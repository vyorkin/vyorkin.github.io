<!DOCTYPE html>
<html lang="en">

<head>
  <title>
  Making of Tiger #2, Lexical Analysis · vyorkin.org
</title>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="color-scheme" content="light dark">




<meta name="author" content="Vasiliy Yorkin">
<meta name="description" content="Intro Link to heading We need a way to translate a program written in one (human-friendly) language to another (machine-specific) language. Generally, this work is splitted into 2 parts: analysis and synthesis.
The synthesis-part (back end) is responsible for the code generation and optimizations.
Analysis-part (front end) is responsible for breaking the program apart to understand its structure and meaning. There are 3 commonly used analysis phases:
Lexical – breaking a sequence of characters into sequence of individual tokens (words) Syntax – parsing and checking that we have a valid sequence of tokens Semantic – gathering the program’s meaning, making sure that declarations and statements of program are semantically correct, this usually includes type checking In this post we’ll focus on implementing the lexical analysis phase.">
<meta name="keywords" content="Vasiliy Yorkin">
<meta name="fediverse:creator" content="" />


  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Making of Tiger #2, Lexical Analysis">
  <meta name="twitter:description" content="Intro Link to heading We need a way to translate a program written in one (human-friendly) language to another (machine-specific) language. Generally, this work is splitted into 2 parts: analysis and synthesis.
The synthesis-part (back end) is responsible for the code generation and optimizations.
Analysis-part (front end) is responsible for breaking the program apart to understand its structure and meaning. There are 3 commonly used analysis phases:
Lexical – breaking a sequence of characters into sequence of individual tokens (words) Syntax – parsing and checking that we have a valid sequence of tokens Semantic – gathering the program’s meaning, making sure that declarations and statements of program are semantically correct, this usually includes type checking In this post we’ll focus on implementing the lexical analysis phase.">

<meta property="og:url" content="https://vyorkin.org/posts/making-of-tiger-2-lexical-analysis/">
  <meta property="og:site_name" content="vyorkin.org">
  <meta property="og:title" content="Making of Tiger #2, Lexical Analysis">
  <meta property="og:description" content="Intro Link to heading We need a way to translate a program written in one (human-friendly) language to another (machine-specific) language. Generally, this work is splitted into 2 parts: analysis and synthesis.
The synthesis-part (back end) is responsible for the code generation and optimizations.
Analysis-part (front end) is responsible for breaking the program apart to understand its structure and meaning. There are 3 commonly used analysis phases:
Lexical – breaking a sequence of characters into sequence of individual tokens (words) Syntax – parsing and checking that we have a valid sequence of tokens Semantic – gathering the program’s meaning, making sure that declarations and statements of program are semantically correct, this usually includes type checking In this post we’ll focus on implementing the lexical analysis phase.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2019-08-23T00:01:00+03:00">
    <meta property="article:modified_time" content="2019-08-23T00:01:00+03:00">
    <meta property="article:tag" content="Compilers">
    <meta property="article:tag" content="Tiger">
    <meta property="article:tag" content="Ocaml">
    <meta property="article:tag" content="Lexing">
    <meta property="article:tag" content="Ocamllex">




<link rel="canonical" href="https://vyorkin.org/posts/making-of-tiger-2-lexical-analysis/">


<link rel="preload" href="https://vyorkin.org/fonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="https://vyorkin.org/fonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="https://vyorkin.org/fonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin>


  
  
  <link rel="stylesheet" href="https://vyorkin.org/css/coder.min.07092c1350ffd254998dc43a44ae96e617d14af4df4602626878df89189c5e1a.css" integrity="sha256-BwksE1D/0lSZjcQ6RK6W5hfRSvTfRgJiaHjfiRicXho=" crossorigin="anonymous" media="screen" />





  
    
    
    <link rel="stylesheet" href="https://vyorkin.org/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css" integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin="anonymous" media="screen" />
  




  
  <link rel="stylesheet" href="https://vyorkin.org/custom.min.37b90b4ab2011637071ddd3590a64f81899b71c028d2d366c001566e70ee9e90.css" integrity="sha256-N7kLSrIBFjcHHd01kKZPgYmbccAo0tNmwAFWbnDunpA=" crossorigin="anonymous" media="screen" />


<link rel="icon" type="image/svg+xml" href="https://vyorkin.org/images/favicon.svg" sizes="any">
<link rel="icon" type="image/png" href="https://vyorkin.org/images/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="https://vyorkin.org/images/favicon-16x16.png" sizes="16x16">

<link rel="apple-touch-icon" href="https://vyorkin.org/images/apple-touch-icon.png">
<link rel="apple-touch-icon" sizes="180x180" href="https://vyorkin.org/images/apple-touch-icon.png">

<link rel="manifest" href="https://vyorkin.org/site.webmanifest">
<link rel="mask-icon" href="https://vyorkin.org/images/safari-pinned-tab.svg" color="#5bbad5">









</head>






<body class="preload-transitions colorscheme-dark">
  
<div class="float-container">
    <a id="dark-mode-toggle" class="colorscheme-toggle">
        <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
    </a>
</div>


  <main class="wrapper">
    <nav class="navigation">
  <section class="container">
    
    <a class="navigation-title" href="https://vyorkin.org/">
      vyorkin.org
    </a>
    
    
      <input type="checkbox" id="menu-toggle" />
      <label class="menu-button float-right" for="menu-toggle">
        <i class="fa-solid fa-bars fa-fw" aria-hidden="true"></i>
      </label>
      <ul class="navigation-list">
        
          
            <li class="navigation-item">
              <a class="navigation-link " href="https://vyorkin.org/about/">about</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="https://vyorkin.org/posts/">posts</a>
            </li>
          
        
        
          
          
          
            
          
            
              
                <li class="navigation-item menu-separator">
                  <span>|</span>
                </li>
                
              
              <li class="navigation-item">
                <a href="https://vyorkin.org/ru-ru/">ru</a>
              </li>
            
          
            
              
              <li class="navigation-item">
                <a href="https://vyorkin.org/de-de/">de</a>
              </li>
            
          
        
      </ul>
    
  </section>
</nav>


    <div class="content">
      
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">
            <a class="title-link" href="https://vyorkin.org/posts/making-of-tiger-2-lexical-analysis/">
              Making of Tiger #2, Lexical Analysis
            </a>
          </h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fa-solid fa-calendar" aria-hidden="true"></i>
              <time datetime="August 23, 2019">
                August 23, 2019
              </time>
            </span>
          </div>
          
          
          <div class="tags">
  <i class="fa-solid fa-tag" aria-hidden="true"></i>
    <span class="tag">
      <a href="https://vyorkin.org/tags/compilers/">Compilers</a>
    </span>
      <span class="separator">•</span>
    <span class="tag">
      <a href="https://vyorkin.org/tags/tiger/">Tiger</a>
    </span>
      <span class="separator">•</span>
    <span class="tag">
      <a href="https://vyorkin.org/tags/ocaml/">Ocaml</a>
    </span>
      <span class="separator">•</span>
    <span class="tag">
      <a href="https://vyorkin.org/tags/lexing/">Lexing</a>
    </span>
      <span class="separator">•</span>
    <span class="tag">
      <a href="https://vyorkin.org/tags/ocamllex/">Ocamllex</a>
    </span></div>

        </div>
      </header>

      <div class="post-content">
        
        <h2 id="intro">
  Intro
  <a class="heading-link" href="#intro">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>We need a way to translate a program written in one
(human-friendly) language to another (machine-specific)
language. Generally, this work is splitted into 2 parts:
<strong>analysis</strong> and <strong>synthesis</strong>.</p>
<p>The <strong>synthesis</strong>-part (back end) is responsible for the code
generation and optimizations.</p>
<p><strong>Analysis</strong>-part (front end) is responsible for breaking the
program apart to understand its structure and meaning. There are
3 commonly used <strong>analysis</strong> phases:</p>
<ol>
<li><strong>Lexical</strong> – breaking a sequence of characters into sequence
of individual <strong>tokens</strong> (words)</li>
<li><strong>Syntax</strong> – parsing and checking that we have a valid sequence
of tokens</li>
<li><strong>Semantic</strong> – gathering the program’s meaning, making sure
that declarations and statements of program are semantically
correct, this usually includes type checking</li>
</ol>
<p>In this post we’ll focus on implementing the <strong>lexical analysis</strong>
phase.</p>
<p>A lexical <strong>token</strong> is a string with an assigned and identified
meaning. This is a <strong>unit</strong> in a grammar of a programming
language.</p>
<ul>
<li>Example <strong>tokens</strong>: identifiers, keywords, separators, operators</li>
<li>Example <strong>non-tokens</strong>: white-spaces, tabs, newlines, comments,
preprocessor directives, macroses</li>
</ul>
<p>Now, I’m going to skip everything related to finite automata and
regular expressions and go straight to the implementation of
<strong>lexer</strong> (lexical analyzer). You can find a good intro to lexing
and parsing using <code>ocamllex</code> and <code>menhir</code> in the <a href="http://dev.realworldocaml.org/parsing-with-ocamllex-and-menhir.html"  class="external-link" target="_blank" rel="noopener">Read World
OCaml book</a>.</p>
<h2 id="example-lexer--morse-code">
  Example lexer (morse code)
  <a class="heading-link" href="#example-lexer--morse-code">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>We’ll start with the simplest possible example of building a
lexer for <a href="https://en.wikipedia.org/wiki/Morse_code"  class="external-link" target="_blank" rel="noopener">morse code</a>, the full source code is <a href="https://github.com/vyorkin/tiger/blob/master/play/menhir/morse-code-simple/lexer.mll"  class="external-link" target="_blank" rel="noopener">here</a>.</p>
<p>The <code>dune</code> file for our playground project is going to look like
this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#434f54">ocamllex</span>
</span></span><span style="display:flex;"><span> (<span style="color:#434f54">modules</span> <span style="color:#434f54">lexer</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>(<span style="color:#434f54">executable</span>
</span></span><span style="display:flex;"><span> (<span style="color:#434f54">name</span> <span style="color:#434f54">driver</span>)
</span></span><span style="display:flex;"><span> (<span style="color:#434f54">libraries</span> <span style="color:#434f54">core</span> <span style="color:#434f54">stdio</span>)
</span></span><span style="display:flex;"><span> (<span style="color:#434f54">preprocess</span> (<span style="color:#434f54">pps</span> <span style="color:#434f54">ppx_deriving.show</span>)))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>(<span style="color:#434f54">env</span> (<span style="color:#434f54">dev</span> (<span style="color:#434f54">flags</span> (<span style="color:#7f8c8d">:standard</span> <span style="color:#434f54">-warn-error</span> <span style="color:#434f54">-A</span>))))
</span></span></code></pre></div><p>Nothing fancy here. Next one is the <code>driver.ml</code> module, this is
our entry point. It simply reads the given file, runs our lexer
and displays the resulting S-expression.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">open</span> <span style="color:#434f54">Core</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">open</span> <span style="color:#434f54">Syntax</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#728e00">rec</span> <span style="color:#434f54">tokens</span> <span style="color:#434f54">buf</span> <span style="color:#728e00">=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">match</span> <span style="color:#434f54">Lexer</span>.<span style="color:#434f54">read</span> <span style="color:#434f54">buf</span> <span style="color:#728e00">with</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">EOF</span> <span style="color:#728e00">-&gt;</span> <span style="color:#728e00">[</span><span style="color:#434f54">EOF</span><span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">tok</span> <span style="color:#728e00">-&gt;</span> <span style="color:#434f54">tok</span><span style="color:#728e00">::</span><span style="color:#434f54">tokens</span> <span style="color:#434f54">buf</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">lex_print</span> <span style="color:#434f54">ch</span> <span style="color:#728e00">=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#434f54">ch</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|&gt;</span> <span style="color:#434f54">Lexing</span>.<span style="color:#434f54">from_channel</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|&gt;</span> <span style="color:#434f54">tokens</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|&gt;</span> <span style="color:#434f54">List</span>.<span style="color:#434f54">iter</span> <span style="color:#728e00">~</span><span style="color:#434f54">f</span><span style="color:#728e00">:(</span><span style="color:#728e00">fun</span> <span style="color:#434f54">e</span> <span style="color:#728e00">-&gt;</span> <span style="color:#434f54">Format</span>.<span style="color:#434f54">printf</span> <span style="color:#7f8c8d">&#34;%s</span><span style="color:#7f8c8d">\n</span><span style="color:#7f8c8d">&#34;</span> <span style="color:#728e00">(</span><span style="color:#434f54">show_exp</span> <span style="color:#434f54">e</span><span style="color:#728e00">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">run</span> <span style="color:#434f54">filename</span> <span style="color:#434f54">()</span> <span style="color:#728e00">=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#434f54">In_channel</span>.<span style="color:#434f54">with_file</span> <span style="color:#434f54">filename</span> <span style="color:#728e00">~</span><span style="color:#434f54">f</span><span style="color:#728e00">:</span><span style="color:#434f54">lex_print</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">()</span> <span style="color:#728e00">=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">let</span> <span style="color:#434f54">spec</span> <span style="color:#728e00">=</span> <span style="color:#434f54">Command</span>.<span style="color:#434f54">Spec</span>.<span style="color:#728e00">(</span><span style="color:#434f54">empty</span> <span style="color:#728e00">+&gt;</span> <span style="color:#434f54">anon</span> <span style="color:#728e00">(</span><span style="color:#7f8c8d">&#34;filename&#34;</span> <span style="color:#728e00">%:</span> <span style="color:#00979d">string</span><span style="color:#728e00">))</span> <span style="color:#728e00">in</span>
</span></span><span style="display:flex;"><span>  <span style="color:#434f54">run</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|&gt;</span> <span style="color:#434f54">Command</span>.<span style="color:#434f54">basic_spec</span> <span style="color:#728e00">~</span><span style="color:#434f54">summary</span><span style="color:#728e00">:</span><span style="color:#7f8c8d">&#34;Run the lexer and display tokens&#34;</span> <span style="color:#434f54">spec</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|&gt;</span> <span style="color:#434f54">Command</span>.<span style="color:#434f54">run</span>
</span></span></code></pre></div><p>We need a module to describe our tokens, lets call it
<code>syntax.ml</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">type</span> <span style="color:#434f54">exp</span> <span style="color:#728e00">=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">SYM</span> <span style="color:#728e00">of</span> <span style="color:#00979d">string</span> <span style="color:#95a5a6">(* symbol *)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">SEP</span> <span style="color:#95a5a6">(* separator *)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">EOF</span> <span style="color:#95a5a6">(* end of file *)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">[@@</span><span style="color:#434f54">deriving</span> <span style="color:#434f54">show</span><span style="color:#728e00">]</span>
</span></span></code></pre></div><p>And the lexer generator itself:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">open</span> <span style="color:#434f54">Lexing</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">open</span> <span style="color:#434f54">Syntax</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#95a5a6">(* Custom exception type for lexer errors *)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">exception</span> <span style="color:#434f54">SyntaxError</span> <span style="color:#728e00">of</span> <span style="color:#00979d">string</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#95a5a6">(* Regular expressions: *)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#95a5a6">(* We use whitespace as a separator, so
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6">   it is a valid token in our language *)</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">white</span>   <span style="color:#728e00">=</span> <span style="color:#728e00">[</span><span style="color:#7f8c8d">&#39; &#39;</span> <span style="color:#7f8c8d">&#39;\t&#39;</span><span style="color:#728e00">]+</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">newline</span> <span style="color:#728e00">=</span> <span style="color:#7f8c8d">&#39;\r&#39;</span> <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#39;\n&#39;</span> <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;</span><span style="color:#7f8c8d">\r\n</span><span style="color:#7f8c8d">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">sym</span>     <span style="color:#728e00">=</span> <span style="color:#728e00">[</span><span style="color:#7f8c8d">&#39;.&#39;</span> <span style="color:#7f8c8d">&#39;-&#39;</span><span style="color:#728e00">]+</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#95a5a6">(* Lexing rules: *)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#434f54">rule</span> <span style="color:#434f54">read</span> <span style="color:#728e00">=</span> <span style="color:#434f54">parse</span>
</span></span><span style="display:flex;"><span>  <span style="color:#95a5a6">(* New lines are separators too *)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">newline</span> <span style="color:#728e00">{</span> <span style="color:#434f54">new_line</span> <span style="color:#434f54">lexbuf</span><span style="color:#728e00">;</span> <span style="color:#434f54">SEP</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">sym</span>     <span style="color:#728e00">{</span> <span style="color:#434f54">SYM</span> <span style="color:#728e00">(</span><span style="color:#434f54">lexeme</span> <span style="color:#434f54">lexbuf</span><span style="color:#728e00">)</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">white</span>   <span style="color:#728e00">{</span> <span style="color:#434f54">SEP</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#728e00">_</span>       <span style="color:#728e00">{</span> <span style="color:#728e00">raise</span> <span style="color:#728e00">(</span><span style="color:#434f54">SyntaxError</span> <span style="color:#728e00">(</span><span style="color:#434f54">Printf</span>.<span style="color:#434f54">sprintf</span> <span style="color:#7f8c8d">&#34;At offset %d: unexpected character.</span><span style="color:#7f8c8d">\n</span><span style="color:#7f8c8d">&#34;</span> <span style="color:#728e00">(</span><span style="color:#434f54">lexeme_start</span> <span style="color:#434f54">lexbuf</span><span style="color:#728e00">)))</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">eof</span>     <span style="color:#728e00">{</span> <span style="color:#434f54">EOF</span> <span style="color:#728e00">}</span>
</span></span></code></pre></div><p>Now we can parse the “hello world” sequence written in Morse
Code:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>.... . .-.. .-.. ---
</span></span><span style="display:flex;"><span>.-- --- .-. .-.. -..
</span></span></code></pre></div><p>The output will be:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#434f54">SYM</span> <span style="color:#7f8c8d">&#34;....&#34;</span>) <span style="color:#434f54">SEP</span> (<span style="color:#434f54">SYM</span> <span style="color:#7f8c8d">&#34;.&#34;</span>) <span style="color:#434f54">SEP</span> (<span style="color:#434f54">SYM</span> <span style="color:#7f8c8d">&#34;.-..&#34;</span>) <span style="color:#434f54">SEP</span> (<span style="color:#434f54">SYM</span> <span style="color:#7f8c8d">&#34;.-..&#34;</span>) <span style="color:#434f54">SEP</span> (<span style="color:#434f54">SYM</span> <span style="color:#7f8c8d">&#34;---&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#434f54">SEP</span>
</span></span><span style="display:flex;"><span>(<span style="color:#434f54">SYM</span> <span style="color:#7f8c8d">&#34;.--&#34;</span>) <span style="color:#434f54">SEP</span> (<span style="color:#434f54">SYM</span> <span style="color:#7f8c8d">&#34;---&#34;</span>) <span style="color:#434f54">SEP</span> (<span style="color:#434f54">SYM</span> <span style="color:#7f8c8d">&#34;.-.&#34;</span>) <span style="color:#434f54">SEP</span> (<span style="color:#434f54">SYM</span> <span style="color:#7f8c8d">&#34;.-..&#34;</span>) <span style="color:#434f54">SEP</span> (<span style="color:#434f54">SYM</span> <span style="color:#7f8c8d">&#34;-..&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#434f54">EOF</span>
</span></span></code></pre></div><h2 id="tiger-lexer">
  Tiger lexer
  <a class="heading-link" href="#tiger-lexer">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>Having that basic understanding of how to use the <code>ocamllex</code> to
build lexers, we can try to build one for our Tiger language.</p>
<p>The <code>dune</code> file is going to remain the same as in the “morse
code” example above. There is a <strong>Tiger Language Reference Manual
in Appendix A</strong> of the book where you can find the information
about the tokens we need: identifiers, comments, declarations,
data types, etc.</p>
<p>For now, we don’t need to define a real AST data type.</p>
<details>
<summary>The “mock” <b>syntax.ml</b> module would suffice.</summary>
<div class="details">
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">type</span> <span style="color:#434f54">exp</span> <span style="color:#728e00">=</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">TYPE</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">VAR</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">FUNCTION</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">BREAK</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">OF</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">END</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">IN</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">NIL</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">LET</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">DO</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">TO</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">FOR</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">WHILE</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">ELSE</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">THEN</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">IF</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">ARRAY</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">ASSIGN</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">OR</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">AND</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">GE</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">GT</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">LE</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">LT</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">NEQ</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">EQ</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">DIVIDE</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">TIMES</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">MINUS</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">PLUS</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">DOT</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">RBRACE</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">LBRACE</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">RBRACK</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">LBRACK</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">RPAREN</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">LPAREN</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">SEMICOLON</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">COLON</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">COMMA</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">STRING</span> <span style="color:#728e00">of</span> <span style="color:#00979d">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">INT</span> <span style="color:#728e00">of</span> <span style="color:#00979d">int</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">ID</span> <span style="color:#728e00">of</span> <span style="color:#00979d">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">EOF</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">[@@</span><span style="color:#434f54">deriving</span> <span style="color:#434f54">show</span><span style="color:#728e00">]</span>
</span></span></code></pre></div></div>
</details>
<p>We want to focus on the lexer part. First, we might want to open
some commonly used modules and define a custom exception type
for lexing errors.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">{</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">open</span> <span style="color:#434f54">Lexing</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">open</span> <span style="color:#434f54">Syntax</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">open</span> <span style="color:#434f54">Base</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">exception</span> <span style="color:#434f54">SyntaxError</span> <span style="color:#728e00">of</span> <span style="color:#00979d">string</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">}</span>
</span></span></code></pre></div><p>Next, we need a few regular expressions:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">digit</span> <span style="color:#728e00">=</span> <span style="color:#728e00">[</span><span style="color:#7f8c8d">&#39;0&#39;</span><span style="color:#728e00">-</span><span style="color:#7f8c8d">&#39;9&#39;</span><span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span><span style="color:#95a5a6">(* There are no negative integer literals in Tiger *)</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#00979d">int</span> <span style="color:#728e00">=</span> <span style="color:#434f54">digit</span><span style="color:#728e00">+</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">frac</span> <span style="color:#728e00">=</span> <span style="color:#7f8c8d">&#39;.&#39;</span> <span style="color:#434f54">digit</span><span style="color:#728e00">*</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">exp</span> <span style="color:#728e00">=</span> <span style="color:#728e00">[</span><span style="color:#7f8c8d">&#39;e&#39;</span> <span style="color:#7f8c8d">&#39;E&#39;</span><span style="color:#728e00">]</span> <span style="color:#728e00">[</span><span style="color:#7f8c8d">&#39;-&#39;</span> <span style="color:#7f8c8d">&#39;+&#39;</span><span style="color:#728e00">]?</span> <span style="color:#00979d">int</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#00979d">float</span> <span style="color:#728e00">=</span> <span style="color:#434f54">digit</span><span style="color:#728e00">*</span> <span style="color:#434f54">frac</span><span style="color:#728e00">?</span> <span style="color:#434f54">exp</span><span style="color:#728e00">?</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">white</span> <span style="color:#728e00">=</span> <span style="color:#728e00">[</span><span style="color:#7f8c8d">&#39; &#39;</span> <span style="color:#7f8c8d">&#39;\t&#39;</span><span style="color:#728e00">]+</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">newline</span> <span style="color:#728e00">=</span> <span style="color:#7f8c8d">&#39;\r&#39;</span> <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#39;\n&#39;</span> <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;</span><span style="color:#7f8c8d">\r\n</span><span style="color:#7f8c8d">&#34;</span>
</span></span></code></pre></div><p>According to <strong>Appendix A</strong>:</p>
<p><em>An <strong>identifier</strong> is a sequence of letters, digits and underscores, starting with a letter. Uppercase letters are distinguished from lowercase</em>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">alphanum</span> <span style="color:#728e00">=</span> <span style="color:#728e00">[</span><span style="color:#7f8c8d">&#39;a&#39;</span><span style="color:#728e00">-</span><span style="color:#7f8c8d">&#39;z&#39;</span> <span style="color:#7f8c8d">&#39;A&#39;</span><span style="color:#728e00">-</span><span style="color:#7f8c8d">&#39;Z&#39;</span> <span style="color:#7f8c8d">&#39;0&#39;</span><span style="color:#728e00">-</span><span style="color:#7f8c8d">&#39;9&#39;</span> <span style="color:#7f8c8d">&#39;_&#39;</span><span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">id</span> <span style="color:#728e00">=</span> <span style="color:#728e00">[</span><span style="color:#7f8c8d">&#39;a&#39;</span><span style="color:#728e00">-</span><span style="color:#7f8c8d">&#39;z&#39;</span><span style="color:#728e00">]</span> <span style="color:#434f54">alphanum</span><span style="color:#728e00">*</span>
</span></span></code></pre></div><p>Lexing rules.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#434f54">rule</span> <span style="color:#434f54">read</span> <span style="color:#728e00">=</span> <span style="color:#434f54">parse</span>
</span></span><span style="display:flex;"><span>  <span style="color:#95a5a6">(* Whitespaces *)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">white</span> <span style="color:#728e00">{</span> <span style="color:#434f54">read</span> <span style="color:#434f54">lexbuf</span> <span style="color:#728e00">}</span>
</span></span></code></pre></div><p>We want to skip the new lines.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">newline</span> <span style="color:#728e00">{</span> <span style="color:#434f54">new_line</span> <span style="color:#434f54">lexbuf</span><span style="color:#728e00">;</span> <span style="color:#434f54">read</span> <span style="color:#434f54">lexbuf</span> <span style="color:#728e00">}</span>
</span></span></code></pre></div><p>We have a separate function to read strings (see the
implementation below).</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#39;&#34;&#39;</span> <span style="color:#728e00">{</span> <span style="color:#434f54">read_string</span> <span style="color:#728e00">(</span><span style="color:#434f54">Buffer</span>.<span style="color:#434f54">create</span> <span style="color:#434f54">16</span><span style="color:#728e00">)</span> <span style="color:#434f54">lexbuf</span> <span style="color:#728e00">}</span>
</span></span></code></pre></div><p>Again, according the <strong>Appendix A</strong>:</p>
<p><em>A comment may appear between any two tokens. Comments start with <code>/*</code> and end with <code>*/</code> and may be nested.</em></p>
<p>We’ll have a separate function for reading comments (scroll down
to see its code).</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;/*&#34;</span> <span style="color:#728e00">{</span> <span style="color:#434f54">read_comment</span> <span style="color:#728e00">[</span><span style="color:#434f54">lexbuf</span><span style="color:#728e00">.</span><span style="color:#434f54">lex_curr_p</span><span style="color:#728e00">]</span> <span style="color:#434f54">lexbuf</span> <span style="color:#728e00">}</span>
</span></span></code></pre></div><p>Basic keywords:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;type&#34;</span>     <span style="color:#728e00">{</span> <span style="color:#434f54">TYPE</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;var&#34;</span>      <span style="color:#728e00">{</span> <span style="color:#434f54">VAR</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;function&#34;</span> <span style="color:#728e00">{</span> <span style="color:#434f54">FUNCTION</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;break&#34;</span>    <span style="color:#728e00">{</span> <span style="color:#434f54">BREAK</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;of&#34;</span>       <span style="color:#728e00">{</span> <span style="color:#434f54">OF</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;end&#34;</span>      <span style="color:#728e00">{</span> <span style="color:#434f54">END</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;in&#34;</span>       <span style="color:#728e00">{</span> <span style="color:#434f54">IN</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;nil&#34;</span>      <span style="color:#728e00">{</span> <span style="color:#434f54">NIL</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;let&#34;</span>      <span style="color:#728e00">{</span> <span style="color:#434f54">LET</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;array&#34;</span>    <span style="color:#728e00">{</span> <span style="color:#434f54">ARRAY</span> <span style="color:#728e00">}</span>
</span></span></code></pre></div><p>We need 4 tokens for loops:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;do&#34;</span>    <span style="color:#728e00">{</span> <span style="color:#434f54">DO</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;to&#34;</span>    <span style="color:#728e00">{</span> <span style="color:#434f54">TO</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;for&#34;</span>   <span style="color:#728e00">{</span> <span style="color:#434f54">FOR</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;while&#34;</span> <span style="color:#728e00">{</span> <span style="color:#434f54">WHILE</span> <span style="color:#728e00">}</span>
</span></span></code></pre></div><p>Conditionals (<code>if-then-else</code>):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;else&#34;</span> <span style="color:#728e00">{</span> <span style="color:#434f54">ELSE</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;then&#34;</span> <span style="color:#728e00">{</span> <span style="color:#434f54">THEN</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;if&#34;</span>   <span style="color:#728e00">{</span> <span style="color:#434f54">IF</span> <span style="color:#728e00">}</span>
</span></span></code></pre></div><p>Operators:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span>  <span style="color:#95a5a6">(* General *)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;:=&#34;</span> <span style="color:#728e00">{</span> <span style="color:#434f54">ASSIGN</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#95a5a6">(* Logical *)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;|&#34;</span> <span style="color:#728e00">{</span> <span style="color:#434f54">OR</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;&amp;&#34;</span> <span style="color:#728e00">{</span> <span style="color:#434f54">AND</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#95a5a6">(* Comparison *)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;&gt;=&#34;</span> <span style="color:#728e00">{</span> <span style="color:#434f54">GE</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;&gt;&#34;</span>  <span style="color:#728e00">{</span> <span style="color:#434f54">GT</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;&lt;=&#34;</span> <span style="color:#728e00">{</span> <span style="color:#434f54">LE</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;&lt;&#34;</span>  <span style="color:#728e00">{</span> <span style="color:#434f54">LT</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;&lt;&gt;&#34;</span> <span style="color:#728e00">{</span> <span style="color:#434f54">NEQ</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;=&#34;</span>  <span style="color:#728e00">{</span> <span style="color:#434f54">EQ</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#95a5a6">(* Arithmetics *)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;/&#34;</span> <span style="color:#728e00">{</span> <span style="color:#434f54">DIVIDE</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;*&#34;</span> <span style="color:#728e00">{</span> <span style="color:#434f54">TIMES</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;-&#34;</span> <span style="color:#728e00">{</span> <span style="color:#434f54">MINUS</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;+&#34;</span> <span style="color:#728e00">{</span> <span style="color:#434f54">PLUS</span> <span style="color:#728e00">}</span>
</span></span></code></pre></div><p>Separators:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;.&#34;</span> <span style="color:#728e00">{</span> <span style="color:#434f54">DOT</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;{&#34;</span> <span style="color:#728e00">{</span> <span style="color:#434f54">LBRACE</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;}&#34;</span> <span style="color:#728e00">{</span> <span style="color:#434f54">RBRACE</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;[&#34;</span> <span style="color:#728e00">{</span> <span style="color:#434f54">LBRACK</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;]&#34;</span> <span style="color:#728e00">{</span> <span style="color:#434f54">RBRACK</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;(&#34;</span> <span style="color:#728e00">{</span> <span style="color:#434f54">LPAREN</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;)&#34;</span> <span style="color:#728e00">{</span> <span style="color:#434f54">RPAREN</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;;&#34;</span> <span style="color:#728e00">{</span> <span style="color:#434f54">SEMICOLON</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;:&#34;</span> <span style="color:#728e00">{</span> <span style="color:#434f54">COLON</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;,&#34;</span> <span style="color:#728e00">{</span> <span style="color:#434f54">COMMA</span> <span style="color:#728e00">}</span>
</span></span></code></pre></div><p>Numbers, identifiers, error and EOF handling:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#00979d">int</span> <span style="color:#728e00">{</span> <span style="color:#434f54">INT</span> <span style="color:#728e00">(</span><span style="color:#434f54">Int</span>.<span style="color:#434f54">of_string</span> <span style="color:#728e00">(</span><span style="color:#434f54">Lexing</span>.<span style="color:#434f54">lexeme</span> <span style="color:#434f54">lexbuf</span><span style="color:#728e00">))</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">id</span>  <span style="color:#728e00">{</span> <span style="color:#434f54">ID</span> <span style="color:#728e00">(</span><span style="color:#434f54">Lexing</span>.<span style="color:#434f54">lexeme</span> <span style="color:#434f54">lexbuf</span><span style="color:#728e00">)</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#728e00">_</span>   <span style="color:#728e00">{</span> <span style="color:#728e00">raise</span> <span style="color:#728e00">(</span><span style="color:#434f54">SyntaxError</span> <span style="color:#728e00">(</span><span style="color:#7f8c8d">&#34;Unexpected character: &#34;</span> <span style="color:#728e00">^</span> <span style="color:#434f54">Lexing</span>.<span style="color:#434f54">lexeme</span> <span style="color:#434f54">lexbuf</span><span style="color:#728e00">))</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">eof</span> <span style="color:#728e00">{</span> <span style="color:#434f54">EOF</span> <span style="color:#728e00">}</span>
</span></span></code></pre></div><p>The rule to match string literals:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">and</span> <span style="color:#434f54">read_string</span> <span style="color:#434f54">buf</span> <span style="color:#728e00">=</span> <span style="color:#434f54">parse</span>
</span></span><span style="display:flex;"><span>  <span style="color:#95a5a6">(* If we reach the terminating double quote, then
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6">   * we return the contents of the buffer as a STRING. *)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#39;&#34;&#39;</span>       <span style="color:#728e00">{</span> <span style="color:#434f54">STRING</span> <span style="color:#728e00">(</span><span style="color:#434f54">Buffer</span>.<span style="color:#434f54">contents</span> <span style="color:#434f54">buf</span><span style="color:#728e00">)</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#95a5a6">(* Handling escape sequences *)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#39;\\&#39;</span> <span style="color:#7f8c8d">&#39;\\&#39;</span> <span style="color:#728e00">{</span> <span style="color:#434f54">Buffer</span>.<span style="color:#434f54">add_char</span> <span style="color:#434f54">buf</span> <span style="color:#7f8c8d">&#39;\\&#39;</span><span style="color:#728e00">;</span> <span style="color:#434f54">read_string</span> <span style="color:#434f54">buf</span> <span style="color:#434f54">lexbuf</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#39;\\&#39;</span> <span style="color:#7f8c8d">&#39;/&#39;</span>  <span style="color:#728e00">{</span> <span style="color:#434f54">Buffer</span>.<span style="color:#434f54">add_char</span> <span style="color:#434f54">buf</span> <span style="color:#7f8c8d">&#39;/&#39;</span><span style="color:#728e00">;</span>  <span style="color:#434f54">read_string</span> <span style="color:#434f54">buf</span> <span style="color:#434f54">lexbuf</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#39;\\&#39;</span> <span style="color:#7f8c8d">&#39;b&#39;</span>  <span style="color:#728e00">{</span> <span style="color:#434f54">Buffer</span>.<span style="color:#434f54">add_char</span> <span style="color:#434f54">buf</span> <span style="color:#7f8c8d">&#39;\b&#39;</span><span style="color:#728e00">;</span> <span style="color:#434f54">read_string</span> <span style="color:#434f54">buf</span> <span style="color:#434f54">lexbuf</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#39;\\&#39;</span> <span style="color:#7f8c8d">&#39;f&#39;</span>  <span style="color:#728e00">{</span> <span style="color:#434f54">Buffer</span>.<span style="color:#434f54">add_char</span> <span style="color:#434f54">buf</span> <span style="color:#7f8c8d">&#39;\012&#39;</span><span style="color:#728e00">;</span> <span style="color:#434f54">read_string</span> <span style="color:#434f54">buf</span> <span style="color:#434f54">lexbuf</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#39;\\&#39;</span> <span style="color:#7f8c8d">&#39;n&#39;</span>  <span style="color:#728e00">{</span> <span style="color:#434f54">Buffer</span>.<span style="color:#434f54">add_char</span> <span style="color:#434f54">buf</span> <span style="color:#7f8c8d">&#39;\n&#39;</span><span style="color:#728e00">;</span> <span style="color:#434f54">read_string</span> <span style="color:#434f54">buf</span> <span style="color:#434f54">lexbuf</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#39;\\&#39;</span> <span style="color:#7f8c8d">&#39;r&#39;</span>  <span style="color:#728e00">{</span> <span style="color:#434f54">Buffer</span>.<span style="color:#434f54">add_char</span> <span style="color:#434f54">buf</span> <span style="color:#7f8c8d">&#39;\r&#39;</span><span style="color:#728e00">;</span> <span style="color:#434f54">read_string</span> <span style="color:#434f54">buf</span> <span style="color:#434f54">lexbuf</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#39;\\&#39;</span> <span style="color:#7f8c8d">&#39;t&#39;</span>  <span style="color:#728e00">{</span> <span style="color:#434f54">Buffer</span>.<span style="color:#434f54">add_char</span> <span style="color:#434f54">buf</span> <span style="color:#7f8c8d">&#39;\t&#39;</span><span style="color:#728e00">;</span> <span style="color:#434f54">read_string</span> <span style="color:#434f54">buf</span> <span style="color:#434f54">lexbuf</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#728e00">[^</span> <span style="color:#7f8c8d">&#39;&#34;&#39;</span> <span style="color:#7f8c8d">&#39;\\&#39;</span><span style="color:#728e00">]+</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">{</span> <span style="color:#434f54">Buffer</span>.<span style="color:#434f54">add_string</span> <span style="color:#434f54">buf</span> <span style="color:#728e00">(</span><span style="color:#434f54">Lexing</span>.<span style="color:#434f54">lexeme</span> <span style="color:#434f54">lexbuf</span><span style="color:#728e00">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#434f54">read_string</span> <span style="color:#434f54">buf</span> <span style="color:#434f54">lexbuf</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#728e00">_</span>   <span style="color:#728e00">{</span> <span style="color:#728e00">raise</span> <span style="color:#728e00">(</span><span style="color:#434f54">SyntaxError</span> <span style="color:#728e00">(</span><span style="color:#7f8c8d">&#34;Illegal string character: &#34;</span> <span style="color:#728e00">^</span> <span style="color:#434f54">Lexing</span>.<span style="color:#434f54">lexeme</span> <span style="color:#434f54">lexbuf</span><span style="color:#728e00">))</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">eof</span> <span style="color:#728e00">{</span> <span style="color:#728e00">raise</span> <span style="color:#728e00">(</span><span style="color:#434f54">SyntaxError</span> <span style="color:#7f8c8d">&#34;String is not terminated&#34;</span><span style="color:#728e00">)</span> <span style="color:#728e00">}</span>
</span></span></code></pre></div><p>The rule to match comments (including nested comments), keeping
a list of where comments open:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">and</span> <span style="color:#434f54">read_comment</span> <span style="color:#434f54">opened</span> <span style="color:#728e00">=</span> <span style="color:#434f54">parse</span>
</span></span><span style="display:flex;"><span>  <span style="color:#95a5a6">(* Opening comment *)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;/*&#34;</span> <span style="color:#728e00">{</span> <span style="color:#434f54">read_comment</span> <span style="color:#728e00">(</span><span style="color:#434f54">lexbuf</span><span style="color:#728e00">.</span><span style="color:#434f54">lex_curr_p</span><span style="color:#728e00">::</span><span style="color:#434f54">opened</span><span style="color:#728e00">)</span> <span style="color:#434f54">lexbuf</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#95a5a6">(* Closing comment *)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;*/&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">{</span> <span style="color:#728e00">match</span> <span style="color:#434f54">opened</span> <span style="color:#728e00">with</span>
</span></span><span style="display:flex;"><span>      <span style="color:#95a5a6">(* No nested opened comments left, continue parsing. *)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#728e00">|</span> <span style="color:#728e00">_::</span><span style="color:#434f54">[]</span> <span style="color:#728e00">-&gt;</span> <span style="color:#434f54">read</span> <span style="color:#434f54">lexbuf</span>
</span></span><span style="display:flex;"><span>      <span style="color:#95a5a6">(* Continue parsing comment. *)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#728e00">|</span> <span style="color:#728e00">_</span> <span style="color:#728e00">-&gt;</span> <span style="color:#434f54">read_comment</span> <span style="color:#728e00">(</span><span style="color:#434f54">List</span>.<span style="color:#434f54">tl_exn</span> <span style="color:#434f54">opened</span><span style="color:#728e00">)</span> <span style="color:#434f54">lexbuf</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">newline</span> <span style="color:#728e00">{</span> <span style="color:#434f54">new_line</span> <span style="color:#434f54">lexbuf</span><span style="color:#728e00">;</span> <span style="color:#434f54">read_comment</span> <span style="color:#434f54">opened</span> <span style="color:#434f54">lexbuf</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#728e00">_</span> <span style="color:#728e00">{</span> <span style="color:#434f54">read_comment</span> <span style="color:#434f54">opened</span> <span style="color:#434f54">lexbuf</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#95a5a6">(* Unexpected end-of-file. Update the current location to
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6">   * point to the opening token that wasn&#39;t closed and raise an error. *)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">eof</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">{</span> <span style="color:#434f54">lexbuf</span><span style="color:#728e00">.</span><span style="color:#434f54">lex_curr_p</span> <span style="color:#728e00">&lt;-</span> <span style="color:#434f54">List</span>.<span style="color:#434f54">hd_exn</span> <span style="color:#434f54">opened</span><span style="color:#728e00">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#728e00">raise</span> <span style="color:#728e00">(</span><span style="color:#434f54">SyntaxError</span> <span style="color:#7f8c8d">&#34;Unterminated comment&#34;</span><span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">}</span>
</span></span></code></pre></div><h2 id="summary">
  Summary
  <a class="heading-link" href="#summary">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>We’ve learned some new things, like <code>ocamllex</code>, but overall, it
wasn’t too hard to follow the book. The full OCaml source code
for the second chapter can be found <a href="https://github.com/vyorkin/tiger/blob/master/chapter2/lexer.mll"  class="external-link" target="_blank" rel="noopener">here</a>. In the next part we’re
going to write a parser.</p>

        
      </div>


      <footer>
        


        
        
        
        
        

        
        
      </footer>
    </article>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css"
    integrity="sha384-vKruj+a13U8yHIkAyGgK1J3ArTLzrFGBbBc0tDp4ad/EyewESeXE/Iv67Aj8gKZ0" crossorigin="anonymous">
  
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js"
    integrity="sha384-PwRUT/YqbnEjkZO0zZxNqcxACrXe+j766U2amXcgMg5457rve2Y7I6ZJSm2A0mS4" crossorigin="anonymous"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/contrib/auto-render.min.js"
    integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"
    onload="renderMathInElement(document.body,
      {
        delimiters: [
          {left: '$$', right: '$$', display:true},
          {left: '$', right: '$', display:false},
          {left: '\\(', right: '\\)', display: false},
          {left: '\\[', right: '\\]', display: true}
        ]
      }
    );"></script>
  </section>

    </div>

    <footer class="footer">
  <section class="container">
    ©
    
      1985 -
    
    2024
     Vasiliy Yorkin 
    
  </section>
</footer>

  </main>

  

  
  
  <script src="https://vyorkin.org/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js" integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script>
  

  

  


  
  
    
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-F8R77TYF8B"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-F8R77TYF8B');
        }
      </script>
    
  



  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
</body>

</html>
