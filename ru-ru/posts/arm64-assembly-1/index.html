<!DOCTYPE html>
<html lang="ru-ru">
<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="color-scheme" content="light dark">




<meta name="author" content="Василий Ёркин">
<meta name="description" content="Заметка основана на конспектах из книги Programming with 64-bit ARM Assembly Language.
Регистры X0-X30 &ndash; Регистры общего назначения. X31, SP, XZR &ndash; Указатель стека или нулевой регистр, в зависимости от контекста. X30, LR &ndash; Ссылочный регистр. При вызове функции этот регистр используется для хранения адреса возврата. Не рекомендуется его использовать для чего-либо другого. PC &ndash; Счётчик инструкций. Хранит адрес по которому в памяти расположена выполняемая в данный момент инструкция. Мы не всегда хотим использовать все 64 бита данных регистра, иногда нам достаточно 32 бит.">
<meta name="keywords" content="Василий Ёркин">

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Программирование для ARM64. Часть 1"/>
<meta name="twitter:description" content="Заметка основана на конспектах из книги Programming with 64-bit ARM Assembly Language.
Регистры X0-X30 &ndash; Регистры общего назначения. X31, SP, XZR &ndash; Указатель стека или нулевой регистр, в зависимости от контекста. X30, LR &ndash; Ссылочный регистр. При вызове функции этот регистр используется для хранения адреса возврата. Не рекомендуется его использовать для чего-либо другого. PC &ndash; Счётчик инструкций. Хранит адрес по которому в памяти расположена выполняемая в данный момент инструкция. Мы не всегда хотим использовать все 64 бита данных регистра, иногда нам достаточно 32 бит."/>

<meta property="og:title" content="Программирование для ARM64. Часть 1" />
<meta property="og:description" content="Заметка основана на конспектах из книги Programming with 64-bit ARM Assembly Language.
Регистры X0-X30 &ndash; Регистры общего назначения. X31, SP, XZR &ndash; Указатель стека или нулевой регистр, в зависимости от контекста. X30, LR &ndash; Ссылочный регистр. При вызове функции этот регистр используется для хранения адреса возврата. Не рекомендуется его использовать для чего-либо другого. PC &ndash; Счётчик инструкций. Хранит адрес по которому в памяти расположена выполняемая в данный момент инструкция. Мы не всегда хотим использовать все 64 бита данных регистра, иногда нам достаточно 32 бит." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://vyorkin.org/ru-ru/posts/arm64-assembly-1/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-07-12T12:10:00+03:00" />
<meta property="article:modified_time" content="2022-07-12T12:10:00+03:00" />




  <title>vyorkin.org</title>

  
  <link rel="canonical" href="https://vyorkin.org/ru-ru/posts/arm64-assembly-1/">
  

  <link rel="preload" href="https://vyorkin.org/fonts/forkawesome-webfont.woff2?v=1.2.0" as="font" type="font/woff2" crossorigin>


  
  
  <link rel="stylesheet" href="https://vyorkin.org/css/coder.min.3ec8c3e098d0ff5163314078ea65461d521ee5762f4bead61b802ae0e8311ed0.css" integrity="sha256-PsjD4JjQ/1FjMUB46mVGHVIe5XYvS&#43;rWG4Aq4OgxHtA=" crossorigin="anonymous" media="screen" />





  


   




  <link rel="icon" type="image/png" href="https://vyorkin.org/images/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="https://vyorkin.org/images/favicon-16x16.png" sizes="16x16">

<link rel="apple-touch-icon" href="https://vyorkin.org/images/apple-touch-icon.png">
<link rel="apple-touch-icon" sizes="180x180" href="https://vyorkin.org/images/apple-touch-icon.png">

<link rel="manifest" href="https://vyorkin.org/site.webmanifest">
<link rel="mask-icon" href="https://vyorkin.org/images/safari-pinned-tab.svg" color="#5bbad5">


  

  <meta name="generator" content="Hugo 0.101.0" />


  

</head>





<body class="preload-transitions colorscheme-light">
  

  <main class="wrapper">
    <nav class="navigation">
  <section class="container">
    <a class="navigation-title" href="https://vyorkin.org/ru-ru">
      vyorkin.org
    </a>
    
      <input type="checkbox" id="menu-toggle" />
      <label class="menu-button float-right" for="menu-toggle">
        <i class="fa fa-bars fa-fw" aria-hidden="true"></i>
      </label>
      <ul class="navigation-list">
        
          
            <li class="navigation-item">
              <a class="navigation-link" href="https://vyorkin.org/ru-ru/about/">эбаут</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link" href="https://vyorkin.org/ru-ru/posts/">лытдыбр</a>
            </li>
          
        
        
          
          
          
            
              
                <li class="navigation-item menu-separator">
                  <span>|</span>
                </li>
                
              
              <li class="navigation-item">
                <a href="https://vyorkin.org/">en</a>
              </li>
            
          
            
          
            
              
              <li class="navigation-item">
                <a href="https://vyorkin.org/de-de/">de</a>
              </li>
            
          
        
      </ul>
    
  </section>
</nav>


    <div class="content">
      
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">
            <a class="title-link" href="https://vyorkin.org/ru-ru/posts/arm64-assembly-1/">
              Программирование для ARM64. Часть 1
            </a>
          </h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fa fa-calendar" aria-hidden="true"></i>
              <time datetime="2022-07-12T12:10:00&#43;03:00">
                июля 12, 2022
              </time>
            </span>
          </div>
          
          <div class="categories">
  <i class="fa fa-folder" aria-hidden="true"></i>
    <a href="https://vyorkin.org/ru-ru/categories/assembly/">assembly</a>
      <span class="separator">•</span>
    <a href="https://vyorkin.org/ru-ru/categories/arm64/">arm64</a></div>

          <div class="tags">
  <i class="fa fa-tag" aria-hidden="true"></i>
    <span class="tag">
      <a href="https://vyorkin.org/ru-ru/tags/assembly/">assembly</a>
    </span></div>

        </div>
      </header>

      <div>
        
        <p><em>Заметка основана на конспектах из книги <a href="https://link.springer.com/book/10.1007/978-1-4842-5881-1">Programming
with 64-bit ARM Assembly Language</a>.</em></p>
<h2 id="регистры">
  Регистры
  <a class="heading-link" href="#%d1%80%d0%b5%d0%b3%d0%b8%d1%81%d1%82%d1%80%d1%8b">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h2>
<ul>
<li><code>X0-X30</code> &ndash; Регистры общего назначения.</li>
<li><code>X31</code>, <code>SP</code>, <code>XZR</code> &ndash; Указатель стека или нулевой регистр, в
зависимости от контекста.</li>
<li><code>X30</code>, <code>LR</code> &ndash; Ссылочный регистр. При вызове функции этот
регистр используется для хранения адреса возврата. Не
рекомендуется его использовать для чего-либо другого.</li>
<li><code>PC</code> &ndash; Счётчик инструкций. Хранит адрес по которому в памяти
расположена выполняемая в данный момент инструкция.</li>
</ul>
<p>Мы не всегда хотим использовать все 64 бита данных регистра,
иногда нам достаточно 32 бит. Поэтому существуют удобные
32-битные регистры <code>W0-W30</code> и <code>WZR</code>. Когда мы их используем, то
верхние 32 бита соответствующего 64-битного регистра
устанавливаются в 0.</p>
<h2 id="формат-инструкций">
  Формат инструкций
  <a class="heading-link" href="#%d1%84%d0%be%d1%80%d0%bc%d0%b0%d1%82-%d0%b8%d0%bd%d1%81%d1%82%d1%80%d1%83%d0%ba%d1%86%d0%b8%d0%b9">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h2>
<p>Все инструкции имеют длину 32 бита. Остальное нам пока не очень
важно для практических целей (если только мы не собираемся
писать дизассемблер).</p>
<h2 id="тривиальная-программа">
  Тривиальная программа
  <a class="heading-link" href="#%d1%82%d1%80%d0%b8%d0%b2%d0%b8%d0%b0%d0%bb%d1%8c%d0%bd%d0%b0%d1%8f-%d0%bf%d1%80%d0%be%d0%b3%d1%80%d0%b0%d0%bc%d0%bc%d0%b0">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h2>
<p>Рассмотрим &ldquo;привет мир&rdquo;.</p>
<ul>
<li><code>X0-X2</code> &ndash; Параметры системных вызовов.</li>
<li><code>X16</code> &ndash; Номер системного вызова.</li>
</ul>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#888">; сообщаем линковщику где начинается программа
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span><span style="color:#369">.global</span> <span style="color:#036;font-weight:bold">_start</span>
</span></span><span style="display:flex;"><span><span style="color:#888">; устанавливаем нужное выравнивание
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span><span style="color:#369">.align</span> <span style="color:#00d;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#369;font-style:italic">_start:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a61717;background-color:#e3d2d2">//</span> <span style="color:#a61717;background-color:#e3d2d2">печатаем</span>
</span></span><span style="display:flex;"><span>  <span style="color:#06b;font-weight:bold">MOV</span> <span style="color:#036;font-weight:bold">X0</span>, <span style="color:#888">#1 ; куда печатать: 1 = stdout
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>  <span style="color:#036;font-weight:bold">ADR</span> <span style="color:#036;font-weight:bold">X1</span>, <span style="color:#036;font-weight:bold">helloworld</span> <span style="color:#888">; что печатать
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>  <span style="color:#036;font-weight:bold">MOV</span> <span style="color:#036;font-weight:bold">X2</span>, <span style="color:#888">#13 ; длина нашей строчки
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>  <span style="color:#036;font-weight:bold">MOV</span> <span style="color:#036;font-weight:bold">X16</span>, <span style="color:#888">#4 ; номер системного вызова &#34;write&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>  <span style="color:#036;font-weight:bold">SVC</span> <span style="color:#888">#0x80 ; делаем системный вызов
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#a61717;background-color:#e3d2d2">//</span> <span style="color:#a61717;background-color:#e3d2d2">выходим</span>
</span></span><span style="display:flex;"><span>  <span style="color:#06b;font-weight:bold">MOV</span> <span style="color:#036;font-weight:bold">X0</span>, <span style="color:#888">#0 ; код 0
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>  <span style="color:#036;font-weight:bold">MOV</span> <span style="color:#036;font-weight:bold">X16</span>, <span style="color:#888">#1 ; номер системного вызова &#34;exit&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>  <span style="color:#036;font-weight:bold">SVC</span> <span style="color:#888">#0x80 ; просим ядро завершить программу
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>
</span></span><span style="display:flex;"><span><span style="color:#369">.data</span>
</span></span><span style="display:flex;"><span>  <span style="color:#369;font-style:italic">helloworld:</span> <span style="color:#369">.ascii</span> <span style="color:#d20;background-color:#fff0f0">&#34;Hello World!\n&#34;</span>
</span></span></code></pre></div><p>Вот так можно собрать:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>as -arch arm64 -o HelloWorld.o HelloWorld.s
</span></span><span style="display:flex;"><span>ld -o HelloWorld HelloWorld.o -lSystem -syslibroot <span style="color:#d20;background-color:#fff0f0">`</span>xcrun -sdk macosx --show-sdk-path<span style="color:#d20;background-color:#fff0f0">`</span> -e _start -arch arm64
</span></span></code></pre></div><h2 id="базовые-инструкции">
  Базовые инструкции
  <a class="heading-link" href="#%d0%b1%d0%b0%d0%b7%d0%be%d0%b2%d1%8b%d0%b5-%d0%b8%d0%bd%d1%81%d1%82%d1%80%d1%83%d0%ba%d1%86%d0%b8%d0%b8">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h2>
<h3 id="mov-movk-movn">
  MOV/MOVK/MOVN
  <a class="heading-link" href="#mov-movk-movn">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h3>
<p>Существует несколько форм инструкций перемещения данных:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#06b;font-weight:bold">MOVK</span> <span style="color:#036;font-weight:bold">XD</span>, <span style="color:#888">#imm16{, LSL #shift}
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span><span style="color:#036;font-weight:bold">MOV</span> <span style="color:#036;font-weight:bold">XD</span>, <span style="color:#888">#imm16{, LSL #shift}
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span><span style="color:#036;font-weight:bold">MOV</span> <span style="color:#036;font-weight:bold">XD</span>, <span style="color:#036;font-weight:bold">XS</span>
</span></span><span style="display:flex;"><span><span style="color:#06b;font-weight:bold">MOV</span> <span style="color:#036;font-weight:bold">XD</span>, <span style="color:#036;font-weight:bold">operand2</span>
</span></span><span style="display:flex;"><span><span style="color:#06b;font-weight:bold">MOVN</span> <span style="color:#036;font-weight:bold">XD</span>, <span style="color:#036;font-weight:bold">operand2</span>
</span></span></code></pre></div><p>Здесь:</p>
<ul>
<li><code>XD</code> и <code>XS</code> &ndash; Какие-то любые регистры.</li>
<li><code>#imm16</code> (<em>immediate value</em>) &ndash; Любой 16-битный числовой литерал.</li>
<li><code>operand2</code> &ndash; Про него ниже.</li>
</ul>
<p>Рассмотрим их по очереди.</p>
<h4 id="movk--move-keep">
  MOVK (move keep)
  <a class="heading-link" href="#movk--move-keep">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h4>
<p>Загружает 16-битное число в одну из 4-х позиций регистра, не
трогая остальные 48 бит. Например, если мы хотим загрузить число
<code>0x1234FEDC4F5D6E3A</code> в регистр <code>X2</code>, то мы можем это сделать
так:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#06b;font-weight:bold">MOV</span> <span style="color:#036;font-weight:bold">X2</span>, <span style="color:#888">#0x6E3A
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span><span style="color:#036;font-weight:bold">MOVK</span> <span style="color:#036;font-weight:bold">X2</span>, <span style="color:#888">#0x4F5D, LSL #16
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span><span style="color:#036;font-weight:bold">MOVK</span> <span style="color:#036;font-weight:bold">X2</span>, <span style="color:#888">#0xFEDC, LSL #32
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span><span style="color:#036;font-weight:bold">MOVK</span> <span style="color:#036;font-weight:bold">X2</span>, <span style="color:#888">#0x1234, LSL #48
</span></span></span></code></pre></div><p>В этом примере выше первая инструкция <code>MOV</code> это алиас <code>MOVZ</code>.
Инструкция <code>MOVZ</code> ведёт себя идентично <code>MOVK</code> за исключением
того, что она обнуляет остальные 48 бит.</p>
<h4 id="mov--из-регистра-в-регистр">
  MOV (из регистра в регистр)
  <a class="heading-link" href="#mov--%d0%b8%d0%b7-%d1%80%d0%b5%d0%b3%d0%b8%d1%81%d1%82%d1%80%d0%b0-%d0%b2-%d1%80%d0%b5%d0%b3%d0%b8%d1%81%d1%82%d1%80">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h4>
<p>Копирует содержимое регистра <code>X2</code> в регистр <code>X1</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#06b;font-weight:bold">MOV</span> <span style="color:#036;font-weight:bold">X1</span>, <span style="color:#036;font-weight:bold">X2</span>
</span></span></code></pre></div><h4 id="что-такое-operand2">
  Что такое operand2
  <a class="heading-link" href="#%d1%87%d1%82%d0%be-%d1%82%d0%b0%d0%ba%d0%be%d0%b5-operand2">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h4>
<p>Все ARM-инструкции, которые работают с данными, имеют
опциональный параметр <code>operand2</code>. Он может быть в 3 формах:</p>
<ol>
<li>
<p><strong>Регистр и сдвиг</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span>      <span style="color:#06b;font-weight:bold">MOV</span> <span style="color:#036;font-weight:bold">X1</span>, <span style="color:#036;font-weight:bold">X2</span>, <span style="color:#036;font-weight:bold">LSL</span> <span style="color:#888">#1 ; логический сдвиг влево
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>      <span style="color:#036;font-weight:bold">MOV</span> <span style="color:#036;font-weight:bold">X1</span>, <span style="color:#036;font-weight:bold">X2</span>, <span style="color:#036;font-weight:bold">LSR</span> <span style="color:#888">#1 ; логический сдвиг вправо
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>      <span style="color:#036;font-weight:bold">MOV</span> <span style="color:#036;font-weight:bold">X1</span>, <span style="color:#036;font-weight:bold">X2</span>, <span style="color:#036;font-weight:bold">ASR</span> <span style="color:#888">#1 ; арифметический сдвиг вправо
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>      <span style="color:#036;font-weight:bold">MOV</span> <span style="color:#036;font-weight:bold">X1</span>, <span style="color:#036;font-weight:bold">X2</span>, <span style="color:#036;font-weight:bold">ROR</span> <span style="color:#888">#1 ; сдвиг вправо (вращение)
</span></span></span></code></pre></div></li>
<li>
<p><strong>Регистр и расширение</strong>. Операции расширения позволяют нам
достать байт, половину или целое слово из второго регистра.
С инструкцией <code>MOV</code> расширения использовать нельзя, поэтому
приведём пример с <code>ADD</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span>      <span style="color:#888">; X2 = X1 + SXTB(X0)
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>      <span style="color:#06b;font-weight:bold">ADD</span> <span style="color:#036;font-weight:bold">X2</span>, <span style="color:#036;font-weight:bold">X1</span>, <span style="color:#036;font-weight:bold">X0</span>, <span style="color:#036;font-weight:bold">SXTB</span>
</span></span></code></pre></div><p>Если можно было догадаться что делают сдвиги, то с <code>SXTB</code> и
другими расширениями уже не так очевидно. Сейчас не будем на
этом детально останавливаться. Надеюсь, что сможем изучить
как работают расширения позже.</p>
</li>
<li>
<p><strong>Число и сдвиг</strong>. Мы уже встречали эту форму, когда
разбирались с <code>MOVK</code>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span>      <span style="color:#06b;font-weight:bold">MOV</span> <span style="color:#036;font-weight:bold">X1</span>, <span style="color:#00d;font-weight:bold">0xAB00</span>, <span style="color:#036;font-weight:bold">LSL</span> <span style="color:#888">#16
</span></span></span></code></pre></div></li>
</ol>
<p>Попробуем <code>MOV</code> на практике:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#369">.global</span> <span style="color:#036;font-weight:bold">_start</span>
</span></span><span style="display:flex;"><span><span style="color:#369">.align</span> <span style="color:#00d;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#369;font-style:italic">_start:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#888">; помещаем число 0x1234FEDC4F5D6E3A в регистр X2
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>  <span style="color:#06b;font-weight:bold">MOV</span> <span style="color:#036;font-weight:bold">X2</span>, <span style="color:#888">#0x6E3A
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>  <span style="color:#036;font-weight:bold">MOVK</span> <span style="color:#036;font-weight:bold">X2</span>, <span style="color:#888">#0x4F5D, LSL #16
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>  <span style="color:#036;font-weight:bold">MOVK</span> <span style="color:#036;font-weight:bold">X2</span>, <span style="color:#888">#0xFEDC, LSL #32
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>  <span style="color:#036;font-weight:bold">MOVK</span> <span style="color:#036;font-weight:bold">X2</span>, <span style="color:#888">#0x1234, LSL #48
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#888">; копируем содержимое W2 в W1
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>  <span style="color:#06b;font-weight:bold">MOV</span> <span style="color:#036;font-weight:bold">W1</span>, <span style="color:#036;font-weight:bold">W2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#888">; пробуем мнемоники сдвигов и вращений
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>  <span style="color:#06b;font-weight:bold">LSL</span>	<span style="color:#036;font-weight:bold">X1</span>, <span style="color:#036;font-weight:bold">X2</span>, <span style="color:#888">#1 ; логический сдвиг влево
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>  <span style="color:#036;font-weight:bold">LSR</span>	<span style="color:#036;font-weight:bold">X1</span>, <span style="color:#036;font-weight:bold">X2</span>, <span style="color:#888">#1 ; логический сдвиг вправо
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>  <span style="color:#036;font-weight:bold">ASR</span>	<span style="color:#036;font-weight:bold">X1</span>, <span style="color:#036;font-weight:bold">X2</span>, <span style="color:#888">#1 ; арифметический сдвиг вправо
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>  <span style="color:#036;font-weight:bold">ROR</span>	<span style="color:#036;font-weight:bold">X1</span>, <span style="color:#036;font-weight:bold">X2</span>, <span style="color:#888">#1 ; сдвиг вправо (вращение)
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#888">; выходим
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>  <span style="color:#06b;font-weight:bold">MOV</span> <span style="color:#036;font-weight:bold">X0</span>, <span style="color:#888">#0 ; код 0
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>  <span style="color:#036;font-weight:bold">MOV</span> <span style="color:#036;font-weight:bold">X16</span>, <span style="color:#888">#1 ; номер системного вызова &#34;exit&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>  <span style="color:#036;font-weight:bold">SVC</span> <span style="color:#888">#0x80 ; просим ядро завершить программу
</span></span></span></code></pre></div><p>Пора начать использовать мейк-файлы:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-makefile" data-lang="makefile"><span style="display:flex;"><span><span style="color:#369">OBJS</span> = mov.o
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">ifdef</span> <span style="color:#a61717;background-color:#e3d2d2">DEBUG</span>
</span></span><span style="display:flex;"><span><span style="color:#369">DEBUGFLGS</span> = -g
</span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">else</span>
</span></span><span style="display:flex;"><span><span style="color:#369">DEBUGFLGS</span> =
</span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">endif</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#369">LDFLAGS</span> = -lSystem -syslibroot <span style="color:#d20;background-color:#fff0f0">`</span>xcrun -sdk macosx --show-sdk-path<span style="color:#d20;background-color:#fff0f0">`</span> -e _start -arch arm64
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#06b;font-weight:bold">%.o </span>: %.s
</span></span><span style="display:flex;"><span>	as <span style="color:#080;font-weight:bold">$(</span>DEBUGFLGS<span style="color:#080;font-weight:bold">)</span> $&lt; -o <span style="color:#369">$@</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#06b;font-weight:bold">all</span>: mov
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#06b;font-weight:bold">mov</span>: <span style="color:#080;font-weight:bold">$(</span><span style="color:#369">OBJS</span><span style="color:#080;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	ld -o mov <span style="color:#080;font-weight:bold">$(</span>LDFLAGS<span style="color:#080;font-weight:bold">)</span> <span style="color:#080;font-weight:bold">$(</span>OBJS<span style="color:#080;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#06b;font-weight:bold">clean</span>:
</span></span><span style="display:flex;"><span>	rm *.o mov
</span></span></code></pre></div><p>А теперь посмотрим что получилось <code>objdump</code>&lsquo;ом:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>objdump -s -d -M no-aliases mov.o
</span></span></code></pre></div><p>Покажет нам следующее:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mov.o:	file format mach-o arm64
</span></span><span style="display:flex;"><span>Contents of section __TEXT,__text:
</span></span><span style="display:flex;"><span> <span style="color:#00d;font-weight:bold">0000</span> 42c78dd2 a2eba9f2 82dbdff2 8246e2f2  B............F..
</span></span><span style="display:flex;"><span> <span style="color:#00d;font-weight:bold">0010</span> e103022a 41f87fd3 41fc41d3 41fc4193  ...*A...A.A.A.A.
</span></span><span style="display:flex;"><span> <span style="color:#00d;font-weight:bold">0020</span> 4104c293 000080d2 300080d2 011000d4  A.......0.......
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Disassembly of section __TEXT,__text:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00d;font-weight:bold">0000000000000000</span> &lt;ltmp0&gt;:
</span></span><span style="display:flex;"><span>       0: <span style="color:#00d;font-weight:bold">42</span> c7 8d d2  	mov	x2, <span style="color:#888">#28218</span>
</span></span><span style="display:flex;"><span>       4: a2 eb a9 f2  	movk	x2, <span style="color:#888">#20317, lsl #16</span>
</span></span><span style="display:flex;"><span>       8: <span style="color:#00d;font-weight:bold">82</span> db df f2  	movk	x2, <span style="color:#888">#65244, lsl #32</span>
</span></span><span style="display:flex;"><span>       c: <span style="color:#00d;font-weight:bold">82</span> <span style="color:#00d;font-weight:bold">46</span> e2 f2  	movk	x2, <span style="color:#888">#4660, lsl #48</span>
</span></span><span style="display:flex;"><span>      10: e1 <span style="color:#00d;font-weight:bold">03</span> <span style="color:#00d;font-weight:bold">02</span> 2a  	orr	w1, wzr, w2
</span></span><span style="display:flex;"><span>      14: <span style="color:#00d;font-weight:bold">41</span> f8 7f d3  	lsl	x1, x2, <span style="color:#888">#1</span>
</span></span><span style="display:flex;"><span>      18: <span style="color:#00d;font-weight:bold">41</span> <span style="color:#038">fc</span> <span style="color:#00d;font-weight:bold">41</span> d3  	lsr	x1, x2, <span style="color:#888">#1</span>
</span></span><span style="display:flex;"><span>      1c: <span style="color:#00d;font-weight:bold">41</span> <span style="color:#038">fc</span> <span style="color:#00d;font-weight:bold">41</span> <span style="color:#00d;font-weight:bold">93</span>  	asr	x1, x2, <span style="color:#888">#1</span>
</span></span><span style="display:flex;"><span>      20: <span style="color:#00d;font-weight:bold">41</span> <span style="color:#00d;font-weight:bold">04</span> c2 <span style="color:#00d;font-weight:bold">93</span>  	extr	x1, x2, x2, <span style="color:#888">#1</span>
</span></span><span style="display:flex;"><span>      24: <span style="color:#00d;font-weight:bold">00</span> <span style="color:#00d;font-weight:bold">00</span> <span style="color:#00d;font-weight:bold">80</span> d2  	mov	x0, <span style="color:#888">#0</span>
</span></span><span style="display:flex;"><span>      28: <span style="color:#00d;font-weight:bold">30</span> <span style="color:#00d;font-weight:bold">00</span> <span style="color:#00d;font-weight:bold">80</span> d2  	mov	x16, <span style="color:#888">#1</span>
</span></span><span style="display:flex;"><span>      2c: <span style="color:#00d;font-weight:bold">01</span> <span style="color:#00d;font-weight:bold">10</span> <span style="color:#00d;font-weight:bold">00</span> d4  	svc	<span style="color:#888">#0x80</span>
</span></span></code></pre></div><p>Обратим внимание, например, что <code>MOV X0, #0</code> была транслирована в <code>ORR W1, WZR, W2</code>.</p>
<h3 id="add-adc">
  ADD/ADC
  <a class="heading-link" href="#add-adc">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h3>
<p>Эти инструкции складывают второй и третий параметры и сохраняют
результат сложения в первый: <code>Xd = Xs + Operand2</code>, где <code>Xd</code> и
<code>Xs</code> могут совпадать.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#06b;font-weight:bold">ADD</span><span style="color:#a61717;background-color:#e3d2d2">{</span><span style="color:#036;font-weight:bold">S</span><span style="color:#a61717;background-color:#e3d2d2">}</span> <span style="color:#036;font-weight:bold">Xd</span>, <span style="color:#036;font-weight:bold">Xs</span>, <span style="color:#036;font-weight:bold">Operand2</span>
</span></span></code></pre></div><p>Рассмотрим несколько примеров.</p>
<ol>
<li>
<p>Сложение с константой. Число может быть до 12 бит (0-4095).</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span>      <span style="color:#888">; X2 = X1 + 4000
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>      <span style="color:#06b;font-weight:bold">ADD</span> <span style="color:#036;font-weight:bold">X2</span>, <span style="color:#036;font-weight:bold">X1</span>, <span style="color:#888">#4000
</span></span></span></code></pre></div></li>
<li>
<p>Со сдвигом влево.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span>      <span style="color:#888">; X2 = X1 + 0x20000
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>      <span style="color:#06b;font-weight:bold">ADD</span> <span style="color:#036;font-weight:bold">X2</span>, <span style="color:#036;font-weight:bold">X1</span>, <span style="color:#888">#0x20, LSL 12
</span></span></span></code></pre></div></li>
<li>
<p>Простое сложение 2-х регистров.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span>      <span style="color:#888">; X2 = X1 + X0
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>      <span style="color:#06b;font-weight:bold">ADD</span> <span style="color:#036;font-weight:bold">X2</span>, <span style="color:#036;font-weight:bold">X1</span>, <span style="color:#036;font-weight:bold">X0</span>
</span></span></code></pre></div></li>
<li>
<p>Сложение регистра со сдвинутым значением в другом регистре.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span>      <span style="color:#888">; X2 = X1 + (X0 * 4)
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>      <span style="color:#06b;font-weight:bold">ADD</span> <span style="color:#036;font-weight:bold">X2</span>, <span style="color:#036;font-weight:bold">X1</span>, <span style="color:#036;font-weight:bold">X0</span>, <span style="color:#036;font-weight:bold">LSL</span> <span style="color:#00d;font-weight:bold">2</span>
</span></span></code></pre></div></li>
</ol>
<h3 id="sub-sbc">
  SUB/SBC
  <a class="heading-link" href="#sub-sbc">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#06b;font-weight:bold">SUB</span><span style="color:#a61717;background-color:#e3d2d2">{</span><span style="color:#036;font-weight:bold">S</span><span style="color:#a61717;background-color:#e3d2d2">}</span> <span style="color:#036;font-weight:bold">Xd</span>, <span style="color:#036;font-weight:bold">Xs</span>, <span style="color:#036;font-weight:bold">Operand2</span>
</span></span></code></pre></div><h2 id="память">
  Память
  <a class="heading-link" href="#%d0%bf%d0%b0%d0%bc%d1%8f%d1%82%d1%8c">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h2>
<p>Для чтения и записи памяти используются инструкции <code>STR</code> и <code>LDR</code>
соответственно.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#06b;font-weight:bold">LDR</span> <span style="color:#036;font-weight:bold">X1</span>, <span style="color:#a61717;background-color:#e3d2d2">=</span><span style="color:#036;font-weight:bold">num</span> <span style="color:#888">; загружает адрес num в регистр X1
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span><span style="color:#036;font-weight:bold">LDR</span> <span style="color:#036;font-weight:bold">X3</span>, <span style="color:#a61717;background-color:#e3d2d2">=</span><span style="color:#036;font-weight:bold">loc</span> <span style="color:#888">; загружает адрес loc в регистр X3
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span><span style="color:#036;font-weight:bold">LDR</span> <span style="color:#036;font-weight:bold">X2</span>, [<span style="color:#036;font-weight:bold">X3</span>] <span style="color:#888">; загружает слово по адресу X3 в X2
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>
</span></span><span style="display:flex;"><span><span style="color:#369">.data</span>
</span></span><span style="display:flex;"><span><span style="color:#06b;font-weight:bold">num</span> <span style="color:#036;font-weight:bold">.BYTE</span> <span style="color:#00d;font-weight:bold">0x12</span>
</span></span><span style="display:flex;"><span><span style="color:#06b;font-weight:bold">loc</span> <span style="color:#036;font-weight:bold">.QUAD</span> <span style="color:#00d;font-weight:bold">0x123456789ABCDEF0</span>
</span></span></code></pre></div><h2 id="функции-и-стек">
  Функции и стек
  <a class="heading-link" href="#%d1%84%d1%83%d0%bd%d0%ba%d1%86%d0%b8%d0%b8-%d0%b8-%d1%81%d1%82%d0%b5%d0%ba">
    <i class="fa fa-link" aria-hidden="true"></i>
  </a>
</h2>
<p>Стек растёт вниз, <code>SP</code> указывает на его вершину и всегда
выровнен на 16 байт (это важно). У нас есть инструкции <code>STR</code> и
<code>STP</code> для размещения содержимого регистров в стеке, а также
<code>LDR</code> и <code>LDP</code> для считывания данных из стека в регистры.</p>
<p>Чтобы скопировать в стек значение из регистра <code>X5</code>, в котором
хранится число <code>1022</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#06b;font-weight:bold">STR</span> <span style="color:#036;font-weight:bold">X5</span>, [<span style="color:#036;font-weight:bold">SP</span>, <span style="color:#888">#-16]!
</span></span></span></code></pre></div><figure><img src="https://vyorkin.org/ox-hugo/str1.png"/>
</figure>

<p>Чтобы загрузить в регистр <code>X4</code> значение из вершины стека, где
лежит число <code>1022</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#06b;font-weight:bold">LDR</span> <span style="color:#036;font-weight:bold">X4</span>, [<span style="color:#036;font-weight:bold">SP</span>], <span style="color:#888">#16
</span></span></span></code></pre></div><figure><img src="https://vyorkin.org/ox-hugo/ldr1.png"/>
</figure>


        
      </div>


      <footer>
        


        
        
        
      </footer>
    </article>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css"
    integrity="sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs" crossorigin="anonymous">
  
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js"
    integrity="sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx" crossorigin="anonymous"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js"
    integrity="sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR" crossorigin="anonymous"
    onload="renderMathInElement(document.body,
      {
        delimiters: [
          {left: '$$', right: '$$', display:true},
          {left: '$', right: '$', display:false},
          {left: '\\(', right: '\\)', display: false},
          {left: '\\[', right: '\\]', display: true}
        ]
      }
    );"></script>
  </section>

    </div>

    <footer class="footer">
  <section class="container">
    ©
    
      1985 -
    
    2022
     Василий Ёркин 
    
  </section>
</footer>

  </main>

  
  
  <script src="https://vyorkin.org/js/coder.min.236049395dc3682fb2719640872958e12f1f24067bb09c327b233e6290c7edac.js" integrity="sha256-I2BJOV3DaC&#43;ycZZAhylY4S8fJAZ7sJwyeyM&#43;YpDH7aw="></script>
  

  

  

  

  

  

  

  

  

  
</body>

</html>
